<!doctype html>
<!-- Generated by akashic-cli-export-html@1.9.18. -->
<!-- Options: {"strip":true,"hashFilename":true,"bundle":true,"magnify":true} -->
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>game</title>
<script>

	!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):(t="undefined"!=typeof globalThis?globalThis:t||self).engineFilesV3_9_3=e()}(this,(function(){"use strict";var t="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{};function e(t){return t&&t.__esModule&&Object.prototype.hasOwnProperty.call(t,"default")?t.default:t}var r={},i={};function n(t){return n="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},n(t)}function o(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function s(t,e){for(var r=0;r<e.length;r++){var i=e[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,(n=i.key,o=void 0,"symbol"==typeof(o=function(t,e){if("object"!=typeof t||null===t)return t;var r=t[Symbol.toPrimitive];if(void 0!==r){var i=r.call(t,e||"default");if("object"!=typeof i)return i;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===e?String:Number)(t)}(n,"string"))?o:String(o)),i)}var n,o}function a(t,e,r){return e&&s(t.prototype,e),r&&s(t,r),Object.defineProperty(t,"prototype",{writable:!1}),t}function h(t){return h=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(t){return t.__proto__||Object.getPrototypeOf(t)},h(t)}function u(t,e){return u=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(t,e){return t.__proto__=e,t},u(t,e)}function c(t,e){if(e&&("object"==typeof e||"function"==typeof e))return e;if(void 0!==e)throw new TypeError("Derived constructors may only return object or undefined");return function(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(t)}function l(t){var e=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(t){return!1}}();return function(){var r,i=h(t);if(e){var n=h(this).constructor;r=Reflect.construct(i,arguments,n)}else r=i.apply(this,arguments);return c(this,r)}}function d(){return d="undefined"!=typeof Reflect&&Reflect.get?Reflect.get.bind():function(t,e,r){var i=function(t,e){for(;!Object.prototype.hasOwnProperty.call(t,e)&&null!==(t=h(t)););return t}(t,e);if(i){var n=Object.getOwnPropertyDescriptor(i,e);return n.get?n.get.call(arguments.length<3?t:r):n.value}},d.apply(this,arguments)}Object.defineProperty(i,"__esModule",{value:!0}),i.PSEUDO_INFINITE_AGE=i.DEFAULT_POLLING_TICK_THRESHOLD=i.DEFAULT_JUMP_IGNORE_THRESHOLD=i.DEFAULT_JUMP_TRY_THRESHOLD=i.DEFAULT_SKIP_THRESHOLD=i.DEFAULT_SKIP_TICKS_AT_ONCE=i.DEFAULT_DELAY_IGNORE_THRESHOLD=void 0,i.DEFAULT_DELAY_IGNORE_THRESHOLD=6,i.DEFAULT_SKIP_TICKS_AT_ONCE=100,i.DEFAULT_SKIP_THRESHOLD=100,i.DEFAULT_JUMP_TRY_THRESHOLD=3e4,i.DEFAULT_JUMP_IGNORE_THRESHOLD=15e3,i.DEFAULT_POLLING_TICK_THRESHOLD=1e4,i.PSEUDO_INFINITE_AGE=189216e4;var p={};Object.defineProperty(p,"__esModule",{value:!0}),p._cloneDeep=p.MemoryAmflowClient=void 0;var f=function(){function t(t){this._tickHandlers=[],this._eventHandlers=[],this._events=[],this._tickList=null,this._playId=t.playId,this._putStorageDataSyncFunc=t.putStorageDataSyncFunc||function(){throw new Error("Implementation not given")},this._getStorageDataSyncFunc=t.getStorageDataSyncFunc||function(){throw new Error("Implementation not given")},t.startPoints?(t.tickList&&(this._tickList=t.tickList),this._startPoints=t.startPoints):this._startPoints=[]}return t.prototype.dump=function(){return{tickList:this._tickList,startPoints:this._startPoints}},t.prototype.open=function(t,e){var r=this;setTimeout((function(){e&&(t===r._playId?e(null):e(new Error("MemoryAmflowClient#open: unknown playId")))}),0)},t.prototype.close=function(t){t&&setTimeout((function(){t(null)}),0)},t.prototype.authenticate=function(e,r){setTimeout((function(){switch(e){case t.TOKEN_ACTIVE:r(null,{writeTick:!0,readTick:!0,subscribeTick:!1,sendEvent:!1,subscribeEvent:!0,maxEventPriority:2});break;case t.TOKEN_PASSIVE:r(null,{writeTick:!1,readTick:!0,subscribeTick:!0,sendEvent:!0,subscribeEvent:!1,maxEventPriority:2});break;default:r(null,{writeTick:!0,readTick:!0,subscribeTick:!0,sendEvent:!0,subscribeEvent:!0,maxEventPriority:2})}}),0)},t.prototype.sendTick=function(t){if(t=_(t),this._tickList){if(this._tickList[0]<=t[0]&&t[0]<=this._tickList[1])throw new Error("illegal age tick");this._tickList[1]=t[0]}else this._tickList=[t[0],t[0],[]];var e=t[1],r=t[2];(e||r)&&(e&&(t[1]=e.filter((function(t){return!(8&t[1])}))),this._tickList[2].push(t)),this._tickHandlers.forEach((function(e){return e(t)}))},t.prototype.onTick=function(t){this._tickHandlers.push(t)},t.prototype.offTick=function(t){this._tickHandlers=this._tickHandlers.filter((function(e){return e!==t}))},t.prototype.sendEvent=function(t){t=_(t),0!==this._eventHandlers.length?this._eventHandlers.forEach((function(e){return e(t)})):this._events.push(t)},t.prototype.onEvent=function(t){var e=this;this._eventHandlers.push(t),this._events.length>0&&(this._events.forEach((function(t){e._eventHandlers.forEach((function(e){return e(t)}))})),this._events=[])},t.prototype.offEvent=function(t){this._eventHandlers=this._eventHandlers.filter((function(e){return e!==t}))},t.prototype.getTickList=function(t,e,r){var i,n;if("number"==typeof t?(i={begin:t,end:e},n=r):(i=t,n=e),this._tickList){var o=Math.max(i.begin,this._tickList[0]),s=Math.min(i.end,this._tickList[1]),a=this._tickList[2].filter((function(t){var e=t[0];return o<=e&&e<=s})),h=[o,s,a];setTimeout((function(){return n(null,h)}),0)}else n&&setTimeout((function(){return n(null)}),0)},t.prototype.putStartPoint=function(t,e){var r=this;setTimeout((function(){r._startPoints.push(t),e(null)}),0)},t.prototype.getStartPoint=function(t,e){var r=this;setTimeout((function(){if(r._startPoints&&0!==r._startPoints.length){var i=0;if(null!=t.frame)for(var n=r._startPoints[0].frame,o=1;o<r._startPoints.length;++o){var s=r._startPoints[o].frame;s<=t.frame&&n<s&&(n=s,i=o)}else{var a=r._startPoints[0].timestamp;for(o=1;o<r._startPoints.length;++o){var h=r._startPoints[o].timestamp;h<=t.timestamp&&a<h&&(a=h,i=o)}}e(null,r._startPoints[i])}else e(new Error("no startpoint"))}),0)},t.prototype.putStorageData=function(t,e,r,i){var n=this;setTimeout((function(){try{n._putStorageDataSyncFunc(t,e,r),i(null)}catch(t){i(t)}}),0)},t.prototype.getStorageData=function(t,e){var r=this;setTimeout((function(){try{var i=r._getStorageDataSyncFunc(t);e(null,i)}catch(t){e(t)}}),0)},t.prototype.dropAfter=function(t){if(this._tickList){var e=this._tickList[0],r=this._tickList[1];t<=e?(this._tickList=null,this._startPoints=[]):t<=r&&(this._tickList[1]=t-1,this._tickList[2]=this._tickList[2].filter((function(r){var i=r[0];return e<=i&&i<=t-1})),this._startPoints=this._startPoints.filter((function(e){return e.frame<t})))}},t.TOKEN_ACTIVE="mamfc-token:active",t.TOKEN_PASSIVE="mamfc-token:passive",t}();function _(t){return t&&"object"===n(t)?Array.isArray(t)?t.map(_):Object.keys(t).reduce((function(e,r){return e[r]=_(t[r]),e}),{}):t}p.MemoryAmflowClient=f,p._cloneDeep=_;var y={};Object.defineProperty(y,"__esModule",{value:!0}),y.ReplayAmflowProxy=void 0;var g=function(){function t(t){this._amflow=t.amflow,this._tickList=t.tickList,this._startPoints=t.startPoints}return t.prototype.dropAfter=function(t){if(this._tickList){var e=this._tickList[0],r=this._tickList[1],i=this._tickList[2]||[];t<=e?(this._tickList=null,this._startPoints=[]):t<=r&&(this._tickList[1]=t-1,this._tickList[2]=this._sliceTicks(i,r,t-1),this._startPoints=this._startPoints.filter((function(e){return e.frame<t})))}},t.prototype.open=function(t,e){this._amflow.open(t,e)},t.prototype.close=function(t){this._amflow.close(t)},t.prototype.authenticate=function(t,e){this._amflow.authenticate(t,e)},t.prototype.sendTick=function(t){this._amflow.sendTick(t)},t.prototype.onTick=function(t){this._amflow.onTick(t)},t.prototype.offTick=function(t){this._amflow.offTick(t)},t.prototype.sendEvent=function(t){this._amflow.sendEvent(t)},t.prototype.onEvent=function(t){this._amflow.onEvent(t)},t.prototype.offEvent=function(t){this._amflow.offEvent(t)},t.prototype.getTickList=function(t,e,r){var i,n,o=this;if("number"==typeof t?(i={begin:t,end:e},n=r):(i=t,n=e),this._tickList){var s=i.begin,a=i.end,h=this._tickList[0],u=this._tickList[1],c=this._tickList[2]||[],l=h<=s&&s<=u,d=h<=a&&a<=u;l&&d?setTimeout((function(){n(null,[s,a,o._sliceTicks(c,s,a)])}),0):this._amflow.getTickList({begin:s,end:a},(function(t,e){if(t)n(t);else if(e)if(l||d)if(l){r=o._sliceTicks(c,s,a).concat(e[2]||[]);n(null,[s,e[1],r])}else{r=(e[2]||[]).concat(o._sliceTicks(c,s,a));n(null,[e[0],a,r])}else if(a<h||u<s)n(null,e);else{var r;if(r=e[2]){var i=o._sliceTicks(r,s,h-1),p=o._sliceTicks(r,u+1,a);r=i.concat(c,p)}else r=c;n(null,[s,a,r])}else n(null,l||d?l?[s,u,o._sliceTicks(c,s,a)]:[h,a,o._sliceTicks(c,s,a)]:a<h||u<s?e:[h,u,o._sliceTicks(c,s,a)])}))}else this._amflow.getTickList(i,n)},t.prototype.putStartPoint=function(t,e){this._amflow.putStartPoint(t,e)},t.prototype.getStartPoint=function(t,e){var r=this,i=0;if(this._startPoints.length>0)if(null!=t.frame)for(var n=this._startPoints[0].frame,o=1;o<this._startPoints.length;++o){var s=this._startPoints[o].frame;s<=t.frame&&n<s&&(n=s,i=o)}else{var a=this._startPoints[0].timestamp;for(o=1;o<this._startPoints.length;++o){var h=this._startPoints[o].timestamp;h<=t.timestamp&&a<h&&(a=h,i=o)}}var u=this._tickList?this._tickList[1]:-1;"number"==typeof t.frame&&t.frame>u?this._amflow.getStartPoint(t,(function(t,n){t?e(t):n&&u<n.frame?e(null,n):e(null,r._startPoints[i])})):setTimeout((function(){e(null,r._startPoints[i])}),0)},t.prototype.putStorageData=function(t,e,r,i){this._amflow.putStorageData(t,e,r,i)},t.prototype.getStorageData=function(t,e){this._amflow.getStorageData(t,e)},t.prototype._sliceTicks=function(t,e,r){return t.filter((function(t){var i=t[0];return e<=i&&i<=r}))},t}();y.ReplayAmflowProxy=g;var v={},m={},T={},A={},w={};Object.defineProperty(w,"__esModule",{value:!0});var S={};Object.defineProperty(S,"__esModule",{value:!0});var b={};Object.defineProperty(b,"__esModule",{value:!0}),function(e){var r=t&&t.__createBinding||(Object.create?function(t,e,r,i){void 0===i&&(i=r);var n=Object.getOwnPropertyDescriptor(e,r);n&&!("get"in n?!e.__esModule:n.writable||n.configurable)||(n={enumerable:!0,get:function(){return e[r]}}),Object.defineProperty(t,i,n)}:function(t,e,r,i){void 0===i&&(i=r),t[i]=e[r]}),i=t&&t.__exportStar||function(t,e){for(var i in t)"default"===i||Object.prototype.hasOwnProperty.call(e,i)||r(e,t,i)};Object.defineProperty(e,"__esModule",{value:!0}),i(w,e),i(S,e),i(b,e)}(A);var P={},x={};Object.defineProperty(x,"__esModule",{value:!0});var E={};Object.defineProperty(E,"__esModule",{value:!0});var O={},k={};Object.defineProperty(k,"__esModule",{value:!0}),k.isPromise=void 0,k.isPromise=function(t){return null!=t&&("object"===n(t)||"function"==typeof t)&&"function"==typeof t.then},Object.defineProperty(O,"__esModule",{value:!0}),O.Trigger=void 0;var M=k,L=function(){function t(){o(this,t),this._handlers=[],this.length=0}return a(t,[{key:"add",value:function(t,e){if("function"==typeof t)this._addHandler({func:t,owner:e,once:!1,name:void 0,filter:void 0});else{var r=t,i="number"==typeof r.index?r.index:void 0;this._addHandler({func:r.func,owner:r.owner,once:!1,name:r.name,filter:r.filter},i)}this.length=this._handlers.length}},{key:"addOnce",value:function(t,e){if("function"==typeof t)this._addHandler({func:t,owner:e,once:!0,name:void 0,filter:void 0});else{var r=t,i="number"==typeof r.index?r.index:void 0;this._addHandler({func:r.func,owner:r.owner,once:!0,name:r.name,filter:r.filter},i)}this.length=this._handlers.length}},{key:"handle",value:function(t,e,r){this.add(e?{owner:t,func:e,name:r}:{func:t})}},{key:"fire",value:function(t){if(this._handlers&&this._handlers.length){for(var e=this._handlers.concat(),r=0;r<e.length;r++){var i=e[r];if(!i.filter||i.filter(i)){var n=i.func.call(i.owner,t);if(!(0,M.isPromise)(n)&&!!n||i.once){if(!this._handlers)continue;var o=this._handlers.indexOf(i);-1!==o&&this._handlers.splice(o,1)}}}null!=this._handlers&&(this.length=this._handlers.length)}}},{key:"contains",value:function(t,e){for(var r="function"==typeof t?{func:t,owner:e}:t,i=0;i<this._handlers.length;i++)if(this._comparePartial(r,this._handlers[i]))return!0;return!1}},{key:"remove",value:function(t,e){for(var r="function"==typeof t?{func:t,owner:e}:t,i=0;i<this._handlers.length;i++){var n=this._handlers[i];if(r.func===n.func&&r.owner===n.owner&&r.name===n.name&&r.filter===n.filter)return this._handlers.splice(i,1),void--this.length}}},{key:"removeAll",value:function(t){var e=[];if(t)for(var r=0;r<this._handlers.length;r++){var i=this._handlers[r];this._comparePartial(t,i)||e.push(i)}this._handlers=e,this.length=this._handlers.length}},{key:"destroy",value:function(){this._handlers=null,this.length=null}},{key:"destroyed",value:function(){return null===this._handlers}},{key:"_addHandler",value:function(t,e){null==e?this._handlers.push({func:t.func,owner:t.owner,once:t.once,name:t.name,filter:t.filter}):this._handlers.splice(e,0,{func:t.func,owner:t.owner,once:t.once,name:t.name,filter:t.filter})}},{key:"_comparePartial",value:function(t,e){return(void 0===t.func||t.func===e.func)&&((void 0===t.owner||t.owner===e.owner)&&((void 0===t.name||t.name===e.name)&&(void 0===t.filter||t.filter===e.filter)))}}]),t}();O.Trigger=L;var R={};Object.defineProperty(R,"__esModule",{value:!0}),R.ChainTrigger=void 0;var C=function(t){!function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),Object.defineProperty(t,"prototype",{writable:!1}),e&&u(t,e)}(r,t);var e=l(r);function r(t,i,n){var s;return o(this,r),(s=e.call(this)).chain=t,s.filter=null!=i?i:null,s.filterOwner=n,s._isActivated=!1,s}return a(r,[{key:"add",value:function(t,e){d(h(r.prototype),"add",this).call(this,t,e),this._isActivated||(this.chain.add(this._onChainTriggerFired,this),this._isActivated=!0)}},{key:"addOnce",value:function(t,e){d(h(r.prototype),"addOnce",this).call(this,t,e),this._isActivated||(this.chain.add(this._onChainTriggerFired,this),this._isActivated=!0)}},{key:"remove",value:function(t,e){d(h(r.prototype),"remove",this).call(this,t,e),0===this.length&&this._isActivated&&(this.chain.remove(this._onChainTriggerFired,this),this._isActivated=!1)}},{key:"removeAll",value:function(t){d(h(r.prototype),"removeAll",this).call(this,t),0===this.length&&this._isActivated&&(this.chain.remove(this._onChainTriggerFired,this),this._isActivated=!1)}},{key:"destroy",value:function(){d(h(r.prototype),"destroy",this).call(this),this.chain.remove(this._onChainTriggerFired,this),this.filter=null,this.filterOwner=null,this._isActivated=!1}},{key:"_onChainTriggerFired",value:function(t){this.filter&&!this.filter.call(this.filterOwner,t)||this.fire(t)}}]),r}(O.Trigger);R.ChainTrigger=C,function(e){var r=t&&t.__createBinding||(Object.create?function(t,e,r,i){void 0===i&&(i=r);var n=Object.getOwnPropertyDescriptor(e,r);n&&!("get"in n?!e.__esModule:n.writable||n.configurable)||(n={enumerable:!0,get:function(){return e[r]}}),Object.defineProperty(t,i,n)}:function(t,e,r,i){void 0===i&&(i=r),t[i]=e[r]}),i=t&&t.__exportStar||function(t,e){for(var i in t)"default"===i||Object.prototype.hasOwnProperty.call(e,i)||r(e,t,i)};Object.defineProperty(e,"__esModule",{value:!0}),i(x,e),i(E,e),i(O,e),i(R,e)}(P);var I={},F={};Object.defineProperty(F,"__esModule",{value:!0});var D={};Object.defineProperty(D,"__esModule",{value:!0});var j,G={};Object.defineProperty(G,"__esModule",{value:!0}),G.CompositeOperation=void 0,function(t){t[t.SourceOver=0]="SourceOver",t[t.SourceAtop=1]="SourceAtop",t[t.Lighter=2]="Lighter",t[t.Copy=3]="Copy",t[t.ExperimentalSourceIn=4]="ExperimentalSourceIn",t[t.ExperimentalSourceOut=5]="ExperimentalSourceOut",t[t.ExperimentalDestinationAtop=6]="ExperimentalDestinationAtop",t[t.ExperimentalDestinationIn=7]="ExperimentalDestinationIn",t[t.DestinationOut=8]="DestinationOut",t[t.DestinationOver=9]="DestinationOver",t[t.Xor=10]="Xor",t[t.Difference=11]="Difference",t[t.Saturation=12]="Saturation"}(j||(G.CompositeOperation=j={}));var U={};Object.defineProperty(U,"__esModule",{value:!0});var B={};Object.defineProperty(B,"__esModule",{value:!0});var H={};Object.defineProperty(H,"__esModule",{value:!0});var N={};Object.defineProperty(N,"__esModule",{value:!0});var W={};Object.defineProperty(W,"__esModule",{value:!0});var V={};Object.defineProperty(V,"__esModule",{value:!0});var X={};Object.defineProperty(X,"__esModule",{value:!0});var z={};Object.defineProperty(z,"__esModule",{value:!0});var q={};Object.defineProperty(q,"__esModule",{value:!0});var Y={};Object.defineProperty(Y,"__esModule",{value:!0});var K={};Object.defineProperty(K,"__esModule",{value:!0});var $={};Object.defineProperty($,"__esModule",{value:!0});var J={};Object.defineProperty(J,"__esModule",{value:!0});var Z={};Object.defineProperty(Z,"__esModule",{value:!0});var Q={};Object.defineProperty(Q,"__esModule",{value:!0});var tt={};Object.defineProperty(tt,"__esModule",{value:!0});var et={};Object.defineProperty(et,"__esModule",{value:!0});var rt={};Object.defineProperty(rt,"__esModule",{value:!0});var it={};Object.defineProperty(it,"__esModule",{value:!0});var nt={};Object.defineProperty(nt,"__esModule",{value:!0});var ot={};Object.defineProperty(ot,"__esModule",{value:!0});var st={};Object.defineProperty(st,"__esModule",{value:!0});var at={};Object.defineProperty(at,"__esModule",{value:!0});var ht,ut={};Object.defineProperty(ut,"__esModule",{value:!0}),ut.AssetLoadErrorType=void 0,function(t){t[t.Unspecified=0]="Unspecified",t[t.RetryLimitExceeded=1]="RetryLimitExceeded",t[t.NetworkError=2]="NetworkError",t[t.ClientError=3]="ClientError",t[t.ServerError=4]="ServerError"}(ht||(ut.AssetLoadErrorType=ht={}));var ct={};Object.defineProperty(ct,"__esModule",{value:!0});var lt,dt={};Object.defineProperty(dt,"__esModule",{value:!0}),dt.FontWeight=void 0,function(t){t[t.Normal=0]="Normal",t[t.Bold=1]="Bold"}(lt||(dt.FontWeight=lt={}));var pt,ft={};Object.defineProperty(ft,"__esModule",{value:!0}),ft.FontFamily=void 0,function(t){t[t.SansSerif=0]="SansSerif",t[t.Serif=1]="Serif",t[t.Monospace=2]="Monospace"}(pt||(ft.FontFamily=pt={}));var _t={};Object.defineProperty(_t,"__esModule",{value:!0});var yt={};Object.defineProperty(yt,"__esModule",{value:!0});var gt={};Object.defineProperty(gt,"__esModule",{value:!0});var vt={};Object.defineProperty(vt,"__esModule",{value:!0});var mt={};Object.defineProperty(mt,"__esModule",{value:!0});var Tt={};Object.defineProperty(Tt,"__esModule",{value:!0});var At={};Object.defineProperty(At,"__esModule",{value:!0});var wt={};Object.defineProperty(wt,"__esModule",{value:!0});var St={};Object.defineProperty(St,"__esModule",{value:!0});var bt={};Object.defineProperty(bt,"__esModule",{value:!0});var Pt={};Object.defineProperty(Pt,"__esModule",{value:!0}),function(e){var r=t&&t.__createBinding||(Object.create?function(t,e,r,i){void 0===i&&(i=r);var n=Object.getOwnPropertyDescriptor(e,r);n&&!("get"in n?!e.__esModule:n.writable||n.configurable)||(n={enumerable:!0,get:function(){return e[r]}}),Object.defineProperty(t,i,n)}:function(t,e,r,i){void 0===i&&(i=r),t[i]=e[r]}),i=t&&t.__exportStar||function(t,e){for(var i in t)"default"===i||Object.prototype.hasOwnProperty.call(e,i)||r(e,t,i)};Object.defineProperty(e,"__esModule",{value:!0}),i(F,e),i(D,e),i(G,e),i(U,e),i(B,e),i(H,e),i(N,e),i(W,e),i(V,e),i(X,e),i(z,e),i(q,e),i(Y,e),i(K,e),i($,e),i(J,e),i(Z,e),i(Q,e),i(tt,e),i(et,e),i(rt,e),i(it,e),i(nt,e),i(ot,e),i(st,e),i(at,e),i(ut,e),i(ct,e),i(dt,e),i(ft,e),i(_t,e),i(yt,e),i(gt,e),i(vt,e),i(mt,e),i(Tt,e),i(At,e),i(wt,e),i(St,e),i(bt,e),i(Pt,e)}(I);var xt={},Et={};Object.defineProperty(Et,"__esModule",{value:!0}),Et.AudioPlayContext=void 0;var Ot=P,kt=function(){function t(t){var e;this.onPlay=new Ot.Trigger,this.onStop=new Ot.Trigger,this.asset=t.asset,this._system=t.system,this._resourceFactory=t.resourceFactory,this._volume=null!==(e=t.volume)&&void 0!==e?e:1,this._id=t.id,this._systemId=t.systemId,this._player=this._createAudioPlayer(),this.asset.onDestroyed.addOnce(this.stop,this)}return Object.defineProperty(t.prototype,"volume",{get:function(){return this._volume},enumerable:!1,configurable:!0}),t.prototype.play=function(){this._player.play(this.asset)},t.prototype.stop=function(){this._player.stop()},t.prototype.changeVolume=function(t){this._volume=t,this._player.changeVolume(t)},t.prototype._startSuppress=function(){"music"!==this._systemId?this.stop():this._player.changeVolume(0)},t.prototype._endSuppress=function(){"music"!==this._systemId||this._player.changeVolume(this._volume)},t.prototype._createAudioPlayer=function(){var t=this._resourceFactory.createAudioPlayer(this._system);return t.changeVolume(this._volume),t.onPlay.add(this.onPlay.fire,this.onPlay),t.onStop.add(this.onStop.fire,this.onStop),t},t}();Et.AudioPlayContext=kt;var Mt,Lt={};Object.defineProperty(Lt,"__esModule",{value:!0}),Lt.ExceptionFactory=void 0,function(t){t.createAssertionError=function(t,e){var r=new Error(t);return r.name="AssertionError",r.cause=e,r},t.createTypeMismatchError=function(t,e,r,i){var o="Type mismatch on "+t+", expected type is "+e;if(arguments.length>2)try{var s=void 0;o+=", actual type is "+((s=r&&r.constructor&&r.constructor.name?r.constructor.name:n(r)).length>40?s.substr(0,40):s)}catch(t){}o+=".";var a=new Error(o);return a.name="TypeMismatchError",a.cause=i,a.expected=e,a.actual=r,a},t.createAssetLoadError=function(t,e,r,i){void 0===e&&(e=!0);var n=new Error(t);return n.name="AssetLoadError",n.cause=i,n.retriable=e,n},t.createRequestAssetLoadError=function(t,e,r){var i=new Error(t);return i.name="RequestAssetLoadError",i.detail=e,i.cause=r,i}}(Mt||(Lt.ExceptionFactory=Mt={}));var Rt={};Object.defineProperty(Rt,"__esModule",{value:!0}),Rt.WeakRefKVS=void 0;var Ct=function(){function t(t){this._target=t}return t.prototype.deref=function(){return this._target},t}(),It=function(){function t(){this._weakRefClass="undefined"!=typeof WeakRef?WeakRef:Ct,this._refMap=Object.create(null)}return t.prototype.set=function(t,e){this._refMap[t]&&this.delete(t),this._refMap[t]=new this._weakRefClass(e)},t.prototype.get=function(t){var e=this._refMap[t];if(e)return e.deref()},t.prototype.has=function(t){return t in this._refMap},t.prototype.delete=function(t){delete this._refMap[t]},t.prototype.keys=function(){return Object.keys(this._refMap)},t.prototype.clear=function(){this._refMap=Object.create(null)},t.prototype.clean=function(){for(var t=0,e=Object.entries(this._refMap);t<e.length;t++){var r=e[t],i=r[0];void 0===r[1].deref()&&this.delete(i)}},t}();Rt.WeakRefKVS=It;var Ft,Dt=t&&t.__extends||(Ft=function(t,e){return Ft=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r])},Ft(t,e)},function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");function r(){this.constructor=t}Ft(t,e),t.prototype=null===e?Object.create(e):(r.prototype=e.prototype,new r)});Object.defineProperty(xt,"__esModule",{value:!0}),xt.SoundAudioSystem=xt.MusicAudioSystem=xt.AudioSystem=void 0;var jt=Et,Gt=Lt,Ut=Rt,Bt=function(){function t(t){this.id=t.id,this._volume=t.volume||1,this._destroyRequestedAssets={},this._explicitMuted=t.muted||!1,this._suppressed=!1,this._muted=!1,this._contextMap=new Ut.WeakRefKVS,this._contextCount=0,this._resourceFactory=t.resourceFactory,this._updateMuted()}return Object.defineProperty(t.prototype,"volume",{get:function(){return this._volume},set:function(t){if(t<0||t>1||isNaN(t)||"number"!=typeof t)throw Gt.ExceptionFactory.createAssertionError("AudioSystem#volume: expected: 0.0-1.0, actual: "+t);this._volume=t,this._onVolumeChanged()},enumerable:!1,configurable:!0}),t.prototype.play=function(t){var e=this.create(t);return e.play(),e},t.prototype.create=function(t){var e=new jt.AudioPlayContext({id:this._generateAudioPlayContextId(),resourceFactory:this._resourceFactory,asset:t,system:this,systemId:this.id,volume:1});return this._contextCount%this._contentMapCleaningFrequency==0&&this._contextMap.clean(),this._contextMap.set(e._id,e),e},t.prototype.stopAll=function(){for(var t=0,e=this._contextMap.keys();t<e.length;t++){var r=e[t],i=this._contextMap.get(r);null==i||i.stop()}this._contextMap.clean()},t.prototype.requestDestroy=function(t){this._destroyRequestedAssets[t.id]=t},t.prototype.cancelRequestDestroy=function(t){delete this._destroyRequestedAssets[t.id]},t.prototype.getDestroyRequestedAsset=function(t){return this._destroyRequestedAssets.hasOwnProperty(t)?this._destroyRequestedAssets[t]:null},t.prototype._reset=function(){this.stopAll(),this._volume=1,this._destroyRequestedAssets={},this._muted=!1,this._suppressed=!1,this._explicitMuted=!1},t.prototype._setMuted=function(t){var e=this._explicitMuted;this._explicitMuted=!!t,this._explicitMuted!==e&&(this._updateMuted(),this._onMutedChanged())},t.prototype._setPlaybackRate=function(t){if(t<0||isNaN(t)||"number"!=typeof t)throw Gt.ExceptionFactory.createAssertionError("AudioSystem#playbackRate: expected: greater or equal to 0.0, actual: "+t);this._suppressed=1!==t,this._updateMuted(),this._onPlaybackRateChanged()},t.prototype._updateMuted=function(){this._muted=this._explicitMuted||this._suppressed},t.prototype._generateAudioPlayContextId=function(){return"".concat(this.id,"-").concat(this._contextCount++)},t.prototype._startSuppress=function(){this._setPlaybackRate(100);for(var t=0,e=this._contextMap.keys();t<e.length;t++){var r=e[t],i=this._contextMap.get(r);null==i||i._startSuppress()}},t.prototype._endSuppress=function(){this._setPlaybackRate(1);for(var t=0,e=this._contextMap.keys();t<e.length;t++){var r=e[t],i=this._contextMap.get(r);null==i||i._endSuppress()}},t}();xt.AudioSystem=Bt;var Ht=function(t){function e(e){var r=t.call(this,e)||this;return r._contentMapCleaningFrequency=5,r._player=void 0,r}return Dt(e,t),Object.defineProperty(e.prototype,"player",{get:function(){return this._player||(this._player=this._resourceFactory.createAudioPlayer(this),this._player.onPlay.add(this._handlePlay,this),this._player.onStop.add(this._handleStop,this)),this._player},set:function(t){this._player=t},enumerable:!1,configurable:!0}),e.prototype.findPlayers=function(t){return this.player.currentAudio&&this.player.currentAudio.id===t.id?[this.player]:[]},e.prototype.createPlayer=function(){return this.player},e.prototype.stopAll=function(){t.prototype.stopAll.call(this),this._player&&this._player.stop()},e.prototype._reset=function(){t.prototype._reset.call(this),this._player&&(this._player.onPlay.remove(this._handlePlay,this),this._player.onStop.remove(this._handleStop,this)),this._player=void 0},e.prototype._onVolumeChanged=function(){this.player._notifyVolumeChanged()},e.prototype._onMutedChanged=function(){this.player._changeMuted(this._muted)},e.prototype._onPlaybackRateChanged=function(){this.player._changeMuted(this._muted)},e.prototype._handlePlay=function(t){if(t.player!==this._player)throw Gt.ExceptionFactory.createAssertionError("MusicAudioSystem#_onPlayerPlayed: unexpected audio player")},e.prototype._handleStop=function(t){this._destroyRequestedAssets[t.audio.id]&&(delete this._destroyRequestedAssets[t.audio.id],t.audio.destroy())},e}(Bt);xt.MusicAudioSystem=Ht;var Nt=function(t){function e(e){var r=t.call(this,e)||this;return r._contentMapCleaningFrequency=50,r.players=[],r}return Dt(e,t),e.prototype.createPlayer=function(){var t=this._resourceFactory.createAudioPlayer(this);return t.canHandleStopped()&&this.players.push(t),t.onPlay.add(this._handlePlay,this),t.onStop.add(this._handleStop,this),t},e.prototype.findPlayers=function(t){for(var e=[],r=0;r<this.players.length;++r){var i=this.players[r].currentAudio;i&&i.id===t.id&&e.push(this.players[r])}return e},e.prototype.stopAll=function(){t.prototype.stopAll.call(this);for(var e=this.players.concat(),r=0;r<e.length;++r)e[r].stop()},e.prototype._reset=function(){t.prototype._reset.call(this);for(var e=0;e<this.players.length;++e){var r=this.players[e];r.onPlay.remove(this._handlePlay,this),r.onStop.remove(this._handleStop,this)}this.players=[]},e.prototype._onMutedChanged=function(){for(var t=this.players,e=0;e<t.length;++e)t[e]._changeMuted(this._muted)},e.prototype._onPlaybackRateChanged=function(){var t=this.players;if(this._suppressed)for(var e=0;e<t.length;++e)t[e]._changeMuted(!0)},e.prototype._handlePlay=function(t){},e.prototype._handleStop=function(t){var e=this.players.indexOf(t.player);e<0||(t.player.onStop.remove(this._handleStop,this),this.players.splice(e,1),this._destroyRequestedAssets[t.audio.id]&&(delete this._destroyRequestedAssets[t.audio.id],t.audio.destroy()))},e.prototype._onVolumeChanged=function(){for(var t=0;t<this.players.length;++t)this.players[t]._notifyVolumeChanged()},e}(Bt);xt.SoundAudioSystem=Nt;var Wt,Vt={},Xt={};Object.defineProperty(Xt,"__esModule",{value:!0}),Xt.PathUtil=void 0,function(t){t.resolvePath=function(e,r){function i(t){var e=t.split("/");return""===e[e.length-1]&&e.pop(),e}if(""===r)return e;for(var n=t.splitPath(e),o=i(n.path).concat(i(r)),s=[],a=0;a<o.length;++a){var h=o[a];switch(h){case"..":var u=s.pop();if(void 0===u||""===u||"."===u)throw new Error("PathUtil.resolvePath: invalid arguments");break;case".":0===s.length&&s.push(".");break;case"":s=[""];break;default:s.push(h)}}return n.host+s.join("/")},t.resolveDirname=function(t){var e=t.lastIndexOf("/");return-1===e?t:t.substr(0,e)},t.resolveExtname=function(t){for(var e=t.length-1;e>=0;--e){var r=t.charAt(e);if("."===r)return t.substr(e);if("/"===r)return""}return""},t.makeNodeModulePaths=function(e){var r=t.splitPath(e),i=r.host;"/"===(e=r.path)[e.length-1]&&(e=e.slice(0,e.length-1));for(var n=e.split("/"),o=n.indexOf("node_modules"),s=o>0?o-1:0,a=[],h=n.length-1;h>=s;--h)if("node_modules"!==n[h]){var u=n.slice(0,h+1);u.push("node_modules");var c=u.join("/");a.push(i+c)}return a},t.splitPath=function(t){var e="",r=t.indexOf("//");if(r>=0){var i=t.indexOf("/",r+2);i>=0?(e=t.slice(0,i),t=t.slice(i)):(e=t,t="/")}else e="";return{host:e,path:t}}}(Wt||(Xt.PathUtil=Wt={})),Object.defineProperty(Vt,"__esModule",{value:!0}),Vt.Module=void 0;var zt=Xt,qt=function(t){var e=this,r=t.path,i=zt.PathUtil.resolveDirname(r),n=t.virtualPath,o=n?zt.PathUtil.resolveDirname(n):void 0,s=t.requireFunc,a=t.resolveFunc;this._runtimeValue=Object.create(t.runtimeValueBase,{filename:{value:r,enumerable:!0},dirname:{value:i,enumerable:!0},module:{value:this,writable:!0,enumerable:!0,configurable:!0}}),this.id=t.id,this.filename=t.path,this.exports={},this.parent=null,this.loaded=!1,this.children=[],this.paths=o?zt.PathUtil.makeNodeModulePaths(o):[],this._dirname=i,this._virtualDirname=o;var h=function(t){return s(t,e)};h.resolve=function(t){return a(t,e)},this.require=h};Vt.Module=qt;var Yt={};Object.defineProperty(Yt,"__esModule",{value:!0}),Yt.ShaderProgram=void 0;var Kt=function(t){this.fragmentShader=t.fragmentShader,this.uniforms=t.uniforms};Yt.ShaderProgram=Kt;var $t={};Object.defineProperty($t,"__esModule",{value:!0}),$t.VideoSystem=void 0;var Jt=function(){};$t.VideoSystem=Jt;var Zt={},Qt={},te={},ee=t&&t.__extends||function(){var t=function(e,r){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r])},t(e,r)};return function(e,r){if("function"!=typeof r&&null!==r)throw new TypeError("Class extends value "+String(r)+" is not a constructor or null");function i(){this.constructor=e}t(e,r),e.prototype=null===r?Object.create(r):(i.prototype=r.prototype,new i)}}();Object.defineProperty(te,"__esModule",{value:!0}),te.SeedEvent=te.PlayerInfoEvent=te.TimestampEvent=te.LeaveEvent=te.JoinEvent=te.OperationEvent=te.MessageEvent=te.PointMoveEventBase=te.PointUpEventBase=te.PointDownEventBase=te.PointEventBase=void 0;var re=function(t,e,r,i,n,o,s){this.eventFlags=o,this.local=!!n,this.player=i,this.pointerId=t,this.target=e,this.point=r,this.button=null!=s?s:0};te.PointEventBase=re;var ie=function(t){function e(){var e=null!==t&&t.apply(this,arguments)||this;return e.type="point-down",e}return ee(e,t),e}(re);te.PointDownEventBase=ie;var ne=function(t){function e(e,r,i,n,o,s,a,h,u){var c=t.call(this,e,r,i,s,a,h,u)||this;return c.type="point-up",c.prevDelta=n,c.startDelta=o,c}return ee(e,t),e}(re);te.PointUpEventBase=ne;var oe=function(t){function e(e,r,i,n,o,s,a,h,u){var c=t.call(this,e,r,i,s,a,h,u)||this;return c.type="point-move",c.prevDelta=n,c.startDelta=o,c}return ee(e,t),e}(re);te.PointMoveEventBase=oe;var se=function(t,e,r,i){this.type="message",this.eventFlags=i,this.local=!!r,this.player=e,this.data=t};te.MessageEvent=se;var ae=function(t,e,r,i,n){this.type="operation",this.eventFlags=n,this.local=!!i,this.player=r,this.code=t,this.data=e};te.OperationEvent=ae;var he=function(t,e){this.type="join",this.eventFlags=e,this.player=t};te.JoinEvent=he;var ue=function(t,e){this.type="leave",this.eventFlags=e,this.player=t};te.LeaveEvent=ue;var ce=function(t,e,r){this.type="timestamp",this.eventFlags=r,this.player=e,this.timestamp=t};te.TimestampEvent=ce;var le=function(t,e){this.type="player-info",this.eventFlags=e,this.player=t};te.PlayerInfoEvent=le;var de=function(t,e){this.type="seed",this.eventFlags=e,this.generator=t};te.SeedEvent=de;var pe={};Object.defineProperty(pe,"__esModule",{value:!0}),pe.PlainMatrix=void 0;var fe=function(){function t(t,e,r,i,n,o,s){void 0===t?(this._modified=!1,this._matrix=[1,0,0,1,0,0]):"number"==typeof t?(this._modified=!1,this._matrix=new Array(6),this.update(t,e,r,i,n,0,0,o,s)):(this._modified=t._modified,this._matrix=[t._matrix[0],t._matrix[1],t._matrix[2],t._matrix[3],t._matrix[4],t._matrix[5]])}return t.prototype.update=function(t,e,r,i,n,o,s,a,h){if(null!=a&&null!=h){var u=n*Math.PI/180,c=Math.cos(u),l=Math.sin(u),d=c*r,p=l*r,f=l*i,_=c*i,y=a*t,g=h*e;this._matrix[0]=d,this._matrix[1]=p,this._matrix[2]=-f,this._matrix[3]=_,this._matrix[4]=-d*y+f*g+o,this._matrix[5]=-p*y-_*g+s}else this._updateWithoutAnchor(t,e,r,i,n,o,s)},t.prototype._updateWithoutAnchor=function(t,e,r,i,n,o,s){var a=n*Math.PI/180,h=Math.cos(a),u=Math.sin(a),c=h*r,l=u*r,d=u*i,p=h*i,f=t/2,_=e/2;this._matrix[0]=c,this._matrix[1]=l,this._matrix[2]=-d,this._matrix[3]=p,this._matrix[4]=-c*f+d*_+f+o,this._matrix[5]=-l*f-p*_+_+s},t.prototype.updateByInverse=function(t,e,r,i,n,o,s,a,h){if(null!=a&&null!=h){var u=n*Math.PI/180,c=Math.cos(u),l=Math.sin(u),d=c/r,p=l/i,f=l/r,_=c/i,y=a*t,g=h*e;this._matrix[0]=d,this._matrix[1]=-p,this._matrix[2]=f,this._matrix[3]=_,this._matrix[4]=-d*o-f*s+y,this._matrix[5]=p*o-_*s+g}else this._updateByInverseWithoutAnchor(t,e,r,i,n,o,s)},t.prototype._updateByInverseWithoutAnchor=function(t,e,r,i,n,o,s){var a=n*Math.PI/180,h=Math.cos(a),u=Math.sin(a),c=h/r,l=u/i,d=u/r,p=h/i,f=t/2,_=e/2;this._matrix[0]=c,this._matrix[1]=-l,this._matrix[2]=d,this._matrix[3]=p,this._matrix[4]=-c*(f+o)-d*(_+s)+f,this._matrix[5]=l*(f+o)-p*(_+s)+_},t.prototype.multiply=function(t){var e=this._matrix,r=t._matrix,i=e[0],n=e[1],o=e[2],s=e[3];e[0]=i*r[0]+o*r[1],e[1]=n*r[0]+s*r[1],e[2]=i*r[2]+o*r[3],e[3]=n*r[2]+s*r[3],e[4]=i*r[4]+o*r[5]+e[4],e[5]=n*r[4]+s*r[5]+e[5]},t.prototype.multiplyLeft=function(t){var e=t._matrix,r=this._matrix,i=r[0],n=r[2],o=r[4];r[0]=e[0]*i+e[2]*r[1],r[1]=e[1]*i+e[3]*r[1],r[2]=e[0]*n+e[2]*r[3],r[3]=e[1]*n+e[3]*r[3],r[4]=e[0]*o+e[2]*r[5]+e[4],r[5]=e[1]*o+e[3]*r[5]+e[5]},t.prototype.multiplyNew=function(t){var e=this.clone();return e.multiply(t),e},t.prototype.reset=function(t,e){this._matrix[0]=1,this._matrix[1]=0,this._matrix[2]=0,this._matrix[3]=1,this._matrix[4]=t||0,this._matrix[5]=e||0},t.prototype.clone=function(){return new t(this)},t.prototype.multiplyInverseForPoint=function(t){var e=this._matrix,r=1/(e[0]*e[3]+e[2]*-e[1]);return{x:e[3]*r*t.x+-e[2]*r*t.y+(e[5]*e[2]-e[4]*e[3])*r,y:e[0]*r*t.y+-e[1]*r*t.x+(-e[5]*e[0]+e[4]*e[1])*r}},t.prototype.scale=function(t,e){var r=this._matrix;r[0]*=t,r[1]*=e,r[2]*=t,r[3]*=e,r[4]*=t,r[5]*=e},t.prototype.multiplyPoint=function(t){var e=this._matrix;return{x:e[0]*t.x+e[2]*t.y+e[4],y:e[1]*t.x+e[3]*t.y+e[5]}},t}();pe.PlainMatrix=fe;var _e={};Object.defineProperty(_e,"__esModule",{value:!0}),_e.Object2D=void 0;var ye=Lt,ge=pe,ve=function(){function t(t){t?(this.x=t.x||0,this.y=t.y||0,this.width=t.width||0,this.height=t.height||0,this.opacity=null!=t.opacity?t.opacity:1,this.scaleX=null!=t.scaleX?t.scaleX:1,this.scaleY=null!=t.scaleY?t.scaleY:1,this.angle=t.angle||0,this.compositeOperation=t.compositeOperation,this.anchorX=void 0===t.anchorX?0:t.anchorX,this.anchorY=void 0===t.anchorY?0:t.anchorY,this._matrix=void 0):(this.x=0,this.y=0,this.width=0,this.height=0,this.opacity=1,this.scaleX=1,this.scaleY=1,this.angle=0,this.compositeOperation=void 0,this.anchorX=0,this.anchorY=0,this._matrix=void 0)}return t.prototype.moveTo=function(t,e){if("number"==typeof t&&"number"!=typeof e)throw ye.ExceptionFactory.createAssertionError("Object2D#moveTo: arguments must be CommonOffset or pair of x and y as a number.");"number"==typeof t?(this.x=t,this.y=e):(this.x=t.x,this.y=t.y)},t.prototype.moveBy=function(t,e){this.x+=t,this.y+=e},t.prototype.resizeTo=function(t,e){if("number"==typeof t&&"number"!=typeof e)throw ye.ExceptionFactory.createAssertionError("Object2D#resizeTo: arguments must be CommonSize or pair of width and height as a number.");"number"==typeof t?(this.width=t,this.height=e):(this.width=t.width,this.height=t.height)},t.prototype.resizeBy=function(t,e){this.width+=t,this.height+=e},t.prototype.scale=function(t){this.scaleX=t,this.scaleY=t},t.prototype.anchor=function(t,e){this.anchorX=t,this.anchorY=e},t.prototype.getMatrix=function(){if(this._matrix){if(!this._matrix._modified)return this._matrix}else this._matrix=new ge.PlainMatrix;return this._updateMatrix(),this._matrix._modified=!1,this._matrix},t.prototype._updateMatrix=function(){this.angle||1!==this.scaleX||1!==this.scaleY||0!==this.anchorX||0!==this.anchorY?this._matrix.update(this.width,this.height,this.scaleX,this.scaleY,this.angle,this.x,this.y,this.anchorX,this.anchorY):this._matrix.reset(this.x,this.y)},t}();_e.Object2D=ve;var me={};Object.defineProperty(me,"__esModule",{value:!0}),me.Util=void 0;var Te,Ae=I;!function(t){var e;t.distance=function(t,e,r,i){return Math.sqrt(Math.pow(t-r,2)+Math.pow(e-i,2))},t.distanceBetweenOffsets=function(e,r){return t.distance(e.x,e.y,r.x,r.y)},t.distanceBetweenAreas=function(e,r){return t.distance(e.x+e.width/2,e.y+e.height/2,r.x+r.width/2,r.y+r.height/2)},t.charCodeAt=function(t,e){var r=t.charCodeAt(e);return 55296<=r&&r<=56319?r<<16|t.charCodeAt(e+1):56320<=r&&r<=57343?null:r},t.enumToSnakeCase=function(t,e){var r=t[e];return r[0].toLowerCase()+r.slice(1).replace(/[A-Z]/g,(function(t){return"-"+t.toLowerCase()}))},t.clamp=function(t,e,r){return Math.min(Math.max(t,e),r)},t.compositeOperationStringTable=((e={})[Ae.CompositeOperation.SourceOver]="source-over",e[Ae.CompositeOperation.SourceAtop]="source-atop",e[Ae.CompositeOperation.Lighter]="lighter",e[Ae.CompositeOperation.Copy]="copy",e[Ae.CompositeOperation.ExperimentalSourceIn]="experimental-source-in",e[Ae.CompositeOperation.ExperimentalSourceOut]="experimental-source-out",e[Ae.CompositeOperation.ExperimentalDestinationAtop]="experimental-destination-atop",e[Ae.CompositeOperation.ExperimentalDestinationIn]="experimental-destination-in",e[Ae.CompositeOperation.DestinationOut]="destination-out",e[Ae.CompositeOperation.DestinationOver]="destination-over",e[Ae.CompositeOperation.Xor]="xor",e[Ae.CompositeOperation.Difference]="difference",e[Ae.CompositeOperation.Saturation]="saturation",e)}(Te||(me.Util=Te={}));var we=t&&t.__extends||function(){var t=function(e,r){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r])},t(e,r)};return function(e,r){if("function"!=typeof r&&null!==r)throw new TypeError("Class extends value "+String(r)+" is not a constructor or null");function i(){this.constructor=e}t(e,r),e.prototype=null===r?Object.create(r):(i.prototype=r.prototype,new i)}}();Object.defineProperty(Qt,"__esModule",{value:!0}),Qt.E=Qt.PointMoveEvent=Qt.PointUpEvent=Qt.PointDownEvent=void 0;var Se=P,be=te,Pe=Lt,xe=pe,Ee=_e,Oe=me,ke=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return we(e,t),e}(be.PointDownEventBase);Qt.PointDownEvent=ke;var Me=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return we(e,t),e}(be.PointUpEventBase);Qt.PointUpEvent=Me;var Le=function(t){function e(){return null!==t&&t.apply(this,arguments)||this}return we(e,t),e}(be.PointMoveEventBase);Qt.PointMoveEvent=Le;var Re=function(t){function e(e){var r=t.call(this,e)||this;if(r.children=void 0,r.parent=void 0,r._touchable=!1,r.state=0,r._hasTouchableChildren=!1,r._onUpdate=void 0,r._onMessage=void 0,r._onPointDown=void 0,r._onPointMove=void 0,r._onPointUp=void 0,r.tag=e.tag,r.shaderProgram=e.shaderProgram,r.local="non-local"!==e.scene.local||!!e.local,e.children)for(var i=0;i<e.children.length;++i)r.append(e.children[i]);return e.parent&&e.parent.append(r),null!=e.touchable&&(r.touchable=e.touchable),e.hidden&&r.hide(),r.id=e.id,e.scene.register(r),r}return we(e,t),Object.defineProperty(e.prototype,"onUpdate",{get:function(){return this._onUpdate||(this._onUpdate=new Se.ChainTrigger(this.scene.onUpdate)),this._onUpdate},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"onMessage",{get:function(){return this._onMessage||(this._onMessage=new Se.ChainTrigger(this.scene.onMessage)),this._onMessage},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"onPointDown",{get:function(){return this._onPointDown||(this._onPointDown=new Se.ChainTrigger(this.scene.onPointDownCapture,this._isTargetOperation,this)),this._onPointDown},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"onPointUp",{get:function(){return this._onPointUp||(this._onPointUp=new Se.ChainTrigger(this.scene.onPointUpCapture,this._isTargetOperation,this)),this._onPointUp},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"onPointMove",{get:function(){return this._onPointMove||(this._onPointMove=new Se.ChainTrigger(this.scene.onPointMoveCapture,this._isTargetOperation,this)),this._onPointMove},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"touchable",{get:function(){return this._touchable},set:function(t){this._touchable!==t&&(this._touchable=t,t?this._enableTouchPropagation():this._disableTouchPropagation())},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"update",{get:function(){return this.onUpdate},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"message",{get:function(){return this.onMessage},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pointDown",{get:function(){return this.onPointDown},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pointUp",{get:function(){return this.onPointUp},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"pointMove",{get:function(){return this.onPointMove},enumerable:!1,configurable:!0}),e.prototype.render=function(t,e){if(this.state&=-5,!(1&this.state))if(8&this.state){if(t.translate(this.x,this.y),this.renderSelf(t,e)&&this.children)for(var r=(o=this.children).length,i=0;i<r;++i)o[i].render(t,e);t.translate(-this.x,-this.y)}else{t.save(),this.angle||1!==this.scaleX||1!==this.scaleY||0!==this.anchorX||0!==this.anchorY?t.transform(this.getMatrix()._matrix):t.translate(this.x,this.y),1!==this.opacity&&t.opacity(this.opacity);var n=this.compositeOperation;if(void 0!==n&&t.setCompositeOperation("string"==typeof n?n:Oe.Util.compositeOperationStringTable[n]),void 0!==this.shaderProgram&&t.isSupportedShaderProgram()&&t.setShaderProgram(this.shaderProgram),this.renderSelf(t,e)&&this.children){var o=this.children;for(i=0;i<o.length;++i)o[i].render(t,e)}t.restore()}},e.prototype.renderSelf=function(t,e){return!0},e.prototype.game=function(){return this.scene.game},e.prototype.append=function(t){this.insertBefore(t,void 0)},e.prototype.insertBefore=function(t,e){t.parent&&t.remove(),this.children||(this.children=[]),t.parent=this;var r=-1;void 0!==e&&(r=this.children.indexOf(e))>-1?this.children.splice(r,0,t):this.children.push(t),(t._touchable||t._hasTouchableChildren)&&(this._hasTouchableChildren=!0,this._enableTouchPropagation()),this.modified(!0)},e.prototype.remove=function(t){if(void 0!==t){var e=this.children?this.children.indexOf(t):-1;if(e<0)throw Pe.ExceptionFactory.createAssertionError("E#remove: invalid child");this.children[e].parent=void 0,this.children.splice(e,1),(t._touchable||t._hasTouchableChildren)&&(this._findTouchableChildren(this)||(this._hasTouchableChildren=!1,this._disableTouchPropagation())),this.modified(!0)}else this.parent.remove(this)},e.prototype.destroy=function(){if(this.parent&&this.remove(),this.children){for(var t=this.children.length-1;t>=0;--t)this.children[t].destroy();if(0!==this.children.length)throw Pe.ExceptionFactory.createAssertionError("E#destroy: can not destroy all children, "+this.children.length);this.children=void 0}this._onUpdate&&(this._onUpdate.destroy(),this._onUpdate=void 0),this._onMessage&&(this._onMessage.destroy(),this._onMessage=void 0),this._onPointDown&&(this._onPointDown.destroy(),this._onPointDown=void 0),this._onPointMove&&(this._onPointMove.destroy(),this._onPointMove=void 0),this._onPointUp&&(this._onPointUp.destroy(),this._onPointUp=void 0),this.scene.unregister(this)},e.prototype.destroyed=function(){return void 0===this.scene},e.prototype.modified=function(t){this._matrix&&(this._matrix._modified=!0),this.angle||1!==this.scaleX||1!==this.scaleY||0!==this.anchorX||0!==this.anchorY||1!==this.opacity||void 0!==this.compositeOperation||void 0!==this.shaderProgram?this.state&=-9:this.state|=8,4&this.state||(this.state|=4,this.parent&&this.parent.modified(!0))},e.prototype.shouldFindChildrenByPoint=function(t){return!0},e.prototype.findPointSourceByPoint=function(t,e,r){if(!(1&this.state)){var i=(e=e?e.multiplyNew(this.getMatrix()):this.getMatrix().clone()).multiplyInverseForPoint(t);if(this._hasTouchableChildren||r&&this.children&&this.children.length){var n=this.children;if(this.shouldFindChildrenByPoint(i))for(var o=n.length-1;o>=0;--o){var s=n[o];if(r||s._touchable||s._hasTouchableChildren){var a=s.findPointSourceByPoint(t,e,r);if(a)return a}}}if(r||this._touchable)return 0<=i.x&&this.width>i.x&&0<=i.y&&this.height>i.y?{target:this,point:i}:void 0}},e.prototype.visible=function(){return 1!=(1&this.state)},e.prototype.show=function(){1&this.state&&(this.state&=-2,this.parent&&this.parent.modified(!0))},e.prototype.hide=function(){1&this.state||(this.state|=1,this.parent&&this.parent.modified(!0))},e.prototype.calculateBoundingRect=function(){return this._calculateBoundingRect(void 0)},e.prototype.localToGlobal=function(t){for(var r=t,i=this;i instanceof e;i=i.parent)r=i.getMatrix().multiplyPoint(r);return r},e.prototype.globalToLocal=function(t){for(var r=new xe.PlainMatrix,i=this;i instanceof e;i=i.parent)r.multiplyLeft(i.getMatrix());return r.multiplyInverseForPoint(t)},e.prototype._calculateMatrixTo=function(t){for(var r=new xe.PlainMatrix,i=this;i instanceof e&&i!==t;i=i.parent)r.multiplyLeft(i.getMatrix());return r},e.prototype._findLowestCommonAncestorWith=function(t){for(var r={},i=this;i instanceof e;i=i.parent)r[i.id]=!0;for(var n=t;n instanceof e&&!r.hasOwnProperty(n.id);n=n.parent);return n},e.prototype._calculateBoundingRect=function(t){var e=this.getMatrix();if(t&&(e=t.multiplyNew(e)),this.visible()){for(var r={left:0,right:this.width,top:0,bottom:this.height},i=[{x:r.left,y:r.top},{x:r.left,y:r.bottom},{x:r.right,y:r.top},{x:r.right,y:r.bottom}],n=e.multiplyPoint(i[0]),o={left:n.x,right:n.x,top:n.y,bottom:n.y},s=1;s<i.length;++s)n=e.multiplyPoint(i[s]),o.left>n.x&&(o.left=n.x),o.right<n.x&&(o.right=n.x),o.top>n.y&&(o.top=n.y),o.bottom<n.y&&(o.bottom=n.y);if(void 0!==this.children)for(s=0;s<this.children.length;++s){var a=this.children[s]._calculateBoundingRect(e);a&&(o.left>a.left&&(o.left=a.left),o.right<a.right&&(o.right=a.right),o.top>a.top&&(o.top=a.top),o.bottom<a.bottom&&(o.bottom=a.bottom))}return o}},e.prototype._enableTouchPropagation=function(){for(var t=this.parent;t instanceof e&&!t._hasTouchableChildren;)t._hasTouchableChildren=!0,t=t.parent},e.prototype._disableTouchPropagation=function(){for(var t=this.parent;t instanceof e&&t._hasTouchableChildren&&!this._findTouchableChildren(t);)t._hasTouchableChildren=!1,t=t.parent},e.prototype._isTargetOperation=function(t){return!(1&this.state)&&(t instanceof be.PointEventBase&&(this._touchable&&t.target===this))},e.prototype._findTouchableChildren=function(t){if(t.children)for(var e=0;e<t.children.length;++e){if(t.children[e].touchable)return t.children[e];var r=this._findTouchableChildren(t.children[e]);if(r)return r}},e}(Ee.Object2D);Qt.E=Re;var Ce=t&&t.__extends||function(){var t=function(e,r){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r])},t(e,r)};return function(e,r){if("function"!=typeof r&&null!==r)throw new TypeError("Class extends value "+String(r)+" is not a constructor or null");function i(){this.constructor=e}t(e,r),e.prototype=null===r?Object.create(r):(i.prototype=r.prototype,new i)}}();Object.defineProperty(Zt,"__esModule",{value:!0}),Zt.CacheableE=void 0;var Ie=function(t){function e(e){var r=t.call(this,e)||this;return r._shouldRenderChildren=!0,r._cache=void 0,r._renderer=void 0,r._renderedCamera=void 0,r}return Ce(e,t),e.prototype.invalidate=function(){this.state&=-3,this.modified()},e.prototype.renderSelf=function(t,r){var i=e.PADDING;if(this._renderedCamera!==r&&(this.state&=-3,this._renderedCamera=r),!(2&this.state)){this._cacheSize=this.calculateCacheSize();var n=Math.ceil(this._cacheSize.width)+2*i,o=Math.ceil(this._cacheSize.height)+2*i,s=!this._cache||this._cache.width<n||this._cache.height<o;s&&(this._cache&&!this._cache.destroyed()&&this._cache.destroy(),this._cache=this.scene.game.resourceFactory.createSurface(n,o),this._renderer=this._cache.renderer());var a=this._renderer;a.begin(),s||a.clear(),a.save(),a.translate(i,i),this.renderCache(a,r),a.restore(),this.state|=2,a.end()}return this._cache&&this._cacheSize.width>0&&this._cacheSize.height>0&&(t.translate(-i,-i),this.renderSelfFromCache(t),t.translate(i,i)),this._shouldRenderChildren},e.prototype.renderSelfFromCache=function(t){t.drawImage(this._cache,0,0,this._cacheSize.width+e.PADDING,this._cacheSize.height+e.PADDING,0,0)},e.prototype.destroy=function(){this._cache&&!this._cache.destroyed()&&this._cache.destroy(),this._cache=void 0,t.prototype.destroy.call(this)},e.prototype.calculateCacheSize=function(){return{width:this.width,height:this.height}},e.PADDING=1,e}(Qt.E);Zt.CacheableE=Ie;var Fe={},De=t&&t.__extends||function(){var t=function(e,r){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r])},t(e,r)};return function(e,r){if("function"!=typeof r&&null!==r)throw new TypeError("Class extends value "+String(r)+" is not a constructor or null");function i(){this.constructor=e}t(e,r),e.prototype=null===r?Object.create(r):(i.prototype=r.prototype,new i)}}();Object.defineProperty(Fe,"__esModule",{value:!0}),Fe.FilledRect=void 0;var je=Lt,Ge=function(t){function e(e){var r=t.call(this,e)||this;if("string"!=typeof e.cssColor)throw je.ExceptionFactory.createTypeMismatchError("ColorBox#constructor(cssColor)","string",e.cssColor);return r.cssColor=e.cssColor,r}return De(e,t),e.prototype.renderSelf=function(t){return t.fillRect(0,0,this.width,this.height,this.cssColor),!0},e}(Qt.E);Fe.FilledRect=Ge;var Ue={},Be={},He={};Object.defineProperty(He,"__esModule",{value:!0}),He.SurfaceUtil=void 0;var Ne,We=Lt;!function(t){function e(t,e,r,i,n){var o;void 0===n&&(n=4);for(var s=(o="number"==typeof n?{top:n,bottom:n,left:n,right:n}:n).left,a=i.width-o.right,h=o.top,u=i.height-o.bottom,c=o.left,l=e-o.right,d=o.top,p=r-o.bottom,f=[{x:0,y:0,width:o.left,height:o.top},{x:a,y:0,width:o.right,height:o.top},{x:0,y:u,width:o.left,height:o.bottom},{x:a,y:u,width:o.right,height:o.bottom}],_=[{x:0,y:0},{x:l,y:0},{x:0,y:p},{x:l,y:p}],y=0;y<f.length;++y){var g=f[y];t.save(),t.translate(_[y].x,_[y].y),t.drawImage(i,g.x,g.y,g.width,g.height,0,0),t.restore()}var v=[{x:s,y:0,width:a-s,height:o.top},{x:0,y:h,width:o.left,height:u-h},{x:a,y:h,width:o.right,height:u-h},{x:s,y:u,width:a-s,height:o.bottom}],m=[{x:c,y:0,width:l-c,height:o.top},{x:0,y:d,width:o.left,height:p-d},{x:l,y:d,width:o.right,height:p-d},{x:c,y:p,width:l-c,height:o.bottom}];for(y=0;y<v.length;++y){var T=v[y],A=m[y];t.save(),t.translate(A.x,A.y),t.transform([A.width/T.width,0,0,A.height/T.height,0,0]),t.drawImage(i,T.x,T.y,T.width,T.height,0,0),t.restore()}var w=a-s,S=u-h,b=l-c,P=p-d;t.save(),t.translate(c,d),t.transform([b/w,0,0,P/S,0,0]),t.drawImage(i,s,h,w,S,0,0),t.restore()}t.asSurface=function(t){if(t){if("type"in t&&"image"===t.type)return t.asSurface();if("_drawable"in t)return t;throw We.ExceptionFactory.createTypeMismatchError("SurfaceUtil#asSurface","ImageAsset|Surface",t)}},t.setupAnimatingHandler=function(t,e){e.isPlaying()&&t._handleAnimationStart()},t.migrateAnimatingHandler=function(t,e,r){t._handleAnimationStop(),r.isPlaying()&&t._handleAnimationStart()},t.drawNinePatch=function(t,r,i){void 0===i&&(i=4);var n=t.renderer();n.begin(),n.clear(),e(n,t.width,t.height,r,i),n.end()},t.renderNinePatch=e}(Ne||(He.SurfaceUtil=Ne={}));var Ve=t&&t.__extends||function(){var t=function(e,r){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r])},t(e,r)};return function(e,r){if("function"!=typeof r&&null!==r)throw new TypeError("Class extends value "+String(r)+" is not a constructor or null");function i(){this.constructor=e}t(e,r),e.prototype=null===r?Object.create(r):(i.prototype=r.prototype,new i)}}();Object.defineProperty(Be,"__esModule",{value:!0}),Be.Sprite=void 0;var Xe=pe,ze=He,qe=function(t){function e(e){var r=t.call(this,e)||this;return r.src=e.src,"_drawable"in e.src?r._surface=e.src:r._surface=ze.SurfaceUtil.asSurface(e.src),null==e.width&&(r.width=r._surface.width),null==e.height&&(r.height=r._surface.height),r.srcWidth=null!=e.srcWidth?e.srcWidth:r.width,r.srcHeight=null!=e.srcHeight?e.srcHeight:r.height,r.srcX=e.srcX||0,r.srcY=e.srcY||0,r._stretchMatrix=void 0,r._beforeSrc=r.src,r._beforeSurface=r._surface,ze.SurfaceUtil.setupAnimatingHandler(r,r._surface),r._invalidateSelf(),r}return Ve(e,t),e.prototype._handleUpdate=function(){this.modified()},e.prototype._handleAnimationStart=function(){this.onUpdate.contains(this._handleUpdate,this)||this.onUpdate.add(this._handleUpdate,this)},e.prototype._handleAnimationStop=function(){this.destroyed()||this.onUpdate.remove(this._handleUpdate,this)},e.prototype.renderSelf=function(t,e){return this.srcWidth<=0||this.srcHeight<=0||(this._stretchMatrix&&(t.save(),t.transform(this._stretchMatrix._matrix)),t.drawImage(this._surface,this.srcX,this.srcY,this.srcWidth,this.srcHeight,0,0),this._stretchMatrix&&t.restore()),!0},e.prototype.invalidate=function(){this._invalidateSelf(),this.modified()},e.prototype.destroy=function(e){this._surface&&!this._surface.destroyed()&&e&&this._surface.destroy(),this.src=void 0,this._beforeSrc=void 0,this._surface=void 0,t.prototype.destroy.call(this)},e.prototype._invalidateSelf=function(){this.width===this.srcWidth&&this.height===this.srcHeight?this._stretchMatrix=void 0:(this._stretchMatrix=new Xe.PlainMatrix,this._stretchMatrix.scale(this.width/this.srcWidth,this.height/this.srcHeight)),this.src!==this._beforeSrc&&(this._beforeSrc=this.src,"_drawable"in this.src?this._surface=this.src:this._surface=ze.SurfaceUtil.asSurface(this.src)),this._surface!==this._beforeSurface&&(ze.SurfaceUtil.migrateAnimatingHandler(this,this._beforeSurface,this._surface),this._beforeSurface=this._surface)},e}(Qt.E);Be.Sprite=qe;var Ye=t&&t.__extends||function(){var t=function(e,r){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r])},t(e,r)};return function(e,r){if("function"!=typeof r&&null!==r)throw new TypeError("Class extends value "+String(r)+" is not a constructor or null");function i(){this.constructor=e}t(e,r),e.prototype=null===r?Object.create(r):(i.prototype=r.prototype,new i)}}();Object.defineProperty(Ue,"__esModule",{value:!0}),Ue.FrameSprite=void 0;var Ke=P,$e=function(t){function e(e){var r=t.call(this,e)||this;return r._lastUsedIndex=0,r.frameNumber=e.frameNumber||0,r.frames=null!=e.frames?e.frames:[0],r.interval=e.interval,r._timer=void 0,r.loop=null==e.loop||e.loop,r.onFinish=new Ke.Trigger,r.finished=r.onFinish,r._modifiedSelf(),r}return Ye(e,t),e.createBySprite=function(t,r,i){var n=new e({scene:t.scene,src:t.src,width:void 0===r?t.width:r,height:void 0===i?t.height:i});return n.srcHeight=void 0===i?t.srcHeight:i,n.srcWidth=void 0===r?t.srcWidth:r,n},e.prototype.start=function(){void 0===this.interval&&(this.interval=1e3/this.game().fps),this._timer&&this._free(),this._timer=this.scene.createTimer(this.interval),this._timer.onElapse.add(this._handleElapse,this)},e.prototype.destroy=function(e){this.stop(),t.prototype.destroy.call(this,e)},e.prototype.stop=function(){this._timer&&this._free()},e.prototype.modified=function(e){this._modifiedSelf(e),t.prototype.modified.call(this,e)},e.prototype._handleElapse=function(){this.frameNumber===this.frames.length-1?this.loop?this.frameNumber=0:(this.stop(),this.onFinish.fire()):this.frameNumber++,this.modified()},e.prototype._free=function(){this._timer&&(this._timer.onElapse.remove(this._handleElapse,this),this._timer.canDelete()&&this.scene.deleteTimer(this._timer),this._timer=void 0)},e.prototype._changeFrame=function(){var t=this.frames[this.frameNumber],e=Math.floor(this._surface.width/this.srcWidth);this.srcX=t%e*this.srcWidth,this.srcY=Math.floor(t/e)*this.srcHeight,this._lastUsedIndex=t},e.prototype._modifiedSelf=function(t){this._lastUsedIndex!==this.frames[this.frameNumber]&&this._changeFrame()},e}(Be.Sprite);Ue.FrameSprite=$e;var Je,Ze={},Qe={};Object.defineProperty(Qe,"__esModule",{value:!0}),Qe.TextAlign=void 0,function(t){t[t.Left=0]="Left",t[t.Center=1]="Center",t[t.Right=2]="Right"}(Je||(Qe.TextAlign=Je={}));var tr=t&&t.__extends||function(){var t=function(e,r){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r])},t(e,r)};return function(e,r){if("function"!=typeof r&&null!==r)throw new TypeError("Class extends value "+String(r)+" is not a constructor or null");function i(){this.constructor=e}t(e,r),e.prototype=null===r?Object.create(r):(i.prototype=r.prototype,new i)}}();Object.defineProperty(Ze,"__esModule",{value:!0}),Ze.Label=void 0;var er=Qe,rr=me,ir=Zt,nr=function(t){function e(e){var r=t.call(this,e)||this;return r.text=e.text,r.font=e.font,r.textAlign=null!=e.textAlign?e.textAlign:er.TextAlign.Left,r.glyphs=new Array(e.text.length),r.fontSize=null!=e.fontSize?e.fontSize:e.font.size,r.maxWidth=e.maxWidth,r.widthAutoAdjust=null==e.widthAutoAdjust||e.widthAutoAdjust,r.textColor=e.textColor,r._realTextAlign="left",r._textWidth=0,r._overhangLeft=0,r._overhangRight=0,r._invalidateSelf(),r}return tr(e,t),e.prototype.aligning=function(t,e){this.width=t,this.widthAutoAdjust=!1,this.textAlign=e},e.prototype.invalidate=function(){this._invalidateSelf(),t.prototype.invalidate.call(this)},e.prototype.renderSelfFromCache=function(t){var e;switch(this._realTextAlign){case"center":e=this.widthAutoAdjust?this._overhangLeft:0;break;case"right":e=this.widthAutoAdjust?this._overhangLeft:this._overhangRight;break;default:e=this._overhangLeft}t.drawImage(this._cache,0,0,this._cacheSize.width+ir.CacheableE.PADDING,this._cacheSize.height+ir.CacheableE.PADDING,e,0)},e.prototype.renderCache=function(t){if(!(!this.fontSize||this.height<=0||this._textWidth<=0)){var e=this.maxWidth&&this.maxWidth>0&&this.maxWidth<this._textWidth?this.maxWidth/this._textWidth:1,r=0;switch(this._realTextAlign){case"center":r=this.width/2-(this._textWidth+this._overhangLeft)/2*e;break;case"right":r=this.width-(this._textWidth+this._overhangLeft)*e;break;default:r-=this._overhangLeft*e}t.translate(Math.round(r),0),1!==e&&t.transform([e,0,0,1,0,0]),t.save();for(var i=this.fontSize/this.font.size,n=0,o=0;o<this.glyphs.length;++o){var s=this.glyphs[o],a=s.advanceWidth*i,h=s.code;s.isSurfaceValid||(s=this.font.glyphForCharacter(h))?(s.surface&&(t.save(),t.translate(Math.round(n),0),t.transform([i,0,0,i,0,0]),t.drawImage(s.surface,s.x,s.y,s.width,s.height,s.offsetX,s.offsetY),t.restore()),n+=a):this._outputOfWarnLogWithNoGlyph(h,"renderCache()")}t.restore(),t.save(),this.textColor&&(t.setCompositeOperation("source-atop"),t.fillRect(0,0,this._textWidth,this.height,this.textColor)),t.restore()}},e.prototype.destroy=function(){t.prototype.destroy.call(this)},e.prototype._invalidateSelf=function(){this.glyphs.length=0,this._textWidth=0;var t=this.textAlign;if(this._realTextAlign="string"==typeof t?t:rr.Util.enumToSnakeCase(er.TextAlign,t),this.fontSize){for(var e=this.text.length-1,r=this.text.length-1;r>=0;--r){if(o=rr.Util.charCodeAt(this.text,r))if((s=this.font.glyphForCharacter(o))&&0!==s.width&&0!==s.advanceWidth){e=r;break}}var i=0,n=this.font.size>0?this.fontSize/this.font.size:0;for(r=0;r<=e;++r){var o,s;if(o=rr.Util.charCodeAt(this.text,r))if(s=this.font.glyphForCharacter(o)){if(!(s.width<0||s.height<0||s.x<0||s.y<0)){this.glyphs.push(s);var a=0;0===r&&(this._overhangLeft=Math.min(s.offsetX,0),a=-this._overhangLeft),r===e&&(this._overhangRight=Math.max(s.width+s.offsetX-s.advanceWidth,0),a+=this._overhangRight),this._textWidth+=(s.advanceWidth+a)*n;var h=s.offsetY+s.height;i<h&&(i=h)}}else this._outputOfWarnLogWithNoGlyph(o,"_invalidateSelf()")}this.widthAutoAdjust&&(this.width=this._textWidth),this.height=i*n}else this.height=0},e.prototype._outputOfWarnLogWithNoGlyph=function(t,e){var r=4294901760&t?String.fromCharCode((4294901760&t)>>>16,65535&t):String.fromCharCode(t);console.warn("Label#"+e+": failed to get a glyph for '"+r+"' (BitmapFont might not have the glyph or DynamicFont might create a glyph larger than its atlas).")},e}(ir.CacheableE);Ze.Label=nr;var or={},sr=t&&t.__extends||function(){var t=function(e,r){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r])},t(e,r)};return function(e,r){if("function"!=typeof r&&null!==r)throw new TypeError("Class extends value "+String(r)+" is not a constructor or null");function i(){this.constructor=e}t(e,r),e.prototype=null===r?Object.create(r):(i.prototype=r.prototype,new i)}}();Object.defineProperty(or,"__esModule",{value:!0}),or.Pane=void 0;var ar=He,hr=function(t){function e(e){var r=t.call(this,e)||this;return r._oldWidth=e.width,r._oldHeight=e.height,r.backgroundImage=e.backgroundImage,r._beforeBackgroundImage=e.backgroundImage,r._backgroundImageSurface=ar.SurfaceUtil.asSurface(e.backgroundImage),r.backgroundEffector=e.backgroundEffector,r._shouldRenderChildren=!1,r._padding=e.padding||0,r._initialize(),r._paddingChanged=!1,r}return sr(e,t),Object.defineProperty(e.prototype,"padding",{get:function(){return this._padding},set:function(t){this._padding=t,this._paddingChanged=!0},enumerable:!1,configurable:!0}),e.prototype.modified=function(e){e&&(this.state&=-3),t.prototype.modified.call(this)},e.prototype.shouldFindChildrenByPoint=function(t){var e=this._normalizedPadding;return e.left<t.x&&this.width-e.right>t.x&&e.top<t.y&&this.height-e.bottom>t.y},e.prototype.renderCache=function(t,e){this.width<=0||this.height<=0||(this._renderBackground(),this._renderChildren(e),this._bgSurface?t.drawImage(this._bgSurface,0,0,this.width,this.height,0,0):this._backgroundImageSurface&&t.drawImage(this._backgroundImageSurface,0,0,this.width,this.height,0,0),this._childrenArea.width<=0||this._childrenArea.height<=0||(t.save(),0===this._childrenArea.x&&0===this._childrenArea.y||t.translate(this._childrenArea.x,this._childrenArea.y),t.drawImage(this._childrenSurface,0,0,this._childrenArea.width,this._childrenArea.height,0,0),t.restore()))},e.prototype.destroy=function(e){e&&this._backgroundImageSurface&&!this._backgroundImageSurface.destroyed()&&this._backgroundImageSurface.destroy(),this._bgSurface&&!this._bgSurface.destroyed()&&this._bgSurface.destroy(),this._childrenSurface&&!this._childrenSurface.destroyed()&&this._childrenSurface.destroy(),this.backgroundImage=void 0,this._backgroundImageSurface=void 0,this._beforeBackgroundImage=void 0,this._bgSurface=void 0,this._childrenSurface=void 0,t.prototype.destroy.call(this)},e.prototype._renderBackground=function(){if(this.backgroundImage!==this._beforeBackgroundImage&&(this._backgroundImageSurface=ar.SurfaceUtil.asSurface(this.backgroundImage),this._beforeBackgroundImage=this.backgroundImage),this._backgroundImageSurface&&this.backgroundEffector){var t=this.backgroundEffector.render(this._backgroundImageSurface,this.width,this.height);this._bgSurface!==t&&(this._bgSurface&&!this._bgSurface.destroyed()&&this._bgSurface.destroy(),this._bgSurface=t)}else this._bgSurface=void 0},e.prototype._renderChildren=function(t){var e=this._oldWidth!==this.width||this._oldHeight!==this.height||this._paddingChanged;if(e&&(this._initialize(),this._paddingChanged=!1,this._oldWidth=this.width,this._oldHeight=this.height),this._childrenRenderer.begin(),e||this._childrenRenderer.clear(),this.children)for(var r=this.children,i=0;i<r.length;++i)r[i].render(this._childrenRenderer,t);this._childrenRenderer.end()},e.prototype._initialize=function(){var t,e=this._padding;t="number"==typeof e?{top:e,bottom:e,left:e,right:e}:e,this._childrenArea={x:t.left,y:t.top,width:this.width-t.left-t.right,height:this.height-t.top-t.bottom};var r=this.scene.game.resourceFactory;this._childrenSurface&&!this._childrenSurface.destroyed()&&this._childrenSurface.destroy(),this._childrenSurface=r.createSurface(Math.ceil(this._childrenArea.width),Math.ceil(this._childrenArea.height)),this._childrenRenderer=this._childrenSurface.renderer(),this._normalizedPadding=t},e.prototype._calculateBoundingRect=function(t){var e=this.getMatrix();if(t&&(e=t.multiplyNew(e)),this.visible()){for(var r={left:0,right:this.width,top:0,bottom:this.height},i=[{x:r.left,y:r.top},{x:r.left,y:r.bottom},{x:r.right,y:r.top},{x:r.right,y:r.bottom}],n=e.multiplyPoint(i[0]),o={left:n.x,right:n.x,top:n.y,bottom:n.y},s=1;s<i.length;++s)n=e.multiplyPoint(i[s]),o.left>n.x&&(o.left=n.x),o.right<n.x&&(o.right=n.x),o.top>n.y&&(o.top=n.y),o.bottom<n.y&&(o.bottom=n.y);return o}},e}(Zt.CacheableE);or.Pane=hr;var ur={};Object.defineProperty(ur,"__esModule",{value:!0}),ur.AssetAccessor=void 0;var cr=function(){function t(t){this._assetManager=t}return t.prototype.getImage=function(t){return this._assetManager.peekLiveAssetByAccessorPath(t,"image")},t.prototype.getAudio=function(t){return this._assetManager.peekLiveAssetByAccessorPath(t,"audio")},t.prototype.getScript=function(t){return this._assetManager.peekLiveAssetByAccessorPath(t,"script")},t.prototype.getText=function(t){return this._assetManager.peekLiveAssetByAccessorPath(t,"text")},t.prototype.getTextContent=function(t){return this.getText(t).data},t.prototype.getJSONContent=function(t){return JSON.parse(this.getTextContent(t))},t.prototype.getVectorImage=function(t){return this._assetManager.peekLiveAssetByAccessorPath(t,"vector-image")},t.prototype.getBinary=function(t){return this._assetManager.peekLiveAssetByAccessorPath(t,"binary")},t.prototype.getBinaryData=function(t){return this.getBinary(t).data},t.prototype.getAllImages=function(t){return this._assetManager.peekAllLiveAssetsByPattern(null!=t?t:"**/*","image")},t.prototype.getAllAudios=function(t){return this._assetManager.peekAllLiveAssetsByPattern(null!=t?t:"**/*","audio")},t.prototype.getAllScripts=function(t){return this._assetManager.peekAllLiveAssetsByPattern(null!=t?t:"**/*","script")},t.prototype.getAllTexts=function(t){return this._assetManager.peekAllLiveAssetsByPattern(null!=t?t:"**/*","text")},t.prototype.getAllVectorImages=function(t){return this._assetManager.peekAllLiveAssetsByPattern(null!=t?t:"**/*","vector-image")},t.prototype.getAllBinaries=function(t){return this._assetManager.peekAllLiveAssetsByPattern(null!=t?t:"**/*","binary")},t.prototype.getImageById=function(t){return this._assetManager.peekLiveAssetById(t,"image")},t.prototype.getAudioById=function(t){return this._assetManager.peekLiveAssetById(t,"audio")},t.prototype.getScriptById=function(t){return this._assetManager.peekLiveAssetById(t,"script")},t.prototype.getTextById=function(t){return this._assetManager.peekLiveAssetById(t,"text")},t.prototype.getTextContentById=function(t){return this.getTextById(t).data},t.prototype.getJSONContentById=function(t){return JSON.parse(this.getTextById(t).data)},t.prototype.getVectorImageById=function(t){return this._assetManager.peekLiveAssetById(t,"vector-image")},t.prototype.getBinaryById=function(t){return this._assetManager.peekLiveAssetById(t,"binary")},t.prototype.getBinaryDataById=function(t){return this.getBinaryById(t).data},t.prototype.pathOf=function(t){return this._assetManager.resolveAccessorPath(t)},t}();ur.AssetAccessor=cr;var lr={};Object.defineProperty(lr,"__esModule",{value:!0});var dr={};Object.defineProperty(dr,"__esModule",{value:!0}),dr.AssetHolder=void 0;var pr=Lt,fr=function(){function t(t){var e=t.assetManager,r=t.assetIds?t.assetIds.concat():[];r.push.apply(r,e.resolvePatternsToAssetIds(t.assetPaths||[])),this.waitingAssetsCount=r.length,this.userData=t.userData,this._assetManager=e,this._assetIds=r,this._assets=[],this._handlerSet=t.handlerSet,this._requested=!1,this._alwaysNotifyFinish=!!t.alwaysNotifyFinish,this._failureAssetIds=[]}return t.prototype.request=function(){return 0!==this.waitingAssetsCount&&(this._requested||(this._requested=!0,this._assetManager.requestAssets(this._assetIds,this)),!0)},t.prototype.destroy=function(){this._requested&&this._assetManager.unrefAssets(this._assets),this.waitingAssetsCount=0,this.userData=void 0,this._handlerSet=void 0,this._assetIds=void 0,this._failureAssetIds=void 0,this._requested=!1},t.prototype.destroyed=function(){return!this._handlerSet},t.prototype._onAssetError=function(t,e){var r=this._handlerSet;if(!this.destroyed()&&!r.owner.destroyed()){var i={asset:t,error:e,cancelRetry:!1};if(r.handleLoadFailure.call(r.owner,i),e.retriable&&!i.cancelRetry)this._assetManager.retryLoad(t);else if(this._assetManager.configuration[t.id])r.handleFinish.call(r.owner,this,!1);else if(this._alwaysNotifyFinish){var n=this._peekAssetConfFromAssetId(t.id);this._failureAssetIds.push(n),this._decrementWaitingAssetCount()}}},t.prototype._onAssetLoad=function(t){var e=this._handlerSet;this.destroyed()||e.owner.destroyed()||(e.handleLoad.call(e.owner,t),this._assets.push(t),this._decrementWaitingAssetCount())},t.prototype._decrementWaitingAssetCount=function(){if(--this.waitingAssetsCount,!(this.waitingAssetsCount>0)){if(this.waitingAssetsCount<0)throw pr.ExceptionFactory.createAssertionError("AssetHolder#_onAssetLoad: broken waitingAssetsCount");var t=this._handlerSet;t.handleFinish.call(t.owner,this,!0)}},t.prototype._getFailureAssetIds=function(){return this._failureAssetIds},t.prototype._peekAssetConfFromAssetId=function(t){for(var e=0,r=this._assetIds;e<r.length;e++){var i=r[e];if(t===("string"==typeof i?i:i.id))return i}throw pr.ExceptionFactory.createAssertionError("AssetHolder#_peekAssetConfFromAssetId: could not peek the asset: ".concat(t))},t}();dr.AssetHolder=fr;var _r={};Object.defineProperty(_r,"__esModule",{value:!0});var yr={},gr={};Object.defineProperty(gr,"__esModule",{value:!0}),gr.EmptyBinaryAsset=void 0;var vr=P,mr=function(){function t(t,e){this.type="binary",this.onDestroyed=new vr.Trigger,this.id=t,this.path=e,this.originalPath=e,this.data=new ArrayBuffer(0)}return t.prototype.inUse=function(){return!1},t.prototype.destroy=function(){this.destroyed()||(this.onDestroyed.destroy(),this.onDestroyed=void 0)},t.prototype.destroyed=function(){return!this.onDestroyed},t.prototype._load=function(t){t._onAssetLoad(this)},t.prototype._assetPathFilter=function(t){return t},t}();gr.EmptyBinaryAsset=mr;var Tr={},Ar={};Object.defineProperty(Ar,"__esModule",{value:!0}),Ar.EmptyVectorImageAsset=void 0;var wr=P,Sr=function(){function t(t,e,r,i,n){this.type="vector-image",this.width=0,this.height=0,this.onDestroyed=new wr.Trigger,this.id=t,this.path=e,this.originalPath=e,this.width=r,this.height=i,this.hint=n}return t.prototype.createSurface=function(t,e,r,i,n,o){return null},t.prototype.inUse=function(){return!1},t.prototype.destroy=function(){this.destroyed()||(this.onDestroyed.destroy(),this.onDestroyed=void 0)},t.prototype.destroyed=function(){return!this.onDestroyed},t.prototype._load=function(t){t._onAssetLoad(this)},t.prototype._assetPathFilter=function(t){return t},t}();Ar.EmptyVectorImageAsset=Sr;var br=t&&t.__extends||function(){var t=function(e,r){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r])},t(e,r)};return function(e,r){if("function"!=typeof r&&null!==r)throw new TypeError("Class extends value "+String(r)+" is not a constructor or null");function i(){this.constructor=e}t(e,r),e.prototype=null===r?Object.create(r):(i.prototype=r.prototype,new i)}}();Object.defineProperty(Tr,"__esModule",{value:!0}),Tr.EmptyGeneratedVectorImageAsset=void 0;var Pr=function(t){function e(e,r,i){var n=t.call(this,e,r,0,0)||this;return n.data=i,n}return br(e,t),e}(Ar.EmptyVectorImageAsset);Tr.EmptyGeneratedVectorImageAsset=Pr;var xr={};Object.defineProperty(xr,"__esModule",{value:!0}),xr.PartialImageAsset=void 0;var Er=P,Or=function(){function t(t,e,r,i,n,o){this.type="image",this.hint=void 0,this.onDestroyed=new Er.Trigger,this._surface=null,this._loadHandler=null,this.id=e,this.path=r,this.originalPath=r,this.width=o.width,this.height=o.height,this._slice=o,this._resourceFactory=t;var s="".concat(e,"/<internal>");this._src=t.createImageAsset(s,r,i,n)}return t.prototype.initialize=function(t){this.hint=t,this._src.initialize(t)},t.prototype.inUse=function(){return!1},t.prototype.destroy=function(){this.destroyed()||(this.onDestroyed.fire(this),this._src.destroy(),this._src=null,this._slice=null,this._resourceFactory=null,this._surface=null,this._loadHandler=null,this.onDestroyed.destroy(),this.onDestroyed=void 0)},t.prototype.destroyed=function(){return!this._src},t.prototype.asSurface=function(){if(this._surface)return this._surface;var t=this._slice,e=t.x,r=t.y,i=t.width,n=t.height,o=this._resourceFactory.createSurface(i,n),s=o.renderer();return s.begin(),s.drawImage(this._src.asSurface(),e,r,i,n,0,0),s.end(),this._surface=o,o},t.prototype._load=function(t){this._loadHandler=t,this._src._load(this)},t.prototype._onAssetLoad=function(t){this._loadHandler._onAssetLoad(this)},t.prototype._onAssetError=function(t,e){this._loadHandler._onAssetError(this,e)},t.prototype._assetPathFilter=function(t){return t},t}();xr.PartialImageAsset=Or,Object.defineProperty(yr,"__esModule",{value:!0}),yr.AssetManager=void 0;var kr=gr,Mr=Tr,Lr=Ar,Rr=xr,Cr=Lt,Ir=$t,Fr=function(t,e){this.asset=t,this.handlers=[e],this.errorCount=0,this.loading=!1};function Dr(t){var e=/([^\*\\\?]*)(\\\*|\\\?|\?|\*(?!\*)|\*\*\/|$)/g,r={"":"","\\*":"\\*","\\?":"\\?","*":"[^/]*","?":"[^/]","**/":"(?:^/)?(?:[^/]+/)*"},i=/[\\^$.*+?()[\]{}|]/g;for(var n="",o=e.exec(t);o&&""!==o[0];o=e.exec(t))n+=o[1].replace(i,"\\$&")+r[o[2]];var s=new RegExp("^"+n+"$");return function(t){return s.test(t)}}var jr=function(){function t(t,e,r,i,n){this._resourceFactory=t.resourceFactory,this._audioSystemManager=t.audio,this._defaultAudioSystemId=t.defaultAudioSystemId,this._audioSystemConfMap=function(t){void 0===t&&(t={});var e={music:{loop:!0,hint:{streaming:!0}},sound:{loop:!1,hint:{streaming:!1}}};for(var r in e)r in t||(t[r]=e[r]);return t}(r),this.configuration=this._normalize(e||{}),this._assets={},this._virtualPathToIdTable={},this._liveAssetVirtualPathTable={},this._liveAssetPathTable={},this._moduleMainScripts=i||{},this._moduleMainPaths=null!=n?n:null,this._refCounts={},this._loadings={},this._generatedAssetCount=0;for(var o=Object.keys(this.configuration),s=0;s<o.length;++s){var a=o[s],h=this.configuration[a];this._virtualPathToIdTable[h.virtualPath]=a}}return t.prototype.destroy=function(){for(var t=Object.keys(this._refCounts),e=0;e<t.length;++e)this._releaseAsset(t[e]);this.configuration=void 0,this._assets=void 0,this._liveAssetVirtualPathTable=void 0,this._liveAssetPathTable=void 0,this._refCounts=void 0,this._loadings=void 0},t.prototype.destroyed=function(){return void 0===this._assets},t.prototype.retryLoad=function(e){if(!this._loadings.hasOwnProperty(e.id))throw Cr.ExceptionFactory.createAssertionError("AssetManager#retryLoad: invalid argument.");var r=this._loadings[e.id];if(r.errorCount>t.MAX_ERROR_COUNT){if(!this.configuration[e.id])return;throw Cr.ExceptionFactory.createAssertionError("AssetManager#retryLoad: too many retrying.")}r.loading||(r.loading=!0,e._load(this))},t.prototype.globalAssetIds=function(){var t=[],e=this.configuration;for(var r in e)e.hasOwnProperty(r)&&e[r].global&&t.push(r);return t},t.prototype.preloadScriptAssetIds=function(){return Object.entries(this.configuration).filter((function(t){var e=t[1];return"script"===e.type&&e.global&&e.preload})).map((function(t){return t[0]}))},t.prototype.resolvePatternsToAssetIds=function(t){if(0===t.length)return[];for(var e=Object.keys(this._virtualPathToIdTable),r=[],i=0;i<t.length;++i)for(var n=t[i],o="string"==typeof n?Dr(this._replaceModulePathToAbsolute(n)):n,s=0;s<e.length;++s){var a=e[s];o("/"+a)&&r.push(this._virtualPathToIdTable[a])}return r},t.prototype.requestAsset=function(t,e){var r;"string"==typeof t?r=t:"uri"in t?(r=t.id,t=this._normalizeAssetBaseDeclaration(r,Object.create(t))):r=t.id;var i,n=!1;if(this._assets.hasOwnProperty(r))++this._refCounts[r],e._onAssetLoad(this._assets[r]);else if(this._loadings.hasOwnProperty(r))(i=this._loadings[r]).handlers.push(e),++this._refCounts[r],n=!0;else{var o=this._getAudioSystem(t),s=null==o?void 0:o.getDestroyRequestedAsset(r);if(o&&s)o.cancelRequestDestroy(s),this._addAssetToTables(s),this._refCounts[r]=1,e._onAssetLoad(s);else{var a=this._createAssetFor(t);i=new Fr(a,e),this._loadings[r]=i,this._refCounts[r]=1,n=!0,i.loading=!0,a._load(this)}}return n},t.prototype.unrefAsset=function(t){var e="string"==typeof t?t:t.id;--this._refCounts[e]>0||this._releaseAsset(e)},t.prototype.requestAssets=function(t,e){for(var r=0,i=0,n=t.length;i<n;++i)this.requestAsset(t[i],e)&&++r;return r},t.prototype.unrefAssets=function(t){for(var e=0,r=t.length;e<r;++e)this.unrefAsset(t[e])},t.prototype.peekLiveAssetByAccessorPath=function(t,e){if("/"!==(t=this._replaceModulePathToAbsolute(t))[0])throw Cr.ExceptionFactory.createAssertionError("AssetManager#peekLiveAssetByAccessorPath(): accessorPath must start with '/'");var r=t.slice(1),i=this._liveAssetVirtualPathTable[r];if(!i||e!==i.type)throw Cr.ExceptionFactory.createAssertionError("AssetManager#peekLiveAssetByAccessorPath(): No ".concat(e," asset for ").concat(t));return i},t.prototype.peekLiveAssetById=function(t,e){var r=this._assets[t];if(!r||e!==r.type)throw Cr.ExceptionFactory.createAssertionError("AssetManager#peekLiveAssetById(): No ".concat(e," asset for id ").concat(t));return r},t.prototype.peekAllLiveAssetsByPattern=function(t,e){for(var r=Object.keys(this._liveAssetVirtualPathTable),i="string"==typeof t?Dr(this._replaceModulePathToAbsolute(t)):t,n=[],o=0;o<r.length;++o){var s=r[o],a=this._liveAssetVirtualPathTable[s];if(!e||a.type===e)i("/"+s)&&n.push(a)}return n},t.prototype.resolveAccessorPath=function(t){var e=this._assets[t];if(!e)return null;var r=this._liveAssetPathTable[e.path];return r?"/"+r:null},t.prototype._normalize=function(t){var e={};if(!(t instanceof Object))throw Cr.ExceptionFactory.createAssertionError("AssetManager#_normalize: invalid arguments.");for(var r in t)if(t.hasOwnProperty(r)){var i=this._normalizeAssetBaseDeclaration(r,Object.create(t[r]));if(!i.path)throw Cr.ExceptionFactory.createAssertionError("AssetManager#_normalize: No path given for: "+r);if(!i.virtualPath)throw Cr.ExceptionFactory.createAssertionError("AssetManager#_normalize: No virtualPath given for: "+r);i.global||(i.global=!1),e[r]=i}return e},t.prototype._normalizeAssetBaseDeclaration=function(t,e){if(!e.type)throw Cr.ExceptionFactory.createAssertionError("AssetManager#_normalize: No type given for: "+t);if("image"===e.type){if("number"!=typeof e.width)throw Cr.ExceptionFactory.createAssertionError("AssetManager#_normalize: wrong width given for the image asset: "+t);if("number"!=typeof e.height)throw Cr.ExceptionFactory.createAssertionError("AssetManager#_normalize: wrong height given for the image asset: "+t);e.slice=e.slice?(r=e.slice,Array.isArray(r)?{x:r[0],y:r[1],width:r[2],height:r[3]}:r):void 0}var r;if("audio"===e.type){void 0===e.duration&&(e.duration=0);var i=this._audioSystemConfMap[e.systemId];if(void 0===e.loop&&(e.loop=!!i&&!!i.loop),void 0===e.hint&&(e.hint=i?i.hint:{}),"music"!==e.systemId&&"sound"!==e.systemId)throw Cr.ExceptionFactory.createAssertionError("AssetManager#_normalize: wrong systemId given for the audio asset: "+t)}if("video"===e.type&&!e.useRealSize){if("number"!=typeof e.width)throw Cr.ExceptionFactory.createAssertionError("AssetManager#_normalize: wrong width given for the video asset: "+t);if("number"!=typeof e.height)throw Cr.ExceptionFactory.createAssertionError("AssetManager#_normalize: wrong height given for the video asset: "+t);e.useRealSize=!1}if("vector-image"===e.type){if("number"!=typeof e.width)throw Cr.ExceptionFactory.createAssertionError("AssetManager#_normalize: wrong width given for the vector-image asset: "+t);if("number"!=typeof e.height)throw Cr.ExceptionFactory.createAssertionError("AssetManager#_normalize: wrong height given for the vector-image asset: "+t)}return e},t.prototype._createAssetFor=function(t){var e,r,i,n;if("string"==typeof t)r=t,n=this.configuration[r],i=this.configuration[r].path;else{if(!("uri"in t))return this._createGeneratedAssetFor(t);r=t.id,n=t,i=t.uri}var o=this._resourceFactory;if(!n)throw Cr.ExceptionFactory.createAssertionError("AssetManager#_createAssetFor: unknown asset ID: "+r);var s=n.type;switch(s){case"image":if(Array.isArray(n.slice))throw new Error("AssetManager#_createAssetFor: array type of configuration.slice is not yet supported");var a=n.slice?new Rr.PartialImageAsset(o,r,i,n.width,n.height,n.slice):o.createImageAsset(r,i,n.width,n.height);return a.initialize(n.hint),a;case"audio":var h=n.systemId?this._audioSystemManager[n.systemId]:this._audioSystemManager[this._defaultAudioSystemId];return o.createAudioAsset(r,i,n.duration,h,!!n.loop,null!==(e=n.hint)&&void 0!==e?e:{},n.offset);case"text":return o.createTextAsset(r,i);case"script":return o.createScriptAsset(r,i,n.exports);case"video":var u=new Ir.VideoSystem;return o.createVideoAsset(r,i,n.width,n.height,u,!!n.loop,!!n.useRealSize);case"vector-image":return o.createVectorImageAsset?o.createVectorImageAsset(r,i,n.width,n.height,n.hint):new Lr.EmptyVectorImageAsset(r,i,n.width,n.height,n.hint);case"binary":return o.createBinaryAsset?o.createBinaryAsset(r,i):new kr.EmptyBinaryAsset(r,i);default:throw Cr.ExceptionFactory.createAssertionError("AssertionError#_createAssetFor: unknown asset type "+s+" for asset ID: "+r)}},t.prototype._createGeneratedAssetFor=function(t){var e=this._resourceFactory,r="%akashic%/generated-asset-".concat(this._generatedAssetCount++);if("vector-image"===t.type)return e.createVectorImageAssetFromString?e.createVectorImageAssetFromString(t.id,r,t.data):new Mr.EmptyGeneratedVectorImageAsset(t.id,r,t.data);throw Cr.ExceptionFactory.createAssertionError("AssertionError#_createFromAssetGenerationFor: unsupported asset type ".concat(t.type," for asset ID: ").concat(t.id))},t.prototype._releaseAsset=function(t){var e=this._assets[t]||this._loadings[t]&&this._loadings[t].asset,r=null;if(e)if(r=e.path,e.inUse())if("audio"===e.type)e._system.requestDestroy(e);else{if("video"!==e.type)throw Cr.ExceptionFactory.createAssertionError("AssetManager#unrefAssets: Unsupported in-use "+e.id);e.destroy()}else e.destroy();if(delete this._refCounts[t],delete this._loadings[t],delete this._assets[t],this.configuration[t]){var i=this.configuration[t].virtualPath;i&&this._liveAssetVirtualPathTable.hasOwnProperty(i)&&delete this._liveAssetVirtualPathTable[i],r&&this._liveAssetPathTable.hasOwnProperty(r)&&delete this._liveAssetPathTable[r]}},t.prototype._countLoadingAsset=function(){return Object.keys(this._loadings).length},t.prototype._onAssetError=function(e,r){if(!this.destroyed()&&!e.destroyed()){var i=this._loadings[e.id],n=i.handlers;i.loading=!1,++i.errorCount,i.errorCount>t.MAX_ERROR_COUNT&&r.retriable&&(r=Cr.ExceptionFactory.createAssetLoadError("Retry limit exceeded",!1,null,r)),r.retriable||delete this._loadings[e.id];for(var o=0;o<n.length;++o)n[o]._onAssetError(e,r,this.retryLoad.bind(this))}},t.prototype._onAssetLoad=function(t){if(!this.destroyed()&&!t.destroyed()){var e=this._loadings[t.id];e.loading=!1,delete this._loadings[t.id],this._addAssetToTables(t);for(var r=e.handlers,i=0;i<r.length;++i)r[i]._onAssetLoad(t)}},t.prototype._replaceModulePathToAbsolute=function(t){if("/"===t[0]||"*"===t[0])return t;for(var e in this._moduleMainScripts)if(this._moduleMainScripts.hasOwnProperty(e)&&0===t.lastIndexOf(e,0))return"/node_modules/"+t;return t},t.prototype._getAudioSystem=function(t){var e=null;if("string"==typeof t)e=this.configuration[t];else if("uri"in t){e=t}return e?"audio"!==e.type?null:e.systemId?this._audioSystemManager[e.systemId]:this._audioSystemManager[this._defaultAudioSystemId]:null},t.prototype._addAssetToTables=function(t){if(this._assets[t.id]=t,this.configuration[t.id]){var e=this.configuration[t.id].virtualPath;if(this._liveAssetVirtualPathTable.hasOwnProperty(e)){if(this._liveAssetVirtualPathTable[e].path!==t.path)throw Cr.ExceptionFactory.createAssertionError("AssetManager#_onAssetLoad(): duplicated asset path")}else this._liveAssetVirtualPathTable[e]=t;this._liveAssetPathTable.hasOwnProperty(t.path)||(this._liveAssetPathTable[t.path]=e)}},t.MAX_ERROR_COUNT=3,t}();yr.AssetManager=jr;var Gr={};Object.defineProperty(Gr,"__esModule",{value:!0});var Ur={};Object.defineProperty(Ur,"__esModule",{value:!0}),Ur.AudioSystemManager=void 0;var Br=xt,Hr=Lt,Nr=function(){function t(t){this._muted=!1,this._resourceFactory=t,this.music=new Br.MusicAudioSystem({id:"music",muted:this._muted,resourceFactory:t}),this.sound=new Br.SoundAudioSystem({id:"sound",muted:this._muted,resourceFactory:t})}return t.prototype.create=function(t){if("music"===t._system.id)return this.music.create(t);if("sound"===t._system.id)return this.sound.create(t);throw Hr.ExceptionFactory.createAssertionError('AudioSystemManager#create(): unknown systemId "'.concat(t._system.id,'" for asset ID "').concat(t.id,'"'))},t.prototype.play=function(t){if("music"===t._system.id)return this.music.play(t);if("sound"===t._system.id)return this.sound.play(t);throw Hr.ExceptionFactory.createAssertionError('AudioSystemManager#play(): unknown systemId "'.concat(t._system.id,'" for asset ID "').concat(t.id,'"'))},t.prototype._reset=function(){this._muted=!1,this.music._reset(),this.sound._reset()},t.prototype._setMuted=function(t){this._muted!==t&&(this._muted=t,this.music._setMuted(t),this.sound._setMuted(t))},t.prototype._setPlaybackRate=function(t){this.music._setPlaybackRate(t),this.sound._setPlaybackRate(t)},t.prototype._startSuppress=function(){this.music._startSuppress(),this.sound._startSuppress()},t.prototype._endSuppress=function(){this.music._endSuppress(),this.sound._endSuppress()},t.prototype.stopAll=function(){this.music.stopAll(),this.sound.stopAll()},t}();Ur.AudioSystemManager=Nr;var Wr={};Object.defineProperty(Wr,"__esModule",{value:!0}),Wr.AudioUtil=void 0;var Vr,Xr=me,zr=function(t,e,r,i){return r*t/i+e};!function(t){function e(t,e,r,n,o){void 0===n&&(n=1),void 0===o&&(o=zr),e.changeVolume(0),e.play();var s=i(t,e,r,n,o),a=s.complete,h=s.cancel;return{complete:function(){a()},cancel:function(t){void 0===t&&(t=!1),h(t),t&&e.stop()}}}function r(t,e,r,n){void 0===n&&(n=zr);var o=i(t,e,r,0,n),s=o.complete,a=o.cancel;return{complete:function(){s(),e.stop()},cancel:function(t){void 0===t&&(t=!1),a(t)}}}function i(t,e,r,i,n){void 0===n&&(n=zr);var o=1e3/t.fps,s=e.volume,a=0;e.changeVolume(Xr.Util.clamp(s,0,1));var h=function(){if((a+=o)<=r){var t=n(a,s,i-s,r);return e.changeVolume(Xr.Util.clamp(t,0,1)),!1}return e.changeVolume(i),!0},u=function(){t.onUpdate.contains(h)&&t.onUpdate.remove(h)};return t.onUpdate.add(h),{complete:function(){u(),e.changeVolume(i)},cancel:function(t){u(),t&&e.changeVolume(s)}}}t.fadeIn=e,t.fadeOut=r,t.crossFade=function(t,i,n,o,s,a){void 0===s&&(s=1),void 0===a&&(a=zr);var h=e(t,i,o,s,a),u=r(t,n,o,a);return{complete:function(){h.complete(),u.complete()},cancel:function(t){void 0===t&&(t=!1),h.cancel(t),u.cancel(t)}}},t.transitionVolume=i}(Vr||(Wr.AudioUtil=Vr={}));var qr={},Yr={};Object.defineProperty(Yr,"__esModule",{value:!0}),Yr.Font=void 0;var Kr=me,$r=function(){function t(){}return t.prototype.measureText=function(t){for(var e=0,r=0,i=0,n=null,o=0;o<t.length;o++){var s=Kr.Util.charCodeAt(t,o);if(s){var a=this.glyphForCharacter(s);!a||a.x<0||a.y<0||a.width<0||a.height<0||(0===o&&(r=-a.offsetX),n=a,e+=a.advanceWidth)}}return n&&(i=e+n.offsetX+n.width-n.advanceWidth),{width:e,actualBoundingBoxLeft:r,actualBoundingBoxRight:i}},t}();Yr.Font=$r;var Jr=t&&t.__extends||function(){var t=function(e,r){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r])},t(e,r)};return function(e,r){if("function"!=typeof r&&null!==r)throw new TypeError("Class extends value "+String(r)+" is not a constructor or null");function i(){this.constructor=e}t(e,r),e.prototype=null===r?Object.create(r):(i.prototype=r.prototype,new i)}}();Object.defineProperty(qr,"__esModule",{value:!0}),qr.BitmapFont=void 0;var Zr=He,Qr=function(t){function e(e){var r=t.call(this)||this;return r.surface=Zr.SurfaceUtil.asSurface(e.src),e.glyphInfo?(r.map=e.glyphInfo.map,r.defaultGlyphWidth=e.glyphInfo.width,r.defaultGlyphHeight=e.glyphInfo.height,r.missingGlyph=e.glyphInfo.missingGlyph,r.size=e.glyphInfo.height):(r.map=e.map||{},r.defaultGlyphWidth=e.defaultGlyphWidth||0,r.defaultGlyphHeight=e.defaultGlyphHeight||0,r.missingGlyph=e.missingGlyph,r.size=e.defaultGlyphHeight||0),r}return Jr(e,t),e.prototype.glyphForCharacter=function(t){var e=this.map[t]||this.missingGlyph;if(!e)return null;var r=void 0===e.width?this.defaultGlyphWidth:e.width,i=void 0===e.height?this.defaultGlyphHeight:e.height,n=e.offsetX||0,o=e.offsetY||0,s=void 0===e.advanceWidth?r:e.advanceWidth,a=0===r||0===i?void 0:this.surface;return{code:t,x:e.x,y:e.y,width:r,height:i,surface:a,offsetX:n,offsetY:o,advanceWidth:s,isSurfaceValid:!0,_atlas:null}},e.prototype.destroy=function(){this.surface&&!this.surface.destroyed()&&this.surface.destroy(),this.map=void 0},e.prototype.destroyed=function(){return!this.map},e}(Yr.Font);qr.BitmapFont=Qr;var ti={};Object.defineProperty(ti,"__esModule",{value:!0});var ei={},ri=t&&t.__extends||function(){var t=function(e,r){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r])},t(e,r)};return function(e,r){if("function"!=typeof r&&null!==r)throw new TypeError("Class extends value "+String(r)+" is not a constructor or null");function i(){this.constructor=e}t(e,r),e.prototype=null===r?Object.create(r):(i.prototype=r.prototype,new i)}}();Object.defineProperty(ei,"__esModule",{value:!0}),ei.Camera2D=void 0;var ii=function(t){function e(e){var r=t.call(this,e)||this;return r.local=!!e.local,r.name=e.name,r._modifiedCount=0,r}return ri(e,t),e.deserialize=function(t){return new e(t.param)},e.prototype.modified=function(){this._modifiedCount=(this._modifiedCount+1)%32768,this._matrix&&(this._matrix._modified=!0)},e.prototype.serialize=function(){return{param:{local:this.local,name:this.name,x:this.x,y:this.y,width:this.width,height:this.height,opacity:this.opacity,scaleX:this.scaleX,scaleY:this.scaleY,angle:this.angle,anchorX:this.anchorX,anchorY:this.anchorY,compositeOperation:this.compositeOperation}}},e.prototype._applyTransformToRenderer=function(t){this.angle||1!==this.scaleX||1!==this.scaleY||0!==this.anchorX||0!==this.anchorY?t.transform(this.getMatrix()._matrix):t.translate(-this.x,-this.y),1!==this.opacity&&t.opacity(this.opacity)},e.prototype._updateMatrix=function(){this._matrix&&(this.angle||1!==this.scaleX||1!==this.scaleY||0!==this.anchorX||0!==this.anchorY?this._matrix.updateByInverse(this.width,this.height,this.scaleX,this.scaleY,this.angle,this.x,this.y,this.anchorX,this.anchorY):this._matrix.reset(-this.x,-this.y))},e}(_e.Object2D);ei.Camera2D=ii;var ni={};Object.defineProperty(ni,"__esModule",{value:!0}),ni.Collision=void 0;var oi,si=me;function ai(t,e){return t.x*e.y-t.y*e.x}function hi(t,e){return{x:t.x-e.x,y:t.y-e.y}}!function(t){t.intersectEntities=function(e,r,i,n){var o=e._findLowestCommonAncestorWith(r);if(!o)return!1;var s=i?{left:i.x,top:i.y,right:i.x+i.width,bottom:i.y+i.height}:{left:0,top:0,right:e.width,bottom:e.height},a=n?{left:n.x,top:n.y,right:n.x+n.width,bottom:n.y+n.height}:{left:0,top:0,right:r.width,bottom:r.height},h=e._calculateMatrixTo(o),u=r._calculateMatrixTo(o),c=h.multiplyPoint({x:s.left,y:s.top}),l=h.multiplyPoint({x:s.right,y:s.top}),d=h.multiplyPoint({x:s.left,y:s.bottom}),p=h.multiplyPoint({x:s.right,y:s.bottom}),f=u.multiplyPoint({x:a.left,y:a.top}),_=u.multiplyPoint({x:a.right,y:a.top}),y=u.multiplyPoint({x:a.left,y:a.bottom}),g=u.multiplyPoint({x:a.right,y:a.bottom}),v=Math.min(c.x,l.x,d.x,p.x),m=Math.max(c.x,l.x,d.x,p.x),T=Math.min(f.x,_.x,y.x,g.x),A=Math.max(f.x,_.x,y.x,g.x);if(m<T||A<v)return!1;var w=Math.min(c.y,l.y,d.y,p.y),S=Math.max(c.y,l.y,d.y,p.y),b=Math.min(f.y,_.y,y.y,g.y),P=Math.max(f.y,_.y,y.y,g.y);if(S<b||P<w)return!1;if(t.intersectLineSegments(c,l,f,_)||t.intersectLineSegments(c,l,_,g)||t.intersectLineSegments(c,l,g,y)||t.intersectLineSegments(c,l,y,f)||t.intersectLineSegments(l,p,f,_)||t.intersectLineSegments(l,p,_,g)||t.intersectLineSegments(l,p,g,y)||t.intersectLineSegments(l,p,y,f)||t.intersectLineSegments(p,d,f,_)||t.intersectLineSegments(p,d,_,g)||t.intersectLineSegments(p,d,g,y)||t.intersectLineSegments(p,d,y,f)||t.intersectLineSegments(d,c,f,_)||t.intersectLineSegments(d,c,_,g)||t.intersectLineSegments(d,c,g,y)||t.intersectLineSegments(d,c,y,f))return!0;var x=ai(hi(c,l),hi(f,l));if(x*ai(hi(d,c),hi(f,c))>=0&&x*ai(hi(p,d),hi(f,d))>=0&&x*ai(hi(l,p),hi(f,p))>=0)return!0;var E=ai(hi(f,_),hi(c,_));return E*ai(hi(y,f),hi(c,f))>=0&&E*ai(hi(g,y),hi(c,y))>=0&&E*ai(hi(_,g),hi(c,g))>=0},t.intersectLineSegments=function(t,e,r,i){var n=hi(e,t),o=hi(i,r);return ai(hi(r,t),n)*ai(hi(i,t),n)<=0&&ai(hi(t,r),o)*ai(hi(e,r),o)<=0},t.intersect=function(t,e,r,i,n,o,s,a){return t<=n+s&&n<=t+r&&e<=o+a&&o<=e+i},t.intersectAreas=function(e,r){return t.intersect(e.x,e.y,e.width,e.height,r.x,r.y,r.width,r.height)},t.within=function(t,e,r,i,n){return void 0===n&&(n=1),n>=si.Util.distance(t,e,r,i)},t.withinAreas=function(t,e,r){return void 0===r&&(r=1),r>=si.Util.distanceBetweenAreas(t,e)}}(oi||(ni.Collision=oi={}));var ui={},ci={},li=t&&t.__extends||function(){var t=function(e,r){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r])},t(e,r)};return function(e,r){if("function"!=typeof r&&null!==r)throw new TypeError("Class extends value "+String(r)+" is not a constructor or null");function i(){this.constructor=e}t(e,r),e.prototype=null===r?Object.create(r):(i.prototype=r.prototype,new i)}}();Object.defineProperty(ci,"__esModule",{value:!0}),ci.CameraCancellingE=void 0;var di=ei,pi=_e,fi=function(t){function e(e){var r=t.call(this,e)||this;return r._canceller=new pi.Object2D,r}return li(e,t),e.prototype.renderSelf=function(t,e){if(!this.children)return!1;if(e&&e instanceof di.Camera2D){var r=e,i=this._canceller;r.x===i.x&&r.y===i.y&&r.angle===i.angle&&r.scaleX===i.scaleX&&r.scaleY===i.scaleY||(i.x=r.x,i.y=r.y,i.angle=r.angle,i.scaleX=r.scaleX,i.scaleY=r.scaleY,i._matrix&&(i._matrix._modified=!0)),t.save(),t.transform(i.getMatrix()._matrix)}for(var n=this.children,o=0;o<n.length;++o)n[o].render(t,e);return e&&t.restore(),!1},e}(Qt.E);ci.CameraCancellingE=fi;var _i={},yi={},gi={},vi={};Object.defineProperty(vi,"__esModule",{value:!0}),vi.Timer=void 0;var mi=P,Ti=function(){function t(t,e){this.interval=t,this._scaledInterval=Math.round(t*e),this.onElapse=new mi.Trigger,this.elapsed=this.onElapse,this._scaledElapsed=0}return t.prototype.tick=function(){for(this._scaledElapsed+=1e3;this._scaledElapsed>=this._scaledInterval&&this.onElapse;)this.onElapse.fire(),this._scaledElapsed-=this._scaledInterval},t.prototype.canDelete=function(){return!this.onElapse||0===this.onElapse.length},t.prototype.destroy=function(){this.interval=void 0,this.onElapse.destroy(),this.onElapse=void 0,this.elapsed=void 0,this._scaledInterval=0,this._scaledElapsed=0},t.prototype.destroyed=function(){return void 0===this.onElapse},t}();vi.Timer=Ti,Object.defineProperty(gi,"__esModule",{value:!0}),gi.TimerManager=gi.TimerIdentifier=void 0;var Ai=Lt,wi=vi,Si=function(){function t(t,e,r,i,n){this._timer=t,this._handler=e,this._handlerOwner=r,this._fired=i,this._firedOwner=n,this._timer.onElapse.add(this._handleElapse,this)}return t.prototype.destroy=function(){this._timer.onElapse.remove(this._handleElapse,this),this._timer=void 0,this._handler=void 0,this._handlerOwner=void 0,this._fired=void 0,this._firedOwner=void 0},t.prototype.destroyed=function(){return void 0===this._timer},t.prototype._handleElapse=function(){this.destroyed()||(this._handler.call(this._handlerOwner),this._fired&&this._fired.call(this._firedOwner,this))},t}();gi.TimerIdentifier=Si;var bi=function(){function t(t,e){this._timers=[],this._trigger=t,this._identifiers=[],this._fps=e,this._registered=!1}return t.prototype.destroy=function(){for(var t=0;t<this._identifiers.length;++t)this._identifiers[t].destroy();for(t=0;t<this._timers.length;++t)this._timers[t].destroy();this._timers=void 0,this._trigger=void 0,this._identifiers=void 0,this._fps=void 0},t.prototype.destroyed=function(){return void 0===this._timers},t.prototype.createTimer=function(t){if(this._registered||(this._trigger.add(this._tick,this),this._registered=!0),t<0)throw Ai.ExceptionFactory.createAssertionError("TimerManager#createTimer: invalid interval");t<1&&(t=1);for(var e=Math.min(1e3,t*this._fps),r=0;r<this._timers.length;++r)if(this._timers[r].interval===t&&this._timers[r]._scaledElapsed<e)return this._timers[r];var i=new wi.Timer(t,this._fps);return this._timers.push(i),i},t.prototype.deleteTimer=function(t){if(t.canDelete()){var e=this._timers.indexOf(t);if(e<0)throw Ai.ExceptionFactory.createAssertionError("TimerManager#deleteTimer: can not find timer");if(this._timers.splice(e,1),t.destroy(),!this._timers.length){if(!this._registered)throw Ai.ExceptionFactory.createAssertionError("TimerManager#deleteTimer: handler is not handled");this._trigger.remove(this._tick,this),this._registered=!1}}},t.prototype.setTimeout=function(t,e,r){var i=this.createTimer(e),n=new Si(i,t,r,this._onTimeoutFired,this);return this._identifiers.push(n),n},t.prototype.clearTimeout=function(t){this._clear(t)},t.prototype.setInterval=function(t,e,r){var i=this.createTimer(e),n=new Si(i,t,r);return this._identifiers.push(n),n},t.prototype.clearInterval=function(t){this._clear(t)},t.prototype._tick=function(){for(var t=this._timers.concat(),e=0;e<t.length;++e)t[e].tick()},t.prototype._onTimeoutFired=function(t){var e=this._identifiers.indexOf(t);if(e<0)throw Ai.ExceptionFactory.createAssertionError("TimerManager#_onTimeoutFired: can not find identifier");this._identifiers.splice(e,1);var r=t._timer;t.destroy(),this.deleteTimer(r)},t.prototype._clear=function(t){var e=this._identifiers.indexOf(t);if(e<0)throw Ai.ExceptionFactory.createAssertionError("TimerManager#_clear: can not find identifier");if(t.destroyed())throw Ai.ExceptionFactory.createAssertionError("TimerManager#_clear: invalid identifier");this._identifiers.splice(e,1);var r=t._timer;t.destroy(),this.deleteTimer(r)},t}();gi.TimerManager=bi,Object.defineProperty(yi,"__esModule",{value:!0}),yi.Scene=void 0;var Pi=P,xi=dr,Ei=ei,Oi=Lt,ki=gi,Mi=function(){function t(t){var e=t.game,r=void 0===t.local||!1===t.local?"non-local":!0===t.local?"full-local":t.local,i=void 0!==t.tickGenerationMode?t.tickGenerationMode:"by-clock";this.name=t.name,this.game=e,this.local=r,this.tickGenerationMode=i,this.onLoad=new Pi.Trigger,this.loaded=this.onLoad,this._onReady=new Pi.Trigger,this._ready=this._onReady,this.assets={},this.asset=e.asset,this.vars={},this._loaded=!1,this._prefetchRequested=!1,this._loadingState="initial",this.onUpdate=new Pi.Trigger,this.update=this.onUpdate,this._timer=new ki.TimerManager(this.onUpdate,this.game.fps),this.onAssetLoad=new Pi.Trigger,this.onAssetLoadFailure=new Pi.Trigger,this.onAssetLoadComplete=new Pi.Trigger,this.assetLoaded=this.onAssetLoad,this.assetLoadFailed=this.onAssetLoadFailure,this.assetLoadCompleted=this.onAssetLoadComplete,this.onMessage=new Pi.Trigger,this.onPointDownCapture=new Pi.Trigger,this.onPointMoveCapture=new Pi.Trigger,this.onPointUpCapture=new Pi.Trigger,this.onOperation=new Pi.Trigger,this.message=this.onMessage,this.pointDownCapture=this.onPointDownCapture,this.pointMoveCapture=this.onPointMoveCapture,this.pointUpCapture=this.onPointUpCapture,this.operation=this.onOperation,this.children=[],this.state="standby",this.onStateChange=new Pi.Trigger,this._assetHolders=[],this._sceneAssetHolder=new xi.AssetHolder({assetManager:this.game._assetManager,assetIds:t.assetIds,assetPaths:t.assetPaths,handlerSet:{owner:this,handleLoad:this._handleSceneAssetLoad,handleLoadFailure:this._handleSceneAssetLoadFailure,handleFinish:this._handleSceneAssetLoadFinish},userData:null}),this.seethrough=null!=t.seethrough&&t.seethrough}return t.prototype.modified=function(t){this.game.modified()},t.prototype.destroy=function(){this.state="before-destroyed",this.onStateChange.fire(this.state);for(var t=0,e=[this.game.db,this.game._localDb];t<e.length;t++)for(var r=e[t],i=0,n=r.keys();i<n.length;i++){var o=n[i],s=r.get(o);(null==s?void 0:s.scene)===this&&s.destroy()}this._timer.destroy(),this.onUpdate.destroy(),this.onMessage.destroy(),this.onPointDownCapture.destroy(),this.onPointMoveCapture.destroy(),this.onPointUpCapture.destroy(),this.onOperation.destroy(),this.onLoad.destroy(),this.onAssetLoad.destroy(),this.onAssetLoadFailure.destroy(),this.onAssetLoadComplete.destroy(),this.assets={},this.vars={};for(var a=0;a<this._assetHolders.length;++a)this._assetHolders[a].destroy();this._sceneAssetHolder.destroy(),this.game=void 0,this._waitingPrepare=void 0,this.state="destroyed",this.onStateChange.fire(this.state),this.onStateChange.destroy()},t.prototype.destroyed=function(){return void 0===this.game},t.prototype.createTimer=function(t){return this._timer.createTimer(t)},t.prototype.deleteTimer=function(t){this._timer.deleteTimer(t)},t.prototype.setInterval=function(t,e,r){return this._timer.setInterval(t,e,r)},t.prototype.clearInterval=function(t){this._timer.clearInterval(t)},t.prototype.setTimeout=function(t,e,r){return this._timer.setTimeout(t,e,r)},t.prototype.clearTimeout=function(t){this._timer.clearTimeout(t)},t.prototype.isCurrentScene=function(){return this.game.scene()===this},t.prototype.gotoScene=function(t,e){if(!this.isCurrentScene())throw Oi.ExceptionFactory.createAssertionError("Scene#gotoScene: this scene is not the current scene");e?this.game.pushScene(t):this.game.replaceScene(t)},t.prototype.end=function(){if(!this.isCurrentScene())throw Oi.ExceptionFactory.createAssertionError("Scene#end: this scene is not the current scene");this.game.popScene()},t.prototype.register=function(t){this.game.register(t),t.scene=this},t.prototype.unregister=function(t){t.scene=void 0,this.game.unregister(t)},t.prototype.append=function(t){this.insertBefore(t,void 0)},t.prototype.insertBefore=function(t,e){t.parent&&t.remove(),t.parent=this;var r=-1;void 0!==e&&(r=this.children.indexOf(e))>-1?this.children.splice(r,0,t):this.children.push(t),this.modified(!0)},t.prototype.remove=function(t){var e=this.children.indexOf(t);-1!==e&&(this.children[e].parent=void 0,this.children.splice(e,1),this.modified(!0))},t.prototype.findPointSourceByPoint=function(t,e,r){for(var i="non-local"!==this.local,n=this.children,o=r&&r instanceof Ei.Camera2D?r.getMatrix():void 0,s=n.length-1;s>=0;--s){var a=n[s].findPointSourceByPoint(t,o,e);if(a)return a.local=a.target&&a.target.local||i,a}return{target:void 0,point:void 0,local:i}},t.prototype.prefetch=function(){this._loaded||this._prefetchRequested||(this._prefetchRequested=!0,this._sceneAssetHolder.request())},t.prototype.requestAssets=function(t,e){var r,i,n=this;if("ready-fired"!==this._loadingState&&"loaded-fired"!==this._loadingState)throw Oi.ExceptionFactory.createAssertionError("Scene#requestAssets(): can be called after loaded.");Array.isArray(t)?(r=t,i=!1):(r=t.assetIds,i=!!t.notifyErrorOnCallback);var o=new xi.AssetHolder({assetManager:this.game._assetManager,assetIds:r,alwaysNotifyFinish:i,handlerSet:{owner:this,handleLoad:this._handleSceneAssetLoad,handleLoadFailure:this._handleSceneAssetLoadFailure,handleFinish:this._handleSceneAssetLoadFinish},userData:function(){if(!n.destroyed()){var t=o._getFailureAssetIds();if(t.length){var r=Oi.ExceptionFactory.createRequestAssetLoadError("Scene#requestAssets(): failed to load the asset. refer to the 'detail' property for more information.",{failureAssetIds:t});e(r)}else e()}}});this._assetHolders.push(o),o.request()},t.prototype._activate=function(){this.state="active",this.onStateChange.fire(this.state)},t.prototype._deactivate=function(){this.state="deactive",this.onStateChange.fire(this.state)},t.prototype._needsLoading=function(){return this._sceneAssetHolder.waitingAssetsCount>0||!!this._waitingPrepare},t.prototype._load=function(){this._loaded||(this._loaded=!0,this._sceneAssetHolder.request()||this._notifySceneReady())},t.prototype._handleSceneAssetLoad=function(t){this.assets[t.id]=t,this.onAssetLoad.fire(t),this.onAssetLoadComplete.fire(t)},t.prototype._handleSceneAssetLoadFailure=function(t){this.onAssetLoadFailure.fire(t),this.onAssetLoadComplete.fire(t.asset)},t.prototype._handleSceneAssetLoadFinish=function(t,e){e?t.userData?this.game._pushPostTickTask(t.userData,null):this._loaded&&this._notifySceneReady():this.game.terminateGame()},t.prototype._notifySceneReady=function(){this._loadingState="ready",this.game._pushPostTickTask(this._fireReady,this)},t.prototype._fireReady=function(){this.destroyed()||(this._onReady.fire(this),this._loadingState="ready-fired")},t.prototype._fireLoaded=function(){this.destroyed()||"loaded-fired"!==this._loadingState&&(this.onLoad.fire(this),this._loadingState="loaded-fired")},t}();yi.Scene=Mi;var Li=t&&t.__extends||function(){var t=function(e,r){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r])},t(e,r)};return function(e,r){if("function"!=typeof r&&null!==r)throw new TypeError("Class extends value "+String(r)+" is not a constructor or null");function i(){this.constructor=e}t(e,r),e.prototype=null===r?Object.create(r):(i.prototype=r.prototype,new i)}}();Object.defineProperty(_i,"__esModule",{value:!0}),_i.LoadingScene=void 0;var Ri=P,Ci=Lt,Ii=function(t){function e(e){var r=this;return e.local=!0,(r=t.call(this,e)||this).onTargetReset=new Ri.Trigger,r.onTargetReady=new Ri.Trigger,r.onTargetAssetLoad=new Ri.Trigger,r.targetReset=r.onTargetReset,r.targetReady=r.onTargetReady,r.targetAssetLoaded=r.onTargetAssetLoad,r._explicitEnd=!!e.explicitEnd,r._targetScene=void 0,r}return Li(e,t),e.prototype.destroy=function(){this._clearTargetScene(),t.prototype.destroy.call(this)},e.prototype.reset=function(t){this._clearTargetScene(),this._targetScene=t,"loaded-fired"!==this._loadingState?this.onLoad.addOnce(this._doReset,this):this._doReset()},e.prototype.getTargetWaitingAssetsCount=function(){return this._targetScene?this._targetScene._sceneAssetHolder.waitingAssetsCount:0},e.prototype.end=function(){if(!this._targetScene||"initial"===this._targetScene._loadingState){var t="LoadingScene#end(): the target scene is in invalid state: "+(this._targetScene?this._targetScene._loadingState:"(no scene)");throw Ci.ExceptionFactory.createAssertionError(t)}this.game._popSceneRaw(!0),this.game._pushPostTickTask(this._targetScene._fireLoaded,this._targetScene),this._clearTargetScene()},e.prototype._clearTargetScene=function(){this._targetScene&&(this.onLoad.removeAll({owner:this,func:this._doReset}),this._targetScene._onReady.removeAll({owner:this}),this._targetScene.onAssetLoad.removeAll({owner:this}),this._targetScene=void 0)},e.prototype._doReset=function(){this.onTargetReset.fire(this._targetScene),"initial"===this._targetScene._loadingState||"ready"===this._targetScene._loadingState?(this._targetScene._onReady.add(this._handleReady,this),this._targetScene.onAssetLoad.add(this._handleAssetLoad,this),this._targetScene._load()):this._handleReady(this._targetScene)},e.prototype._handleAssetLoad=function(t){this.onTargetAssetLoad.fire(t)},e.prototype._handleReady=function(t){this.onTargetReady.fire(t),this._explicitEnd||this.end()},e}(yi.Scene);_i.LoadingScene=Ii;var Fi=t&&t.__extends||function(){var t=function(e,r){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r])},t(e,r)};return function(e,r){if("function"!=typeof r&&null!==r)throw new TypeError("Class extends value "+String(r)+" is not a constructor or null");function i(){this.constructor=e}t(e,r),e.prototype=null===r?Object.create(r):(i.prototype=r.prototype,new i)}}();Object.defineProperty(ui,"__esModule",{value:!0}),ui.DefaultLoadingScene=void 0;var Di=ci,ji=Fe,Gi=function(t){function e(e){var r=t.call(this,{game:e.game,name:"akashic:default-loading-scene"})||this;return"compact"===e.style?(r._barWidth=r.game.width/4,r._barHeight=5,r._style="compact"):(r._barWidth=Math.min(r.game.width,Math.max(100,r.game.width/2)),r._barHeight=5,r._style="default"),r._gauge=void 0,r._gaugeUpdateCount=0,r._totalWaitingAssetCount=0,r.onLoad.add(r._handleLoad,r),r.onTargetReset.add(r._handleTargetReset,r),r.onTargetAssetLoad.add(r._handleTargetAssetLoad,r),r}return Fi(e,t),e.prototype._handleLoad=function(){var t,e,r,i;if("compact"===this._style){var n=.05*Math.min(this.game.width,this.game.height);t=this.game.width-n-this._barWidth,e=this.game.height-n-this._barHeight,r="transparent"}else t=(this.game.width-this._barWidth)/2,e=(this.game.height-this._barHeight)/2,r="rgba(0, 0, 0, 0.8)";return this.append(new Di.CameraCancellingE({scene:this,children:[new ji.FilledRect({scene:this,width:this.game.width,height:this.game.height,cssColor:r,children:[new ji.FilledRect({scene:this,x:t,y:e,width:this._barWidth,height:this._barHeight,cssColor:"gray",children:[i=new ji.FilledRect({scene:this,width:0,height:this._barHeight,cssColor:"white"})]})]})]})),i.onUpdate.add(this._handleUpdate,this),this._gauge=i,!0},e.prototype._handleUpdate=function(){++this._gaugeUpdateCount;var t=Math.round(205+50*Math.sin(this._gaugeUpdateCount/this.game.fps*(2/3)*(2*Math.PI)));this._gauge.cssColor="rgb("+t+","+t+","+t+")",this._gauge.modified()},e.prototype._handleTargetReset=function(t){this._gauge&&(this._gauge.width=0,this._gauge.modified()),this._totalWaitingAssetCount=t._sceneAssetHolder.waitingAssetsCount},e.prototype._handleTargetAssetLoad=function(t){var e=this._targetScene._sceneAssetHolder.waitingAssetsCount;this._gauge.width=Math.ceil((1-e/this._totalWaitingAssetCount)*this._barWidth),this._gauge.modified()},e}(_i.LoadingScene);ui.DefaultLoadingScene=Gi;var Ui={},Bi=t&&t.__extends||function(){var t=function(e,r){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r])},t(e,r)};return function(e,r){if("function"!=typeof r&&null!==r)throw new TypeError("Class extends value "+String(r)+" is not a constructor or null");function i(){this.constructor=e}t(e,r),e.prototype=null===r?Object.create(r):(i.prototype=r.prototype,new i)}}();Object.defineProperty(Ui,"__esModule",{value:!0}),Ui.DefaultSkippingScene=void 0;var Hi=ci,Ni=yi;function Wi(t,e,r,i){var n=.15*i;return 0<t&&t<n?function(t,e,r,i){return(t/=i/2)<1?r/2*t*t+e:-r/2*(--t*(t-2)-1)+e}(t,e,r,n):e+r}var Vi=function(t){function e(e){var r=t.call(this,e)||this;return r.age=0,r.offsetDurationFrame=e.offsetDurationFrame,r.easingDurationFrame=e.easingDurationFrame,r.valueFrom=e.valueFrom,r.valueTo=e.valueTo,r.easing=e.easing,r.onUpdate.add(r._incrementAge,r),r.onUpdate.add(r._updateColor,r),r}return Bi(e,t),e.prototype._incrementAge=function(){this.age++},e.prototype._updateColor=function(){var t=this._calculateCSSColor();this.cssColor!==t&&(this.cssColor=t,this.modified())},e.prototype._calculateCSSColor=function(){var t=this,e=t.age,r=t.offsetDurationFrame,i=t.easingDurationFrame,n=t.valueFrom,o=t.valueTo,s=(0,t.easing)(Math.max(e-r,0)%i,n,o-n,i);return"rgb(".concat(s,", ").concat(s,", ").concat(s,")")},e}(Fe.FilledRect),Xi=function(t){function e(e){var r=t.call(this,{game:e.game,local:"full-local",name:"akashic:default-skipping-scene"})||this;return"indicator"===e.style&&r.onLoad.addOnce(r._handleLoadForIndicator,r),r}return Bi(e,t),e.prototype._handleLoadForIndicator=function(){var t=this,e=this.game,r=.03*Math.min(e.width,e.height)|0,i=.03*Math.min(e.width,e.height)|0,n=.05*Math.min(e.width,e.height)|0,o=.05*Math.min(e.width,e.height)|0,s=400/(1e3/e.fps),a=2500/(1e3/e.fps),h=255,u=Wi;this.append(new Hi.CameraCancellingE({scene:this,children:[3,2,1,0].map((function(c,l){return new Vi({scene:t,cssColor:"rgb(".concat(h,", ").concat(h,", ").concat(h,")"),width:r,height:r,x:e.width-l*(r+i)-n,y:e.height-o,anchorX:1,anchorY:1,offsetDurationFrame:s*c,easingDurationFrame:a,valueFrom:205,valueTo:h,easing:u})}))}))},e}(Ni.Scene);Ui.DefaultSkippingScene=Xi;var zi={};Object.defineProperty(zi,"__esModule",{value:!0});var qi={},Yi={},Ki={},$i={};Object.defineProperty($i,"__esModule",{value:!0}),$i.SurfaceAtlasSlot=void 0;var Ji=function(t,e,r,i){this.x=t,this.y=e,this.width=r,this.height=i,this.prev=null,this.next=null};$i.SurfaceAtlasSlot=Ji,Object.defineProperty(Ki,"__esModule",{value:!0}),Ki.SurfaceAtlas=void 0;var Zi=$i;var Qi=function(){function t(t){this._surface=t,this._emptySurfaceAtlasSlotHead=new Zi.SurfaceAtlasSlot(0,0,this._surface.width,this._surface.height),this._accessScore=0,this._usedRectangleAreaSize={width:0,height:0}}return t.prototype.reset=function(){var t=this._surface.renderer();t.begin(),t.clear(),t.end(),this._emptySurfaceAtlasSlotHead=new Zi.SurfaceAtlasSlot(0,0,this._surface.width,this._surface.height),this._accessScore=0,this._usedRectangleAreaSize.width=0,this._usedRectangleAreaSize.height=0},t.prototype._acquireSurfaceAtlasSlot=function(t,e){t+=1,e+=1;var r=function(t,e,r){for(;t;){if(t.width>=e&&t.height>=r)return t;t=t.next}return null}(this._emptySurfaceAtlasSlotHead,t,e);if(!r)return null;var i,n,o=r.width-t,s=r.height-e;o<=s?(i=new Zi.SurfaceAtlasSlot(r.x+t,r.y,o,e),n=new Zi.SurfaceAtlasSlot(r.x,r.y+e,r.width,s)):(i=new Zi.SurfaceAtlasSlot(r.x,r.y+e,t,s),n=new Zi.SurfaceAtlasSlot(r.x+t,r.y,o,r.height)),i.prev=r.prev,i.next=n,null===i.prev?this._emptySurfaceAtlasSlotHead=i:i.prev.next=i,n.prev=i,n.next=r.next,n.next&&(n.next.prev=n);var a=new Zi.SurfaceAtlasSlot(r.x,r.y,t,e);return this._updateUsedRectangleAreaSize(a),a},t.prototype._updateUsedRectangleAreaSize=function(t){var e=t.x+t.width,r=t.y+t.height;e>this._usedRectangleAreaSize.width&&(this._usedRectangleAreaSize.width=e),r>this._usedRectangleAreaSize.height&&(this._usedRectangleAreaSize.height=r)},t.prototype.addSurface=function(t,e,r,i,n){var o=this._acquireSurfaceAtlasSlot(i,n);if(!o)return null;var s=this._surface.renderer();return s.begin(),s.drawImage(t,e,r,i,n,o.x,o.y),s.end(),o},t.prototype.destroy=function(){this._surface.destroy()},t.prototype.destroyed=function(){return this._surface.destroyed()},t.prototype.getAtlasUsedSize=function(){return this._usedRectangleAreaSize},t.prototype.getAccessScore=function(){return this._accessScore},t}();Ki.SurfaceAtlas=Qi,Object.defineProperty(Yi,"__esModule",{value:!0}),Yi.SurfaceAtlasSet=void 0;var tn=Ki;var en=function(){function t(e){this._surfaceAtlases=[],this._atlasGlyphsTable=[],this._resourceFactory=e.resourceFactory,this._currentAtlasIndex=0;var r=e.hint?e.hint:{};this._maxAtlasNum=r.maxAtlasNum?r.maxAtlasNum:t.INITIAL_MAX_SURFACEATLAS_NUM,r.initialAtlasWidth=r.initialAtlasWidth?r.initialAtlasWidth:512,r.initialAtlasHeight=r.initialAtlasHeight?r.initialAtlasHeight:512,r.maxAtlasWidth=r.maxAtlasWidth?r.maxAtlasWidth:512,r.maxAtlasHeight=r.maxAtlasHeight?r.maxAtlasHeight:512,this._atlasSize=function(t){return{width:Math.ceil(Math.min(t.initialAtlasWidth,t.maxAtlasWidth)),height:Math.ceil(Math.min(t.initialAtlasHeight,t.maxAtlasHeight))}}(r)}return t.prototype._deleteAtlas=function(t){for(var e=0;e<t;++e){var r=this._spliceLeastFrequentlyUsedAtlas();if(!r)return;r.destroy()}},t.prototype._findLeastFrequentlyUsedAtlasIndex=function(){for(var t=Number.MAX_VALUE,e=-1,r=0;r<this._surfaceAtlases.length;++r)this._surfaceAtlases[r]._accessScore<=t&&(t=this._surfaceAtlases[r]._accessScore,e=r);return e},t.prototype._spliceLeastFrequentlyUsedAtlas=function(){var t=this._findLeastFrequentlyUsedAtlasIndex();if(-1===t)return null;this._currentAtlasIndex>=t&&--this._currentAtlasIndex;for(var e=this._surfaceAtlases.splice(t,1)[0],r=this._atlasGlyphsTable.splice(t,1)[0],i=0;i<r.length;i++){var n=r[i];n.surface=void 0,n.isSurfaceValid=!1,n._atlas=null}return e},t.prototype._moveGlyphSurface=function(t){for(var e=0;e<this._surfaceAtlases.length;++e){var r=(this._currentAtlasIndex+e)%this._surfaceAtlases.length,i=this._surfaceAtlases[r],n=i.addSurface(t.surface,t.x,t.y,t.width,t.height);if(n)return this._currentAtlasIndex=r,t.surface&&t.surface.destroy(),t.surface=i._surface,t.x=n.x,t.y=n.y,t._atlas=i,this._atlasGlyphsTable[r].push(t),!0}return!1},t.prototype._reallocateAtlas=function(){var t=null;this._surfaceAtlases.length>=this._maxAtlasNum?(t=this._spliceLeastFrequentlyUsedAtlas()).reset():t=new tn.SurfaceAtlas(this._resourceFactory.createSurface(this._atlasSize.width,this._atlasSize.height)),this._surfaceAtlases.push(t),this._atlasGlyphsTable.push([]),this._currentAtlasIndex=this._surfaceAtlases.length-1},t.prototype.getAtlas=function(t){return this._surfaceAtlases[t]},t.prototype.getAtlasNum=function(){return this._surfaceAtlases.length},t.prototype.getMaxAtlasNum=function(){return this._maxAtlasNum},t.prototype.changeMaxAtlasNum=function(t){if(this._maxAtlasNum=t,this._surfaceAtlases.length>this._maxAtlasNum){var e=this._surfaceAtlases.length-this._maxAtlasNum;this._deleteAtlas(e)}},t.prototype.getAtlasUsedSize=function(){return this._atlasSize},t.prototype.addGlyph=function(t){return!(t.width>this._atlasSize.width||t.height>this._atlasSize.height)&&(!!this._moveGlyphSurface(t)||(this._reallocateAtlas(),this._moveGlyphSurface(t)))},t.prototype.touchGlyph=function(t){t._atlas&&(t._atlas._accessScore+=1);for(var e=0;e<this._surfaceAtlases.length;e++){this._surfaceAtlases[e]._accessScore/=2}},t.prototype.destroy=function(){for(var t=0;t<this._surfaceAtlases.length;++t)this._surfaceAtlases[t].destroy();this._surfaceAtlases=void 0,this._resourceFactory=void 0,this._atlasGlyphsTable=void 0},t.prototype.destroyed=function(){return void 0===this._surfaceAtlases},t.INITIAL_MAX_SURFACEATLAS_NUM=10,t}();Yi.SurfaceAtlasSet=en;var rn=t&&t.__extends||function(){var t=function(e,r){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r])},t(e,r)};return function(e,r){if("function"!=typeof r&&null!==r)throw new TypeError("Class extends value "+String(r)+" is not a constructor or null");function i(){this.constructor=e}t(e,r),e.prototype=null===r?Object.create(r):(i.prototype=r.prototype,new i)}}();Object.defineProperty(qi,"__esModule",{value:!0}),qi.DynamicFont=void 0;var nn=I,on=qr,sn=Yi,an=me,hn=function(t){function e(e){var r=t.call(this)||this;r.fontFamily=e.fontFamily,r.size=e.size,r.hint=null!=e.hint?e.hint:{},r.fontColor=null!=e.fontColor?e.fontColor:"black",r.fontWeight=null!=e.fontWeight?e.fontWeight:nn.FontWeight.Normal,r.strokeWidth=null!=e.strokeWidth?e.strokeWidth:0,r.strokeColor=null!=e.strokeColor?e.strokeColor:"black",r.strokeOnly=null!=e.strokeOnly&&e.strokeOnly;var i=e.game;r._resourceFactory=i.resourceFactory;var n,o=r.fontFamily;if("string"==typeof o)n=o;else if(Array.isArray(o)){for(var s=[],a=0;a<o.length;++a){var h=o[a];s.push("string"==typeof h?h:an.Util.enumToSnakeCase(nn.FontFamily,h))}n=s}else{(s=[]).push("string"==typeof o?o:an.Util.enumToSnakeCase(nn.FontFamily,o)),n=s}var u=r.fontWeight,c="string"==typeof u?u:an.Util.enumToSnakeCase(nn.FontWeight,u);if(r._glyphFactory=r._resourceFactory.createGlyphFactory(n,r.size,r.hint.baselineHeight,r.fontColor,r.strokeWidth,r.strokeColor,r.strokeOnly,c),r._glyphs={},r._destroyed=!1,r._isSurfaceAtlasSetOwner=!1,e.surfaceAtlasSet?r._atlasSet=e.surfaceAtlasSet:e.hint?(r._isSurfaceAtlasSetOwner=!0,r._atlasSet=new sn.SurfaceAtlasSet({resourceFactory:i.resourceFactory,hint:r.hint})):r._atlasSet=i.surfaceAtlasSet,r.hint.presetChars){a=0;for(var l=r.hint.presetChars.length;a<l;a++){var d=an.Util.charCodeAt(r.hint.presetChars,a);d&&r.glyphForCharacter(d)}}return r}return rn(e,t),e.prototype.glyphForCharacter=function(t){var e=this._glyphs[t];if(!e||!e.isSurfaceValid){if((e=this._glyphFactory.create(t)).surface&&!this._atlasSet.addGlyph(e))return null;this._glyphs[t]=e}return this._atlasSet.touchGlyph(e),e},e.prototype.asBitmapFont=function(t){var e=this;if(1!==this._atlasSet.getAtlasNum())return null;var r=null;t&&(r=an.Util.charCodeAt(t,0),this.glyphForCharacter(r));var i={};Object.keys(this._glyphs).forEach((function(t){var r=Number(t),n=e._glyphs[r],o={x:n.x,y:n.y,width:n.width,height:n.height,offsetX:n.offsetX,offsetY:n.offsetY,advanceWidth:n.advanceWidth};i[r]=o}));var n=i[r],o=this._atlasSet.getAtlas(0),s=o.getAtlasUsedSize(),a=this._resourceFactory.createSurface(s.width,s.height),h=a.renderer();return h.begin(),h.drawImage(o._surface,0,0,s.width,s.height,0,0),h.end(),new on.BitmapFont({src:a,map:i,defaultGlyphWidth:0,defaultGlyphHeight:this.size,missingGlyph:n})},e.prototype.destroy=function(){this._isSurfaceAtlasSetOwner&&this._atlasSet.destroy(),this._glyphs=void 0,this._glyphFactory=void 0,this._destroyed=!0},e.prototype.destroyed=function(){return this._destroyed},e}(Yr.Font);qi.DynamicFont=hn;var un={};Object.defineProperty(un,"__esModule",{value:!0});var cn={};Object.defineProperty(cn,"__esModule",{value:!0}),cn.EventConverter=void 0;var ln=Qt,dn=te,pn=Lt,fn=function(){function t(t){var e;this._game=t.game,this._playerId=null!==(e=t.playerId)&&void 0!==e?e:null,this._playerTable={}}return t.prototype.toGameEvent=function(t){var e,r,i,n,o,s,a,h,u,c=t[0],l=t[1],d=t[2],p=this._playerTable[d]||{id:d};switch(c){case 0:return p={id:d,name:t[3]},this._playerTable[d]&&null!=this._playerTable[d].userData&&(p.userData=this._playerTable[d].userData),this._playerTable[d]=p,new dn.JoinEvent(p,l);case 1:return delete this._playerTable[p.id],new dn.LeaveEvent(p,l);case 2:return h=t[3],new dn.TimestampEvent(h,p,l);case 3:return p={id:d,name:t[3],userData:t[4]},this._playerTable[d]=p,new dn.PlayerInfoEvent(p,l);case 32:return a=t[4],new dn.MessageEvent(t[3],p,a,l);case 33:return a=t[8],e=t[3],i=null==(r=t[6])?void 0:r>=0?this._game.db.get(r):this._game._localDb.get(r),n={x:t[4],y:t[5]},u=t[7],new ln.PointDownEvent(e,i,n,p,a,l,u);case 34:return a=t[12],e=t[3],i=null==(r=t[10])?void 0:r>=0?this._game.db.get(r):this._game._localDb.get(r),n={x:t[4],y:t[5]},o={x:t[6],y:t[7]},s={x:t[8],y:t[9]},u=t[11],new ln.PointMoveEvent(e,i,n,s,o,p,a,l,u);case 35:return a=t[12],e=t[3],i=null==(r=t[10])?void 0:r>=0?this._game.db.get(r):this._game._localDb.get(r),n={x:t[4],y:t[5]},o={x:t[6],y:t[7]},s={x:t[8],y:t[9]},u=t[11],new ln.PointUpEvent(e,i,n,s,o,p,a,l,u);case 64:a=t[5];var f=t[3],_=t[4],y=this._game._decodeOperationPluginOperation(f,_);return new dn.OperationEvent(f,y,p,a,l);default:throw pn.ExceptionFactory.createAssertionError("EventConverter#toGameEvent")}},t.prototype.toPlaylogEvent=function(t,e){var r,i,n,o,s,a,h,u,c;switch(t.type){case"join":case"leave":throw pn.ExceptionFactory.createAssertionError("EventConverter#toPlaylogEvent: Invalid type: "+t.type);case"timestamp":var l=t;return c=e?null!==(r=l.player.id)&&void 0!==r?r:null:this._playerId,[2,l.eventFlags,c,l.timestamp];case"player-info":var d=t;return c=e?null!==(i=d.player.id)&&void 0!==i?i:null:this._playerId,[3,d.eventFlags,c,d.player.name,d.player.userData];case"point-down":var p=t;return u=p.target?p.target.id:null,c=e&&p.player?null!==(n=p.player.id)&&void 0!==n?n:null:this._playerId,[33,p.eventFlags,c,p.pointerId,p.point.x,p.point.y,u,p.button,!!p.local];case"point-move":var f=t;return u=f.target?f.target.id:null,c=e&&f.player?null!==(o=f.player.id)&&void 0!==o?o:null:this._playerId,[34,f.eventFlags,c,f.pointerId,f.point.x,f.point.y,f.startDelta.x,f.startDelta.y,f.prevDelta.x,f.prevDelta.y,u,f.button,!!f.local];case"point-up":var _=t;return u=_.target?_.target.id:null,c=e&&_.player?null!==(s=_.player.id)&&void 0!==s?s:null:this._playerId,[35,_.eventFlags,c,_.pointerId,_.point.x,_.point.y,_.startDelta.x,_.startDelta.y,_.prevDelta.x,_.prevDelta.y,u,_.button,!!_.local];case"message":var y=t;return c=e&&y.player?null!==(a=y.player.id)&&void 0!==a?a:null:this._playerId,[32,y.eventFlags,c,y.data,!!y.local];case"operation":var g=t;return c=e&&g.player?null!==(h=g.player.id)&&void 0!==h?h:null:this._playerId,[64,g.eventFlags,c,g.code,g.data,!!g.local];default:throw pn.ExceptionFactory.createAssertionError("Unknown type: "+t.type)}},t.prototype.makePlaylogOperationEvent=function(t){var e=this._playerId;return[64,null!=t.priority?3&t.priority:0,e,t._code,t.data,!!t.local]},t}();cn.EventConverter=fn;var _n={};Object.defineProperty(_n,"__esModule",{value:!0});var yn={};Object.defineProperty(yn,"__esModule",{value:!0});var gn={};Object.defineProperty(gn,"__esModule",{value:!0});var vn={};Object.defineProperty(vn,"__esModule",{value:!0});var mn={};Object.defineProperty(mn,"__esModule",{value:!0});var Tn={};Object.defineProperty(Tn,"__esModule",{value:!0});var An={};Object.defineProperty(An,"__esModule",{value:!0});var wn={},Sn={};Object.defineProperty(Sn,"__esModule",{value:!0}),Sn.RequireCachedValue=void 0;var bn=function(){function t(t){this._value=t}return t.prototype._cachedValue=function(){return this._value},t}();Sn.RequireCachedValue=bn;var Pn={};Object.defineProperty(Pn,"__esModule",{value:!0}),Pn.ScriptAssetContext=void 0;var xn=Lt,En=function(){function t(t,e){this._asset=t,this._module=e,this._started=!1}return t.prototype._cachedValue=function(){if(!this._started)throw xn.ExceptionFactory.createAssertionError("ScriptAssetContext#_cachedValue: not executed yet.");return this._module.exports},t.prototype._executeScript=function(t){return this._started||(t&&(this._module.parent=t,t.children.push(this._module)),this._started=!0,this._asset.execute(this._module._runtimeValue),this._module.loaded=!0),this._module.exports},t}();Pn.ScriptAssetContext=En,Object.defineProperty(wn,"__esModule",{value:!0}),wn.ModuleManager=void 0;var On=Xt,kn=Lt,Mn=Vt,Ln=Sn,Rn=Pn,Cn=function(){function t(t,e){this._assetManager=e,this._runtimeValueBase=t,this._scriptCaches={}}return t.prototype._internalRequire=function(t,e){var r=this._require(t,e);return r.__esModule?r.default:r},t.prototype._require=function(t,e){var r,i,n=this,o=this._assetManager._liveAssetVirtualPathTable,s=this._assetManager._moduleMainScripts;if(-1===t.indexOf("/")&&this._assetManager._assets.hasOwnProperty(t)&&(r=this._assetManager._assets[t],i=this._assetManager._liveAssetPathTable[r.path]),i||(i=this._resolvePath(t,e),/^\//.test(i)&&(i=i.slice(1))),this._scriptCaches.hasOwnProperty(i))return this._scriptCaches[i]._cachedValue();if(r=s[t]?o[i]:this._findAssetByPathAsFile(i,o)){if(this._scriptCaches.hasOwnProperty(i))return this._scriptCaches[i]._cachedValue();if("script"===r.type){var a=new Mn.Module({runtimeValueBase:this._runtimeValueBase,id:r.id,path:r.path,virtualPath:this._assetManager._liveAssetPathTable[r.path],requireFunc:function(t,e){return n._require(t,e)},resolveFunc:function(t,e){return n._resolvePath(t,e)}}),h=new Rn.ScriptAssetContext(r,a);return this._scriptCaches[i]=h,h._executeScript(e)}if("text"===r.type&&r&&".json"===On.PathUtil.resolveExtname(t))return(this._scriptCaches[i]=new Ln.RequireCachedValue(JSON.parse(r.data)))._cachedValue()}throw kn.ExceptionFactory.createAssertionError("g._require: can not find module: "+t)},t.prototype._resolvePath=function(t,e){var r=null,i=this._assetManager._liveAssetVirtualPathTable,n=this._assetManager._moduleMainScripts;if(/^\.\/|^\.\.\/|^\//.test(t)){if(e){if(!e._virtualDirname)throw kn.ExceptionFactory.createAssertionError("g._require.resolve: couldn't resolve the moudle path without virtualPath");r=On.PathUtil.resolvePath(e._virtualDirname,t)}else{if(!/^\.\//.test(t))throw kn.ExceptionFactory.createAssertionError("g._require.resolve: entry point path must start with './'");r=t.substring(2)}if(h=this._resolveAbsolutePathAsFile(r,i))return h;if(h=this._resolveAbsolutePathAsDirectory(r,i))return h}else{if(n[t])return n[t];var o=e?e.paths.concat():[];o.push("node_modules");for(var s=0;s<o.length;++s){var a=o[s],h=On.PathUtil.resolvePath(a,t);if(r=this._resolveAbsolutePathAsFile(h,i))return r;if(r=this._resolveAbsolutePathAsDirectory(h,i))return r}}throw kn.ExceptionFactory.createAssertionError("g._require.resolve: couldn't resolve the path: "+t)},t.prototype._findAssetByPathAsFile=function(t,e){return e.hasOwnProperty(t)?e[t]:e.hasOwnProperty(t+".js")?e[t+".js"]:void 0},t.prototype._resolveAbsolutePathAsFile=function(t,e){return e.hasOwnProperty(t)?"/"+t:e.hasOwnProperty(t+".js")?"/"+t+".js":null},t.prototype._resolveAbsolutePathAsDirectory=function(t,e){var r=t+"/package.json",i=e[r],n=this._assetManager._moduleMainPaths;if(n&&n[r])return n[r];if(e.hasOwnProperty(r)&&"text"===i.type){var o=JSON.parse(i.data);if(o&&"string"==typeof o.main){var s=this._resolveAbsolutePathAsFile(On.PathUtil.resolvePath(t,o.main),e);if(s)return s}}return r=t+"/index.js",e.hasOwnProperty(r)?"/"+r:null},t}();wn.ModuleManager=Cn;var In={};Object.defineProperty(In,"__esModule",{value:!0}),In.NinePatchSurfaceEffector=void 0;var Fn=He,Dn=function(){function t(t,e){void 0===e&&(e=4),this.game=t,this.borderWidth="number"==typeof e?{top:e,bottom:e,left:e,right:e}:e}return t.prototype.render=function(t,e,r){return this._surface&&this._surface.width===e&&this._surface.height===r&&this._beforeSrcSurface===t||(this._surface=this.game.resourceFactory.createSurface(Math.ceil(e),Math.ceil(r)),this._beforeSrcSurface=t),Fn.SurfaceUtil.drawNinePatch(this._surface,t,this.borderWidth),this._surface},t}();In.NinePatchSurfaceEffector=Dn;var jn={};Object.defineProperty(jn,"__esModule",{value:!0});var Gn={},Un=t&&t.__assign||function(){return Un=Object.assign||function(t){for(var e,r=1,i=arguments.length;r<i;r++)for(var n in e=arguments[r])Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t},Un.apply(this,arguments)};Object.defineProperty(Gn,"__esModule",{value:!0}),Gn.OperationPluginManager=void 0;var Bn=P,Hn=function(){function t(t,e,r){this._code=t,this._handler=r,this._handlerOwner=e}return t.prototype.onOperation=function(t){var e;e=Array.isArray(t)?{_code:this._code,data:t}:Un({_code:this._code},t),this._handler.call(this._handlerOwner,e)},t}(),Nn=function(){function t(t,e){this.onOperate=new Bn.Trigger,this.operated=this.onOperate,this.plugins={},this._game=t,this._viewInfo=e}return t.prototype.register=function(t,e,r){return this._instantiateOperationPlugin(t,e,r)},t.prototype.start=function(t){var e=this.plugins[t];e&&e.start()},t.prototype.stop=function(t){var e=this.plugins[t];e&&e.stop()},t.prototype.destroy=function(){this.stopAll(),this.onOperate.destroy(),this.onOperate=void 0,this.operated=void 0,this.plugins=void 0,this._game=void 0,this._viewInfo=void 0},t.prototype.reset=function(){this.stopAll(),this.onOperate.removeAll(),this.plugins={}},t.prototype.stopAll=function(){for(var t in this.plugins)if(this.plugins.hasOwnProperty(t)){var e=this.plugins[t];e&&e.stop()}},t.prototype._instantiateOperationPlugin=function(t,e,r){if(t.isSupported()){if(this.plugins[e])throw new Error("Plugin#code conflicted for code: ".concat(e));var i=new t(this._game,this._viewInfo,r);this.plugins[e]=i;var n=new Hn(e,this.onOperate,this.onOperate.fire);return i.operationTrigger.add(n.onOperation,n),i}},t}();Gn.OperationPluginManager=Nn;var Wn={};Object.defineProperty(Wn,"__esModule",{value:!0});var Vn={};Object.defineProperty(Vn,"__esModule",{value:!0});var Xn={};Object.defineProperty(Xn,"__esModule",{value:!0});var zn={};Object.defineProperty(zn,"__esModule",{value:!0}),zn.PointEventResolver=void 0;var qn=function(){function t(t){var e;this._currentPoints=0,this._pointEventMap={},this._sourceResolver=t.sourceResolver,this._playerId=t.playerId,this._maxPoints=null!==(e=t.maxPoints)&&void 0!==e?e:null}return t.prototype.pointDown=function(t){if(null!=this._maxPoints&&this._currentPoints>=this._maxPoints)return null;var e=this._sourceResolver.findPointSource(t.offset),r=e.point?e.point:t.offset,i=e.target?e.target.id:void 0,n=e.local;this._pointEventMap[t.identifier]={targetId:i,local:n,point:r,start:{x:t.offset.x,y:t.offset.y},prev:{x:t.offset.x,y:t.offset.y}},this._currentPoints++;var o=[33,2,this._playerId,t.identifier,r.x,r.y,i,t.button];return e&&e.local&&o.push(e.local),o},t.prototype.pointMove=function(t){var e=this._pointEventMap[t.identifier];if(!e)return null;var r={x:0,y:0},i={x:0,y:0};this._pointMoveAndUp(e,t.offset,r,i);var n=[34,2,this._playerId,t.identifier,e.point.x,e.point.y,i.x,i.y,r.x,r.y,e.targetId,t.button];return e.local&&n.push(e.local),n},t.prototype.pointUp=function(t){var e=this._pointEventMap[t.identifier];if(!e)return null;var r={x:0,y:0},i={x:0,y:0};this._pointMoveAndUp(e,t.offset,r,i),delete this._pointEventMap[t.identifier],this._currentPoints--;var n=[35,2,this._playerId,t.identifier,e.point.x,e.point.y,i.x,i.y,r.x,r.y,e.targetId,t.button];return e.local&&n.push(e.local),n},t.prototype._pointMoveAndUp=function(t,e,r,i){i.x=e.x-t.start.x,i.y=e.y-t.start.y,r.x=e.x-t.prev.x,r.y=e.y-t.prev.y,t.prev.x=e.x,t.prev.y=e.y},t}();zn.PointEventResolver=qn;var Yn={};Object.defineProperty(Yn,"__esModule",{value:!0}),Yn.RandomGenerator=void 0;var Kn=function(t){this.seed=t};Yn.RandomGenerator=Kn;var $n={};Object.defineProperty($n,"__esModule",{value:!0});var Jn={};Object.defineProperty(Jn,"__esModule",{value:!0});var Zn={};Object.defineProperty(Zn,"__esModule",{value:!0});var Qn={};Object.defineProperty(Qn,"__esModule",{value:!0}),Qn.SpriteFactory=void 0;var to=Be,eo=Lt,ro=function(){function t(){}return t.createSpriteFromE=function(t,e,r){var i=e.x,n=e.y,o=0,s=0,a=e.width,h=e.height,u=e.calculateBoundingRect();if(!u)throw eo.ExceptionFactory.createAssertionError("SpriteFactory.createSpriteFromE: camera must look e");a=u.right-u.left,h=u.bottom-u.top,u.left<e.x&&(o=e.x-u.left),u.top<e.y&&(s=e.y-u.top),e.moveTo(o,s),e._matrix&&(e._matrix._modified=!0);var c=t.game.resourceFactory.createSurface(Math.ceil(a),Math.ceil(h)),l=c.renderer();l.begin(),e.render(l,r),l.end();var d=new to.Sprite({scene:t,src:c,width:a,height:h});return d.moveTo(u.left,u.top),e.moveTo(i,n),e._matrix&&(e._matrix._modified=!0),d},t.createSpriteFromScene=function(t,e,r){var i=t.game.resourceFactory.createSurface(Math.ceil(e.game.width),Math.ceil(e.game.height)),n=i.renderer();n.begin();for(var o=e.children,s=0;s<o.length;++s)o[s].render(n,r);return n.end(),new to.Sprite({scene:t,src:i,width:e.game.width,height:e.game.height})},t}();Qn.SpriteFactory=ro;var io={};Object.defineProperty(io,"__esModule",{value:!0});var no={};Object.defineProperty(no,"__esModule",{value:!0});var oo={};Object.defineProperty(oo,"__esModule",{value:!0});var so={};Object.defineProperty(so,"__esModule",{value:!0});var ao={};Object.defineProperty(ao,"__esModule",{value:!0}),ao.Xorshift=void 0;var ho=function(){function t(t){var e=Array.isArray(t)?t:this.generateSeeds(t);this._state0U=0|e[0],this._state0L=0|e[1],this._state1U=0|e[2],this._state1L=0|e[3]}return t.deserialize=function(e){return new t([e._state0U,e._state0L,e._state1U,e._state1L])},t.prototype.initState=function(t){var e=this.generateSeeds(t);this._state0L=0|e[0],this._state0U=0|e[1],this._state1L=0|e[2],this._state1U=0|e[3]},t.prototype.randomInt=function(){var t=this._state0U,e=this._state0L,r=this._state1U,i=this._state1L,n=(i>>>0)+(e>>>0),o=r+t+(n/2>>>31)>>>0,s=n>>>0;this._state0U=r,this._state0L=i;var a=0,h=0;a=(t^=a=t<<23|(-512&e)>>>9)^r,h=(e^=h=e<<23)^i;a^=t>>>18,h^=e>>>18|(262143&t)<<14;return a^=r>>>5,h^=i>>>5|(31&r)<<27,this._state1U=a,this._state1L=h,[o,s]},t.prototype.random=function(){var t=this.randomInt();return 2.3283064365386963e-10*t[0]+2220446049250313e-31*(t[1]>>>12)},t.prototype.nextInt=function(t,e){return Math.floor(t+this.random()*(e-t))},t.prototype.serialize=function(){return{_state0U:this._state0U,_state0L:this._state0L,_state1U:this._state1U,_state1L:this._state1L}},t.prototype.generateSeeds=function(t){var e=1812433253;return[t=e*(t^t>>30)+1,t=e*(t^t>>30)+2,t=e*(t^t>>30)+3,t=e*(t^t>>30)+4]},t}();ao.Xorshift=ho;var uo={},co=t&&t.__extends||function(){var t=function(e,r){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r])},t(e,r)};return function(e,r){if("function"!=typeof r&&null!==r)throw new TypeError("Class extends value "+String(r)+" is not a constructor or null");function i(){this.constructor=e}t(e,r),e.prototype=null===r?Object.create(r):(i.prototype=r.prototype,new i)}}();Object.defineProperty(uo,"__esModule",{value:!0}),uo.XorshiftRandomGenerator=void 0;var lo=Lt,po=ao,fo=function(t){function e(e,r){var i=this;if(void 0===e)throw lo.ExceptionFactory.createAssertionError("XorshiftRandomGenerator#constructor: seed is undefined");return(i=t.call(this,e)||this)._xorshift=r?po.Xorshift.deserialize(r):new po.Xorshift(e),i}return co(e,t),e.deserialize=function(t){return new e(t._seed,t._xorshift)},e.prototype.get=function(t,e){return this._xorshift.nextInt(t,e+1)},e.prototype.generate=function(){return this._xorshift.random()},e.prototype.serialize=function(){return{_seed:this.seed,_xorshift:this._xorshift.serialize()}},e}(Yn.RandomGenerator);uo.XorshiftRandomGenerator=fo;var _o={};Object.defineProperty(_o,"__esModule",{value:!0}),_o.Game=void 0;var yo=P,go=ur,vo=yr,mo=Ur,To=ui,Ao=Ui,wo=cn,So=Lt,bo=_i,Po=wn,xo=Gn,Eo=zn,Oo=yi,ko=Yi,Mo=Rt,Lo=uo,Ro=function(){function t(t){var e=this._normalizeConfiguration(t.configuration);if(this.fps=e.fps,this.width=e.width,this.height=e.height,this.renderers=[],this.scenes=[],this.age=0,this.assetBase=t.assetBase||"",this.resourceFactory=t.resourceFactory,this.handlerSet=t.handlerSet,this.selfId=t.selfId,this.db=void 0,this.loadingScene=void 0,this.operationPlugins=void 0,this.random=void 0,this.localRandom=void 0,this._defaultLoadingScene=void 0,this._defaultSkippingScene=void 0,this._eventConverter=void 0,this._pointEventResolver=void 0,this._idx=void 0,this._localDb=void 0,this._localIdx=void 0,this._cameraIdx=void 0,this._isTerminated=void 0,this._modified=void 0,this._postTickTasks=void 0,this._toBeDestroyedScenes=[],this.playId=void 0,this.isSkipping=!1,this.joinedPlayerIds=[],this.audio=new mo.AudioSystemManager(this.resourceFactory),this.defaultAudioSystemId="sound",this.assets={},this.surfaceAtlasSet=new ko.SurfaceAtlasSet({resourceFactory:this.resourceFactory}),this.onJoin=new yo.Trigger,this.onLeave=new yo.Trigger,this.onPlayerInfo=new yo.Trigger,this.onSeed=new yo.Trigger,this.join=this.onJoin,this.leave=this.onLeave,this.playerInfo=this.onPlayerInfo,this.seed=this.onSeed,this._eventTriggerMap={unknown:void 0,timestamp:void 0,join:this.onJoin,leave:this.onLeave,"player-info":this.onPlayerInfo,seed:this.onSeed,message:void 0,"point-down":void 0,"point-move":void 0,"point-up":void 0,operation:void 0},this.onResized=new yo.Trigger,this.onSkipChange=new yo.Trigger,this.resized=this.onResized,this.skippingChanged=this.onSkipChange,this.isLastTickLocal=!0,this.lastOmittedLocalTickCount=0,this.lastLocalTickMode=null,this.lastTickGenerationMode=null,this._onLoad=new yo.Trigger,this._onStart=new yo.Trigger,this._loaded=this._onLoad,this._started=this._onStart,this.isLoaded=!1,this.onSnapshotRequest=new yo.Trigger,this.snapshotRequest=this.onSnapshotRequest,this.external={},this._runtimeValueBase=Object.create(t.engineModule,{game:{value:this,enumerable:!0}}),this._main=e.main,this._mainFunc=t.mainFunc,this._mainParameter=void 0,this._configuration=e,Array.isArray(e.assets))throw new Error("Game#constructor: array type of configuration.assets is not yet supported");this._assetManager=new vo.AssetManager(this,e.assets,e.audio,e.moduleMainScripts,e.moduleMainPaths),this._moduleManager=void 0,this.asset=new go.AssetAccessor(this._assetManager),this.operationPluginManager=new xo.OperationPluginManager(this,t.operationPluginViewInfo||null),this._onOperationPluginOperated=new yo.Trigger,this._operationPluginOperated=this._onOperationPluginOperated,this._onOperationPluginOperated.add(this._handleOperationPluginOperated,this),this.onSceneChange=new yo.Trigger,this._onSceneChange=new yo.Trigger,this._onSceneChange.add(this._handleSceneChanged,this),this._sceneChanged=this._onSceneChange,this.onUpdate=new yo.Trigger,this._initialScene=new Oo.Scene({game:this,assetIds:this._assetManager.globalAssetIds(),local:!0,name:"akashic:initial-scene"}),this._initialScene.onLoad.add(this._handleInitialSceneLoad,this),this._reset({age:0})}return Object.defineProperty(t.prototype,"focusingCamera",{get:function(){return this._focusingCamera},set:function(t){t!==this._focusingCamera&&(this._modified&&this.render(),this._focusingCamera=t)},enumerable:!1,configurable:!0}),Object.defineProperty(t.prototype,"skippingScene",{get:function(){return this._skippingScene},set:function(t){if(t!==this._skippingScene){if(t){if("full-local"!==t.local)throw So.ExceptionFactory.createAssertionError("Game#skippingScene: only 'full-local' scene is supported.");if(t._needsLoading())throw So.ExceptionFactory.createAssertionError("Game#skippingScene: must not depend on any assets.")}this._skippingScene=t}},enumerable:!1,configurable:!0}),t.prototype.pushScene=function(t,e){this._postTickTasks.push({type:0,scene:t,prepare:null==e?void 0:e.prepare})},t.prototype.replaceScene=function(t,e){var r,i;"object"===n(e)?(r=!!e.preserveCurrent,i=e.prepare):r=!!e,this._postTickTasks.push({type:1,scene:t,preserveCurrent:r,prepare:i})},t.prototype.popScene=function(t,e){void 0===e&&(e=1);for(var r=0;r<e;r++)this._postTickTasks.push({type:2,preserveCurrent:!!t})},t.prototype.scene=function(){if(this.scenes.length)return this.scenes[this.scenes.length-1]},t.prototype.tick=function(t,e,r){var i=null;if(this._isTerminated)return!1;if(this.isLastTickLocal=!t,this.lastOmittedLocalTickCount=e||0,this.scenes.length){if(i=this.scenes[this.scenes.length-1],r&&r.length)for(var n=0;n<r.length;++n){var o=this._eventConverter.toGameEvent(r[n]),s=this._eventTriggerMap[o.type];s&&s.fire(o)}i.onUpdate.fire(),t&&++this.age}return this.onUpdate.fire(),!!this._postTickTasks.length&&(this._flushPostTickTasks(),i!==this.scenes[this.scenes.length-1])},t.prototype.render=function(){var t,e,r=null!==(t=this._skippingScene)&&void 0!==t?t:this._defaultSkippingScene;if(r&&this.isSkipping?(e=r).onUpdate.fire():e=this.scene(),this._modified&&e){for(var i=this.focusingCamera,n=this.renderers,o=this.scenes.length-1;o>=0&&this.scenes[o].seethrough;)--o;for(var s=o,a=0;a<n.length;++a){var h=n[a];if(h.begin(),h.save(),h.clear(),i&&(h.save(),i._applyTransformToRenderer(h)),e===r)for(var u=0;u<e.children.length;++u)e.children[u].render(h,i);else for(var c=s;c<this.scenes.length;++c){var l=this.scenes[c].children;for(u=0;u<l.length;++u)l[u].render(h,i)}i&&h.restore(),h.restore(),h.end()}this._modified=!1}},t.prototype.resolvePointEvent=function(t){switch(t.type){case 0:return this._pointEventResolver.pointDown(t);case 1:return this._pointEventResolver.pointMove(t);case 2:return this._pointEventResolver.pointUp(t)}},t.prototype.findPointSource=function(t,e){e||(e=this.focusingCamera);var r=this.scene();if(r)return r.findPointSourceByPoint(t,!1,e)},t.prototype.register=function(t){if(t.local){if(void 0===t.id)t.id=--this._localIdx;else{if(t.id>0)throw So.ExceptionFactory.createAssertionError("Game#register: invalid local id: "+t.id);if(this._localDb.has(t.id))throw So.ExceptionFactory.createAssertionError("Game#register: conflicted id: "+t.id);this._localIdx>t.id&&(this._localIdx=t.id)}this._localDb.set(t.id,t)}else{if(void 0===t.id)t.id=++this._idx;else{if(t.id<0)throw So.ExceptionFactory.createAssertionError("Game#register: invalid non-local id: "+t.id);if(this.db.has(t.id))throw So.ExceptionFactory.createAssertionError("Game#register: conflicted id: "+t.id);this._idx<t.id&&(this._idx=t.id)}this.db.set(t.id,t)}},t.prototype.unregister=function(t){t.local?this._localDb.delete(t.id):this.db.delete(t.id)},t.prototype.terminateGame=function(){this._isTerminated=!0,this._terminateGame()},t.prototype.modified=function(){this._modified=!0},t.prototype.raiseEvent=function(t){this.handlerSet.raiseEvent(this._eventConverter.toPlaylogEvent(t))},t.prototype.raiseTick=function(t){if(null!=t&&t.length){for(var e=[],r=0;r<t.length;r++)e.push(this._eventConverter.toPlaylogEvent(t[r]));this.handlerSet.raiseTick(e)}else this.handlerSet.raiseTick()},t.prototype.addEventFilter=function(t,e){this.handlerSet.addEventFilter(t,e)},t.prototype.removeEventFilter=function(t){this.handlerSet.removeEventFilter(t)},t.prototype.shouldSaveSnapshot=function(){return this.handlerSet.shouldSaveSnapshot()},t.prototype.saveSnapshot=function(t,e){this.handlerSet.saveSnapshot(this.age,t,this.random.serialize(),this._idx,e)},t.prototype.requestSaveSnapshot=function(t,e){var r=this;this._postTickTasks.unshift({type:3,fun:function(){if(r.handlerSet.shouldSaveSnapshot()){var i=t.call(e);i&&r.handlerSet.saveSnapshot(r.age,i.snapshot,r.random.serialize(),r._idx,i.timestamp)}},owner:null})},t.prototype.getCurrentTime=function(){return this.handlerSet.getCurrentTime()},t.prototype.isActiveInstance=function(){return"active"===this.handlerSet.getInstanceType()},t.prototype._pushPostTickTask=function(t,e){this._postTickTasks.push({type:3,fun:t,owner:e})},t.prototype._popSceneRaw=function(t){this._postTickTasks.push({type:4,preserveCurrent:t})},t.prototype._normalizeConfiguration=function(t){if(!t)throw So.ExceptionFactory.createAssertionError("Game#_normalizeConfiguration: invalid arguments");if(null==t.assets&&(t.assets={}),null==t.fps&&(t.fps=30),"number"!=typeof t.fps)throw So.ExceptionFactory.createAssertionError("Game#_normalizeConfiguration: fps must be given as a number");if(!(0<=t.fps&&t.fps<=60))throw So.ExceptionFactory.createAssertionError("Game#_normalizeConfiguration: fps must be a number in (0, 60].");if("number"!=typeof t.width)throw So.ExceptionFactory.createAssertionError("Game#_normalizeConfiguration: width must be given as a number");if("number"!=typeof t.height)throw So.ExceptionFactory.createAssertionError("Game#_normalizeConfiguration: height must be given as a number");return t},t.prototype._setAudioPlaybackRate=function(t){this.audio._setPlaybackRate(t)},t.prototype._startSuppressAudio=function(){this.audio._startSuppress()},t.prototype._endSuppressAudio=function(){this.audio._endSuppress()},t.prototype._setMuted=function(t){this.audio._setMuted(t)},t.prototype._decodeOperationPluginOperation=function(t,e){var r=this.operationPluginManager.plugins[t];return r&&r.decode?r.decode(e):e},t.prototype._reset=function(t){var e;if(this.operationPluginManager.reset(),this.operationPluginManager.onOperate.add(this._onOperationPluginOperated.fire,this._onOperationPluginOperated),this.scene()){for(;this.scene()!==this._initialScene;)this._popSceneRaw(!1),this._flushPostTickTasks();this.isLoaded||this.scenes.pop()}switch(this._skippingScene&&!this._skippingScene.destroyed()&&this._skippingScene.destroy(),t&&(void 0!==t.age&&(this.age=t.age),void 0!==t.randGenSer?this.random=Lo.XorshiftRandomGenerator.deserialize(t.randGenSer):void 0!==t.randSeed&&(this.random=new Lo.XorshiftRandomGenerator(t.randSeed))),this.audio._reset(),this._onLoad.removeAll({func:this._handleLoad,owner:this}),this.onJoin.removeAll(),this.onLeave.removeAll(),this.onSeed.removeAll(),this.onResized.removeAll(),this.onSkipChange.removeAll(),this.onSceneChange.removeAll(),this.onUpdate.removeAll(),this.handlerSet.removeAllEventFilters(),this.isSkipping=!1,this.onSkipChange.add(this._handleSkipChange,this),this.joinedPlayerIds=[],this.onJoin.add(this._handleJoinEvent,this),this.onLeave.add(this._handleLeaveEvent,this),this._idx=null!==(e=null==t?void 0:t.nextEntityId)&&void 0!==e?e:0,this._localIdx=0,this._cameraIdx=0,this.db=new Mo.WeakRefKVS,this._localDb=new Mo.WeakRefKVS,this._modified=!0,this.loadingScene=void 0,this._skippingScene=void 0,this._focusingCamera=void 0,this.lastLocalTickMode=null,this.lastTickGenerationMode=null,this.onSnapshotRequest.removeAll(),this._postTickTasks=[],this._toBeDestroyedScenes=[],this._eventConverter=new wo.EventConverter({game:this,playerId:this.selfId}),this._pointEventResolver=new Eo.PointEventResolver({sourceResolver:this,playerId:this.selfId,maxPoints:this._configuration.maxPoints}),this.localRandom=new Lo.XorshiftRandomGenerator(Math.floor(9007199254740991*Math.random())),this._isTerminated=!1,this.vars={},this._moduleManager=new Po.ModuleManager(this._runtimeValueBase,this._assetManager),this.surfaceAtlasSet.destroy(),this.surfaceAtlasSet=new ko.SurfaceAtlasSet({resourceFactory:this.resourceFactory}),this._configuration.defaultLoadingScene){case"none":this._defaultLoadingScene=new bo.LoadingScene({game:this});break;case"compact":this._defaultLoadingScene=new To.DefaultLoadingScene({game:this,style:"compact"});break;default:this._defaultLoadingScene=new To.DefaultLoadingScene({game:this})}switch(this._configuration.defaultSkippingScene){case"none":this._defaultSkippingScene=new Ao.DefaultSkippingScene({game:this,style:"none"});break;case"indicator":this._defaultSkippingScene=new Ao.DefaultSkippingScene({game:this,style:"indicator"});break;default:this._defaultSkippingScene=void 0}},t.prototype._destroy=function(){if(this.operationPluginManager.destroy(),this.scene())for(;this.scene()!==this._initialScene;)this.popScene(),this._flushPostTickTasks();this._initialScene.destroy(),this.loadingScene&&!this.loadingScene.destroyed()&&this.loadingScene.destroy(),this._defaultLoadingScene.destroyed()||this._defaultLoadingScene.destroy(),this._defaultSkippingScene&&!this._defaultSkippingScene.destroyed()&&this._defaultSkippingScene.destroy(),this._skippingScene&&!this._skippingScene.destroyed()&&this._skippingScene.destroy(),this.db=void 0,this.renderers=void 0,this.scenes=void 0,this.random=void 0,this._modified=!1,this.age=0,this.assets=void 0,this.isLoaded=!1,this.loadingScene=void 0,this.assetBase="",this.selfId=void 0,this.audio.music.stopAll(),this.audio.sound.stopAll(),this.audio=void 0,this.defaultAudioSystemId=void 0,this.handlerSet=void 0,this.localRandom=void 0,this.onJoin.destroy(),this.onJoin=void 0,this.onLeave.destroy(),this.onLeave=void 0,this.onSeed.destroy(),this.onSeed=void 0,this.onPlayerInfo.destroy(),this.onPlayerInfo=void 0,this.onResized.destroy(),this.onResized=void 0,this.onSkipChange.destroy(),this.onSkipChange=void 0,this.onSceneChange.destroy(),this.onSceneChange=void 0,this.onUpdate.destroy(),this.onUpdate=void 0,this.onSnapshotRequest.destroy(),this.onSnapshotRequest=void 0,this.join=void 0,this.leave=void 0,this.seed=void 0,this.playerInfo=void 0,this.snapshotRequest=void 0,this.resized=void 0,this.skippingChanged=void 0,this._sceneChanged=void 0,this._loaded=void 0,this._started=void 0,this._operationPluginOperated=void 0,this._onSceneChange.destroy(),this._onSceneChange=void 0,this._onLoad.destroy(),this._onLoad=void 0,this._onStart.destroy(),this._onStart=void 0,this.resourceFactory=void 0,this.playId=void 0,this.operationPlugins=void 0,this._eventTriggerMap=void 0,this._initialScene=void 0,this._defaultLoadingScene=void 0,this._main=void 0,this._mainFunc=void 0,this._mainParameter=void 0,this._assetManager.destroy(),this._assetManager=void 0,this.asset=void 0,this._eventConverter=void 0,this._pointEventResolver=void 0,this.operationPluginManager=void 0,this._onOperationPluginOperated.destroy(),this._onOperationPluginOperated=void 0,this._idx=0,this._localDb=void 0,this._localIdx=0,this._cameraIdx=0,this._isTerminated=!0,this._focusingCamera=void 0,this._skippingScene=void 0,this._configuration=void 0,this._postTickTasks=void 0,this.surfaceAtlasSet.destroy(),this.surfaceAtlasSet=void 0,this._moduleManager=void 0},t.prototype._loadAndStart=function(t){this._mainParameter=t||{},this.isLoaded?this._handleLoad():(this._onLoad.add(this._handleLoad,this),this.pushScene(this._initialScene),this._flushPostTickTasks())},t.prototype._startLoadingGlobalAssets=function(){if(this.isLoaded)throw So.ExceptionFactory.createAssertionError("Game#_startLoadingGlobalAssets: already loaded.");this.pushScene(this._initialScene),this._flushPostTickTasks()},t.prototype._updateEventTriggers=function(t){if(this._modified=!0,!t)return this._eventTriggerMap.message=void 0,this._eventTriggerMap["point-down"]=void 0,this._eventTriggerMap["point-move"]=void 0,this._eventTriggerMap["point-up"]=void 0,void(this._eventTriggerMap.operation=void 0);this._eventTriggerMap.message=t.onMessage,this._eventTriggerMap["point-down"]=t.onPointDownCapture,this._eventTriggerMap["point-move"]=t.onPointMoveCapture,this._eventTriggerMap["point-up"]=t.onPointUpCapture,this._eventTriggerMap.operation=t.onOperation,t._activate()},t.prototype._handleInitialSceneLoad=function(){this._initialScene.onLoad.remove(this._handleInitialSceneLoad,this),this.assets=this._initialScene.assets,this.isLoaded=!0,this._onLoad.fire(this)},t.prototype._handleOperationPluginOperated=function(t){var e=this._eventConverter.makePlaylogOperationEvent(t);this.handlerSet.raiseEvent(e)},t.prototype._handleSceneChanged=function(t){this._updateEventTriggers(t);var e=t?t.local:"full-local",r=t?t.tickGenerationMode:"by-clock";this.lastLocalTickMode===e&&this.lastTickGenerationMode===r||(this.lastLocalTickMode=e,this.lastTickGenerationMode=r,this.handlerSet.changeSceneMode({local:e,tickGenerationMode:r}))},t.prototype._handleSkippingSceneReady=function(t){this._pushPostTickTask(t._fireLoaded,t)},t.prototype._terminateGame=function(){},t.prototype._flushPostTickTasks=function(){do{var t=this._postTickTasks;this._postTickTasks=[];for(var e=0;e<t.length;++e){var r=t[e];switch(r.type){case 0:var i=this.scene();i&&i._deactivate(),this._doPushScene(r.scene,!1,r.prepare?this._createPreparingLoadingScene(r.scene,r.prepare,"akashic:preparing-".concat(r.scene.name)):void 0);break;case 1:this._doPopScene(r.preserveCurrent,!1,!1),this._doPushScene(r.scene,!1,r.prepare?this._createPreparingLoadingScene(r.scene,r.prepare,"akashic:preparing-".concat(r.scene.name)):void 0);break;case 2:this._doPopScene(r.preserveCurrent,!1,!0);break;case 3:r.fun.call(r.owner);break;case 4:this._doPopScene(r.preserveCurrent,!0,!0);break;default:throw So.ExceptionFactory.createAssertionError("Game#_flushPostTickTasks: unknown post-tick task type.")}}}while(this._postTickTasks.length>0);if(this._toBeDestroyedScenes.length>0){for(var n=0,o=this._toBeDestroyedScenes;n<o.length;n++){o[n].destroy()}this._toBeDestroyedScenes=[]}},t.prototype._handleSkipChange=function(t){var e;if(this.isSkipping=t,t){var r=null!==(e=this._skippingScene)&&void 0!==e?e:this._defaultSkippingScene;r&&!r._loaded&&(r._load(),r._onReady.addOnce(this._handleSkippingSceneReady,this))}this._cleanDB(),this._modified=!0},t.prototype._handleJoinEvent=function(t){t.player.id&&-1===this.joinedPlayerIds.indexOf(t.player.id)&&this.joinedPlayerIds.push(t.player.id)},t.prototype._handleLeaveEvent=function(t){this.joinedPlayerIds=this.joinedPlayerIds.filter((function(e){return e!==t.player.id}))},t.prototype._doPopScene=function(t,e,r){var i,n=this.scenes.pop();if(!e)for(;n&&n instanceof bo.LoadingScene;)n._clearTargetScene(),n=this.scenes.pop();if(!n)throw So.ExceptionFactory.createAssertionError("Game#_doPopScene: invalid call; scene stack underflow");if(n===this._initialScene)throw So.ExceptionFactory.createAssertionError("Game#_doPopScene: invalid call; attempting to pop the initial scene");if((t||this._toBeDestroyedScenes.includes(n)||this._toBeDestroyedScenes.push(n),!e)&&((s=this.scene())&&s._needsLoading()&&"loaded-fired"!==s._loadingState)){var o=s._waitingPrepare?this._createPreparingLoadingScene(s,s._waitingPrepare,"akashic:preparing-".concat(s.name)):null!==(i=this.loadingScene)&&void 0!==i?i:this._defaultLoadingScene;this._doPushScene(o,!0,this._defaultLoadingScene),o.reset(s)}if(r){var s=this.scene();this.onSceneChange.fire(s),this._onSceneChange.fire(s)}},t.prototype._handleLoad=function(){for(var t=0,e=this._configuration.operationPlugins||[];t<e.length;t++){var r=e[t];if(r.script){var i=this._moduleManager._internalRequire(r.script),n=this.operationPluginManager.register(i,r.code,r.option);!r.manualStart&&n&&n.start()}}this.operationPlugins=this.operationPluginManager.plugins;for(var o=0,s=this._assetManager.preloadScriptAssetIds();o<s.length;o++){var a=s[o],h=this._moduleManager._internalRequire(a);if(!h||"function"!=typeof h)throw So.ExceptionFactory.createAssertionError("Game#_handleLoad: ".concat(a," has no-exported function."));h()}if(this._mainFunc)this._mainFunc(this._runtimeValueBase,this._mainParameter||{});else{if(!this._main)throw So.ExceptionFactory.createAssertionError("Game#_handleLoad: does not have an entry point");var u=this._moduleManager._internalRequire(this._main);if(!u||"function"!=typeof u)throw So.ExceptionFactory.createAssertionError("Game#_handleLoad: Entry point ".concat(this._main," not found."));u(this._mainParameter)}this._flushPostTickTasks(),this._onStart.fire()},t.prototype._doPushScene=function(t,e,r){var i=this.scenes;if(!e)for(;i.length>0&&i[i.length-1]instanceof bo.LoadingScene;){i.pop()._clearTargetScene()}if(r||(r=this.loadingScene||this._defaultLoadingScene),i.push(t),t._needsLoading()&&"loaded-fired"!==t._loadingState){if(this._defaultLoadingScene._needsLoading())throw So.ExceptionFactory.createAssertionError("Game#_doPushScene: _defaultLoadingScene must not depend on any assets.");this._doPushScene(r,!0,this._defaultLoadingScene),r.reset(t)}else this.onSceneChange.fire(t),this._onSceneChange.fire(t),t._loaded||(t._load(),this._pushPostTickTask(t._fireLoaded,t));this._modified=!0},t.prototype._createPreparingLoadingScene=function(t,e,r){var i=this;t._waitingPrepare=e;var n=new bo.LoadingScene({game:this,explicitEnd:!0,name:r});return n.onTargetReady.addOnce((function(){var e=t._waitingPrepare;t._waitingPrepare=void 0,e?e((function(){i._isTerminated||n.end()})):i._pushPostTickTask(n.end,n)})),n},t.prototype._cleanDB=function(){this.db.clean(),this._localDb.clean()},t}();_o.Game=Ro,function(e){var r=t&&t.__createBinding||(Object.create?function(t,e,r,i){void 0===i&&(i=r);var n=Object.getOwnPropertyDescriptor(e,r);n&&!("get"in n?!e.__esModule:n.writable||n.configurable)||(n={enumerable:!0,get:function(){return e[r]}}),Object.defineProperty(t,i,n)}:function(t,e,r,i){void 0===i&&(i=r),t[i]=e[r]}),i=t&&t.__exportStar||function(t,e){for(var i in t)"default"===i||Object.prototype.hasOwnProperty.call(e,i)||r(e,t,i)};Object.defineProperty(e,"__esModule",{value:!0}),e.PathUtil=e.VideoSystem=e.ShaderProgram=e.Module=e.AudioSystem=void 0,i(A,e),i(P,e),i(I,e);var n=xt;Object.defineProperty(e,"AudioSystem",{enumerable:!0,get:function(){return n.AudioSystem}});var o=Vt;Object.defineProperty(e,"Module",{enumerable:!0,get:function(){return o.Module}});var s=Yt;Object.defineProperty(e,"ShaderProgram",{enumerable:!0,get:function(){return s.ShaderProgram}});var a=$t;Object.defineProperty(e,"VideoSystem",{enumerable:!0,get:function(){return a.VideoSystem}});var h=Xt;Object.defineProperty(e,"PathUtil",{enumerable:!0,get:function(){return h.PathUtil}}),i(Zt,e),i(Qt,e),i(Fe,e),i(Ue,e),i(Ze,e),i(or,e),i(Be,e),i(ur,e),i(lr,e),i(dr,e),i(_r,e),i(yr,e),i(Gr,e),i(Et,e),i(xt,e),i(Ur,e),i(Wr,e),i(qr,e),i(ti,e),i(ei,e),i(ni,e),i(ui,e),i(Ui,e),i(zi,e),i(qi,e),i(un,e),i(te,e),i(cn,e),i(_n,e),i(yn,e),i(gn,e),i(vn,e),i(Lt,e),i(Yr,e),i(mn,e),i(Tn,e),i(_i,e),i(An,e),i(pe,e),i(Vt,e),i(wn,e),i(In,e),i(_e,e),i(jn,e),i(Gn,e),i(Wn,e),i(Vn,e),i(Xn,e),i(zn,e),i(Yn,e),i($n,e),i(Jn,e),i(Sn,e),i(Pn,e),i(Yt,e),i(Zn,e),i(Qn,e),i(Ki,e),i(Yi,e),i($i,e),i(io,e),i(He,e),i(Qe,e),i(no,e),i(oo,e),i(so,e),i(vi,e),i(gi,e),i(me,e),i($t,e),i(Rt,e),i(ao,e),i(uo,e),i(yi,e),i(_o,e)}(T);var Co={};Object.defineProperty(Co,"__esModule",{value:!0}),function(e){var r=t&&t.__createBinding||(Object.create?function(t,e,r,i){void 0===i&&(i=r);var n=Object.getOwnPropertyDescriptor(e,r);n&&!("get"in n?!e.__esModule:n.writable||n.configurable)||(n={enumerable:!0,get:function(){return e[r]}}),Object.defineProperty(t,i,n)}:function(t,e,r,i){void 0===i&&(i=r),t[i]=e[r]}),i=t&&t.__exportStar||function(t,e){for(var i in t)"default"===i||Object.prototype.hasOwnProperty.call(e,i)||r(e,t,i)};Object.defineProperty(e,"__esModule",{value:!0}),i(T,e),i(Co,e)}(m);var Io=m;Object.defineProperty(v,"__esModule",{value:!0}),v.SimpleProfiler=void 0;var Fo=Io,Do=function(){function t(e){var r;this._startTime=0,this._beforeFlushTime=0,this._beforeTimes=[],this._values=[],this._calculateProfilerValueTrigger=new Fo.Trigger,this._interval=null!==(r=e.interval)&&void 0!==r?r:t.DEFAULT_INTERVAL,null!=e.limit?this._limit=e.limit>=t.DEFAULT_LIMIT?e.limit:t.DEFAULT_LIMIT:this._limit=t.DEFAULT_LIMIT,e.getValueHandler&&this._calculateProfilerValueTrigger.add(e.getValueHandler,e.getValueHandlerOwner),this._reset()}return t.prototype.time=function(t){this._beforeTimes[t]=this._getCurrentTime()},t.prototype.timeEnd=function(t){var e=this._getCurrentTime(),r=null!=this._beforeTimes[t]?e-this._beforeTimes[t]:0;this._values[t].push({time:e,value:r})},t.prototype.flush=function(){var e=this._getCurrentTime();if(0===this._beforeFlushTime&&(this._beforeFlushTime=e),this._beforeFlushTime+this._interval<e&&(this._calculateProfilerValueTrigger.fire(this.getProfilerValue(this._interval)),this._beforeFlushTime=e),this._values[1].length>this._limit)for(var r in this._values)this._values.hasOwnProperty(r)&&(this._values[r]=this._values[r].slice(-t.BACKUP_MARGIN))},t.prototype.setValue=function(t,e){this._values[t].push({time:this._getCurrentTime(),value:e})},t.prototype.getProfilerValue=function(t){var e=this._calculateProfilerValue(1,t);return{skippedFrameCount:this._calculateProfilerValue(0,t),rawFrameInterval:e,framePerSecond:{ave:1e3/e.ave,max:1e3/e.min,min:1e3/e.max},frameTime:this._calculateProfilerValue(2,t),renderingTime:this._calculateProfilerValue(3,t)}},t.prototype._reset=function(){this._startTime=this._getCurrentTime(),this._beforeFlushTime=0,this._beforeTimes=[],this._beforeTimes[1]=0,this._beforeTimes[2]=0,this._beforeTimes[3]=0,this._beforeTimes[0]=0,this._values=[],this._values[1]=[],this._values[2]=[],this._values[3]=[],this._values[0]=[]},t.prototype._calculateProfilerValue=function(t,e){for(var r=this._getCurrentTime()-e,i=0,n=0,o=0,s=Number.MAX_VALUE,a=this._values[t].length-1;a>=0&&!(0<n&&this._values[t][a].time<r);--a){var h=this._values[t][a].value;o<h&&(o=h),h<s&&(s=h),i+=h,++n}return{ave:i/n,max:o,min:s}},t.prototype._getCurrentTime=function(){return+new Date},t.DEFAULT_INTERVAL=1e3,t.DEFAULT_LIMIT=1e3,t.BACKUP_MARGIN=100,t}();v.SimpleProfiler=Do;var jo,Go={};Object.defineProperty(Go,"__esModule",{value:!0}),function(t){t[t.Active=0]="Active",t[t.Passive=1]="Passive"}(jo||(jo={})),Go.default=jo;var Uo={},Bo=t&&t.__extends||function(){var t=function(e,r){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r])},t(e,r)};return function(e,r){if("function"!=typeof r&&null!==r)throw new TypeError("Class extends value "+String(r)+" is not a constructor or null");function i(){this.constructor=e}t(e,r),e.prototype=null===r?Object.create(r):(i.prototype=r.prototype,new i)}}();Object.defineProperty(Uo,"__esModule",{value:!0}),Uo.Game=void 0;var Ho=Io,No=function(t){function e(e){var r=t.call(this,e)||this;return r.agePassedTrigger=new Ho.Trigger,r.targetTimeReachedTrigger=new Ho.Trigger,r.skippingChangedTrigger=new Ho.Trigger,r.abortTrigger=new Ho.Trigger,r._notifyPassedAgeTable=Object.create(null),r._notifiesTargetTimeReached=!1,r._isSkipAware=!1,r.player=e.player,r.rawHandlerSet=e.handlerSet,r._gameArgs=e.gameArgs,r._globalGameArgs=e.globalGameArgs,r.skippingChangedTrigger.add(r._onSkippingChanged,r),r}return Bo(e,t),e.prototype.requestNotifyAgePassed=function(t){this._notifyPassedAgeTable[t]=!0},e.prototype.cancelNotifyAgePassed=function(t){delete this._notifyPassedAgeTable[t]},e.prototype.requestNotifyTargetTimeReached=function(){this._notifiesTargetTimeReached=!0},e.prototype.cancelNofityTargetTimeReached=function(){this._notifiesTargetTimeReached=!1},e.prototype.fireAgePassedIfNeeded=function(){var t=this.age-1;return!!this._notifyPassedAgeTable[t]&&(delete this._notifyPassedAgeTable[t],this.agePassedTrigger.fire(t),!0)},e.prototype.getIsSkipAware=function(){return this._isSkipAware},e.prototype.setIsSkipAware=function(t){this._isSkipAware=t},e.prototype._destroy=function(){this.agePassedTrigger.destroy(),this.agePassedTrigger=null,this.targetTimeReachedTrigger.destroy(),this.targetTimeReachedTrigger=null,this.skippingChangedTrigger.destroy(),this.skippingChangedTrigger=null,this.abortTrigger.destroy(),this.abortTrigger=null,this.player=null,this.rawHandlerSet=null,this._notifyPassedAgeTable=null,this._gameArgs=null,this._globalGameArgs=null,t.prototype._destroy.call(this)},e.prototype._restartWithSnapshot=function(t){var e=t.data;null!=e.seed?(this._reset({age:t.frame,randSeed:e.seed}),this._loadAndStart({args:this._gameArgs,globalArgs:this._globalGameArgs})):(this._reset({age:t.frame,nextEntityId:e.nextEntityId,randGenSer:e.randGenSer}),this._loadAndStart({args:this._gameArgs,snapshot:e.gameSnapshot}))},e.prototype._abortGame=function(){this.abortTrigger.fire()},e.prototype._onRawTargetTimeReached=function(t){this._notifiesTargetTimeReached&&(this._notifiesTargetTimeReached=!1,this.targetTimeReachedTrigger.fire(t))},e.prototype._onSkippingChanged=function(t){this._isSkipAware&&this.onSkipChange.fire(t)},e}(Ho.Game);Uo.Game=No;var Wo,Vo={},Xo={},zo={};Object.defineProperty(zo,"__esModule",{value:!0}),zo.PathUtil=void 0,function(t){t.resolvePath=function(e,r){function i(t){var e=t.split("/");return""===e[e.length-1]&&e.pop(),e}if(""===r)return e;for(var n=t.splitPath(e),o=i(n.path).concat(i(r)),s=[],a=0;a<o.length;++a){var h=o[a];switch(h){case"..":var u=s.pop();if(void 0===u||""===u||"."===u)throw new Error("PathUtil.resolvePath: invalid arguments");break;case".":0===s.length&&s.push(".");break;case"":s=[""];break;default:s.push(h)}}return n.host+s.join("/")},t.resolveDirname=function(t){var e=t.lastIndexOf("/");return-1===e?t:t.substr(0,e)},t.resolveExtname=function(t){for(var e=t.length-1;e>=0;--e){var r=t.charAt(e);if("."===r)return t.substr(e);if("/"===r)return""}return""},t.makeNodeModulePaths=function(e){var r=t.splitPath(e),i=r.host;"/"===(e=r.path)[e.length-1]&&(e=e.slice(0,e.length-1));for(var n=e.split("/"),o=n.indexOf("node_modules"),s=o>0?o-1:0,a=[],h=n.length-1;h>=s;--h)if("node_modules"!==n[h]){var u=n.slice(0,h+1);u.push("node_modules");var c=u.join("/");a.push(i+c)}return a},t.splitPath=function(t){var e="",r=t.indexOf("//");if(r>=0){var i=t.indexOf("/",r+2);i>=0?(e=t.slice(0,i),t=t.slice(i)):(e=t,t="/")}else e="";return{host:e,path:t}}}(Wo||(zo.PathUtil=Wo={}));var qo={};Object.defineProperty(qo,"__esModule",{value:!0});var Yo={},Ko=t&&t.__assign||function(){return Ko=Object.assign||function(t){for(var e,r=1,i=arguments.length;r<i;r++)for(var n in e=arguments[r])Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=e[n]);return t},Ko.apply(this,arguments)};Object.defineProperty(Yo,"__esModule",{value:!0}),Yo._mergeObject=Yo.toAssetArray=Yo.makeLoadConfigurationFunc=void 0;var $o=zo;function Jo(t,e){for(var r=Object.keys(e),i=0,o=r.length;i<o;++i){var s=r[i],a=e[s],h=n(a);if(h===n(t[s]))if("string"===h||"number"===h||"boolean"===h)t[s]=a;else{if("object"!==h)throw new Error("_mergeObject(): unknown type");null==a?t[s]=a:Array.isArray(a)?t[s]=t[s].concat(a):Jo(t[s],a)}else t[s]=a}return t}Yo.makeLoadConfigurationFunc=function(t){function e(e,i,o,s){t(e,(function(t,a){if(t)s(t);else if("definitions"in a){var h=a.definitions.map((function(t){return"string"==typeof t?r(o?$o.PathUtil.resolvePath(o,t):t,void 0,o):r(o?$o.PathUtil.resolvePath(o,t.url):t.url,t.basePath,o)}));Promise.all(h).then((function(t){return s(null,t.reduce(Jo))})).catch((function(t){return s(t)}))}else{var u=void 0;try{u=function(t,e){var r,i={};function o(t,e){if(i.hasOwnProperty(t))throw new Error("_normalizeAssets: asset ID already exists: "+t);i[t]=e}if(Array.isArray(t.assets))t.assets.forEach((function(t){var r,i=t.path;i&&(t.virtualPath=null!==(r=t.virtualPath)&&void 0!==r?r:t.path,t.path=$o.PathUtil.resolvePath(e,i)),o(i,t)}));else if("object"===n(t.assets))for(var s in t.assets)if(t.assets.hasOwnProperty(s)){var a=t.assets[s];a.path&&(a.virtualPath=null!==(r=a.virtualPath)&&void 0!==r?r:a.path,a.path=$o.PathUtil.resolvePath(e,a.path)),o(s,a)}t.globalScripts&&(t.globalScripts.forEach((function(t){o(t,{type:/\.json$/i.test(t)?"text":"script",virtualPath:t,path:$o.PathUtil.resolvePath(e,t),global:!0})})),delete t.globalScripts);return t.assets=i,t}(a,null!=i?i:$o.PathUtil.resolveDirname(e))}catch(t){return void s(t)}s(null,u)}}))}function r(t,r,i){return new Promise((function(n,o){e(t,r,i,(function(t,e){return t?o(t):n(e)}))}))}return e},Yo.toAssetArray=function(t){return Object.keys(t).map((function(e){return Ko({id:e},t[e])}))},Yo._mergeObject=Jo,function(e){var r=t&&t.__createBinding||(Object.create?function(t,e,r,i){void 0===i&&(i=r);var n=Object.getOwnPropertyDescriptor(e,r);n&&!("get"in n?!e.__esModule:n.writable||n.configurable)||(n={enumerable:!0,get:function(){return e[r]}}),Object.defineProperty(t,i,n)}:function(t,e,r,i){void 0===i&&(i=r),t[i]=e[r]}),i=t&&t.__exportStar||function(t,e){for(var i in t)"default"===i||Object.prototype.hasOwnProperty.call(e,i)||r(e,t,i)};Object.defineProperty(e,"__esModule",{value:!0}),i(zo,e),i(qo,e),i(Yo,e)}(Xo);var Zo={};Object.defineProperty(Zo,"__esModule",{value:!0}),Zo.EventBuffer=void 0;var Qo=function(){function t(e){var r=this;this._discardsEventsDuringSkip=!0,this._discardsLocalEventsDuringSkip=!0,this._filters=null,this._amflow=e.amflow,this._isLocalReceiver=!0,this._isReceiver=!1,this._isSender=!1,this._isDiscarder=!1,this._skipping=!1,this._defaultEventPriority=0,this._buffer=[],this._joinLeaveBuffer=[],this._localBuffer=[],this._filters=null,this._filterController={processNext:function(e){t.isEventLocal(e)?r._unfilteredLocalEvents.push(e):r._unfilteredEvents.push(e)}},this._unfilteredLocalEvents=[],this._unfilteredEvents=[],this._resolvePointEvent_bound=e.game.resolvePointEvent.bind(e.game),this._onEvent_bound=this.onEvent.bind(this)}return t.isEventLocal=function(t){switch(t[0]){case 0:case 3:case 64:return t[5];case 1:return t[3];case 2:case 32:return t[4];case 33:return t[8];case 34:case 35:return t[12];default:throw new Error("EventBuffer.isEventLocal")}},t.prototype.setMode=function(t){null!=t.isLocalReceiver&&(this._isLocalReceiver=t.isLocalReceiver),null!=t.isReceiver&&this._isReceiver!==t.isReceiver&&(this._isReceiver=t.isReceiver,t.isReceiver?this._amflow.onEvent(this._onEvent_bound):this._amflow.offEvent(this._onEvent_bound)),null!=t.isSender&&(this._isSender=t.isSender),null!=t.isDiscarder&&(this._isDiscarder=t.isDiscarder),null!=t.defaultEventPriority&&(this._defaultEventPriority=3&t.defaultEventPriority)},t.prototype.getMode=function(){return{isLocalReceiver:this._isLocalReceiver,isReceiver:this._isReceiver,isSender:this._isSender,isDiscarder:this._isDiscarder,defaultEventPriority:this._defaultEventPriority}},t.prototype.onEvent=function(e){t.isEventLocal(e)?!this._isLocalReceiver||this._isDiscarder||this._skipping&&this._discardsLocalEventsDuringSkip||this._unfilteredLocalEvents.push(e):this._skipping&&this._discardsEventsDuringSkip||(this._isReceiver&&!this._isDiscarder&&this._unfilteredEvents.push(e),this._isSender&&(null==e[1]&&(e[1]=3&this._defaultEventPriority),this._amflow.sendEvent(e)))},t.prototype.onPointEvent=function(t){var e=this._resolvePointEvent_bound(t);e&&this.onEvent(e)},t.prototype.addEventDirect=function(e){if(t.isEventLocal(e)){if(!this._isLocalReceiver||this._isDiscarder)return;this._localBuffer.push(e)}else this._isReceiver&&!this._isDiscarder&&(0===e[0]||1===e[0]?this._joinLeaveBuffer.push(e):this._buffer.push(e)),this._isSender&&(null==e[1]&&(e[1]=3&this._defaultEventPriority),this._amflow.sendEvent(e))},t.prototype.readEvents=function(){var t=this._buffer;return 0===t.length?null:(this._buffer=[],t)},t.prototype.readJoinLeaves=function(){var t=this._joinLeaveBuffer;return 0===t.length?null:(this._joinLeaveBuffer=[],t)},t.prototype.readLocalEvents=function(){var t=this._localBuffer;return 0===t.length?null:(this._localBuffer=[],t)},t.prototype.addFilter=function(t,e){this._filters||(this._filters=[]),this._filters.push({func:t,handleEmpty:!!e})},t.prototype.removeFilter=function(t){if(this._filters)if(t)for(var e=this._filters.length-1;e>=0;--e)this._filters[e].func===t&&this._filters.splice(e,1);else this._filters=null},t.prototype.processEvents=function(e){var r=this._unfilteredLocalEvents,i=this._unfilteredEvents;this._unfilteredLocalEvents=[];var n=r;if(!e&&i.length>0&&(n=n.length>0?n.concat(i):i,this._unfilteredEvents=[]),this._filters)for(var o=0;o<this._filters.length;++o){var s=this._filters[o];(n.length>0||s.handleEmpty)&&(n=this._filters[o].func(n,this._filterController)||[])}for(o=0;o<n.length;++o){var a=n[o];t.isEventLocal(a)?this._localBuffer.push(a):0===a[0]||1===a[0]?this._joinLeaveBuffer.push(a):this._buffer.push(a)}},t.prototype.startSkipping=function(){this._skipping=!0},t.prototype.endSkipping=function(){this._skipping=!1},t}();Zo.EventBuffer=Qo;var ts={};Object.defineProperty(ts,"__esModule",{value:!0}),ts.GameHandlerSet=void 0;var es=Io,rs=function(){function t(t){this.raiseEventTrigger=new es.Trigger,this.raiseTickTrigger=new es.Trigger,this.snapshotTrigger=new es.Trigger,this.changeSceneModeTrigger=new es.Trigger,this._getCurrentTimeFunc=null,this._eventFilterFuncs=null,this._local=null,this._tickGenerationMode=null,this.isSnapshotSaver=!!t.isSnapshotSaver}return t.prototype.setCurrentTimeFunc=function(t){this._getCurrentTimeFunc=t},t.prototype.setEventFilterFuncs=function(t){this._eventFilterFuncs=t},t.prototype.removeAllEventFilters=function(){this._eventFilterFuncs&&this._eventFilterFuncs.removeFilter()},t.prototype.changeSceneMode=function(t){this._local=t.local,this._tickGenerationMode=t.tickGenerationMode,this.changeSceneModeTrigger.fire(t)},t.prototype.getCurrentTime=function(){return Math.floor(this._getCurrentTimeFunc())},t.prototype.raiseEvent=function(t){this.raiseEventTrigger.fire(t)},t.prototype.raiseTick=function(t){this.raiseTickTrigger.fire(t)},t.prototype.addEventFilter=function(t,e){this._eventFilterFuncs&&this._eventFilterFuncs.addFilter(t,e)},t.prototype.removeEventFilter=function(t){this._eventFilterFuncs&&t&&this._eventFilterFuncs.removeFilter(t)},t.prototype.shouldSaveSnapshot=function(){return this.isSnapshotSaver},t.prototype.getInstanceType=function(){return this.shouldSaveSnapshot()?"active":"passive"},t.prototype.saveSnapshot=function(t,e,r,i,n){void 0===n&&(n=this._getCurrentTimeFunc()),this.shouldSaveSnapshot()&&this.snapshotTrigger.fire({frame:t,timestamp:n,data:{randGenSer:r,nextEntityId:i,gameSnapshot:e}})},t}();ts.GameHandlerSet=rs;var is={},ns={};Object.defineProperty(ns,"__esModule",{value:!0}),ns.Clock=void 0;var os=Io,ss=function(){function t(e){this.fps=e.fps,this.scaleFactor=e.scaleFactor||1,this.frameTrigger=new os.Trigger,this.rawFrameTrigger=new os.Trigger,this.deltaTimeBrokenThreshold=e.deltaTimeBrokenThreshold||t.DEFAULT_DELTA_TIME_BROKEN_THRESHOLD,this._platform=e.platform,this._maxFramePerOnce=e.maxFramePerOnce,e.frameHandler&&this.frameTrigger.add(e.frameHandler,e.frameHandlerOwner),this.running=!1,this._totalDeltaTime=0,this._onLooperCall_bound=this._onLooperCall.bind(this),this._looper=this._platform.createLooper(this._onLooperCall_bound),this._waitTime=0,this._waitTimeDoubled=0,this._waitTimeMax=0,this._skipFrameWaitTime=0,this._realMaxFramePerOnce=0}return t.prototype.start=function(){this.running||(this._totalDeltaTime=0,this._updateWaitTimes(this.fps,this.scaleFactor),this._looper.start(),this.running=!0)},t.prototype.stop=function(){this.running&&(this._looper.stop(),this.running=!1)},t.prototype.changeScaleFactor=function(t){this.running?(this.stop(),this.scaleFactor=t,this.start()):this.scaleFactor=t},t.prototype.setDeltaTimeBrokenThreshold=function(t){this.deltaTimeBrokenThreshold=t},t.prototype._onLooperCall=function(t){isNaN(t)&&(t=this._waitTime-this._totalDeltaTime);var e=t;if(t<=0)return this._waitTime-this._totalDeltaTime;t>this.deltaTimeBrokenThreshold&&(t=this._waitTime);var r=this._totalDeltaTime;if((r+=t)<=this._skipFrameWaitTime)return this._totalDeltaTime=r,this._waitTime-r;for(var i=r<this._waitTimeDoubled?1:r>this._waitTimeMax?this._realMaxFramePerOnce:r/this._waitTime|0,n=i,o={deltaTime:e,interrupt:!1};n>0&&this.running&&!o.interrupt;)--n,this.frameTrigger.fire(o),o.deltaTime=0;return r-=(i-n)*this._waitTime,this.rawFrameTrigger.fire(),this._totalDeltaTime=r,this._waitTime-r},t.prototype._updateWaitTimes=function(e,r){var i=e*r;this._waitTime=1e3/i,this._waitTimeDoubled=Math.max(2e3/i|0,1),this._waitTimeMax=Math.max(r*(1e3*this._maxFramePerOnce/i)|0,1),this._skipFrameWaitTime=this._waitTime*t.ANTICIPATE_RATE|0,this._realMaxFramePerOnce=this._maxFramePerOnce*r},t.ANTICIPATE_RATE=.8,t.DEFAULT_DELTA_TIME_BROKEN_THRESHOLD=150,t}();ns.Clock=ss;var as,hs={};Object.defineProperty(hs,"__esModule",{value:!0}),function(t){t[t.Realtime=0]="Realtime",t[t.Replay=1]="Replay",t[t.FrameByFrame=2]="FrameByFrame"}(as||(as={})),hs.default=as;var us,cs={};Object.defineProperty(cs,"__esModule",{value:!0}),function(t){t[t.AfterRawFrame=0]="AfterRawFrame",t[t.None=1]="None"}(us||(us={})),cs.default=us;var ls={},ds=t&&t.__extends||function(){var t=function(e,r){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r])},t(e,r)};return function(e,r){if("function"!=typeof r&&null!==r)throw new TypeError("Class extends value "+String(r)+" is not a constructor or null");function i(){this.constructor=e}t(e,r),e.prototype=null===r?Object.create(r):(i.prototype=r.prototype,new i)}}();Object.defineProperty(ls,"__esModule",{value:!0}),ls.ProfilerClock=void 0;var ps=function(t){function e(e){var r=t.call(this,e)||this;return r._profiler=e.profiler,r}return ds(e,t),e.prototype._onLooperCall=function(t){var e=t;if(t<=0)return this._waitTime-this._totalDeltaTime;t>this.deltaTimeBrokenThreshold&&(t=this._waitTime);var r=this._totalDeltaTime;if((r+=t)<=this._skipFrameWaitTime)return this._totalDeltaTime=r,this._waitTime-r;this._profiler.timeEnd(1),this._profiler.time(1);var i=r<this._waitTimeDoubled?1:r>this._waitTimeMax?this._realMaxFramePerOnce:r/this._waitTime|0,n=i,o={deltaTime:e,interrupt:!1};for(this._profiler.setValue(0,n-1);n>0&&this.running&&!o.interrupt;)--n,this._profiler.time(2),this.frameTrigger.fire(o),this._profiler.timeEnd(2),o.deltaTime=0;return r-=(i-n)*this._waitTime,this._profiler.time(3),this.rawFrameTrigger.fire(),this._profiler.timeEnd(3),this._totalDeltaTime=r,this._profiler.flush(),this._waitTime-r},e}(ns.Clock);ls.ProfilerClock=ps;var fs={},_s={};Object.defineProperty(_s,"__esModule",{value:!0}),_s.TickBuffer=void 0;var ys=Io,gs=Go;ys.EventIndex;var vs=function(){function t(e){this.currentAge=0,this.knownLatestAge=-1,this.gotNextTickTrigger=new ys.Trigger,this.gotNoTickTrigger=new ys.Trigger,this._receiving=!1,this._skipping=!1,this._tickRanges=[],this._nextTickTimeCache=null,this._amflow=e.amflow,this._prefetchThreshold=e.prefetchThreshold||t.DEFAULT_PREFETCH_THRESHOLD,this._sizeRequestOnce=e.sizeRequestOnce||t.DEFAULT_SIZE_REQUEST_ONCE,this._executionMode=e.executionMode,this._startedAt=e.startedAt||0,this._oldTimestampThreshold=null!=e.startedAt?e.startedAt-864e6:0,this._nearestAbsentAge=this.currentAge,this._addTick_bound=this.addTick.bind(this),this._onTicks_bound=this._onTicks.bind(this)}return t.prototype.start=function(){this._receiving=!0,this._updateAmflowReceiveState()},t.prototype.stop=function(){this._receiving=!1,this._updateAmflowReceiveState()},t.prototype.setExecutionMode=function(t){this._executionMode!==t&&(this._dropUntil(this.knownLatestAge+1),this.knownLatestAge=this.currentAge,this._nextTickTimeCache=null,this._nearestAbsentAge=this.currentAge,this._executionMode=t,this._updateAmflowReceiveState())},t.prototype.setCurrentAge=function(t){this._dropUntil(t),this._nextTickTimeCache=null,this.currentAge=t,this.knownLatestAge<t-1&&(this.knownLatestAge=t-1),this._nearestAbsentAge=this._findNearestAbscentAge(t)},t.prototype.startSkipping=function(){this._skipping=!0},t.prototype.endSkipping=function(){this._skipping=!1},t.prototype.hasNextTick=function(){return this.currentAge!==this._nearestAbsentAge},t.prototype.consume=function(){if(this.currentAge===this._nearestAbsentAge)return null;var t=this.currentAge,e=this._tickRanges[0];return t===e.start?(this._nextTickTimeCache=null,++this.currentAge,++e.start,t+this._prefetchThreshold===this._nearestAbsentAge&&this.requestTicks(this._nearestAbsentAge,this._sizeRequestOnce),e.start===e.end&&this._tickRanges.shift(),e.ticks.length>0&&e.ticks[0][0]===t?e.ticks.shift():t):(this._dropUntil(this.currentAge),this.consume())},t.prototype.readNextTickTime=function(){if(null!=this._nextTickTimeCache)return this._nextTickTimeCache;if(this.currentAge===this._nearestAbsentAge)return null;var t=this.currentAge,e=this._tickRanges[0];if(t===e.start){if(0===e.ticks.length)return null;var r=e.ticks[0];if(r[0]!==t)return null;var i=r[1];if(!i)return null;for(var n=0;n<i.length;++n)if(2===i[n][0]){var o=i[n][3];return o<this._oldTimestampThreshold&&(o+=this._startedAt),this._nextTickTimeCache=o,o}return null}return this._dropUntil(this.currentAge),this.readNextTickTime()},t.prototype.isKnownLatestTickTimeNear=function(t,e,r){return this._calcKnownLatestTickTimeDelta(t,e,r)<t},t.prototype.requestTicks=function(t,e){void 0===t&&(t=this.currentAge),void 0===e&&(e=this._sizeRequestOnce),this._skipping?this.requestNonIgnorableTicks(t,e):this.requestAllTicks(t,e)},t.prototype.requestAllTicks=function(t,e){void 0===t&&(t=this.currentAge),void 0===e&&(e=this._sizeRequestOnce),this._executionMode===gs.default.Passive&&("undefined"==typeof window||window.prompt!==window.confirm?this._amflow.getTickList({begin:t,end:t+e},this._onTicks_bound):this._amflow.getTickList(t,t+e,this._onTicks_bound))},t.prototype.requestNonIgnorableTicks=function(t,e){void 0===t&&(t=this.currentAge),void 0===e&&(e=this._sizeRequestOnce),this._executionMode===gs.default.Passive&&("undefined"==typeof window||window.prompt!==window.confirm?this._amflow.getTickList({begin:t,end:t+e,excludeEventFlags:{ignorable:!0}},this._onTicks_bound):this._amflow.getTickList(t,t+e,this._onTicks_bound))},t.prototype.addTick=function(t){var e=t[0],r=this.currentAge===e&&this._nearestAbsentAge===e;this.knownLatestAge<e&&(this.knownLatestAge=e);for(var i=this._tickRanges.length-1;i>=0;--i){if(e>=(n=this._tickRanges[i]).start)break}var n,o=this._tickRanges[i+1];i<0?this._tickRanges.unshift(this._createTickRangeFromTick(t)):e===(n=this._tickRanges[i]).end?(++n.end,t[1]&&n.ticks.push(t)):e>n.end&&this._tickRanges.splice(i+1,0,this._createTickRangeFromTick(t));this._nearestAbsentAge===e&&(++this._nearestAbsentAge,o&&this._nearestAbsentAge===o.start&&(this._nearestAbsentAge=this._findNearestAbscentAge(this._nearestAbsentAge))),r&&this.gotNextTickTrigger.fire()},t.prototype.addTickList=function(t){var e=t[0],r=t[1]+1,i=t[2],n=e,o=r;this.knownLatestAge<r-1&&(this.knownLatestAge=r-1);var s=0,a=this._tickRanges.length;for(s=0;s<a;++s){var h=this._tickRanges[s];if(e<h.start)break}var u=s;if(s>0){--s;var c=this._tickRanges[s].end;e<c&&(e=c)}for(;s<a;++s){h=this._tickRanges[s];if(r<=h.end)break}if(s<a){var l=this._tickRanges[s].start;r>l&&(r=l)}if(e>=r)return{start:e,end:e,ticks:[]};i||(i=[]),n===e&&o===r||(i=i.filter((function(t){var i=t[0];return e<=i&&i<r})));var d={start:e,end:r,ticks:i},p=Math.max(0,s-u);return this._tickRanges.splice(u,p,d),e<=this._nearestAbsentAge&&this._nearestAbsentAge<r&&(this._nearestAbsentAge=this._findNearestAbscentAge(this._nearestAbsentAge)),d},t.prototype.dropAll=function(){this._tickRanges=[],this._nearestAbsentAge=this.currentAge,this._nextTickTimeCache=null},t.prototype._updateAmflowReceiveState=function(){this._receiving&&this._executionMode===gs.default.Passive?this._amflow.onTick(this._addTick_bound):this._amflow.offTick(this._addTick_bound)},t.prototype._onTicks=function(t,e){if(t)throw t;if(e){var r=this.currentAge===this._nearestAbsentAge,i=this.addTickList(e);r&&i.start<=this.currentAge&&this.currentAge<i.end&&this.gotNextTickTrigger.fire(),i.start===i.end&&this.gotNoTickTrigger.fire()}else this.gotNoTickTrigger.fire()},t.prototype._findNearestAbscentAge=function(t){for(var e=0,r=this._tickRanges.length;e<r&&!(t<=this._tickRanges[e].end);++e);for(;e<r;++e){var i=this._tickRanges[e];if(t<i.start)break;t=i.end}return t},t.prototype._dropUntil=function(t){var e;for(e=0;e<this._tickRanges.length&&!(t<this._tickRanges[e].end);++e);if(this._tickRanges=this._tickRanges.slice(e),0!==this._tickRanges.length){var r=this._tickRanges[0];if(!(t<r.start)){for(r.start=t,e=0;e<r.ticks.length&&!(t<=r.ticks[e][0]);++e);r.ticks=r.ticks.slice(e)}}},t.prototype._calcKnownLatestTickTimeDelta=function(t,e,r){var i=this._tickRanges;if(0===i.length)return 0;for(var n=0,o=i[i.length-1].end,s=o,a=i.length-1;a>=0;--a){var h=i[a];if(h.end!==o)return 1/0;o=h.start;for(var u=h.ticks,c=u.length-1;c>=0;--c){var l=u[c],d=l[1];if(d){var p=l[0];if((n+=(s-p)*r)>t)return t;s=p;for(var f=0;f<d.length;++f)if(2===d[f][0]){var _=d[f][3]-e+n;return Math.min(_,t)}}}}return n+=(s-i[0].start)*r,Math.min(n,t)},t.prototype._createTickRangeFromTick=function(t){var e=t[0],r={start:e,end:e+1,ticks:[]};return t[1]&&r.ticks.push(t),r},t.DEFAULT_PREFETCH_THRESHOLD=1800,t.DEFAULT_SIZE_REQUEST_ONCE=9e3,t}();_s.TickBuffer=vs;var ms={};Object.defineProperty(ms,"__esModule",{value:!0}),ms.TickGenerator=void 0;var Ts=Io,As=function(){function t(t){this.tickTrigger=new Ts.Trigger,this.errorTrigger=new Ts.Trigger,this._nextAge=0,this._generatingTick=!1,t.errorHandler&&this.errorTrigger.add(t.errorHandler,t.errorHandlerOwner),this._amflow=t.amflow,this._eventBuffer=t.eventBuffer}return t.prototype.next=function(){if(this._generatingTick){var t=this._eventBuffer.readEvents(),e=this._eventBuffer.readJoinLeaves(),r=t&&e?t.concat(e):null!=t?t:e;this.tickTrigger.fire([this._nextAge++,r])}},t.prototype.forceNext=function(){var t=this._generatingTick;this._generatingTick=!0,this.next(),this._generatingTick=t},t.prototype.startStopGenerate=function(t){this._generatingTick=t},t.prototype.startTick=function(){this._generatingTick=!0},t.prototype.stopTick=function(){this._generatingTick=!1},t.prototype.setNextAge=function(t){this._nextAge=t},t}();ms.TickGenerator=As,Object.defineProperty(fs,"__esModule",{value:!0}),fs.TickController=void 0;var ws=Io,Ss=Go,bs=_s,Ps=ms,xs=function(){function t(t){this.errorTrigger=new ws.Trigger,t.errorHandler&&this.errorTrigger.add(t.errorHandler,t.errorHandlerOwner),this._amflow=t.amflow,this._clock=t.clock,this._started=!1,this._executionMode=t.executionMode,this._generator=new Ps.TickGenerator({amflow:t.amflow,eventBuffer:t.eventBuffer,errorHandler:this.errorTrigger.fire,errorHandlerOwner:this.errorTrigger}),this._buffer=new bs.TickBuffer({amflow:t.amflow,executionMode:t.executionMode,startedAt:t.startedAt}),this._generator.tickTrigger.add(this._onTickGenerated,this),this._clock.frameTrigger.add(this._generator.next,this._generator)}return t.prototype.startTick=function(){this._started=!0,this._updateGeneratorState()},t.prototype.stopTick=function(){this._started=!1,this._updateGeneratorState()},t.prototype.startTickOnce=function(){this._started=!0,this._generator.tickTrigger.addOnce(this._stopTriggerOnTick,this),this._updateGeneratorState()},t.prototype.setNextAge=function(t){this._generator.setNextAge(t)},t.prototype.forceGenerateTick=function(){this._generator.forceNext()},t.prototype.getBuffer=function(){return this._buffer},t.prototype.setExecutionMode=function(t){this._executionMode!==t&&(this._executionMode=t,this._updateGeneratorState(),this._buffer.setExecutionMode(t))},t.prototype._stopTriggerOnTick=function(){this.stopTick()},t.prototype._updateGeneratorState=function(){var t=this._started&&this._executionMode===Ss.default.Active;this._generator.startStopGenerate(t)},t.prototype._onTickGenerated=function(t){this._amflow.sendTick(t),this._buffer.addTick(t)},t}();fs.TickController=xs,Object.defineProperty(is,"__esModule",{value:!0}),is.GameLoop=void 0;var Es=Io,Os=ns,ks=i,Ms=Go,Ls=hs,Rs=cs,Cs=ls,Is=fs;Es.EventIndex;var Fs=function(){function t(t){this.errorTrigger=new Es.Trigger,this.rawTargetTimeReachedTrigger=new Es.Trigger,this.running=!1,this._omittedTickDuration=0,this._sceneTickMode=null,this._sceneLocalMode=null,this._waitingStartPoint=!1,this._lastRequestedStartPointAge=-1,this._lastRequestedStartPointTime=-1,this._waitingNextTick=!1,this._foundLatestTick=!1,this._skipping=!1,this._lastPollingTickTime=0,this._events=[],this._currentTime=t.startedAt,this._currentTickTime=this._currentTime,this._frameTime=1e3/t.game.fps,t.errorHandler&&this.errorTrigger.add(t.errorHandler,t.errorHandlerOwner);var e=t.configuration;this._startedAt=t.startedAt,this._targetTimeFunc=e.targetTimeFunc||null,this._targetTimeOffset=e.targetTimeOffset||null,this._originDate=e.originDate||null,this._realTargetTimeOffset=null!=this._originDate?this._originDate:(this._targetTimeOffset||0)+this._startedAt,this._delayIgnoreThreshold=e.delayIgnoreThreshold||ks.DEFAULT_DELAY_IGNORE_THRESHOLD,this._skipTicksAtOnce=e.skipTicksAtOnce||ks.DEFAULT_SKIP_TICKS_AT_ONCE,this._skipThreshold=e.skipThreshold||ks.DEFAULT_SKIP_THRESHOLD,this._skipThresholdTime=this._skipThreshold*this._frameTime,this._jumpTryThreshold=e.jumpTryThreshold||ks.DEFAULT_JUMP_TRY_THRESHOLD,this._jumpIgnoreThreshold=e.jumpIgnoreThreshold||ks.DEFAULT_JUMP_IGNORE_THRESHOLD,this._pollingTickThreshold=e._pollingTickThreshold||ks.DEFAULT_POLLING_TICK_THRESHOLD,this._playbackRate=e.playbackRate||1;var r=null!=e.loopRenderMode?e.loopRenderMode:Rs.default.AfterRawFrame;this._loopRenderMode=null,this._omitInterpolatedTickOnReplay=null==e.omitInterpolatedTickOnReplay||e.omitInterpolatedTickOnReplay,this._loopMode=e.loopMode,this._amflow=t.amflow,this._game=t.game,this._eventBuffer=t.eventBuffer,this._executionMode=t.executionMode,this._targetAge=null!=e.targetAge?e.targetAge:null,t.profiler?this._clock=new Cs.ProfilerClock({fps:t.game.fps,scaleFactor:this._playbackRate,platform:t.platform,maxFramePerOnce:5,profiler:t.profiler,deltaTimeBrokenThreshold:e.deltaTimeBrokenThreshold}):this._clock=new Os.Clock({fps:t.game.fps,scaleFactor:this._playbackRate,platform:t.platform,maxFramePerOnce:5,deltaTimeBrokenThreshold:e.deltaTimeBrokenThreshold}),this._tickController=new Is.TickController({amflow:t.amflow,clock:this._clock,eventBuffer:t.eventBuffer,executionMode:t.executionMode,startedAt:t.startedAt,errorHandler:this.errorTrigger.fire,errorHandlerOwner:this.errorTrigger}),this._tickBuffer=this._tickController.getBuffer(),this._onGotStartPoint_bound=this._onGotStartPoint.bind(this),this._setLoopRenderMode(r),this._game.setIsSkipAware(null==e.skipAwareGame||e.skipAwareGame),this._game.rawHandlerSet.raiseEventTrigger.add(this._onGameRaiseEvent,this),this._game.rawHandlerSet.raiseTickTrigger.add(this._onGameRaiseTick,this),this._game.rawHandlerSet.changeSceneModeTrigger.add(this._handleSceneChange,this),this._game._onStart.add(this._onGameStarted,this),this._tickBuffer.gotNextTickTrigger.add(this._onGotNextFrameTick,this),this._tickBuffer.gotNoTickTrigger.add(this._onGotNoTick,this),this._tickBuffer.start(),this._updateGameAudioSuppression()}return t.prototype.reset=function(t){this._clock.frameTrigger.remove(this._onEventsProcessed,this),this._skipping&&this._stopSkipping(),this._tickBuffer.setCurrentAge(t.frame),this._currentTime=t.timestamp||t.data.timestamp||0,this._currentTickTime=this._currentTime,this._waitingNextTick=!1,this._foundLatestTick=!1,this._lastRequestedStartPointAge=-1,this._lastRequestedStartPointTime=-1,this._omittedTickDuration=0,this._game._restartWithSnapshot(t)},t.prototype.start=function(){this.running=!0,this._clock.start()},t.prototype.stop=function(){this._clock.stop(),this.running=!1},t.prototype.setNextAge=function(t){this._tickController.setNextAge(t)},t.prototype.getExecutionMode=function(){return this._executionMode},t.prototype.setExecutionMode=function(t){this._executionMode=t,this._tickController.setExecutionMode(t)},t.prototype.getLoopConfiguration=function(){var t,e,r,i,n;return{loopMode:this._loopMode,delayIgnoreThreshold:this._delayIgnoreThreshold,skipTicksAtOnce:this._skipTicksAtOnce,skipThreshold:this._skipThreshold,skipAwareGame:this._game.getIsSkipAware(),jumpTryThreshold:this._jumpTryThreshold,jumpIgnoreThreshold:this._jumpIgnoreThreshold,playbackRate:this._playbackRate,loopRenderMode:null!==(t=this._loopRenderMode)&&void 0!==t?t:void 0,targetTimeFunc:null!==(e=this._targetTimeFunc)&&void 0!==e?e:void 0,targetTimeOffset:null!==(r=this._targetTimeOffset)&&void 0!==r?r:void 0,originDate:null!==(i=this._originDate)&&void 0!==i?i:void 0,omitInterpolatedTickOnReplay:this._omitInterpolatedTickOnReplay,targetAge:null!==(n=this._targetAge)&&void 0!==n?n:void 0,deltaTimeBrokenThreshold:this._clock.deltaTimeBrokenThreshold}},t.prototype.setLoopConfiguration=function(t){null!=t.loopMode&&(this._loopMode=t.loopMode),null!=t.delayIgnoreThreshold&&(this._delayIgnoreThreshold=t.delayIgnoreThreshold),null!=t.skipTicksAtOnce&&(this._skipTicksAtOnce=t.skipTicksAtOnce),null!=t.skipThreshold&&(this._skipThreshold=t.skipThreshold,this._skipThresholdTime=this._skipThreshold*this._frameTime),null!=t.skipAwareGame&&this._game.setIsSkipAware(t.skipAwareGame),null!=t.jumpTryThreshold&&(this._jumpTryThreshold=t.jumpTryThreshold),null!=t.jumpIgnoreThreshold&&(this._jumpIgnoreThreshold=t.jumpIgnoreThreshold),null!=t.playbackRate&&(this._playbackRate=t.playbackRate,this._clock.changeScaleFactor(this._playbackRate),this._updateGameAudioSuppression()),null!=t.loopRenderMode&&this._setLoopRenderMode(t.loopRenderMode),null!=t.targetTimeFunc&&(this._targetTimeFunc=t.targetTimeFunc),null!=t.targetTimeOffset&&(this._targetTimeOffset=t.targetTimeOffset),null!=t.originDate&&(this._originDate=t.originDate),this._realTargetTimeOffset=null!=this._originDate?this._originDate:(this._targetTimeOffset||0)+this._startedAt,null!=t.omitInterpolatedTickOnReplay&&(this._omitInterpolatedTickOnReplay=t.omitInterpolatedTickOnReplay),null!=t.targetAge&&(this._targetAge!==t.targetAge&&(this._waitingNextTick=!1),this._targetAge=t.targetAge),null!=t.deltaTimeBrokenThreshold&&this._clock.setDeltaTimeBrokenThreshold(t.deltaTimeBrokenThreshold)},t.prototype.addTickList=function(t){this._tickBuffer.addTickList(t)},t.prototype.getCurrentTime=function(){return this._currentTime},t.prototype._startSkipping=function(t){this._skipping=!0,t||this._updateGameAudioSuppression(),this._tickBuffer.startSkipping(),this._eventBuffer.startSkipping(),this._game.skippingChangedTrigger.fire(!0)},t.prototype._stopSkipping=function(){this._skipping=!1,this._updateGameAudioSuppression(),this._tickBuffer.endSkipping(),this._eventBuffer.endSkipping(),this._game.skippingChangedTrigger.fire(!1)},t.prototype._updateGameAudioSuppression=function(){1!==(this._skipping?this._playbackRate*this._skipTicksAtOnce:this._playbackRate)?this._game._startSuppressAudio():this._game._endSuppressAudio()},t.prototype._handleSceneChange=function(t){var e=t.local,r=t.tickGenerationMode;if(this._sceneLocalMode!==e||this._sceneTickMode!==r)switch(this._sceneLocalMode=e,this._sceneTickMode=r,this._clock.frameTrigger.remove(this._onFrame,this),this._clock.frameTrigger.remove(this._onLocalFrame,this),e){case"full-local":this._tickController.stopTick(),this._clock.frameTrigger.add(this._onLocalFrame,this);break;case"non-local":case"interpolate-local":"by-clock"===r?this._tickController.startTick():this._tickController.startTickOnce(),this._clock.frameTrigger.add(this._onFrame,this);break;default:return void this.errorTrigger.fire(new Error("Unknown LocalTickMode: "+e))}},t.prototype._onLocalFrame=function(){this._doLocalTick()},t.prototype._doLocalTick=function(){var t=this._game,e=this._eventBuffer.readLocalEvents();this._currentTime+=this._frameTime,e?t.tick(!1,Math.floor(this._omittedTickDuration/this._frameTime),e):t.tick(!1,Math.floor(this._omittedTickDuration/this._frameTime)),this._omittedTickDuration=0},t.prototype._onFrame=function(t){if(this._loopMode===Ls.default.Replay&&this._targetTimeFunc){var e=this._targetTimeFunc(),r=e+this._realTargetTimeOffset,i=this._currentTickTime;this._onFrameForTimedReplay(r,t),i===this._currentTickTime&&i<=r&&this._isImmediateBeforeOf(r)&&this.rawTargetTimeReachedTrigger.fire(e)}else this._onFrameNormal(t)},t.prototype._onFrameForTimedReplay=function(t,e){var r,i,n,o=!1,s=this._game,a=(t-this._currentTickTime)/this._frameTime;if((a>this._jumpTryThreshold||a<0)&&!this._waitingStartPoint&&this._lastRequestedStartPointTime<this._currentTickTime&&(this._waitingStartPoint=!0,this._lastRequestedStartPointTime=t,this._amflow.getStartPoint({timestamp:t},this._onGotStartPoint_bound)),a<=0)this._skipping&&this._stopSkipping();else{if(!this._skipping&&(a>this._skipThreshold||0===this._tickBuffer.currentAge)&&(this._tickBuffer.hasNextTick()||this._omitInterpolatedTickOnReplay&&this._foundLatestTick)){var h=a<=this._skipThreshold;this._startSkipping(h)}for(var u=0;u<this._skipTicksAtOnce;++u){var c=this._currentTime+this._frameTime;if(!this._tickBuffer.hasNextTick()){this._waitingNextTick||(this._startWaitingNextTick(),this._foundLatestTick||this._tickBuffer.requestNonIgnorableTicks()),this._omitInterpolatedTickOnReplay&&"interpolate-local"===this._sceneLocalMode&&(this._foundLatestTick&&(this._currentTime=t-this._frameTime),t>c&&this._doLocalTick());break}var l=null!==(n=this._tickBuffer.readNextTickTime())&&void 0!==n?n:this._currentTickTime+this._frameTime;if(t<=l&&t<=c)break;if(c<l){if(!this._omitInterpolatedTickOnReplay||!this._skipping){"interpolate-local"===this._sceneLocalMode&&this._doLocalTick();continue}if(t<=l){this._omittedTickDuration+=t-this._currentTickTime,this._currentTime=Math.floor(t/this._frameTime)*this._frameTime;break}c=l,this._omittedTickDuration+=l-this._currentTickTime}this._currentTime=c,this._currentTickTime=l;var d=this._tickBuffer.consume(),p=-1;if(this._events.length=0,null!=d){var f=this._eventBuffer.readLocalEvents();if(f&&(r=this._events).push.apply(r,f),"number"==typeof d)p=d,o=s.tick(!0,Math.floor(this._omittedTickDuration/this._frameTime),this._events);else{p=d[0];var _=d[1];_&&(i=this._events).push.apply(i,_),o=s.tick(!0,Math.floor(this._omittedTickDuration/this._frameTime),this._events)}}if(this._omittedTickDuration=0,s._notifyPassedAgeTable[p]&&s.fireAgePassedIfNeeded()){e.interrupt=!0;break}if(o)break}this._skipping&&t-this._currentTime<this._frameTime&&this._isImmediateBeforeOf(t)&&(this._stopSkipping(),this._tickBuffer.dropAll(),this._tickBuffer.requestTicks())}},t.prototype._onFrameNormal=function(t){var e,r,i=!1,n=this._game;if(!this._skipping&&t.deltaTime>this._skipThresholdTime&&(this._startSkipping(!1),this._waitingNextTick&&this._stopSkipping()),this._waitingNextTick)"interpolate-local"===this._sceneLocalMode&&this._doLocalTick();else{var o,s,a=this._tickBuffer.currentAge;if(this._loopMode===Ls.default.Realtime?s=(o=this._tickBuffer.knownLatestAge+1)-a:null===this._targetAge?(o=null,s=1):this._targetAge===a?(o=this._targetAge=null,s=1):s=(o=this._targetAge)-a,(s>this._jumpTryThreshold||s<0)&&!this._waitingStartPoint&&this._lastRequestedStartPointAge<a&&(this._waitingStartPoint=!0,this._lastRequestedStartPointAge=o,this._amflow.getStartPoint({frame:o},this._onGotStartPoint_bound)),s<=0)return 0===s&&(this._foundLatestTick||this._tickBuffer.requestNonIgnorableTicks(),this._startWaitingNextTick()),"interpolate-local"===this._sceneLocalMode&&this._doLocalTick(),void(this._skipping&&this._stopSkipping());if(!this._skipping&&(s>this._skipThreshold||0===a)&&this._tickBuffer.hasNextTick()){var h=0===a&&this._tickBuffer.isKnownLatestTickTimeNear(this._skipThresholdTime,this._currentTickTime,this._frameTime);this._startSkipping(h)}for(var u=!this._skipping&&s<=this._delayIgnoreThreshold?1:Math.min(s,this._skipTicksAtOnce),c=0;c<u;++c){var l=this._currentTime+this._frameTime,d=this._tickBuffer.readNextTickTime();if(null!=d&&l<d){if(!(this._loopMode===Ls.default.Realtime||this._omitInterpolatedTickOnReplay&&this._skipping)){if("interpolate-local"===this._sceneLocalMode){this._doLocalTick();continue}break}l=Math.ceil(d/this._frameTime)*this._frameTime,this._omittedTickDuration+=l-this._currentTickTime}this._currentTime=l,this._currentTickTime=null!=d?d:this._currentTickTime+this._frameTime;var p=this._tickBuffer.consume(),f=-1;if(this._events.length=0,null==p){this._tickBuffer.requestTicks(),this._startWaitingNextTick();break}var _=this._eventBuffer.readLocalEvents();if(_&&(e=this._events).push.apply(e,_),"number"==typeof p)f=p,i=n.tick(!0,Math.floor(this._omittedTickDuration/this._frameTime),this._events);else{f=p[0];var y=p[1];y&&(r=this._events).push.apply(r,y),i=n.tick(!0,Math.floor(this._omittedTickDuration/this._frameTime),this._events)}if(this._omittedTickDuration=0,n._notifyPassedAgeTable[f]&&n.fireAgePassedIfNeeded()){t.interrupt=!0;break}if(i)break}this._skipping&&o-this._tickBuffer.currentAge<1&&this._stopSkipping()}},t.prototype._onGotNextFrameTick=function(){this._waitingNextTick&&this._loopMode!==Ls.default.FrameByFrame&&this._stopWaitingNextTick()},t.prototype._onGotNoTick=function(){this._waitingNextTick&&(this._foundLatestTick=!0)},t.prototype._onGotStartPoint=function(t,e){if(this._waitingStartPoint=!1,t)this.errorTrigger.fire(t);else if(e){if(this._targetTimeFunc&&this._loopMode!==Ls.default.Realtime){var r=this._targetTimeFunc()+this._realTargetTimeOffset;if(r<e.timestamp)return;var i=this._currentTickTime;if(i<=r&&e.timestamp<i+this._jumpIgnoreThreshold*this._frameTime)return}else{var n=this._loopMode===Ls.default.Realtime?this._tickBuffer.knownLatestAge+1:this._targetAge;if(null===n||n<e.frame)return;var o=this._tickBuffer.currentAge;if(o<=n&&e.frame<o+this._jumpIgnoreThreshold)return}this.reset(e)}},t.prototype._onGameStarted=function(){this._clock.frameTrigger.add({index:0,owner:this,func:this._onEventsProcessed})},t.prototype._onEventsProcessed=function(){this._eventBuffer.processEvents("full-local"===this._sceneLocalMode)},t.prototype._setLoopRenderMode=function(t){if(t!==this._loopRenderMode)switch(this._loopRenderMode=t,t){case Rs.default.AfterRawFrame:this._clock.rawFrameTrigger.add(this._renderOnRawFrame,this);break;case Rs.default.None:this._clock.rawFrameTrigger.remove(this._renderOnRawFrame,this);break;default:this.errorTrigger.fire(new Error("GameLoop#_setLoopRenderMode: unknown mode: "+t))}},t.prototype._renderOnRawFrame=function(){this._game.render()},t.prototype._onGameRaiseEvent=function(t){this._eventBuffer.onEvent(t)},t.prototype._onGameRaiseTick=function(t){if(this._executionMode===Ms.default.Active){if(t)for(var e=0;e<t.length;++e)this._eventBuffer.addEventDirect(t[e]);this._tickController.forceGenerateTick()}},t.prototype._onPollingTick=function(){var t=Date.now();t-this._lastPollingTickTime>this._pollingTickThreshold&&(this._lastPollingTickTime=t,this._tickBuffer.requestTicks())},t.prototype._startWaitingNextTick=function(){this._waitingNextTick=!0,this._clock.rawFrameTrigger.add(this._onPollingTick,this),this._lastPollingTickTime=Date.now(),this._skipping&&this._stopSkipping()},t.prototype._stopWaitingNextTick=function(){this._waitingNextTick=!1,this._clock.rawFrameTrigger.remove(this._onPollingTick,this)},t.prototype._isImmediateBeforeOf=function(t){var e;return this._tickBuffer.hasNextTick()?t<(null!==(e=this._tickBuffer.readNextTickTime())&&void 0!==e?e:this._currentTickTime+this._frameTime):this._foundLatestTick},t}();is.GameLoop=Fs,Object.defineProperty(Vo,"__esModule",{value:!0}),Vo.GameDriver=void 0;var Ds=Io,js=Xo,Gs=i,Us=Zo,Bs=Go,Hs=Uo,Ns=ts,Ws=is,Vs=hs,Xs="GAME_DESTROYED",zs=function(){function t(t){this.errorTrigger=new Ds.Trigger,this.configurationLoadedTrigger=new Ds.Trigger,this.gameCreatedTrigger=new Ds.Trigger,this._rendererRequirement=null,this._game=null,this._gameLoop=null,this._eventBuffer=null,this._openedAmflow=!1,this._playToken=null,this._permission=null,this._hidden=!1,this._destroyed=!1,t.errorHandler&&this.errorTrigger.add(t.errorHandler,t.errorHandlerOwner),this._platform=t.platform,this._loadConfigurationFunc=(0,js.makeLoadConfigurationFunc)(t.platform.loadGameConfiguration),this._player=t.player}return t.prototype.initialize=function(t,e){this.doInitialize(t).then((function(){e()}),e)},t.prototype.changeState=function(t,e){var r,i=this,n=this._gameLoop&&this._gameLoop.running;n&&(null===(r=this._gameLoop)||void 0===r||r.stop()),this.initialize(t,(function(t){var r;t?null==e||e(t):(n&&(null===(r=i._gameLoop)||void 0===r||r.start()),null==e||e())}))},t.prototype.startGame=function(){this._gameLoop?this._gameLoop.start():this.errorTrigger.fire(new Error("Not initialized"))},t.prototype.stopGame=function(){this._gameLoop&&this._gameLoop.stop()},t.prototype.setNextAge=function(t){var e;null===(e=this._gameLoop)||void 0===e||e.setNextAge(t)},t.prototype.getPermission=function(){return this._permission},t.prototype.getDriverConfiguration=function(){var t;return{playId:this._playId,playToken:null!==(t=this._playToken)&&void 0!==t?t:void 0,executionMode:this._gameLoop?this._gameLoop.getExecutionMode():void 0,eventBufferMode:this._eventBuffer?this._eventBuffer.getMode():void 0}},t.prototype.getLoopConfiguration=function(){return this._gameLoop?this._gameLoop.getLoopConfiguration():null},t.prototype.getHidden=function(){return this._hidden},t.prototype.resetPrimarySurface=function(t,e,r){r=r||(this._rendererRequirement?this._rendererRequirement.rendererCandidates:void 0);var i=this._game,n=this._platform,o=n.getPrimarySurface();i.renderers=i.renderers.filter((function(t){return t!==o.renderer()})),n.setRendererRequirement({primarySurfaceWidth:t,primarySurfaceHeight:e,rendererCandidates:r}),this._rendererRequirement={primarySurfaceWidth:t,primarySurfaceHeight:e,rendererCandidates:r},i.renderers.push(n.getPrimarySurface().renderer()),i.width=t,i.height=e,i.onResized.fire({width:t,height:e}),i.modified()},t.prototype.doInitialize=function(t){var e=this,r=new Promise((function(r,i){if(e._gameLoop&&e._gameLoop.running)return i(new Error("Game is running. Must be stopped."));e._gameLoop&&t.loopConfiguration&&e._gameLoop.setLoopConfiguration(t.loopConfiguration),null!=t.hidden&&(e._hidden=t.hidden,e._game&&e._game._setMuted(t.hidden)),r()})).then((function(){return e._assertLive(),e._doSetDriverConfiguration(t.driverConfiguration)})),i=t.configurationUrl;return i?r.then((function(){return e._assertLive(),e._loadConfiguration(i,t.assetBase,t.configurationBase)})).then((function(r){return e._assertLive(),e._createGame(r,e._player,t)})):r},t.prototype.destroy=function(){var t=this;return new Promise((function(e,r){t.stopGame(),t._game&&(t._game._destroy(),t._game=null),t.errorTrigger.destroy(),t.errorTrigger=null,t.configurationLoadedTrigger.destroy(),t.configurationLoadedTrigger=null,t.gameCreatedTrigger.destroy(),t.gameCreatedTrigger=null,t._platform.destroy?t._platform.destroy():t._platform.setRendererRequirement(void 0),t._platform=null,t._loadConfigurationFunc=null,t._player=null,t._rendererRequirement=null,t._playId=void 0,t._gameLoop=null,t._eventBuffer=null,t._openedAmflow=!1,t._playToken=null,t._permission=null,t._hidden=!1,t._destroyed=!0,e()}))},t.prototype._doSetDriverConfiguration=function(t){var e,r,i=this;if(null==t)return Promise.resolve();void 0===t.playId&&(t.playId=null!==(e=this._playId)&&void 0!==e?e:void 0),void 0===t.playToken&&(t.playToken=null!==(r=this._playToken)&&void 0!==r?r:void 0),void 0===t.eventBufferMode&&(t.executionMode===Bs.default.Active?t.eventBufferMode={isReceiver:!0,isSender:!1}:t.executionMode===Bs.default.Passive&&(t.eventBufferMode={isReceiver:!1,isSender:!0}));var n=Promise.resolve();return this._playId!==t.playId&&(n=n.then((function(){return i._assertLive(),i._doOpenAmflow(t.playId)}))),this._playToken!==t.playToken&&(n=n.then((function(){return i._assertLive(),i._doAuthenticate(t.playToken)}))),n.then((function(){i._assertLive(),null!=t.eventBufferMode&&(null==t.eventBufferMode.defaultEventPriority&&(i._permission?t.eventBufferMode.defaultEventPriority=3&i._permission.maxEventPriority:t.eventBufferMode.defaultEventPriority=0),i._eventBuffer&&i._eventBuffer.setMode(t.eventBufferMode)),null!=t.executionMode&&i._gameLoop&&i._gameLoop.setExecutionMode(t.executionMode)}))},t.prototype._doCloseAmflow=function(){var t=this;return new Promise((function(e,r){if(!t._openedAmflow)return e();t._platform.amflow.close((function(i){t._openedAmflow=!1;var n=t._getCallbackError(i);if(n)return r(n);e()}))}))},t.prototype._doOpenAmflow=function(t){var e=this;return void 0===t?Promise.resolve():this._doCloseAmflow().then((function(){return e._assertLive(),new Promise((function(r,i){if(null===t)return r();e._platform.amflow.open(t,(function(n){var o=e._getCallbackError(n);if(o)return i(o);e._openedAmflow=!0,e._playId=t,e._game&&e._updateGamePlayId(e._game),r()}))}))}))},t.prototype._doAuthenticate=function(t){var e=this;return null==t?Promise.resolve():new Promise((function(r,i){e._platform.amflow.authenticate(t,(function(n,o){var s=e._getCallbackError(n);if(s)return i(s);o?(e._playToken=t,e._permission=o,e._game&&(e._game.rawHandlerSet.isSnapshotSaver=o.writeTick),r()):i(new Error("Permission denied."))}))}))},t.prototype._loadConfiguration=function(t,e,r){var i=this;return new Promise((function(n,o){i._loadConfigurationFunc(t,e,r,(function(t,e){var r=i._getCallbackError(t);r?o(r):e?(i.configurationLoadedTrigger.fire(e),n(e)):o(new Error("GameDriver#_loadConfiguration: No configuration found."))}))}))},t.prototype._putZerothStartPoint=function(t){var e=this;return new Promise((function(r,i){var n={frame:0,timestamp:t.startedAt,data:t};e._platform.amflow.putStartPoint(n,(function(t){var n=e._getCallbackError(t);if(n)return i(n);r()}))}))},t.prototype._getStartPoint=function(t){var e=this;return new Promise((function(r,i){e._platform.amflow.getStartPoint({frame:t},(function(t,n){var o=e._getCallbackError(t);return o?i(o):n?void r(n):i(new Error("GameDriver#_getStartPoint: No startPoint found"))}))}))},t.prototype._createGame=function(t,e,r){var i,n,o=this,s=!!(null===(i=this._permission)||void 0===i?void 0:i.writeTick),a=!((null===(n=r.driverConfiguration)||void 0===n?void 0:n.executionMode)!==Bs.default.Active)&&s;if(!r.loopConfiguration)throw new Error("GameDriver#_createGame: No loopConfiguration");var h=r.loopConfiguration;return(a?this._putZerothStartPoint({seed:Date.now(),globalArgs:r.globalGameArgs,fps:t.fps,startedAt:Date.now()}):Promise.resolve()).then((function(){return o._assertLive(),o._getStartPoint(0)})).then((function(t){return a||h.loopMode!==Vs.default.Realtime?[t,t]:o._getStartPoint(Gs.PSEUDO_INFINITE_AGE).then((function(e){return[t,e]}))})).then((function(i){var n=i[0],a=i[1];o._assertLive();var u=n.data;if("number"!=typeof u.seed)throw new Error("GameDriver#_createGame: No seed found in the zeroth startpoint.");var c=o._platform,l=r.driverConfiguration||{eventBufferMode:{isReceiver:!0,isSender:!1},executionMode:Bs.default.Active},d=u.seed,p=r.gameArgs,f=u.globalArgs,_=u.startedAt,y={primarySurfaceWidth:t.width,primarySurfaceHeight:t.height,rendererCandidates:t.renderers};c.setRendererRequirement(y);var g=new Ns.GameHandlerSet({isSnapshotSaver:s}),v=new Hs.Game({engineModule:Ds,handlerSet:g,configuration:t,selfId:e.id,player:e,resourceFactory:c.getResourceFactory(),assetBase:r.assetBase,operationPluginViewInfo:c.getOperationPluginViewInfo?c.getOperationPluginViewInfo():void 0,gameArgs:p,globalGameArgs:f}),m=new Us.EventBuffer({game:v,amflow:c.amflow}),T=l.eventBufferMode,A=l.executionMode;m.setMode(T),c.setPlatformEventHandler(m),g.setEventFilterFuncs({addFilter:m.addFilter.bind(m),removeFilter:m.removeFilter.bind(m)}),v.renderers.push(c.getPrimarySurface().renderer());var w=new Ws.GameLoop({game:v,amflow:c.amflow,platform:c,executionMode:A,eventBuffer:m,configuration:h,startedAt:_,profiler:r.profiler});w.rawTargetTimeReachedTrigger.add(v._onRawTargetTimeReached,v),g.setCurrentTimeFunc(w.getCurrentTime.bind(w)),v._reset({age:0,randSeed:d}),o._updateGamePlayId(v),o._hidden&&v._setMuted(!0),g.snapshotTrigger.add((function(t){0!==t.frame&&o._platform.amflow.putStartPoint(t,(function(t){var e=o._getCallbackError(t);e&&o.errorTrigger.fire(e)}))})),o._game=v,o._eventBuffer=m,o._gameLoop=w,o._rendererRequirement=y,o.gameCreatedTrigger.fire(v),w.reset(a)}))},t.prototype._updateGamePlayId=function(t){var e=this;t.playId=this._playId,t.external.send=function(t){e._playId&&e._platform.sendToExternal(e._playId,t)}},t.prototype._assertLive=function(){if(this._destroyed)throw new Error(Xs)},t.prototype._getCallbackError=function(t){return t||(this._destroyed?new Error(Xs):null)},t}();Vo.GameDriver=zs,function(e){var r=t&&t.__createBinding||(Object.create?function(t,e,r,i){void 0===i&&(i=r);var n=Object.getOwnPropertyDescriptor(e,r);n&&!("get"in n?!e.__esModule:n.writable||n.configurable)||(n={enumerable:!0,get:function(){return e[r]}}),Object.defineProperty(t,i,n)}:function(t,e,r,i){void 0===i&&(i=r),t[i]=e[r]}),n=t&&t.__exportStar||function(t,e){for(var i in t)"default"===i||Object.prototype.hasOwnProperty.call(e,i)||r(e,t,i)};Object.defineProperty(e,"__esModule",{value:!0}),e.LoopRenderMode=e.LoopMode=e.GameDriver=e.Game=e.ExecutionMode=e.SimpleProfiler=e.ReplayAmflowProxy=e.MemoryAmflowClient=void 0,n(i,e);var o=p;Object.defineProperty(e,"MemoryAmflowClient",{enumerable:!0,get:function(){return o.MemoryAmflowClient}});var s=y;Object.defineProperty(e,"ReplayAmflowProxy",{enumerable:!0,get:function(){return s.ReplayAmflowProxy}});var a=v;Object.defineProperty(e,"SimpleProfiler",{enumerable:!0,get:function(){return a.SimpleProfiler}});var h=Go;e.ExecutionMode=h.default;var u=Uo;Object.defineProperty(e,"Game",{enumerable:!0,get:function(){return u.Game}});var c=Vo;Object.defineProperty(e,"GameDriver",{enumerable:!0,get:function(){return c.GameDriver}});var l=hs;e.LoopMode=l.default;var d=cs;e.LoopRenderMode=d.default}(r);var qs=r,Ys={},Ks={};Object.defineProperty(Ks,"__esModule",{value:!0}),Ks.Asset=void 0;var $s=P,Js=function(){function t(t,e){this.id=t,this.originalPath=e,this.path=this._assetPathFilter(e),this.onDestroyed=new $s.Trigger}return t.prototype.destroy=function(){this.onDestroyed.fire(this),this.id=void 0,this.originalPath=void 0,this.path=void 0,this.onDestroyed.destroy(),this.onDestroyed=void 0},t.prototype.destroyed=function(){return void 0===this.id},t.prototype.inUse=function(){return!1},t.prototype._assetPathFilter=function(t){return t},t}();Ks.Asset=Js;var Zs=t&&t.__extends||function(){var t=function(e,r){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r])},t(e,r)};return function(e,r){if("function"!=typeof r&&null!==r)throw new TypeError("Class extends value "+String(r)+" is not a constructor or null");function i(){this.constructor=e}t(e,r),e.prototype=null===r?Object.create(r):(i.prototype=r.prototype,new i)}}();Object.defineProperty(Ys,"__esModule",{value:!0}),Ys.AudioAsset=void 0;var Qs=function(t){function e(e,r,i,n,o,s,a){var h=t.call(this,e,r)||this;return h.type="audio",h.duration=i,h.loop=o,h.hint=s,h._system=n,h.data=void 0,h.offset=a,h}return Zs(e,t),e.prototype.play=function(){var t=this._system.createPlayer();return t.play(this),this._lastPlayedPlayer=t,t},e.prototype.stop=function(){for(var t=this._system.findPlayers(this),e=0;e<t.length;++e)t[e].stop()},e.prototype.inUse=function(){return this._system.findPlayers(this).length>0},e.prototype.destroy=function(){this._system&&this.stop(),this.data=void 0,this._system=void 0,this._lastPlayedPlayer=void 0,t.prototype.destroy.call(this)},e}(Ks.Asset);Ys.AudioAsset=Qs;var ta={};Object.defineProperty(ta,"__esModule",{value:!0}),ta.AudioPlayer=void 0;var ea=P,ra=function(){function t(t){this.onPlay=new ea.Trigger,this.onStop=new ea.Trigger,this.played=this.onPlay,this.stopped=this.onStop,this.currentAudio=void 0,this.volume=t.volume,this._muted=t._muted,this._system=t}return t.prototype.play=function(t){this.currentAudio=t,this.onPlay.fire({player:this,audio:t})},t.prototype.stop=function(){var t=this.currentAudio;t&&(this.currentAudio=void 0,this.onStop.fire({player:this,audio:t}))},t.prototype.canHandleStopped=function(){return!0},t.prototype.changeVolume=function(t){this.volume=t},t.prototype._changeMuted=function(t){this._muted=t},t.prototype._notifyVolumeChanged=function(){this.changeVolume(this.volume)},t}();ta.AudioPlayer=ra;var ia={},na=t&&t.__extends||function(){var t=function(e,r){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r])},t(e,r)};return function(e,r){if("function"!=typeof r&&null!==r)throw new TypeError("Class extends value "+String(r)+" is not a constructor or null");function i(){this.constructor=e}t(e,r),e.prototype=null===r?Object.create(r):(i.prototype=r.prototype,new i)}}();Object.defineProperty(ia,"__esModule",{value:!0}),ia.ScriptAsset=void 0;var oa=function(t){function e(e,r,i){void 0===i&&(i=[]);var n=t.call(this,e,r)||this;return n.type="script",n.exports=i,n.script=void 0,n}return na(e,t),e.prototype.destroy=function(){this.script=void 0,t.prototype.destroy.call(this)},e}(Ks.Asset);ia.ScriptAsset=oa;var sa={},aa=t&&t.__extends||function(){var t=function(e,r){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r])},t(e,r)};return function(e,r){if("function"!=typeof r&&null!==r)throw new TypeError("Class extends value "+String(r)+" is not a constructor or null");function i(){this.constructor=e}t(e,r),e.prototype=null===r?Object.create(r):(i.prototype=r.prototype,new i)}}();Object.defineProperty(sa,"__esModule",{value:!0}),sa.TextAsset=void 0;var ha=function(t){function e(e,r){var i=t.call(this,e,r)||this;return i.type="text",i.data=void 0,i}return aa(e,t),e.prototype.destroy=function(){this.data=void 0,t.prototype.destroy.call(this)},e}(Ks.Asset);sa.TextAsset=ha;var ua=Io;ua.AudioAsset=Ys.AudioAsset,ua.AudioPlayer=ta.AudioPlayer,ua.ScriptAsset=ia.ScriptAsset,ua.TextAsset=sa.TextAsset;var ca,la,da={},pa={},fa={},_a={},ya={};function ga(){return ca||(ca=1,Object.defineProperty(ya,"__esModule",{value:!0}),ya.ExceptionFactory=void 0,function(t){t.createAssetLoadError=function(t,e,r){return void 0===e&&(e=!0),{name:"AssetLoadError",message:t,retriable:e,cause:r}}}(t||(ya.ExceptionFactory=t={}))),ya;var t}function va(){if(la)return _a;la=1,Object.defineProperty(_a,"__esModule",{value:!0}),_a.XHRLoader=void 0;var t=ga(),e=function(){function e(t){void 0===t&&(t={}),this.timeout=t.timeout||15e3}return e.prototype.get=function(t,e){this._getRequestObject({url:t,responseType:"text"},e)},e.prototype.getArrayBuffer=function(t,e){this._getRequestObject({url:t,responseType:"arraybuffer"},e)},e.prototype._getRequestObject=function(e,r){var i=new XMLHttpRequest;i.open("GET",e.url,!0),i.responseType=e.responseType,i.timeout=this.timeout,i.addEventListener("timeout",(function(){r(t.ExceptionFactory.createAssetLoadError("loading timeout"))}),!1),i.addEventListener("load",(function(){if(i.status>=200&&i.status<300){var n="text"===e.responseType?i.responseText:i.response;r(null,n)}else r(t.ExceptionFactory.createAssetLoadError("loading error. status: "+i.status))}),!1),i.addEventListener("error",(function(){r(t.ExceptionFactory.createAssetLoadError("loading error. status: "+i.status))}),!1),i.send()},e}();return _a.XHRLoader=e,_a}var ma,Ta,Aa={};function wa(){if(ma)return Aa;ma=1,Object.defineProperty(Aa,"__esModule",{value:!0}),Aa.Asset=void 0;var t=P,e=function(){function e(e,r){this.onDestroyed=new t.Trigger,this.id=e,this.originalPath=r,this.path=this._assetPathFilter(r)}return e.prototype.destroy=function(){this.onDestroyed.fire(this),this.id=void 0,this.originalPath=void 0,this.path=void 0,this.onDestroyed.destroy(),this.onDestroyed=void 0},e.prototype.destroyed=function(){return void 0===this.id},e.prototype.inUse=function(){return!1},e.prototype._assetPathFilter=function(t){return t},e}();return Aa.Asset=e,Aa}function Sa(){if(Ta)return fa;Ta=1;var e=t&&t.__extends||function(){var t=function(e,r){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r])},t(e,r)};return function(e,r){if("function"!=typeof r&&null!==r)throw new TypeError("Class extends value "+String(r)+" is not a constructor or null");function i(){this.constructor=e}t(e,r),e.prototype=null===r?Object.create(r):(i.prototype=r.prototype,new i)}}();Object.defineProperty(fa,"__esModule",{value:!0}),fa.XHRTextAsset=void 0;var r=va(),i=function(t){function i(e,r){var i=t.call(this,e,r)||this;return i.type="text",i.data="",i}return e(i,t),i.prototype._load=function(t){var e=this;(new r.XHRLoader).get(this.path,(function(r,i){r?t._onAssetError(e,r):i?(e.data=i,t._onAssetLoad(e)):t._onAssetError(e,{name:"AssetLoadError",message:"XHRTextAsset#_load(): no data received",retriable:!1})}))},i.prototype.destroy=function(){this.data=void 0,t.prototype.destroy.call(this)},i}(wa().Asset);return fa.XHRTextAsset=i,fa}var ba,Pa={};var xa,Ea,Oa={},ka={},Ma={},La={};function Ra(){if(xa)return La;xa=1,Object.defineProperty(La,"__esModule",{value:!0}),La.preventEventDefault=La.InputEventHandler=void 0;var t=P,e=function(){function e(e){this.inputView=e,this.pointerEventLock={},this._xScale=1,this._yScale=1,this.pointTrigger=new t.Trigger,e.style.touchAction="none",e.style.userSelect="none"}return e.isSupported=function(){return!1},e.prototype.setScale=function(t,e){void 0===e&&(e=t),this._xScale=t,this._yScale=e},e.prototype.pointDown=function(t,e,r){e.offsetX<0||e.offsetY<0||e.offsetX>this.inputView.offsetWidth||e.offsetY>this.inputView.offsetHeight||(this.pointTrigger.fire({type:0,identifier:t,offset:this.getOffsetFromEvent(e),button:r}),this.pointerEventLock[t]=!0)},e.prototype.pointMove=function(t,e,r){this.pointerEventLock.hasOwnProperty(t+"")&&this.pointTrigger.fire({type:1,identifier:t,offset:this.getOffsetFromEvent(e),button:r})},e.prototype.pointUp=function(t,e,r){this.pointerEventLock.hasOwnProperty(t+"")&&(this.pointTrigger.fire({type:2,identifier:t,offset:this.getOffsetFromEvent(e),button:r}),delete this.pointerEventLock[t])},e.prototype.getOffsetFromEvent=function(t){return{x:t.offsetX,y:t.offsetY}},e.prototype.getScale=function(){return{x:this._xScale,y:this._yScale}},e.prototype.getOffsetPositionFromInputView=function(t){var e=this.inputView.getBoundingClientRect(),r=this.getScale();return{offsetX:(t.pageX-Math.round(window.pageXOffset+e.left))/r.x,offsetY:(t.pageY-Math.round(window.pageYOffset+e.top))/r.y}},e}();return La.InputEventHandler=e,La.preventEventDefault=function(t){t.preventDefault()},La}var Ca,Ia,Fa,Da={};function ja(){if(Ia)return ka;Ia=1,Object.defineProperty(ka,"__esModule",{value:!0}),ka.InputHandlerLayer=void 0;var e=P,r=function(){if(Ea)return Ma;Ea=1;var e=t&&t.__extends||function(){var t=function(e,r){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r])},t(e,r)};return function(e,r){if("function"!=typeof r&&null!==r)throw new TypeError("Class extends value "+String(r)+" is not a constructor or null");function i(){this.constructor=e}t(e,r),e.prototype=null===r?Object.create(r):(i.prototype=r.prototype,new i)}}();Object.defineProperty(Ma,"__esModule",{value:!0}),Ma.MouseTouchEventHandler=void 0;var r=Ra(),i=function(t){function i(){var e=null!==t&&t.apply(this,arguments)||this;return e.pressingMouseButton=null,e.onMouseDown=function(t){null==e.pressingMouseButton&&(e.pressingMouseButton=t.button,e.pointDown(i.MOUSE_IDENTIFIER,e.getOffsetPositionFromInputView(t),e.getPlatformButtonType(t,0)),window.addEventListener("mousemove",e.onWindowMouseMove,!1),window.addEventListener("mouseup",e.onWindowMouseUp,!1))},e.onWindowMouseMove=function(t){e.pointMove(i.MOUSE_IDENTIFIER,e.getOffsetPositionFromInputView(t),-1)},e.onWindowMouseUp=function(t){e.pressingMouseButton===t.button&&(e.pressingMouseButton=null,e.pointUp(i.MOUSE_IDENTIFIER,e.getOffsetPositionFromInputView(t),e.getPlatformButtonType(t,0)),window.removeEventListener("mousemove",e.onWindowMouseMove,!1),window.removeEventListener("mouseup",e.onWindowMouseUp,!1))},e.onTouchStart=function(t){for(var r=t.changedTouches,i=0,n=r.length;i<n;i++){var o=r[i];e.pointDown(o.identifier,e.getOffsetPositionFromInputView(o),0)}t.preventDefault()},e.onTouchMove=function(t){for(var r=t.changedTouches,i=0,n=r.length;i<n;i++){var o=r[i];e.pointMove(o.identifier,e.getOffsetPositionFromInputView(o),0)}},e.onTouchEnd=function(t){for(var r=t.changedTouches,i=0,n=r.length;i<n;i++){var o=r[i];e.pointUp(o.identifier,e.getOffsetPositionFromInputView(o),0)}window.removeEventListener("touchmove",e.onTouchMove,!1),window.removeEventListener("touchend",e.onTouchEnd,!1)},e}return e(i,t),i.isSupported=function(){return!1},i.prototype.start=function(){this.inputView.addEventListener("mousedown",this.onMouseDown,!1),this.inputView.addEventListener("touchstart",this.onTouchStart),this.inputView.addEventListener("touchmove",this.onTouchMove),this.inputView.addEventListener("touchend",this.onTouchEnd),this.inputView.addEventListener("contextmenu",r.preventEventDefault)},i.prototype.stop=function(){this.inputView.removeEventListener("mousedown",this.onMouseDown,!1),this.inputView.removeEventListener("touchstart",this.onTouchStart),this.inputView.removeEventListener("touchmove",this.onTouchMove),this.inputView.removeEventListener("touchend",this.onTouchEnd),this.inputView.removeEventListener("contextmenu",r.preventEventDefault)},i.prototype.getPlatformButtonType=function(t,e){switch(t.button){case-1:return-1;case 0:return 0;case 1:return 1;case 2:return 2;default:return e}},i.MOUSE_IDENTIFIER=1,i}(r.InputEventHandler);return Ma.MouseTouchEventHandler=i,Ma}(),i=function(){if(Ca)return Da;Ca=1;var e=t&&t.__extends||function(){var t=function(e,r){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r])},t(e,r)};return function(e,r){if("function"!=typeof r&&null!==r)throw new TypeError("Class extends value "+String(r)+" is not a constructor or null");function i(){this.constructor=e}t(e,r),e.prototype=null===r?Object.create(r):(i.prototype=r.prototype,new i)}}();Object.defineProperty(Da,"__esModule",{value:!0}),Da.PointerEventHandler=void 0;var r=Ra(),i=function(t){function i(e){var r=t.call(this,e)||this;return r.onPointerDown=function(t){r.pointDown(t.pointerId,r.getOffsetPositionFromInputView(t),r.getPlatformButtonType(t,0));var e=function(t){r.pointMove(t.pointerId,r.getOffsetPositionFromInputView(t),r.getPlatformButtonType(t,-1))},i=function(e){if(r.pointUp(e.pointerId,r.getOffsetPositionFromInputView(e),r.getPlatformButtonType(e,0)),t.pointerId===e.pointerId){var i=r._eventHandlersMap[e.pointerId];if(!i)return;var n=i.onPointerMove,o=i.onPointerUp;window.removeEventListener("pointermove",n,!1),window.removeEventListener("pointerup",o,!1),delete r._eventHandlersMap[e.pointerId]}};window.addEventListener("pointermove",e,!1),window.addEventListener("pointerup",i,!1),r._eventHandlersMap[t.pointerId]={onPointerMove:e,onPointerUp:i}},r._eventHandlersMap=Object.create(null),r}return e(i,t),i.isSupported=function(){return!1},i.prototype.start=function(){this.inputView.addEventListener("pointerdown",this.onPointerDown,!1),this.inputView.addEventListener("contextmenu",r.preventEventDefault,!1)},i.prototype.stop=function(){this.inputView.removeEventListener("pointerdown",this.onPointerDown,!1),this.inputView.removeEventListener("contextmenu",r.preventEventDefault,!1)},i.prototype.getPlatformButtonType=function(t,e){switch(t.button){case-1:return-1;case 0:return 0;case 1:return 1;case 2:return 2;default:return e}},i}(r.InputEventHandler);return Da.PointerEventHandler=i,Da}(),n=function(){function t(t){this.view=this._createInputView(t.width,t.height),this._inputHandler=void 0,this.pointEventTrigger=new e.Trigger}return t.prototype.enablePointerEvent=function(){var t=this,e=!!window.PointerEvent;this._inputHandler=e?new i.PointerEventHandler(this.view):new r.MouseTouchEventHandler(this.view),this._inputHandler.pointTrigger.add((function(e){t.pointEventTrigger.fire(e)})),this._inputHandler.start()},t.prototype.disablePointerEvent=function(){var t;null===(t=this._inputHandler)||void 0===t||t.stop()},t.prototype.setOffset=function(t){var e="position:relative; left:".concat(t.x,"px; top:").concat(t.y,"px");this._inputHandler.inputView.setAttribute("style",e)},t.prototype.setViewSize=function(t){var e=this.view;e.style.width=t.width+"px",e.style.height=t.height+"px"},t.prototype.setViewTabIndex=function(t){this.view.setAttribute("tabindex",t)},t.prototype._createInputView=function(t,e){var r=document.createElement("div");return r.setAttribute("style","display:inline-block; outline:none; touch-action:none"),r.style.width=t+"px",r.style.height=e+"px",r.setAttribute("tabindex","0"),r},t}();return ka.InputHandlerLayer=n,ka}var Ga,Ua={};function Ba(){if(Ga)return Ua;Ga=1,Object.defineProperty(Ua,"__esModule",{value:!0}),Ua.AudioPluginManager=void 0;var t=function(){function t(){this._activePlugin=null}return t.prototype.getActivePlugin=function(){return this._activePlugin},t.prototype.tryInstallPlugin=function(t){for(var e=0,r=t.length;e<r;e++){var i=t[e];if(!i.isSupported)return this._activePlugin=i,!0;var n=i;if(n.isSupported())return this._activePlugin=new n,!0}return!1},t}();return Ua.AudioPluginManager=t,Ua}var Ha,Na={};function Wa(){if(Ha)return Na;Ha=1,Object.defineProperty(Na,"__esModule",{value:!0}),Na.AudioPluginRegistry=void 0;var t=[];return Na.AudioPluginRegistry={addPlugin:function(e){-1===t.indexOf(e)&&t.push(e)},getRegisteredAudioPlugins:function(){return t},clear:function(){t=[]}},Na}var Va,Xa={};var za,qa={},Ya={};var Ka,$a,Ja={},Za={},Qa={},th={},eh={};function rh(){if(Ka)return eh;Ka=1,Object.defineProperty(eh,"__esModule",{value:!0}),eh.Surface=void 0;var t=function(){function t(t,e,r){this.width=Math.ceil(t),this.height=Math.ceil(e),this._drawable=r}return t.prototype.destroy=function(){this._destroyed=!0},t.prototype.destroyed=function(){return!!this._destroyed},t}();return eh.Surface=t,eh}function ih(){if($a)return th;$a=1;var e=t&&t.__extends||function(){var t=function(e,r){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r])},t(e,r)};return function(e,r){if("function"!=typeof r&&null!==r)throw new TypeError("Class extends value "+String(r)+" is not a constructor or null");function i(){this.constructor=e}t(e,r),e.prototype=null===r?Object.create(r):(i.prototype=r.prototype,new i)}}();Object.defineProperty(th,"__esModule",{value:!0}),th.CanvasSurface=void 0;var r=function(t){function r(e,r){var i=this,n=document.createElement("canvas");return i=t.call(this,e,r,n)||this,n.width=e,n.height=r,i.canvas=n,i}return e(r,t),r.prototype.destroy=function(){this.canvas.width=1,this.canvas.height=1,this.canvas=void 0,t.prototype.destroy.call(this)},r.prototype.getHTMLElement=function(){return this.canvas},r.prototype.changeVisualScale=function(t,e){var r=this.canvas.style;"transform"in r?(r.transformOrigin="0 0",r.transform="scale("+t+","+e+")"):"webkitTransform"in r?(r.webkitTransformOrigin="0 0",r.webkitTransform="scale("+t+","+e+")"):(r.width=Math.floor(t*this.width)+"px",r.height=Math.floor(e*this.width)+"px")},r}(rh().Surface);return th.CanvasSurface=r,th}var nh,oh,sh,ah={},hh={},uh={};function ch(){if(nh)return uh;nh=1,Object.defineProperty(uh,"__esModule",{value:!0}),uh.AffineTransformer=void 0;var t=function(){function t(t){this.matrix=t?new Float32Array(t.matrix):new Float32Array([1,0,0,1,0,0])}return t.prototype.scale=function(t,e){var r=this.matrix;return r[0]*=t,r[1]*=t,r[2]*=e,r[3]*=e,this},t.prototype.translate=function(t,e){var r=this.matrix;return r[4]+=r[0]*t+r[2]*e,r[5]+=r[1]*t+r[3]*e,this},t.prototype.transform=function(t){var e=this.matrix,r=t[0]*e[0]+t[1]*e[2],i=t[0]*e[1]+t[1]*e[3],n=t[2]*e[0]+t[3]*e[2],o=t[2]*e[1]+t[3]*e[3],s=t[4]*e[0]+t[5]*e[2]+e[4],a=t[4]*e[1]+t[5]*e[3]+e[5];return e[0]=r,e[1]=i,e[2]=n,e[3]=o,e[4]=s,e[5]=a,this},t.prototype.setTransform=function(t){var e=this.matrix;e[0]=t[0],e[1]=t[1],e[2]=t[2],e[3]=t[3],e[4]=t[4],e[5]=t[5]},t.prototype.copyFrom=function(t){return this.matrix.set(t.matrix),this},t}();return uh.AffineTransformer=t,uh}function lh(){if(sh)return ah;sh=1,Object.defineProperty(ah,"__esModule",{value:!0}),ah.CanvasSurfaceContext=void 0;var t=function(){if(oh)return hh;oh=1,Object.defineProperty(hh,"__esModule",{value:!0}),hh.CanvasRenderingState=void 0;var t=ch(),e=function(e){e?(this.fillStyle=e.fillStyle,this.globalAlpha=e.globalAlpha,this.globalCompositeOperation=e.globalCompositeOperation,this.transformer=new t.AffineTransformer(e.transformer)):(this.fillStyle="#000000",this.globalAlpha=1,this.globalCompositeOperation="source-over",this.transformer=new t.AffineTransformer)};return hh.CanvasRenderingState=e,hh}(),e=function(){function e(e){this._stateStack=[],this._modifiedTransform=!1,this._context=e;var r=new t.CanvasRenderingState;this._contextFillStyle=r.fillStyle,this._contextGlobalAlpha=r.globalAlpha,this._contextGlobalCompositeOperation=r.globalCompositeOperation,this.pushState(r)}return Object.defineProperty(e.prototype,"fillStyle",{get:function(){return this.currentState().fillStyle},set:function(t){this.currentState().fillStyle=t},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"globalAlpha",{get:function(){return this.currentState().globalAlpha},set:function(t){this.currentState().globalAlpha=t},enumerable:!1,configurable:!0}),Object.defineProperty(e.prototype,"globalCompositeOperation",{get:function(){return this.currentState().globalCompositeOperation},set:function(t){this.currentState().globalCompositeOperation=t},enumerable:!1,configurable:!0}),e.prototype.getCanvasRenderingContext2D=function(){return this._context},e.prototype.clearRect=function(t,e,r,i){this.prerender(),this._context.clearRect(t,e,r,i)},e.prototype.save=function(){var e=new t.CanvasRenderingState(this.currentState());this.pushState(e)},e.prototype.restore=function(){this.popState()},e.prototype.scale=function(t,e){this.currentState().transformer.scale(t,e),this._modifiedTransform=!0},e.prototype.drawImage=function(t,e,r,i,n,o,s,a,h){this.prerender(),this._context.drawImage(t,e,r,i,n,o,s,a,h)},e.prototype.fillRect=function(t,e,r,i){this.prerender(),this._context.fillRect(t,e,r,i)},e.prototype.fillText=function(t,e,r,i){this.prerender(),this._context.fillText(t,e,r,i)},e.prototype.strokeText=function(t,e,r,i){this.prerender(),this._context.strokeText(t,e,r,i)},e.prototype.translate=function(t,e){this.currentState().transformer.translate(t,e),this._modifiedTransform=!0},e.prototype.transform=function(t,e,r,i,n,o){this.currentState().transformer.transform([t,e,r,i,n,o]),this._modifiedTransform=!0},e.prototype.setTransform=function(t,e,r,i,n,o){this.currentState().transformer.setTransform([t,e,r,i,n,o]),this._modifiedTransform=!0},e.prototype.setGlobalAlpha=function(t){this.currentState().globalAlpha=t},e.prototype.getImageData=function(t,e,r,i){return this._context.getImageData(t,e,r,i)},e.prototype.putImageData=function(t,e,r,i,n,o,s){this._context.putImageData(t,e,r,i,n,o,s)},e.prototype.prerender=function(){var t=this.currentState();if(t.fillStyle!==this._contextFillStyle&&(this._context.fillStyle=t.fillStyle,this._contextFillStyle=t.fillStyle),t.globalAlpha!==this._contextGlobalAlpha&&(this._context.globalAlpha=t.globalAlpha,this._contextGlobalAlpha=t.globalAlpha),t.globalCompositeOperation!==this._contextGlobalCompositeOperation&&(this._context.globalCompositeOperation=t.globalCompositeOperation,this._contextGlobalCompositeOperation=t.globalCompositeOperation),this._modifiedTransform){var e=t.transformer;this._context.setTransform(e.matrix[0],e.matrix[1],e.matrix[2],e.matrix[3],e.matrix[4],e.matrix[5]),this._modifiedTransform=!1}},e.prototype.pushState=function(t){this._stateStack.push(t)},e.prototype.popState=function(){this._stateStack.length<=1||(this._stateStack.pop(),this._modifiedTransform=!0,this._contextFillStyle=this._context.fillStyle,this._contextGlobalAlpha=this._context.globalAlpha,this._contextGlobalCompositeOperation=this._context.globalCompositeOperation)},e.prototype.currentState=function(){return this._stateStack[this._stateStack.length-1]},e}();return ah.CanvasSurfaceContext=e,ah}var dh,ph,fh,_h,yh={};function gh(){if(ph)return Qa;ph=1;var e=t&&t.__extends||function(){var t=function(e,r){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r])},t(e,r)};return function(e,r){if("function"!=typeof r&&null!==r)throw new TypeError("Class extends value "+String(r)+" is not a constructor or null");function i(){this.constructor=e}t(e,r),e.prototype=null===r?Object.create(r):(i.prototype=r.prototype,new i)}}();Object.defineProperty(Qa,"__esModule",{value:!0}),Qa.Context2DSurface=void 0;var r=ih(),i=lh(),n=function(){if(dh)return yh;dh=1,Object.defineProperty(yh,"__esModule",{value:!0}),yh.Context2DRenderer=void 0;var t={"source-over":"source-over","source-atop":"source-atop",lighter:"lighter",copy:"copy","experimental-source-in":"source-in","experimental-source-out":"source-out","experimental-destination-atop":"destination-atop","experimental-destination-in":"destination-in","destination-out":"destination-out","destination-over":"destination-over",xor:"xor",difference:"difference",saturation:"saturation"},e=function(){function e(t){this.surface=t,this.context=t.context(),this.canvasRenderingContext2D=this.context.getCanvasRenderingContext2D()}return e.prototype.begin=function(){this.canvasRenderingContext2D.save(),this.context.save()},e.prototype.end=function(){this.canvasRenderingContext2D.restore(),this.context.restore()},e.prototype.clear=function(){this.context.clearRect(0,0,this.surface.width,this.surface.height)},e.prototype.drawImage=function(t,e,r,i,n,o,s){this.context.drawImage(t._drawable,e,r,i,n,o,s,i,n)},e.prototype.drawSprites=function(t,e,r,i,n,o,s,a){for(var h=0;h<a;++h)this.drawImage(t,e[h],r[h],i[h],n[h],o[h],s[h])},e.prototype.translate=function(t,e){this.context.translate(t,e)},e.prototype.transform=function(t){this.context.transform(t[0],t[1],t[2],t[3],t[4],t[5])},e.prototype.opacity=function(t){this.context.globalAlpha*=t},e.prototype.save=function(){this.context.save()},e.prototype.restore=function(){this.context.restore()},e.prototype.fillRect=function(t,e,r,i,n){this.context.fillStyle=n,this.context.fillRect(t,e,r,i)},e.prototype.setCompositeOperation=function(e){this.context.globalCompositeOperation=t[e]||"source-over"},e.prototype.setOpacity=function(t){this.context.globalAlpha=t},e.prototype.setTransform=function(t){this.context.setTransform(t[0],t[1],t[2],t[3],t[4],t[5])},e.prototype.setShaderProgram=function(t){throw new Error("Context2DRenderer#setShaderProgram() is not implemented")},e.prototype.isSupportedShaderProgram=function(){return!1},e.prototype.getContext=function(){return this.context.getCanvasRenderingContext2D()},e.prototype.flush=function(){},e.prototype._getImageData=function(t,e,r,i){return this.context.getImageData(t,e,r,i)},e.prototype._putImageData=function(t,e,r,i,n,o,s){void 0===i&&(i=0),void 0===n&&(n=0),void 0===o&&(o=t.width),void 0===s&&(s=t.height),this.context.putImageData(t,e,r,i,n,o,s)},e}();return yh.Context2DRenderer=e,yh}(),o=function(t){function r(){return null!==t&&t.apply(this,arguments)||this}return e(r,t),r.prototype.context=function(){if(!this._context){var t=this.canvas.getContext("2d");if(!t)throw new Error("Context2DSurface#context(): could not initialize CanvasRenderingContext2D");this._context=new i.CanvasSurfaceContext(t)}return this._context},r.prototype.renderer=function(){return this._renderer||(this._renderer=new n.Context2DRenderer(this)),this._renderer},r.prototype.changePhysicalScale=function(t,e){if(!this._context)throw new Error("Context2DSurface#changePhysicalScale(): context has not been initialized");this.canvas.width=this.width*t,this.canvas.height=this.height*e,this._context.scale(t,e)},r.prototype.isPlaying=function(){return!1},r}(r.CanvasSurface);return Qa.Context2DSurface=o,Qa}function vh(){if(fh)return Za;fh=1;var e=t&&t.__extends||function(){var t=function(e,r){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r])},t(e,r)};return function(e,r){if("function"!=typeof r&&null!==r)throw new TypeError("Class extends value "+String(r)+" is not a constructor or null");function i(){this.constructor=e}t(e,r),e.prototype=null===r?Object.create(r):(i.prototype=r.prototype,new i)}}();Object.defineProperty(Za,"__esModule",{value:!0}),Za.SVGImageAsset=Za.SVGImageAssetSurface=void 0;var r=gh(),i=rh(),n=ga(),o=wa(),s=function(t){function r(){return null!==t&&t.apply(this,arguments)||this}return e(r,t),r.prototype.renderer=function(){throw new Error("SVGImageAssetSurface cannot be rendered.")},r.prototype.isPlaying=function(){return!1},r}(i.Surface);Za.SVGImageAssetSurface=s;var a=function(t){function i(e,r,i,n,o){var s=t.call(this,e,r)||this;return s.type="vector-image",s.width=i,s.height=n,s.hint=o,s.data=null,s._surface=null,s}return e(i,t),i.prototype.destroy=function(){this.data=null,this.hint=void 0,this._surface=null,t.prototype.destroy.call(this)},i.prototype._load=function(t){var e=this,r=new Image;this.hint&&this.hint.untainted&&(r.crossOrigin="anonymous"),r.onerror=function(){t._onAssetError(e,n.ExceptionFactory.createAssetLoadError("SVGImageAsset unknown loading error"))},r.onload=function(){e.data=r,t._onAssetLoad(e)},r.src=this.path},i.prototype.createSurface=function(t,e,i,n,o,a){void 0===i&&(i=0),void 0===n&&(n=0);var h=this,u=h.width,c=h.height,l=h.data;if(!l)throw new Error("SVGImageAsset#asSurface: not yet loaded.");this._surface||(this._surface=new s(u,c,l)),o||(o=u),a||(a=c);var d=new r.Context2DSurface(t,e),p=d.renderer();return p.save(),p.transform([t/o,0,0,e/a,0,0]),p.drawImage(this._surface,i,n,o,a,0,0),p.restore(),d},i}(o.Asset);return Za.SVGImageAsset=a,Za}var mh,Th={};var Ah,wh,Sh={},bh={};function Ph(){if(wh)return Sh;wh=1;var e=t&&t.__extends||function(){var t=function(e,r){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r])},t(e,r)};return function(e,r){if("function"!=typeof r&&null!==r)throw new TypeError("Class extends value "+String(r)+" is not a constructor or null");function i(){this.constructor=e}t(e,r),e.prototype=null===r?Object.create(r):(i.prototype=r.prototype,new i)}}();Object.defineProperty(Sh,"__esModule",{value:!0}),Sh.HTMLVideoAsset=void 0;var r=rh(),i=wa(),n=function(){if(Ah)return bh;Ah=1,Object.defineProperty(bh,"__esModule",{value:!0}),bh.HTMLVideoPlayer=void 0;var t=P,e=function(){function e(e){this._loop=!!e,this.onPlay=new t.Trigger,this.onStop=new t.Trigger,this.played=this.onPlay,this.stopped=this.onStop,this.currentVideo=void 0,this.volume=1,this.isDummy=!0}return e.prototype.play=function(t){},e.prototype.stop=function(){},e.prototype.changeVolume=function(t){},e}();return bh.HTMLVideoPlayer=e,bh}(),o=function(t){function r(e,r,i){return t.call(this,e,r,i)||this}return e(r,t),r.prototype.renderer=function(){throw new Error("VideoAssetSurface cannot be rendered.")},r.prototype.isPlaying=function(){return!1},r}(r.Surface),s=function(t){function r(e,r,i,s,a,h,u){var c=t.call(this,e,r)||this;return c.type="video",c.width=i,c.height=s,c.realWidth=0,c.realHeight=0,c._system=a,c._loop=h,c._useRealSize=u,c._player=new n.HTMLVideoPlayer,c._surface=new o(i,s),c}return e(r,t),r.prototype.play=function(t){return this.getPlayer().play(this),this.getPlayer()},r.prototype.stop=function(){this.getPlayer().stop()},r.prototype.inUse=function(){return!1},r.prototype._load=function(t){var e=this;setTimeout((function(){t._onAssetLoad(e)}),0)},r.prototype.getPlayer=function(){return this._player},r.prototype.asSurface=function(){return this._surface},r}(i.Asset);return Sh.HTMLVideoAsset=s,Sh}var xh,Eh={};var Oh,kh={};var Mh,Lh={},Rh={};function Ch(){return Mh||(Mh=1,Object.defineProperty(Rh,"__esModule",{value:!0}),Rh.RenderingHelper=void 0,function(t){t.toPowerOfTwo=function(t){if(0!=(t&t-1)){for(var e=1;e<t;)e*=2;return e}return t},t.clamp=function(t){return Math.min(Math.max(t,0),1)},t.usedWebGL=function(t){var e;if(!t||0===t.length)return!1;var r=t[0];if("string"==typeof r){if("webgl"===r)return{type:"webgl",options:{enableDepthBuffer:!1}}}else if("webgl"===r.type){return{type:"webgl",options:{enableDepthBuffer:!!(null===(e=r.options)||void 0===e?void 0:e.enableDepthBuffer)}}}return!1}}(t||(Rh.RenderingHelper=t={}))),Rh;var t}var Ih,Fh={},Dh={},jh={},Gh={},Uh={};var Bh,Hh,Nh,Wh={};function Vh(){if(Bh)return Wh;Bh=1,Object.defineProperty(Wh,"__esModule",{value:!0}),Wh.WebGLRenderingState=void 0;var t=ch(),e=function(){function e(e){e?(this.globalAlpha=e.globalAlpha,this.globalCompositeOperation=e.globalCompositeOperation,this.transformer=new t.AffineTransformer(e.transformer),this.shaderProgram=e.shaderProgram):(this.globalAlpha=1,this.globalCompositeOperation="source-over",this.transformer=new t.AffineTransformer,this.shaderProgram=null)}return e.prototype.copyFrom=function(t){return this.globalAlpha=t.globalAlpha,this.globalCompositeOperation=t.globalCompositeOperation,this.transformer.copyFrom(t.transformer),this.shaderProgram=t.shaderProgram,this},e}();return Wh.WebGLRenderingState=e,Wh}function Xh(){if(Hh)return Gh;Hh=1,Object.defineProperty(Gh,"__esModule",{value:!0}),Gh.WebGLRenderer=void 0;var t=function(){if(Ih)return Uh;Ih=1,Object.defineProperty(Uh,"__esModule",{value:!0}),Uh.WebGLColor=void 0;var t,e=Ch();return function(t){t.colorMap={ALICEBLUE:[240/255,248/255,1,1],ANTIQUEWHITE:[250/255,235/255,215/255,1],AQUA:[0,1,1,1],AQUAMARINE:[127/255,1,212/255,1],AZURE:[240/255,1,1,1],BEIGE:[245/255,245/255,220/255,1],BISQUE:[1,228/255,196/255,1],BLACK:[0,0,0,1],BLANCHEDALMOND:[1,235/255,205/255,1],BLUE:[0,0,1,1],BLUEVIOLET:[138/255,43/255,226/255,1],BROWN:[165/255,42/255,42/255,1],BURLYWOOD:[222/255,184/255,135/255,1],CADETBLUE:[95/255,158/255,160/255,1],CHARTREUSE:[127/255,1,0,1],CHOCOLATE:[210/255,105/255,30/255,1],CORAL:[1,127/255,80/255,1],CORNFLOWERBLUE:[100/255,149/255,237/255,1],CORNSILK:[1,248/255,220/255,1],CRIMSON:[220/255,20/255,60/255,1],CYAN:[0,1,1,1],DARKBLUE:[0,0,139/255,1],DARKCYAN:[0,139/255,139/255,1],DARKGOLDENROD:[184/255,134/255,11/255,1],DARKGRAY:[169/255,169/255,169/255,1],DARKGREEN:[0,100/255,0,1],DARKGREY:[169/255,169/255,169/255,1],DARKKHAKI:[189/255,183/255,107/255,1],DARKMAGENTA:[139/255,0,139/255,1],DARKOLIVEGREEN:[85/255,107/255,47/255,1],DARKORANGE:[1,140/255,0,1],DARKORCHID:[.6,50/255,.8,1],DARKRED:[139/255,0,0,1],DARKSALMON:[233/255,150/255,122/255,1],DARKSEAGREEN:[143/255,188/255,143/255,1],DARKSLATEBLUE:[72/255,61/255,139/255,1],DARKSLATEGRAY:[47/255,79/255,79/255,1],DARKSLATEGREY:[47/255,79/255,79/255,1],DARKTURQUOISE:[0,206/255,209/255,1],DARKVIOLET:[148/255,0,211/255,1],DEEPPINK:[1,20/255,147/255,1],DEEPSKYBLUE:[0,191/255,1,1],DIMGRAY:[105/255,105/255,105/255,1],DIMGREY:[105/255,105/255,105/255,1],DODGERBLUE:[30/255,144/255,1,1],FIREBRICK:[178/255,34/255,34/255,1],FLORALWHITE:[1,250/255,240/255,1],FORESTGREEN:[34/255,139/255,34/255,1],FUCHSIA:[1,0,1,1],GAINSBORO:[220/255,220/255,220/255,1],GHOSTWHITE:[248/255,248/255,1,1],GOLD:[1,215/255,0,1],GOLDENROD:[218/255,165/255,32/255,1],GRAY:[128/255,128/255,128/255,1],GREEN:[0,128/255,0,1],GREENYELLOW:[173/255,1,47/255,1],GREY:[128/255,128/255,128/255,1],HONEYDEW:[240/255,1,240/255,1],HOTPINK:[1,105/255,180/255,1],INDIANRED:[205/255,92/255,92/255,1],INDIGO:[75/255,0,130/255,1],IVORY:[1,1,240/255,1],KHAKI:[240/255,230/255,140/255,1],LAVENDER:[230/255,230/255,250/255,1],LAVENDERBLUSH:[1,240/255,245/255,1],LAWNGREEN:[124/255,252/255,0,1],LEMONCHIFFON:[1,250/255,205/255,1],LIGHTBLUE:[173/255,216/255,230/255,1],LIGHTCORAL:[240/255,128/255,128/255,1],LIGHTCYAN:[224/255,1,1,1],LIGHTGOLDENRODYELLOW:[250/255,250/255,210/255,1],LIGHTGRAY:[211/255,211/255,211/255,1],LIGHTGREEN:[144/255,238/255,144/255,1],LIGHTGREY:[211/255,211/255,211/255,1],LIGHTPINK:[1,182/255,193/255,1],LIGHTSALMON:[1,160/255,122/255,1],LIGHTSEAGREEN:[32/255,178/255,170/255,1],LIGHTSKYBLUE:[135/255,206/255,250/255,1],LIGHTSLATEGRAY:[119/255,136/255,.6,1],LIGHTSLATEGREY:[119/255,136/255,.6,1],LIGHTSTEELBLUE:[176/255,196/255,222/255,1],LIGHTYELLOW:[1,1,224/255,1],LIME:[0,1,0,1],LIMEGREEN:[50/255,205/255,50/255,1],LINEN:[250/255,240/255,230/255,1],MAGENTA:[1,0,1,1],MAROON:[128/255,0,0,1],MEDIUMAQUAMARINE:[.4,205/255,170/255,1],MEDIUMBLUE:[0,0,205/255,1],MEDIUMORCHID:[186/255,85/255,211/255,1],MEDIUMPURPLE:[147/255,112/255,219/255,1],MEDIUMSEAGREEN:[60/255,179/255,113/255,1],MEDIUMSLATEBLUE:[123/255,104/255,238/255,1],MEDIUMSPRINGGREEN:[0,250/255,154/255,1],MEDIUMTURQUOISE:[72/255,209/255,.8,1],MEDIUMVIOLETRED:[199/255,21/255,133/255,1],MIDNIGHTBLUE:[25/255,25/255,112/255,1],MINTCREAM:[245/255,1,250/255,1],MISTYROSE:[1,228/255,225/255,1],MOCCASIN:[1,228/255,181/255,1],NAVAJOWHITE:[1,222/255,173/255,1],NAVY:[0,0,128/255,1],OLDLACE:[253/255,245/255,230/255,1],OLIVE:[128/255,128/255,0,1],OLIVEDRAB:[107/255,142/255,35/255,1],ORANGE:[1,165/255,0,1],ORANGERED:[1,69/255,0,1],ORCHID:[218/255,112/255,214/255,1],PALEGOLDENROD:[238/255,232/255,170/255,1],PALEGREEN:[152/255,251/255,152/255,1],PALETURQUOISE:[175/255,238/255,238/255,1],PALEVIOLETRED:[219/255,112/255,147/255,1],PAPAYAWHIP:[1,239/255,213/255,1],PEACHPUFF:[1,218/255,185/255,1],PERU:[205/255,133/255,63/255,1],PINK:[1,192/255,203/255,1],PLUM:[221/255,160/255,221/255,1],POWDERBLUE:[176/255,224/255,230/255,1],PURPLE:[128/255,0,128/255,1],RED:[1,0,0,1],ROSYBROWN:[188/255,143/255,143/255,1],ROYALBLUE:[65/255,105/255,225/255,1],SADDLEBROWN:[139/255,69/255,19/255,1],SALMON:[250/255,128/255,114/255,1],SANDYBROWN:[244/255,164/255,96/255,1],SEAGREEN:[46/255,139/255,87/255,1],SEASHELL:[1,245/255,238/255,1],SIENNA:[160/255,82/255,45/255,1],SILVER:[192/255,192/255,192/255,1],SKYBLUE:[135/255,206/255,235/255,1],SLATEBLUE:[106/255,90/255,205/255,1],SLATEGRAY:[112/255,128/255,144/255,1],SLATEGREY:[112/255,128/255,144/255,1],SNOW:[1,250/255,250/255,1],SPRINGGREEN:[0,1,127/255,1],STEELBLUE:[70/255,130/255,180/255,1],TAN:[210/255,180/255,140/255,1],TEAL:[0,128/255,128/255,1],THISTLE:[216/255,191/255,216/255,1],TOMATO:[1,99/255,71/255,1],TURQUOISE:[64/255,224/255,208/255,1],VIOLET:[238/255,130/255,238/255,1],WHEAT:[245/255,222/255,179/255,1],WHITE:[1,1,1,1],WHITESMOKE:[245/255,245/255,245/255,1],YELLOW:[1,1,0,1],YELLOWGREEN:[154/255,205/255,50/255,1]},t.get=function(r){var i="string"==typeof r?t._toColor(r):[r[0],r[1],r[2],r[3]];return i[3]=e.RenderingHelper.clamp(i[3]),i[0]=e.RenderingHelper.clamp(i[0])*i[3],i[1]=e.RenderingHelper.clamp(i[1])*i[3],i[2]=e.RenderingHelper.clamp(i[2])*i[3],i},t._hsl2rgb=function(t){var e=t[0]%360,r=t[1],i=t[2]>50?100-t[2]:t[2],n=t[3],o=i+i*r,s=i-i*r;return e<60?[o,e/60*(o-s)+s,s,n]:e<120?[(120-e)/60*(o-s)+s,o,s,n]:e<180?[s,o,(e-120)/60*(o-s)+s,n]:e<240?[s,(240-e)/60*(o-s)+s,o,n]:e<300?[(e-240)/60*(o-s)+s,s,o,n]:[o,s,(360-e)/60*(o-s)+s,n]},t._toColor=function(r){var i=r.toUpperCase().replace(/\s+/g,""),n=t.colorMap[i];if(n)return n;if(i.match(/^#([\dA-F])([\dA-F])([\dA-F])$/))return[parseInt(RegExp.$1,16)/15,parseInt(RegExp.$2,16)/15,parseInt(RegExp.$3,16)/15,1];if(i.match(/^#([\dA-F]{2})([\dA-F]{2})([\dA-F]{2})$/))return[parseInt(RegExp.$1,16)/255,parseInt(RegExp.$2,16)/255,parseInt(RegExp.$3,16)/255,1];if(i.match(/^RGB\((\d{1,3}),(\d{1,3}),(\d{1,3})\)$/))return[parseInt(RegExp.$1,10)/255,parseInt(RegExp.$2,10)/255,parseInt(RegExp.$3,10)/255,1];if(i.match(/^RGBA\((\d{1,3}),(\d{1,3}),(\d{1,3}),(\d(\.\d*)?)\)$/))return[parseInt(RegExp.$1,10)/255,parseInt(RegExp.$2,10)/255,parseInt(RegExp.$3,10)/255,parseFloat(RegExp.$4)];if(i.match(/^HSL\((\d{1,3}),(\d{1,3})%,(\d{1,3})%\)$/))return t._hsl2rgb([parseInt(RegExp.$1,10),e.RenderingHelper.clamp(parseInt(RegExp.$2,10)/100),e.RenderingHelper.clamp(parseInt(RegExp.$3,10)/100),1]);if(i.match(/^HSLA\((\d{1,3}),(\d{1,3})%,(\d{1,3})%,(\d(\.\d*)?)\)$/))return t._hsl2rgb([parseInt(RegExp.$1,10),e.RenderingHelper.clamp(parseInt(RegExp.$2,10)/100),e.RenderingHelper.clamp(parseInt(RegExp.$3,10)/100),parseFloat(RegExp.$4)]);throw Error("illigal cssColor format: "+i)}}(t||(Uh.WebGLColor=t={})),Uh}(),e=Vh(),r=function(){function r(t,e){this._stateStack=[],this._stateStackPointer=0,this._capacity=0,this._reallocation(r.DEFAULT_CAPACITY),this._whiteColor=[1,1,1,1],this._shared=t,this._renderTarget=e}return r.prototype.clear=function(){this._shared.clear()},r.prototype.begin=function(){},r.prototype.end=function(){this._shared.end()},r.prototype.save=function(){this._pushState()},r.prototype.restore=function(){this._popState()},r.prototype.translate=function(t,e){this.currentState().transformer.translate(t,e)},r.prototype.transform=function(t){this.currentState().transformer.transform(t)},r.prototype.opacity=function(t){this.currentState().globalAlpha*=t},r.prototype.setCompositeOperation=function(t){this.currentState().globalCompositeOperation=t},r.prototype.currentState=function(){return this._stateStack[this._stateStackPointer]},r.prototype.fillRect=function(e,r,i,n,o){this._shared.draw(this.currentState(),this._shared.getFillRectSurfaceTexture(),0,0,i,n,e,r,t.WebGLColor.get(o))},r.prototype.drawSprites=function(t,e,r,i,n,o,s,a){for(var h=0;h<a;++h)this.drawImage(t,e[h],r[h],i[h],n[h],o[h],s[h])},r.prototype.drawImage=function(t,e,r,i,n,o,s){if(!t._drawable)throw new Error("WebGLRenderer#drawImage: no drawable surface.");if(t._drawable.texture instanceof WebGLTexture||this._shared.makeTextureForSurface(t),!t._drawable.texture)throw new Error("WebGLRenderer#drawImage: could not create a texture.");this._shared.draw(this.currentState(),t._drawable,e,r,i,n,o,s,this._whiteColor)},r.prototype.setTransform=function(t){this.currentState().transformer.setTransform(t)},r.prototype.setOpacity=function(t){this.currentState().globalAlpha=t},r.prototype.setShaderProgram=function(t){this.currentState().shaderProgram=this._shared.initializeShaderProgram(t)},r.prototype.isSupportedShaderProgram=function(){return!0},r.prototype.changeViewportSize=function(t,e){var r=this._renderTarget;this._renderTarget={width:r.width,height:r.height,viewportWidth:t,viewportHeight:e,texture:r.texture,framebuffer:r.framebuffer}},r.prototype.getContext=function(){return this._shared.getContext()},r.prototype.flush=function(){return this._shared.flush()},r.prototype.destroy=function(){this._shared.requestDeleteRenderTarget(this._renderTarget),this._shared=void 0,this._renderTarget=void 0,this._whiteColor=void 0},r.prototype._getImageData=function(){throw new Error("WebGLRenderer#_getImageData() is not implemented")},r.prototype._putImageData=function(t,e,r,i,n,o,s){throw new Error("WebGLRenderer#_putImageData() is not implemented")},r.prototype._pushState=function(){var t=this.currentState();++this._stateStackPointer,this._isOverCapacity()&&this._reallocation(this._stateStackPointer+1),this.currentState().copyFrom(t)},r.prototype._popState=function(){if(!(this._stateStackPointer>0))throw new Error("WebGLRenderer#restore: state stack under-flow.");this.currentState().shaderProgram=null,--this._stateStackPointer},r.prototype._isOverCapacity=function(){return this._capacity<=this._stateStackPointer},r.prototype._reallocation=function(t){var r=this._capacity;if(r<t){t<2*r?this._capacity*=2:this._capacity=t;for(var i=r;i<this._capacity;++i)this._stateStack.push(new e.WebGLRenderingState)}},r.DEFAULT_CAPACITY=16,r}();return Gh.WebGLRenderer=r,Gh}var zh,qh,Yh,Kh={},$h={};function Jh(){if(qh)return Kh;qh=1;var e=t&&t.__extends||function(){var t=function(e,r){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r])},t(e,r)};return function(e,r){if("function"!=typeof r&&null!==r)throw new TypeError("Class extends value "+String(r)+" is not a constructor or null");function i(){this.constructor=e}t(e,r),e.prototype=null===r?Object.create(r):(i.prototype=r.prototype,new i)}}();Object.defineProperty(Kh,"__esModule",{value:!0}),Kh.WebGLPrimarySurface=void 0;var r=ih(),i=function(){if(zh)return $h;zh=1;var e=t&&t.__extends||function(){var t=function(e,r){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r])},t(e,r)};return function(e,r){if("function"!=typeof r&&null!==r)throw new TypeError("Class extends value "+String(r)+" is not a constructor or null");function i(){this.constructor=e}t(e,r),e.prototype=null===r?Object.create(r):(i.prototype=r.prototype,new i)}}();Object.defineProperty($h,"__esModule",{value:!0}),$h.WebGLPrimarySurfaceRenderer=void 0;var r=function(t){function r(e,r){var i=t.call(this,e,r)||this;return i._shared.pushRenderTarget(i._renderTarget),i}return e(r,t),r.prototype.begin=function(){t.prototype.begin.call(this),this._shared.begin()},r}(Xh().WebGLRenderer);return $h.WebGLPrimarySurfaceRenderer=r,$h}(),n=function(t){function r(e,r,i){var n=t.call(this,r,i)||this;return n.canvas.style.position="absolute",n._shared=e,n}return e(r,t),r.prototype.renderer=function(){return this._renderer||(this._renderer=new i.WebGLPrimarySurfaceRenderer(this._shared,this._shared.getPrimaryRenderTarget(this.width,this.height))),this._renderer},r.prototype.changePhysicalScale=function(t,e){var r=Math.ceil(this.width*t),i=Math.ceil(this.height*e);this.canvas.width=r,this.canvas.height=i,this.renderer().changeViewportSize(r,i)},r.prototype.isPlaying=function(){return!1},r}(r.CanvasSurface);return Kh.WebGLPrimarySurface=n,Kh}function Zh(){if(Yh)return Dh;Yh=1;var e=t&&t.__extends||function(){var t=function(e,r){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r])},t(e,r)};return function(e,r){if("function"!=typeof r&&null!==r)throw new TypeError("Class extends value "+String(r)+" is not a constructor or null");function i(){this.constructor=e}t(e,r),e.prototype=null===r?Object.create(r):(i.prototype=r.prototype,new i)}}();Object.defineProperty(Dh,"__esModule",{value:!0}),Dh.WebGLBackSurface=void 0;var r=function(){if(Nh)return jh;Nh=1;var e=t&&t.__extends||function(){var t=function(e,r){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r])},t(e,r)};return function(e,r){if("function"!=typeof r&&null!==r)throw new TypeError("Class extends value "+String(r)+" is not a constructor or null");function i(){this.constructor=e}t(e,r),e.prototype=null===r?Object.create(r):(i.prototype=r.prototype,new i)}}();Object.defineProperty(jh,"__esModule",{value:!0}),jh.WebGLBackSurfaceRenderer=void 0;var r=Xh(),i=Vh(),n=function(t){function r(e,r){var i=t.call(this,r,r.createRenderTarget(e.width,e.height))||this;return e._drawable={texture:i._renderTarget.texture,textureOffsetX:0,textureOffsetY:0,textureWidth:e.width,textureHeight:e.height},i}return e(r,t),r.prototype.begin=function(){t.prototype.begin.call(this),this.save();var e=new i.WebGLRenderingState(this.currentState()),r=e.transformer.matrix;r[1]*=-1,r[3]*=-1,r[5]=-r[5]+this._renderTarget.height,this.currentState().copyFrom(e),this._shared.pushRenderTarget(this._renderTarget)},r.prototype.end=function(){this.restore(),this._shared.popRenderTarget(),t.prototype.end.call(this)},r}(r.WebGLRenderer);return jh.WebGLBackSurfaceRenderer=n,jh}(),i=function(t){function i(){return null!==t&&t.apply(this,arguments)||this}return e(i,t),i.prototype.renderer=function(){return this._renderer||(this._renderer=new r.WebGLBackSurfaceRenderer(this,this._shared)),this._renderer},i.prototype.destroy=function(){this._renderer&&this._renderer.destroy(),this._renderer=void 0,this._drawable=void 0,t.prototype.destroy.call(this)},i}(Jh().WebGLPrimarySurface);return Dh.WebGLBackSurface=i,Dh}var Qh,tu={};var eu,ru,iu,nu={},ou={};function su(){if(ru)return nu;ru=1,Object.defineProperty(nu,"__esModule",{value:!0}),nu.WebGLTextureAtlas=void 0;var t=Ch(),e=function(){if(eu)return ou;eu=1,Object.defineProperty(ou,"__esModule",{value:!0}),ou.WebGLTextureMap=void 0;var t=function(){function t(t,e,r,i,n){this._left=null,this._right=null,this._surface=null,this.texture=t,this.offsetX=e,this.offsetY=r,this._width=i,this._height=n}return t.prototype.dispose=function(){this._left&&(this._left.dispose(),this._left=null),this._right&&(this._right.dispose(),this._right=null),this._surface&&(this._surface._drawable&&(this._surface._drawable.texture=null),this._surface=null)},t.prototype.capacity=function(){return this._width*this._height},t.prototype.area=function(){if(!this._surface)return 0;var t=this._surface._drawable,e=t.width*t.height;return this._left&&(e+=this._left.area()),this._right&&(e+=this._right.area()),e},t.prototype.occupancy=function(){return this.area()/this.capacity()},t.prototype.insert=function(e){var r=e._drawable,i=r.width+t.TEXTURE_MARGIN,n=r.height+t.TEXTURE_MARGIN;if(this._surface){if(this._left){var o=this._left.insert(e);if(o)return o}if(this._right){var s=this._right.insert(e);if(s)return s}return null}if(this._width<i||this._height<n)return null;var a=this._width-i,h=this._height-n;return a<=h?(this._left=new t(this.texture,this.offsetX+i,this.offsetY,a,n),this._right=new t(this.texture,this.offsetX,this.offsetY+n,this._width,h)):(this._left=new t(this.texture,this.offsetX,this.offsetY+n,i,h),this._right=new t(this.texture,this.offsetX+i,this.offsetY,a,this._height)),this._surface=e,this},t.TEXTURE_MARGIN=1,t}();return ou.WebGLTextureMap=t,ou}(),r=function(){function r(){this._maps=[],this._insertPos=0,this.emptyTexturePixels=new Uint8Array(r.TEXTURE_SIZE*r.TEXTURE_SIZE*4)}return r.prototype.clear=function(){for(var t=0;t<this._maps.length;++t)this._maps[t].dispose()},r.prototype.showOccupancy=function(){for(var t=0;t<this._maps.length;++t)console.log("occupancy["+t+"]: "+this._maps[t].occupancy())},r.prototype.makeTextureForSurface=function(e,i){var n=i._drawable;if(n&&!n.texture){var o=n.width,s=n.height;if(o>=r.TEXTURE_SIZE||s>=r.TEXTURE_SIZE){var a=t.RenderingHelper.toPowerOfTwo(n.width),h=t.RenderingHelper.toPowerOfTwo(n.height);if(a!==n.width||h!==n.height){var u=document.createElement("canvas");u.width=a,u.height=h;var c=u.getContext("2d");if(!c)throw new Error("WebGLTextureAtlas#makeTextureForSurface(): could not initialize CanvasRenderingContext2D");c.globalCompositeOperation="copy",c.drawImage(n,0,0),n=c.getImageData(0,0,a,h)}return i._drawable.texture=e.makeTexture(n),i._drawable.textureOffsetX=0,i._drawable.textureOffsetY=0,i._drawable.textureWidth=a,void(i._drawable.textureHeight=h)}this._assign(e,i,this._maps)}},r.prototype._assign=function(t,i,n){for(var o=null,s=0;s<n.length;++s)if(o=n[(s+this._insertPos)%n.length].insert(i))return this._register(t,o,i._drawable),void(this._insertPos=s);o=null,n.length>=r.TEXTURE_COUNT&&(o=n.shift(),t.disposeTexture(o.texture),o.dispose(),t.clearTexture(this.emptyTexturePixels,r.TEXTURE_SIZE,r.TEXTURE_SIZE,o.texture)),o||(o=new e.WebGLTextureMap(t.makeTextureRaw(r.TEXTURE_SIZE,r.TEXTURE_SIZE),0,0,r.TEXTURE_SIZE,r.TEXTURE_SIZE)),n.push(o),o=o.insert(i),this._register(t,o,i._drawable)},r.prototype._register=function(t,e,i){i.texture=e.texture,i.textureOffsetX=e.offsetX,i.textureOffsetY=e.offsetY,i.textureWidth=r.TEXTURE_SIZE,i.textureHeight=r.TEXTURE_SIZE,t.assignTexture(i,e.offsetX,e.offsetY,e.texture)},r.TEXTURE_SIZE=1024,r.TEXTURE_COUNT=16,r}();return nu.WebGLTextureAtlas=r,nu}function au(){if(iu)return Fh;iu=1,Object.defineProperty(Fh,"__esModule",{value:!0}),Fh.WebGLSharedObject=void 0;var t=Zh(),e=Jh(),r=function(){if(Qh)return tu;Qh=1,Object.defineProperty(tu,"__esModule",{value:!0}),tu.WebGLShaderProgram=void 0;var t=function(){function t(e,r,i){void 0===i&&(i=Object.create(null));var n=t._DEFAULT_VERTEX_SHADER;r=r||t._DEFAULT_FRAGMENT_SHADER;var o=t._makeShaderProgram(e,n,r);this.program=o,this._context=e,this._aVertex=e.getAttribLocation(this.program,"aVertex");var s=e.getUniformLocation(this.program,"uColor");if(!s)throw new Error("WebGLShaderProgram#constructor: could not get UniformLocation of 'uColor'");var a=e.getUniformLocation(this.program,"uAlpha");if(!a)throw new Error("WebGLShaderProgram#constructor: could not get UniformLocation of 'uAlpha'");var h=e.getUniformLocation(this.program,"uSampler");if(!h)throw new Error("WebGLShaderProgram#constructor: could not get UniformLocation of 'uSampler'");this._uColor=s,this._uAlpha=a,this._uSampler=h,this._uniforms=i,this._uniformCaches=[],this._uniformSetterTable={float:this._uniform1f.bind(this),int:this._uniform1i.bind(this),float_v:this._uniform1fv.bind(this),int_v:this._uniform1iv.bind(this),vec2:this._uniform2fv.bind(this),vec3:this._uniform3fv.bind(this),vec4:this._uniform4fv.bind(this),ivec2:this._uniform2iv.bind(this),ivec3:this._uniform3iv.bind(this),ivec4:this._uniform4iv.bind(this),mat2:this._uniformMatrix2fv.bind(this),mat3:this._uniformMatrix3fv.bind(this),mat4:this._uniformMatrix4fv.bind(this)}}return t._makeShader=function(t,e,r){var i=t.createShader(e);if(!i)throw new Error("WebGLShaderProgram._makeShader(): WebGLShader could not initialize");if(t.shaderSource(i,r),t.compileShader(i),!t.getShaderParameter(i,t.COMPILE_STATUS)){var n=t.getShaderInfoLog(i);throw t.deleteShader(i),new Error(null!=n?n:"WebGLShaderProgram._makeShader(): unknown gl error")}return i},t._makeShaderProgram=function(e,r,i){var n=e.createProgram();if(!n)throw new Error("WebGLShaderProgram._makeShaderProgram(): WebGLProgram could not initialize");var o=t._makeShader(e,e.VERTEX_SHADER,r);e.attachShader(n,o),e.deleteShader(o);var s=t._makeShader(e,e.FRAGMENT_SHADER,i);if(e.attachShader(n,s),e.deleteShader(s),e.linkProgram(n),!e.getProgramParameter(n,e.LINK_STATUS)){var a=e.getProgramInfoLog(n);throw e.deleteProgram(n),new Error(null!=a?a:"WebGLShaderProgram._makeShaderProgram(): unknown gl error")}return n},t.prototype.set_aVertex=function(t){this._context.bindBuffer(this._context.ARRAY_BUFFER,t),this._context.enableVertexAttribArray(this._aVertex),this._context.vertexAttribPointer(this._aVertex,4,this._context.FLOAT,!1,0,0)},t.prototype.set_uColor=function(t){this._context.uniform4f(this._uColor,t[0],t[1],t[2],t[3])},t.prototype.set_uAlpha=function(t){this._context.uniform1f(this._uAlpha,t)},t.prototype.set_uSampler=function(t){this._context.uniform1i(this._uSampler,t)},t.prototype.updateUniforms=function(){for(var t=0;t<this._uniformCaches.length;++t){var e=this._uniformCaches[t],r=this._uniforms[e.name].value;(e.isArray||r!==e.beforeValue)&&(e.update(e.loc,r),e.beforeValue=r)}},t.prototype.initializeUniforms=function(){var t=this,e=[],r=this._uniforms;null!=r&&Object.keys(r).forEach((function(i){var n=r[i].type,o=!("number"==typeof r[i].value);!o||"int"!==n&&"float"!==n||(n+="_v");var s=t._uniformSetterTable[n];if(!s)throw new Error("WebGLShaderProgram#initializeUniforms: Uniform type '".concat(n,"' is not supported."));var a=t._context.getUniformLocation(t.program,i);if(!a)throw new Error("WebGLShaderProgram#initializeUniforms: could not get UniformLocation of '".concat(i,"'."));e.push({name:i,update:s,beforeValue:null,isArray:o,loc:a})})),this._uniformCaches=e},t.prototype.use=function(){this._context.useProgram(this.program)},t.prototype.unuse=function(){this._context.useProgram(null)},t.prototype.destroy=function(){this._context.deleteProgram(this.program)},t.prototype._uniform1f=function(t,e){this._context.uniform1f(t,e)},t.prototype._uniform1i=function(t,e){this._context.uniform1i(t,e)},t.prototype._uniform1fv=function(t,e){this._context.uniform1fv(t,e)},t.prototype._uniform1iv=function(t,e){this._context.uniform1iv(t,e)},t.prototype._uniform2fv=function(t,e){this._context.uniform2fv(t,e)},t.prototype._uniform3fv=function(t,e){this._context.uniform3fv(t,e)},t.prototype._uniform4fv=function(t,e){this._context.uniform4fv(t,e)},t.prototype._uniform2iv=function(t,e){this._context.uniform2iv(t,e)},t.prototype._uniform3iv=function(t,e){this._context.uniform3iv(t,e)},t.prototype._uniform4iv=function(t,e){this._context.uniform4iv(t,e)},t.prototype._uniformMatrix2fv=function(t,e){this._context.uniformMatrix2fv(t,!1,e)},t.prototype._uniformMatrix3fv=function(t,e){this._context.uniformMatrix3fv(t,!1,e)},t.prototype._uniformMatrix4fv=function(t,e){this._context.uniformMatrix4fv(t,!1,e)},t._DEFAULT_VERTEX_SHADER="#version 100\nprecision mediump float;\nattribute vec4 aVertex;\nvarying vec2 vTexCoord;\nvarying vec4 vColor;\nuniform vec4 uColor;\nuniform float uAlpha;\nvoid main() {    gl_Position = vec4(aVertex.xy, 0.0, 1.0);    vTexCoord = aVertex.zw;    vColor = uColor * uAlpha;}",t._DEFAULT_FRAGMENT_SHADER="#version 100\nprecision mediump float;\nvarying vec2 vTexCoord;\nvarying vec4 vColor;\nuniform sampler2D uSampler;\nvoid main() {    gl_FragColor = texture2D(uSampler, vTexCoord) * vColor;}",t}();return tu.WebGLShaderProgram=t,tu}(),i=su(),n=function(){function n(t){this._renderTarget=void 0,this._defaultShaderProgram=void 0,this._textureAtlas=void 0,this._fillRectTexture=void 0,this._fillRectSurfaceTexture=void 0,this._maxSpriteCount=void 0,this._vertices=void 0,this._verticesCache=void 0,this._numSprites=void 0,this._renderTargetStack=void 0,this._currentTexture=void 0,this._currentColor=void 0,this._currentAlpha=void 0,this._currentCompositeOperation=void 0,this._currentShaderProgram=void 0,this._compositeOps=void 0,this._deleteRequestedTargets=void 0;var r=t.width,i=t.height,n=!!t.enableDepthBuffer,o=new e.WebGLPrimarySurface(this,r,i),s=o.canvas.getContext("webgl",{depth:n,preserveDrawingBuffer:!0});if(!s)throw new Error("WebGLSharedObject#constructor: could not initialize WebGLRenderingContext");this._enableDepthBuffer=n,this._surface=o,this._context=s,this._init()}return n.prototype.getFillRectSurfaceTexture=function(){return this._fillRectSurfaceTexture},n.prototype.getPrimarySurface=function(){return this._surface},n.prototype.createBackSurface=function(e,r){return new t.WebGLBackSurface(this,e,r)},n.prototype.pushRenderTarget=function(t){this._commit(),this._renderTargetStack.push(t),this._context.bindFramebuffer(this._context.FRAMEBUFFER,t.framebuffer),this._context.viewport(0,0,t.viewportWidth,t.viewportHeight)},n.prototype.popRenderTarget=function(){this._commit(),this._renderTargetStack.pop();var t=this.getCurrentRenderTarget();this._context.bindFramebuffer(this._context.FRAMEBUFFER,t.framebuffer),this._context.viewport(0,0,t.viewportWidth,t.viewportHeight)},n.prototype.getCurrentRenderTarget=function(){return this._renderTargetStack[this._renderTargetStack.length-1]},n.prototype.begin=function(){this.clear(),this._currentShaderProgram.use(),this._currentShaderProgram.set_aVertex(this._vertices),this._currentShaderProgram.set_uColor(this._currentColor),this._currentShaderProgram.set_uAlpha(this._currentAlpha),this._currentShaderProgram.set_uSampler(0),this._currentShaderProgram.updateUniforms()},n.prototype.clear=function(){if(this._enableDepthBuffer)return this._context.depthMask(!0),this._context.clear(this._context.COLOR_BUFFER_BIT|this._context.DEPTH_BUFFER_BIT),void this._context.depthMask(!1);this._context.clear(this._context.COLOR_BUFFER_BIT)},n.prototype.draw=function(t,e,r,i,n,o,s,a,h){var u;if(this._numSprites>=this._maxSpriteCount&&this._commit(),u=e===this._fillRectSurfaceTexture||null==t.shaderProgram||null==t.shaderProgram._program?this._defaultShaderProgram:t.shaderProgram._program,this._currentShaderProgram!==u&&(this._commit(),this._currentShaderProgram=u,this._currentShaderProgram.use(),this._currentShaderProgram.updateUniforms(),this._currentCompositeOperation=null,this._currentAlpha=null,this._currentColor=[],this._currentTexture=null),this._currentTexture!==e.texture&&(this._currentTexture=e.texture,this._commit(),this._context.bindTexture(this._context.TEXTURE_2D,e.texture)),this._currentColor[0]===h[0]&&this._currentColor[1]===h[1]&&this._currentColor[2]===h[2]&&this._currentColor[3]===h[3]||(this._currentColor=h,this._commit(),this._currentShaderProgram.set_uColor(h)),this._currentAlpha!==t.globalAlpha&&(this._currentAlpha=t.globalAlpha,this._commit(),this._currentShaderProgram.set_uAlpha(t.globalAlpha)),this._currentCompositeOperation!==t.globalCompositeOperation){this._currentCompositeOperation=t.globalCompositeOperation,this._commit();var c=this._compositeOps[this._currentCompositeOperation];this._context.blendFunc(c[0],c[1])}var l=1/e.textureWidth,d=1/e.textureHeight,p=e.textureOffsetX,f=e.textureOffsetY,_=l*(p+r+n),y=d*(f+i+o),g=l*(p+r),v=d*(f+i);this._register(this._transformVertex(s,a,n,o,t.transformer),[g,v,_,v,_,y,g,v,_,y,g,y])},n.prototype.end=function(){if(this._commit(),this._deleteRequestedTargets.length>0){for(var t=0;t<this._deleteRequestedTargets.length;++t)this.deleteRenderTarget(this._deleteRequestedTargets[t]);this._deleteRequestedTargets=[]}},n.prototype.makeTextureForSurface=function(t){this._textureAtlas.makeTextureForSurface(this,t)},n.prototype.disposeTexture=function(t){this._currentTexture===t&&this._commit()},n.prototype.assignTexture=function(t,e,r,i){if(this._context.bindTexture(this._context.TEXTURE_2D,i),t instanceof HTMLVideoElement)throw new Error("WebGLRenderer#assignTexture: HTMLVideoElement is not supported.");this._context.texSubImage2D(this._context.TEXTURE_2D,0,e,r,this._context.RGBA,this._context.UNSIGNED_BYTE,t),this._context.bindTexture(this._context.TEXTURE_2D,this._currentTexture)},n.prototype.clearTexture=function(t,e,r,i){this._context.bindTexture(this._context.TEXTURE_2D,i),this._context.texSubImage2D(this._context.TEXTURE_2D,0,0,0,e,r,this._context.RGBA,this._context.UNSIGNED_BYTE,t),this._context.bindTexture(this._context.TEXTURE_2D,this._currentTexture)},n.prototype.makeTextureRaw=function(t,e,r){void 0===r&&(r=null);var i=this._context.createTexture();if(!i)throw new Error("WebGLSharedObject#makeTextureRaw(): could not create WebGLTexture");return this._context.bindTexture(this._context.TEXTURE_2D,i),this._context.pixelStorei(this._context.UNPACK_PREMULTIPLY_ALPHA_WEBGL,1),this._context.texParameteri(this._context.TEXTURE_2D,this._context.TEXTURE_WRAP_S,this._context.CLAMP_TO_EDGE),this._context.texParameteri(this._context.TEXTURE_2D,this._context.TEXTURE_WRAP_T,this._context.CLAMP_TO_EDGE),this._context.texParameteri(this._context.TEXTURE_2D,this._context.TEXTURE_MAG_FILTER,this._context.NEAREST),this._context.texParameteri(this._context.TEXTURE_2D,this._context.TEXTURE_MIN_FILTER,this._context.NEAREST),this._context.texImage2D(this._context.TEXTURE_2D,0,this._context.RGBA,t,e,0,this._context.RGBA,this._context.UNSIGNED_BYTE,r),this._context.bindTexture(this._context.TEXTURE_2D,this._currentTexture),i},n.prototype.makeTexture=function(t){var e=this._context.createTexture();if(!e)throw new Error("WebGLSharedObject#makeTexture(): could not create WebGLTexture");return this._context.bindTexture(this._context.TEXTURE_2D,e),this._context.pixelStorei(this._context.UNPACK_PREMULTIPLY_ALPHA_WEBGL,1),this._context.texParameteri(this._context.TEXTURE_2D,this._context.TEXTURE_WRAP_S,this._context.CLAMP_TO_EDGE),this._context.texParameteri(this._context.TEXTURE_2D,this._context.TEXTURE_WRAP_T,this._context.CLAMP_TO_EDGE),this._context.texParameteri(this._context.TEXTURE_2D,this._context.TEXTURE_MAG_FILTER,this._context.NEAREST),this._context.texParameteri(this._context.TEXTURE_2D,this._context.TEXTURE_MIN_FILTER,this._context.NEAREST),(t instanceof HTMLImageElement||t instanceof HTMLCanvasElement||t instanceof ImageData)&&this._context.texImage2D(this._context.TEXTURE_2D,0,this._context.RGBA,this._context.RGBA,this._context.UNSIGNED_BYTE,t),this._context.bindTexture(this._context.TEXTURE_2D,this._currentTexture),e},n.prototype.getPrimaryRenderTarget=function(t,e){return this._renderTarget},n.prototype.createRenderTarget=function(t,e){var r=this._context,i=r.createFramebuffer();r.bindFramebuffer(r.FRAMEBUFFER,i);var n=r.createTexture();r.bindTexture(r.TEXTURE_2D,n),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MAG_FILTER,r.LINEAR),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_MIN_FILTER,r.LINEAR),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_S,r.CLAMP_TO_EDGE),r.texParameteri(r.TEXTURE_2D,r.TEXTURE_WRAP_T,r.CLAMP_TO_EDGE),r.texImage2D(r.TEXTURE_2D,0,r.RGBA,t,e,0,r.RGBA,r.UNSIGNED_BYTE,null),r.framebufferTexture2D(r.FRAMEBUFFER,r.COLOR_ATTACHMENT0,r.TEXTURE_2D,n,0),r.bindTexture(r.TEXTURE_2D,this._currentTexture);var o=this.getCurrentRenderTarget();return r.bindFramebuffer(r.FRAMEBUFFER,o.framebuffer),{width:t,height:e,viewportWidth:t,viewportHeight:e,framebuffer:i,texture:n}},n.prototype.requestDeleteRenderTarget=function(t){this._deleteRequestedTargets.push(t)},n.prototype.deleteRenderTarget=function(t){var e=this._context;this.getCurrentRenderTarget()===t&&this._commit(),e.deleteFramebuffer(t.framebuffer),e.deleteTexture(t.texture)},n.prototype.getContext=function(){return this._context},n.prototype.getDefaultShaderProgram=function(){return this._defaultShaderProgram},n.prototype.initializeShaderProgram=function(t){if(t&&!t._program){var e=new r.WebGLShaderProgram(this._context,t.fragmentShader,t.uniforms);e.initializeUniforms(),t._program=e}return t},n.prototype.flush=function(){this._commit()},n.prototype._init=function(){var t=new r.WebGLShaderProgram(this._context);this._textureAtlas=new i.WebGLTextureAtlas,this._fillRectTexture=this.makeTextureRaw(1,1,new Uint8Array([255,255,255,255])),this._fillRectSurfaceTexture={texture:this._fillRectTexture,textureWidth:1,textureHeight:1,textureOffsetX:0,textureOffsetY:0},this._renderTarget={width:this._surface.width,height:this._surface.height,viewportWidth:this._surface.width,viewportHeight:this._surface.height,framebuffer:null,texture:null},this._maxSpriteCount=1024,this._vertices=this._makeBuffer(24*this._maxSpriteCount*4),this._verticesCache=new Float32Array(24*this._maxSpriteCount),this._numSprites=0,this._currentTexture=null,this._currentColor=[1,1,1,1],this._currentAlpha=1,this._currentCompositeOperation="source-over",this._currentShaderProgram=t,this._defaultShaderProgram=t,this._renderTargetStack=[],this._deleteRequestedTargets=[],this._currentShaderProgram.use();try{this._currentShaderProgram.set_aVertex(this._vertices),this._currentShaderProgram.set_uColor(this._currentColor),this._currentShaderProgram.set_uAlpha(this._currentAlpha),this._currentShaderProgram.set_uSampler(0)}finally{this._currentShaderProgram.unuse()}this._context.enable(this._context.BLEND),this._context.activeTexture(this._context.TEXTURE0),this._context.bindTexture(this._context.TEXTURE_2D,this._fillRectTexture),this._compositeOps={"source-atop":[this._context.DST_ALPHA,this._context.ONE_MINUS_SRC_ALPHA],"experimental-source-in":[this._context.DST_ALPHA,this._context.ZERO],"experimental-source-out":[this._context.ONE_MINUS_DST_ALPHA,this._context.ZERO],"source-over":[this._context.ONE,this._context.ONE_MINUS_SRC_ALPHA],"experimental-destination-atop":[this._context.ONE_MINUS_DST_ALPHA,this._context.SRC_ALPHA],"experimental-destination-in":[this._context.ZERO,this._context.SRC_ALPHA],"destination-out":[this._context.ZERO,this._context.ONE_MINUS_SRC_ALPHA],"destination-over":[this._context.ONE_MINUS_DST_ALPHA,this._context.ONE],lighter:[this._context.ONE,this._context.ONE],copy:[this._context.ONE,this._context.ZERO],xor:[this._context.ONE_MINUS_DST_ALPHA,this._context.ONE_MINUS_SRC_ALPHA],difference:[this._context.ONE,this._context.ONE_MINUS_SRC_ALPHA],saturation:[this._context.ONE,this._context.ONE_MINUS_SRC_ALPHA]};var e=this._compositeOps[this._currentCompositeOperation];this._context.blendFunc(e[0],e[1])},n.prototype._makeBuffer=function(t){var e=this._context.createBuffer();if(!e)throw new Error("WebGLSharedObject#_makeBuffer(): could not create WebGLBuffer");return this._context.bindBuffer(this._context.ARRAY_BUFFER,e),this._context.bufferData(this._context.ARRAY_BUFFER,t,this._context.DYNAMIC_DRAW),e},n.prototype._transformVertex=function(t,e,r,i,n){var o=this.getCurrentRenderTarget(),s=2/o.width,a=-2/o.height,h=n.matrix,u=s*r*h[0],c=a*r*h[1],l=s*i*h[2],d=a*i*h[3],p=s*(t*h[0]+e*h[2]+h[4])-1,f=a*(t*h[1]+e*h[3]+h[5])+1;return[p,f,u+p,c+f,u+l+p,c+d+f,p,f,u+l+p,c+d+f,l+p,d+f]},n.prototype._register=function(t,e){var r=6*this._numSprites;++this._numSprites;for(var i=0;i<6;++i)this._verticesCache[4*(i+r)+0]=t[2*i+0],this._verticesCache[4*(i+r)+1]=t[2*i+1],this._verticesCache[4*(i+r)+2]=e[2*i+0],this._verticesCache[4*(i+r)+3]=e[2*i+1]},n.prototype._commit=function(){this._numSprites>0&&(this._context.bindBuffer(this._context.ARRAY_BUFFER,this._vertices),this._context.bufferSubData(this._context.ARRAY_BUFFER,0,this._verticesCache.subarray(0,24*this._numSprites)),this._context.drawArrays(this._context.TRIANGLES,0,6*this._numSprites),this._numSprites=0)},n}();return Fh.WebGLSharedObject=n,Fh}var hu,uu,cu,lu,du={};function pu(){if(uu)return Lh;uu=1,Object.defineProperty(Lh,"__esModule",{value:!0}),Lh.SurfaceFactory=void 0;var t=gh(),e=Ch(),r=au(),i=function(){if(hu)return du;hu=1,Object.defineProperty(du,"__esModule",{value:!0}),du.CanvasDisposer=void 0;var t=function(){function t(){this._idCounter=0,this._canvasMap={},this._registry="undefined"!=typeof FinalizationRegistry?new FinalizationRegistry(this._dispose.bind(this)):null}return t.prototype.register=function(t,e){if(this._registry){var r="".concat(this._idCounter++);this._canvasMap[r]=e,this._registry.register(t,r)}},t.prototype._dispose=function(t){var e=this._canvasMap[t];e&&(e.width=1,e.height=1,delete this._canvasMap[t])},t}();return du.CanvasDisposer=t,du}(),n=function(){function n(){this._disposer=new i.CanvasDisposer}return n.prototype.createPrimarySurface=function(i,n,o){var s=e.RenderingHelper.usedWebGL(o);return s?(this._shared||(this._shared=new r.WebGLSharedObject({width:i,height:n,enableDepthBuffer:s.options.enableDepthBuffer})),this._shared.getPrimarySurface()):new t.Context2DSurface(i,n)},n.prototype.createBackSurface=function(r,i,n){var o=e.RenderingHelper.usedWebGL(n)?this._shared.createBackSurface(r,i):new t.Context2DSurface(r,i);return this._disposer.register(o,o.getHTMLElement()),o},n}();return Lh.SurfaceFactory=n,Lh}function fu(){if(cu)return qa;cu=1,Object.defineProperty(qa,"__esModule",{value:!0}),qa.ResourceFactory=void 0;var e=function(){if(za)return Ya;za=1;var e=t&&t.__extends||function(){var t=function(e,r){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r])},t(e,r)};return function(e,r){if("function"!=typeof r&&null!==r)throw new TypeError("Class extends value "+String(r)+" is not a constructor or null");function i(){this.constructor=e}t(e,r),e.prototype=null===r?Object.create(r):(i.prototype=r.prototype,new i)}}();Object.defineProperty(Ya,"__esModule",{value:!0}),Ya.BinaryAsset=void 0;var r=va(),i=function(t){function i(e,r){var i=t.call(this,e,r)||this;return i.type="binary",i.data=void 0,i}return e(i,t),i.prototype.destroy=function(){this.data=void 0,t.prototype.destroy.call(this)},i.prototype._load=function(t){var e=this;(new r.XHRLoader).getArrayBuffer(this.path,(function(r,i){r?t._onAssetError(e,r):null!=i?(e.data=i,t._onAssetLoad(e)):t._onAssetError(e,{name:"AssetLoadError",retriable:!1,message:"BinaryAsset#_load(): no data received"})}))},i}(wa().Asset);return Ya.BinaryAsset=i,Ya}(),r=function(){if(_h)return Ja;_h=1;var e=t&&t.__extends||function(){var t=function(e,r){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r])},t(e,r)};return function(e,r){if("function"!=typeof r&&null!==r)throw new TypeError("Class extends value "+String(r)+" is not a constructor or null");function i(){this.constructor=e}t(e,r),e.prototype=null===r?Object.create(r):(i.prototype=r.prototype,new i)}}();Object.defineProperty(Ja,"__esModule",{value:!0}),Ja.GeneratedSVGImageAsset=void 0;var r=ga(),i=function(t){function i(e,r,i){var n=t.call(this,e,r,0,0)||this;return n._svgString=i,n}return e(i,t),i.prototype.destroy=function(){this._svgString=null,t.prototype.destroy.call(this)},i.prototype._load=function(t){var e,i=this,o=this._svgString,s=new DOMParser;try{var a=s.parseFromString(o,"text/xml").getElementsByTagName("svg")[0],h=a.getAttribute("width"),u=a.getAttribute("height");if(null==h)throw new Error("must give width in the root element.");if(null==u)throw new Error("must give height in the root element.");if(!n(h))throw new Error('the width in the root element must be given in "px" units');if(!n(u))throw new Error('the height in the root element must be given in "px" units');e=window.btoa(o),this.width=parseFloat(h),this.height=parseFloat(u)}catch(e){return void t._onAssetError(this,r.ExceptionFactory.createAssetLoadError(e.message,!1,e))}var c=new Image;c.onerror=function(e){t._onAssetError(i,r.ExceptionFactory.createAssetLoadError("GeneratedSVGImageAsset: unknown loading error",void 0,e))},c.onload=function(){i.data=c,t._onAssetLoad(i)},c.src="data:image/svg+xml;base64,"+e},i}(vh().SVGImageAsset);function n(t){return/^[+-]?(?:(?:[0-9]+(?:\.[0-9]*)?)|(?:\.[0-9]+))(?:[eE][+-]?[0-9]+)?(?:px)?$/.test(t)}return Ja.GeneratedSVGImageAsset=i,Ja}(),i=function(){if(mh)return Th;mh=1;var e=t&&t.__extends||function(){var t=function(e,r){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r])},t(e,r)};return function(e,r){if("function"!=typeof r&&null!==r)throw new TypeError("Class extends value "+String(r)+" is not a constructor or null");function i(){this.constructor=e}t(e,r),e.prototype=null===r?Object.create(r):(i.prototype=r.prototype,new i)}}();Object.defineProperty(Th,"__esModule",{value:!0}),Th.HTMLImageAsset=Th.ImageAssetSurface=void 0;var r=rh(),i=ga(),n=wa(),o=function(t){function r(){return null!==t&&t.apply(this,arguments)||this}return e(r,t),r.prototype.renderer=function(){throw new Error("ImageAssetSurface cannot be rendered.")},r.prototype.isPlaying=function(){return!1},r}(r.Surface);Th.ImageAssetSurface=o;var s=function(t){function r(e,r,i,n){var o=t.call(this,e,r)||this;return o.type="image",o.width=i,o.height=n,o.data=void 0,o._surface=void 0,o}return e(r,t),r.prototype.initialize=function(t){this.hint=t},r.prototype.destroy=function(){this._surface&&!this._surface.destroyed()&&this._surface.destroy(),this.data=void 0,this._surface=void 0,t.prototype.destroy.call(this)},r.prototype._load=function(t){var e=this,r=new Image;this.hint&&this.hint.untainted&&(r.crossOrigin="anonymous"),r.onerror=function(){t._onAssetError(e,i.ExceptionFactory.createAssetLoadError("HTMLImageAsset unknown loading error"))},r.onload=function(){e.data=r,t._onAssetLoad(e)},r.src=this.path},r.prototype.asSurface=function(){if(!this.data)throw new Error("ImageAssetImpl#asSurface: not yet loaded.");return this._surface||(this._surface=new o(this.width,this.height,this.data)),this._surface},r}(n.Asset);return Th.HTMLImageAsset=s,Th}(),n=Ph(),o=vh(),s=function(){if(xh)return Eh;xh=1;var e=t&&t.__extends||function(){var t=function(e,r){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r])},t(e,r)};return function(e,r){if("function"!=typeof r&&null!==r)throw new TypeError("Class extends value "+String(r)+" is not a constructor or null");function i(){this.constructor=e}t(e,r),e.prototype=null===r?Object.create(r):(i.prototype=r.prototype,new i)}}();Object.defineProperty(Eh,"__esModule",{value:!0}),Eh.XHRScriptAsset=void 0;var r=va(),i=function(t){function i(e,r,i){void 0===i&&(i=[]);var n=t.call(this,e,r)||this;return n.type="script",n.script="",n.exports=i,n}return e(i,t),i.prototype._load=function(t){var e=this;(new r.XHRLoader).get(this.path,(function(r,i){r?t._onAssetError(e,r):(e.script=i+"\n",t._onAssetLoad(e))}))},i.prototype.execute=function(t){return this._wrap()(t),t.module.exports},i.prototype.destroy=function(){this.script=void 0,t.prototype.destroy.call(this)},i.prototype._wrap=function(){for(var t="",e=0,r=this.exports;e<r.length;e++){var i=r[e];t+='exports["'.concat(i,'"] = typeof ').concat(i,' !== "undefined" ? ').concat(i," : undefined;\n")}return new Function("g","(function(exports, require, module, __filename, __dirname) {\n"+this.script+"\n"+t+"\n})(g.module.exports, g.module.require, g.module, g.filename, g.dirname);")},i}(wa().Asset);return Eh.XHRScriptAsset=i,Eh}(),a=Sa(),h=function(){if(Oh)return kh;Oh=1,Object.defineProperty(kh,"__esModule",{value:!0}),kh.GlyphFactory=void 0;var t=gh();function e(e,r,i,n,s,a,h,u,c,l,d,p){var f=r<o._environmentMinimumFontSize?r/o._environmentMinimumFontSize:1,_=Math.ceil((r+2*s)*f),y=Math.ceil((r+2*a)*f),g=new t.Context2DSurface(_,y),v=g.canvas,m=v.getContext("2d");if(!m)throw new Error("createGlyphRenderedSurface(): could not initialize CanvasRenderingContext2D");var T=4294901760&e?String.fromCharCode((4294901760&e)>>>16,65535&e):String.fromCharCode(e);m.save(),m.font=p+" "+r+"px "+i,m.textAlign="left",m.textBaseline="alphabetic",m.lineJoin="bevel",1!==f&&m.scale(f,f),c>0&&(m.lineWidth=c,m.strokeStyle=l,m.strokeText(T,s,a+n)),d||(m.fillStyle=u,m.fillText(T,s,a+n));var A=m.measureText(T).width;return m.restore(),{surface:g,advanceWidth:A,imageData:h?m.getImageData(0,0,v.width,v.height):void 0}}var r=["serif","sans-serif","monospace","cursive","fantasy","system-ui"];function i(t){return-1!==r.indexOf(t)?t:'"'+t+'"'}function n(t,e,r,i,n,o,s,a,h,u){return{code:t,x:e,y:r,width:i,height:n,surface:h,offsetX:o,offsetY:s,advanceWidth:a,isSurfaceValid:u,_atlas:null}}var o=function(){function t(e,r,n,o,s,a,h,u){void 0===n&&(n=r),void 0===o&&(o="black"),void 0===s&&(s=0),void 0===a&&(a="black"),void 0===h&&(h=!1),void 0===u&&(u="normal"),this._glyphAreas=Object.create(null),this.fontFamily=e,this.fontSize=r,this.baselineHeight=n,this.fontColor=o,this.strokeWidth=s,this.strokeColor=a,this.strokeOnly=h,this.fontWeight=u,this._cssFontFamily="string"==typeof e?i(e):e.map(i).join(","),-1===this._cssFontFamily.indexOf("sans-serif")&&(this._cssFontFamily+=",sans-serif"),this._marginW=Math.ceil(.3*this.fontSize+this.strokeWidth/2),this._marginH=Math.ceil(.3*this.fontSize+this.strokeWidth/2),void 0===t._environmentMinimumFontSize&&(t._environmentMinimumFontSize=this.measureMinimumFontSize())}return t.prototype.create=function(t){var r=null,i=this._glyphAreas[t];return i||((i=function(t){for(var e=t.width,r=t.height,i=0,n=0,o=0,s=0,a=t.height;s<a;s=s+1|0)for(var h=0,u=t.width;h<u;h=h+1|0)0!==t.data[o+3]&&(h<e&&(e=h),h>i&&(i=h),s<r&&(r=s),s>n&&(n=s)),o+=4;return e===t.width?{x:0,y:0,width:0,height:0}:{x:e,y:r,width:i-e+1,height:n-r+1}}((r=e(t,this.fontSize,this._cssFontFamily,this.baselineHeight,this._marginW,this._marginH,!0,this.fontColor,this.strokeWidth,this.strokeColor,this.strokeOnly,this.fontWeight)).imageData)).advanceWidth=r.advanceWidth,this._glyphAreas[t]=i),function(t){return 0===t.width||0===t.height}(i)?(r&&r.surface.destroy(),n(t,0,0,0,0,0,0,i.advanceWidth,void 0,!0)):(r||(r=e(t,this.fontSize,this._cssFontFamily,this.baselineHeight,this._marginW,this._marginH,!1,this.fontColor,this.strokeWidth,this.strokeColor,this.strokeOnly,this.fontWeight)),n(t,i.x,i.y,i.width,i.height,i.x-this._marginW,i.y-this._marginH,i.advanceWidth,r.surface,!0))},t.prototype.measureMinimumFontSize=function(){var t,e=1,r=document.createElement("canvas").getContext("2d");if(!r)throw new Error("GlyphFactory#measureMinimumFontSize(): could not initialize CanvasRenderingContext2D");r.textAlign="left",r.textBaseline="alphabetic",r.lineJoin="bevel",r.font=e+"px sans-serif";var i=r.measureText("M").width;do{t=i,e+=1,r.font=e+"px sans-serif",i=r.measureText("M").width}while(t===i||e>50);return e},t}();return kh.GlyphFactory=o,kh}(),u=pu(),c=function(){function t(t){this._audioPluginManager=t.audioPluginManager,this._audioManager=t.audioManager,this._platform=t.platform,this._surfaceFactory=new u.SurfaceFactory}return t.prototype.createAudioAsset=function(t,e,r,i,n,o,s){var a=this._audioPluginManager.getActivePlugin();if(!a)throw new Error("ResourceFactory#createAudioAsset(): could not initialize ActivePlugin");var h=a.createAsset(t,e,r,i,n,o,s);return this._audioManager.registerAudioAsset(h),h.onDestroyed.addOnce(this._onAudioAssetDestroyed,this),h},t.prototype.createAudioPlayer=function(t){var e=this._audioPluginManager.getActivePlugin();if(!e)throw new Error("ResourceFactory#createAudioAsset(): could not initialize ActivePlugin");return e.createPlayer(t,this._audioManager)},t.prototype.createImageAsset=function(t,e,r,n){return new i.HTMLImageAsset(t,e,r,n)},t.prototype.createVideoAsset=function(t,e,r,i,o,s,a){return new n.HTMLVideoAsset(t,e,r,i,o,s,a)},t.prototype.createTextAsset=function(t,e){return new a.XHRTextAsset(t,e)},t.prototype.createScriptAsset=function(t,e,r){return new s.XHRScriptAsset(t,e,r)},t.prototype.createPrimarySurface=function(t,e){return this._surfaceFactory.createPrimarySurface(t,e,this._rendererCandidates)},t.prototype.createSurface=function(t,e){return this._surfaceFactory.createBackSurface(t,e,this._rendererCandidates)},t.prototype.createGlyphFactory=function(t,e,r,i,n,o,s,a){return new h.GlyphFactory(t,e,r,i,n,o,s,a)},t.prototype.createVectorImageAsset=function(t,e,r,i,n){return new o.SVGImageAsset(t,e,r,i,n)},t.prototype.createVectorImageAssetFromString=function(t,e,i){return new r.GeneratedSVGImageAsset(t,e,i)},t.prototype.createBinaryAsset=function(t,r){return new e.BinaryAsset(t,r)},t.prototype._onAudioAssetDestroyed=function(t){this._audioManager.removeAudioAsset(t)},t}();return qa.ResourceFactory=c,qa}function _u(){if(lu)return pa;lu=1,Object.defineProperty(pa,"__esModule",{value:!0}),pa.Platform=void 0;var t=Sa(),e=function(){if(ba)return Pa;ba=1,Object.defineProperty(Pa,"__esModule",{value:!0}),Pa.AudioManager=void 0;var t=function(){function t(){this.audioAssets=[],this._masterVolume=1}return t.prototype.registerAudioAsset=function(t){-1===this.audioAssets.indexOf(t)&&this.audioAssets.push(t)},t.prototype.removeAudioAsset=function(t){var e=this.audioAssets.indexOf(t);-1===e&&this.audioAssets.splice(e,1)},t.prototype.setMasterVolume=function(t){this._masterVolume=t;for(var e=0;e<this.audioAssets.length;e++)this.audioAssets[e]._lastPlayedPlayer&&this.audioAssets[e]._lastPlayedPlayer.notifyMasterVolumeChanged()},t.prototype.getMasterVolume=function(){return this._masterVolume},t}();return Pa.AudioManager=t,Pa}(),r=function(){if(Fa)return Oa;Fa=1,Object.defineProperty(Oa,"__esModule",{value:!0}),Oa.ContainerController=void 0;var t=P,e=ja(),r=function(){function r(e){this.container=void 0,this.surface=void 0,this.inputHandlerLayer=void 0,this.rootView=void 0,this.observer=void 0,this.useResizeForScaling=!1,this.pointEventTrigger=new t.Trigger,this._rendererReq=void 0,this.resourceFactory=e}return r.prototype.initialize=function(t){this._rendererReq=t.rendererRequirement,this._loadView()},r.prototype.setRootView=function(t){t!==this.rootView&&(this.rootView&&(this.unloadView(),this._loadView()),this.rootView=t,this._appendToRootView(t))},r.prototype.resetView=function(t){this.unloadView(),this._rendererReq=t,this._loadView(),this._appendToRootView(this.rootView)},r.prototype.getRenderer=function(){if(!this.surface)throw new Error("this container has no surface");return this.surface.renderer()},r.prototype.changeScale=function(t,e){this.useResizeForScaling?this.surface.changePhysicalScale(t,e):this.surface.changeVisualScale(t,e),this.inputHandlerLayer._inputHandler.setScale(t,e)},r.prototype.unloadView=function(){if(this.inputHandlerLayer.disablePointerEvent(),this.rootView)for(;this.rootView.firstChild;)this.rootView.removeChild(this.rootView.firstChild)},r.prototype.setTabIndex=function(t){this.inputHandlerLayer.setViewTabIndex(t)},r.prototype._loadView=function(){var t=this,r=this._rendererReq,i=r.primarySurfaceWidth,n=r.primarySurfaceHeight;this.container=document.createDocumentFragment(),this.inputHandlerLayer?(this.inputHandlerLayer.setViewSize({width:i,height:n}),this.inputHandlerLayer.pointEventTrigger.removeAll(),this.surface&&!this.surface.destroyed()&&(this.inputHandlerLayer.view.removeChild(this.surface.canvas),this.surface.destroy(),this.observer.disconnect())):this.inputHandlerLayer=new e.InputHandlerLayer({width:i,height:n}),this.surface=this.resourceFactory.createPrimarySurface(i,n);var o=this.surface.getHTMLElement();this.observer=new MutationObserver((function(){t.inputHandlerLayer.view.style.width=o.offsetWidth+"px",t.inputHandlerLayer.view.style.height=o.offsetHeight+"px"})),this.observer.observe(o,{attributeFilter:["width","height","style"]}),this.inputHandlerLayer.view.appendChild(o),this.container.appendChild(this.inputHandlerLayer.view)},r.prototype._appendToRootView=function(t){t.appendChild(this.container),this.inputHandlerLayer.enablePointerEvent(),this.inputHandlerLayer.pointEventTrigger.add(this.pointEventTrigger.fire,this.pointEventTrigger)},r}();return Oa.ContainerController=r,Oa}(),i=Ba(),n=Wa(),o=function(){if(Va)return Xa;Va=1,Object.defineProperty(Xa,"__esModule",{value:!0}),Xa.RafLooper=void 0;var t=function(){function t(t){this._timerId=null,this._fun=t,this._prev=0}return t.prototype.start=function(){var t=this,e=function e(r){null!=t._timerId&&(t._timerId=requestAnimationFrame(e),t._fun(r-t._prev),t._prev=r)};this._timerId=requestAnimationFrame((function(r){t._timerId=requestAnimationFrame(e),t._fun(0),t._prev=r}))},t.prototype.stop=function(){null!=this._timerId&&cancelAnimationFrame(this._timerId),this._timerId=null,this._prev=0},t}();return Xa.RafLooper=t,Xa}(),s=fu(),a=function(){function a(t){this.usingPointerEvents=!0,this.containerView=t.containerView,this.audioPluginManager=new i.AudioPluginManager,t.audioPlugins&&this.audioPluginManager.tryInstallPlugin(t.audioPlugins),this.audioPluginManager.tryInstallPlugin(n.AudioPluginRegistry.getRegisteredAudioPlugins()),this._audioManager=new e.AudioManager,this.amflow=t.amflow,this._platformEventHandler=null,this._resourceFactory=t.resourceFactory||new s.ResourceFactory({audioPluginManager:this.audioPluginManager,platform:this,audioManager:this._audioManager}),this.containerController=new r.ContainerController(this._resourceFactory),this._rendererReq=null,this._disablePreventDefault=!!t.disablePreventDefault}return a.prototype.setPlatformEventHandler=function(t){this.containerController&&(this.containerController.pointEventTrigger.removeAll({owner:this._platformEventHandler}),this.containerController.pointEventTrigger.add(t.onPointEvent,t)),this._platformEventHandler=t},a.prototype.loadGameConfiguration=function(e,r){var i=new t.XHRTextAsset("(game.json)",e);i._load({_onAssetLoad:function(t){r(null,JSON.parse(i.data))},_onAssetError:function(t,e){r(e,null)}})},a.prototype.getResourceFactory=function(){return this._resourceFactory},a.prototype.setRendererRequirement=function(t){var e;t?(this._rendererReq=t,this._resourceFactory._rendererCandidates=null!==(e=this._rendererReq.rendererCandidates)&&void 0!==e?e:[],this.containerController&&!this.containerController.inputHandlerLayer?(this.containerController.initialize({rendererRequirement:t,disablePreventDefault:this._disablePreventDefault}),this.containerController.setRootView(this.containerView),this._platformEventHandler&&this.containerController.pointEventTrigger.add(this._platformEventHandler.onPointEvent,this._platformEventHandler)):this.containerController.resetView(t)):this.containerController&&this.containerController.unloadView()},a.prototype.getPrimarySurface=function(){return this.containerController.surface},a.prototype.getOperationPluginViewInfo=function(){var t=this;return{type:"pdi-browser",view:this.containerController.inputHandlerLayer.view,getScale:function(){return t.containerController.inputHandlerLayer._inputHandler.getScale()}}},a.prototype.createLooper=function(t){return new o.RafLooper(t)},a.prototype.sendToExternal=function(t,e){},a.prototype.registerAudioPlugins=function(t){return this.audioPluginManager.tryInstallPlugin(t)},a.prototype.setScale=function(t,e){this.containerController.changeScale(t,e)},a.prototype.notifyViewMoved=function(){},a.prototype.setMasterVolume=function(t){this._audioManager.setMasterVolume(t)},a.prototype.getMasterVolume=function(){return this._audioManager.getMasterVolume()},a.prototype.setTabIndex=function(t){this.containerController.setTabIndex(t)},a.prototype.destroy=function(){this.setRendererRequirement(void 0),this.setMasterVolume(0)},a}();return pa.Platform=a,pa}var yu,gu={},vu={};function mu(){if(yu)return vu;return yu=1,Object.defineProperty(vu,"__esModule",{value:!0}),vu.addExtname=vu.resolveExtname=vu.detectSupportedFormats=void 0,vu.detectSupportedFormats=function(){var t;if(-1!==navigator.userAgent.indexOf("Edge/"))return["aac"];for(var e=document.createElement("audio"),r=["ogg","m4a","aac","mp4"],i={m4a:"audio/x-m4a"},n=[],o=0,s=r.length;o<s;o++){var a=r[o],h=null!==(t=i[a])&&void 0!==t?t:"audio/"+a;try{var u=e.canPlayType(h);"no"!==u&&""!==u&&n.push(a)}catch(t){}}return n},vu.resolveExtname=function(t,e){if(!t||!t.length)return null;for(var r=0,i=e;r<i.length;r++){var n="."+i[r];if(-1!==t.indexOf(n))return n}return null},vu.addExtname=function(t,e){var r=t.indexOf("?");return-1===r?t+e:t.substring(0,r)+e+t.substring(r,t.length)},vu}var Tu,Au,wu={},Su={};function bu(){if(Tu)return Su;Tu=1;var e=t&&t.__extends||function(){var t=function(e,r){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r])},t(e,r)};return function(e,r){if("function"!=typeof r&&null!==r)throw new TypeError("Class extends value "+String(r)+" is not a constructor or null");function i(){this.constructor=e}t(e,r),e.prototype=null===r?Object.create(r):(i.prototype=r.prototype,new i)}}();Object.defineProperty(Su,"__esModule",{value:!0}),Su.AudioAsset=void 0;var r=function(t){function r(e,r,i,n,o,s,a){var h=t.call(this,e,r)||this;return h.type="audio",h.data=void 0,h.duration=i,h.loop=o,h.hint=s,h._system=n,h.offset=a,h.path=h._modifyPath(h.path),h}return e(r,t),r.prototype.play=function(){var t=this._system.createPlayer();return t.play(this),this._lastPlayedPlayer=t,t},r.prototype.stop=function(){for(var t=this._system.findPlayers(this),e=0;e<t.length;++e)t[e].stop()},r.prototype.inUse=function(){return this._system.findPlayers(this).length>0},r.prototype.destroy=function(){this._system&&this.stop(),this.data=void 0,this._system=void 0,this._lastPlayedPlayer=void 0,t.prototype.destroy.call(this)},r}(wa().Asset);return Su.AudioAsset=r,Su}var Pu,xu={},Eu={};function Ou(){if(Pu)return Eu;Pu=1,Object.defineProperty(Eu,"__esModule",{value:!0}),Eu.AudioPlayer=void 0;var t=P,e=function(){function e(e){this.onPlay=new t.Trigger,this.onStop=new t.Trigger,this.played=this.onPlay,this.stopped=this.onStop,this.volume=1,this._muted=!1,this._system=e}return e.prototype.play=function(t){this.currentAudio=t,this.onPlay.fire({player:this,audio:t})},e.prototype.stop=function(){var t=this.currentAudio;t&&(this.currentAudio=void 0,this.onStop.fire({player:this,audio:t}))},e.prototype.canHandleStopped=function(){return!0},e.prototype.changeVolume=function(t){this.volume=t},e.prototype._changeMuted=function(t){},e.prototype._notifyVolumeChanged=function(){this.changeVolume(this.volume)},e}();return Eu.AudioPlayer=e,Eu}var ku,Mu,Lu,Ru={};function Cu(){if(ku)return Ru;ku=1,Object.defineProperty(Ru,"__esModule",{value:!0}),Ru.setupChromeMEIWorkaround=void 0;var t=0,e=[];function r(){i(),document.removeEventListener("keydown",r),document.removeEventListener("mousedown",r),document.removeEventListener("touchend",r)}function i(){t=2,e.forEach((function(t){return t.play()})),e=[]}return Ru.setupChromeMEIWorkaround=function(n){var o=null;function s(){switch(t){case 0:case 1:i()}t=2,clearTimeout(o)}switch(t){case 0:n.addEventListener("play",s,!0),o=window.setTimeout((function(){switch(n.removeEventListener("play",s),t){case 0:e.push(n),t=1,document.addEventListener("keydown",r,!0),document.addEventListener("mousedown",r,!0),document.addEventListener("touchend",r,!0);break;case 1:e.push(n);break;case 2:n.play()}}),100);break;case 1:e.push(n)}},Ru}function Iu(){if(Lu)return gu;Lu=1,Object.defineProperty(gu,"__esModule",{value:!0}),gu.HTMLAudioPlugin=void 0;var e=mu(),r=function(){if(Au)return wu;Au=1;var e=t&&t.__extends||function(){var t=function(e,r){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r])},t(e,r)};return function(e,r){if("function"!=typeof r&&null!==r)throw new TypeError("Class extends value "+String(r)+" is not a constructor or null");function i(){this.constructor=e}t(e,r),e.prototype=null===r?Object.create(r):(i.prototype=r.prototype,new i)}}();Object.defineProperty(wu,"__esModule",{value:!0}),wu.HTMLAudioAsset=void 0;var r=bu(),i=ga(),n=mu(),o=function(t){function r(){var e=null!==t&&t.apply(this,arguments)||this;return e._intervalId=-1,e._intervalCount=0,e}return e(r,t),r.prototype._load=function(t){var e=this;if(null==this.path)return this.data=null,void setTimeout((function(){return t._onAssetLoad(e)}),0);var o=this.createAudioElement(),s=function(t,r){o.autoplay=!1,o.preload="none",o.src=t,e._attachAll(o,r),o.preload="auto",h(o,r),o.load()},a={success:function(){e._detachAll(o,a),e.data=o,t._onAssetLoad(e),window.clearInterval(e._intervalId)},error:function(){e._detachAll(o,a),e.data=o,t._onAssetError(e,i.ExceptionFactory.createAssetLoadError("HTMLAudioAsset loading error")),window.clearInterval(e._intervalId)}},h=function(t,r){e._intervalCount=0,e._intervalId=window.setInterval((function(){4===t.readyState?r.success():(++e._intervalCount,600===e._intervalCount&&r.error())}),100)},u=this.path.indexOf("?");if(".aac"!==(u>=0?this.path.substring(0,u):this.path).slice(-4)||-1===r.supportedFormats.indexOf("mp4"))s(this.path,a);else{var c={success:a.success,error:function(){e._detachAll(o,c),window.clearInterval(e._intervalId),e.path=(0,n.addExtname)(e.originalPath,".mp4"),s(e.path,a)}};s(this.path,c)}},r.prototype.cloneElement=function(){return this.data?this.createAudioElement(this.data.src):null},r.prototype._assetPathFilter=function(t){return-1!==r.supportedFormats.indexOf("ogg")?(0,n.addExtname)(t,".ogg"):-1!==r.supportedFormats.indexOf("aac")?(0,n.addExtname)(t,".aac"):null},r.prototype._modifyPath=function(t){var e,i=(0,n.resolveExtname)(null===(e=this.hint)||void 0===e?void 0:e.extensions,r.supportedFormats);return i?(0,n.addExtname)(this.originalPath,i):t},r.prototype.createAudioElement=function(t){return new Audio(t)},r.prototype._attachAll=function(t,e){e.success&&t.addEventListener("canplaythrough",e.success,!1),e.error&&(t.addEventListener("stalled",e.error,!1),t.addEventListener("error",e.error,!1),t.addEventListener("abort",e.error,!1))},r.prototype._detachAll=function(t,e){e.success&&t.removeEventListener("canplaythrough",e.success,!1),e.error&&(t.removeEventListener("stalled",e.error,!1),t.removeEventListener("error",e.error,!1),t.removeEventListener("abort",e.error,!1))},r}(r.AudioAsset);return wu.HTMLAudioAsset=o,wu}(),i=function(){if(Mu)return xu;Mu=1;var e=t&&t.__extends||function(){var t=function(e,r){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r])},t(e,r)};return function(e,r){if("function"!=typeof r&&null!==r)throw new TypeError("Class extends value "+String(r)+" is not a constructor or null");function i(){this.constructor=e}t(e,r),e.prototype=null===r?Object.create(r):(i.prototype=r.prototype,new i)}}();Object.defineProperty(xu,"__esModule",{value:!0}),xu.HTMLAudioPlayer=void 0;var r=Ou(),i=Cu(),n=function(t){function r(e,r){var i=t.call(this,e)||this;return i._audioInstance=null,i._isWaitingPlayEvent=!1,i._isStopRequested=!1,i._assetLoop=!1,i._manager=r,i._endedEventHandler=function(){i._onAudioEnded()},i._onPlayEventHandler=function(){i._onPlayEvent()},i._dummyDurationWaitTimer=null,i}return e(r,t),r.prototype.play=function(e){var r,n;if(this.currentAudio){if(e.id===this.currentAudio.id)return t.prototype.stop.call(this),this._audioInstance.currentTime=(null!==(r=e.offset)&&void 0!==r?r:0)/1e3,void t.prototype.play.call(this,e);this.stop()}var o=e.cloneElement();if(this._assetLoop=e.loop,o){if(e.offset){var s=(null!==(n=e.offset)&&void 0!==n?n:0)/1e3,a=e.duration/1e3+s;o.currentTime=s,o.ontimeupdate=function(){a<=o.currentTime&&(e.loop?o.currentTime=s:o.pause())},o.onended=function(){e.loop&&(o.currentTime=s,o.play())}}else o.loop=e.loop;(0,i.setupChromeMEIWorkaround)(o),o.volume=this._calculateVolume(),o.play().catch((function(t){})),o.addEventListener("ended",this._endedEventHandler,!1),o.addEventListener("play",this._onPlayEventHandler,!1),this._isWaitingPlayEvent=!0,this._audioInstance=o}else this._dummyDurationWaitTimer=setTimeout(this._endedEventHandler,e.duration);t.prototype.play.call(this,e)},r.prototype.stop=function(){this.currentAudio?(this._clearEndedEventHandler(),this._audioInstance&&(this._isWaitingPlayEvent?this._isStopRequested=!0:(this._audioInstance.pause(),this._audioInstance=null)),t.prototype.stop.call(this)):t.prototype.stop.call(this)},r.prototype.changeVolume=function(e){t.prototype.changeVolume.call(this,e),this._audioInstance&&(this._audioInstance.volume=this._calculateVolume())},r.prototype._changeMuted=function(e){t.prototype._changeMuted.call(this,e),this._audioInstance&&(this._audioInstance.volume=this._calculateVolume())},r.prototype.notifyMasterVolumeChanged=function(){this._audioInstance&&(this._audioInstance.volume=this._calculateVolume())},r.prototype._onAudioEnded=function(){this._assetLoop||(this._clearEndedEventHandler(),t.prototype.stop.call(this))},r.prototype._clearEndedEventHandler=function(){this._audioInstance&&this._audioInstance.removeEventListener("ended",this._endedEventHandler,!1),null!=this._dummyDurationWaitTimer&&(clearTimeout(this._dummyDurationWaitTimer),this._dummyDurationWaitTimer=null)},r.prototype._onPlayEvent=function(){var t;this._isWaitingPlayEvent&&(this._isWaitingPlayEvent=!1,this._isStopRequested&&(this._isStopRequested=!1,null===(t=this._audioInstance)||void 0===t||t.pause(),this._audioInstance=null))},r.prototype._calculateVolume=function(){return this._system._muted?0:this.volume*this._system.volume*this._manager.getMasterVolume()},r}(r.AudioPlayer);return xu.HTMLAudioPlayer=n,xu}(),n=function(){function t(){this._supportedFormats=[],this.supportedFormats=(0,e.detectSupportedFormats)()}return t.isSupported=function(){var t=document.createElement("audio"),e=!1;try{e=void 0!==t.canPlayType}catch(t){}return e},Object.defineProperty(t.prototype,"supportedFormats",{get:function(){return this._supportedFormats},set:function(t){this._supportedFormats=t,r.HTMLAudioAsset.supportedFormats=t},enumerable:!1,configurable:!0}),t.prototype.createAsset=function(t,e,i,n,o,s,a){return new r.HTMLAudioAsset(t,e,i,n,o,s,a)},t.prototype.createPlayer=function(t,e){return new i.HTMLAudioPlayer(t,e)},t}();return gu.HTMLAudioPlugin=n,gu}var Fu,Du={},ju={};var Gu,Uu,Bu={};function Hu(){if(Uu)return Du;Uu=1,Object.defineProperty(Du,"__esModule",{value:!0}),Du.ProxyAudioPlugin=void 0;var e=function(){if(Fu)return ju;Fu=1;var e=t&&t.__extends||function(){var t=function(e,r){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r])},t(e,r)};return function(e,r){if("function"!=typeof r&&null!==r)throw new TypeError("Class extends value "+String(r)+" is not a constructor or null");function i(){this.constructor=e}t(e,r),e.prototype=null===r?Object.create(r):(i.prototype=r.prototype,new i)}}();Object.defineProperty(ju,"__esModule",{value:!0}),ju.ProxyAudioAsset=void 0;var r=bu(),i=ga(),n=function(t){function r(e,r,i,n,o,s,a,h){var u=t.call(this,r,i,n,o,s,a,h)||this;return u._handlerSet=e,u}return e(r,t),r.prototype.destroy=function(){this._handlerSet.unloadAudioAsset(this.id),t.prototype.destroy.call(this)},r.prototype._load=function(t){var e=this;this._handlerSet.loadAudioAsset({id:this.id,assetPath:this.path,duration:this.duration,loop:this.loop,hint:this.hint,offset:this.offset},(function(r){r?t._onAssetError(e,i.ExceptionFactory.createAssetLoadError(r)):t._onAssetLoad(e)}))},r.prototype._assetPathFilter=function(t){return t},r.prototype._modifyPath=function(t){return t},r}(r.AudioAsset);return ju.ProxyAudioAsset=n,ju}(),r=function(){if(Gu)return Bu;Gu=1;var e=t&&t.__extends||function(){var t=function(e,r){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r])},t(e,r)};return function(e,r){if("function"!=typeof r&&null!==r)throw new TypeError("Class extends value "+String(r)+" is not a constructor or null");function i(){this.constructor=e}t(e,r),e.prototype=null===r?Object.create(r):(i.prototype=r.prototype,new i)}}();Object.defineProperty(Bu,"__esModule",{value:!0}),Bu.ProxyAudioPlayer=void 0;var r=function(t){function r(e,r,i){var n=t.call(this,r)||this;return n._audioPlayerId=null,n._handlerSet=e,n._manager=i,n}return e(r,t),r.prototype.changeVolume=function(e){t.prototype.changeVolume.call(this,e),this._notifyVolumeToHandler()},r.prototype._changeMuted=function(e){t.prototype._changeMuted.call(this,e),this._notifyVolumeToHandler()},r.prototype.play=function(e){null!=this._audioPlayerId&&this.stop(),this._audioPlayerId="ap".concat(r._audioPlayerIdCounter++),this._handlerSet.createAudioPlayer({assetId:e.id,audioPlayerId:this._audioPlayerId,isPlaying:!0,volume:this._calculateVolume(),playbackRate:1}),t.prototype.play.call(this,e)},r.prototype.stop=function(){null!=this._audioPlayerId&&(this._handlerSet.stopAudioPlayer(this._audioPlayerId),this._handlerSet.destroyAudioPlayer(this._audioPlayerId),this._audioPlayerId=null),t.prototype.stop.call(this)},r.prototype.notifyMasterVolumeChanged=function(){this._notifyVolumeToHandler()},r.prototype._notifyVolumeToHandler=function(){null!=this._audioPlayerId&&this._handlerSet.changeAudioVolume(this._audioPlayerId,this._calculateVolume())},r.prototype._calculateVolume=function(){return this._system._muted?0:this.volume*this._system.volume*this._manager.getMasterVolume()},r._audioPlayerIdCounter=0,r}(Ou().AudioPlayer);return Bu.ProxyAudioPlayer=r,Bu}(),i=function(){function t(t){this.supportedFormats=[],this._handlerSet=t}return t.isSupported=function(){return!0},t.prototype.createAsset=function(t,r,i,n,o,s,a){return new e.ProxyAudioAsset(this._handlerSet,t,r,i,n,o,s,a)},t.prototype.createPlayer=function(t,e){return new r.ProxyAudioPlayer(this._handlerSet,t,e)},t}();return Du.ProxyAudioPlugin=i,Du}var Nu,Wu,Vu,Xu,zu,qu={},Yu={};function Ku(){if(Wu)return Nu;Wu=1;var t,e=window.AudioContext||window.webkitAudioContext;return function(t){t.getAudioContext=function(){window.__akashic__||Object.defineProperty(window,"__akashic__",{value:{},enumerable:!1,configurable:!1,writable:!1});var r=window.__akashic__.audioContext;return r instanceof e||(r=window.__akashic__.audioContext=new e,t._workAroundSafari()),r},t.createGainNode=function(t){return t.createGain?t.createGain():t.createGainNode()},t.createBufferNode=function(t){var e=t.createBufferSource();return e.start||(e.start=e.noteOn,e.stop=e.noteOff),e},t._workAroundSafari=function(){document.addEventListener("touchstart",(function e(){document.removeEventListener("touchstart",e),t.getAudioContext().createBufferSource().start(0)}),!0)}}(t||(t={})),Nu=t}function $u(){if(zu)return Xu;zu=1;var t,e=Ku();function r(){e.getAudioContext().resume(),document.removeEventListener("keydown",r),document.removeEventListener("mousedown",r),document.removeEventListener("touchend",r)}return function(t){t.setupChromeMEIWorkaround=function(){var t=e.getAudioContext();if(!t||"function"==typeof t.resume){var i=e.createGainNode(t),n=t.createOscillator();n.type="sawtooth",n.frequency.value=440,n.connect(i),n.start(0);var o=t.state;n.disconnect(),"running"!==o&&(document.addEventListener("keydown",r,!0),document.addEventListener("mousedown",r,!0),document.addEventListener("touchend",r,!0))}}}(t||(t={})),Xu=t}var Ju,Zu,Qu,tc,ec,rc={};function ic(){if(Zu)return qu;Zu=1,Object.defineProperty(qu,"__esModule",{value:!0}),qu.WebAudioPlugin=void 0;var e=mu(),r=function(){if(Vu)return Yu;Vu=1;var e=t&&t.__extends||function(){var t=function(e,r){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r])},t(e,r)};return function(e,r){if("function"!=typeof r&&null!==r)throw new TypeError("Class extends value "+String(r)+" is not a constructor or null");function i(){this.constructor=e}t(e,r),e.prototype=null===r?Object.create(r):(i.prototype=r.prototype,new i)}}();Object.defineProperty(Yu,"__esModule",{value:!0}),Yu.WebAudioAsset=void 0;var r=bu(),i=ga(),n=va(),o=mu(),s=Ku(),a=function(t){function r(){return null!==t&&t.apply(this,arguments)||this}return e(r,t),r.prototype._load=function(t){var e=this;if(null==this.path)return this.data=null,void setTimeout((function(){return t._onAssetLoad(e)}),0);var r=function(r){e.data=r,t._onAssetLoad(e)},a=function(){t._onAssetError(e,i.ExceptionFactory.createAssetLoadError("WebAudioAsset unknown loading error"))},h=function(t){s.getAudioContext().decodeAudioData(t,r,a)},u=new n.XHRLoader,c=function(t,e,r){u.getArrayBuffer(t,(function(t,i){t?r(t):e(i)}))},l=this.path.indexOf("?");".aac"!==(l>=0?this.path.substring(0,l):this.path).slice(-4)?c(this.path,h,a):c(this.path,h,(function(t){var r=(0,o.addExtname)(e.originalPath,".mp4");c(r,(function(t){e.path=r,h(t)}),a)}))},r.prototype._assetPathFilter=function(t){return-1!==r.supportedFormats.indexOf("ogg")?(0,o.addExtname)(t,".ogg"):-1!==r.supportedFormats.indexOf("aac")?(0,o.addExtname)(t,".aac"):null},r.prototype._modifyPath=function(t){var e,i=(0,o.resolveExtname)(null===(e=this.hint)||void 0===e?void 0:e.extensions,r.supportedFormats);return i?(0,o.addExtname)(this.originalPath,i):t},r.supportedFormats=[],r}(r.AudioAsset);return Yu.WebAudioAsset=a,Yu}(),i=$u(),n=function(){if(Ju)return rc;Ju=1;var e=t&&t.__extends||function(){var t=function(e,r){return t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var r in e)Object.prototype.hasOwnProperty.call(e,r)&&(t[r]=e[r])},t(e,r)};return function(e,r){if("function"!=typeof r&&null!==r)throw new TypeError("Class extends value "+String(r)+" is not a constructor or null");function i(){this.constructor=e}t(e,r),e.prototype=null===r?Object.create(r):(i.prototype=r.prototype,new i)}}();Object.defineProperty(rc,"__esModule",{value:!0}),rc.WebAudioPlayer=void 0;var r=Ou(),i=Ku(),n=function(t){function r(e,r){var n=t.call(this,e)||this;return n._audioContext=i.getAudioContext(),n._manager=r,n._gainNode=i.createGainNode(n._audioContext),n._gainNode.connect(n._audioContext.destination),n._dummyDurationWaitTimer=null,n._endedEventHandler=function(){n._onAudioEnded()},n}return e(r,t),r.prototype.changeVolume=function(e){t.prototype.changeVolume.call(this,e),this._gainNode.gain.value=this._calculateVolume()},r.prototype._changeMuted=function(e){t.prototype._changeMuted.call(this,e),this._gainNode.gain.value=this._calculateVolume()},r.prototype.play=function(e){var r;if(this.currentAudio&&this.stop(),e.data){var n=i.createBufferNode(this._audioContext);if(n.buffer=e.data,this._gainNode.gain.value=this._calculateVolume(),n.connect(this._gainNode),this._sourceNode=n,this._sourceNode.onended=this._endedEventHandler,e.loop)n.loop=e.loop,this._sourceNode.start(0);else{var o=(null!==(r=e.offset)&&void 0!==r?r:0)/1e3;e.duration>0?this._sourceNode.start(0,o,e.duration/1e3):this._sourceNode.start(0,o)}}else this._dummyDurationWaitTimer=setTimeout(this._endedEventHandler,e.duration);t.prototype.play.call(this,e)},r.prototype.stop=function(){this.currentAudio?(this._clearEndedEventHandler(),this._sourceNode&&this._sourceNode.stop(0),t.prototype.stop.call(this)):t.prototype.stop.call(this)},r.prototype.notifyMasterVolumeChanged=function(){this._gainNode.gain.value=this._calculateVolume()},r.prototype._onAudioEnded=function(){this._clearEndedEventHandler(),t.prototype.stop.call(this)},r.prototype._clearEndedEventHandler=function(){this._sourceNode&&(this._sourceNode.onended=null),null!=this._dummyDurationWaitTimer&&(clearTimeout(this._dummyDurationWaitTimer),this._dummyDurationWaitTimer=null)},r.prototype._calculateVolume=function(){return this._system._muted?0:this.volume*this._system.volume*this._manager.getMasterVolume()},r}(r.AudioPlayer);return rc.WebAudioPlayer=n,rc}(),o=function(){function t(){this._supportedFormats=[],this.supportedFormats=(0,e.detectSupportedFormats)(),i.setupChromeMEIWorkaround()}return t.isSupported=function(){return"AudioContext"in window||"webkitAudioContext"in window},Object.defineProperty(t.prototype,"supportedFormats",{get:function(){return this._supportedFormats},set:function(t){this._supportedFormats=t,r.WebAudioAsset.supportedFormats=t},enumerable:!1,configurable:!0}),t.prototype.createAsset=function(t,e,i,n,o,s,a){return new r.WebAudioAsset(t,e,i,n,o,s,a)},t.prototype.createPlayer=function(t,e){return new n.WebAudioPlayer(t,e)},t}();return qu.WebAudioPlugin=o,qu}return e({gameDriver:qs,akashicEngine:ua,pdiBrowser:"undefined"!=typeof window?ec?tc:(ec=1,Qu||(Qu=1,function(t){Object.defineProperty(t,"__esModule",{value:!0}),t.ProxyAudioPlugin=t.WebAudioPlugin=t.HTMLAudioPlugin=t.AudioPluginManager=t.AudioPluginRegistry=t.ResourceFactory=t.Platform=void 0;var e=_u();Object.defineProperty(t,"Platform",{enumerable:!0,get:function(){return e.Platform}});var r=Wa();Object.defineProperty(t,"AudioPluginRegistry",{enumerable:!0,get:function(){return r.AudioPluginRegistry}});var i=Ba();Object.defineProperty(t,"AudioPluginManager",{enumerable:!0,get:function(){return i.AudioPluginManager}});var n=Iu();Object.defineProperty(t,"HTMLAudioPlugin",{enumerable:!0,get:function(){return n.HTMLAudioPlugin}});var o=Hu();Object.defineProperty(t,"ProxyAudioPlugin",{enumerable:!0,get:function(){return o.ProxyAudioPlugin}});var s=ic();Object.defineProperty(t,"WebAudioPlugin",{enumerable:!0,get:function(){return s.WebAudioPlugin}});var a=fu();Object.defineProperty(t,"ResourceFactory",{enumerable:!0,get:function(){return a.ResourceFactory}})}(da)),tc=da):null})}));


	
		window.engineFiles = engineFilesV3_9_3;
		window.g = engineFiles.akashicEngine;
		(function() {
			var originalRequire = window.require;
			window.require = function(moduleName) {
				switch(moduleName) {
					case "@akashic/akashic-engine":
						return engineFiles.akashicEngine;
					default:
						return this.call(this, moduleName);
				}
			};
		})();
	

</script>

<script>
if (! ("optionProps" in window)) {
	window.optionProps = {};
}
window.optionProps.magnify = true

window.g = require("@akashic/akashic-engine");
</script>
<script>
if (! ("gLocalAssetContainer" in window)) {
	window.gLocalAssetContainer = {};
}

if (! ("__akashic__" in window)) {
	window.__akashic__ = {};
}


	
		window.gLocalAssetContainer["game.json"] = "{%0A%09%22width%22: 1280,%0A%09%22height%22: 720,%0A%09%22fps%22: 60,%0A%09%22main%22: %22./script/_bootstrap.js%22,%0A%09%22assets%22: {%0A%09%09%22_bootstrap%22: {%0A%09%09%09%22type%22: %22script%22,%0A%09%09%09%22path%22: %22files/1b69b90133980bf57115.js%22,%0A%09%09%09%22global%22: true,%0A%09%09%09%22virtualPath%22: %22script/_bootstrap.js%22%0A%09%09},%0A%09%09%22main%22: {%0A%09%09%09%22type%22: %22script%22,%0A%09%09%09%22path%22: %22files/0d75bfc2cf044a49e7a9.js%22,%0A%09%09%09%22global%22: true,%0A%09%09%09%22virtualPath%22: %22script/main.js%22%0A%09%09},%0A%09%09%22gameConfig%22: {%0A%09%09%09%22type%22: %22script%22,%0A%09%09%09%22path%22: %22files/9c34e6aba723d0b385ea.js%22,%0A%09%09%09%22global%22: true,%0A%09%09%09%22virtualPath%22: %22script/gameConfig.js%22%0A%09%09},%0A%09%09%22Hud%22: {%0A%09%09%09%22type%22: %22script%22,%0A%09%09%09%22path%22: %22files/3b9ec86f44bf936b89ce.js%22,%0A%09%09%09%22global%22: true,%0A%09%09%09%22virtualPath%22: %22script/Hud.js%22%0A%09%09},%0A%09%09%22MainScene%22: {%0A%09%09%09%22type%22: %22script%22,%0A%09%09%09%22path%22: %22files/6f1d3017319a65955977.js%22,%0A%09%09%09%22global%22: true,%0A%09%09%09%22virtualPath%22: %22script/MainScene.js%22%0A%09%09},%0A%09%09%22Paddle%22: {%0A%09%09%09%22type%22: %22script%22,%0A%09%09%09%22path%22: %22files/3eec3538149c20f7b32b.js%22,%0A%09%09%09%22global%22: true,%0A%09%09%09%22virtualPath%22: %22script/Paddle.js%22%0A%09%09},%0A%09%09%22Basket%22: {%0A%09%09%09%22type%22: %22script%22,%0A%09%09%09%22path%22: %22files/30399a4e7d4fc0bb55bf.js%22,%0A%09%09%09%22global%22: true,%0A%09%09%09%22virtualPath%22: %22script/Basket.js%22%0A%09%09},%0A%09%09%22Apple%22: {%0A%09%09%09%22type%22: %22script%22,%0A%09%09%09%22path%22: %22files/af5f1f9b8af31609c294.js%22,%0A%09%09%09%22global%22: true,%0A%09%09%09%22virtualPath%22: %22script/Apple.js%22%0A%09%09},%0A%09%09%22bgm%22: {%0A%09%09%09%22type%22: %22audio%22,%0A%09%09%09%22path%22: %22files/6e6ed82de3ca7cdfa409%22,%0A%09%09%09%22systemId%22: %22music%22,%0A%09%09%09%22duration%22: 78367,%0A%09%09%09%22hint%22: {%0A%09%09%09%09%22extensions%22: [%0A%09%09%09%09%09%22.aac%22,%0A%09%09%09%09%09%22.ogg%22%0A%09%09%09%09]%0A%09%09%09},%0A%09%09%09%22virtualPath%22: %22audio/bgm%22%0A%09%09},%0A%09%09%22scoreSound%22: {%0A%09%09%09%22type%22: %22audio%22,%0A%09%09%09%22path%22: %22files/daf0cee62e799324e788%22,%0A%09%09%09%22systemId%22: %22sound%22,%0A%09%09%09%22duration%22: 1090,%0A%09%09%09%22hint%22: {%0A%09%09%09%09%22extensions%22: [%0A%09%09%09%09%09%22.aac%22,%0A%09%09%09%09%09%22.ogg%22%0A%09%09%09%09]%0A%09%09%09},%0A%09%09%09%22virtualPath%22: %22audio/scoreSound%22%0A%09%09},%0A%09%09%22appleImage%22: {%0A%09%09%09%22type%22: %22image%22,%0A%09%09%09%22path%22: %22files/77fbbe707e309d6e1c9c.png%22,%0A%09%09%09%22width%22: 124,%0A%09%09%09%22height%22: 129,%0A%09%09%09%22virtualPath%22: %22image/appleImage.png%22%0A%09%09},%0A%09%09%22basketImage%22: {%0A%09%09%09%22type%22: %22image%22,%0A%09%09%09%22path%22: %22files/84720aa400035f44d979.png%22,%0A%09%09%09%22width%22: 231,%0A%09%09%09%22height%22: 256,%0A%09%09%09%22virtualPath%22: %22image/basketImage.png%22%0A%09%09},%0A%09%09%22paddleImage%22: {%0A%09%09%09%22type%22: %22image%22,%0A%09%09%09%22path%22: %22files/79c4fa23e2e0d7a48179.png%22,%0A%09%09%09%22width%22: 394,%0A%09%09%09%22height%22: 50,%0A%09%09%09%22virtualPath%22: %22image/paddleImage.png%22%0A%09%09},%0A%09%09%22bgImage%22: {%0A%09%09%09%22type%22: %22image%22,%0A%09%09%09%22path%22: %22files/0c22545d35df6adcc55d.png%22,%0A%09%09%09%22width%22: 640,%0A%09%09%09%22height%22: 360,%0A%09%09%09%22virtualPath%22: %22image/bgImage.png%22%0A%09%09},%0A%09%09%22hitSound%22: {%0A%09%09%09%22type%22: %22audio%22,%0A%09%09%09%22path%22: %22files/9496101a12e7cfe33a69%22,%0A%09%09%09%22systemId%22: %22sound%22,%0A%09%09%09%22duration%22: 1292,%0A%09%09%09%22hint%22: {%0A%09%09%09%09%22extensions%22: [%0A%09%09%09%09%09%22.aac%22,%0A%09%09%09%09%09%22.ogg%22%0A%09%09%09%09]%0A%09%09%09},%0A%09%09%09%22virtualPath%22: %22audio/hitSound%22%0A%09%09},%0A%09%09%22rpgatsumaru%22: {%0A%09%09%09%22type%22: %22script%22,%0A%09%09%09%22path%22: %22files/1ff73f8ed19e54984b9e.js%22,%0A%09%09%09%22global%22: true,%0A%09%09%09%22virtualPath%22: %22script/rpgatsumaru.js%22%0A%09%09},%0A%09%09%22a_e_z_0%22: {%0A%09%09%09%22type%22: %22script%22,%0A%09%09%09%22virtualPath%22: %22node_modules/@akashic-extension/akashic-box2d/lib/Box2D.js%22,%0A%09%09%09%22path%22: %22files/4d9cc66e803eecb6ce00.js%22,%0A%09%09%09%22global%22: true%0A%09%09},%0A%09%09%22a_e_z_1%22: {%0A%09%09%09%22type%22: %22script%22,%0A%09%09%09%22virtualPath%22: %22node_modules/@akashic-extension/akashic-box2d/lib/ContactManager.js%22,%0A%09%09%09%22path%22: %22files/446eff3e94f10ea90317.js%22,%0A%09%09%09%22global%22: true%0A%09%09},%0A%09%09%22a_e_z_2%22: {%0A%09%09%09%22type%22: %22script%22,%0A%09%09%09%22virtualPath%22: %22node_modules/@akashic-extension/akashic-box2d/lib/index.js%22,%0A%09%09%09%22path%22: %22files/0dcb090c6350b000aeaa.js%22,%0A%09%09%09%22global%22: true%0A%09%09},%0A%09%09%22a_e_z_3%22: {%0A%09%09%09%22type%22: %22script%22,%0A%09%09%09%22virtualPath%22: %22node_modules/@akashic-extension/akashic-box2d/lib/parameters.js%22,%0A%09%09%09%22path%22: %22files/7716b669c352c785bbf5.js%22,%0A%09%09%09%22global%22: true%0A%09%09},%0A%09%09%22a_e_z_4%22: {%0A%09%09%09%22type%22: %22script%22,%0A%09%09%09%22virtualPath%22: %22node_modules/@akashic-extension/akashic-box2d/patch/index.js%22,%0A%09%09%09%22path%22: %22files/cc82ae3bfe164c3af7c9.js%22,%0A%09%09%09%22global%22: true%0A%09%09},%0A%09%09%22a_e_z_5%22: {%0A%09%09%09%22type%22: %22script%22,%0A%09%09%09%22virtualPath%22: %22node_modules/@akashic-extension/akashic-box2d/patch/math.js%22,%0A%09%09%09%22path%22: %22files/f9290ada13ef582f311b.js%22,%0A%09%09%09%22global%22: true%0A%09%09},%0A%09%09%22a_e_z_6%22: {%0A%09%09%09%22type%22: %22script%22,%0A%09%09%09%22virtualPath%22: %22node_modules/@akashic-extension/akashic-box2d/patch/box2d.js%22,%0A%09%09%09%22path%22: %22files/ba3836213e3589817879.js%22,%0A%09%09%09%22global%22: true%0A%09%09},%0A%09%09%22a_e_z_7%22: {%0A%09%09%09%22type%22: %22script%22,%0A%09%09%09%22virtualPath%22: %22node_modules/box2dweb/box2d.js%22,%0A%09%09%09%22path%22: %22files/9f4ff958011415efcfa1.js%22,%0A%09%09%09%22global%22: true%0A%09%09}%0A%09},%0A%09%22environment%22: {%0A%09%09%22sandbox-runtime%22: %223%22,%0A%09%09%22nicolive%22: {%0A%09%09%09%22supportedModes%22: [%0A%09%09%09%09%22ranking%22%0A%09%09%09],%0A%09%09%09%22preferredSessionParameters%22: {%0A%09%09%09%09%22totalTimeLimit%22: 110%0A%09%09%09}%0A%09%09}%0A%09},%0A%09%22globalScripts%22: [],%0A%09%22moduleMainScripts%22: {%0A%09%09%22@akashic-extension/akashic-box2d%22: %22node_modules/@akashic-extension/akashic-box2d/lib/index.js%22,%0A%09%09%22box2dweb%22: %22node_modules/box2dweb/box2d.js%22%0A%09}%0A}";
	

	
		window.gLocalAssetContainer["_bootstrap"] = function(g) {
			(function(exports, require, module, __filename, __dirname) {
const main_1 = require("./main");
module.exports = (originalParam) => {
    const param = {};
    Object.keys(originalParam).forEach((key) => {
        param[key] = originalParam[key];
    });
    // セッションパラメーター
    param.sessionParameter = {};
    // 乱数生成器
    param.random = g.game.random;
    const limitTickToWait = 3; // セッションパラメーターが来るまでに待つtick数
    const scene = new g.Scene({
        game: g.game
    });
    // セッションパラメーターを受け取ってゲームを開始します
    scene.onMessage.add((msg) => {
        if (msg.data && msg.data.type === "start" && msg.data.parameters) {
            param.sessionParameter = msg.data.parameters; // sessionParameterフィールドを追加
            if (msg.data.parameters.randomSeed != null) {
                param.random = new g.XorshiftRandomGenerator(msg.data.parameters.randomSeed);
            }
            g.game.popScene();
            main_1.main(param);
        }
    });
    scene.onLoad.add(() => {
        let currentTickCount = 0;
        scene.onUpdate.add(() => {
            currentTickCount++;
            // 待ち時間を超えた場合はゲームを開始します
            if (currentTickCount > limitTickToWait) {
                g.game.popScene();
                main_1.main(param);
            }
        });
    });
    g.game.pushScene(scene);
};

})(g.module.exports, g.module.require, g.module, g.filename, g.dirname);

		};
	

	
		window.gLocalAssetContainer["main"] = function(g) {
			(function(exports, require, module, __filename, __dirname) {
"use strict";

/*
制作に使用したゲームエンジン
akashic-engine
Copyright (c) 2017 DWANGO Co., Ltd.
https://github.com/akashic-games/akashic-engine/blob/main/LICENSE
akashic-cli
Copyright (c) 2019 DWANGO Co., Ltd.
https://github.com/akashic-games/akashic-cli/blob/main/LICENSE
*/

const MainScene = require("./MainScene");
const gc = require("./gameConfig");
const box2dPatch = require("@akashic-extension/akashic-box2d/patch");
const RPGAtsumaru = require("./rpgatsumaru"); //アツマールAPIを導入

function main(param) {
    //アツマール変数
    const isAtsumaru = typeof window !== "undefined" && typeof window.RPGAtsumaru !== "undefined";
    console.log(isAtsumaru ? "RPGAtsumaruAPI is enabled" : "RPGAtsumaruAPI is disabled");
    //共通乱数
    let random = param.random;
    //デフォルトスコア値
    g.game.vars.gameState = {score: 0};

    //三角関数用パッチ適用
    box2dPatch.patchBox2DMath({
        tableSize: 8192,
        wholePeriod: true
    });

    g.game.pushScene(
        new MainScene(random, isAtsumaru)
    );
}

exports.main = main;
})(g.module.exports, g.module.require, g.module, g.filename, g.dirname);

		};
	

	
		window.gLocalAssetContainer["gameConfig"] = function(g) {
			(function(exports, require, module, __filename, __dirname) {
"use strcit";

const config = {
    box2d: {
        scale: 50,
        stepsPerFrame: 2
    },
    timeLimit: 90,
    droppingInterval: 2,
    numOfDroppingApples: 40,

    basket: {
        x: g.game.width / 2,
        y: g.game.height - 230,
        width: 145,
        height: 130,
        box2d: {
            friction: 0.5,
            restitution: 0
        }
    },
    paddle: {
        x: g.game.width / 2,
        y: g.game.height - 80,
        width: 150,
        height: 25,
        box2d: {
            density: 20,
            friction: 10,
            restitution: 0.9,
            mouseJoint: {
                maxForce: 1000000
            }
        }
    },
    apple: {
        size: 45,
        box2d: {
            density: 1,
            friction: 1,
            restitution: 0.8,
            linearDamping: 0.01,
            angularDamping: 0.05
        }
    }
}

module.exports = config;
})(g.module.exports, g.module.require, g.module, g.filename, g.dirname);

		};
	

	
		window.gLocalAssetContainer["Hud"] = function(g) {
			(function(exports, require, module, __filename, __dirname) {
"use strict";

const presetChars = "01234567789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ -+¥🕹️⏲️";

class Hud extends g.E {
    constructor(scene) {
        super({
            scene: scene
        });
        this._scene = scene;

        //フォント
        this._font = new g.DynamicFont({
            game: g.game,
            fontFamily: g.FontFamily.Monospace,
            fontColor: "white",
            //strokeColor: "black",
            //strokeWidth: 5,
            //fontWeight: "bold",
            size: 40,
            hint: {
                presetChars: presetChars
            }
        });

        //ラベル郡
        this._timeLabel = new g.Label({
            scene: scene,
            text: "0000",
            font: this._font,
            fontSize: this._font.size,
            x: g.game.width / 2,
            y: 30,
            anchorX: 0.5
        });
        this.append(this._timeLabel);

        this._scoreLabel = new g.Label({
            scene: scene,
            text: "0000",
            font: this._font,
            fontSize: this._font.size,
            x: g.game.width / 2,
            y: g.game.height/ 2,
            anchorX: 0.5
        });
        this.append(this._scoreLabel);

        //初期設定
        this.time = 0;
        this.score = 0;
    }

    set time(tmp) {
        let str = "";
        let min = Math.floor(tmp / 60);
        let second = Math.floor(tmp % 60);
        str += "" + ("00" + min).slice(-2) + ":" + ("00" + second).slice(-2);
        if(this._timeLabel.text !== str) {
            this._timeLabel.text = str;
            this._timeLabel.invalidate();
        }
    }

    set score(tmp) {
        let str = "";
        str += "" + tmp + "";
        if(this._scoreLabel.text !== str) {
            this._scoreLabel.text = str;
            this._scoreLabel.invalidate();
        }
    }
}

module.exports = Hud;
})(g.module.exports, g.module.require, g.module, g.filename, g.dirname);

		};
	

	
		window.gLocalAssetContainer["MainScene"] = function(g) {
			(function(exports, require, module, __filename, __dirname) {
"use strict";

const gc = require("./gameConfig");
const box2d = require("@akashic-extension/akashic-box2d");
const box2dPatch = require("@akashic-extension/akashic-box2d/patch");
const Paddle = require("./Paddle");
const Basket = require("./Basket");
const Apple = require("./Apple");
const Hud = require("./Hud");

class MainScene extends g.Scene {
    constructor(random, isAtsumaru) {
        super({
            game: g.game,
            assetIds: [
                "bgm", "scoreSound", "hitSound",
                "appleImage", "paddleImage", "basketImage", "bgImage"
            ]
        });

        this._random = random;
        this._isAtsumaru = isAtsumaru;

        this.loaded.addOnce( () => {
            this._setup();
        });

        this.update.add( () => {
            this._mainLoop();
        });
    }

    _setup() {
        //レイヤー生成
        this._bg = new g.Sprite({
            scene: this,
            src: this.assets["bgImage"],
            scaleX: g.game.width / this.assets["bgImage"].width,
            scaleY: g.game.height / this.assets["bgImage"].height
        });
        this._box2dBgLayer = new g.E({
            scene: this
        });
        this._box2dLayer = new g.E({
            scene: this
        });
        this._box2dFrontLayer = new g.E({
            scene: this
        });
        this._effectLayer = new g.E({
            scene: this
        });
        this._hudLayer = new g.E({
            scene: this
        });
        this.append(this._bg);
        this.append(this._box2dBgLayer);
        this.append(this._box2dLayer);
        this.append(this._box2dFrontLayer);
        this.append(this._effectLayer);
        this.append(this._hudLayer);

        this._controllerLayer = new g.E({
            scene: this,
            width: g.game.width,
            height: g.game.height,
            touchable: true
        });
        this.append(this._controllerLayer);

        //ゲームステート
        this._gameState = "finished";
        this._score = 0;
        this._gameTimer = 0;

        //データ管理
        this._apples = [];
        this._dropTimer = 0;
        this._dropCount = 0;

        //物理演算世界生成
        this._box2dWorld = new box2d.Box2D({
            gravity: [0, 9.8],
            scale: gc.box2d.scale,
            sleep: true
        });
        box2dPatch.patchBox2D(
            this._box2dWorld,
            {
                maxTOILoop: 10
            }
        );

        //衝突開始時の処理
        this._contactListener = new box2d.Box2DWeb.Dynamics.b2ContactListener;
        this._contactListener.BeginContact = (contact) => {
            let bodyA = contact.GetFixtureA().GetBody();
            let bodyB = contact.GetFixtureB().GetBody();
            let bodyAUserData = bodyA.GetUserData();
            let bodyBUserData = bodyB.GetUserData();
            //スコア加算
            if(
                bodyAUserData.type === "apple" && bodyBUserData.type === "goal" ||
                bodyAUserData.type === "goal" && bodyBUserData.type === "apple"
            ) {
                let appleBodyData;
                if(bodyAUserData.type === "apple") {
                    appleBodyData = bodyAUserData;
                }
                else {
                    appleBodyData = bodyBUserData;
                }
                if(!appleBodyData.destroyFlag) {
                    appleBodyData.destroyFlag = true;
                    this._score += 1;
                    this.assets["scoreSound"].play();
                }
            }
            if(
                bodyAUserData.type === "apple" && bodyBUserData.type === "paddle" ||
                bodyAUserData.type === "paddle" && bodyBUserData.type === "apple"
            ) {
                this.assets["hitSound"].play();
            }
        }
        this._box2dWorld.world.SetContactListener(this._contactListener);

        //Hud初期化
        this._hud = new Hud(this);
        this._hudLayer.append(this._hud);

        //バスケット初期化
        this._basket = new Basket(
            this, this.assets["basketImage"],
            this._box2dWorld,
            {x: gc.basket.x, y: gc.basket.y},
            gc.basket.width, gc.basket.height,
            gc.basket.box2d
        );
        this._box2dFrontLayer.append(this._basket.bg);
        /*
        this._basket.bodies.forEach( (body) => {
            this._box2dLayer.append(body.entity);
        });
        */

        //パドル初期化
        this._paddle = new Paddle(
            this, this.assets["paddleImage"],
            this._box2dWorld,
            {x: gc.paddle.x, y: gc.paddle.y},
            gc.paddle.width, gc.paddle.height,
            gc.paddle.box2d
        );
        this._box2dLayer.append(this._paddle.body.entity);

        //パドル操作
        this._controllerLayer.pointDown.add((ev) => {
            if(this._isAtsumaru) {
                if(this._gameState === "finished") {
                    this._initialize();
                }
            }
            this._paddle.mouseJoint.SetTarget(
                this._box2dWorld.vec2(
                    ev.point.x,
                    gc.paddle.y
                )
            );
        });
        this._controllerLayer.pointMove.add((ev) => {
            let x = ev.point.x + ev.startDelta.x;
            if(x < 0 + gc.paddle.width / 2) {
                x  = 0 + gc.paddle.width / 2;
            }
            else if(x > g.game.width - gc.paddle.width / 2) {
                x = g.game.width - gc.paddle.width / 2;
            }
            this._paddle.mouseJoint.SetTarget(
                this._box2dWorld.vec2(
                    x,
                    gc.paddle.y
                )
            );
        });

        //初期化
        this._initialize();
    }

    _initialize() {
        //ゲーム状態初期化
        this._gameState = "ready";
        this._score = 0;
        this._gameTimer = gc.timeLimit;
        this._dropTimer = 0;
        this._dropCount = 0;

        //アップル消去
        for(let apple of this._apples) {
            this._box2dWorld.removeBody(apple.body);
            apple.body.entity.destroy();
        }
        this._apples = [];

        //カウントダウン
        this.setTimeout( () => {
            this._gameState = "playing";
        }, 5000);

        //初回描画のため
        this._drawHud();

        //音楽
        this.assets["bgm"].play().changeVolume(0.2);
    }

    _mainLoop() {
        //時間更新
        if(this._gameState === "playing") {
            this._gameTimer -= 1 / g.game.fps;
            if(this._gameTimer <= 0)  {
                this._gameTimer = 0;
                this._gameState = "finished";
                //スコアボードセット
                if(this._isAtsumaru) {
                    console.log("atsumaru scoreboard");
                    window.RPGAtsumaru.scoreboards.setRecord(1, this._score)
                    .then(function() {
                        window.RPGAtsumaru.scoreboards.display(1);
                    })
                    .catch(function(error) {
                        console.error("スコアボードへの書き込み及び読み込みに失敗", error);
                    });
                }
            }
        }

        //物理演算更新
        if(this._gameState !== "finished") {
            const steps = gc.box2d.stepsPerFrame;
            for(let i = 0; i < steps; i++) {
                this._box2dWorld.step(1 / g.game.fps / steps);
            }
        }

        //アップルドロップ
        if(this._gameState === "playing" && this._dropCount < gc.numOfDroppingApples) {
            this._dropTimer -= 1 / g.game.fps;
            if(this._dropTimer <= 0) {
                this._dropTimer = gc.droppingInterval;
                this._dropCount++;
                //ドロップ
                let x;
                if(this._random.generate() < 0.5) {
                    x = gc.paddle.width + this._random.generate() *
                    (g.game.width / 2 - gc.paddle.width - gc.basket.width);
                }
                else {
                    x = g.game.width - gc.paddle.width - this._random.generate() *
                    (g.game.width / 2 - gc.paddle.width - gc.basket.width);
                }
                let apple = new Apple(
                    this, this.assets["appleImage"], this._box2dWorld,
                    {x: x, y: -50},
                    gc.apple.size, gc.apple.box2d
                );
                this._box2dLayer.append(apple.body.entity);
                this._apples.push(apple);
            }
        }

        //アップル管理
        for(let apple of this._apples) {
            if(
                apple.body.b2Body.GetUserData().destroyFlag ||
                apple.body.entity.y > g.game.height + 100
            ) {
                this._box2dWorld.removeBody(apple.body);
                apple.body.entity.destroy();
            }
        }
        this._apples = this._apples.filter( (apple) => {
            return !apple.body.entity.destroyed();
        });

        //スコア更新
        g.game.vars.gameState.score = this._score;

        //HUD更新
        this._drawHud();
    }

    _drawHud() {
        this._hud.time = this._gameTimer;
        this._hud.score = this._score;
    }
}

module.exports = MainScene;
})(g.module.exports, g.module.require, g.module, g.filename, g.dirname);

		};
	

	
		window.gLocalAssetContainer["Paddle"] = function(g) {
			(function(exports, require, module, __filename, __dirname) {
"use strict";

const box2d = require("@akashic-extension/akashic-box2d");

class Paddle {
    constructor(scene, imageAsset, box2dWorld, position, width, height, box2dOption) {
        this._scene = scene;
        this._box2dWorld = box2dWorld;

        //ボディ生成
        let entity = new g.Sprite({
            scene: scene,
            src: imageAsset,
            x: position.x,
            y: position.y,
            scaleX: width / imageAsset.width,
            scaleY: height / imageAsset.height,
            anchorX: 0.5,
            anchorY: 0.5,
            opacity: 1
        });
        let entityFixDef = box2dWorld.createFixtureDef({
            density: box2dOption.density,
            friction: box2dOption.friction,
            restitution: box2dOption.restitution,
            shape: box2dWorld.createRectShape(width, height),
            filter: {
                categoryBits: 0x0001,
                maskBits: 0x1111
            }
        });
        let entityDef = box2dWorld.createBodyDef({
            type: box2d.BodyType.Dynamic,
            fixedRotation: true,
            //gravityScale: 0,
            bullet: true,
            userData: {
                type: "paddle",
                objectData: this
            }
        });
        this._body = box2dWorld.createBody(entity, entityDef, entityFixDef);

        //宙に浮かせる
        /*
        this._body.b2Body.ApplyForce(
            this._box2dWorld.vec2(
                0,
                -this._body.b2Body.GetMass() * this._box2dWorld.scale * this._box2dWorld.world.GetGravity().y
            ),
            this._body.b2Body.GetPosition()
        );
        */

        //prismaticジョイント
        /*
        let prismaticJointDef = new box2d.Box2DWeb.Dynamics.Joints.b2PrismaticJointDef();
        prismaticJointDef.Initialize(
            box2dWorld.world.GetGroundBody(),
            this._body.b2Body,
            this._body.b2Body.GetPosition(),
            new box2d.Box2DWeb.Common.Math.b2Vec2(0, 1)
        );
        prismaticJointDef.enableLimit = true;
        prismaticJointDef.lowerTranslation = -0.0;
        prismaticJointDef.upperTranslation = 0.0;
        this._prismaticJoint = box2dWorld.world.CreateJoint(prismaticJointDef);
        */

        //マウス操作用
        let mouseJointDef = new box2d.Box2DWeb.Dynamics.Joints.b2MouseJointDef();
        mouseJointDef.bodyA = box2dWorld.world.GetGroundBody();
        mouseJointDef.bodyB = this._body.b2Body;
        mouseJointDef.collideConnected = true;
        mouseJointDef.maxForce = box2dOption.mouseJoint.maxForce;
        mouseJointDef.target = box2dWorld.vec2(position.x, position.y);
        this._mouseJoint = box2dWorld.world.CreateJoint(mouseJointDef);
    }

    get body() {
        return this._body;
    }

    get mouseJoint () {
        return this._mouseJoint;
    }
}

module.exports = Paddle;
})(g.module.exports, g.module.require, g.module, g.filename, g.dirname);

		};
	

	
		window.gLocalAssetContainer["Basket"] = function(g) {
			(function(exports, require, module, __filename, __dirname) {
"use strict";

const box2d = require("@akashic-extension/akashic-box2d");

const wallThickness = 10;

class Basket {
    constructor(scene, imageAsset, box2dWorld, position, width, height, box2dOption) {
        this._scene = scene;
        this._box2dWorld = box2dWorld;

        //背景描画
        this._bg = new g.Sprite({
            scene: scene,
            src: imageAsset,
            x: position.x,
            y: position.y,
            scaleX: width / imageAsset.width,
            scaleY: height / imageAsset.height,
            anchorX: 0.5,
            anchorY: 0.5,
            opacity: 1
        });

        //ボディ生成
        this._bodies = [];
        this._bodies.push(
            this._createBody(
                scene, box2dWorld,
                position.x - width / 2 + wallThickness / 2, position.y,
                wallThickness, height,
                box2dOption.friction, box2dOption.restitution, false
            )
        );
        this._bodies.push(
            this._createBody(
                scene, box2dWorld,
                position.x + width / 2 - wallThickness / 2, position.y,
                wallThickness, height,
                box2dOption.friction, box2dOption.restitution, false
            )
        );
        this._bodies.push(
            this._createBody(
                scene, box2dWorld,
                position.x, position.y + height / 2 - wallThickness / 2,
                width, wallThickness,
                box2dOption.friction, box2dOption.restitution, false
            )
        );
        this._bodies.push(
            this._createBody(
                scene, box2dWorld,
                position.x, position.y + height / 2 - wallThickness / 2 * 3,
                width - wallThickness * 2, wallThickness,
                box2dOption.friction, box2dOption.restitution, true
            )
        );
    }

    get bg() {
        return this._bg;
    }

    get bodies() {
        return this._bodies;
    }

    _createBody(scene, box2dWorld, x, y, width, height, friction, restitution, isScoreBody) {
        let entity = new g.FilledRect({
            scene: scene,
            x: x,
            y: y,
            width: width,
            height: height,
            anchorX: 0.5,
            anchorY: 0.5,
            cssColor: isScoreBody ? "red" : "white"
        });
        let entityFixDef = box2dWorld.createFixtureDef({
            density: 1,
            friction: friction,
            restitution: restitution,
            shape: box2dWorld.createRectShape(width, height),
            filter: {
                categoryBits: 0x0001,
                maskBits: 0x1111
            }
        });
        let entityDef = box2dWorld.createBodyDef({
            type: box2d.BodyType.Static,
            bullet: false,
            userData: {
                type: isScoreBody ? "goal" : "basket",
                objectData: this
            }
        });
        let body = box2dWorld.createBody(entity, entityDef, entityFixDef);
        return body;
    }
}

module.exports = Basket;
})(g.module.exports, g.module.require, g.module, g.filename, g.dirname);

		};
	

	
		window.gLocalAssetContainer["Apple"] = function(g) {
			(function(exports, require, module, __filename, __dirname) {
"use strict";

const box2d = require("@akashic-extension/akashic-box2d");

class Apple {
    constructor(scene, imageAsset, box2dWorld, position, size, box2dOption) {
        this._scene = scene;
        this._box2dWorld = box2dWorld;

        //ボディ生成
        let entity = new g.Sprite({
            scene: scene,
            src: imageAsset,
            x: position.x,
            y: position.y,
            scaleX: size / imageAsset.width,
            scaleY: size / imageAsset.height,
            anchorX: 0.5,
            anchorY: 0.5,
            opacity: 1
        });
        let entityFixDef = box2dWorld.createFixtureDef({
            density: box2dOption.density,
            friction: box2dOption.friction,
            restitution: box2dOption.restitution,
            shape: box2dWorld.createCircleShape(size),
            filter: {
                categoryBits: 0x0010,
                maskBits: 0x1101
            }
        });
        let entityDef = box2dWorld.createBodyDef({
            type: box2d.BodyType.Dynamic,
            bullet: true,
            linearDamping: box2dOption.linearDamping,
            angularDamping: box2dOption.angularDamping,
            userData: {
                type: "apple",
                objectData: this,
                destroyFlag: false
            }
        });
        this._body = box2dWorld.createBody(entity, entityDef, entityFixDef);
    }

    get body() {
        return this._body;
    }
}

module.exports = Apple;
})(g.module.exports, g.module.require, g.module, g.filename, g.dirname);

		};
	

	
		window.gLocalAssetContainer["rpgatsumaru"] = function(g) {
			(function(exports, require, module, __filename, __dirname) {
window.RPGAtsumaru = {
  scoreboards: {
    setRecord: function (recordKey, recordValue) {
      console.log("setRecord");
      return new Promise(function (resolve, reject) {
        // postmessageで親ウィンドウにデータを送信する
        window.parent.postMessage(
          {
            type: "setRecord",
            key: recordKey,
            value: recordValue,
          },
          "*"
        );

        // 親ウィンドウからのメッセージを受信する
        function receiveMessage(event) {
          if (
            event.source === window.parent &&
            event.data.type === "setRecordResponse"
          ) {
            console.log(event.data.message);
            window.removeEventListener("message", receiveMessage);
            resolve();
          }
        }
        window.addEventListener("message", receiveMessage);

        // タイムアウト処理
        setTimeout(function () {
          window.removeEventListener("message", receiveMessage);
          reject(new Error("timeout"));
        }, 5000); // 5秒でタイムアウト
      });
    },
    display: function (recordKey) {
      // postmessageで親ウィンドウにデータを送信する
      window.parent.postMessage(
        {
          type: "display",
          key: recordKey,
        },
        "*"
      );
    },
  },
};

})(g.module.exports, g.module.require, g.module, g.filename, g.dirname);

		};
	

	
		window.gLocalAssetContainer["a_e_z_0"] = function(g) {
			(function(exports, require, module, __filename, __dirname) {
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.Box2D = void 0;
var box2dweb = require("box2dweb");
/**
 * AkashicのエンティティをBox2DWebのb2Worldに追加し、演算結果をエンティティに反映するクラス。
 */
var Box2D = /** @class */ (function () {
    /**
     * `Box2D` のインスタンスを生成する。
     * @param param `b2World` の生成オプション
     */
    function Box2D(param) {
        /**
         * このクラスが保持する `EBody` のリスト。
         */
        this.bodies = [];
        this._createBodyCount = 0;
        // オブジェクト生成を減らすためのキャッシュ
        this._matrix = new g.PlainMatrix();
        if (param.gravity == null) {
            throw g.ExceptionFactory.createAssertionError("Missing parameter: gravity");
        }
        if (param.scale == null) {
            throw g.ExceptionFactory.createAssertionError("Missing parameter: scale");
        }
        var sleep = param.sleep != null ? !!param.sleep : true;
        var b2world = new box2dweb.Dynamics.b2World(new box2dweb.Common.Math.b2Vec2(param.gravity[0], param.gravity[1]), sleep);
        this.scale = param.scale;
        this.world = b2world;
    }
    /**
     * このクラスにボディを追加し、その `EBody` を返す。
     * すでに同エンティティが追加されている場合は何もせず `null` を返す。
     * エンティティのアンカーポイントが (0.5, 0.5) に指定される点に注意。
     * @param entity 対象のエンティティ
     * @param bodyDef 対象のb2BodyDef
     * @param fixtureDef 対象のb2FixtureDefまたは対象のb2FixtureDefの配列
     */
    Box2D.prototype.createBody = function (entity, bodyDef, fixtureDef) {
        for (var i = 0; i < this.bodies.length; i++) {
            if (this.bodies[i].entity === entity) {
                return null;
            }
        }
        var fixtureDefs = Array.isArray(fixtureDef) ? fixtureDef : [fixtureDef];
        var b2Body = this.world.CreateBody(bodyDef);
        for (var i = 0; i < fixtureDefs.length; i++) {
            b2Body.CreateFixture(fixtureDefs[i]);
        }
        if (entity.anchorX !== 0.5 || entity.anchorY !== 0.5) {
            var m = this._matrix;
            var e = entity;
            m.update(e.width, e.height, e.scaleX, e.scaleY, e.angle, e.x, e.y, e.anchorX, e.anchorY);
            var _a = m.multiplyPoint({ x: e.width / 2, y: e.height / 2 }), x = _a.x, y = _a.y;
            e.x = x;
            e.y = y;
            e.anchorX = 0.5;
            e.anchorY = 0.5;
        }
        b2Body.SetPositionAndAngle(this.vec2(entity.x, entity.y), this.radian(entity.angle));
        b2Body.SetUserData(bodyDef.userData != null ? bodyDef.userData : entity.id);
        var body = {
            id: "".concat(this._createBodyCount++),
            entity: entity,
            b2Body: b2Body
        };
        this.bodies.push(body);
        return body;
    };
    /**
     * このクラスに追加された `EBody` を削除する。
     * @param ebody 削除する `EBody`
     */
    Box2D.prototype.removeBody = function (ebody) {
        var index = this.bodies.indexOf(ebody);
        if (index === -1) {
            return;
        }
        this.world.DestroyBody(ebody.b2Body);
        this.bodies.splice(index, 1);
    };
    /**
     * エンティティからこのクラスに追加されている `EBody` を返す。
     * @param entity エンティティ
     */
    Box2D.prototype.getEBodyFromEntity = function (entity) {
        for (var i = 0; i < this.bodies.length; i++) {
            if (this.bodies[i].entity === entity) {
                return this.bodies[i];
            }
        }
        return null;
    };
    /**
     * `b2Body` からこのクラスに追加されている `EBody` を返す。
     * @param b2Body b2Body
     */
    Box2D.prototype.getEBodyFromb2Body = function (b2Body) {
        for (var i = 0; i < this.bodies.length; i++) {
            if (this.bodies[i].b2Body === b2Body) {
                return this.bodies[i];
            }
        }
        return null;
    };
    /**
     * このクラスのインスタンスを破棄する。
     */
    Box2D.prototype.destroy = function () {
        this.world = undefined;
        this.bodies = undefined;
    };
    /**
     * このクラスのインスタンスが破棄済みであるかを返す。
     */
    Box2D.prototype.destroyed = function () {
        return this.world === undefined;
    };
    /**
     * 時間を経過させ、このクラスに追加されたエンティティの座標と角度を変更する。
     * このメソッドは暗黙的に `E#modified()` を呼び出している。
     * @param dt 経過させる時間単位
     * @param velocityIteration 速度演算のイテレーション回数 省略時は10
     * @param positionIteration 位置演算のイテレーション回数 省略時は10
     */
    Box2D.prototype.step = function (dt, velocityIteration, positionIteration) {
        if (velocityIteration === void 0) { velocityIteration = 10; }
        if (positionIteration === void 0) { positionIteration = 10; }
        this.world.Step(dt, velocityIteration, positionIteration);
        this.stepBodies();
    };
    /**
     * ボディ同士の接触を、Box2DWebのユーザデータを参照して検出する。
     * @param body1 対象のボディ
     * @param body2 対象のボディ
     * @param contact 対象のb2Contacts
     */
    Box2D.prototype.isContact = function (body1, body2, contact) {
        var bodyA = contact.GetFixtureA().GetBody().GetUserData();
        var bodyB = contact.GetFixtureB().GetBody().GetUserData();
        if ((body1.b2Body.GetUserData() === bodyA && body2.b2Body.GetUserData() === bodyB)
            || (body1.b2Body.GetUserData() === bodyB && body2.b2Body.GetUserData() === bodyA)) {
            return true;
        }
        return false;
    };
    /**
     * 長方形を表す `b2PolygonShape` インスタンスを生成する。
     * @param width 横幅 px
     * @param height 縦幅 px
     */
    Box2D.prototype.createRectShape = function (width, height) {
        var shape = new box2dweb.Collision.Shapes.b2PolygonShape();
        shape.SetAsBox(width / (this.scale * 2), height / (this.scale * 2));
        return shape;
    };
    /**
     * 円を表す `b2CircleShape` インスタンスを生成する。
     * @param diameter 直径 px
     */
    Box2D.prototype.createCircleShape = function (diameter) {
        return new box2dweb.Collision.Shapes.b2CircleShape((diameter / 2) / this.scale);
    };
    /**
     * 任意の多角形を表す `b2PolygonShape` インスタンスを生成する。
     * @param vertices[] 各頂点の `b2Vec2` 配列
     */
    Box2D.prototype.createPolygonShape = function (vertices) {
        var shape = new box2dweb.Collision.Shapes.b2PolygonShape();
        shape.SetAsArray(vertices, vertices.length);
        return shape;
    };
    /**
     * b2FixtureDefインスタンスを生成する。
     * @param fixtureOption FixtureOption
     */
    Box2D.prototype.createFixtureDef = function (fixtureDef) {
        var def = new box2dweb.Dynamics.b2FixtureDef();
        if (fixtureDef.shape != null) {
            def.shape = fixtureDef.shape;
        }
        if (fixtureDef.density != null) {
            def.density = fixtureDef.density;
        }
        if (fixtureDef.friction != null) {
            def.friction = fixtureDef.friction;
        }
        if (fixtureDef.restitution != null) {
            def.restitution = fixtureDef.restitution;
        }
        if (fixtureDef.isSensor != null) {
            def.isSensor = fixtureDef.isSensor;
        }
        if (fixtureDef.userData != null) {
            def.userData = fixtureDef.userData;
        }
        var opt = fixtureDef.filter;
        if (opt) {
            def.filter.categoryBits = opt.categoryBits;
            def.filter.maskBits = opt.maskBits;
            if (opt.groupIndex != null) {
                def.filter.groupIndex = opt.groupIndex;
            }
        }
        return def;
    };
    /**
     * `b2BodyDef` インスタンスを生成する。
     * @param bodyDef Box2DBodyDef
     */
    Box2D.prototype.createBodyDef = function (bodyDef) {
        var def = new box2dweb.Dynamics.b2BodyDef();
        if (bodyDef.type != null) {
            def.type = bodyDef.type;
        }
        if (bodyDef.angularDamping != null) {
            def.angularDamping = bodyDef.angularDamping;
        }
        if (bodyDef.angularVelocity != null) {
            def.angularVelocity = bodyDef.angularVelocity;
        }
        if (bodyDef.linearDamping != null) {
            def.linearDamping = bodyDef.linearDamping;
        }
        if (bodyDef.linearDamping != null) {
            def.linearDamping = bodyDef.linearDamping;
        }
        if (bodyDef.active != null) {
            def.active = bodyDef.active;
        }
        if (bodyDef.allowSleep != null) {
            def.allowSleep = bodyDef.allowSleep;
        }
        if (bodyDef.awake != null) {
            def.awake = bodyDef.awake;
        }
        if (bodyDef.bullet != null) {
            def.bullet = bodyDef.bullet;
        }
        if (bodyDef.fixedRotation != null) {
            def.fixedRotation = bodyDef.fixedRotation;
        }
        if (bodyDef.userData != null) {
            def.userData = bodyDef.userData;
        }
        return def;
    };
    /**
     * ラジアンを度に変換する。
     * @param radian 対象のラジアン
     */
    Box2D.prototype.degree = function (radian) {
        return radian * 180 / Math.PI;
    };
    /**
     * 度をラジアンに変換する。
     * @param degree 対象の度
     */
    Box2D.prototype.radian = function (degree) {
        return degree * Math.PI / 180;
    };
    /**
     * この物理エンジン世界のビクセルスケールに変換した `b2Vec2` インスタンスを生成する。
     * @param x x方向のピクセル値
     * @param y y方向のピクセル値
     */
    Box2D.prototype.vec2 = function (x, y) {
        return new box2dweb.Common.Math.b2Vec2(x / this.scale, y / this.scale);
    };
    Box2D.prototype.stepBodies = function () {
        for (var i = 0; i < this.bodies.length; i++) {
            var b2Body = this.bodies[i].b2Body;
            var entity = this.bodies[i].entity;
            if (entity.destroyed()) {
                continue;
            }
            var pos = b2Body.GetPosition();
            entity.anchorX = 0.5;
            entity.anchorY = 0.5;
            entity.x = pos.x * this.scale;
            entity.y = pos.y * this.scale;
            entity.angle = this.degree(b2Body.GetAngle());
            entity.modified();
        }
    };
    return Box2D;
}());
exports.Box2D = Box2D;

})(g.module.exports, g.module.require, g.module, g.filename, g.dirname);

		};
	

	
		window.gLocalAssetContainer["a_e_z_1"] = function(g) {
			(function(exports, require, module, __filename, __dirname) {
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.ContactManager = void 0;
var box2dweb = require("box2dweb");
/**
 * 衝突判定を管理するクラス。
 */
var ContactManager = /** @class */ (function () {
    /**
     * `ContactManager` のインスタンスを生成する。
     * @param param `ContactManager` の生成オプション
     */
    function ContactManager(param) {
        var _this = this;
        this._beginContactTriggerMap = {};
        this._endContactTriggerMap = {};
        this.box2d = param.box2d;
        var contactListener = new box2dweb.Dynamics.b2ContactListener();
        contactListener.BeginContact = function (contact) {
            var bodyA = _this.box2d.getEBodyFromb2Body(contact.GetFixtureA().GetBody());
            if (bodyA == null) {
                return;
            }
            var bodyB = _this.box2d.getEBodyFromb2Body(contact.GetFixtureB().GetBody());
            if (bodyB == null) {
                return;
            }
            var id1 = "".concat(bodyA.id, "-").concat(bodyB.id);
            var id2 = "".concat(bodyB.id, "-").concat(bodyA.id);
            var trigger1 = _this._beginContactTriggerMap[id1];
            var trigger2 = _this._beginContactTriggerMap[id2];
            if (trigger1 && !trigger1.destroyed()) {
                trigger1.fire();
            }
            else if (trigger2 && !trigger2.destroyed()) {
                trigger2.fire();
            }
        };
        contactListener.EndContact = function (contact) {
            var bodyA = _this.box2d.getEBodyFromb2Body(contact.GetFixtureA().GetBody());
            if (bodyA == null) {
                return;
            }
            var bodyB = _this.box2d.getEBodyFromb2Body(contact.GetFixtureB().GetBody());
            if (bodyB == null) {
                return;
            }
            var id1 = "".concat(bodyA.id, "-").concat(bodyB.id);
            var id2 = "".concat(bodyB.id, "-").concat(bodyA.id);
            var trigger1 = _this._endContactTriggerMap[id1];
            var trigger2 = _this._endContactTriggerMap[id2];
            if (trigger1 && !trigger1.destroyed()) {
                trigger1.fire();
            }
            else if (trigger2 && !trigger2.destroyed()) {
                trigger2.fire();
            }
        };
        this.box2d.world.SetContactListener(contactListener);
    }
    /**
     * このクラスのインスタンスを破棄する。
     */
    ContactManager.prototype.destroy = function () {
        var _this = this;
        this.box2d = undefined;
        Object.keys(this._beginContactTriggerMap).forEach(function (k) {
            _this._beginContactTriggerMap[k].destroy();
        });
        this._beginContactTriggerMap = undefined;
        Object.keys(this._endContactTriggerMap).forEach(function (k) {
            _this._endContactTriggerMap[k].destroy();
        });
        this._beginContactTriggerMap = undefined;
    };
    /**
     * このクラスのインスタンスが破棄済みであるかを返す。
     */
    ContactManager.prototype.destroyed = function () {
        return this.box2d === undefined;
    };
    /**
     * `EBody` 同士の接触開始を検出する `g.Trigger` を生成する。
     * @param bodyA 対象のボディ
     * @param bodyB 対象のボディ
     */
    ContactManager.prototype.createBeginContactTrigger = function (bodyA, bodyB) {
        var id = "".concat(bodyA.id, "-").concat(bodyB.id);
        var trigger = this._beginContactTriggerMap[id];
        if (trigger) {
            return trigger;
        }
        else {
            this._beginContactTriggerMap[id] = new g.Trigger();
            return this._beginContactTriggerMap[id];
        }
    };
    /**
     * `EBody` 同士の接触開始を検出する `g.Trigger` を削除する。
     * @param bodyA 対象のボディ
     * @param bodyB 対象のボディ
     */
    ContactManager.prototype.removeBeginContactTrigger = function (bodyA, bodyB) {
        var idA = bodyA.id;
        var idB = bodyB.id;
        var id1 = "".concat(idA, "-").concat(idB);
        var id2 = "".concat(idB, "-").concat(idA);
        if (this._beginContactTriggerMap[id1]) {
            var trigger = this._beginContactTriggerMap[id1];
            if (!trigger.destroyed()) {
                trigger.destroy();
            }
            delete this._beginContactTriggerMap[id1];
            return true;
        }
        else if (this._beginContactTriggerMap[id2]) {
            var trigger = this._beginContactTriggerMap[id2];
            if (!trigger.destroyed()) {
                trigger.destroy();
            }
            delete this._beginContactTriggerMap[id2];
            return true;
        }
        return false;
    };
    /**
     * `EBody` 同士の接触終了を検出する `g.Trigger` を生成する。
     * @param bodyA 対象のボディ
     * @param bodyB 対象のボディ
     */
    ContactManager.prototype.createEndContactTrigger = function (bodyA, bodyB) {
        var id = "".concat(bodyA.id, "-").concat(bodyB.id);
        var trigger = this._endContactTriggerMap[id];
        if (trigger) {
            return trigger;
        }
        else {
            this._endContactTriggerMap[id] = new g.Trigger();
            return this._endContactTriggerMap[id];
        }
    };
    /**
     * `EBody` 同士の接触終了を検出する `g.Trigger` を削除する。
     * @param bodyA 対象のボディ
     * @param bodyB 対象のボディ
     */
    ContactManager.prototype.removeEndContactTrigger = function (bodyA, bodyB) {
        var idA = bodyA.id;
        var idB = bodyB.id;
        var id1 = "".concat(idA, "-").concat(idB);
        var id2 = "".concat(idB, "-").concat(idA);
        if (this._endContactTriggerMap[id1]) {
            var trigger = this._endContactTriggerMap[id1];
            if (!trigger.destroyed()) {
                trigger.destroy();
            }
            delete this._endContactTriggerMap[id1];
            return true;
        }
        else if (this._endContactTriggerMap[id2]) {
            var trigger = this._endContactTriggerMap[id2];
            if (!trigger.destroyed()) {
                trigger.destroy();
            }
            delete this._endContactTriggerMap[id2];
            return true;
        }
        return false;
    };
    return ContactManager;
}());
exports.ContactManager = ContactManager;

})(g.module.exports, g.module.require, g.module, g.filename, g.dirname);

		};
	

	
		window.gLocalAssetContainer["a_e_z_2"] = function(g) {
			(function(exports, require, module, __filename, __dirname) {
"use strict";
// tslint:disable-next-line:no-reference
/// <reference path="../typings/box2dweb.d.ts"/>
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    Object.defineProperty(o, k2, { enumerable: true, get: function() { return m[k]; } });
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __exportStar = (this && this.__exportStar) || function(m, exports) {
    for (var p in m) if (p !== "default" && !Object.prototype.hasOwnProperty.call(exports, p)) __createBinding(exports, m, p);
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.Box2DWeb = void 0;
var Box2DWeb = require("box2dweb");
exports.Box2DWeb = Box2DWeb;
__exportStar(require("./Box2D"), exports);
__exportStar(require("./ContactManager"), exports);
__exportStar(require("./parameters"), exports);

})(g.module.exports, g.module.require, g.module, g.filename, g.dirname);

		};
	

	
		window.gLocalAssetContainer["a_e_z_3"] = function(g) {
			(function(exports, require, module, __filename, __dirname) {
"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.BodyType = void 0;
var box2dweb = require("box2dweb");
/**
 * ボディタイプの定義。
 */
var BodyType;
(function (BodyType) {
    /**
     * 静的物体。
     */
    BodyType[BodyType["Static"] = box2dweb.Dynamics.b2Body.b2_staticBody] = "Static";
    /**
     * キネマティック物体。
     */
    BodyType[BodyType["Kinematic"] = box2dweb.Dynamics.b2Body.b2_kinematicBody] = "Kinematic";
    /**
     * 動的物体。
     */
    BodyType[BodyType["Dynamic"] = box2dweb.Dynamics.b2Body.b2_dynamicBody] = "Dynamic";
})(BodyType = exports.BodyType || (exports.BodyType = {}));

})(g.module.exports, g.module.require, g.module, g.filename, g.dirname);

		};
	

	
		window.gLocalAssetContainer["a_e_z_4"] = function(g) {
			(function(exports, require, module, __filename, __dirname) {
var math = require("./math");
var box2d = require("./box2d");

module.exports = {
    patchBox2D: box2d.patchBox2D,
    patchBox2DMath: math.patchBox2DMath
};

})(g.module.exports, g.module.require, g.module, g.filename, g.dirname);

		};
	

	
		window.gLocalAssetContainer["a_e_z_5"] = function(g) {
			(function(exports, require, module, __filename, __dirname) {
var b2 = require("box2dweb");

function patchBox2DMath(opts) {
    opts = opts || {};
    opts.tableSize = typeof opts.tableSize === "number" ? opts.tableSize : 8192 * 4;
    opts.wholePeriod = opts.wholePeriod === undefined ? true : !!opts.wholePeriod;

    var arrayType = typeof Float32Array !== "undefined" ? Float32Array : Array;

    function setupSinTable(arr, angleRange) {
        var reso = arr.length;

        // Math.sin() との差の絶対値の最大値:
        // * iterNum=10: 5.551115123125783e-16
        // * iterNum= 5: 5.551115123125783e-16
        // * iterNum= 4: 4.374278717023117e-14
        function sin(x) {
            var iterNum = 5;
            var minus_x_squared = -x * x;
            var s = 1;
            var n = 0;
            var term = 1;

            for (var i = 1; i <= 2 * iterNum; i++) {
                n = n + 2;
                term = term * minus_x_squared / (n * (n + 1));
                s = s + term;
            }

            s = x * s;

            return s;
        }

        var factor = angleRange / (reso - 1);
        for (var i = 0; i < reso; i++) {
            arr[i] = sin(factor * i);
        }

        return arr;
    }

    function LutMath() {
        var angleRange = opts.wholePeriod ? Math.PI * 2 : Math.PI / 2;
        this.PI2 = Math.PI * 2;
        this.factor = (opts.tableSize - 1) / angleRange;
        this.sinTable = setupSinTable(new arrayType(opts.tableSize), angleRange);
    }

    LutMath.prototype.sin = opts.wholePeriod ? function(th) {
        th %= this.PI2;
        if (th < 0) {
            th += this.PI2;
        }
        return this.sinTable[(th * this.factor) | 0];
    } : function(th) {
        th %= this.PI2;
        if (th < 0) {
            th += this.PI2;
        }

        var sign = 1;
        if (th > Math.PI) {
            th -= Math.PI;
            sign = -1;
        }

        var idx = (th * this.factor) | 0;
        if (idx > this.sinTable.length - 1) {
            idx = (this.sinTable.length - 1) * 2 - idx;
        }

        return sign * this.sinTable[idx];
    };

    LutMath.prototype.cos = function(th) {
        return this.sin(th + Math.PI / 2);
    };

    b2.Common.Math.b2Mat22.prototype.__lutmath = new LutMath();

    // override
    b2.Common.Math.b2Mat22.prototype.Set = function(angle) {
        if (angle === undefined) angle = 0;
        var c = this.__lutmath.cos(angle);
        var s = this.__lutmath.sin(angle);
        this.col1.x = c;
        this.col2.x = (-s);
        this.col1.y = s;
        this.col2.y = c;
    };
}

module.exports = {
    patchBox2DMath: patchBox2DMath
};

})(g.module.exports, g.module.require, g.module, g.filename, g.dirname);

		};
	

	
		window.gLocalAssetContainer["a_e_z_6"] = function(g) {
			(function(exports, require, module, __filename, __dirname) {
/*
 * This file is based on box2dweb (https://github.com/mikolalysenko/box2dweb)
 * which is released under the following license.
 */

/*
 * Copyright (c) 2006-2007 Erin Catto http://www.gphysics.com
 *
 * This software is provided 'as-is', without any express or implied
 * warranty.  In no event will the authors be held liable for any damages
 * arising from the use of this software.
 * Permission is granted to anyone to use this software for any purpose,
 * including commercial applications, and to alter it and redistribute it
 * freely, subject to the following restrictions:
 * 1. The origin of this software must not be misrepresented; you must not
 * claim that you wrote the original software. If you use this software
 * in a product, an acknowledgment in the product documentation would be
 * appreciated but is not required.
 * 2. Altered source versions must be plainly marked as such, and must not be
 * misrepresented as being the original software.
 * 3. This notice may not be removed or altered from any source distribution.
 */

var b2 = require("box2dweb");

function patchBox2D(box2d, opts) {
    opts = opts || {};
    var maxTOILoop = typeof opts.maxTOILoop === "number" ? opts.maxTOILoop : (Number.MAX_SAFE_INTEGER || 9007199254740991);

    // https://www.ecma-international.org/ecma-262/6.0/#sec-number.epsilon
    var EPSILON = 2.2204460492503130808472633361816e-16;

    var b2Settings = b2.Common.b2Settings,
        b2Body = b2.Dynamics.b2Body,
        b2World = b2.Dynamics.b2World,
        b2Contact = b2.Dynamics.Contacts.b2Contact;

    // alter https://github.com/mikolalysenko/box2dweb/blob/87ba08d7fc7cdd15235cb6c8bd79f24a92874198/box2d.js#L6271
    box2d.world.SolveTOI = function (step) {
        var b;
        var fA;
        var fB;
        var bA;
        var bB;
        var cEdge;
        var j;
        var island = this.m_island;
        island.Initialize(this.m_bodyCount, b2Settings.b2_maxTOIContactsPerIsland, b2Settings.b2_maxTOIJointsPerIsland, null, this.m_contactManager.m_contactListener, this.m_contactSolver);
        var queue = b2World.s_queue;
        for (b = this.m_bodyList; b; b = b.m_next) {
            b.m_flags &= ~b2Body.e_islandFlag;
            b.m_sweep.t0 = 0.0;
        }
        var c;
        for (c = this.m_contactList; c; c = c.m_next) {
            c.m_flags &= ~(b2Contact.e_toiFlag | b2Contact.e_islandFlag);
        }
        for (j = this.m_jointList; j; j = j.m_next) {
            j.m_islandFlag = false;
        }

        // 物理計算を中断するためのカウンタを追加。
        // 物理計算のためにフレームレートが低下するケースに対処できるよう、
        // 最大ループ回数を導入する。
        //
        // 修正前:
        //   for (;;) {
        // 修正後:
        //   for (var toiLoopCount = 0; toiLoopCount < maxTOILoop; ++toiLoopCount) {
        for (var toiLoopCount = 0; toiLoopCount < maxTOILoop; ++toiLoopCount) {

            var minContact = null;
            var minTOI = 1.0;
            for (c = this.m_contactList; c; c = c.m_next) {
                if (c.IsSensor() == true || c.IsEnabled() == false || c.IsContinuous() == false) {
                    continue;
                }
                var toi = 1.0;
                if (c.m_flags & b2Contact.e_toiFlag) {
                    toi = c.m_toi;
                } else {
                    fA = c.m_fixtureA;
                    fB = c.m_fixtureB;
                    bA = fA.m_body;
                    bB = fB.m_body;
                    if ((bA.GetType() != b2Body.b2_dynamicBody || bA.IsAwake() == false) && (bB.GetType() != b2Body.b2_dynamicBody || bB.IsAwake() == false)) {
                        continue;
                    }
                    var t0 = bA.m_sweep.t0;
                    if (bA.m_sweep.t0 < bB.m_sweep.t0) {
                        t0 = bB.m_sweep.t0;
                        bA.m_sweep.Advance(t0);
                    } else if (bB.m_sweep.t0 < bA.m_sweep.t0) {
                        t0 = bA.m_sweep.t0;
                        bB.m_sweep.Advance(t0);
                    }
                    toi = c.ComputeTOI(bA.m_sweep, bB.m_sweep);
                    b2Settings.b2Assert(0.0 <= toi && toi <= 1.0);
                    if (toi > 0.0 && toi < 1.0) {
                        toi = (1.0 - toi) * t0 + toi;
                        if (toi > 1) toi = 1;
                    }
                    c.m_toi = toi;
                    c.m_flags |= b2Contact.e_toiFlag;
                }
                if (Number.MIN_VALUE < toi && toi < minTOI) {
                    minContact = c;
                    minTOI = toi;
                }
            }
            // 無限ループすることがある問題の修正。
            //
            // 修正前:
            //   if (minContact == null || 1.0 - 100.0 * Number.MIN_VALUE < minTOI)
            // 修正後:
            //   if (minContact == null || 1.0 - 100.0 * EPSILON < minTOI)
            //
            // box2dweb の実装では情報落ちしていたため、本家 box2d の実装に揃えた。
            if (minContact == null || 1.0 - 100.0 * EPSILON < minTOI) {
                break;
            }
            fA = minContact.m_fixtureA;
            fB = minContact.m_fixtureB;
            bA = fA.m_body;
            bB = fB.m_body;
            b2World.s_backupA.Set(bA.m_sweep);
            b2World.s_backupB.Set(bB.m_sweep);
            bA.Advance(minTOI);
            bB.Advance(minTOI);
            minContact.Update(this.m_contactManager.m_contactListener);
            minContact.m_flags &= ~b2Contact.e_toiFlag;
            if (minContact.IsSensor() == true || minContact.IsEnabled() == false) {
                bA.m_sweep.Set(b2World.s_backupA);
                bB.m_sweep.Set(b2World.s_backupB);
                bA.SynchronizeTransform();
                bB.SynchronizeTransform();
                continue;
            }
            if (minContact.IsTouching() == false) {
                continue;
            }
            var seed = bA;
            if (seed.GetType() != b2Body.b2_dynamicBody) {
                seed = bB;
            }
            island.Clear();
            var queueStart = 0;
            var queueSize = 0;
            queue[queueStart + queueSize++] = seed;
            seed.m_flags |= b2Body.e_islandFlag;
            while (queueSize > 0) {
                b = queue[queueStart++];
                --queueSize;
                island.AddBody(b);
                if (b.IsAwake() == false) {
                    b.SetAwake(true);
                }
                if (b.GetType() != b2Body.b2_dynamicBody) {
                    continue;
                }
                for (cEdge = b.m_contactList; cEdge; cEdge = cEdge.next) {
                    if (island.m_contactCount == island.m_contactCapacity) {
                        break;
                    }
                    if (cEdge.contact.m_flags & b2Contact.e_islandFlag) {
                        continue;
                    }
                    if (cEdge.contact.IsSensor() == true || cEdge.contact.IsEnabled() == false || cEdge.contact.IsTouching() == false) {
                        continue;
                    }
                    island.AddContact(cEdge.contact);
                    cEdge.contact.m_flags |= b2Contact.e_islandFlag;
                    var other = cEdge.other;
                    if (other.m_flags & b2Body.e_islandFlag) {
                        continue;
                    }
                    if (other.GetType() != b2Body.b2_staticBody) {
                        other.Advance(minTOI);
                        other.SetAwake(true);
                    }
                    queue[queueStart + queueSize] = other;
                    ++queueSize;
                    other.m_flags |= b2Body.e_islandFlag;
                }
                for (var jEdge = b.m_jointList; jEdge; jEdge = jEdge.next) {
                    if (island.m_jointCount == island.m_jointCapacity) continue;
                    if (jEdge.joint.m_islandFlag == true) continue;
                    other = jEdge.other;
                    if (other.IsActive() == false) {
                        continue;
                    }
                    island.AddJoint(jEdge.joint);
                    jEdge.joint.m_islandFlag = true;
                    if (other.m_flags & b2Body.e_islandFlag) continue;
                    if (other.GetType() != b2Body.b2_staticBody) {
                        other.Advance(minTOI);
                        other.SetAwake(true);
                    }
                    queue[queueStart + queueSize] = other;
                    ++queueSize;
                    other.m_flags |= b2Body.e_islandFlag;
                }
            }
            var subStep = b2World.s_timestep;
            subStep.warmStarting = false;
            subStep.dt = (1.0 - minTOI) * step.dt;
            subStep.inv_dt = 1.0 / subStep.dt;
            subStep.dtRatio = 0.0;
            subStep.velocityIterations = step.velocityIterations;
            subStep.positionIterations = step.positionIterations;
            island.SolveTOI(subStep);
            var i = 0;
            for (i = 0; i < island.m_bodyCount; ++i) {
                b = island.m_bodies[i];
                b.m_flags &= ~b2Body.e_islandFlag;
                if (b.IsAwake() == false) {
                    continue;
                }
                if (b.GetType() != b2Body.b2_dynamicBody) {
                    continue;
                }
                b.SynchronizeFixtures();
                for (cEdge = b.m_contactList; cEdge; cEdge = cEdge.next) {
                    cEdge.contact.m_flags &= ~b2Contact.e_toiFlag;
                }
            }
            for (i = 0; i < island.m_contactCount; ++i) {
                c = island.m_contacts[i];
                c.m_flags &= ~(b2Contact.e_toiFlag | b2Contact.e_islandFlag);
            }
            for (i = 0; i < island.m_jointCount; ++i) {
                j = island.m_joints[i];
                j.m_islandFlag = false;
            }
            this.m_contactManager.FindNewContacts();
        }
    };
}

module.exports = {
    patchBox2D: patchBox2D
};

})(g.module.exports, g.module.require, g.module, g.filename, g.dirname);

		};
	

	
		window.gLocalAssetContainer["a_e_z_7"] = function(g) {
			(function(exports, require, module, __filename, __dirname) {
/*
* Copyright (c) 2006-2007 Erin Catto http://www.gphysics.com
*
* This software is provided 'as-is', without any express or implied
* warranty.  In no event will the authors be held liable for any damages
* arising from the use of this software.
* Permission is granted to anyone to use this software for any purpose,
* including commercial applications, and to alter it and redistribute it
* freely, subject to the following restrictions:
* 1. The origin of this software must not be misrepresented; you must not
* claim that you wrote the original software. If you use this software
* in a product, an acknowledgment in the product documentation would be
* appreciated but is not required.
* 2. Altered source versions must be plainly marked as such, and must not be
* misrepresented as being the original software.
* 3. This notice may not be removed or altered from any source distribution.
*/
"use strict"

var Box2D = {};

(function (a2j, undefined) {
   
   function emptyFn() {};
   a2j.inherit = function(cls, base) {
      var tmpCtr = cls;
      emptyFn.prototype = base.prototype;
      cls.prototype = new emptyFn;
      cls.prototype.constructor = tmpCtr;
   };
   
   a2j.generateCallback = function generateCallback(context, cb) {
      return function () {
         cb.apply(context, arguments);
      };
   };
   
   a2j.NVector = function NVector(length) {
      if (length === undefined) length = 0;
      var tmp = new Array(length || 0);
      for (var i = 0; i < length; ++i)
      tmp[i] = 0;
      return tmp;
   };
   
   a2j.is = function is(o1, o2) {
      if (o1 === null) return false;
      if ((o2 instanceof Function) && (o1 instanceof o2)) return true;
      if ((o1.constructor.__implements != undefined) && (o1.constructor.__implements[o2])) return true;
      return false;
   };
   
   a2j.parseUInt = function(v) {
      return Math.abs(parseInt(v));
   }
   
})(Box2D);

//#TODO remove assignments from global namespace
var Vector = Array;
var Vector_a2j_Number = Box2D.NVector;
//package structure
if (typeof(Box2D) === "undefined") Box2D = {};
if (typeof(Box2D.Collision) === "undefined") Box2D.Collision = {};
if (typeof(Box2D.Collision.Shapes) === "undefined") Box2D.Collision.Shapes = {};
if (typeof(Box2D.Common) === "undefined") Box2D.Common = {};
if (typeof(Box2D.Common.Math) === "undefined") Box2D.Common.Math = {};
if (typeof(Box2D.Dynamics) === "undefined") Box2D.Dynamics = {};
if (typeof(Box2D.Dynamics.Contacts) === "undefined") Box2D.Dynamics.Contacts = {};
if (typeof(Box2D.Dynamics.Controllers) === "undefined") Box2D.Dynamics.Controllers = {};
if (typeof(Box2D.Dynamics.Joints) === "undefined") Box2D.Dynamics.Joints = {};
//pre-definitions
(function () {
   Box2D.Collision.IBroadPhase = 'Box2D.Collision.IBroadPhase';

   function b2AABB() {
      b2AABB.b2AABB.apply(this, arguments);
   };
   Box2D.Collision.b2AABB = b2AABB;

   function b2Bound() {
      b2Bound.b2Bound.apply(this, arguments);
   };
   Box2D.Collision.b2Bound = b2Bound;

   function b2BoundValues() {
      b2BoundValues.b2BoundValues.apply(this, arguments);
      if (this.constructor === b2BoundValues) this.b2BoundValues.apply(this, arguments);
   };
   Box2D.Collision.b2BoundValues = b2BoundValues;

   function b2Collision() {
      b2Collision.b2Collision.apply(this, arguments);
   };
   Box2D.Collision.b2Collision = b2Collision;

   function b2ContactID() {
      b2ContactID.b2ContactID.apply(this, arguments);
      if (this.constructor === b2ContactID) this.b2ContactID.apply(this, arguments);
   };
   Box2D.Collision.b2ContactID = b2ContactID;

   function b2ContactPoint() {
      b2ContactPoint.b2ContactPoint.apply(this, arguments);
   };
   Box2D.Collision.b2ContactPoint = b2ContactPoint;

   function b2Distance() {
      b2Distance.b2Distance.apply(this, arguments);
   };
   Box2D.Collision.b2Distance = b2Distance;

   function b2DistanceInput() {
      b2DistanceInput.b2DistanceInput.apply(this, arguments);
   };
   Box2D.Collision.b2DistanceInput = b2DistanceInput;

   function b2DistanceOutput() {
      b2DistanceOutput.b2DistanceOutput.apply(this, arguments);
   };
   Box2D.Collision.b2DistanceOutput = b2DistanceOutput;

   function b2DistanceProxy() {
      b2DistanceProxy.b2DistanceProxy.apply(this, arguments);
   };
   Box2D.Collision.b2DistanceProxy = b2DistanceProxy;

   function b2DynamicTree() {
      b2DynamicTree.b2DynamicTree.apply(this, arguments);
      if (this.constructor === b2DynamicTree) this.b2DynamicTree.apply(this, arguments);
   };
   Box2D.Collision.b2DynamicTree = b2DynamicTree;

   function b2DynamicTreeBroadPhase() {
      b2DynamicTreeBroadPhase.b2DynamicTreeBroadPhase.apply(this, arguments);
   };
   Box2D.Collision.b2DynamicTreeBroadPhase = b2DynamicTreeBroadPhase;

   function b2DynamicTreeNode() {
      b2DynamicTreeNode.b2DynamicTreeNode.apply(this, arguments);
   };
   Box2D.Collision.b2DynamicTreeNode = b2DynamicTreeNode;

   function b2DynamicTreePair() {
      b2DynamicTreePair.b2DynamicTreePair.apply(this, arguments);
   };
   Box2D.Collision.b2DynamicTreePair = b2DynamicTreePair;

   function b2Manifold() {
      b2Manifold.b2Manifold.apply(this, arguments);
      if (this.constructor === b2Manifold) this.b2Manifold.apply(this, arguments);
   };
   Box2D.Collision.b2Manifold = b2Manifold;

   function b2ManifoldPoint() {
      b2ManifoldPoint.b2ManifoldPoint.apply(this, arguments);
      if (this.constructor === b2ManifoldPoint) this.b2ManifoldPoint.apply(this, arguments);
   };
   Box2D.Collision.b2ManifoldPoint = b2ManifoldPoint;

   function b2Point() {
      b2Point.b2Point.apply(this, arguments);
   };
   Box2D.Collision.b2Point = b2Point;

   function b2RayCastInput() {
      b2RayCastInput.b2RayCastInput.apply(this, arguments);
      if (this.constructor === b2RayCastInput) this.b2RayCastInput.apply(this, arguments);
   };
   Box2D.Collision.b2RayCastInput = b2RayCastInput;

   function b2RayCastOutput() {
      b2RayCastOutput.b2RayCastOutput.apply(this, arguments);
   };
   Box2D.Collision.b2RayCastOutput = b2RayCastOutput;

   function b2Segment() {
      b2Segment.b2Segment.apply(this, arguments);
   };
   Box2D.Collision.b2Segment = b2Segment;

   function b2SeparationFunction() {
      b2SeparationFunction.b2SeparationFunction.apply(this, arguments);
   };
   Box2D.Collision.b2SeparationFunction = b2SeparationFunction;

   function b2Simplex() {
      b2Simplex.b2Simplex.apply(this, arguments);
      if (this.constructor === b2Simplex) this.b2Simplex.apply(this, arguments);
   };
   Box2D.Collision.b2Simplex = b2Simplex;

   function b2SimplexCache() {
      b2SimplexCache.b2SimplexCache.apply(this, arguments);
   };
   Box2D.Collision.b2SimplexCache = b2SimplexCache;

   function b2SimplexVertex() {
      b2SimplexVertex.b2SimplexVertex.apply(this, arguments);
   };
   Box2D.Collision.b2SimplexVertex = b2SimplexVertex;

   function b2TimeOfImpact() {
      b2TimeOfImpact.b2TimeOfImpact.apply(this, arguments);
   };
   Box2D.Collision.b2TimeOfImpact = b2TimeOfImpact;

   function b2TOIInput() {
      b2TOIInput.b2TOIInput.apply(this, arguments);
   };
   Box2D.Collision.b2TOIInput = b2TOIInput;

   function b2WorldManifold() {
      b2WorldManifold.b2WorldManifold.apply(this, arguments);
      if (this.constructor === b2WorldManifold) this.b2WorldManifold.apply(this, arguments);
   };
   Box2D.Collision.b2WorldManifold = b2WorldManifold;

   function ClipVertex() {
      ClipVertex.ClipVertex.apply(this, arguments);
   };
   Box2D.Collision.ClipVertex = ClipVertex;

   function Features() {
      Features.Features.apply(this, arguments);
   };
   Box2D.Collision.Features = Features;

   function b2CircleShape() {
      b2CircleShape.b2CircleShape.apply(this, arguments);
      if (this.constructor === b2CircleShape) this.b2CircleShape.apply(this, arguments);
   };
   Box2D.Collision.Shapes.b2CircleShape = b2CircleShape;

   function b2EdgeChainDef() {
      b2EdgeChainDef.b2EdgeChainDef.apply(this, arguments);
      if (this.constructor === b2EdgeChainDef) this.b2EdgeChainDef.apply(this, arguments);
   };
   Box2D.Collision.Shapes.b2EdgeChainDef = b2EdgeChainDef;

   function b2EdgeShape() {
      b2EdgeShape.b2EdgeShape.apply(this, arguments);
      if (this.constructor === b2EdgeShape) this.b2EdgeShape.apply(this, arguments);
   };
   Box2D.Collision.Shapes.b2EdgeShape = b2EdgeShape;

   function b2MassData() {
      b2MassData.b2MassData.apply(this, arguments);
   };
   Box2D.Collision.Shapes.b2MassData = b2MassData;

   function b2PolygonShape() {
      b2PolygonShape.b2PolygonShape.apply(this, arguments);
      if (this.constructor === b2PolygonShape) this.b2PolygonShape.apply(this, arguments);
   };
   Box2D.Collision.Shapes.b2PolygonShape = b2PolygonShape;

   function b2Shape() {
      b2Shape.b2Shape.apply(this, arguments);
      if (this.constructor === b2Shape) this.b2Shape.apply(this, arguments);
   };
   Box2D.Collision.Shapes.b2Shape = b2Shape;
   Box2D.Common.b2internal = 'Box2D.Common.b2internal';

   function b2Color() {
      b2Color.b2Color.apply(this, arguments);
      if (this.constructor === b2Color) this.b2Color.apply(this, arguments);
   };
   Box2D.Common.b2Color = b2Color;

   function b2Settings() {
      b2Settings.b2Settings.apply(this, arguments);
   };
   Box2D.Common.b2Settings = b2Settings;

   function b2Mat22() {
      b2Mat22.b2Mat22.apply(this, arguments);
      if (this.constructor === b2Mat22) this.b2Mat22.apply(this, arguments);
   };
   Box2D.Common.Math.b2Mat22 = b2Mat22;

   function b2Mat33() {
      b2Mat33.b2Mat33.apply(this, arguments);
      if (this.constructor === b2Mat33) this.b2Mat33.apply(this, arguments);
   };
   Box2D.Common.Math.b2Mat33 = b2Mat33;

   function b2Math() {
      b2Math.b2Math.apply(this, arguments);
   };
   Box2D.Common.Math.b2Math = b2Math;

   function b2Sweep() {
      b2Sweep.b2Sweep.apply(this, arguments);
   };
   Box2D.Common.Math.b2Sweep = b2Sweep;

   function b2Transform() {
      b2Transform.b2Transform.apply(this, arguments);
      if (this.constructor === b2Transform) this.b2Transform.apply(this, arguments);
   };
   Box2D.Common.Math.b2Transform = b2Transform;

   function b2Vec2() {
      b2Vec2.b2Vec2.apply(this, arguments);
      if (this.constructor === b2Vec2) this.b2Vec2.apply(this, arguments);
   };
   Box2D.Common.Math.b2Vec2 = b2Vec2;

   function b2Vec3() {
      b2Vec3.b2Vec3.apply(this, arguments);
      if (this.constructor === b2Vec3) this.b2Vec3.apply(this, arguments);
   };
   Box2D.Common.Math.b2Vec3 = b2Vec3;

   function b2Body() {
      b2Body.b2Body.apply(this, arguments);
      if (this.constructor === b2Body) this.b2Body.apply(this, arguments);
   };
   Box2D.Dynamics.b2Body = b2Body;

   function b2BodyDef() {
      b2BodyDef.b2BodyDef.apply(this, arguments);
      if (this.constructor === b2BodyDef) this.b2BodyDef.apply(this, arguments);
   };
   Box2D.Dynamics.b2BodyDef = b2BodyDef;

   function b2ContactFilter() {
      b2ContactFilter.b2ContactFilter.apply(this, arguments);
   };
   Box2D.Dynamics.b2ContactFilter = b2ContactFilter;

   function b2ContactImpulse() {
      b2ContactImpulse.b2ContactImpulse.apply(this, arguments);
   };
   Box2D.Dynamics.b2ContactImpulse = b2ContactImpulse;

   function b2ContactListener() {
      b2ContactListener.b2ContactListener.apply(this, arguments);
   };
   Box2D.Dynamics.b2ContactListener = b2ContactListener;

   function b2ContactManager() {
      b2ContactManager.b2ContactManager.apply(this, arguments);
      if (this.constructor === b2ContactManager) this.b2ContactManager.apply(this, arguments);
   };
   Box2D.Dynamics.b2ContactManager = b2ContactManager;

   function b2DebugDraw() {
      b2DebugDraw.b2DebugDraw.apply(this, arguments);
      if (this.constructor === b2DebugDraw) this.b2DebugDraw.apply(this, arguments);
   };
   Box2D.Dynamics.b2DebugDraw = b2DebugDraw;

   function b2DestructionListener() {
      b2DestructionListener.b2DestructionListener.apply(this, arguments);
   };
   Box2D.Dynamics.b2DestructionListener = b2DestructionListener;

   function b2FilterData() {
      b2FilterData.b2FilterData.apply(this, arguments);
   };
   Box2D.Dynamics.b2FilterData = b2FilterData;

   function b2Fixture() {
      b2Fixture.b2Fixture.apply(this, arguments);
      if (this.constructor === b2Fixture) this.b2Fixture.apply(this, arguments);
   };
   Box2D.Dynamics.b2Fixture = b2Fixture;

   function b2FixtureDef() {
      b2FixtureDef.b2FixtureDef.apply(this, arguments);
      if (this.constructor === b2FixtureDef) this.b2FixtureDef.apply(this, arguments);
   };
   Box2D.Dynamics.b2FixtureDef = b2FixtureDef;

   function b2Island() {
      b2Island.b2Island.apply(this, arguments);
      if (this.constructor === b2Island) this.b2Island.apply(this, arguments);
   };
   Box2D.Dynamics.b2Island = b2Island;

   function b2TimeStep() {
      b2TimeStep.b2TimeStep.apply(this, arguments);
   };
   Box2D.Dynamics.b2TimeStep = b2TimeStep;

   function b2World() {
      b2World.b2World.apply(this, arguments);
      if (this.constructor === b2World) this.b2World.apply(this, arguments);
   };
   Box2D.Dynamics.b2World = b2World;

   function b2CircleContact() {
      b2CircleContact.b2CircleContact.apply(this, arguments);
   };
   Box2D.Dynamics.Contacts.b2CircleContact = b2CircleContact;

   function b2Contact() {
      b2Contact.b2Contact.apply(this, arguments);
      if (this.constructor === b2Contact) this.b2Contact.apply(this, arguments);
   };
   Box2D.Dynamics.Contacts.b2Contact = b2Contact;

   function b2ContactConstraint() {
      b2ContactConstraint.b2ContactConstraint.apply(this, arguments);
      if (this.constructor === b2ContactConstraint) this.b2ContactConstraint.apply(this, arguments);
   };
   Box2D.Dynamics.Contacts.b2ContactConstraint = b2ContactConstraint;

   function b2ContactConstraintPoint() {
      b2ContactConstraintPoint.b2ContactConstraintPoint.apply(this, arguments);
   };
   Box2D.Dynamics.Contacts.b2ContactConstraintPoint = b2ContactConstraintPoint;

   function b2ContactEdge() {
      b2ContactEdge.b2ContactEdge.apply(this, arguments);
   };
   Box2D.Dynamics.Contacts.b2ContactEdge = b2ContactEdge;

   function b2ContactFactory() {
      b2ContactFactory.b2ContactFactory.apply(this, arguments);
      if (this.constructor === b2ContactFactory) this.b2ContactFactory.apply(this, arguments);
   };
   Box2D.Dynamics.Contacts.b2ContactFactory = b2ContactFactory;

   function b2ContactRegister() {
      b2ContactRegister.b2ContactRegister.apply(this, arguments);
   };
   Box2D.Dynamics.Contacts.b2ContactRegister = b2ContactRegister;

   function b2ContactResult() {
      b2ContactResult.b2ContactResult.apply(this, arguments);
   };
   Box2D.Dynamics.Contacts.b2ContactResult = b2ContactResult;

   function b2ContactSolver() {
      b2ContactSolver.b2ContactSolver.apply(this, arguments);
      if (this.constructor === b2ContactSolver) this.b2ContactSolver.apply(this, arguments);
   };
   Box2D.Dynamics.Contacts.b2ContactSolver = b2ContactSolver;

   function b2EdgeAndCircleContact() {
      b2EdgeAndCircleContact.b2EdgeAndCircleContact.apply(this, arguments);
   };
   Box2D.Dynamics.Contacts.b2EdgeAndCircleContact = b2EdgeAndCircleContact;

   function b2NullContact() {
      b2NullContact.b2NullContact.apply(this, arguments);
      if (this.constructor === b2NullContact) this.b2NullContact.apply(this, arguments);
   };
   Box2D.Dynamics.Contacts.b2NullContact = b2NullContact;

   function b2PolyAndCircleContact() {
      b2PolyAndCircleContact.b2PolyAndCircleContact.apply(this, arguments);
   };
   Box2D.Dynamics.Contacts.b2PolyAndCircleContact = b2PolyAndCircleContact;

   function b2PolyAndEdgeContact() {
      b2PolyAndEdgeContact.b2PolyAndEdgeContact.apply(this, arguments);
   };
   Box2D.Dynamics.Contacts.b2PolyAndEdgeContact = b2PolyAndEdgeContact;

   function b2PolygonContact() {
      b2PolygonContact.b2PolygonContact.apply(this, arguments);
   };
   Box2D.Dynamics.Contacts.b2PolygonContact = b2PolygonContact;

   function b2PositionSolverManifold() {
      b2PositionSolverManifold.b2PositionSolverManifold.apply(this, arguments);
      if (this.constructor === b2PositionSolverManifold) this.b2PositionSolverManifold.apply(this, arguments);
   };
   Box2D.Dynamics.Contacts.b2PositionSolverManifold = b2PositionSolverManifold;

   function b2BuoyancyController() {
      b2BuoyancyController.b2BuoyancyController.apply(this, arguments);
   };
   Box2D.Dynamics.Controllers.b2BuoyancyController = b2BuoyancyController;

   function b2ConstantAccelController() {
      b2ConstantAccelController.b2ConstantAccelController.apply(this, arguments);
   };
   Box2D.Dynamics.Controllers.b2ConstantAccelController = b2ConstantAccelController;

   function b2ConstantForceController() {
      b2ConstantForceController.b2ConstantForceController.apply(this, arguments);
   };
   Box2D.Dynamics.Controllers.b2ConstantForceController = b2ConstantForceController;

   function b2Controller() {
      b2Controller.b2Controller.apply(this, arguments);
   };
   Box2D.Dynamics.Controllers.b2Controller = b2Controller;

   function b2ControllerEdge() {
      b2ControllerEdge.b2ControllerEdge.apply(this, arguments);
   };
   Box2D.Dynamics.Controllers.b2ControllerEdge = b2ControllerEdge;

   function b2GravityController() {
      b2GravityController.b2GravityController.apply(this, arguments);
   };
   Box2D.Dynamics.Controllers.b2GravityController = b2GravityController;

   function b2TensorDampingController() {
      b2TensorDampingController.b2TensorDampingController.apply(this, arguments);
   };
   Box2D.Dynamics.Controllers.b2TensorDampingController = b2TensorDampingController;

   function b2DistanceJoint() {
      b2DistanceJoint.b2DistanceJoint.apply(this, arguments);
      if (this.constructor === b2DistanceJoint) this.b2DistanceJoint.apply(this, arguments);
   };
   Box2D.Dynamics.Joints.b2DistanceJoint = b2DistanceJoint;

   function b2DistanceJointDef() {
      b2DistanceJointDef.b2DistanceJointDef.apply(this, arguments);
      if (this.constructor === b2DistanceJointDef) this.b2DistanceJointDef.apply(this, arguments);
   };
   Box2D.Dynamics.Joints.b2DistanceJointDef = b2DistanceJointDef;

   function b2FrictionJoint() {
      b2FrictionJoint.b2FrictionJoint.apply(this, arguments);
      if (this.constructor === b2FrictionJoint) this.b2FrictionJoint.apply(this, arguments);
   };
   Box2D.Dynamics.Joints.b2FrictionJoint = b2FrictionJoint;

   function b2FrictionJointDef() {
      b2FrictionJointDef.b2FrictionJointDef.apply(this, arguments);
      if (this.constructor === b2FrictionJointDef) this.b2FrictionJointDef.apply(this, arguments);
   };
   Box2D.Dynamics.Joints.b2FrictionJointDef = b2FrictionJointDef;

   function b2GearJoint() {
      b2GearJoint.b2GearJoint.apply(this, arguments);
      if (this.constructor === b2GearJoint) this.b2GearJoint.apply(this, arguments);
   };
   Box2D.Dynamics.Joints.b2GearJoint = b2GearJoint;

   function b2GearJointDef() {
      b2GearJointDef.b2GearJointDef.apply(this, arguments);
      if (this.constructor === b2GearJointDef) this.b2GearJointDef.apply(this, arguments);
   };
   Box2D.Dynamics.Joints.b2GearJointDef = b2GearJointDef;

   function b2Jacobian() {
      b2Jacobian.b2Jacobian.apply(this, arguments);
   };
   Box2D.Dynamics.Joints.b2Jacobian = b2Jacobian;

   function b2Joint() {
      b2Joint.b2Joint.apply(this, arguments);
      if (this.constructor === b2Joint) this.b2Joint.apply(this, arguments);
   };
   Box2D.Dynamics.Joints.b2Joint = b2Joint;

   function b2JointDef() {
      b2JointDef.b2JointDef.apply(this, arguments);
      if (this.constructor === b2JointDef) this.b2JointDef.apply(this, arguments);
   };
   Box2D.Dynamics.Joints.b2JointDef = b2JointDef;

   function b2JointEdge() {
      b2JointEdge.b2JointEdge.apply(this, arguments);
   };
   Box2D.Dynamics.Joints.b2JointEdge = b2JointEdge;

   function b2LineJoint() {
      b2LineJoint.b2LineJoint.apply(this, arguments);
      if (this.constructor === b2LineJoint) this.b2LineJoint.apply(this, arguments);
   };
   Box2D.Dynamics.Joints.b2LineJoint = b2LineJoint;

   function b2LineJointDef() {
      b2LineJointDef.b2LineJointDef.apply(this, arguments);
      if (this.constructor === b2LineJointDef) this.b2LineJointDef.apply(this, arguments);
   };
   Box2D.Dynamics.Joints.b2LineJointDef = b2LineJointDef;

   function b2MouseJoint() {
      b2MouseJoint.b2MouseJoint.apply(this, arguments);
      if (this.constructor === b2MouseJoint) this.b2MouseJoint.apply(this, arguments);
   };
   Box2D.Dynamics.Joints.b2MouseJoint = b2MouseJoint;

   function b2MouseJointDef() {
      b2MouseJointDef.b2MouseJointDef.apply(this, arguments);
      if (this.constructor === b2MouseJointDef) this.b2MouseJointDef.apply(this, arguments);
   };
   Box2D.Dynamics.Joints.b2MouseJointDef = b2MouseJointDef;

   function b2PrismaticJoint() {
      b2PrismaticJoint.b2PrismaticJoint.apply(this, arguments);
      if (this.constructor === b2PrismaticJoint) this.b2PrismaticJoint.apply(this, arguments);
   };
   Box2D.Dynamics.Joints.b2PrismaticJoint = b2PrismaticJoint;

   function b2PrismaticJointDef() {
      b2PrismaticJointDef.b2PrismaticJointDef.apply(this, arguments);
      if (this.constructor === b2PrismaticJointDef) this.b2PrismaticJointDef.apply(this, arguments);
   };
   Box2D.Dynamics.Joints.b2PrismaticJointDef = b2PrismaticJointDef;

   function b2PulleyJoint() {
      b2PulleyJoint.b2PulleyJoint.apply(this, arguments);
      if (this.constructor === b2PulleyJoint) this.b2PulleyJoint.apply(this, arguments);
   };
   Box2D.Dynamics.Joints.b2PulleyJoint = b2PulleyJoint;

   function b2PulleyJointDef() {
      b2PulleyJointDef.b2PulleyJointDef.apply(this, arguments);
      if (this.constructor === b2PulleyJointDef) this.b2PulleyJointDef.apply(this, arguments);
   };
   Box2D.Dynamics.Joints.b2PulleyJointDef = b2PulleyJointDef;

   function b2RevoluteJoint() {
      b2RevoluteJoint.b2RevoluteJoint.apply(this, arguments);
      if (this.constructor === b2RevoluteJoint) this.b2RevoluteJoint.apply(this, arguments);
   };
   Box2D.Dynamics.Joints.b2RevoluteJoint = b2RevoluteJoint;

   function b2RevoluteJointDef() {
      b2RevoluteJointDef.b2RevoluteJointDef.apply(this, arguments);
      if (this.constructor === b2RevoluteJointDef) this.b2RevoluteJointDef.apply(this, arguments);
   };
   Box2D.Dynamics.Joints.b2RevoluteJointDef = b2RevoluteJointDef;

   function b2WeldJoint() {
      b2WeldJoint.b2WeldJoint.apply(this, arguments);
      if (this.constructor === b2WeldJoint) this.b2WeldJoint.apply(this, arguments);
   };
   Box2D.Dynamics.Joints.b2WeldJoint = b2WeldJoint;

   function b2WeldJointDef() {
      b2WeldJointDef.b2WeldJointDef.apply(this, arguments);
      if (this.constructor === b2WeldJointDef) this.b2WeldJointDef.apply(this, arguments);
   };
   Box2D.Dynamics.Joints.b2WeldJointDef = b2WeldJointDef;
})(); //definitions
Box2D.postDefs = [];
(function () {
   var b2CircleShape = Box2D.Collision.Shapes.b2CircleShape,
      b2EdgeChainDef = Box2D.Collision.Shapes.b2EdgeChainDef,
      b2EdgeShape = Box2D.Collision.Shapes.b2EdgeShape,
      b2MassData = Box2D.Collision.Shapes.b2MassData,
      b2PolygonShape = Box2D.Collision.Shapes.b2PolygonShape,
      b2Shape = Box2D.Collision.Shapes.b2Shape,
      b2Color = Box2D.Common.b2Color,
      b2internal = Box2D.Common.b2internal,
      b2Settings = Box2D.Common.b2Settings,
      b2Mat22 = Box2D.Common.Math.b2Mat22,
      b2Mat33 = Box2D.Common.Math.b2Mat33,
      b2Math = Box2D.Common.Math.b2Math,
      b2Sweep = Box2D.Common.Math.b2Sweep,
      b2Transform = Box2D.Common.Math.b2Transform,
      b2Vec2 = Box2D.Common.Math.b2Vec2,
      b2Vec3 = Box2D.Common.Math.b2Vec3,
      b2AABB = Box2D.Collision.b2AABB,
      b2Bound = Box2D.Collision.b2Bound,
      b2BoundValues = Box2D.Collision.b2BoundValues,
      b2Collision = Box2D.Collision.b2Collision,
      b2ContactID = Box2D.Collision.b2ContactID,
      b2ContactPoint = Box2D.Collision.b2ContactPoint,
      b2Distance = Box2D.Collision.b2Distance,
      b2DistanceInput = Box2D.Collision.b2DistanceInput,
      b2DistanceOutput = Box2D.Collision.b2DistanceOutput,
      b2DistanceProxy = Box2D.Collision.b2DistanceProxy,
      b2DynamicTree = Box2D.Collision.b2DynamicTree,
      b2DynamicTreeBroadPhase = Box2D.Collision.b2DynamicTreeBroadPhase,
      b2DynamicTreeNode = Box2D.Collision.b2DynamicTreeNode,
      b2DynamicTreePair = Box2D.Collision.b2DynamicTreePair,
      b2Manifold = Box2D.Collision.b2Manifold,
      b2ManifoldPoint = Box2D.Collision.b2ManifoldPoint,
      b2Point = Box2D.Collision.b2Point,
      b2RayCastInput = Box2D.Collision.b2RayCastInput,
      b2RayCastOutput = Box2D.Collision.b2RayCastOutput,
      b2Segment = Box2D.Collision.b2Segment,
      b2SeparationFunction = Box2D.Collision.b2SeparationFunction,
      b2Simplex = Box2D.Collision.b2Simplex,
      b2SimplexCache = Box2D.Collision.b2SimplexCache,
      b2SimplexVertex = Box2D.Collision.b2SimplexVertex,
      b2TimeOfImpact = Box2D.Collision.b2TimeOfImpact,
      b2TOIInput = Box2D.Collision.b2TOIInput,
      b2WorldManifold = Box2D.Collision.b2WorldManifold,
      ClipVertex = Box2D.Collision.ClipVertex,
      Features = Box2D.Collision.Features,
      IBroadPhase = Box2D.Collision.IBroadPhase;

   b2AABB.b2AABB = function () {
      this.lowerBound = new b2Vec2();
      this.upperBound = new b2Vec2();
   };
   b2AABB.prototype.IsValid = function () {
      var dX = this.upperBound.x - this.lowerBound.x;
      var dY = this.upperBound.y - this.lowerBound.y;
      var valid = dX >= 0.0 && dY >= 0.0;
      valid = valid && this.lowerBound.IsValid() && this.upperBound.IsValid();
      return valid;
   }
   b2AABB.prototype.GetCenter = function () {
      return new b2Vec2((this.lowerBound.x + this.upperBound.x) / 2, (this.lowerBound.y + this.upperBound.y) / 2);
   }
   b2AABB.prototype.GetExtents = function () {
      return new b2Vec2((this.upperBound.x - this.lowerBound.x) / 2, (this.upperBound.y - this.lowerBound.y) / 2);
   }
   b2AABB.prototype.Contains = function (aabb) {
      var result = true;
      result = result && this.lowerBound.x <= aabb.lowerBound.x;
      result = result && this.lowerBound.y <= aabb.lowerBound.y;
      result = result && aabb.upperBound.x <= this.upperBound.x;
      result = result && aabb.upperBound.y <= this.upperBound.y;
      return result;
   }
   b2AABB.prototype.RayCast = function (output, input) {
      var tmin = (-Number.MAX_VALUE);
      var tmax = Number.MAX_VALUE;
      var pX = input.p1.x;
      var pY = input.p1.y;
      var dX = input.p2.x - input.p1.x;
      var dY = input.p2.y - input.p1.y;
      var absDX = Math.abs(dX);
      var absDY = Math.abs(dY);
      var normal = output.normal;
      var inv_d = 0;
      var t1 = 0;
      var t2 = 0;
      var t3 = 0;
      var s = 0; {
         if (absDX < Number.MIN_VALUE) {
            if (pX < this.lowerBound.x || this.upperBound.x < pX) return false;
         }
         else {
            inv_d = 1.0 / dX;
            t1 = (this.lowerBound.x - pX) * inv_d;
            t2 = (this.upperBound.x - pX) * inv_d;
            s = (-1.0);
            if (t1 > t2) {
               t3 = t1;
               t1 = t2;
               t2 = t3;
               s = 1.0;
            }
            if (t1 > tmin) {
               normal.x = s;
               normal.y = 0;
               tmin = t1;
            }
            tmax = Math.min(tmax, t2);
            if (tmin > tmax) return false;
         }
      } {
         if (absDY < Number.MIN_VALUE) {
            if (pY < this.lowerBound.y || this.upperBound.y < pY) return false;
         }
         else {
            inv_d = 1.0 / dY;
            t1 = (this.lowerBound.y - pY) * inv_d;
            t2 = (this.upperBound.y - pY) * inv_d;
            s = (-1.0);
            if (t1 > t2) {
               t3 = t1;
               t1 = t2;
               t2 = t3;
               s = 1.0;
            }
            if (t1 > tmin) {
               normal.y = s;
               normal.x = 0;
               tmin = t1;
            }
            tmax = Math.min(tmax, t2);
            if (tmin > tmax) return false;
         }
      }
      output.fraction = tmin;
      return true;
   }
   b2AABB.prototype.TestOverlap = function (other) {
      var d1X = other.lowerBound.x - this.upperBound.x;
      var d1Y = other.lowerBound.y - this.upperBound.y;
      var d2X = this.lowerBound.x - other.upperBound.x;
      var d2Y = this.lowerBound.y - other.upperBound.y;
      if (d1X > 0.0 || d1Y > 0.0) return false;
      if (d2X > 0.0 || d2Y > 0.0) return false;
      return true;
   }
   b2AABB.Combine = function (aabb1, aabb2) {
      var aabb = new b2AABB();
      aabb.Combine(aabb1, aabb2);
      return aabb;
   }
   b2AABB.prototype.Combine = function (aabb1, aabb2) {
      this.lowerBound.x = Math.min(aabb1.lowerBound.x, aabb2.lowerBound.x);
      this.lowerBound.y = Math.min(aabb1.lowerBound.y, aabb2.lowerBound.y);
      this.upperBound.x = Math.max(aabb1.upperBound.x, aabb2.upperBound.x);
      this.upperBound.y = Math.max(aabb1.upperBound.y, aabb2.upperBound.y);
   }
   b2Bound.b2Bound = function () {};
   b2Bound.prototype.IsLower = function () {
      return (this.value & 1) == 0;
   }
   b2Bound.prototype.IsUpper = function () {
      return (this.value & 1) == 1;
   }
   b2Bound.prototype.Swap = function (b) {
      var tempValue = this.value;
      var tempProxy = this.proxy;
      var tempStabbingCount = this.stabbingCount;
      this.value = b.value;
      this.proxy = b.proxy;
      this.stabbingCount = b.stabbingCount;
      b.value = tempValue;
      b.proxy = tempProxy;
      b.stabbingCount = tempStabbingCount;
   }
   b2BoundValues.b2BoundValues = function () {};
   b2BoundValues.prototype.b2BoundValues = function () {
      this.lowerValues = new Vector_a2j_Number();
      this.lowerValues[0] = 0.0;
      this.lowerValues[1] = 0.0;
      this.upperValues = new Vector_a2j_Number();
      this.upperValues[0] = 0.0;
      this.upperValues[1] = 0.0;
   }
   b2Collision.b2Collision = function () {};
   b2Collision.ClipSegmentToLine = function (vOut, vIn, normal, offset) {
      if (offset === undefined) offset = 0;
      var cv;
      var numOut = 0;
      cv = vIn[0];
      var vIn0 = cv.v;
      cv = vIn[1];
      var vIn1 = cv.v;
      var distance0 = normal.x * vIn0.x + normal.y * vIn0.y - offset;
      var distance1 = normal.x * vIn1.x + normal.y * vIn1.y - offset;
      if (distance0 <= 0.0) vOut[numOut++].Set(vIn[0]);
      if (distance1 <= 0.0) vOut[numOut++].Set(vIn[1]);
      if (distance0 * distance1 < 0.0) {
         var interp = distance0 / (distance0 - distance1);
         cv = vOut[numOut];
         var tVec = cv.v;
         tVec.x = vIn0.x + interp * (vIn1.x - vIn0.x);
         tVec.y = vIn0.y + interp * (vIn1.y - vIn0.y);
         cv = vOut[numOut];
         var cv2;
         if (distance0 > 0.0) {
            cv2 = vIn[0];
            cv.id = cv2.id;
         }
         else {
            cv2 = vIn[1];
            cv.id = cv2.id;
         }++numOut;
      }
      return numOut;
   }
   b2Collision.EdgeSeparation = function (poly1, xf1, edge1, poly2, xf2) {
      if (edge1 === undefined) edge1 = 0;
      var count1 = parseInt(poly1.m_vertexCount);
      var vertices1 = poly1.m_vertices;
      var normals1 = poly1.m_normals;
      var count2 = parseInt(poly2.m_vertexCount);
      var vertices2 = poly2.m_vertices;
      var tMat;
      var tVec;
      tMat = xf1.R;
      tVec = normals1[edge1];
      var normal1WorldX = (tMat.col1.x * tVec.x + tMat.col2.x * tVec.y);
      var normal1WorldY = (tMat.col1.y * tVec.x + tMat.col2.y * tVec.y);
      tMat = xf2.R;
      var normal1X = (tMat.col1.x * normal1WorldX + tMat.col1.y * normal1WorldY);
      var normal1Y = (tMat.col2.x * normal1WorldX + tMat.col2.y * normal1WorldY);
      var index = 0;
      var minDot = Number.MAX_VALUE;
      for (var i = 0; i < count2; ++i) {
         tVec = vertices2[i];
         var dot = tVec.x * normal1X + tVec.y * normal1Y;
         if (dot < minDot) {
            minDot = dot;
            index = i;
         }
      }
      tVec = vertices1[edge1];
      tMat = xf1.R;
      var v1X = xf1.position.x + (tMat.col1.x * tVec.x + tMat.col2.x * tVec.y);
      var v1Y = xf1.position.y + (tMat.col1.y * tVec.x + tMat.col2.y * tVec.y);
      tVec = vertices2[index];
      tMat = xf2.R;
      var v2X = xf2.position.x + (tMat.col1.x * tVec.x + tMat.col2.x * tVec.y);
      var v2Y = xf2.position.y + (tMat.col1.y * tVec.x + tMat.col2.y * tVec.y);
      v2X -= v1X;
      v2Y -= v1Y;
      var separation = v2X * normal1WorldX + v2Y * normal1WorldY;
      return separation;
   }
   b2Collision.FindMaxSeparation = function (edgeIndex, poly1, xf1, poly2, xf2) {
      var count1 = parseInt(poly1.m_vertexCount);
      var normals1 = poly1.m_normals;
      var tVec;
      var tMat;
      tMat = xf2.R;
      tVec = poly2.m_centroid;
      var dX = xf2.position.x + (tMat.col1.x * tVec.x + tMat.col2.x * tVec.y);
      var dY = xf2.position.y + (tMat.col1.y * tVec.x + tMat.col2.y * tVec.y);
      tMat = xf1.R;
      tVec = poly1.m_centroid;
      dX -= xf1.position.x + (tMat.col1.x * tVec.x + tMat.col2.x * tVec.y);
      dY -= xf1.position.y + (tMat.col1.y * tVec.x + tMat.col2.y * tVec.y);
      var dLocal1X = (dX * xf1.R.col1.x + dY * xf1.R.col1.y);
      var dLocal1Y = (dX * xf1.R.col2.x + dY * xf1.R.col2.y);
      var edge = 0;
      var maxDot = (-Number.MAX_VALUE);
      for (var i = 0; i < count1; ++i) {
         tVec = normals1[i];
         var dot = (tVec.x * dLocal1X + tVec.y * dLocal1Y);
         if (dot > maxDot) {
            maxDot = dot;
            edge = i;
         }
      }
      var s = b2Collision.EdgeSeparation(poly1, xf1, edge, poly2, xf2);
      var prevEdge = parseInt(edge - 1 >= 0 ? edge - 1 : count1 - 1);
      var sPrev = b2Collision.EdgeSeparation(poly1, xf1, prevEdge, poly2, xf2);
      var nextEdge = parseInt(edge + 1 < count1 ? edge + 1 : 0);
      var sNext = b2Collision.EdgeSeparation(poly1, xf1, nextEdge, poly2, xf2);
      var bestEdge = 0;
      var bestSeparation = 0;
      var increment = 0;
      if (sPrev > s && sPrev > sNext) {
         increment = (-1);
         bestEdge = prevEdge;
         bestSeparation = sPrev;
      }
      else if (sNext > s) {
         increment = 1;
         bestEdge = nextEdge;
         bestSeparation = sNext;
      }
      else {
         edgeIndex[0] = edge;
         return s;
      }
      while (true) {
         if (increment == (-1)) edge = bestEdge - 1 >= 0 ? bestEdge - 1 : count1 - 1;
         else edge = bestEdge + 1 < count1 ? bestEdge + 1 : 0;s = b2Collision.EdgeSeparation(poly1, xf1, edge, poly2, xf2);
         if (s > bestSeparation) {
            bestEdge = edge;
            bestSeparation = s;
         }
         else {
            break;
         }
      }
      edgeIndex[0] = bestEdge;
      return bestSeparation;
   }
   b2Collision.FindIncidentEdge = function (c, poly1, xf1, edge1, poly2, xf2) {
      if (edge1 === undefined) edge1 = 0;
      var count1 = parseInt(poly1.m_vertexCount);
      var normals1 = poly1.m_normals;
      var count2 = parseInt(poly2.m_vertexCount);
      var vertices2 = poly2.m_vertices;
      var normals2 = poly2.m_normals;
      var tMat;
      var tVec;
      tMat = xf1.R;
      tVec = normals1[edge1];
      var normal1X = (tMat.col1.x * tVec.x + tMat.col2.x * tVec.y);
      var normal1Y = (tMat.col1.y * tVec.x + tMat.col2.y * tVec.y);
      tMat = xf2.R;
      var tX = (tMat.col1.x * normal1X + tMat.col1.y * normal1Y);
      normal1Y = (tMat.col2.x * normal1X + tMat.col2.y * normal1Y);
      normal1X = tX;
      var index = 0;
      var minDot = Number.MAX_VALUE;
      for (var i = 0; i < count2; ++i) {
         tVec = normals2[i];
         var dot = (normal1X * tVec.x + normal1Y * tVec.y);
         if (dot < minDot) {
            minDot = dot;
            index = i;
         }
      }
      var tClip;
      var i1 = parseInt(index);
      var i2 = parseInt(i1 + 1 < count2 ? i1 + 1 : 0);
      tClip = c[0];
      tVec = vertices2[i1];
      tMat = xf2.R;
      tClip.v.x = xf2.position.x + (tMat.col1.x * tVec.x + tMat.col2.x * tVec.y);
      tClip.v.y = xf2.position.y + (tMat.col1.y * tVec.x + tMat.col2.y * tVec.y);
      tClip.id.features.referenceEdge = edge1;
      tClip.id.features.incidentEdge = i1;
      tClip.id.features.incidentVertex = 0;
      tClip = c[1];
      tVec = vertices2[i2];
      tMat = xf2.R;
      tClip.v.x = xf2.position.x + (tMat.col1.x * tVec.x + tMat.col2.x * tVec.y);
      tClip.v.y = xf2.position.y + (tMat.col1.y * tVec.x + tMat.col2.y * tVec.y);
      tClip.id.features.referenceEdge = edge1;
      tClip.id.features.incidentEdge = i2;
      tClip.id.features.incidentVertex = 1;
   }
   b2Collision.MakeClipPointVector = function () {
      var r = new Vector(2);
      r[0] = new ClipVertex();
      r[1] = new ClipVertex();
      return r;
   }
   b2Collision.CollidePolygons = function (manifold, polyA, xfA, polyB, xfB) {
      var cv;
      manifold.m_pointCount = 0;
      var totalRadius = polyA.m_radius + polyB.m_radius;
      var edgeA = 0;
      b2Collision.s_edgeAO[0] = edgeA;
      var separationA = b2Collision.FindMaxSeparation(b2Collision.s_edgeAO, polyA, xfA, polyB, xfB);
      edgeA = b2Collision.s_edgeAO[0];
      if (separationA > totalRadius) return;
      var edgeB = 0;
      b2Collision.s_edgeBO[0] = edgeB;
      var separationB = b2Collision.FindMaxSeparation(b2Collision.s_edgeBO, polyB, xfB, polyA, xfA);
      edgeB = b2Collision.s_edgeBO[0];
      if (separationB > totalRadius) return;
      var poly1;
      var poly2;
      var xf1;
      var xf2;
      var edge1 = 0;
      var flip = 0;
      var k_relativeTol = 0.98;
      var k_absoluteTol = 0.001;
      var tMat;
      if (separationB > k_relativeTol * separationA + k_absoluteTol) {
         poly1 = polyB;
         poly2 = polyA;
         xf1 = xfB;
         xf2 = xfA;
         edge1 = edgeB;
         manifold.m_type = b2Manifold.e_faceB;
         flip = 1;
      }
      else {
         poly1 = polyA;
         poly2 = polyB;
         xf1 = xfA;
         xf2 = xfB;
         edge1 = edgeA;
         manifold.m_type = b2Manifold.e_faceA;
         flip = 0;
      }
      var incidentEdge = b2Collision.s_incidentEdge;
      b2Collision.FindIncidentEdge(incidentEdge, poly1, xf1, edge1, poly2, xf2);
      var count1 = parseInt(poly1.m_vertexCount);
      var vertices1 = poly1.m_vertices;
      var local_v11 = vertices1[edge1];
      var local_v12;
      if (edge1 + 1 < count1) {
         local_v12 = vertices1[parseInt(edge1 + 1)];
      }
      else {
         local_v12 = vertices1[0];
      }
      var localTangent = b2Collision.s_localTangent;
      localTangent.Set(local_v12.x - local_v11.x, local_v12.y - local_v11.y);
      localTangent.Normalize();
      var localNormal = b2Collision.s_localNormal;
      localNormal.x = localTangent.y;
      localNormal.y = (-localTangent.x);
      var planePoint = b2Collision.s_planePoint;
      planePoint.Set(0.5 * (local_v11.x + local_v12.x), 0.5 * (local_v11.y + local_v12.y));
      var tangent = b2Collision.s_tangent;
      tMat = xf1.R;
      tangent.x = (tMat.col1.x * localTangent.x + tMat.col2.x * localTangent.y);
      tangent.y = (tMat.col1.y * localTangent.x + tMat.col2.y * localTangent.y);
      var tangent2 = b2Collision.s_tangent2;
      tangent2.x = (-tangent.x);
      tangent2.y = (-tangent.y);
      var normal = b2Collision.s_normal;
      normal.x = tangent.y;
      normal.y = (-tangent.x);
      var v11 = b2Collision.s_v11;
      var v12 = b2Collision.s_v12;
      v11.x = xf1.position.x + (tMat.col1.x * local_v11.x + tMat.col2.x * local_v11.y);
      v11.y = xf1.position.y + (tMat.col1.y * local_v11.x + tMat.col2.y * local_v11.y);
      v12.x = xf1.position.x + (tMat.col1.x * local_v12.x + tMat.col2.x * local_v12.y);
      v12.y = xf1.position.y + (tMat.col1.y * local_v12.x + tMat.col2.y * local_v12.y);
      var frontOffset = normal.x * v11.x + normal.y * v11.y;
      var sideOffset1 = (-tangent.x * v11.x) - tangent.y * v11.y + totalRadius;
      var sideOffset2 = tangent.x * v12.x + tangent.y * v12.y + totalRadius;
      var clipPoints1 = b2Collision.s_clipPoints1;
      var clipPoints2 = b2Collision.s_clipPoints2;
      var np = 0;
      np = b2Collision.ClipSegmentToLine(clipPoints1, incidentEdge, tangent2, sideOffset1);
      if (np < 2) return;
      np = b2Collision.ClipSegmentToLine(clipPoints2, clipPoints1, tangent, sideOffset2);
      if (np < 2) return;
      manifold.m_localPlaneNormal.SetV(localNormal);
      manifold.m_localPoint.SetV(planePoint);
      var pointCount = 0;
      for (var i = 0; i < b2Settings.b2_maxManifoldPoints; ++i) {
         cv = clipPoints2[i];
         var separation = normal.x * cv.v.x + normal.y * cv.v.y - frontOffset;
         if (separation <= totalRadius) {
            var cp = manifold.m_points[pointCount];
            tMat = xf2.R;
            var tX = cv.v.x - xf2.position.x;
            var tY = cv.v.y - xf2.position.y;
            cp.m_localPoint.x = (tX * tMat.col1.x + tY * tMat.col1.y);
            cp.m_localPoint.y = (tX * tMat.col2.x + tY * tMat.col2.y);
            cp.m_id.Set(cv.id);
            cp.m_id.features.flip = flip;
            ++pointCount;
         }
      }
      manifold.m_pointCount = pointCount;
   }
   b2Collision.CollideCircles = function (manifold, circle1, xf1, circle2, xf2) {
      manifold.m_pointCount = 0;
      var tMat;
      var tVec;
      tMat = xf1.R;
      tVec = circle1.m_p;
      var p1X = xf1.position.x + (tMat.col1.x * tVec.x + tMat.col2.x * tVec.y);
      var p1Y = xf1.position.y + (tMat.col1.y * tVec.x + tMat.col2.y * tVec.y);
      tMat = xf2.R;
      tVec = circle2.m_p;
      var p2X = xf2.position.x + (tMat.col1.x * tVec.x + tMat.col2.x * tVec.y);
      var p2Y = xf2.position.y + (tMat.col1.y * tVec.x + tMat.col2.y * tVec.y);
      var dX = p2X - p1X;
      var dY = p2Y - p1Y;
      var distSqr = dX * dX + dY * dY;
      var radius = circle1.m_radius + circle2.m_radius;
      if (distSqr > radius * radius) {
         return;
      }
      manifold.m_type = b2Manifold.e_circles;
      manifold.m_localPoint.SetV(circle1.m_p);
      manifold.m_localPlaneNormal.SetZero();
      manifold.m_pointCount = 1;
      manifold.m_points[0].m_localPoint.SetV(circle2.m_p);
      manifold.m_points[0].m_id.key = 0;
   }
   b2Collision.CollidePolygonAndCircle = function (manifold, polygon, xf1, circle, xf2) {
      manifold.m_pointCount = 0;
      var tPoint;
      var dX = 0;
      var dY = 0;
      var positionX = 0;
      var positionY = 0;
      var tVec;
      var tMat;
      tMat = xf2.R;
      tVec = circle.m_p;
      var cX = xf2.position.x + (tMat.col1.x * tVec.x + tMat.col2.x * tVec.y);
      var cY = xf2.position.y + (tMat.col1.y * tVec.x + tMat.col2.y * tVec.y);
      dX = cX - xf1.position.x;
      dY = cY - xf1.position.y;
      tMat = xf1.R;
      var cLocalX = (dX * tMat.col1.x + dY * tMat.col1.y);
      var cLocalY = (dX * tMat.col2.x + dY * tMat.col2.y);
      var dist = 0;
      var normalIndex = 0;
      var separation = (-Number.MAX_VALUE);
      var radius = polygon.m_radius + circle.m_radius;
      var vertexCount = parseInt(polygon.m_vertexCount);
      var vertices = polygon.m_vertices;
      var normals = polygon.m_normals;
      for (var i = 0; i < vertexCount; ++i) {
         tVec = vertices[i];
         dX = cLocalX - tVec.x;
         dY = cLocalY - tVec.y;
         tVec = normals[i];
         var s = tVec.x * dX + tVec.y * dY;
         if (s > radius) {
            return;
         }
         if (s > separation) {
            separation = s;
            normalIndex = i;
         }
      }
      var vertIndex1 = parseInt(normalIndex);
      var vertIndex2 = parseInt(vertIndex1 + 1 < vertexCount ? vertIndex1 + 1 : 0);
      var v1 = vertices[vertIndex1];
      var v2 = vertices[vertIndex2];
      if (separation < Number.MIN_VALUE) {
         manifold.m_pointCount = 1;
         manifold.m_type = b2Manifold.e_faceA;
         manifold.m_localPlaneNormal.SetV(normals[normalIndex]);
         manifold.m_localPoint.x = 0.5 * (v1.x + v2.x);
         manifold.m_localPoint.y = 0.5 * (v1.y + v2.y);
         manifold.m_points[0].m_localPoint.SetV(circle.m_p);
         manifold.m_points[0].m_id.key = 0;
         return;
      }
      var u1 = (cLocalX - v1.x) * (v2.x - v1.x) + (cLocalY - v1.y) * (v2.y - v1.y);
      var u2 = (cLocalX - v2.x) * (v1.x - v2.x) + (cLocalY - v2.y) * (v1.y - v2.y);
      if (u1 <= 0.0) {
         if ((cLocalX - v1.x) * (cLocalX - v1.x) + (cLocalY - v1.y) * (cLocalY - v1.y) > radius * radius) return;
         manifold.m_pointCount = 1;
         manifold.m_type = b2Manifold.e_faceA;
         manifold.m_localPlaneNormal.x = cLocalX - v1.x;
         manifold.m_localPlaneNormal.y = cLocalY - v1.y;
         manifold.m_localPlaneNormal.Normalize();
         manifold.m_localPoint.SetV(v1);
         manifold.m_points[0].m_localPoint.SetV(circle.m_p);
         manifold.m_points[0].m_id.key = 0;
      }
      else if (u2 <= 0) {
         if ((cLocalX - v2.x) * (cLocalX - v2.x) + (cLocalY - v2.y) * (cLocalY - v2.y) > radius * radius) return;
         manifold.m_pointCount = 1;
         manifold.m_type = b2Manifold.e_faceA;
         manifold.m_localPlaneNormal.x = cLocalX - v2.x;
         manifold.m_localPlaneNormal.y = cLocalY - v2.y;
         manifold.m_localPlaneNormal.Normalize();
         manifold.m_localPoint.SetV(v2);
         manifold.m_points[0].m_localPoint.SetV(circle.m_p);
         manifold.m_points[0].m_id.key = 0;
      }
      else {
         var faceCenterX = 0.5 * (v1.x + v2.x);
         var faceCenterY = 0.5 * (v1.y + v2.y);
         separation = (cLocalX - faceCenterX) * normals[vertIndex1].x + (cLocalY - faceCenterY) * normals[vertIndex1].y;
         if (separation > radius) return;
         manifold.m_pointCount = 1;
         manifold.m_type = b2Manifold.e_faceA;
         manifold.m_localPlaneNormal.x = normals[vertIndex1].x;
         manifold.m_localPlaneNormal.y = normals[vertIndex1].y;
         manifold.m_localPlaneNormal.Normalize();
         manifold.m_localPoint.Set(faceCenterX, faceCenterY);
         manifold.m_points[0].m_localPoint.SetV(circle.m_p);
         manifold.m_points[0].m_id.key = 0;
      }
   }
   b2Collision.TestOverlap = function (a, b) {
      var t1 = b.lowerBound;
      var t2 = a.upperBound;
      var d1X = t1.x - t2.x;
      var d1Y = t1.y - t2.y;
      t1 = a.lowerBound;
      t2 = b.upperBound;
      var d2X = t1.x - t2.x;
      var d2Y = t1.y - t2.y;
      if (d1X > 0.0 || d1Y > 0.0) return false;
      if (d2X > 0.0 || d2Y > 0.0) return false;
      return true;
   }
   Box2D.postDefs.push(function () {
      Box2D.Collision.b2Collision.s_incidentEdge = b2Collision.MakeClipPointVector();
      Box2D.Collision.b2Collision.s_clipPoints1 = b2Collision.MakeClipPointVector();
      Box2D.Collision.b2Collision.s_clipPoints2 = b2Collision.MakeClipPointVector();
      Box2D.Collision.b2Collision.s_edgeAO = new Vector_a2j_Number(1);
      Box2D.Collision.b2Collision.s_edgeBO = new Vector_a2j_Number(1);
      Box2D.Collision.b2Collision.s_localTangent = new b2Vec2();
      Box2D.Collision.b2Collision.s_localNormal = new b2Vec2();
      Box2D.Collision.b2Collision.s_planePoint = new b2Vec2();
      Box2D.Collision.b2Collision.s_normal = new b2Vec2();
      Box2D.Collision.b2Collision.s_tangent = new b2Vec2();
      Box2D.Collision.b2Collision.s_tangent2 = new b2Vec2();
      Box2D.Collision.b2Collision.s_v11 = new b2Vec2();
      Box2D.Collision.b2Collision.s_v12 = new b2Vec2();
      Box2D.Collision.b2Collision.b2CollidePolyTempVec = new b2Vec2();
      Box2D.Collision.b2Collision.b2_nullFeature = 0x000000ff;
   });
   b2ContactID.b2ContactID = function () {
      this.features = new Features();
   };
   b2ContactID.prototype.b2ContactID = function () {
      this.features._m_id = this;
   }
   b2ContactID.prototype.Set = function (id) {
      this.key = id._key;
   }
   b2ContactID.prototype.Copy = function () {
      var id = new b2ContactID();
      id.key = this.key;
      return id;
   }
   Object.defineProperty(b2ContactID.prototype, 'key', {
      enumerable: false,
      configurable: true,
      get: function () {
         return this._key;
      }
   });
   Object.defineProperty(b2ContactID.prototype, 'key', {
      enumerable: false,
      configurable: true,
      set: function (value) {
         if (value === undefined) value = 0;
         this._key = value;
         this.features._referenceEdge = this._key & 0x000000ff;
         this.features._incidentEdge = ((this._key & 0x0000ff00) >> 8) & 0x000000ff;
         this.features._incidentVertex = ((this._key & 0x00ff0000) >> 16) & 0x000000ff;
         this.features._flip = ((this._key & 0xff000000) >> 24) & 0x000000ff;
      }
   });
   b2ContactPoint.b2ContactPoint = function () {
      this.position = new b2Vec2();
      this.velocity = new b2Vec2();
      this.normal = new b2Vec2();
      this.id = new b2ContactID();
   };
   b2Distance.b2Distance = function () {};
   b2Distance.Distance = function (output, cache, input) {
      ++b2Distance.b2_gjkCalls;
      var proxyA = input.proxyA;
      var proxyB = input.proxyB;
      var transformA = input.transformA;
      var transformB = input.transformB;
      var simplex = b2Distance.s_simplex;
      simplex.ReadCache(cache, proxyA, transformA, proxyB, transformB);
      var vertices = simplex.m_vertices;
      var k_maxIters = 20;
      var saveA = b2Distance.s_saveA;
      var saveB = b2Distance.s_saveB;
      var saveCount = 0;
      var closestPoint = simplex.GetClosestPoint();
      var distanceSqr1 = closestPoint.LengthSquared();
      var distanceSqr2 = distanceSqr1;
      var i = 0;
      var p;
      var iter = 0;
      while (iter < k_maxIters) {
         saveCount = simplex.m_count;
         for (i = 0;
         i < saveCount; i++) {
            saveA[i] = vertices[i].indexA;
            saveB[i] = vertices[i].indexB;
         }
         switch (simplex.m_count) {
         case 1:
            break;
         case 2:
            simplex.Solve2();
            break;
         case 3:
            simplex.Solve3();
            break;
         default:
            b2Settings.b2Assert(false);
         }
         if (simplex.m_count == 3) {
            break;
         }
         p = simplex.GetClosestPoint();
         distanceSqr2 = p.LengthSquared();
         if (distanceSqr2 > distanceSqr1) {}
         distanceSqr1 = distanceSqr2;
         var d = simplex.GetSearchDirection();
         if (d.LengthSquared() < Number.MIN_VALUE * Number.MIN_VALUE) {
            break;
         }
         var vertex = vertices[simplex.m_count];
         vertex.indexA = proxyA.GetSupport(b2Math.MulTMV(transformA.R, d.GetNegative()));
         vertex.wA = b2Math.MulX(transformA, proxyA.GetVertex(vertex.indexA));
         vertex.indexB = proxyB.GetSupport(b2Math.MulTMV(transformB.R, d));
         vertex.wB = b2Math.MulX(transformB, proxyB.GetVertex(vertex.indexB));
         vertex.w = b2Math.SubtractVV(vertex.wB, vertex.wA);
         ++iter;
         ++b2Distance.b2_gjkIters;
         var duplicate = false;
         for (i = 0;
         i < saveCount; i++) {
            if (vertex.indexA == saveA[i] && vertex.indexB == saveB[i]) {
               duplicate = true;
               break;
            }
         }
         if (duplicate) {
            break;
         }++simplex.m_count;
      }
      b2Distance.b2_gjkMaxIters = b2Math.Max(b2Distance.b2_gjkMaxIters, iter);
      simplex.GetWitnessPoints(output.pointA, output.pointB);
      output.distance = b2Math.SubtractVV(output.pointA, output.pointB).Length();
      output.iterations = iter;
      simplex.WriteCache(cache);
      if (input.useRadii) {
         var rA = proxyA.m_radius;
         var rB = proxyB.m_radius;
         if (output.distance > rA + rB && output.distance > Number.MIN_VALUE) {
            output.distance -= rA + rB;
            var normal = b2Math.SubtractVV(output.pointB, output.pointA);
            normal.Normalize();
            output.pointA.x += rA * normal.x;
            output.pointA.y += rA * normal.y;
            output.pointB.x -= rB * normal.x;
            output.pointB.y -= rB * normal.y;
         }
         else {
            p = new b2Vec2();
            p.x = .5 * (output.pointA.x + output.pointB.x);
            p.y = .5 * (output.pointA.y + output.pointB.y);
            output.pointA.x = output.pointB.x = p.x;
            output.pointA.y = output.pointB.y = p.y;
            output.distance = 0.0;
         }
      }
   }
   Box2D.postDefs.push(function () {
      Box2D.Collision.b2Distance.s_simplex = new b2Simplex();
      Box2D.Collision.b2Distance.s_saveA = new Vector_a2j_Number(3);
      Box2D.Collision.b2Distance.s_saveB = new Vector_a2j_Number(3);
   });
   b2DistanceInput.b2DistanceInput = function () {};
   b2DistanceOutput.b2DistanceOutput = function () {
      this.pointA = new b2Vec2();
      this.pointB = new b2Vec2();
   };
   b2DistanceProxy.b2DistanceProxy = function () {};
   b2DistanceProxy.prototype.Set = function (shape) {
      switch (shape.GetType()) {
      case b2Shape.e_circleShape:
         {
            var circle = (shape instanceof b2CircleShape ? shape : null);
            this.m_vertices = new Vector(1, true);
            this.m_vertices[0] = circle.m_p;
            this.m_count = 1;
            this.m_radius = circle.m_radius;
         }
         break;
      case b2Shape.e_polygonShape:
         {
            var polygon = (shape instanceof b2PolygonShape ? shape : null);
            this.m_vertices = polygon.m_vertices;
            this.m_count = polygon.m_vertexCount;
            this.m_radius = polygon.m_radius;
         }
         break;
      default:
         b2Settings.b2Assert(false);
      }
   }
   b2DistanceProxy.prototype.GetSupport = function (d) {
      var bestIndex = 0;
      var bestValue = this.m_vertices[0].x * d.x + this.m_vertices[0].y * d.y;
      for (var i = 1; i < this.m_count; ++i) {
         var value = this.m_vertices[i].x * d.x + this.m_vertices[i].y * d.y;
         if (value > bestValue) {
            bestIndex = i;
            bestValue = value;
         }
      }
      return bestIndex;
   }
   b2DistanceProxy.prototype.GetSupportVertex = function (d) {
      var bestIndex = 0;
      var bestValue = this.m_vertices[0].x * d.x + this.m_vertices[0].y * d.y;
      for (var i = 1; i < this.m_count; ++i) {
         var value = this.m_vertices[i].x * d.x + this.m_vertices[i].y * d.y;
         if (value > bestValue) {
            bestIndex = i;
            bestValue = value;
         }
      }
      return this.m_vertices[bestIndex];
   }
   b2DistanceProxy.prototype.GetVertexCount = function () {
      return this.m_count;
   }
   b2DistanceProxy.prototype.GetVertex = function (index) {
      if (index === undefined) index = 0;
      b2Settings.b2Assert(0 <= index && index < this.m_count);
      return this.m_vertices[index];
   }
   b2DynamicTree.b2DynamicTree = function () {};
   b2DynamicTree.prototype.b2DynamicTree = function () {
      this.m_root = null;
      this.m_freeList = null;
      this.m_path = 0;
      this.m_insertionCount = 0;
   }
   b2DynamicTree.prototype.CreateProxy = function (aabb, userData) {
      var node = this.AllocateNode();
      var extendX = b2Settings.b2_aabbExtension;
      var extendY = b2Settings.b2_aabbExtension;
      node.aabb.lowerBound.x = aabb.lowerBound.x - extendX;
      node.aabb.lowerBound.y = aabb.lowerBound.y - extendY;
      node.aabb.upperBound.x = aabb.upperBound.x + extendX;
      node.aabb.upperBound.y = aabb.upperBound.y + extendY;
      node.userData = userData;
      this.InsertLeaf(node);
      return node;
   }
   b2DynamicTree.prototype.DestroyProxy = function (proxy) {
      this.RemoveLeaf(proxy);
      this.FreeNode(proxy);
   }
   b2DynamicTree.prototype.MoveProxy = function (proxy, aabb, displacement) {
      b2Settings.b2Assert(proxy.IsLeaf());
      if (proxy.aabb.Contains(aabb)) {
         return false;
      }
      this.RemoveLeaf(proxy);
      var extendX = b2Settings.b2_aabbExtension + b2Settings.b2_aabbMultiplier * (displacement.x > 0 ? displacement.x : (-displacement.x));
      var extendY = b2Settings.b2_aabbExtension + b2Settings.b2_aabbMultiplier * (displacement.y > 0 ? displacement.y : (-displacement.y));
      proxy.aabb.lowerBound.x = aabb.lowerBound.x - extendX;
      proxy.aabb.lowerBound.y = aabb.lowerBound.y - extendY;
      proxy.aabb.upperBound.x = aabb.upperBound.x + extendX;
      proxy.aabb.upperBound.y = aabb.upperBound.y + extendY;
      this.InsertLeaf(proxy);
      return true;
   }
   b2DynamicTree.prototype.Rebalance = function (iterations) {
      if (iterations === undefined) iterations = 0;
      if (this.m_root == null) return;
      for (var i = 0; i < iterations; i++) {
         var node = this.m_root;
         var bit = 0;
         while (node.IsLeaf() == false) {
            node = (this.m_path >> bit) & 1 ? node.child2 : node.child1;
            bit = (bit + 1) & 31;
         }++this.m_path;
         this.RemoveLeaf(node);
         this.InsertLeaf(node);
      }
   }
   b2DynamicTree.prototype.GetFatAABB = function (proxy) {
      return proxy.aabb;
   }
   b2DynamicTree.prototype.GetUserData = function (proxy) {
      return proxy.userData;
   }
   b2DynamicTree.prototype.Query = function (callback, aabb) {
      if (this.m_root == null) return;
      var stack = new Vector();
      var count = 0;
      stack[count++] = this.m_root;
      while (count > 0) {
         var node = stack[--count];
         if (node.aabb.TestOverlap(aabb)) {
            if (node.IsLeaf()) {
               var proceed = callback(node);
               if (!proceed) return;
            }
            else {
               stack[count++] = node.child1;
               stack[count++] = node.child2;
            }
         }
      }
   }
   b2DynamicTree.prototype.RayCast = function (callback, input) {
      if (this.m_root == null) return;
      var p1 = input.p1;
      var p2 = input.p2;
      var r = b2Math.SubtractVV(p1, p2);
      r.Normalize();
      var v = b2Math.CrossFV(1.0, r);
      var abs_v = b2Math.AbsV(v);
      var maxFraction = input.maxFraction;
      var segmentAABB = new b2AABB();
      var tX = 0;
      var tY = 0; {
         tX = p1.x + maxFraction * (p2.x - p1.x);
         tY = p1.y + maxFraction * (p2.y - p1.y);
         segmentAABB.lowerBound.x = Math.min(p1.x, tX);
         segmentAABB.lowerBound.y = Math.min(p1.y, tY);
         segmentAABB.upperBound.x = Math.max(p1.x, tX);
         segmentAABB.upperBound.y = Math.max(p1.y, tY);
      }
      var stack = new Vector();
      var count = 0;
      stack[count++] = this.m_root;
      while (count > 0) {
         var node = stack[--count];
         if (node.aabb.TestOverlap(segmentAABB) == false) {
            continue;
         }
         var c = node.aabb.GetCenter();
         var h = node.aabb.GetExtents();
         var separation = Math.abs(v.x * (p1.x - c.x) + v.y * (p1.y - c.y)) - abs_v.x * h.x - abs_v.y * h.y;
         if (separation > 0.0) continue;
         if (node.IsLeaf()) {
            var subInput = new b2RayCastInput();
            subInput.p1 = input.p1;
            subInput.p2 = input.p2;
            subInput.maxFraction = input.maxFraction;
            maxFraction = callback(subInput, node);
            if (maxFraction == 0.0) return;
            if (maxFraction > 0.0) {
               tX = p1.x + maxFraction * (p2.x - p1.x);
               tY = p1.y + maxFraction * (p2.y - p1.y);
               segmentAABB.lowerBound.x = Math.min(p1.x, tX);
               segmentAABB.lowerBound.y = Math.min(p1.y, tY);
               segmentAABB.upperBound.x = Math.max(p1.x, tX);
               segmentAABB.upperBound.y = Math.max(p1.y, tY);
            }
         }
         else {
            stack[count++] = node.child1;
            stack[count++] = node.child2;
         }
      }
   }
   b2DynamicTree.prototype.AllocateNode = function () {
      if (this.m_freeList) {
         var node = this.m_freeList;
         this.m_freeList = node.parent;
         node.parent = null;
         node.child1 = null;
         node.child2 = null;
         return node;
      }
      return new b2DynamicTreeNode();
   }
   b2DynamicTree.prototype.FreeNode = function (node) {
      node.parent = this.m_freeList;
      this.m_freeList = node;
   }
   b2DynamicTree.prototype.InsertLeaf = function (leaf) {
      ++this.m_insertionCount;
      if (this.m_root == null) {
         this.m_root = leaf;
         this.m_root.parent = null;
         return;
      }
      var center = leaf.aabb.GetCenter();
      var sibling = this.m_root;
      if (sibling.IsLeaf() == false) {
         do {
            var child1 = sibling.child1;
            var child2 = sibling.child2;
            var norm1 = Math.abs((child1.aabb.lowerBound.x + child1.aabb.upperBound.x) / 2 - center.x) + Math.abs((child1.aabb.lowerBound.y + child1.aabb.upperBound.y) / 2 - center.y);
            var norm2 = Math.abs((child2.aabb.lowerBound.x + child2.aabb.upperBound.x) / 2 - center.x) + Math.abs((child2.aabb.lowerBound.y + child2.aabb.upperBound.y) / 2 - center.y);
            if (norm1 < norm2) {
               sibling = child1;
            }
            else {
               sibling = child2;
            }
         }
         while (sibling.IsLeaf() == false)
      }
      var node1 = sibling.parent;
      var node2 = this.AllocateNode();
      node2.parent = node1;
      node2.userData = null;
      node2.aabb.Combine(leaf.aabb, sibling.aabb);
      if (node1) {
         if (sibling.parent.child1 == sibling) {
            node1.child1 = node2;
         }
         else {
            node1.child2 = node2;
         }
         node2.child1 = sibling;
         node2.child2 = leaf;
         sibling.parent = node2;
         leaf.parent = node2;
         do {
            if (node1.aabb.Contains(node2.aabb)) break;
            node1.aabb.Combine(node1.child1.aabb, node1.child2.aabb);
            node2 = node1;
            node1 = node1.parent;
         }
         while (node1)
      }
      else {
         node2.child1 = sibling;
         node2.child2 = leaf;
         sibling.parent = node2;
         leaf.parent = node2;
         this.m_root = node2;
      }
   }
   b2DynamicTree.prototype.RemoveLeaf = function (leaf) {
      if (leaf == this.m_root) {
         this.m_root = null;
         return;
      }
      var node2 = leaf.parent;
      var node1 = node2.parent;
      var sibling;
      if (node2.child1 == leaf) {
         sibling = node2.child2;
      }
      else {
         sibling = node2.child1;
      }
      if (node1) {
         if (node1.child1 == node2) {
            node1.child1 = sibling;
         }
         else {
            node1.child2 = sibling;
         }
         sibling.parent = node1;
         this.FreeNode(node2);
         while (node1) {
            var oldAABB = node1.aabb;
            node1.aabb = b2AABB.Combine(node1.child1.aabb, node1.child2.aabb);
            if (oldAABB.Contains(node1.aabb)) break;
            node1 = node1.parent;
         }
      }
      else {
         this.m_root = sibling;
         sibling.parent = null;
         this.FreeNode(node2);
      }
   }
   b2DynamicTreeBroadPhase.b2DynamicTreeBroadPhase = function () {
      this.m_tree = new b2DynamicTree();
      this.m_moveBuffer = new Vector();
      this.m_pairBuffer = new Vector();
      this.m_pairCount = 0;
   };
   b2DynamicTreeBroadPhase.prototype.CreateProxy = function (aabb, userData) {
      var proxy = this.m_tree.CreateProxy(aabb, userData);
      ++this.m_proxyCount;
      this.BufferMove(proxy);
      return proxy;
   }
   b2DynamicTreeBroadPhase.prototype.DestroyProxy = function (proxy) {
      this.UnBufferMove(proxy);
      --this.m_proxyCount;
      this.m_tree.DestroyProxy(proxy);
   }
   b2DynamicTreeBroadPhase.prototype.MoveProxy = function (proxy, aabb, displacement) {
      var buffer = this.m_tree.MoveProxy(proxy, aabb, displacement);
      if (buffer) {
         this.BufferMove(proxy);
      }
   }
   b2DynamicTreeBroadPhase.prototype.TestOverlap = function (proxyA, proxyB) {
      var aabbA = this.m_tree.GetFatAABB(proxyA);
      var aabbB = this.m_tree.GetFatAABB(proxyB);
      return aabbA.TestOverlap(aabbB);
   }
   b2DynamicTreeBroadPhase.prototype.GetUserData = function (proxy) {
      return this.m_tree.GetUserData(proxy);
   }
   b2DynamicTreeBroadPhase.prototype.GetFatAABB = function (proxy) {
      return this.m_tree.GetFatAABB(proxy);
   }
   b2DynamicTreeBroadPhase.prototype.GetProxyCount = function () {
      return this.m_proxyCount;
   }
   b2DynamicTreeBroadPhase.prototype.UpdatePairs = function (callback) {
      var __this = this;
      __this.m_pairCount = 0;
      var i = 0,
         queryProxy;
       function QueryCallback(proxy) {
          if (proxy == queryProxy) return true;
          if (__this.m_pairCount == __this.m_pairBuffer.length) {
             __this.m_pairBuffer[__this.m_pairCount] = new b2DynamicTreePair();
          }
          var pair = __this.m_pairBuffer[__this.m_pairCount];
          pair.proxyA = proxy < queryProxy ? proxy : queryProxy;
          pair.proxyB = proxy >= queryProxy ? proxy : queryProxy;++__this.m_pairCount;
          return true;
       };
      for (i = 0;
      i < __this.m_moveBuffer.length; ++i) {
         queryProxy = __this.m_moveBuffer[i];
         var fatAABB = __this.m_tree.GetFatAABB(queryProxy);
         __this.m_tree.Query(QueryCallback, fatAABB);
      }
      __this.m_moveBuffer.length = 0;
      for (var i = 0; i < __this.m_pairCount;) {
         var primaryPair = __this.m_pairBuffer[i];
         var userDataA = __this.m_tree.GetUserData(primaryPair.proxyA);
         var userDataB = __this.m_tree.GetUserData(primaryPair.proxyB);
         callback(userDataA, userDataB);
         ++i;
         while (i < __this.m_pairCount) {
            var pair = __this.m_pairBuffer[i];
            if (pair.proxyA != primaryPair.proxyA || pair.proxyB != primaryPair.proxyB) {
               break;
            }++i;
         }
      }
   }
   b2DynamicTreeBroadPhase.prototype.Query = function (callback, aabb) {
      this.m_tree.Query(callback, aabb);
   }
   b2DynamicTreeBroadPhase.prototype.RayCast = function (callback, input) {
      this.m_tree.RayCast(callback, input);
   }
   b2DynamicTreeBroadPhase.prototype.Validate = function () {}
   b2DynamicTreeBroadPhase.prototype.Rebalance = function (iterations) {
      if (iterations === undefined) iterations = 0;
      this.m_tree.Rebalance(iterations);
   }
   b2DynamicTreeBroadPhase.prototype.BufferMove = function (proxy) {
      this.m_moveBuffer[this.m_moveBuffer.length] = proxy;
   }
   b2DynamicTreeBroadPhase.prototype.UnBufferMove = function (proxy) {
      var i = parseInt(this.m_moveBuffer.indexOf(proxy));
      this.m_moveBuffer.splice(i, 1);
   }
   b2DynamicTreeBroadPhase.prototype.ComparePairs = function (pair1, pair2) {
      return 0;
   }
   b2DynamicTreeBroadPhase.__implements = {};
   b2DynamicTreeBroadPhase.__implements[IBroadPhase] = true;
   b2DynamicTreeNode.b2DynamicTreeNode = function () {
      this.aabb = new b2AABB();
   };
   b2DynamicTreeNode.prototype.IsLeaf = function () {
      return this.child1 == null;
   }
   b2DynamicTreePair.b2DynamicTreePair = function () {};
   b2Manifold.b2Manifold = function () {
      this.m_pointCount = 0;
   };
   b2Manifold.prototype.b2Manifold = function () {
      this.m_points = new Vector(b2Settings.b2_maxManifoldPoints);
      for (var i = 0; i < b2Settings.b2_maxManifoldPoints; i++) {
         this.m_points[i] = new b2ManifoldPoint();
      }
      this.m_localPlaneNormal = new b2Vec2();
      this.m_localPoint = new b2Vec2();
   }
   b2Manifold.prototype.Reset = function () {
      for (var i = 0; i < b2Settings.b2_maxManifoldPoints; i++) {
         ((this.m_points[i] instanceof b2ManifoldPoint ? this.m_points[i] : null)).Reset();
      }
      this.m_localPlaneNormal.SetZero();
      this.m_localPoint.SetZero();
      this.m_type = 0;
      this.m_pointCount = 0;
   }
   b2Manifold.prototype.Set = function (m) {
      this.m_pointCount = m.m_pointCount;
      for (var i = 0; i < b2Settings.b2_maxManifoldPoints; i++) {
         ((this.m_points[i] instanceof b2ManifoldPoint ? this.m_points[i] : null)).Set(m.m_points[i]);
      }
      this.m_localPlaneNormal.SetV(m.m_localPlaneNormal);
      this.m_localPoint.SetV(m.m_localPoint);
      this.m_type = m.m_type;
   }
   b2Manifold.prototype.Copy = function () {
      var copy = new b2Manifold();
      copy.Set(this);
      return copy;
   }
   Box2D.postDefs.push(function () {
      Box2D.Collision.b2Manifold.e_circles = 0x0001;
      Box2D.Collision.b2Manifold.e_faceA = 0x0002;
      Box2D.Collision.b2Manifold.e_faceB = 0x0004;
   });
   b2ManifoldPoint.b2ManifoldPoint = function () {
      this.m_localPoint = new b2Vec2();
      this.m_id = new b2ContactID();
   };
   b2ManifoldPoint.prototype.b2ManifoldPoint = function () {
      this.Reset();
   }
   b2ManifoldPoint.prototype.Reset = function () {
      this.m_localPoint.SetZero();
      this.m_normalImpulse = 0.0;
      this.m_tangentImpulse = 0.0;
      this.m_id.key = 0;
   }
   b2ManifoldPoint.prototype.Set = function (m) {
      this.m_localPoint.SetV(m.m_localPoint);
      this.m_normalImpulse = m.m_normalImpulse;
      this.m_tangentImpulse = m.m_tangentImpulse;
      this.m_id.Set(m.m_id);
   }
   b2Point.b2Point = function () {
      this.p = new b2Vec2();
   };
   b2Point.prototype.Support = function (xf, vX, vY) {
      if (vX === undefined) vX = 0;
      if (vY === undefined) vY = 0;
      return this.p;
   }
   b2Point.prototype.GetFirstVertex = function (xf) {
      return this.p;
   }
   b2RayCastInput.b2RayCastInput = function () {
      this.p1 = new b2Vec2();
      this.p2 = new b2Vec2();
   };
   b2RayCastInput.prototype.b2RayCastInput = function (p1, p2, maxFraction) {
      if (p1 === undefined) p1 = null;
      if (p2 === undefined) p2 = null;
      if (maxFraction === undefined) maxFraction = 1;
      if (p1) this.p1.SetV(p1);
      if (p2) this.p2.SetV(p2);
      this.maxFraction = maxFraction;
   }
   b2RayCastOutput.b2RayCastOutput = function () {
      this.normal = new b2Vec2();
   };
   b2Segment.b2Segment = function () {
      this.p1 = new b2Vec2();
      this.p2 = new b2Vec2();
   };
   b2Segment.prototype.TestSegment = function (lambda, normal, segment, maxLambda) {
      if (maxLambda === undefined) maxLambda = 0;
      var s = segment.p1;
      var rX = segment.p2.x - s.x;
      var rY = segment.p2.y - s.y;
      var dX = this.p2.x - this.p1.x;
      var dY = this.p2.y - this.p1.y;
      var nX = dY;
      var nY = (-dX);
      var k_slop = 100.0 * Number.MIN_VALUE;
      var denom = (-(rX * nX + rY * nY));
      if (denom > k_slop) {
         var bX = s.x - this.p1.x;
         var bY = s.y - this.p1.y;
         var a = (bX * nX + bY * nY);
         if (0.0 <= a && a <= maxLambda * denom) {
            var mu2 = (-rX * bY) + rY * bX;
            if ((-k_slop * denom) <= mu2 && mu2 <= denom * (1.0 + k_slop)) {
               a /= denom;
               var nLen = Math.sqrt(nX * nX + nY * nY);
               nX /= nLen;
               nY /= nLen;
               lambda[0] = a;
               normal.Set(nX, nY);
               return true;
            }
         }
      }
      return false;
   }
   b2Segment.prototype.Extend = function (aabb) {
      this.ExtendForward(aabb);
      this.ExtendBackward(aabb);
   }
   b2Segment.prototype.ExtendForward = function (aabb) {
      var dX = this.p2.x - this.p1.x;
      var dY = this.p2.y - this.p1.y;
      var lambda = Math.min(dX > 0 ? (aabb.upperBound.x - this.p1.x) / dX : dX < 0 ? (aabb.lowerBound.x - this.p1.x) / dX : Number.POSITIVE_INFINITY,
      dY > 0 ? (aabb.upperBound.y - this.p1.y) / dY : dY < 0 ? (aabb.lowerBound.y - this.p1.y) / dY : Number.POSITIVE_INFINITY);
      this.p2.x = this.p1.x + dX * lambda;
      this.p2.y = this.p1.y + dY * lambda;
   }
   b2Segment.prototype.ExtendBackward = function (aabb) {
      var dX = (-this.p2.x) + this.p1.x;
      var dY = (-this.p2.y) + this.p1.y;
      var lambda = Math.min(dX > 0 ? (aabb.upperBound.x - this.p2.x) / dX : dX < 0 ? (aabb.lowerBound.x - this.p2.x) / dX : Number.POSITIVE_INFINITY,
      dY > 0 ? (aabb.upperBound.y - this.p2.y) / dY : dY < 0 ? (aabb.lowerBound.y - this.p2.y) / dY : Number.POSITIVE_INFINITY);
      this.p1.x = this.p2.x + dX * lambda;
      this.p1.y = this.p2.y + dY * lambda;
   }
   b2SeparationFunction.b2SeparationFunction = function () {
      this.m_localPoint = new b2Vec2();
      this.m_axis = new b2Vec2();
   };
   b2SeparationFunction.prototype.Initialize = function (cache, proxyA, transformA, proxyB, transformB) {
      this.m_proxyA = proxyA;
      this.m_proxyB = proxyB;
      var count = parseInt(cache.count);
      b2Settings.b2Assert(0 < count && count < 3);
      var localPointA;
      var localPointA1;
      var localPointA2;
      var localPointB;
      var localPointB1;
      var localPointB2;
      var pointAX = 0;
      var pointAY = 0;
      var pointBX = 0;
      var pointBY = 0;
      var normalX = 0;
      var normalY = 0;
      var tMat;
      var tVec;
      var s = 0;
      var sgn = 0;
      if (count == 1) {
         this.m_type = b2SeparationFunction.e_points;
         localPointA = this.m_proxyA.GetVertex(cache.indexA[0]);
         localPointB = this.m_proxyB.GetVertex(cache.indexB[0]);
         tVec = localPointA;
         tMat = transformA.R;
         pointAX = transformA.position.x + (tMat.col1.x * tVec.x + tMat.col2.x * tVec.y);
         pointAY = transformA.position.y + (tMat.col1.y * tVec.x + tMat.col2.y * tVec.y);
         tVec = localPointB;
         tMat = transformB.R;
         pointBX = transformB.position.x + (tMat.col1.x * tVec.x + tMat.col2.x * tVec.y);
         pointBY = transformB.position.y + (tMat.col1.y * tVec.x + tMat.col2.y * tVec.y);
         this.m_axis.x = pointBX - pointAX;
         this.m_axis.y = pointBY - pointAY;
         this.m_axis.Normalize();
      }
      else if (cache.indexB[0] == cache.indexB[1]) {
         this.m_type = b2SeparationFunction.e_faceA;
         localPointA1 = this.m_proxyA.GetVertex(cache.indexA[0]);
         localPointA2 = this.m_proxyA.GetVertex(cache.indexA[1]);
         localPointB = this.m_proxyB.GetVertex(cache.indexB[0]);
         this.m_localPoint.x = 0.5 * (localPointA1.x + localPointA2.x);
         this.m_localPoint.y = 0.5 * (localPointA1.y + localPointA2.y);
         this.m_axis = b2Math.CrossVF(b2Math.SubtractVV(localPointA2, localPointA1), 1.0);
         this.m_axis.Normalize();
         tVec = this.m_axis;
         tMat = transformA.R;
         normalX = tMat.col1.x * tVec.x + tMat.col2.x * tVec.y;
         normalY = tMat.col1.y * tVec.x + tMat.col2.y * tVec.y;
         tVec = this.m_localPoint;
         tMat = transformA.R;
         pointAX = transformA.position.x + (tMat.col1.x * tVec.x + tMat.col2.x * tVec.y);
         pointAY = transformA.position.y + (tMat.col1.y * tVec.x + tMat.col2.y * tVec.y);
         tVec = localPointB;
         tMat = transformB.R;
         pointBX = transformB.position.x + (tMat.col1.x * tVec.x + tMat.col2.x * tVec.y);
         pointBY = transformB.position.y + (tMat.col1.y * tVec.x + tMat.col2.y * tVec.y);
         s = (pointBX - pointAX) * normalX + (pointBY - pointAY) * normalY;
         if (s < 0.0) {
            this.m_axis.NegativeSelf();
         }
      }
      else if (cache.indexA[0] == cache.indexA[0]) {
         this.m_type = b2SeparationFunction.e_faceB;
         localPointB1 = this.m_proxyB.GetVertex(cache.indexB[0]);
         localPointB2 = this.m_proxyB.GetVertex(cache.indexB[1]);
         localPointA = this.m_proxyA.GetVertex(cache.indexA[0]);
         this.m_localPoint.x = 0.5 * (localPointB1.x + localPointB2.x);
         this.m_localPoint.y = 0.5 * (localPointB1.y + localPointB2.y);
         this.m_axis = b2Math.CrossVF(b2Math.SubtractVV(localPointB2, localPointB1), 1.0);
         this.m_axis.Normalize();
         tVec = this.m_axis;
         tMat = transformB.R;
         normalX = tMat.col1.x * tVec.x + tMat.col2.x * tVec.y;
         normalY = tMat.col1.y * tVec.x + tMat.col2.y * tVec.y;
         tVec = this.m_localPoint;
         tMat = transformB.R;
         pointBX = transformB.position.x + (tMat.col1.x * tVec.x + tMat.col2.x * tVec.y);
         pointBY = transformB.position.y + (tMat.col1.y * tVec.x + tMat.col2.y * tVec.y);
         tVec = localPointA;
         tMat = transformA.R;
         pointAX = transformA.position.x + (tMat.col1.x * tVec.x + tMat.col2.x * tVec.y);
         pointAY = transformA.position.y + (tMat.col1.y * tVec.x + tMat.col2.y * tVec.y);
         s = (pointAX - pointBX) * normalX + (pointAY - pointBY) * normalY;
         if (s < 0.0) {
            this.m_axis.NegativeSelf();
         }
      }
      else {
         localPointA1 = this.m_proxyA.GetVertex(cache.indexA[0]);
         localPointA2 = this.m_proxyA.GetVertex(cache.indexA[1]);
         localPointB1 = this.m_proxyB.GetVertex(cache.indexB[0]);
         localPointB2 = this.m_proxyB.GetVertex(cache.indexB[1]);
         var pA = b2Math.MulX(transformA, localPointA);
         var dA = b2Math.MulMV(transformA.R, b2Math.SubtractVV(localPointA2, localPointA1));
         var pB = b2Math.MulX(transformB, localPointB);
         var dB = b2Math.MulMV(transformB.R, b2Math.SubtractVV(localPointB2, localPointB1));
         var a = dA.x * dA.x + dA.y * dA.y;
         var e = dB.x * dB.x + dB.y * dB.y;
         var r = b2Math.SubtractVV(dB, dA);
         var c = dA.x * r.x + dA.y * r.y;
         var f = dB.x * r.x + dB.y * r.y;
         var b = dA.x * dB.x + dA.y * dB.y;
         var denom = a * e - b * b;
         s = 0.0;
         if (denom != 0.0) {
            s = b2Math.Clamp((b * f - c * e) / denom, 0.0, 1.0);
         }
         var t = (b * s + f) / e;
         if (t < 0.0) {
            t = 0.0;
            s = b2Math.Clamp((b - c) / a, 0.0, 1.0);
         }
         localPointA = new b2Vec2();
         localPointA.x = localPointA1.x + s * (localPointA2.x - localPointA1.x);
         localPointA.y = localPointA1.y + s * (localPointA2.y - localPointA1.y);
         localPointB = new b2Vec2();
         localPointB.x = localPointB1.x + s * (localPointB2.x - localPointB1.x);
         localPointB.y = localPointB1.y + s * (localPointB2.y - localPointB1.y);
         if (s == 0.0 || s == 1.0) {
            this.m_type = b2SeparationFunction.e_faceB;
            this.m_axis = b2Math.CrossVF(b2Math.SubtractVV(localPointB2, localPointB1), 1.0);
            this.m_axis.Normalize();
            this.m_localPoint = localPointB;
            tVec = this.m_axis;
            tMat = transformB.R;
            normalX = tMat.col1.x * tVec.x + tMat.col2.x * tVec.y;
            normalY = tMat.col1.y * tVec.x + tMat.col2.y * tVec.y;
            tVec = this.m_localPoint;
            tMat = transformB.R;
            pointBX = transformB.position.x + (tMat.col1.x * tVec.x + tMat.col2.x * tVec.y);
            pointBY = transformB.position.y + (tMat.col1.y * tVec.x + tMat.col2.y * tVec.y);
            tVec = localPointA;
            tMat = transformA.R;
            pointAX = transformA.position.x + (tMat.col1.x * tVec.x + tMat.col2.x * tVec.y);
            pointAY = transformA.position.y + (tMat.col1.y * tVec.x + tMat.col2.y * tVec.y);
            sgn = (pointAX - pointBX) * normalX + (pointAY - pointBY) * normalY;
            if (s < 0.0) {
               this.m_axis.NegativeSelf();
            }
         }
         else {
            this.m_type = b2SeparationFunction.e_faceA;
            this.m_axis = b2Math.CrossVF(b2Math.SubtractVV(localPointA2, localPointA1), 1.0);
            this.m_localPoint = localPointA;
            tVec = this.m_axis;
            tMat = transformA.R;
            normalX = tMat.col1.x * tVec.x + tMat.col2.x * tVec.y;
            normalY = tMat.col1.y * tVec.x + tMat.col2.y * tVec.y;
            tVec = this.m_localPoint;
            tMat = transformA.R;
            pointAX = transformA.position.x + (tMat.col1.x * tVec.x + tMat.col2.x * tVec.y);
            pointAY = transformA.position.y + (tMat.col1.y * tVec.x + tMat.col2.y * tVec.y);
            tVec = localPointB;
            tMat = transformB.R;
            pointBX = transformB.position.x + (tMat.col1.x * tVec.x + tMat.col2.x * tVec.y);
            pointBY = transformB.position.y + (tMat.col1.y * tVec.x + tMat.col2.y * tVec.y);
            sgn = (pointBX - pointAX) * normalX + (pointBY - pointAY) * normalY;
            if (s < 0.0) {
               this.m_axis.NegativeSelf();
            }
         }
      }
   }
   b2SeparationFunction.prototype.Evaluate = function (transformA, transformB) {
      var axisA;
      var axisB;
      var localPointA;
      var localPointB;
      var pointA;
      var pointB;
      var seperation = 0;
      var normal;
      switch (this.m_type) {
      case b2SeparationFunction.e_points:
         {
            axisA = b2Math.MulTMV(transformA.R, this.m_axis);
            axisB = b2Math.MulTMV(transformB.R, this.m_axis.GetNegative());
            localPointA = this.m_proxyA.GetSupportVertex(axisA);
            localPointB = this.m_proxyB.GetSupportVertex(axisB);
            pointA = b2Math.MulX(transformA, localPointA);
            pointB = b2Math.MulX(transformB, localPointB);
            seperation = (pointB.x - pointA.x) * this.m_axis.x + (pointB.y - pointA.y) * this.m_axis.y;
            return seperation;
         }
      case b2SeparationFunction.e_faceA:
         {
            normal = b2Math.MulMV(transformA.R, this.m_axis);
            pointA = b2Math.MulX(transformA, this.m_localPoint);
            axisB = b2Math.MulTMV(transformB.R, normal.GetNegative());
            localPointB = this.m_proxyB.GetSupportVertex(axisB);
            pointB = b2Math.MulX(transformB, localPointB);
            seperation = (pointB.x - pointA.x) * normal.x + (pointB.y - pointA.y) * normal.y;
            return seperation;
         }
      case b2SeparationFunction.e_faceB:
         {
            normal = b2Math.MulMV(transformB.R, this.m_axis);
            pointB = b2Math.MulX(transformB, this.m_localPoint);
            axisA = b2Math.MulTMV(transformA.R, normal.GetNegative());
            localPointA = this.m_proxyA.GetSupportVertex(axisA);
            pointA = b2Math.MulX(transformA, localPointA);
            seperation = (pointA.x - pointB.x) * normal.x + (pointA.y - pointB.y) * normal.y;
            return seperation;
         }
      default:
         b2Settings.b2Assert(false);
         return 0.0;
      }
   }
   Box2D.postDefs.push(function () {
      Box2D.Collision.b2SeparationFunction.e_points = 0x01;
      Box2D.Collision.b2SeparationFunction.e_faceA = 0x02;
      Box2D.Collision.b2SeparationFunction.e_faceB = 0x04;
   });
   b2Simplex.b2Simplex = function () {
      this.m_v1 = new b2SimplexVertex();
      this.m_v2 = new b2SimplexVertex();
      this.m_v3 = new b2SimplexVertex();
      this.m_vertices = new Vector(3);
   };
   b2Simplex.prototype.b2Simplex = function () {
      this.m_vertices[0] = this.m_v1;
      this.m_vertices[1] = this.m_v2;
      this.m_vertices[2] = this.m_v3;
   }
   b2Simplex.prototype.ReadCache = function (cache, proxyA, transformA, proxyB, transformB) {
      b2Settings.b2Assert(0 <= cache.count && cache.count <= 3);
      var wALocal;
      var wBLocal;
      this.m_count = cache.count;
      var vertices = this.m_vertices;
      for (var i = 0; i < this.m_count; i++) {
         var v = vertices[i];
         v.indexA = cache.indexA[i];
         v.indexB = cache.indexB[i];
         wALocal = proxyA.GetVertex(v.indexA);
         wBLocal = proxyB.GetVertex(v.indexB);
         v.wA = b2Math.MulX(transformA, wALocal);
         v.wB = b2Math.MulX(transformB, wBLocal);
         v.w = b2Math.SubtractVV(v.wB, v.wA);
         v.a = 0;
      }
      if (this.m_count > 1) {
         var metric1 = cache.metric;
         var metric2 = this.GetMetric();
         if (metric2 < .5 * metric1 || 2.0 * metric1 < metric2 || metric2 < Number.MIN_VALUE) {
            this.m_count = 0;
         }
      }
      if (this.m_count == 0) {
         v = vertices[0];
         v.indexA = 0;
         v.indexB = 0;
         wALocal = proxyA.GetVertex(0);
         wBLocal = proxyB.GetVertex(0);
         v.wA = b2Math.MulX(transformA, wALocal);
         v.wB = b2Math.MulX(transformB, wBLocal);
         v.w = b2Math.SubtractVV(v.wB, v.wA);
         this.m_count = 1;
      }
   }
   b2Simplex.prototype.WriteCache = function (cache) {
      cache.metric = this.GetMetric();
      cache.count = Box2D.parseUInt(this.m_count);
      var vertices = this.m_vertices;
      for (var i = 0; i < this.m_count; i++) {
         cache.indexA[i] = Box2D.parseUInt(vertices[i].indexA);
         cache.indexB[i] = Box2D.parseUInt(vertices[i].indexB);
      }
   }
   b2Simplex.prototype.GetSearchDirection = function () {
      switch (this.m_count) {
      case 1:
         return this.m_v1.w.GetNegative();
      case 2:
         {
            var e12 = b2Math.SubtractVV(this.m_v2.w, this.m_v1.w);
            var sgn = b2Math.CrossVV(e12, this.m_v1.w.GetNegative());
            if (sgn > 0.0) {
               return b2Math.CrossFV(1.0, e12);
            }
            else {
               return b2Math.CrossVF(e12, 1.0);
            }
         }
      default:
         b2Settings.b2Assert(false);
         return new b2Vec2();
      }
   }
   b2Simplex.prototype.GetClosestPoint = function () {
      switch (this.m_count) {
      case 0:
         b2Settings.b2Assert(false);
         return new b2Vec2();
      case 1:
         return this.m_v1.w;
      case 2:
         return new b2Vec2(this.m_v1.a * this.m_v1.w.x + this.m_v2.a * this.m_v2.w.x, this.m_v1.a * this.m_v1.w.y + this.m_v2.a * this.m_v2.w.y);
      default:
         b2Settings.b2Assert(false);
         return new b2Vec2();
      }
   }
   b2Simplex.prototype.GetWitnessPoints = function (pA, pB) {
      switch (this.m_count) {
      case 0:
         b2Settings.b2Assert(false);
         break;
      case 1:
         pA.SetV(this.m_v1.wA);
         pB.SetV(this.m_v1.wB);
         break;
      case 2:
         pA.x = this.m_v1.a * this.m_v1.wA.x + this.m_v2.a * this.m_v2.wA.x;
         pA.y = this.m_v1.a * this.m_v1.wA.y + this.m_v2.a * this.m_v2.wA.y;
         pB.x = this.m_v1.a * this.m_v1.wB.x + this.m_v2.a * this.m_v2.wB.x;
         pB.y = this.m_v1.a * this.m_v1.wB.y + this.m_v2.a * this.m_v2.wB.y;
         break;
      case 3:
         pB.x = pA.x = this.m_v1.a * this.m_v1.wA.x + this.m_v2.a * this.m_v2.wA.x + this.m_v3.a * this.m_v3.wA.x;
         pB.y = pA.y = this.m_v1.a * this.m_v1.wA.y + this.m_v2.a * this.m_v2.wA.y + this.m_v3.a * this.m_v3.wA.y;
         break;
      default:
         b2Settings.b2Assert(false);
         break;
      }
   }
   b2Simplex.prototype.GetMetric = function () {
      switch (this.m_count) {
      case 0:
         b2Settings.b2Assert(false);
         return 0.0;
      case 1:
         return 0.0;
      case 2:
         return b2Math.SubtractVV(this.m_v1.w, this.m_v2.w).Length();
      case 3:
         return b2Math.CrossVV(b2Math.SubtractVV(this.m_v2.w, this.m_v1.w), b2Math.SubtractVV(this.m_v3.w, this.m_v1.w));
      default:
         b2Settings.b2Assert(false);
         return 0.0;
      }
   }
   b2Simplex.prototype.Solve2 = function () {
      var w1 = this.m_v1.w;
      var w2 = this.m_v2.w;
      var e12 = b2Math.SubtractVV(w2, w1);
      var d12_2 = (-(w1.x * e12.x + w1.y * e12.y));
      if (d12_2 <= 0.0) {
         this.m_v1.a = 1.0;
         this.m_count = 1;
         return;
      }
      var d12_1 = (w2.x * e12.x + w2.y * e12.y);
      if (d12_1 <= 0.0) {
         this.m_v2.a = 1.0;
         this.m_count = 1;
         this.m_v1.Set(this.m_v2);
         return;
      }
      var inv_d12 = 1.0 / (d12_1 + d12_2);
      this.m_v1.a = d12_1 * inv_d12;
      this.m_v2.a = d12_2 * inv_d12;
      this.m_count = 2;
   }
   b2Simplex.prototype.Solve3 = function () {
      var w1 = this.m_v1.w;
      var w2 = this.m_v2.w;
      var w3 = this.m_v3.w;
      var e12 = b2Math.SubtractVV(w2, w1);
      var w1e12 = b2Math.Dot(w1, e12);
      var w2e12 = b2Math.Dot(w2, e12);
      var d12_1 = w2e12;
      var d12_2 = (-w1e12);
      var e13 = b2Math.SubtractVV(w3, w1);
      var w1e13 = b2Math.Dot(w1, e13);
      var w3e13 = b2Math.Dot(w3, e13);
      var d13_1 = w3e13;
      var d13_2 = (-w1e13);
      var e23 = b2Math.SubtractVV(w3, w2);
      var w2e23 = b2Math.Dot(w2, e23);
      var w3e23 = b2Math.Dot(w3, e23);
      var d23_1 = w3e23;
      var d23_2 = (-w2e23);
      var n123 = b2Math.CrossVV(e12, e13);
      var d123_1 = n123 * b2Math.CrossVV(w2, w3);
      var d123_2 = n123 * b2Math.CrossVV(w3, w1);
      var d123_3 = n123 * b2Math.CrossVV(w1, w2);
      if (d12_2 <= 0.0 && d13_2 <= 0.0) {
         this.m_v1.a = 1.0;
         this.m_count = 1;
         return;
      }
      if (d12_1 > 0.0 && d12_2 > 0.0 && d123_3 <= 0.0) {
         var inv_d12 = 1.0 / (d12_1 + d12_2);
         this.m_v1.a = d12_1 * inv_d12;
         this.m_v2.a = d12_2 * inv_d12;
         this.m_count = 2;
         return;
      }
      if (d13_1 > 0.0 && d13_2 > 0.0 && d123_2 <= 0.0) {
         var inv_d13 = 1.0 / (d13_1 + d13_2);
         this.m_v1.a = d13_1 * inv_d13;
         this.m_v3.a = d13_2 * inv_d13;
         this.m_count = 2;
         this.m_v2.Set(this.m_v3);
         return;
      }
      if (d12_1 <= 0.0 && d23_2 <= 0.0) {
         this.m_v2.a = 1.0;
         this.m_count = 1;
         this.m_v1.Set(this.m_v2);
         return;
      }
      if (d13_1 <= 0.0 && d23_1 <= 0.0) {
         this.m_v3.a = 1.0;
         this.m_count = 1;
         this.m_v1.Set(this.m_v3);
         return;
      }
      if (d23_1 > 0.0 && d23_2 > 0.0 && d123_1 <= 0.0) {
         var inv_d23 = 1.0 / (d23_1 + d23_2);
         this.m_v2.a = d23_1 * inv_d23;
         this.m_v3.a = d23_2 * inv_d23;
         this.m_count = 2;
         this.m_v1.Set(this.m_v3);
         return;
      }
      var inv_d123 = 1.0 / (d123_1 + d123_2 + d123_3);
      this.m_v1.a = d123_1 * inv_d123;
      this.m_v2.a = d123_2 * inv_d123;
      this.m_v3.a = d123_3 * inv_d123;
      this.m_count = 3;
   }
   b2SimplexCache.b2SimplexCache = function () {
      this.indexA = new Vector_a2j_Number(3);
      this.indexB = new Vector_a2j_Number(3);
   };
   b2SimplexVertex.b2SimplexVertex = function () {};
   b2SimplexVertex.prototype.Set = function (other) {
      this.wA.SetV(other.wA);
      this.wB.SetV(other.wB);
      this.w.SetV(other.w);
      this.a = other.a;
      this.indexA = other.indexA;
      this.indexB = other.indexB;
   }
   b2TimeOfImpact.b2TimeOfImpact = function () {};
   b2TimeOfImpact.TimeOfImpact = function (input) {
      ++b2TimeOfImpact.b2_toiCalls;
      var proxyA = input.proxyA;
      var proxyB = input.proxyB;
      var sweepA = input.sweepA;
      var sweepB = input.sweepB;
      b2Settings.b2Assert(sweepA.t0 == sweepB.t0);
      b2Settings.b2Assert(1.0 - sweepA.t0 > Number.MIN_VALUE);
      var radius = proxyA.m_radius + proxyB.m_radius;
      var tolerance = input.tolerance;
      var alpha = 0.0;
      var k_maxIterations = 1000;
      var iter = 0;
      var target = 0.0;
      b2TimeOfImpact.s_cache.count = 0;
      b2TimeOfImpact.s_distanceInput.useRadii = false;
      for (;;) {
         sweepA.GetTransform(b2TimeOfImpact.s_xfA, alpha);
         sweepB.GetTransform(b2TimeOfImpact.s_xfB, alpha);
         b2TimeOfImpact.s_distanceInput.proxyA = proxyA;
         b2TimeOfImpact.s_distanceInput.proxyB = proxyB;
         b2TimeOfImpact.s_distanceInput.transformA = b2TimeOfImpact.s_xfA;
         b2TimeOfImpact.s_distanceInput.transformB = b2TimeOfImpact.s_xfB;
         b2Distance.Distance(b2TimeOfImpact.s_distanceOutput, b2TimeOfImpact.s_cache, b2TimeOfImpact.s_distanceInput);
         if (b2TimeOfImpact.s_distanceOutput.distance <= 0.0) {
            alpha = 1.0;
            break;
         }
         b2TimeOfImpact.s_fcn.Initialize(b2TimeOfImpact.s_cache, proxyA, b2TimeOfImpact.s_xfA, proxyB, b2TimeOfImpact.s_xfB);
         var separation = b2TimeOfImpact.s_fcn.Evaluate(b2TimeOfImpact.s_xfA, b2TimeOfImpact.s_xfB);
         if (separation <= 0.0) {
            alpha = 1.0;
            break;
         }
         if (iter == 0) {
            if (separation > radius) {
               target = b2Math.Max(radius - tolerance, 0.75 * radius);
            }
            else {
               target = b2Math.Max(separation - tolerance, 0.02 * radius);
            }
         }
         if (separation - target < 0.5 * tolerance) {
            if (iter == 0) {
               alpha = 1.0;
               break;
            }
            break;
         }
         var newAlpha = alpha; {
            var x1 = alpha;
            var x2 = 1.0;
            var f1 = separation;
            sweepA.GetTransform(b2TimeOfImpact.s_xfA, x2);
            sweepB.GetTransform(b2TimeOfImpact.s_xfB, x2);
            var f2 = b2TimeOfImpact.s_fcn.Evaluate(b2TimeOfImpact.s_xfA, b2TimeOfImpact.s_xfB);
            if (f2 >= target) {
               alpha = 1.0;
               break;
            }
            var rootIterCount = 0;
            for (;;) {
               var x = 0;
               if (rootIterCount & 1) {
                  x = x1 + (target - f1) * (x2 - x1) / (f2 - f1);
               }
               else {
                  x = 0.5 * (x1 + x2);
               }
               sweepA.GetTransform(b2TimeOfImpact.s_xfA, x);
               sweepB.GetTransform(b2TimeOfImpact.s_xfB, x);
               var f = b2TimeOfImpact.s_fcn.Evaluate(b2TimeOfImpact.s_xfA, b2TimeOfImpact.s_xfB);
               if (b2Math.Abs(f - target) < 0.025 * tolerance) {
                  newAlpha = x;
                  break;
               }
               if (f > target) {
                  x1 = x;
                  f1 = f;
               }
               else {
                  x2 = x;
                  f2 = f;
               }++rootIterCount;
               ++b2TimeOfImpact.b2_toiRootIters;
               if (rootIterCount == 50) {
                  break;
               }
            }
            b2TimeOfImpact.b2_toiMaxRootIters = b2Math.Max(b2TimeOfImpact.b2_toiMaxRootIters, rootIterCount);
         }
         if (newAlpha < (1.0 + 100.0 * Number.MIN_VALUE) * alpha) {
            break;
         }
         alpha = newAlpha;
         iter++;
         ++b2TimeOfImpact.b2_toiIters;
         if (iter == k_maxIterations) {
            break;
         }
      }
      b2TimeOfImpact.b2_toiMaxIters = b2Math.Max(b2TimeOfImpact.b2_toiMaxIters, iter);
      return alpha;
   }
   Box2D.postDefs.push(function () {
      Box2D.Collision.b2TimeOfImpact.b2_toiCalls = 0;
      Box2D.Collision.b2TimeOfImpact.b2_toiIters = 0;
      Box2D.Collision.b2TimeOfImpact.b2_toiMaxIters = 0;
      Box2D.Collision.b2TimeOfImpact.b2_toiRootIters = 0;
      Box2D.Collision.b2TimeOfImpact.b2_toiMaxRootIters = 0;
      Box2D.Collision.b2TimeOfImpact.s_cache = new b2SimplexCache();
      Box2D.Collision.b2TimeOfImpact.s_distanceInput = new b2DistanceInput();
      Box2D.Collision.b2TimeOfImpact.s_xfA = new b2Transform();
      Box2D.Collision.b2TimeOfImpact.s_xfB = new b2Transform();
      Box2D.Collision.b2TimeOfImpact.s_fcn = new b2SeparationFunction();
      Box2D.Collision.b2TimeOfImpact.s_distanceOutput = new b2DistanceOutput();
   });
   b2TOIInput.b2TOIInput = function () {
      this.proxyA = new b2DistanceProxy();
      this.proxyB = new b2DistanceProxy();
      this.sweepA = new b2Sweep();
      this.sweepB = new b2Sweep();
   };
   b2WorldManifold.b2WorldManifold = function () {
      this.m_normal = new b2Vec2();
   };
   b2WorldManifold.prototype.b2WorldManifold = function () {
      this.m_points = new Vector(b2Settings.b2_maxManifoldPoints);
      for (var i = 0; i < b2Settings.b2_maxManifoldPoints; i++) {
         this.m_points[i] = new b2Vec2();
      }
   }
   b2WorldManifold.prototype.Initialize = function (manifold, xfA, radiusA, xfB, radiusB) {
      if (radiusA === undefined) radiusA = 0;
      if (radiusB === undefined) radiusB = 0;
      if (manifold.m_pointCount == 0) {
         return;
      }
      var i = 0;
      var tVec;
      var tMat;
      var normalX = 0;
      var normalY = 0;
      var planePointX = 0;
      var planePointY = 0;
      var clipPointX = 0;
      var clipPointY = 0;
      switch (manifold.m_type) {
      case b2Manifold.e_circles:
         {
            tMat = xfA.R;
            tVec = manifold.m_localPoint;
            var pointAX = xfA.position.x + tMat.col1.x * tVec.x + tMat.col2.x * tVec.y;
            var pointAY = xfA.position.y + tMat.col1.y * tVec.x + tMat.col2.y * tVec.y;
            tMat = xfB.R;
            tVec = manifold.m_points[0].m_localPoint;
            var pointBX = xfB.position.x + tMat.col1.x * tVec.x + tMat.col2.x * tVec.y;
            var pointBY = xfB.position.y + tMat.col1.y * tVec.x + tMat.col2.y * tVec.y;
            var dX = pointBX - pointAX;
            var dY = pointBY - pointAY;
            var d2 = dX * dX + dY * dY;
            if (d2 > Number.MIN_VALUE * Number.MIN_VALUE) {
               var d = Math.sqrt(d2);
               this.m_normal.x = dX / d;
               this.m_normal.y = dY / d;
            }
            else {
               this.m_normal.x = 1;
               this.m_normal.y = 0;
            }
            var cAX = pointAX + radiusA * this.m_normal.x;
            var cAY = pointAY + radiusA * this.m_normal.y;
            var cBX = pointBX - radiusB * this.m_normal.x;
            var cBY = pointBY - radiusB * this.m_normal.y;
            this.m_points[0].x = 0.5 * (cAX + cBX);
            this.m_points[0].y = 0.5 * (cAY + cBY);
         }
         break;
      case b2Manifold.e_faceA:
         {
            tMat = xfA.R;
            tVec = manifold.m_localPlaneNormal;
            normalX = tMat.col1.x * tVec.x + tMat.col2.x * tVec.y;
            normalY = tMat.col1.y * tVec.x + tMat.col2.y * tVec.y;
            tMat = xfA.R;
            tVec = manifold.m_localPoint;
            planePointX = xfA.position.x + tMat.col1.x * tVec.x + tMat.col2.x * tVec.y;
            planePointY = xfA.position.y + tMat.col1.y * tVec.x + tMat.col2.y * tVec.y;
            this.m_normal.x = normalX;
            this.m_normal.y = normalY;
            for (i = 0;
            i < manifold.m_pointCount; i++) {
               tMat = xfB.R;
               tVec = manifold.m_points[i].m_localPoint;
               clipPointX = xfB.position.x + tMat.col1.x * tVec.x + tMat.col2.x * tVec.y;
               clipPointY = xfB.position.y + tMat.col1.y * tVec.x + tMat.col2.y * tVec.y;
               this.m_points[i].x = clipPointX + 0.5 * (radiusA - (clipPointX - planePointX) * normalX - (clipPointY - planePointY) * normalY - radiusB) * normalX;
               this.m_points[i].y = clipPointY + 0.5 * (radiusA - (clipPointX - planePointX) * normalX - (clipPointY - planePointY) * normalY - radiusB) * normalY;
            }
         }
         break;
      case b2Manifold.e_faceB:
         {
            tMat = xfB.R;
            tVec = manifold.m_localPlaneNormal;
            normalX = tMat.col1.x * tVec.x + tMat.col2.x * tVec.y;
            normalY = tMat.col1.y * tVec.x + tMat.col2.y * tVec.y;
            tMat = xfB.R;
            tVec = manifold.m_localPoint;
            planePointX = xfB.position.x + tMat.col1.x * tVec.x + tMat.col2.x * tVec.y;
            planePointY = xfB.position.y + tMat.col1.y * tVec.x + tMat.col2.y * tVec.y;
            this.m_normal.x = (-normalX);
            this.m_normal.y = (-normalY);
            for (i = 0;
            i < manifold.m_pointCount; i++) {
               tMat = xfA.R;
               tVec = manifold.m_points[i].m_localPoint;
               clipPointX = xfA.position.x + tMat.col1.x * tVec.x + tMat.col2.x * tVec.y;
               clipPointY = xfA.position.y + tMat.col1.y * tVec.x + tMat.col2.y * tVec.y;
               this.m_points[i].x = clipPointX + 0.5 * (radiusB - (clipPointX - planePointX) * normalX - (clipPointY - planePointY) * normalY - radiusA) * normalX;
               this.m_points[i].y = clipPointY + 0.5 * (radiusB - (clipPointX - planePointX) * normalX - (clipPointY - planePointY) * normalY - radiusA) * normalY;
            }
         }
         break;
      }
   }
   ClipVertex.ClipVertex = function () {
      this.v = new b2Vec2();
      this.id = new b2ContactID();
   };
   ClipVertex.prototype.Set = function (other) {
      this.v.SetV(other.v);
      this.id.Set(other.id);
   }
   Features.Features = function () {};
   Object.defineProperty(Features.prototype, 'referenceEdge', {
      enumerable: false,
      configurable: true,
      get: function () {
         return this._referenceEdge;
      }
   });
   Object.defineProperty(Features.prototype, 'referenceEdge', {
      enumerable: false,
      configurable: true,
      set: function (value) {
         if (value === undefined) value = 0;
         this._referenceEdge = value;
         this._m_id._key = (this._m_id._key & 0xffffff00) | (this._referenceEdge & 0x000000ff);
      }
   });
   Object.defineProperty(Features.prototype, 'incidentEdge', {
      enumerable: false,
      configurable: true,
      get: function () {
         return this._incidentEdge;
      }
   });
   Object.defineProperty(Features.prototype, 'incidentEdge', {
      enumerable: false,
      configurable: true,
      set: function (value) {
         if (value === undefined) value = 0;
         this._incidentEdge = value;
         this._m_id._key = (this._m_id._key & 0xffff00ff) | ((this._incidentEdge << 8) & 0x0000ff00);
      }
   });
   Object.defineProperty(Features.prototype, 'incidentVertex', {
      enumerable: false,
      configurable: true,
      get: function () {
         return this._incidentVertex;
      }
   });
   Object.defineProperty(Features.prototype, 'incidentVertex', {
      enumerable: false,
      configurable: true,
      set: function (value) {
         if (value === undefined) value = 0;
         this._incidentVertex = value;
         this._m_id._key = (this._m_id._key & 0xff00ffff) | ((this._incidentVertex << 16) & 0x00ff0000);
      }
   });
   Object.defineProperty(Features.prototype, 'flip', {
      enumerable: false,
      configurable: true,
      get: function () {
         return this._flip;
      }
   });
   Object.defineProperty(Features.prototype, 'flip', {
      enumerable: false,
      configurable: true,
      set: function (value) {
         if (value === undefined) value = 0;
         this._flip = value;
         this._m_id._key = (this._m_id._key & 0x00ffffff) | ((this._flip << 24) & 0xff000000);
      }
   });
})();
(function () {
   var b2Color = Box2D.Common.b2Color,
      b2internal = Box2D.Common.b2internal,
      b2Settings = Box2D.Common.b2Settings,
      b2CircleShape = Box2D.Collision.Shapes.b2CircleShape,
      b2EdgeChainDef = Box2D.Collision.Shapes.b2EdgeChainDef,
      b2EdgeShape = Box2D.Collision.Shapes.b2EdgeShape,
      b2MassData = Box2D.Collision.Shapes.b2MassData,
      b2PolygonShape = Box2D.Collision.Shapes.b2PolygonShape,
      b2Shape = Box2D.Collision.Shapes.b2Shape,
      b2Mat22 = Box2D.Common.Math.b2Mat22,
      b2Mat33 = Box2D.Common.Math.b2Mat33,
      b2Math = Box2D.Common.Math.b2Math,
      b2Sweep = Box2D.Common.Math.b2Sweep,
      b2Transform = Box2D.Common.Math.b2Transform,
      b2Vec2 = Box2D.Common.Math.b2Vec2,
      b2Vec3 = Box2D.Common.Math.b2Vec3,
      b2Body = Box2D.Dynamics.b2Body,
      b2BodyDef = Box2D.Dynamics.b2BodyDef,
      b2ContactFilter = Box2D.Dynamics.b2ContactFilter,
      b2ContactImpulse = Box2D.Dynamics.b2ContactImpulse,
      b2ContactListener = Box2D.Dynamics.b2ContactListener,
      b2ContactManager = Box2D.Dynamics.b2ContactManager,
      b2DebugDraw = Box2D.Dynamics.b2DebugDraw,
      b2DestructionListener = Box2D.Dynamics.b2DestructionListener,
      b2FilterData = Box2D.Dynamics.b2FilterData,
      b2Fixture = Box2D.Dynamics.b2Fixture,
      b2FixtureDef = Box2D.Dynamics.b2FixtureDef,
      b2Island = Box2D.Dynamics.b2Island,
      b2TimeStep = Box2D.Dynamics.b2TimeStep,
      b2World = Box2D.Dynamics.b2World,
      b2AABB = Box2D.Collision.b2AABB,
      b2Bound = Box2D.Collision.b2Bound,
      b2BoundValues = Box2D.Collision.b2BoundValues,
      b2Collision = Box2D.Collision.b2Collision,
      b2ContactID = Box2D.Collision.b2ContactID,
      b2ContactPoint = Box2D.Collision.b2ContactPoint,
      b2Distance = Box2D.Collision.b2Distance,
      b2DistanceInput = Box2D.Collision.b2DistanceInput,
      b2DistanceOutput = Box2D.Collision.b2DistanceOutput,
      b2DistanceProxy = Box2D.Collision.b2DistanceProxy,
      b2DynamicTree = Box2D.Collision.b2DynamicTree,
      b2DynamicTreeBroadPhase = Box2D.Collision.b2DynamicTreeBroadPhase,
      b2DynamicTreeNode = Box2D.Collision.b2DynamicTreeNode,
      b2DynamicTreePair = Box2D.Collision.b2DynamicTreePair,
      b2Manifold = Box2D.Collision.b2Manifold,
      b2ManifoldPoint = Box2D.Collision.b2ManifoldPoint,
      b2Point = Box2D.Collision.b2Point,
      b2RayCastInput = Box2D.Collision.b2RayCastInput,
      b2RayCastOutput = Box2D.Collision.b2RayCastOutput,
      b2Segment = Box2D.Collision.b2Segment,
      b2SeparationFunction = Box2D.Collision.b2SeparationFunction,
      b2Simplex = Box2D.Collision.b2Simplex,
      b2SimplexCache = Box2D.Collision.b2SimplexCache,
      b2SimplexVertex = Box2D.Collision.b2SimplexVertex,
      b2TimeOfImpact = Box2D.Collision.b2TimeOfImpact,
      b2TOIInput = Box2D.Collision.b2TOIInput,
      b2WorldManifold = Box2D.Collision.b2WorldManifold,
      ClipVertex = Box2D.Collision.ClipVertex,
      Features = Box2D.Collision.Features,
      IBroadPhase = Box2D.Collision.IBroadPhase;

   Box2D.inherit(b2CircleShape, Box2D.Collision.Shapes.b2Shape);
   b2CircleShape.prototype.__super = Box2D.Collision.Shapes.b2Shape.prototype;
   b2CircleShape.b2CircleShape = function () {
      Box2D.Collision.Shapes.b2Shape.b2Shape.apply(this, arguments);
      this.m_p = new b2Vec2();
   };
   b2CircleShape.prototype.Copy = function () {
      var s = new b2CircleShape();
      s.Set(this);
      return s;
   }
   b2CircleShape.prototype.Set = function (other) {
      this.__super.Set.call(this, other);
      if (Box2D.is(other, b2CircleShape)) {
         var other2 = (other instanceof b2CircleShape ? other : null);
         this.m_p.SetV(other2.m_p);
      }
   }
   b2CircleShape.prototype.TestPoint = function (transform, p) {
      var tMat = transform.R;
      var dX = transform.position.x + (tMat.col1.x * this.m_p.x + tMat.col2.x * this.m_p.y);
      var dY = transform.position.y + (tMat.col1.y * this.m_p.x + tMat.col2.y * this.m_p.y);
      dX = p.x - dX;
      dY = p.y - dY;
      return (dX * dX + dY * dY) <= this.m_radius * this.m_radius;
   }
   b2CircleShape.prototype.RayCast = function (output, input, transform) {
      var tMat = transform.R;
      var positionX = transform.position.x + (tMat.col1.x * this.m_p.x + tMat.col2.x * this.m_p.y);
      var positionY = transform.position.y + (tMat.col1.y * this.m_p.x + tMat.col2.y * this.m_p.y);
      var sX = input.p1.x - positionX;
      var sY = input.p1.y - positionY;
      var b = (sX * sX + sY * sY) - this.m_radius * this.m_radius;
      var rX = input.p2.x - input.p1.x;
      var rY = input.p2.y - input.p1.y;
      var c = (sX * rX + sY * rY);
      var rr = (rX * rX + rY * rY);
      var sigma = c * c - rr * b;
      if (sigma < 0.0 || rr < Number.MIN_VALUE) {
         return false;
      }
      var a = (-(c + Math.sqrt(sigma)));
      if (0.0 <= a && a <= input.maxFraction * rr) {
         a /= rr;
         output.fraction = a;
         output.normal.x = sX + a * rX;
         output.normal.y = sY + a * rY;
         output.normal.Normalize();
         return true;
      }
      return false;
   }
   b2CircleShape.prototype.ComputeAABB = function (aabb, transform) {
      var tMat = transform.R;
      var pX = transform.position.x + (tMat.col1.x * this.m_p.x + tMat.col2.x * this.m_p.y);
      var pY = transform.position.y + (tMat.col1.y * this.m_p.x + tMat.col2.y * this.m_p.y);
      aabb.lowerBound.Set(pX - this.m_radius, pY - this.m_radius);
      aabb.upperBound.Set(pX + this.m_radius, pY + this.m_radius);
   }
   b2CircleShape.prototype.ComputeMass = function (massData, density) {
      if (density === undefined) density = 0;
      massData.mass = density * b2Settings.b2_pi * this.m_radius * this.m_radius;
      massData.center.SetV(this.m_p);
      massData.I = massData.mass * (0.5 * this.m_radius * this.m_radius + (this.m_p.x * this.m_p.x + this.m_p.y * this.m_p.y));
   }
   b2CircleShape.prototype.ComputeSubmergedArea = function (normal, offset, xf, c) {
      if (offset === undefined) offset = 0;
      var p = b2Math.MulX(xf, this.m_p);
      var l = (-(b2Math.Dot(normal, p) - offset));
      if (l < (-this.m_radius) + Number.MIN_VALUE) {
         return 0;
      }
      if (l > this.m_radius) {
         c.SetV(p);
         return Math.PI * this.m_radius * this.m_radius;
      }
      var r2 = this.m_radius * this.m_radius;
      var l2 = l * l;
      var area = r2 * (Math.asin(l / this.m_radius) + Math.PI / 2) + l * Math.sqrt(r2 - l2);
      var com = (-2 / 3 * Math.pow(r2 - l2, 1.5) / area);
      c.x = p.x + normal.x * com;
      c.y = p.y + normal.y * com;
      return area;
   }
   b2CircleShape.prototype.GetLocalPosition = function () {
      return this.m_p;
   }
   b2CircleShape.prototype.SetLocalPosition = function (position) {
      this.m_p.SetV(position);
   }
   b2CircleShape.prototype.GetRadius = function () {
      return this.m_radius;
   }
   b2CircleShape.prototype.SetRadius = function (radius) {
      if (radius === undefined) radius = 0;
      this.m_radius = radius;
   }
   b2CircleShape.prototype.b2CircleShape = function (radius) {
      if (radius === undefined) radius = 0;
      this.__super.b2Shape.call(this);
      this.m_type = b2Shape.e_circleShape;
      this.m_radius = radius;
   }
   b2EdgeChainDef.b2EdgeChainDef = function () {};
   b2EdgeChainDef.prototype.b2EdgeChainDef = function () {
      this.vertexCount = 0;
      this.isALoop = true;
      this.vertices = [];
   }
   Box2D.inherit(b2EdgeShape, Box2D.Collision.Shapes.b2Shape);
   b2EdgeShape.prototype.__super = Box2D.Collision.Shapes.b2Shape.prototype;
   b2EdgeShape.b2EdgeShape = function () {
      Box2D.Collision.Shapes.b2Shape.b2Shape.apply(this, arguments);
      this.s_supportVec = new b2Vec2();
      this.m_v1 = new b2Vec2();
      this.m_v2 = new b2Vec2();
      this.m_coreV1 = new b2Vec2();
      this.m_coreV2 = new b2Vec2();
      this.m_normal = new b2Vec2();
      this.m_direction = new b2Vec2();
      this.m_cornerDir1 = new b2Vec2();
      this.m_cornerDir2 = new b2Vec2();
   };
   b2EdgeShape.prototype.TestPoint = function (transform, p) {
      return false;
   }
   b2EdgeShape.prototype.RayCast = function (output, input, transform) {
      var tMat;
      var rX = input.p2.x - input.p1.x;
      var rY = input.p2.y - input.p1.y;
      tMat = transform.R;
      var v1X = transform.position.x + (tMat.col1.x * this.m_v1.x + tMat.col2.x * this.m_v1.y);
      var v1Y = transform.position.y + (tMat.col1.y * this.m_v1.x + tMat.col2.y * this.m_v1.y);
      var nX = transform.position.y + (tMat.col1.y * this.m_v2.x + tMat.col2.y * this.m_v2.y) - v1Y;
      var nY = (-(transform.position.x + (tMat.col1.x * this.m_v2.x + tMat.col2.x * this.m_v2.y) - v1X));
      var k_slop = 100.0 * Number.MIN_VALUE;
      var denom = (-(rX * nX + rY * nY));
      if (denom > k_slop) {
         var bX = input.p1.x - v1X;
         var bY = input.p1.y - v1Y;
         var a = (bX * nX + bY * nY);
         if (0.0 <= a && a <= input.maxFraction * denom) {
            var mu2 = (-rX * bY) + rY * bX;
            if ((-k_slop * denom) <= mu2 && mu2 <= denom * (1.0 + k_slop)) {
               a /= denom;
               output.fraction = a;
               var nLen = Math.sqrt(nX * nX + nY * nY);
               output.normal.x = nX / nLen;
               output.normal.y = nY / nLen;
               return true;
            }
         }
      }
      return false;
   }
   b2EdgeShape.prototype.ComputeAABB = function (aabb, transform) {
      var tMat = transform.R;
      var v1X = transform.position.x + (tMat.col1.x * this.m_v1.x + tMat.col2.x * this.m_v1.y);
      var v1Y = transform.position.y + (tMat.col1.y * this.m_v1.x + tMat.col2.y * this.m_v1.y);
      var v2X = transform.position.x + (tMat.col1.x * this.m_v2.x + tMat.col2.x * this.m_v2.y);
      var v2Y = transform.position.y + (tMat.col1.y * this.m_v2.x + tMat.col2.y * this.m_v2.y);
      if (v1X < v2X) {
         aabb.lowerBound.x = v1X;
         aabb.upperBound.x = v2X;
      }
      else {
         aabb.lowerBound.x = v2X;
         aabb.upperBound.x = v1X;
      }
      if (v1Y < v2Y) {
         aabb.lowerBound.y = v1Y;
         aabb.upperBound.y = v2Y;
      }
      else {
         aabb.lowerBound.y = v2Y;
         aabb.upperBound.y = v1Y;
      }
   }
   b2EdgeShape.prototype.ComputeMass = function (massData, density) {
      if (density === undefined) density = 0;
      massData.mass = 0;
      massData.center.SetV(this.m_v1);
      massData.I = 0;
   }
   b2EdgeShape.prototype.ComputeSubmergedArea = function (normal, offset, xf, c) {
      if (offset === undefined) offset = 0;
      var v0 = new b2Vec2(normal.x * offset, normal.y * offset);
      var v1 = b2Math.MulX(xf, this.m_v1);
      var v2 = b2Math.MulX(xf, this.m_v2);
      var d1 = b2Math.Dot(normal, v1) - offset;
      var d2 = b2Math.Dot(normal, v2) - offset;
      if (d1 > 0) {
         if (d2 > 0) {
            return 0;
         }
         else {
            v1.x = (-d2 / (d1 - d2) * v1.x) + d1 / (d1 - d2) * v2.x;
            v1.y = (-d2 / (d1 - d2) * v1.y) + d1 / (d1 - d2) * v2.y;
         }
      }
      else {
         if (d2 > 0) {
            v2.x = (-d2 / (d1 - d2) * v1.x) + d1 / (d1 - d2) * v2.x;
            v2.y = (-d2 / (d1 - d2) * v1.y) + d1 / (d1 - d2) * v2.y;
         }
         else {}
      }
      c.x = (v0.x + v1.x + v2.x) / 3;
      c.y = (v0.y + v1.y + v2.y) / 3;
      return 0.5 * ((v1.x - v0.x) * (v2.y - v0.y) - (v1.y - v0.y) * (v2.x - v0.x));
   }
   b2EdgeShape.prototype.GetLength = function () {
      return this.m_length;
   }
   b2EdgeShape.prototype.GetVertex1 = function () {
      return this.m_v1;
   }
   b2EdgeShape.prototype.GetVertex2 = function () {
      return this.m_v2;
   }
   b2EdgeShape.prototype.GetCoreVertex1 = function () {
      return this.m_coreV1;
   }
   b2EdgeShape.prototype.GetCoreVertex2 = function () {
      return this.m_coreV2;
   }
   b2EdgeShape.prototype.GetNormalVector = function () {
      return this.m_normal;
   }
   b2EdgeShape.prototype.GetDirectionVector = function () {
      return this.m_direction;
   }
   b2EdgeShape.prototype.GetCorner1Vector = function () {
      return this.m_cornerDir1;
   }
   b2EdgeShape.prototype.GetCorner2Vector = function () {
      return this.m_cornerDir2;
   }
   b2EdgeShape.prototype.Corner1IsConvex = function () {
      return this.m_cornerConvex1;
   }
   b2EdgeShape.prototype.Corner2IsConvex = function () {
      return this.m_cornerConvex2;
   }
   b2EdgeShape.prototype.GetFirstVertex = function (xf) {
      var tMat = xf.R;
      return new b2Vec2(xf.position.x + (tMat.col1.x * this.m_coreV1.x + tMat.col2.x * this.m_coreV1.y), xf.position.y + (tMat.col1.y * this.m_coreV1.x + tMat.col2.y * this.m_coreV1.y));
   }
   b2EdgeShape.prototype.GetNextEdge = function () {
      return this.m_nextEdge;
   }
   b2EdgeShape.prototype.GetPrevEdge = function () {
      return this.m_prevEdge;
   }
   b2EdgeShape.prototype.Support = function (xf, dX, dY) {
      if (dX === undefined) dX = 0;
      if (dY === undefined) dY = 0;
      var tMat = xf.R;
      var v1X = xf.position.x + (tMat.col1.x * this.m_coreV1.x + tMat.col2.x * this.m_coreV1.y);
      var v1Y = xf.position.y + (tMat.col1.y * this.m_coreV1.x + tMat.col2.y * this.m_coreV1.y);
      var v2X = xf.position.x + (tMat.col1.x * this.m_coreV2.x + tMat.col2.x * this.m_coreV2.y);
      var v2Y = xf.position.y + (tMat.col1.y * this.m_coreV2.x + tMat.col2.y * this.m_coreV2.y);
      if ((v1X * dX + v1Y * dY) > (v2X * dX + v2Y * dY)) {
         this.s_supportVec.x = v1X;
         this.s_supportVec.y = v1Y;
      }
      else {
         this.s_supportVec.x = v2X;
         this.s_supportVec.y = v2Y;
      }
      return this.s_supportVec;
   }
   b2EdgeShape.prototype.b2EdgeShape = function (v1, v2) {
      this.__super.b2Shape.call(this);
      this.m_type = b2Shape.e_edgeShape;
      this.m_prevEdge = null;
      this.m_nextEdge = null;
      this.m_v1 = v1;
      this.m_v2 = v2;
      this.m_direction.Set(this.m_v2.x - this.m_v1.x, this.m_v2.y - this.m_v1.y);
      this.m_length = this.m_direction.Normalize();
      this.m_normal.Set(this.m_direction.y, (-this.m_direction.x));
      this.m_coreV1.Set((-b2Settings.b2_toiSlop * (this.m_normal.x - this.m_direction.x)) + this.m_v1.x, (-b2Settings.b2_toiSlop * (this.m_normal.y - this.m_direction.y)) + this.m_v1.y);
      this.m_coreV2.Set((-b2Settings.b2_toiSlop * (this.m_normal.x + this.m_direction.x)) + this.m_v2.x, (-b2Settings.b2_toiSlop * (this.m_normal.y + this.m_direction.y)) + this.m_v2.y);
      this.m_cornerDir1 = this.m_normal;
      this.m_cornerDir2.Set((-this.m_normal.x), (-this.m_normal.y));
   }
   b2EdgeShape.prototype.SetPrevEdge = function (edge, core, cornerDir, convex) {
      this.m_prevEdge = edge;
      this.m_coreV1 = core;
      this.m_cornerDir1 = cornerDir;
      this.m_cornerConvex1 = convex;
   }
   b2EdgeShape.prototype.SetNextEdge = function (edge, core, cornerDir, convex) {
      this.m_nextEdge = edge;
      this.m_coreV2 = core;
      this.m_cornerDir2 = cornerDir;
      this.m_cornerConvex2 = convex;
   }
   b2MassData.b2MassData = function () {
      this.mass = 0.0;
      this.center = new b2Vec2(0, 0);
      this.I = 0.0;
   };
   Box2D.inherit(b2PolygonShape, Box2D.Collision.Shapes.b2Shape);
   b2PolygonShape.prototype.__super = Box2D.Collision.Shapes.b2Shape.prototype;
   b2PolygonShape.b2PolygonShape = function () {
      Box2D.Collision.Shapes.b2Shape.b2Shape.apply(this, arguments);
   };
   b2PolygonShape.prototype.Copy = function () {
      var s = new b2PolygonShape();
      s.Set(this);
      return s;
   }
   b2PolygonShape.prototype.Set = function (other) {
      this.__super.Set.call(this, other);
      if (Box2D.is(other, b2PolygonShape)) {
         var other2 = (other instanceof b2PolygonShape ? other : null);
         this.m_centroid.SetV(other2.m_centroid);
         this.m_vertexCount = other2.m_vertexCount;
         this.Reserve(this.m_vertexCount);
         for (var i = 0; i < this.m_vertexCount; i++) {
            this.m_vertices[i].SetV(other2.m_vertices[i]);
            this.m_normals[i].SetV(other2.m_normals[i]);
         }
      }
   }
   b2PolygonShape.prototype.SetAsArray = function (vertices, vertexCount) {
      if (vertexCount === undefined) vertexCount = 0;
      var v = new Vector();
      var i = 0,
         tVec;
      for (i = 0;
      i < vertices.length; ++i) {
         tVec = vertices[i];
         v.push(tVec);
      }
      this.SetAsVector(v, vertexCount);
   }
   b2PolygonShape.AsArray = function (vertices, vertexCount) {
      if (vertexCount === undefined) vertexCount = 0;
      var polygonShape = new b2PolygonShape();
      polygonShape.SetAsArray(vertices, vertexCount);
      return polygonShape;
   }
   b2PolygonShape.prototype.SetAsVector = function (vertices, vertexCount) {
      if (vertexCount === undefined) vertexCount = 0;
      if (vertexCount == 0) vertexCount = vertices.length;
      b2Settings.b2Assert(2 <= vertexCount);
      this.m_vertexCount = vertexCount;
      this.Reserve(vertexCount);
      var i = 0;
      for (i = 0;
      i < this.m_vertexCount; i++) {
         this.m_vertices[i].SetV(vertices[i]);
      }
      for (i = 0;
      i < this.m_vertexCount; ++i) {
         var i1 = parseInt(i);
         var i2 = parseInt(i + 1 < this.m_vertexCount ? i + 1 : 0);
         var edge = b2Math.SubtractVV(this.m_vertices[i2], this.m_vertices[i1]);
         b2Settings.b2Assert(edge.LengthSquared() > Number.MIN_VALUE);
         this.m_normals[i].SetV(b2Math.CrossVF(edge, 1.0));
         this.m_normals[i].Normalize();
      }
      this.m_centroid = b2PolygonShape.ComputeCentroid(this.m_vertices, this.m_vertexCount);
   }
   b2PolygonShape.AsVector = function (vertices, vertexCount) {
      if (vertexCount === undefined) vertexCount = 0;
      var polygonShape = new b2PolygonShape();
      polygonShape.SetAsVector(vertices, vertexCount);
      return polygonShape;
   }
   b2PolygonShape.prototype.SetAsBox = function (hx, hy) {
      if (hx === undefined) hx = 0;
      if (hy === undefined) hy = 0;
      this.m_vertexCount = 4;
      this.Reserve(4);
      this.m_vertices[0].Set((-hx), (-hy));
      this.m_vertices[1].Set(hx, (-hy));
      this.m_vertices[2].Set(hx, hy);
      this.m_vertices[3].Set((-hx), hy);
      this.m_normals[0].Set(0.0, (-1.0));
      this.m_normals[1].Set(1.0, 0.0);
      this.m_normals[2].Set(0.0, 1.0);
      this.m_normals[3].Set((-1.0), 0.0);
      this.m_centroid.SetZero();
   }
   b2PolygonShape.AsBox = function (hx, hy) {
      if (hx === undefined) hx = 0;
      if (hy === undefined) hy = 0;
      var polygonShape = new b2PolygonShape();
      polygonShape.SetAsBox(hx, hy);
      return polygonShape;
   }
   b2PolygonShape.prototype.SetAsOrientedBox = function (hx, hy, center, angle) {
      if (hx === undefined) hx = 0;
      if (hy === undefined) hy = 0;
      if (center === undefined) center = null;
      if (angle === undefined) angle = 0.0;
      this.m_vertexCount = 4;
      this.Reserve(4);
      this.m_vertices[0].Set((-hx), (-hy));
      this.m_vertices[1].Set(hx, (-hy));
      this.m_vertices[2].Set(hx, hy);
      this.m_vertices[3].Set((-hx), hy);
      this.m_normals[0].Set(0.0, (-1.0));
      this.m_normals[1].Set(1.0, 0.0);
      this.m_normals[2].Set(0.0, 1.0);
      this.m_normals[3].Set((-1.0), 0.0);
      this.m_centroid = center;
      var xf = new b2Transform();
      xf.position = center;
      xf.R.Set(angle);
      for (var i = 0; i < this.m_vertexCount; ++i) {
         this.m_vertices[i] = b2Math.MulX(xf, this.m_vertices[i]);
         this.m_normals[i] = b2Math.MulMV(xf.R, this.m_normals[i]);
      }
   }
   b2PolygonShape.AsOrientedBox = function (hx, hy, center, angle) {
      if (hx === undefined) hx = 0;
      if (hy === undefined) hy = 0;
      if (center === undefined) center = null;
      if (angle === undefined) angle = 0.0;
      var polygonShape = new b2PolygonShape();
      polygonShape.SetAsOrientedBox(hx, hy, center, angle);
      return polygonShape;
   }
   b2PolygonShape.prototype.SetAsEdge = function (v1, v2) {
      this.m_vertexCount = 2;
      this.Reserve(2);
      this.m_vertices[0].SetV(v1);
      this.m_vertices[1].SetV(v2);
      this.m_centroid.x = 0.5 * (v1.x + v2.x);
      this.m_centroid.y = 0.5 * (v1.y + v2.y);
      this.m_normals[0] = b2Math.CrossVF(b2Math.SubtractVV(v2, v1), 1.0);
      this.m_normals[0].Normalize();
      this.m_normals[1].x = (-this.m_normals[0].x);
      this.m_normals[1].y = (-this.m_normals[0].y);
   }
   b2PolygonShape.AsEdge = function (v1, v2) {
      var polygonShape = new b2PolygonShape();
      polygonShape.SetAsEdge(v1, v2);
      return polygonShape;
   }
   b2PolygonShape.prototype.TestPoint = function (xf, p) {
      var tVec;
      var tMat = xf.R;
      var tX = p.x - xf.position.x;
      var tY = p.y - xf.position.y;
      var pLocalX = (tX * tMat.col1.x + tY * tMat.col1.y);
      var pLocalY = (tX * tMat.col2.x + tY * tMat.col2.y);
      for (var i = 0; i < this.m_vertexCount; ++i) {
         tVec = this.m_vertices[i];
         tX = pLocalX - tVec.x;
         tY = pLocalY - tVec.y;
         tVec = this.m_normals[i];
         var dot = (tVec.x * tX + tVec.y * tY);
         if (dot > 0.0) {
            return false;
         }
      }
      return true;
   }
   b2PolygonShape.prototype.RayCast = function (output, input, transform) {
      var lower = 0.0;
      var upper = input.maxFraction;
      var tX = 0;
      var tY = 0;
      var tMat;
      var tVec;
      tX = input.p1.x - transform.position.x;
      tY = input.p1.y - transform.position.y;
      tMat = transform.R;
      var p1X = (tX * tMat.col1.x + tY * tMat.col1.y);
      var p1Y = (tX * tMat.col2.x + tY * tMat.col2.y);
      tX = input.p2.x - transform.position.x;
      tY = input.p2.y - transform.position.y;
      tMat = transform.R;
      var p2X = (tX * tMat.col1.x + tY * tMat.col1.y);
      var p2Y = (tX * tMat.col2.x + tY * tMat.col2.y);
      var dX = p2X - p1X;
      var dY = p2Y - p1Y;
      var index = parseInt((-1));
      for (var i = 0; i < this.m_vertexCount; ++i) {
         tVec = this.m_vertices[i];
         tX = tVec.x - p1X;
         tY = tVec.y - p1Y;
         tVec = this.m_normals[i];
         var numerator = (tVec.x * tX + tVec.y * tY);
         var denominator = (tVec.x * dX + tVec.y * dY);
         if (denominator == 0.0) {
            if (numerator < 0.0) {
               return false;
            }
         }
         else {
            if (denominator < 0.0 && numerator < lower * denominator) {
               lower = numerator / denominator;
               index = i;
            }
            else if (denominator > 0.0 && numerator < upper * denominator) {
               upper = numerator / denominator;
            }
         }
         if (upper < lower - Number.MIN_VALUE) {
            return false;
         }
      }
      if (index >= 0) {
         output.fraction = lower;
         tMat = transform.R;
         tVec = this.m_normals[index];
         output.normal.x = (tMat.col1.x * tVec.x + tMat.col2.x * tVec.y);
         output.normal.y = (tMat.col1.y * tVec.x + tMat.col2.y * tVec.y);
         return true;
      }
      return false;
   }
   b2PolygonShape.prototype.ComputeAABB = function (aabb, xf) {
      var tMat = xf.R;
      var tVec = this.m_vertices[0];
      var lowerX = xf.position.x + (tMat.col1.x * tVec.x + tMat.col2.x * tVec.y);
      var lowerY = xf.position.y + (tMat.col1.y * tVec.x + tMat.col2.y * tVec.y);
      var upperX = lowerX;
      var upperY = lowerY;
      for (var i = 1; i < this.m_vertexCount; ++i) {
         tVec = this.m_vertices[i];
         var vX = xf.position.x + (tMat.col1.x * tVec.x + tMat.col2.x * tVec.y);
         var vY = xf.position.y + (tMat.col1.y * tVec.x + tMat.col2.y * tVec.y);
         lowerX = lowerX < vX ? lowerX : vX;
         lowerY = lowerY < vY ? lowerY : vY;
         upperX = upperX > vX ? upperX : vX;
         upperY = upperY > vY ? upperY : vY;
      }
      aabb.lowerBound.x = lowerX - this.m_radius;
      aabb.lowerBound.y = lowerY - this.m_radius;
      aabb.upperBound.x = upperX + this.m_radius;
      aabb.upperBound.y = upperY + this.m_radius;
   }
   b2PolygonShape.prototype.ComputeMass = function (massData, density) {
      if (density === undefined) density = 0;
      if (this.m_vertexCount == 2) {
         massData.center.x = 0.5 * (this.m_vertices[0].x + this.m_vertices[1].x);
         massData.center.y = 0.5 * (this.m_vertices[0].y + this.m_vertices[1].y);
         massData.mass = 0.0;
         massData.I = 0.0;
         return;
      }
      var centerX = 0.0;
      var centerY = 0.0;
      var area = 0.0;
      var I = 0.0;
      var p1X = 0.0;
      var p1Y = 0.0;
      var k_inv3 = 1.0 / 3.0;
      for (var i = 0; i < this.m_vertexCount; ++i) {
         var p2 = this.m_vertices[i];
         var p3 = i + 1 < this.m_vertexCount ? this.m_vertices[parseInt(i + 1)] : this.m_vertices[0];
         var e1X = p2.x - p1X;
         var e1Y = p2.y - p1Y;
         var e2X = p3.x - p1X;
         var e2Y = p3.y - p1Y;
         var D = e1X * e2Y - e1Y * e2X;
         var triangleArea = 0.5 * D;area += triangleArea;
         centerX += triangleArea * k_inv3 * (p1X + p2.x + p3.x);
         centerY += triangleArea * k_inv3 * (p1Y + p2.y + p3.y);
         var px = p1X;
         var py = p1Y;
         var ex1 = e1X;
         var ey1 = e1Y;
         var ex2 = e2X;
         var ey2 = e2Y;
         var intx2 = k_inv3 * (0.25 * (ex1 * ex1 + ex2 * ex1 + ex2 * ex2) + (px * ex1 + px * ex2)) + 0.5 * px * px;
         var inty2 = k_inv3 * (0.25 * (ey1 * ey1 + ey2 * ey1 + ey2 * ey2) + (py * ey1 + py * ey2)) + 0.5 * py * py;I += D * (intx2 + inty2);
      }
      massData.mass = density * area;
      centerX *= 1.0 / area;
      centerY *= 1.0 / area;
      massData.center.Set(centerX, centerY);
      massData.I = density * I;
   }
   b2PolygonShape.prototype.ComputeSubmergedArea = function (normal, offset, xf, c) {
      if (offset === undefined) offset = 0;
      var normalL = b2Math.MulTMV(xf.R, normal);
      var offsetL = offset - b2Math.Dot(normal, xf.position);
      var depths = new Vector_a2j_Number();
      var diveCount = 0;
      var intoIndex = parseInt((-1));
      var outoIndex = parseInt((-1));
      var lastSubmerged = false;
      var i = 0;
      for (i = 0;
      i < this.m_vertexCount; ++i) {
         depths[i] = b2Math.Dot(normalL, this.m_vertices[i]) - offsetL;
         var isSubmerged = depths[i] < (-Number.MIN_VALUE);
         if (i > 0) {
            if (isSubmerged) {
               if (!lastSubmerged) {
                  intoIndex = i - 1;
                  diveCount++;
               }
            }
            else {
               if (lastSubmerged) {
                  outoIndex = i - 1;
                  diveCount++;
               }
            }
         }
         lastSubmerged = isSubmerged;
      }
      switch (diveCount) {
      case 0:
         if (lastSubmerged) {
            var md = new b2MassData();
            this.ComputeMass(md, 1);
            c.SetV(b2Math.MulX(xf, md.center));
            return md.mass;
         }
         else {
            return 0;
         }
         break;
      case 1:
         if (intoIndex == (-1)) {
            intoIndex = this.m_vertexCount - 1;
         }
         else {
            outoIndex = this.m_vertexCount - 1;
         }
         break;
      }
      var intoIndex2 = parseInt((intoIndex + 1) % this.m_vertexCount);
      var outoIndex2 = parseInt((outoIndex + 1) % this.m_vertexCount);
      var intoLamdda = (0 - depths[intoIndex]) / (depths[intoIndex2] - depths[intoIndex]);
      var outoLamdda = (0 - depths[outoIndex]) / (depths[outoIndex2] - depths[outoIndex]);
      var intoVec = new b2Vec2(this.m_vertices[intoIndex].x * (1 - intoLamdda) + this.m_vertices[intoIndex2].x * intoLamdda, this.m_vertices[intoIndex].y * (1 - intoLamdda) + this.m_vertices[intoIndex2].y * intoLamdda);
      var outoVec = new b2Vec2(this.m_vertices[outoIndex].x * (1 - outoLamdda) + this.m_vertices[outoIndex2].x * outoLamdda, this.m_vertices[outoIndex].y * (1 - outoLamdda) + this.m_vertices[outoIndex2].y * outoLamdda);
      var area = 0;
      var center = new b2Vec2();
      var p2 = this.m_vertices[intoIndex2];
      var p3;
      i = intoIndex2;
      while (i != outoIndex2) {
         i = (i + 1) % this.m_vertexCount;
         if (i == outoIndex2) p3 = outoVec;
         else p3 = this.m_vertices[i];
         var triangleArea = 0.5 * ((p2.x - intoVec.x) * (p3.y - intoVec.y) - (p2.y - intoVec.y) * (p3.x - intoVec.x));
         area += triangleArea;
         center.x += triangleArea * (intoVec.x + p2.x + p3.x) / 3;
         center.y += triangleArea * (intoVec.y + p2.y + p3.y) / 3;
         p2 = p3;
      }
      center.Multiply(1 / area);
      c.SetV(b2Math.MulX(xf, center));
      return area;
   }
   b2PolygonShape.prototype.GetVertexCount = function () {
      return this.m_vertexCount;
   }
   b2PolygonShape.prototype.GetVertices = function () {
      return this.m_vertices;
   }
   b2PolygonShape.prototype.GetNormals = function () {
      return this.m_normals;
   }
   b2PolygonShape.prototype.GetSupport = function (d) {
      var bestIndex = 0;
      var bestValue = this.m_vertices[0].x * d.x + this.m_vertices[0].y * d.y;
      for (var i = 1; i < this.m_vertexCount; ++i) {
         var value = this.m_vertices[i].x * d.x + this.m_vertices[i].y * d.y;
         if (value > bestValue) {
            bestIndex = i;
            bestValue = value;
         }
      }
      return bestIndex;
   }
   b2PolygonShape.prototype.GetSupportVertex = function (d) {
      var bestIndex = 0;
      var bestValue = this.m_vertices[0].x * d.x + this.m_vertices[0].y * d.y;
      for (var i = 1; i < this.m_vertexCount; ++i) {
         var value = this.m_vertices[i].x * d.x + this.m_vertices[i].y * d.y;
         if (value > bestValue) {
            bestIndex = i;
            bestValue = value;
         }
      }
      return this.m_vertices[bestIndex];
   }
   b2PolygonShape.prototype.Validate = function () {
      return false;
   }
   b2PolygonShape.prototype.b2PolygonShape = function () {
      this.__super.b2Shape.call(this);
      this.m_type = b2Shape.e_polygonShape;
      this.m_centroid = new b2Vec2();
      this.m_vertices = new Vector();
      this.m_normals = new Vector();
   }
   b2PolygonShape.prototype.Reserve = function (count) {
      if (count === undefined) count = 0;
      for (var i = parseInt(this.m_vertices.length); i < count; i++) {
         this.m_vertices[i] = new b2Vec2();
         this.m_normals[i] = new b2Vec2();
      }
   }
   b2PolygonShape.ComputeCentroid = function (vs, count) {
      if (count === undefined) count = 0;
      var c = new b2Vec2();
      var area = 0.0;
      var p1X = 0.0;
      var p1Y = 0.0;
      var inv3 = 1.0 / 3.0;
      for (var i = 0; i < count; ++i) {
         var p2 = vs[i];
         var p3 = i + 1 < count ? vs[parseInt(i + 1)] : vs[0];
         var e1X = p2.x - p1X;
         var e1Y = p2.y - p1Y;
         var e2X = p3.x - p1X;
         var e2Y = p3.y - p1Y;
         var D = (e1X * e2Y - e1Y * e2X);
         var triangleArea = 0.5 * D;area += triangleArea;
         c.x += triangleArea * inv3 * (p1X + p2.x + p3.x);
         c.y += triangleArea * inv3 * (p1Y + p2.y + p3.y);
      }
      c.x *= 1.0 / area;
      c.y *= 1.0 / area;
      return c;
   }
   b2PolygonShape.ComputeOBB = function (obb, vs, count) {
      if (count === undefined) count = 0;
      var i = 0;
      var p = new Vector(count + 1);
      for (i = 0;
      i < count; ++i) {
         p[i] = vs[i];
      }
      p[count] = p[0];
      var minArea = Number.MAX_VALUE;
      for (i = 1;
      i <= count; ++i) {
         var root = p[parseInt(i - 1)];
         var uxX = p[i].x - root.x;
         var uxY = p[i].y - root.y;
         var length = Math.sqrt(uxX * uxX + uxY * uxY);
         uxX /= length;
         uxY /= length;
         var uyX = (-uxY);
         var uyY = uxX;
         var lowerX = Number.MAX_VALUE;
         var lowerY = Number.MAX_VALUE;
         var upperX = (-Number.MAX_VALUE);
         var upperY = (-Number.MAX_VALUE);
         for (var j = 0; j < count; ++j) {
            var dX = p[j].x - root.x;
            var dY = p[j].y - root.y;
            var rX = (uxX * dX + uxY * dY);
            var rY = (uyX * dX + uyY * dY);
            if (rX < lowerX) lowerX = rX;
            if (rY < lowerY) lowerY = rY;
            if (rX > upperX) upperX = rX;
            if (rY > upperY) upperY = rY;
         }
         var area = (upperX - lowerX) * (upperY - lowerY);
         if (area < 0.95 * minArea) {
            minArea = area;
            obb.R.col1.x = uxX;
            obb.R.col1.y = uxY;
            obb.R.col2.x = uyX;
            obb.R.col2.y = uyY;
            var centerX = 0.5 * (lowerX + upperX);
            var centerY = 0.5 * (lowerY + upperY);
            var tMat = obb.R;
            obb.center.x = root.x + (tMat.col1.x * centerX + tMat.col2.x * centerY);
            obb.center.y = root.y + (tMat.col1.y * centerX + tMat.col2.y * centerY);
            obb.extents.x = 0.5 * (upperX - lowerX);
            obb.extents.y = 0.5 * (upperY - lowerY);
         }
      }
   }
   Box2D.postDefs.push(function () {
      Box2D.Collision.Shapes.b2PolygonShape.s_mat = new b2Mat22();
   });
   b2Shape.b2Shape = function () {};
   b2Shape.prototype.Copy = function () {
      return null;
   }
   b2Shape.prototype.Set = function (other) {
      this.m_radius = other.m_radius;
   }
   b2Shape.prototype.GetType = function () {
      return this.m_type;
   }
   b2Shape.prototype.TestPoint = function (xf, p) {
      return false;
   }
   b2Shape.prototype.RayCast = function (output, input, transform) {
      return false;
   }
   b2Shape.prototype.ComputeAABB = function (aabb, xf) {}
   b2Shape.prototype.ComputeMass = function (massData, density) {
      if (density === undefined) density = 0;
   }
   b2Shape.prototype.ComputeSubmergedArea = function (normal, offset, xf, c) {
      if (offset === undefined) offset = 0;
      return 0;
   }
   b2Shape.TestOverlap = function (shape1, transform1, shape2, transform2) {
      var input = new b2DistanceInput();
      input.proxyA = new b2DistanceProxy();
      input.proxyA.Set(shape1);
      input.proxyB = new b2DistanceProxy();
      input.proxyB.Set(shape2);
      input.transformA = transform1;
      input.transformB = transform2;
      input.useRadii = true;
      var simplexCache = new b2SimplexCache();
      simplexCache.count = 0;
      var output = new b2DistanceOutput();
      b2Distance.Distance(output, simplexCache, input);
      return output.distance < 10.0 * Number.MIN_VALUE;
   }
   b2Shape.prototype.b2Shape = function () {
      this.m_type = b2Shape.e_unknownShape;
      this.m_radius = b2Settings.b2_linearSlop;
   }
   Box2D.postDefs.push(function () {
      Box2D.Collision.Shapes.b2Shape.e_unknownShape = parseInt((-1));
      Box2D.Collision.Shapes.b2Shape.e_circleShape = 0;
      Box2D.Collision.Shapes.b2Shape.e_polygonShape = 1;
      Box2D.Collision.Shapes.b2Shape.e_edgeShape = 2;
      Box2D.Collision.Shapes.b2Shape.e_shapeTypeCount = 3;
      Box2D.Collision.Shapes.b2Shape.e_hitCollide = 1;
      Box2D.Collision.Shapes.b2Shape.e_missCollide = 0;
      Box2D.Collision.Shapes.b2Shape.e_startsInsideCollide = parseInt((-1));
   });
})();
(function () {
   var b2Color = Box2D.Common.b2Color,
      b2internal = Box2D.Common.b2internal,
      b2Settings = Box2D.Common.b2Settings,
      b2Mat22 = Box2D.Common.Math.b2Mat22,
      b2Mat33 = Box2D.Common.Math.b2Mat33,
      b2Math = Box2D.Common.Math.b2Math,
      b2Sweep = Box2D.Common.Math.b2Sweep,
      b2Transform = Box2D.Common.Math.b2Transform,
      b2Vec2 = Box2D.Common.Math.b2Vec2,
      b2Vec3 = Box2D.Common.Math.b2Vec3;

   b2Color.b2Color = function () {
      this._r = 0;
      this._g = 0;
      this._b = 0;
   };
   b2Color.prototype.b2Color = function (rr, gg, bb) {
      if (rr === undefined) rr = 0;
      if (gg === undefined) gg = 0;
      if (bb === undefined) bb = 0;
      this._r = Box2D.parseUInt(255 * b2Math.Clamp(rr, 0.0, 1.0));
      this._g = Box2D.parseUInt(255 * b2Math.Clamp(gg, 0.0, 1.0));
      this._b = Box2D.parseUInt(255 * b2Math.Clamp(bb, 0.0, 1.0));
   }
   b2Color.prototype.Set = function (rr, gg, bb) {
      if (rr === undefined) rr = 0;
      if (gg === undefined) gg = 0;
      if (bb === undefined) bb = 0;
      this._r = Box2D.parseUInt(255 * b2Math.Clamp(rr, 0.0, 1.0));
      this._g = Box2D.parseUInt(255 * b2Math.Clamp(gg, 0.0, 1.0));
      this._b = Box2D.parseUInt(255 * b2Math.Clamp(bb, 0.0, 1.0));
   }
   Object.defineProperty(b2Color.prototype, 'r', {
      enumerable: false,
      configurable: true,
      set: function (rr) {
         if (rr === undefined) rr = 0;
         this._r = Box2D.parseUInt(255 * b2Math.Clamp(rr, 0.0, 1.0));
      }
   });
   Object.defineProperty(b2Color.prototype, 'g', {
      enumerable: false,
      configurable: true,
      set: function (gg) {
         if (gg === undefined) gg = 0;
         this._g = Box2D.parseUInt(255 * b2Math.Clamp(gg, 0.0, 1.0));
      }
   });
   Object.defineProperty(b2Color.prototype, 'b', {
      enumerable: false,
      configurable: true,
      set: function (bb) {
         if (bb === undefined) bb = 0;
         this._b = Box2D.parseUInt(255 * b2Math.Clamp(bb, 0.0, 1.0));
      }
   });
   Object.defineProperty(b2Color.prototype, 'color', {
      enumerable: false,
      configurable: true,
      get: function () {
         return (this._r << 16) | (this._g << 8) | (this._b);
      }
   });
   b2Settings.b2Settings = function () {};
   b2Settings.b2MixFriction = function (friction1, friction2) {
      if (friction1 === undefined) friction1 = 0;
      if (friction2 === undefined) friction2 = 0;
      return Math.sqrt(friction1 * friction2);
   }
   b2Settings.b2MixRestitution = function (restitution1, restitution2) {
      if (restitution1 === undefined) restitution1 = 0;
      if (restitution2 === undefined) restitution2 = 0;
      return restitution1 > restitution2 ? restitution1 : restitution2;
   }
   b2Settings.b2Assert = function (a) {
      if (!a) {
         throw "Assertion Failed";
      }
   }
   Box2D.postDefs.push(function () {
      Box2D.Common.b2Settings.VERSION = "2.1alpha";
      Box2D.Common.b2Settings.USHRT_MAX = 0x0000ffff;
      Box2D.Common.b2Settings.b2_pi = Math.PI;
      Box2D.Common.b2Settings.b2_maxManifoldPoints = 2;
      Box2D.Common.b2Settings.b2_aabbExtension = 0.1;
      Box2D.Common.b2Settings.b2_aabbMultiplier = 2.0;
      Box2D.Common.b2Settings.b2_polygonRadius = 2.0 * b2Settings.b2_linearSlop;
      Box2D.Common.b2Settings.b2_linearSlop = 0.005;
      Box2D.Common.b2Settings.b2_angularSlop = 2.0 / 180.0 * b2Settings.b2_pi;
      Box2D.Common.b2Settings.b2_toiSlop = 8.0 * b2Settings.b2_linearSlop;
      Box2D.Common.b2Settings.b2_maxTOIContactsPerIsland = 32;
      Box2D.Common.b2Settings.b2_maxTOIJointsPerIsland = 32;
      Box2D.Common.b2Settings.b2_velocityThreshold = 1.0;
      Box2D.Common.b2Settings.b2_maxLinearCorrection = 0.2;
      Box2D.Common.b2Settings.b2_maxAngularCorrection = 8.0 / 180.0 * b2Settings.b2_pi;
      Box2D.Common.b2Settings.b2_maxTranslation = 2.0;
      Box2D.Common.b2Settings.b2_maxTranslationSquared = b2Settings.b2_maxTranslation * b2Settings.b2_maxTranslation;
      Box2D.Common.b2Settings.b2_maxRotation = 0.5 * b2Settings.b2_pi;
      Box2D.Common.b2Settings.b2_maxRotationSquared = b2Settings.b2_maxRotation * b2Settings.b2_maxRotation;
      Box2D.Common.b2Settings.b2_contactBaumgarte = 0.2;
      Box2D.Common.b2Settings.b2_timeToSleep = 0.5;
      Box2D.Common.b2Settings.b2_linearSleepTolerance = 0.01;
      Box2D.Common.b2Settings.b2_angularSleepTolerance = 2.0 / 180.0 * b2Settings.b2_pi;
   });
})();
(function () {
   var b2AABB = Box2D.Collision.b2AABB,
      b2Color = Box2D.Common.b2Color,
      b2internal = Box2D.Common.b2internal,
      b2Settings = Box2D.Common.b2Settings,
      b2Mat22 = Box2D.Common.Math.b2Mat22,
      b2Mat33 = Box2D.Common.Math.b2Mat33,
      b2Math = Box2D.Common.Math.b2Math,
      b2Sweep = Box2D.Common.Math.b2Sweep,
      b2Transform = Box2D.Common.Math.b2Transform,
      b2Vec2 = Box2D.Common.Math.b2Vec2,
      b2Vec3 = Box2D.Common.Math.b2Vec3;

   b2Mat22.b2Mat22 = function () {
      this.col1 = new b2Vec2();
      this.col2 = new b2Vec2();
   };
   b2Mat22.prototype.b2Mat22 = function () {
      this.SetIdentity();
   }
   b2Mat22.FromAngle = function (angle) {
      if (angle === undefined) angle = 0;
      var mat = new b2Mat22();
      mat.Set(angle);
      return mat;
   }
   b2Mat22.FromVV = function (c1, c2) {
      var mat = new b2Mat22();
      mat.SetVV(c1, c2);
      return mat;
   }
   b2Mat22.prototype.Set = function (angle) {
      if (angle === undefined) angle = 0;
      var c = Math.cos(angle);
      var s = Math.sin(angle);
      this.col1.x = c;
      this.col2.x = (-s);
      this.col1.y = s;
      this.col2.y = c;
   }
   b2Mat22.prototype.SetVV = function (c1, c2) {
      this.col1.SetV(c1);
      this.col2.SetV(c2);
   }
   b2Mat22.prototype.Copy = function () {
      var mat = new b2Mat22();
      mat.SetM(this);
      return mat;
   }
   b2Mat22.prototype.SetM = function (m) {
      this.col1.SetV(m.col1);
      this.col2.SetV(m.col2);
   }
   b2Mat22.prototype.AddM = function (m) {
      this.col1.x += m.col1.x;
      this.col1.y += m.col1.y;
      this.col2.x += m.col2.x;
      this.col2.y += m.col2.y;
   }
   b2Mat22.prototype.SetIdentity = function () {
      this.col1.x = 1.0;
      this.col2.x = 0.0;
      this.col1.y = 0.0;
      this.col2.y = 1.0;
   }
   b2Mat22.prototype.SetZero = function () {
      this.col1.x = 0.0;
      this.col2.x = 0.0;
      this.col1.y = 0.0;
      this.col2.y = 0.0;
   }
   b2Mat22.prototype.GetAngle = function () {
      return Math.atan2(this.col1.y, this.col1.x);
   }
   b2Mat22.prototype.GetInverse = function (out) {
      var a = this.col1.x;
      var b = this.col2.x;
      var c = this.col1.y;
      var d = this.col2.y;
      var det = a * d - b * c;
      if (det != 0.0) {
         det = 1.0 / det;
      }
      out.col1.x = det * d;
      out.col2.x = (-det * b);
      out.col1.y = (-det * c);
      out.col2.y = det * a;
      return out;
   }
   b2Mat22.prototype.Solve = function (out, bX, bY) {
      if (bX === undefined) bX = 0;
      if (bY === undefined) bY = 0;
      var a11 = this.col1.x;
      var a12 = this.col2.x;
      var a21 = this.col1.y;
      var a22 = this.col2.y;
      var det = a11 * a22 - a12 * a21;
      if (det != 0.0) {
         det = 1.0 / det;
      }
      out.x = det * (a22 * bX - a12 * bY);
      out.y = det * (a11 * bY - a21 * bX);
      return out;
   }
   b2Mat22.prototype.Abs = function () {
      this.col1.Abs();
      this.col2.Abs();
   }
   b2Mat33.b2Mat33 = function () {
      this.col1 = new b2Vec3();
      this.col2 = new b2Vec3();
      this.col3 = new b2Vec3();
   };
   b2Mat33.prototype.b2Mat33 = function (c1, c2, c3) {
      if (c1 === undefined) c1 = null;
      if (c2 === undefined) c2 = null;
      if (c3 === undefined) c3 = null;
      if (!c1 && !c2 && !c3) {
         this.col1.SetZero();
         this.col2.SetZero();
         this.col3.SetZero();
      }
      else {
         this.col1.SetV(c1);
         this.col2.SetV(c2);
         this.col3.SetV(c3);
      }
   }
   b2Mat33.prototype.SetVVV = function (c1, c2, c3) {
      this.col1.SetV(c1);
      this.col2.SetV(c2);
      this.col3.SetV(c3);
   }
   b2Mat33.prototype.Copy = function () {
      return new b2Mat33(this.col1, this.col2, this.col3);
   }
   b2Mat33.prototype.SetM = function (m) {
      this.col1.SetV(m.col1);
      this.col2.SetV(m.col2);
      this.col3.SetV(m.col3);
   }
   b2Mat33.prototype.AddM = function (m) {
      this.col1.x += m.col1.x;
      this.col1.y += m.col1.y;
      this.col1.z += m.col1.z;
      this.col2.x += m.col2.x;
      this.col2.y += m.col2.y;
      this.col2.z += m.col2.z;
      this.col3.x += m.col3.x;
      this.col3.y += m.col3.y;
      this.col3.z += m.col3.z;
   }
   b2Mat33.prototype.SetIdentity = function () {
      this.col1.x = 1.0;
      this.col2.x = 0.0;
      this.col3.x = 0.0;
      this.col1.y = 0.0;
      this.col2.y = 1.0;
      this.col3.y = 0.0;
      this.col1.z = 0.0;
      this.col2.z = 0.0;
      this.col3.z = 1.0;
   }
   b2Mat33.prototype.SetZero = function () {
      this.col1.x = 0.0;
      this.col2.x = 0.0;
      this.col3.x = 0.0;
      this.col1.y = 0.0;
      this.col2.y = 0.0;
      this.col3.y = 0.0;
      this.col1.z = 0.0;
      this.col2.z = 0.0;
      this.col3.z = 0.0;
   }
   b2Mat33.prototype.Solve22 = function (out, bX, bY) {
      if (bX === undefined) bX = 0;
      if (bY === undefined) bY = 0;
      var a11 = this.col1.x;
      var a12 = this.col2.x;
      var a21 = this.col1.y;
      var a22 = this.col2.y;
      var det = a11 * a22 - a12 * a21;
      if (det != 0.0) {
         det = 1.0 / det;
      }
      out.x = det * (a22 * bX - a12 * bY);
      out.y = det * (a11 * bY - a21 * bX);
      return out;
   }
   b2Mat33.prototype.Solve33 = function (out, bX, bY, bZ) {
      if (bX === undefined) bX = 0;
      if (bY === undefined) bY = 0;
      if (bZ === undefined) bZ = 0;
      var a11 = this.col1.x;
      var a21 = this.col1.y;
      var a31 = this.col1.z;
      var a12 = this.col2.x;
      var a22 = this.col2.y;
      var a32 = this.col2.z;
      var a13 = this.col3.x;
      var a23 = this.col3.y;
      var a33 = this.col3.z;
      var det = a11 * (a22 * a33 - a32 * a23) + a21 * (a32 * a13 - a12 * a33) + a31 * (a12 * a23 - a22 * a13);
      if (det != 0.0) {
         det = 1.0 / det;
      }
      out.x = det * (bX * (a22 * a33 - a32 * a23) + bY * (a32 * a13 - a12 * a33) + bZ * (a12 * a23 - a22 * a13));
      out.y = det * (a11 * (bY * a33 - bZ * a23) + a21 * (bZ * a13 - bX * a33) + a31 * (bX * a23 - bY * a13));
      out.z = det * (a11 * (a22 * bZ - a32 * bY) + a21 * (a32 * bX - a12 * bZ) + a31 * (a12 * bY - a22 * bX));
      return out;
   }
   b2Math.b2Math = function () {};
   b2Math.IsValid = function (x) {
      if (x === undefined) x = 0;
      return isFinite(x);
   }
   b2Math.Dot = function (a, b) {
      return a.x * b.x + a.y * b.y;
   }
   b2Math.CrossVV = function (a, b) {
      return a.x * b.y - a.y * b.x;
   }
   b2Math.CrossVF = function (a, s) {
      if (s === undefined) s = 0;
      var v = new b2Vec2(s * a.y, (-s * a.x));
      return v;
   }
   b2Math.CrossFV = function (s, a) {
      if (s === undefined) s = 0;
      var v = new b2Vec2((-s * a.y), s * a.x);
      return v;
   }
   b2Math.MulMV = function (A, v) {
      var u = new b2Vec2(A.col1.x * v.x + A.col2.x * v.y, A.col1.y * v.x + A.col2.y * v.y);
      return u;
   }
   b2Math.MulTMV = function (A, v) {
      var u = new b2Vec2(b2Math.Dot(v, A.col1), b2Math.Dot(v, A.col2));
      return u;
   }
   b2Math.MulX = function (T, v) {
      var a = b2Math.MulMV(T.R, v);
      a.x += T.position.x;
      a.y += T.position.y;
      return a;
   }
   b2Math.MulXT = function (T, v) {
      var a = b2Math.SubtractVV(v, T.position);
      var tX = (a.x * T.R.col1.x + a.y * T.R.col1.y);
      a.y = (a.x * T.R.col2.x + a.y * T.R.col2.y);
      a.x = tX;
      return a;
   }
   b2Math.AddVV = function (a, b) {
      var v = new b2Vec2(a.x + b.x, a.y + b.y);
      return v;
   }
   b2Math.SubtractVV = function (a, b) {
      var v = new b2Vec2(a.x - b.x, a.y - b.y);
      return v;
   }
   b2Math.Distance = function (a, b) {
      var cX = a.x - b.x;
      var cY = a.y - b.y;
      return Math.sqrt(cX * cX + cY * cY);
   }
   b2Math.DistanceSquared = function (a, b) {
      var cX = a.x - b.x;
      var cY = a.y - b.y;
      return (cX * cX + cY * cY);
   }
   b2Math.MulFV = function (s, a) {
      if (s === undefined) s = 0;
      var v = new b2Vec2(s * a.x, s * a.y);
      return v;
   }
   b2Math.AddMM = function (A, B) {
      var C = b2Mat22.FromVV(b2Math.AddVV(A.col1, B.col1), b2Math.AddVV(A.col2, B.col2));
      return C;
   }
   b2Math.MulMM = function (A, B) {
      var C = b2Mat22.FromVV(b2Math.MulMV(A, B.col1), b2Math.MulMV(A, B.col2));
      return C;
   }
   b2Math.MulTMM = function (A, B) {
      var c1 = new b2Vec2(b2Math.Dot(A.col1, B.col1), b2Math.Dot(A.col2, B.col1));
      var c2 = new b2Vec2(b2Math.Dot(A.col1, B.col2), b2Math.Dot(A.col2, B.col2));
      var C = b2Mat22.FromVV(c1, c2);
      return C;
   }
   b2Math.Abs = function (a) {
      if (a === undefined) a = 0;
      return a > 0.0 ? a : (-a);
   }
   b2Math.AbsV = function (a) {
      var b = new b2Vec2(b2Math.Abs(a.x), b2Math.Abs(a.y));
      return b;
   }
   b2Math.AbsM = function (A) {
      var B = b2Mat22.FromVV(b2Math.AbsV(A.col1), b2Math.AbsV(A.col2));
      return B;
   }
   b2Math.Min = function (a, b) {
      if (a === undefined) a = 0;
      if (b === undefined) b = 0;
      return a < b ? a : b;
   }
   b2Math.MinV = function (a, b) {
      var c = new b2Vec2(b2Math.Min(a.x, b.x), b2Math.Min(a.y, b.y));
      return c;
   }
   b2Math.Max = function (a, b) {
      if (a === undefined) a = 0;
      if (b === undefined) b = 0;
      return a > b ? a : b;
   }
   b2Math.MaxV = function (a, b) {
      var c = new b2Vec2(b2Math.Max(a.x, b.x), b2Math.Max(a.y, b.y));
      return c;
   }
   b2Math.Clamp = function (a, low, high) {
      if (a === undefined) a = 0;
      if (low === undefined) low = 0;
      if (high === undefined) high = 0;
      return a < low ? low : a > high ? high : a;
   }
   b2Math.ClampV = function (a, low, high) {
      return b2Math.MaxV(low, b2Math.MinV(a, high));
   }
   b2Math.Swap = function (a, b) {
      var tmp = a[0];
      a[0] = b[0];
      b[0] = tmp;
   }
   b2Math.Random = function () {
      return Math.random() * 2 - 1;
   }
   b2Math.RandomRange = function (lo, hi) {
      if (lo === undefined) lo = 0;
      if (hi === undefined) hi = 0;
      var r = Math.random();
      r = (hi - lo) * r + lo;
      return r;
   }
   b2Math.NextPowerOfTwo = function (x) {
      if (x === undefined) x = 0;
      x |= (x >> 1) & 0x7FFFFFFF;
      x |= (x >> 2) & 0x3FFFFFFF;
      x |= (x >> 4) & 0x0FFFFFFF;
      x |= (x >> 8) & 0x00FFFFFF;
      x |= (x >> 16) & 0x0000FFFF;
      return x + 1;
   }
   b2Math.IsPowerOfTwo = function (x) {
      if (x === undefined) x = 0;
      var result = x > 0 && (x & (x - 1)) == 0;
      return result;
   }
   Box2D.postDefs.push(function () {
      Box2D.Common.Math.b2Math.b2Vec2_zero = new b2Vec2(0.0, 0.0);
      Box2D.Common.Math.b2Math.b2Mat22_identity = b2Mat22.FromVV(new b2Vec2(1.0, 0.0), new b2Vec2(0.0, 1.0));
      Box2D.Common.Math.b2Math.b2Transform_identity = new b2Transform(b2Math.b2Vec2_zero, b2Math.b2Mat22_identity);
   });
   b2Sweep.b2Sweep = function () {
      this.localCenter = new b2Vec2();
      this.c0 = new b2Vec2;
      this.c = new b2Vec2();
   };
   b2Sweep.prototype.Set = function (other) {
      this.localCenter.SetV(other.localCenter);
      this.c0.SetV(other.c0);
      this.c.SetV(other.c);
      this.a0 = other.a0;
      this.a = other.a;
      this.t0 = other.t0;
   }
   b2Sweep.prototype.Copy = function () {
      var copy = new b2Sweep();
      copy.localCenter.SetV(this.localCenter);
      copy.c0.SetV(this.c0);
      copy.c.SetV(this.c);
      copy.a0 = this.a0;
      copy.a = this.a;
      copy.t0 = this.t0;
      return copy;
   }
   b2Sweep.prototype.GetTransform = function (xf, alpha) {
      if (alpha === undefined) alpha = 0;
      xf.position.x = (1.0 - alpha) * this.c0.x + alpha * this.c.x;
      xf.position.y = (1.0 - alpha) * this.c0.y + alpha * this.c.y;
      var angle = (1.0 - alpha) * this.a0 + alpha * this.a;
      xf.R.Set(angle);
      var tMat = xf.R;
      xf.position.x -= (tMat.col1.x * this.localCenter.x + tMat.col2.x * this.localCenter.y);
      xf.position.y -= (tMat.col1.y * this.localCenter.x + tMat.col2.y * this.localCenter.y);
   }
   b2Sweep.prototype.Advance = function (t) {
      if (t === undefined) t = 0;
      if (this.t0 < t && 1.0 - this.t0 > Number.MIN_VALUE) {
         var alpha = (t - this.t0) / (1.0 - this.t0);
         this.c0.x = (1.0 - alpha) * this.c0.x + alpha * this.c.x;
         this.c0.y = (1.0 - alpha) * this.c0.y + alpha * this.c.y;
         this.a0 = (1.0 - alpha) * this.a0 + alpha * this.a;
         this.t0 = t;
      }
   }
   b2Transform.b2Transform = function () {
      this.position = new b2Vec2;
      this.R = new b2Mat22();
   };
   b2Transform.prototype.b2Transform = function (pos, r) {
      if (pos === undefined) pos = null;
      if (r === undefined) r = null;
      if (pos) {
         this.position.SetV(pos);
         this.R.SetM(r);
      }
   }
   b2Transform.prototype.Initialize = function (pos, r) {
      this.position.SetV(pos);
      this.R.SetM(r);
   }
   b2Transform.prototype.SetIdentity = function () {
      this.position.SetZero();
      this.R.SetIdentity();
   }
   b2Transform.prototype.Set = function (x) {
      this.position.SetV(x.position);
      this.R.SetM(x.R);
   }
   b2Transform.prototype.GetAngle = function () {
      return Math.atan2(this.R.col1.y, this.R.col1.x);
   }
   b2Vec2.b2Vec2 = function () {};
   b2Vec2.prototype.b2Vec2 = function (x_, y_) {
      if (x_ === undefined) x_ = 0;
      if (y_ === undefined) y_ = 0;
      this.x = x_;
      this.y = y_;
   }
   b2Vec2.prototype.SetZero = function () {
      this.x = 0.0;
      this.y = 0.0;
   }
   b2Vec2.prototype.Set = function (x_, y_) {
      if (x_ === undefined) x_ = 0;
      if (y_ === undefined) y_ = 0;
      this.x = x_;
      this.y = y_;
   }
   b2Vec2.prototype.SetV = function (v) {
      this.x = v.x;
      this.y = v.y;
   }
   b2Vec2.prototype.GetNegative = function () {
      return new b2Vec2((-this.x), (-this.y));
   }
   b2Vec2.prototype.NegativeSelf = function () {
      this.x = (-this.x);
      this.y = (-this.y);
   }
   b2Vec2.Make = function (x_, y_) {
      if (x_ === undefined) x_ = 0;
      if (y_ === undefined) y_ = 0;
      return new b2Vec2(x_, y_);
   }
   b2Vec2.prototype.Copy = function () {
      return new b2Vec2(this.x, this.y);
   }
   b2Vec2.prototype.Add = function (v) {
      this.x += v.x;
      this.y += v.y;
   }
   b2Vec2.prototype.Subtract = function (v) {
      this.x -= v.x;
      this.y -= v.y;
   }
   b2Vec2.prototype.Multiply = function (a) {
      if (a === undefined) a = 0;
      this.x *= a;
      this.y *= a;
   }
   b2Vec2.prototype.MulM = function (A) {
      var tX = this.x;
      this.x = A.col1.x * tX + A.col2.x * this.y;
      this.y = A.col1.y * tX + A.col2.y * this.y;
   }
   b2Vec2.prototype.MulTM = function (A) {
      var tX = b2Math.Dot(this, A.col1);
      this.y = b2Math.Dot(this, A.col2);
      this.x = tX;
   }
   b2Vec2.prototype.CrossVF = function (s) {
      if (s === undefined) s = 0;
      var tX = this.x;
      this.x = s * this.y;
      this.y = (-s * tX);
   }
   b2Vec2.prototype.CrossFV = function (s) {
      if (s === undefined) s = 0;
      var tX = this.x;
      this.x = (-s * this.y);
      this.y = s * tX;
   }
   b2Vec2.prototype.MinV = function (b) {
      this.x = this.x < b.x ? this.x : b.x;
      this.y = this.y < b.y ? this.y : b.y;
   }
   b2Vec2.prototype.MaxV = function (b) {
      this.x = this.x > b.x ? this.x : b.x;
      this.y = this.y > b.y ? this.y : b.y;
   }
   b2Vec2.prototype.Abs = function () {
      if (this.x < 0) this.x = (-this.x);
      if (this.y < 0) this.y = (-this.y);
   }
   b2Vec2.prototype.Length = function () {
      return Math.sqrt(this.x * this.x + this.y * this.y);
   }
   b2Vec2.prototype.LengthSquared = function () {
      return (this.x * this.x + this.y * this.y);
   }
   b2Vec2.prototype.Normalize = function () {
      var length = Math.sqrt(this.x * this.x + this.y * this.y);
      if (length < Number.MIN_VALUE) {
         return 0.0;
      }
      var invLength = 1.0 / length;
      this.x *= invLength;
      this.y *= invLength;
      return length;
   }
   b2Vec2.prototype.IsValid = function () {
      return b2Math.IsValid(this.x) && b2Math.IsValid(this.y);
   }
   b2Vec3.b2Vec3 = function () {};
   b2Vec3.prototype.b2Vec3 = function (x, y, z) {
      if (x === undefined) x = 0;
      if (y === undefined) y = 0;
      if (z === undefined) z = 0;
      this.x = x;
      this.y = y;
      this.z = z;
   }
   b2Vec3.prototype.SetZero = function () {
      this.x = this.y = this.z = 0.0;
   }
   b2Vec3.prototype.Set = function (x, y, z) {
      if (x === undefined) x = 0;
      if (y === undefined) y = 0;
      if (z === undefined) z = 0;
      this.x = x;
      this.y = y;
      this.z = z;
   }
   b2Vec3.prototype.SetV = function (v) {
      this.x = v.x;
      this.y = v.y;
      this.z = v.z;
   }
   b2Vec3.prototype.GetNegative = function () {
      return new b2Vec3((-this.x), (-this.y), (-this.z));
   }
   b2Vec3.prototype.NegativeSelf = function () {
      this.x = (-this.x);
      this.y = (-this.y);
      this.z = (-this.z);
   }
   b2Vec3.prototype.Copy = function () {
      return new b2Vec3(this.x, this.y, this.z);
   }
   b2Vec3.prototype.Add = function (v) {
      this.x += v.x;
      this.y += v.y;
      this.z += v.z;
   }
   b2Vec3.prototype.Subtract = function (v) {
      this.x -= v.x;
      this.y -= v.y;
      this.z -= v.z;
   }
   b2Vec3.prototype.Multiply = function (a) {
      if (a === undefined) a = 0;
      this.x *= a;
      this.y *= a;
      this.z *= a;
   }
})();
(function () {
   var b2ControllerEdge = Box2D.Dynamics.Controllers.b2ControllerEdge,
      b2Mat22 = Box2D.Common.Math.b2Mat22,
      b2Mat33 = Box2D.Common.Math.b2Mat33,
      b2Math = Box2D.Common.Math.b2Math,
      b2Sweep = Box2D.Common.Math.b2Sweep,
      b2Transform = Box2D.Common.Math.b2Transform,
      b2Vec2 = Box2D.Common.Math.b2Vec2,
      b2Vec3 = Box2D.Common.Math.b2Vec3,
      b2Color = Box2D.Common.b2Color,
      b2internal = Box2D.Common.b2internal,
      b2Settings = Box2D.Common.b2Settings,
      b2AABB = Box2D.Collision.b2AABB,
      b2Bound = Box2D.Collision.b2Bound,
      b2BoundValues = Box2D.Collision.b2BoundValues,
      b2Collision = Box2D.Collision.b2Collision,
      b2ContactID = Box2D.Collision.b2ContactID,
      b2ContactPoint = Box2D.Collision.b2ContactPoint,
      b2Distance = Box2D.Collision.b2Distance,
      b2DistanceInput = Box2D.Collision.b2DistanceInput,
      b2DistanceOutput = Box2D.Collision.b2DistanceOutput,
      b2DistanceProxy = Box2D.Collision.b2DistanceProxy,
      b2DynamicTree = Box2D.Collision.b2DynamicTree,
      b2DynamicTreeBroadPhase = Box2D.Collision.b2DynamicTreeBroadPhase,
      b2DynamicTreeNode = Box2D.Collision.b2DynamicTreeNode,
      b2DynamicTreePair = Box2D.Collision.b2DynamicTreePair,
      b2Manifold = Box2D.Collision.b2Manifold,
      b2ManifoldPoint = Box2D.Collision.b2ManifoldPoint,
      b2Point = Box2D.Collision.b2Point,
      b2RayCastInput = Box2D.Collision.b2RayCastInput,
      b2RayCastOutput = Box2D.Collision.b2RayCastOutput,
      b2Segment = Box2D.Collision.b2Segment,
      b2SeparationFunction = Box2D.Collision.b2SeparationFunction,
      b2Simplex = Box2D.Collision.b2Simplex,
      b2SimplexCache = Box2D.Collision.b2SimplexCache,
      b2SimplexVertex = Box2D.Collision.b2SimplexVertex,
      b2TimeOfImpact = Box2D.Collision.b2TimeOfImpact,
      b2TOIInput = Box2D.Collision.b2TOIInput,
      b2WorldManifold = Box2D.Collision.b2WorldManifold,
      ClipVertex = Box2D.Collision.ClipVertex,
      Features = Box2D.Collision.Features,
      IBroadPhase = Box2D.Collision.IBroadPhase,
      b2CircleShape = Box2D.Collision.Shapes.b2CircleShape,
      b2EdgeChainDef = Box2D.Collision.Shapes.b2EdgeChainDef,
      b2EdgeShape = Box2D.Collision.Shapes.b2EdgeShape,
      b2MassData = Box2D.Collision.Shapes.b2MassData,
      b2PolygonShape = Box2D.Collision.Shapes.b2PolygonShape,
      b2Shape = Box2D.Collision.Shapes.b2Shape,
      b2Body = Box2D.Dynamics.b2Body,
      b2BodyDef = Box2D.Dynamics.b2BodyDef,
      b2ContactFilter = Box2D.Dynamics.b2ContactFilter,
      b2ContactImpulse = Box2D.Dynamics.b2ContactImpulse,
      b2ContactListener = Box2D.Dynamics.b2ContactListener,
      b2ContactManager = Box2D.Dynamics.b2ContactManager,
      b2DebugDraw = Box2D.Dynamics.b2DebugDraw,
      b2DestructionListener = Box2D.Dynamics.b2DestructionListener,
      b2FilterData = Box2D.Dynamics.b2FilterData,
      b2Fixture = Box2D.Dynamics.b2Fixture,
      b2FixtureDef = Box2D.Dynamics.b2FixtureDef,
      b2Island = Box2D.Dynamics.b2Island,
      b2TimeStep = Box2D.Dynamics.b2TimeStep,
      b2World = Box2D.Dynamics.b2World,
      b2CircleContact = Box2D.Dynamics.Contacts.b2CircleContact,
      b2Contact = Box2D.Dynamics.Contacts.b2Contact,
      b2ContactConstraint = Box2D.Dynamics.Contacts.b2ContactConstraint,
      b2ContactConstraintPoint = Box2D.Dynamics.Contacts.b2ContactConstraintPoint,
      b2ContactEdge = Box2D.Dynamics.Contacts.b2ContactEdge,
      b2ContactFactory = Box2D.Dynamics.Contacts.b2ContactFactory,
      b2ContactRegister = Box2D.Dynamics.Contacts.b2ContactRegister,
      b2ContactResult = Box2D.Dynamics.Contacts.b2ContactResult,
      b2ContactSolver = Box2D.Dynamics.Contacts.b2ContactSolver,
      b2EdgeAndCircleContact = Box2D.Dynamics.Contacts.b2EdgeAndCircleContact,
      b2NullContact = Box2D.Dynamics.Contacts.b2NullContact,
      b2PolyAndCircleContact = Box2D.Dynamics.Contacts.b2PolyAndCircleContact,
      b2PolyAndEdgeContact = Box2D.Dynamics.Contacts.b2PolyAndEdgeContact,
      b2PolygonContact = Box2D.Dynamics.Contacts.b2PolygonContact,
      b2PositionSolverManifold = Box2D.Dynamics.Contacts.b2PositionSolverManifold,
      b2Controller = Box2D.Dynamics.Controllers.b2Controller,
      b2DistanceJoint = Box2D.Dynamics.Joints.b2DistanceJoint,
      b2DistanceJointDef = Box2D.Dynamics.Joints.b2DistanceJointDef,
      b2FrictionJoint = Box2D.Dynamics.Joints.b2FrictionJoint,
      b2FrictionJointDef = Box2D.Dynamics.Joints.b2FrictionJointDef,
      b2GearJoint = Box2D.Dynamics.Joints.b2GearJoint,
      b2GearJointDef = Box2D.Dynamics.Joints.b2GearJointDef,
      b2Jacobian = Box2D.Dynamics.Joints.b2Jacobian,
      b2Joint = Box2D.Dynamics.Joints.b2Joint,
      b2JointDef = Box2D.Dynamics.Joints.b2JointDef,
      b2JointEdge = Box2D.Dynamics.Joints.b2JointEdge,
      b2LineJoint = Box2D.Dynamics.Joints.b2LineJoint,
      b2LineJointDef = Box2D.Dynamics.Joints.b2LineJointDef,
      b2MouseJoint = Box2D.Dynamics.Joints.b2MouseJoint,
      b2MouseJointDef = Box2D.Dynamics.Joints.b2MouseJointDef,
      b2PrismaticJoint = Box2D.Dynamics.Joints.b2PrismaticJoint,
      b2PrismaticJointDef = Box2D.Dynamics.Joints.b2PrismaticJointDef,
      b2PulleyJoint = Box2D.Dynamics.Joints.b2PulleyJoint,
      b2PulleyJointDef = Box2D.Dynamics.Joints.b2PulleyJointDef,
      b2RevoluteJoint = Box2D.Dynamics.Joints.b2RevoluteJoint,
      b2RevoluteJointDef = Box2D.Dynamics.Joints.b2RevoluteJointDef,
      b2WeldJoint = Box2D.Dynamics.Joints.b2WeldJoint,
      b2WeldJointDef = Box2D.Dynamics.Joints.b2WeldJointDef;

   b2Body.b2Body = function () {
      this.m_xf = new b2Transform();
      this.m_sweep = new b2Sweep();
      this.m_linearVelocity = new b2Vec2();
      this.m_force = new b2Vec2();
   };
   b2Body.prototype.connectEdges = function (s1, s2, angle1) {
      if (angle1 === undefined) angle1 = 0;
      var angle2 = Math.atan2(s2.GetDirectionVector().y, s2.GetDirectionVector().x);
      var coreOffset = Math.tan((angle2 - angle1) * 0.5);
      var core = b2Math.MulFV(coreOffset, s2.GetDirectionVector());
      core = b2Math.SubtractVV(core, s2.GetNormalVector());
      core = b2Math.MulFV(b2Settings.b2_toiSlop, core);
      core = b2Math.AddVV(core, s2.GetVertex1());
      var cornerDir = b2Math.AddVV(s1.GetDirectionVector(), s2.GetDirectionVector());
      cornerDir.Normalize();
      var convex = b2Math.Dot(s1.GetDirectionVector(), s2.GetNormalVector()) > 0.0;
      s1.SetNextEdge(s2, core, cornerDir, convex);
      s2.SetPrevEdge(s1, core, cornerDir, convex);
      return angle2;
   }
   b2Body.prototype.CreateFixture = function (def) {
      if (this.m_world.IsLocked() == true) {
         return null;
      }
      var fixture = new b2Fixture();
      fixture.Create(this, this.m_xf, def);
      if (this.m_flags & b2Body.e_activeFlag) {
         var broadPhase = this.m_world.m_contactManager.m_broadPhase;
         fixture.CreateProxy(broadPhase, this.m_xf);
      }
      fixture.m_next = this.m_fixtureList;
      this.m_fixtureList = fixture;
      ++this.m_fixtureCount;
      fixture.m_body = this;
      if (fixture.m_density > 0.0) {
         this.ResetMassData();
      }
      this.m_world.m_flags |= b2World.e_newFixture;
      return fixture;
   }
   b2Body.prototype.CreateFixture2 = function (shape, density) {
      if (density === undefined) density = 0.0;
      var def = new b2FixtureDef();
      def.shape = shape;
      def.density = density;
      return this.CreateFixture(def);
   }
   b2Body.prototype.DestroyFixture = function (fixture) {
      if (this.m_world.IsLocked() == true) {
         return;
      }
      var node = this.m_fixtureList;
      var ppF = null;
      var found = false;
      while (node != null) {
         if (node == fixture) {
            if (ppF) ppF.m_next = fixture.m_next;
            else this.m_fixtureList = fixture.m_next;
            found = true;
            break;
         }
         ppF = node;
         node = node.m_next;
      }
      var edge = this.m_contactList;
      while (edge) {
         var c = edge.contact;
         edge = edge.next;
         var fixtureA = c.GetFixtureA();
         var fixtureB = c.GetFixtureB();
         if (fixture == fixtureA || fixture == fixtureB) {
            this.m_world.m_contactManager.Destroy(c);
         }
      }
      if (this.m_flags & b2Body.e_activeFlag) {
         var broadPhase = this.m_world.m_contactManager.m_broadPhase;
         fixture.DestroyProxy(broadPhase);
      }
      else {}
      fixture.Destroy();
      fixture.m_body = null;
      fixture.m_next = null;
      --this.m_fixtureCount;
      this.ResetMassData();
   }
   b2Body.prototype.SetPositionAndAngle = function (position, angle) {
      if (angle === undefined) angle = 0;
      var f;
      if (this.m_world.IsLocked() == true) {
         return;
      }
      this.m_xf.R.Set(angle);
      this.m_xf.position.SetV(position);
      var tMat = this.m_xf.R;
      var tVec = this.m_sweep.localCenter;
      this.m_sweep.c.x = (tMat.col1.x * tVec.x + tMat.col2.x * tVec.y);
      this.m_sweep.c.y = (tMat.col1.y * tVec.x + tMat.col2.y * tVec.y);
      this.m_sweep.c.x += this.m_xf.position.x;
      this.m_sweep.c.y += this.m_xf.position.y;
      this.m_sweep.c0.SetV(this.m_sweep.c);
      this.m_sweep.a0 = this.m_sweep.a = angle;
      var broadPhase = this.m_world.m_contactManager.m_broadPhase;
      for (f = this.m_fixtureList;
      f; f = f.m_next) {
         f.Synchronize(broadPhase, this.m_xf, this.m_xf);
      }
      this.m_world.m_contactManager.FindNewContacts();
   }
   b2Body.prototype.SetTransform = function (xf) {
      this.SetPositionAndAngle(xf.position, xf.GetAngle());
   }
   b2Body.prototype.GetTransform = function () {
      return this.m_xf;
   }
   b2Body.prototype.GetPosition = function () {
      return this.m_xf.position;
   }
   b2Body.prototype.SetPosition = function (position) {
      this.SetPositionAndAngle(position, this.GetAngle());
   }
   b2Body.prototype.GetAngle = function () {
      return this.m_sweep.a;
   }
   b2Body.prototype.SetAngle = function (angle) {
      if (angle === undefined) angle = 0;
      this.SetPositionAndAngle(this.GetPosition(), angle);
   }
   b2Body.prototype.GetWorldCenter = function () {
      return this.m_sweep.c;
   }
   b2Body.prototype.GetLocalCenter = function () {
      return this.m_sweep.localCenter;
   }
   b2Body.prototype.SetLinearVelocity = function (v) {
      if (this.m_type == b2Body.b2_staticBody) {
         return;
      }
      this.m_linearVelocity.SetV(v);
   }
   b2Body.prototype.GetLinearVelocity = function () {
      return this.m_linearVelocity;
   }
   b2Body.prototype.SetAngularVelocity = function (omega) {
      if (omega === undefined) omega = 0;
      if (this.m_type == b2Body.b2_staticBody) {
         return;
      }
      this.m_angularVelocity = omega;
   }
   b2Body.prototype.GetAngularVelocity = function () {
      return this.m_angularVelocity;
   }
   b2Body.prototype.GetDefinition = function () {
      var bd = new b2BodyDef();
      bd.type = this.GetType();
      bd.allowSleep = (this.m_flags & b2Body.e_allowSleepFlag) == b2Body.e_allowSleepFlag;
      bd.angle = this.GetAngle();
      bd.angularDamping = this.m_angularDamping;
      bd.angularVelocity = this.m_angularVelocity;
      bd.fixedRotation = (this.m_flags & b2Body.e_fixedRotationFlag) == b2Body.e_fixedRotationFlag;
      bd.bullet = (this.m_flags & b2Body.e_bulletFlag) == b2Body.e_bulletFlag;
      bd.awake = (this.m_flags & b2Body.e_awakeFlag) == b2Body.e_awakeFlag;
      bd.linearDamping = this.m_linearDamping;
      bd.linearVelocity.SetV(this.GetLinearVelocity());
      bd.position = this.GetPosition();
      bd.userData = this.GetUserData();
      return bd;
   }
   b2Body.prototype.ApplyForce = function (force, point) {
      if (this.m_type != b2Body.b2_dynamicBody) {
         return;
      }
      if (this.IsAwake() == false) {
         this.SetAwake(true);
      }
      this.m_force.x += force.x;
      this.m_force.y += force.y;
      this.m_torque += ((point.x - this.m_sweep.c.x) * force.y - (point.y - this.m_sweep.c.y) * force.x);
   }
   b2Body.prototype.ApplyTorque = function (torque) {
      if (torque === undefined) torque = 0;
      if (this.m_type != b2Body.b2_dynamicBody) {
         return;
      }
      if (this.IsAwake() == false) {
         this.SetAwake(true);
      }
      this.m_torque += torque;
   }
   b2Body.prototype.ApplyImpulse = function (impulse, point) {
      if (this.m_type != b2Body.b2_dynamicBody) {
         return;
      }
      if (this.IsAwake() == false) {
         this.SetAwake(true);
      }
      this.m_linearVelocity.x += this.m_invMass * impulse.x;
      this.m_linearVelocity.y += this.m_invMass * impulse.y;
      this.m_angularVelocity += this.m_invI * ((point.x - this.m_sweep.c.x) * impulse.y - (point.y - this.m_sweep.c.y) * impulse.x);
   }
   b2Body.prototype.Split = function (callback) {
      var linearVelocity = this.GetLinearVelocity().Copy();
      var angularVelocity = this.GetAngularVelocity();
      var center = this.GetWorldCenter();
      var body1 = this;
      var body2 = this.m_world.CreateBody(this.GetDefinition());
      var prev;
      for (var f = body1.m_fixtureList; f;) {
         if (callback(f)) {
            var next = f.m_next;
            if (prev) {
               prev.m_next = next;
            }
            else {
               body1.m_fixtureList = next;
            }
            body1.m_fixtureCount--;
            f.m_next = body2.m_fixtureList;
            body2.m_fixtureList = f;
            body2.m_fixtureCount++;
            f.m_body = body2;
            f = next;
         }
         else {
            prev = f;
            f = f.m_next;
         }
      }
      body1.ResetMassData();
      body2.ResetMassData();
      var center1 = body1.GetWorldCenter();
      var center2 = body2.GetWorldCenter();
      var velocity1 = b2Math.AddVV(linearVelocity, b2Math.CrossFV(angularVelocity, b2Math.SubtractVV(center1, center)));
      var velocity2 = b2Math.AddVV(linearVelocity, b2Math.CrossFV(angularVelocity, b2Math.SubtractVV(center2, center)));
      body1.SetLinearVelocity(velocity1);
      body2.SetLinearVelocity(velocity2);
      body1.SetAngularVelocity(angularVelocity);
      body2.SetAngularVelocity(angularVelocity);
      body1.SynchronizeFixtures();
      body2.SynchronizeFixtures();
      return body2;
   }
   b2Body.prototype.Merge = function (other) {
      var f;
      for (f = other.m_fixtureList;
      f;) {
         var next = f.m_next;
         other.m_fixtureCount--;
         f.m_next = this.m_fixtureList;
         this.m_fixtureList = f;
         this.m_fixtureCount++;
         f.m_body = body2;
         f = next;
      }
      body1.m_fixtureCount = 0;
      var body1 = this;
      var body2 = other;
      var center1 = body1.GetWorldCenter();
      var center2 = body2.GetWorldCenter();
      var velocity1 = body1.GetLinearVelocity().Copy();
      var velocity2 = body2.GetLinearVelocity().Copy();
      var angular1 = body1.GetAngularVelocity();
      var angular = body2.GetAngularVelocity();
      body1.ResetMassData();
      this.SynchronizeFixtures();
   }
   b2Body.prototype.GetMass = function () {
      return this.m_mass;
   }
   b2Body.prototype.GetInertia = function () {
      return this.m_I;
   }
   b2Body.prototype.GetMassData = function (data) {
      data.mass = this.m_mass;
      data.I = this.m_I;
      data.center.SetV(this.m_sweep.localCenter);
   }
   b2Body.prototype.SetMassData = function (massData) {
      b2Settings.b2Assert(this.m_world.IsLocked() == false);
      if (this.m_world.IsLocked() == true) {
         return;
      }
      if (this.m_type != b2Body.b2_dynamicBody) {
         return;
      }
      this.m_invMass = 0.0;
      this.m_I = 0.0;
      this.m_invI = 0.0;
      this.m_mass = massData.mass;
      if (this.m_mass <= 0.0) {
         this.m_mass = 1.0;
      }
      this.m_invMass = 1.0 / this.m_mass;
      if (massData.I > 0.0 && (this.m_flags & b2Body.e_fixedRotationFlag) == 0) {
         this.m_I = massData.I - this.m_mass * (massData.center.x * massData.center.x + massData.center.y * massData.center.y);
         this.m_invI = 1.0 / this.m_I;
      }
      var oldCenter = this.m_sweep.c.Copy();
      this.m_sweep.localCenter.SetV(massData.center);
      this.m_sweep.c0.SetV(b2Math.MulX(this.m_xf, this.m_sweep.localCenter));
      this.m_sweep.c.SetV(this.m_sweep.c0);
      this.m_linearVelocity.x += this.m_angularVelocity * (-(this.m_sweep.c.y - oldCenter.y));
      this.m_linearVelocity.y += this.m_angularVelocity * (+(this.m_sweep.c.x - oldCenter.x));
   }
   b2Body.prototype.ResetMassData = function () {
      this.m_mass = 0.0;
      this.m_invMass = 0.0;
      this.m_I = 0.0;
      this.m_invI = 0.0;
      this.m_sweep.localCenter.SetZero();
      if (this.m_type == b2Body.b2_staticBody || this.m_type == b2Body.b2_kinematicBody) {
         return;
      }
      var center = b2Vec2.Make(0, 0);
      for (var f = this.m_fixtureList; f; f = f.m_next) {
         if (f.m_density == 0.0) {
            continue;
         }
         var massData = f.GetMassData();
         this.m_mass += massData.mass;
         center.x += massData.center.x * massData.mass;
         center.y += massData.center.y * massData.mass;
         this.m_I += massData.I;
      }
      if (this.m_mass > 0.0) {
         this.m_invMass = 1.0 / this.m_mass;
         center.x *= this.m_invMass;
         center.y *= this.m_invMass;
      }
      else {
         this.m_mass = 1.0;
         this.m_invMass = 1.0;
      }
      if (this.m_I > 0.0 && (this.m_flags & b2Body.e_fixedRotationFlag) == 0) {
         this.m_I -= this.m_mass * (center.x * center.x + center.y * center.y);
         this.m_I *= this.m_inertiaScale;
         b2Settings.b2Assert(this.m_I > 0);
         this.m_invI = 1.0 / this.m_I;
      }
      else {
         this.m_I = 0.0;
         this.m_invI = 0.0;
      }
      var oldCenter = this.m_sweep.c.Copy();
      this.m_sweep.localCenter.SetV(center);
      this.m_sweep.c0.SetV(b2Math.MulX(this.m_xf, this.m_sweep.localCenter));
      this.m_sweep.c.SetV(this.m_sweep.c0);
      this.m_linearVelocity.x += this.m_angularVelocity * (-(this.m_sweep.c.y - oldCenter.y));
      this.m_linearVelocity.y += this.m_angularVelocity * (+(this.m_sweep.c.x - oldCenter.x));
   }
   b2Body.prototype.GetWorldPoint = function (localPoint) {
      var A = this.m_xf.R;
      var u = new b2Vec2(A.col1.x * localPoint.x + A.col2.x * localPoint.y, A.col1.y * localPoint.x + A.col2.y * localPoint.y);
      u.x += this.m_xf.position.x;
      u.y += this.m_xf.position.y;
      return u;
   }
   b2Body.prototype.GetWorldVector = function (localVector) {
      return b2Math.MulMV(this.m_xf.R, localVector);
   }
   b2Body.prototype.GetLocalPoint = function (worldPoint) {
      return b2Math.MulXT(this.m_xf, worldPoint);
   }
   b2Body.prototype.GetLocalVector = function (worldVector) {
      return b2Math.MulTMV(this.m_xf.R, worldVector);
   }
   b2Body.prototype.GetLinearVelocityFromWorldPoint = function (worldPoint) {
      return new b2Vec2(this.m_linearVelocity.x - this.m_angularVelocity * (worldPoint.y - this.m_sweep.c.y), this.m_linearVelocity.y + this.m_angularVelocity * (worldPoint.x - this.m_sweep.c.x));
   }
   b2Body.prototype.GetLinearVelocityFromLocalPoint = function (localPoint) {
      var A = this.m_xf.R;
      var worldPoint = new b2Vec2(A.col1.x * localPoint.x + A.col2.x * localPoint.y, A.col1.y * localPoint.x + A.col2.y * localPoint.y);
      worldPoint.x += this.m_xf.position.x;
      worldPoint.y += this.m_xf.position.y;
      return new b2Vec2(this.m_linearVelocity.x - this.m_angularVelocity * (worldPoint.y - this.m_sweep.c.y), this.m_linearVelocity.y + this.m_angularVelocity * (worldPoint.x - this.m_sweep.c.x));
   }
   b2Body.prototype.GetLinearDamping = function () {
      return this.m_linearDamping;
   }
   b2Body.prototype.SetLinearDamping = function (linearDamping) {
      if (linearDamping === undefined) linearDamping = 0;
      this.m_linearDamping = linearDamping;
   }
   b2Body.prototype.GetAngularDamping = function () {
      return this.m_angularDamping;
   }
   b2Body.prototype.SetAngularDamping = function (angularDamping) {
      if (angularDamping === undefined) angularDamping = 0;
      this.m_angularDamping = angularDamping;
   }
   b2Body.prototype.SetType = function (type) {
      if (type === undefined) type = 0;
      if (this.m_type == type) {
         return;
      }
      this.m_type = type;
      this.ResetMassData();
      if (this.m_type == b2Body.b2_staticBody) {
         this.m_linearVelocity.SetZero();
         this.m_angularVelocity = 0.0;
      }
      this.SetAwake(true);
      this.m_force.SetZero();
      this.m_torque = 0.0;
      for (var ce = this.m_contactList; ce; ce = ce.next) {
         ce.contact.FlagForFiltering();
      }
   }
   b2Body.prototype.GetType = function () {
      return this.m_type;
   }
   b2Body.prototype.SetBullet = function (flag) {
      if (flag) {
         this.m_flags |= b2Body.e_bulletFlag;
      }
      else {
         this.m_flags &= ~b2Body.e_bulletFlag;
      }
   }
   b2Body.prototype.IsBullet = function () {
      return (this.m_flags & b2Body.e_bulletFlag) == b2Body.e_bulletFlag;
   }
   b2Body.prototype.SetSleepingAllowed = function (flag) {
      if (flag) {
         this.m_flags |= b2Body.e_allowSleepFlag;
      }
      else {
         this.m_flags &= ~b2Body.e_allowSleepFlag;
         this.SetAwake(true);
      }
   }
   b2Body.prototype.SetAwake = function (flag) {
      if (flag) {
         this.m_flags |= b2Body.e_awakeFlag;
         this.m_sleepTime = 0.0;
      }
      else {
         this.m_flags &= ~b2Body.e_awakeFlag;
         this.m_sleepTime = 0.0;
         this.m_linearVelocity.SetZero();
         this.m_angularVelocity = 0.0;
         this.m_force.SetZero();
         this.m_torque = 0.0;
      }
   }
   b2Body.prototype.IsAwake = function () {
      return (this.m_flags & b2Body.e_awakeFlag) == b2Body.e_awakeFlag;
   }
   b2Body.prototype.SetFixedRotation = function (fixed) {
      if (fixed) {
         this.m_flags |= b2Body.e_fixedRotationFlag;
      }
      else {
         this.m_flags &= ~b2Body.e_fixedRotationFlag;
      }
      this.ResetMassData();
   }
   b2Body.prototype.IsFixedRotation = function () {
      return (this.m_flags & b2Body.e_fixedRotationFlag) == b2Body.e_fixedRotationFlag;
   }
   b2Body.prototype.SetActive = function (flag) {
      if (flag == this.IsActive()) {
         return;
      }
      var broadPhase;
      var f;
      if (flag) {
         this.m_flags |= b2Body.e_activeFlag;
         broadPhase = this.m_world.m_contactManager.m_broadPhase;
         for (f = this.m_fixtureList;
         f; f = f.m_next) {
            f.CreateProxy(broadPhase, this.m_xf);
         }
      }
      else {
         this.m_flags &= ~b2Body.e_activeFlag;
         broadPhase = this.m_world.m_contactManager.m_broadPhase;
         for (f = this.m_fixtureList;
         f; f = f.m_next) {
            f.DestroyProxy(broadPhase);
         }
         var ce = this.m_contactList;
         while (ce) {
            var ce0 = ce;
            ce = ce.next;
            this.m_world.m_contactManager.Destroy(ce0.contact);
         }
         this.m_contactList = null;
      }
   }
   b2Body.prototype.IsActive = function () {
      return (this.m_flags & b2Body.e_activeFlag) == b2Body.e_activeFlag;
   }
   b2Body.prototype.IsSleepingAllowed = function () {
      return (this.m_flags & b2Body.e_allowSleepFlag) == b2Body.e_allowSleepFlag;
   }
   b2Body.prototype.GetFixtureList = function () {
      return this.m_fixtureList;
   }
   b2Body.prototype.GetJointList = function () {
      return this.m_jointList;
   }
   b2Body.prototype.GetControllerList = function () {
      return this.m_controllerList;
   }
   b2Body.prototype.GetContactList = function () {
      return this.m_contactList;
   }
   b2Body.prototype.GetNext = function () {
      return this.m_next;
   }
   b2Body.prototype.GetUserData = function () {
      return this.m_userData;
   }
   b2Body.prototype.SetUserData = function (data) {
      this.m_userData = data;
   }
   b2Body.prototype.GetWorld = function () {
      return this.m_world;
   }
   b2Body.prototype.b2Body = function (bd, world) {
      this.m_flags = 0;
      if (bd.bullet) {
         this.m_flags |= b2Body.e_bulletFlag;
      }
      if (bd.fixedRotation) {
         this.m_flags |= b2Body.e_fixedRotationFlag;
      }
      if (bd.allowSleep) {
         this.m_flags |= b2Body.e_allowSleepFlag;
      }
      if (bd.awake) {
         this.m_flags |= b2Body.e_awakeFlag;
      }
      if (bd.active) {
         this.m_flags |= b2Body.e_activeFlag;
      }
      this.m_world = world;
      this.m_xf.position.SetV(bd.position);
      this.m_xf.R.Set(bd.angle);
      this.m_sweep.localCenter.SetZero();
      this.m_sweep.t0 = 1.0;
      this.m_sweep.a0 = this.m_sweep.a = bd.angle;
      var tMat = this.m_xf.R;
      var tVec = this.m_sweep.localCenter;
      this.m_sweep.c.x = (tMat.col1.x * tVec.x + tMat.col2.x * tVec.y);
      this.m_sweep.c.y = (tMat.col1.y * tVec.x + tMat.col2.y * tVec.y);
      this.m_sweep.c.x += this.m_xf.position.x;
      this.m_sweep.c.y += this.m_xf.position.y;
      this.m_sweep.c0.SetV(this.m_sweep.c);
      this.m_jointList = null;
      this.m_controllerList = null;
      this.m_contactList = null;
      this.m_controllerCount = 0;
      this.m_prev = null;
      this.m_next = null;
      this.m_linearVelocity.SetV(bd.linearVelocity);
      this.m_angularVelocity = bd.angularVelocity;
      this.m_linearDamping = bd.linearDamping;
      this.m_angularDamping = bd.angularDamping;
      this.m_force.Set(0.0, 0.0);
      this.m_torque = 0.0;
      this.m_sleepTime = 0.0;
      this.m_type = bd.type;
      if (this.m_type == b2Body.b2_dynamicBody) {
         this.m_mass = 1.0;
         this.m_invMass = 1.0;
      }
      else {
         this.m_mass = 0.0;
         this.m_invMass = 0.0;
      }
      this.m_I = 0.0;
      this.m_invI = 0.0;
      this.m_inertiaScale = bd.inertiaScale;
      this.m_userData = bd.userData;
      this.m_fixtureList = null;
      this.m_fixtureCount = 0;
   }
   b2Body.prototype.SynchronizeFixtures = function () {
      var xf1 = b2Body.s_xf1;
      xf1.R.Set(this.m_sweep.a0);
      var tMat = xf1.R;
      var tVec = this.m_sweep.localCenter;
      xf1.position.x = this.m_sweep.c0.x - (tMat.col1.x * tVec.x + tMat.col2.x * tVec.y);
      xf1.position.y = this.m_sweep.c0.y - (tMat.col1.y * tVec.x + tMat.col2.y * tVec.y);
      var f;
      var broadPhase = this.m_world.m_contactManager.m_broadPhase;
      for (f = this.m_fixtureList;
      f; f = f.m_next) {
         f.Synchronize(broadPhase, xf1, this.m_xf);
      }
   }
   b2Body.prototype.SynchronizeTransform = function () {
      this.m_xf.R.Set(this.m_sweep.a);
      var tMat = this.m_xf.R;
      var tVec = this.m_sweep.localCenter;
      this.m_xf.position.x = this.m_sweep.c.x - (tMat.col1.x * tVec.x + tMat.col2.x * tVec.y);
      this.m_xf.position.y = this.m_sweep.c.y - (tMat.col1.y * tVec.x + tMat.col2.y * tVec.y);
   }
   b2Body.prototype.ShouldCollide = function (other) {
      if (this.m_type != b2Body.b2_dynamicBody && other.m_type != b2Body.b2_dynamicBody) {
         return false;
      }
      for (var jn = this.m_jointList; jn; jn = jn.next) {
         if (jn.other == other) if (jn.joint.m_collideConnected == false) {
            return false;
         }
      }
      return true;
   }
   b2Body.prototype.Advance = function (t) {
      if (t === undefined) t = 0;
      this.m_sweep.Advance(t);
      this.m_sweep.c.SetV(this.m_sweep.c0);
      this.m_sweep.a = this.m_sweep.a0;
      this.SynchronizeTransform();
   }
   Box2D.postDefs.push(function () {
      Box2D.Dynamics.b2Body.s_xf1 = new b2Transform();
      Box2D.Dynamics.b2Body.e_islandFlag = 0x0001;
      Box2D.Dynamics.b2Body.e_awakeFlag = 0x0002;
      Box2D.Dynamics.b2Body.e_allowSleepFlag = 0x0004;
      Box2D.Dynamics.b2Body.e_bulletFlag = 0x0008;
      Box2D.Dynamics.b2Body.e_fixedRotationFlag = 0x0010;
      Box2D.Dynamics.b2Body.e_activeFlag = 0x0020;
      Box2D.Dynamics.b2Body.b2_staticBody = 0;
      Box2D.Dynamics.b2Body.b2_kinematicBody = 1;
      Box2D.Dynamics.b2Body.b2_dynamicBody = 2;
   });
   b2BodyDef.b2BodyDef = function () {
      this.position = new b2Vec2();
      this.linearVelocity = new b2Vec2();
   };
   b2BodyDef.prototype.b2BodyDef = function () {
      this.userData = null;
      this.position.Set(0.0, 0.0);
      this.angle = 0.0;
      this.linearVelocity.Set(0, 0);
      this.angularVelocity = 0.0;
      this.linearDamping = 0.0;
      this.angularDamping = 0.0;
      this.allowSleep = true;
      this.awake = true;
      this.fixedRotation = false;
      this.bullet = false;
      this.type = b2Body.b2_staticBody;
      this.active = true;
      this.inertiaScale = 1.0;
   }
   b2ContactFilter.b2ContactFilter = function () {};
   b2ContactFilter.prototype.ShouldCollide = function (fixtureA, fixtureB) {
      var filter1 = fixtureA.GetFilterData();
      var filter2 = fixtureB.GetFilterData();
      if (filter1.groupIndex == filter2.groupIndex && filter1.groupIndex != 0) {
         return filter1.groupIndex > 0;
      }
      var collide = (filter1.maskBits & filter2.categoryBits) != 0 && (filter1.categoryBits & filter2.maskBits) != 0;
      return collide;
   }
   b2ContactFilter.prototype.RayCollide = function (userData, fixture) {
      if (!userData) return true;
      return this.ShouldCollide((userData instanceof b2Fixture ? userData : null), fixture);
   }
   Box2D.postDefs.push(function () {
      Box2D.Dynamics.b2ContactFilter.b2_defaultFilter = new b2ContactFilter();
   });
   b2ContactImpulse.b2ContactImpulse = function () {
      this.normalImpulses = new Vector_a2j_Number(b2Settings.b2_maxManifoldPoints);
      this.tangentImpulses = new Vector_a2j_Number(b2Settings.b2_maxManifoldPoints);
   };
   b2ContactListener.b2ContactListener = function () {};
   b2ContactListener.prototype.BeginContact = function (contact) {}
   b2ContactListener.prototype.EndContact = function (contact) {}
   b2ContactListener.prototype.PreSolve = function (contact, oldManifold) {}
   b2ContactListener.prototype.PostSolve = function (contact, impulse) {}
   Box2D.postDefs.push(function () {
      Box2D.Dynamics.b2ContactListener.b2_defaultListener = new b2ContactListener();
   });
   b2ContactManager.b2ContactManager = function () {};
   b2ContactManager.prototype.b2ContactManager = function () {
      this.m_world = null;
      this.m_contactCount = 0;
      this.m_contactFilter = b2ContactFilter.b2_defaultFilter;
      this.m_contactListener = b2ContactListener.b2_defaultListener;
      this.m_contactFactory = new b2ContactFactory(this.m_allocator);
      this.m_broadPhase = new b2DynamicTreeBroadPhase();
   }
   b2ContactManager.prototype.AddPair = function (proxyUserDataA, proxyUserDataB) {
      var fixtureA = (proxyUserDataA instanceof b2Fixture ? proxyUserDataA : null);
      var fixtureB = (proxyUserDataB instanceof b2Fixture ? proxyUserDataB : null);
      var bodyA = fixtureA.GetBody();
      var bodyB = fixtureB.GetBody();
      if (bodyA == bodyB) return;
      var edge = bodyB.GetContactList();
      while (edge) {
         if (edge.other == bodyA) {
            var fA = edge.contact.GetFixtureA();
            var fB = edge.contact.GetFixtureB();
            if (fA == fixtureA && fB == fixtureB) return;
            if (fA == fixtureB && fB == fixtureA) return;
         }
         edge = edge.next;
      }
      if (bodyB.ShouldCollide(bodyA) == false) {
         return;
      }
      if (this.m_contactFilter.ShouldCollide(fixtureA, fixtureB) == false) {
         return;
      }
      var c = this.m_contactFactory.Create(fixtureA, fixtureB);
      fixtureA = c.GetFixtureA();
      fixtureB = c.GetFixtureB();
      bodyA = fixtureA.m_body;
      bodyB = fixtureB.m_body;
      c.m_prev = null;
      c.m_next = this.m_world.m_contactList;
      if (this.m_world.m_contactList != null) {
         this.m_world.m_contactList.m_prev = c;
      }
      this.m_world.m_contactList = c;
      c.m_nodeA.contact = c;
      c.m_nodeA.other = bodyB;
      c.m_nodeA.prev = null;
      c.m_nodeA.next = bodyA.m_contactList;
      if (bodyA.m_contactList != null) {
         bodyA.m_contactList.prev = c.m_nodeA;
      }
      bodyA.m_contactList = c.m_nodeA;
      c.m_nodeB.contact = c;
      c.m_nodeB.other = bodyA;
      c.m_nodeB.prev = null;
      c.m_nodeB.next = bodyB.m_contactList;
      if (bodyB.m_contactList != null) {
         bodyB.m_contactList.prev = c.m_nodeB;
      }
      bodyB.m_contactList = c.m_nodeB;
      ++this.m_world.m_contactCount;
      return;
   }
   b2ContactManager.prototype.FindNewContacts = function () {
      this.m_broadPhase.UpdatePairs(Box2D.generateCallback(this, this.AddPair));
   }
   b2ContactManager.prototype.Destroy = function (c) {
      var fixtureA = c.GetFixtureA();
      var fixtureB = c.GetFixtureB();
      var bodyA = fixtureA.GetBody();
      var bodyB = fixtureB.GetBody();
      if (c.IsTouching()) {
         this.m_contactListener.EndContact(c);
      }
      if (c.m_prev) {
         c.m_prev.m_next = c.m_next;
      }
      if (c.m_next) {
         c.m_next.m_prev = c.m_prev;
      }
      if (c == this.m_world.m_contactList) {
         this.m_world.m_contactList = c.m_next;
      }
      if (c.m_nodeA.prev) {
         c.m_nodeA.prev.next = c.m_nodeA.next;
      }
      if (c.m_nodeA.next) {
         c.m_nodeA.next.prev = c.m_nodeA.prev;
      }
      if (c.m_nodeA == bodyA.m_contactList) {
         bodyA.m_contactList = c.m_nodeA.next;
      }
      if (c.m_nodeB.prev) {
         c.m_nodeB.prev.next = c.m_nodeB.next;
      }
      if (c.m_nodeB.next) {
         c.m_nodeB.next.prev = c.m_nodeB.prev;
      }
      if (c.m_nodeB == bodyB.m_contactList) {
         bodyB.m_contactList = c.m_nodeB.next;
      }
      this.m_contactFactory.Destroy(c);
      --this.m_contactCount;
   }
   b2ContactManager.prototype.Collide = function () {
      var c = this.m_world.m_contactList;
      while (c) {
         var fixtureA = c.GetFixtureA();
         var fixtureB = c.GetFixtureB();
         var bodyA = fixtureA.GetBody();
         var bodyB = fixtureB.GetBody();
         if (bodyA.IsAwake() == false && bodyB.IsAwake() == false) {
            c = c.GetNext();
            continue;
         }
         if (c.m_flags & b2Contact.e_filterFlag) {
            if (bodyB.ShouldCollide(bodyA) == false) {
               var cNuke = c;
               c = cNuke.GetNext();
               this.Destroy(cNuke);
               continue;
            }
            if (this.m_contactFilter.ShouldCollide(fixtureA, fixtureB) == false) {
               cNuke = c;
               c = cNuke.GetNext();
               this.Destroy(cNuke);
               continue;
            }
            c.m_flags &= ~b2Contact.e_filterFlag;
         }
         var proxyA = fixtureA.m_proxy;
         var proxyB = fixtureB.m_proxy;
         var overlap = this.m_broadPhase.TestOverlap(proxyA, proxyB);
         if (overlap == false) {
            cNuke = c;
            c = cNuke.GetNext();
            this.Destroy(cNuke);
            continue;
         }
         c.Update(this.m_contactListener);
         c = c.GetNext();
      }
   }
   Box2D.postDefs.push(function () {
      Box2D.Dynamics.b2ContactManager.s_evalCP = new b2ContactPoint();
   });
   b2DebugDraw.b2DebugDraw = function () {};
   b2DebugDraw.prototype.b2DebugDraw = function () {}
   b2DebugDraw.prototype.SetFlags = function (flags) {
      if (flags === undefined) flags = 0;
   }
   b2DebugDraw.prototype.GetFlags = function () {}
   b2DebugDraw.prototype.AppendFlags = function (flags) {
      if (flags === undefined) flags = 0;
   }
   b2DebugDraw.prototype.ClearFlags = function (flags) {
      if (flags === undefined) flags = 0;
   }
   b2DebugDraw.prototype.SetSprite = function (sprite) {}
   b2DebugDraw.prototype.GetSprite = function () {}
   b2DebugDraw.prototype.SetDrawScale = function (drawScale) {
      if (drawScale === undefined) drawScale = 0;
   }
   b2DebugDraw.prototype.GetDrawScale = function () {}
   b2DebugDraw.prototype.SetLineThickness = function (lineThickness) {
      if (lineThickness === undefined) lineThickness = 0;
   }
   b2DebugDraw.prototype.GetLineThickness = function () {}
   b2DebugDraw.prototype.SetAlpha = function (alpha) {
      if (alpha === undefined) alpha = 0;
   }
   b2DebugDraw.prototype.GetAlpha = function () {}
   b2DebugDraw.prototype.SetFillAlpha = function (alpha) {
      if (alpha === undefined) alpha = 0;
   }
   b2DebugDraw.prototype.GetFillAlpha = function () {}
   b2DebugDraw.prototype.SetXFormScale = function (xformScale) {
      if (xformScale === undefined) xformScale = 0;
   }
   b2DebugDraw.prototype.GetXFormScale = function () {}
   b2DebugDraw.prototype.DrawPolygon = function (vertices, vertexCount, color) {
      if (vertexCount === undefined) vertexCount = 0;
   }
   b2DebugDraw.prototype.DrawSolidPolygon = function (vertices, vertexCount, color) {
      if (vertexCount === undefined) vertexCount = 0;
   }
   b2DebugDraw.prototype.DrawCircle = function (center, radius, color) {
      if (radius === undefined) radius = 0;
   }
   b2DebugDraw.prototype.DrawSolidCircle = function (center, radius, axis, color) {
      if (radius === undefined) radius = 0;
   }
   b2DebugDraw.prototype.DrawSegment = function (p1, p2, color) {}
   b2DebugDraw.prototype.DrawTransform = function (xf) {}
   Box2D.postDefs.push(function () {
      Box2D.Dynamics.b2DebugDraw.e_shapeBit = 0x0001;
      Box2D.Dynamics.b2DebugDraw.e_jointBit = 0x0002;
      Box2D.Dynamics.b2DebugDraw.e_aabbBit = 0x0004;
      Box2D.Dynamics.b2DebugDraw.e_pairBit = 0x0008;
      Box2D.Dynamics.b2DebugDraw.e_centerOfMassBit = 0x0010;
      Box2D.Dynamics.b2DebugDraw.e_controllerBit = 0x0020;
   });
   b2DestructionListener.b2DestructionListener = function () {};
   b2DestructionListener.prototype.SayGoodbyeJoint = function (joint) {}
   b2DestructionListener.prototype.SayGoodbyeFixture = function (fixture) {}
   b2FilterData.b2FilterData = function () {
      this.categoryBits = 0x0001;
      this.maskBits = 0xFFFF;
      this.groupIndex = 0;
   };
   b2FilterData.prototype.Copy = function () {
      var copy = new b2FilterData();
      copy.categoryBits = this.categoryBits;
      copy.maskBits = this.maskBits;
      copy.groupIndex = this.groupIndex;
      return copy;
   }
   b2Fixture.b2Fixture = function () {
      this.m_filter = new b2FilterData();
   };
   b2Fixture.prototype.GetType = function () {
      return this.m_shape.GetType();
   }
   b2Fixture.prototype.GetShape = function () {
      return this.m_shape;
   }
   b2Fixture.prototype.SetSensor = function (sensor) {
      if (this.m_isSensor == sensor) return;
      this.m_isSensor = sensor;
      if (this.m_body == null) return;
      var edge = this.m_body.GetContactList();
      while (edge) {
         var contact = edge.contact;
         var fixtureA = contact.GetFixtureA();
         var fixtureB = contact.GetFixtureB();
         if (fixtureA == this || fixtureB == this) contact.SetSensor(fixtureA.IsSensor() || fixtureB.IsSensor());
         edge = edge.next;
      }
   }
   b2Fixture.prototype.IsSensor = function () {
      return this.m_isSensor;
   }
   b2Fixture.prototype.SetFilterData = function (filter) {
      this.m_filter = filter.Copy();
      if (this.m_body) return;
      var edge = this.m_body.GetContactList();
      while (edge) {
         var contact = edge.contact;
         var fixtureA = contact.GetFixtureA();
         var fixtureB = contact.GetFixtureB();
         if (fixtureA == this || fixtureB == this) contact.FlagForFiltering();
         edge = edge.next;
      }
   }
   b2Fixture.prototype.GetFilterData = function () {
      return this.m_filter.Copy();
   }
   b2Fixture.prototype.GetBody = function () {
      return this.m_body;
   }
   b2Fixture.prototype.GetNext = function () {
      return this.m_next;
   }
   b2Fixture.prototype.GetUserData = function () {
      return this.m_userData;
   }
   b2Fixture.prototype.SetUserData = function (data) {
      this.m_userData = data;
   }
   b2Fixture.prototype.TestPoint = function (p) {
      return this.m_shape.TestPoint(this.m_body.GetTransform(), p);
   }
   b2Fixture.prototype.RayCast = function (output, input) {
      return this.m_shape.RayCast(output, input, this.m_body.GetTransform());
   }
   b2Fixture.prototype.GetMassData = function (massData) {
      if (massData === undefined) massData = null;
      if (massData == null) {
         massData = new b2MassData();
      }
      this.m_shape.ComputeMass(massData, this.m_density);
      return massData;
   }
   b2Fixture.prototype.SetDensity = function (density) {
      if (density === undefined) density = 0;
      this.m_density = density;
   }
   b2Fixture.prototype.GetDensity = function () {
      return this.m_density;
   }
   b2Fixture.prototype.GetFriction = function () {
      return this.m_friction;
   }
   b2Fixture.prototype.SetFriction = function (friction) {
      if (friction === undefined) friction = 0;
      this.m_friction = friction;
   }
   b2Fixture.prototype.GetRestitution = function () {
      return this.m_restitution;
   }
   b2Fixture.prototype.SetRestitution = function (restitution) {
      if (restitution === undefined) restitution = 0;
      this.m_restitution = restitution;
   }
   b2Fixture.prototype.GetAABB = function () {
      return this.m_aabb;
   }
   b2Fixture.prototype.b2Fixture = function () {
      this.m_aabb = new b2AABB();
      this.m_userData = null;
      this.m_body = null;
      this.m_next = null;
      this.m_shape = null;
      this.m_density = 0.0;
      this.m_friction = 0.0;
      this.m_restitution = 0.0;
   }
   b2Fixture.prototype.Create = function (body, xf, def) {
      this.m_userData = def.userData;
      this.m_friction = def.friction;
      this.m_restitution = def.restitution;
      this.m_body = body;
      this.m_next = null;
      this.m_filter = def.filter.Copy();
      this.m_isSensor = def.isSensor;
      this.m_shape = def.shape.Copy();
      this.m_density = def.density;
   }
   b2Fixture.prototype.Destroy = function () {
      this.m_shape = null;
   }
   b2Fixture.prototype.CreateProxy = function (broadPhase, xf) {
      this.m_shape.ComputeAABB(this.m_aabb, xf);
      this.m_proxy = broadPhase.CreateProxy(this.m_aabb, this);
   }
   b2Fixture.prototype.DestroyProxy = function (broadPhase) {
      if (this.m_proxy == null) {
         return;
      }
      broadPhase.DestroyProxy(this.m_proxy);
      this.m_proxy = null;
   }
   b2Fixture.prototype.Synchronize = function (broadPhase, transform1, transform2) {
      if (!this.m_proxy) return;
      var aabb1 = new b2AABB();
      var aabb2 = new b2AABB();
      this.m_shape.ComputeAABB(aabb1, transform1);
      this.m_shape.ComputeAABB(aabb2, transform2);
      this.m_aabb.Combine(aabb1, aabb2);
      var displacement = b2Math.SubtractVV(transform2.position, transform1.position);
      broadPhase.MoveProxy(this.m_proxy, this.m_aabb, displacement);
   }
   b2FixtureDef.b2FixtureDef = function () {
      this.filter = new b2FilterData();
   };
   b2FixtureDef.prototype.b2FixtureDef = function () {
      this.shape = null;
      this.userData = null;
      this.friction = 0.2;
      this.restitution = 0.0;
      this.density = 0.0;
      this.filter.categoryBits = 0x0001;
      this.filter.maskBits = 0xFFFF;
      this.filter.groupIndex = 0;
      this.isSensor = false;
   }
   b2Island.b2Island = function () {};
   b2Island.prototype.b2Island = function () {
      this.m_bodies = new Vector();
      this.m_contacts = new Vector();
      this.m_joints = new Vector();
   }
   b2Island.prototype.Initialize = function (bodyCapacity, contactCapacity, jointCapacity, allocator, listener, contactSolver) {
      if (bodyCapacity === undefined) bodyCapacity = 0;
      if (contactCapacity === undefined) contactCapacity = 0;
      if (jointCapacity === undefined) jointCapacity = 0;
      var i = 0;
      this.m_bodyCapacity = bodyCapacity;
      this.m_contactCapacity = contactCapacity;
      this.m_jointCapacity = jointCapacity;
      this.m_bodyCount = 0;
      this.m_contactCount = 0;
      this.m_jointCount = 0;
      this.m_allocator = allocator;
      this.m_listener = listener;
      this.m_contactSolver = contactSolver;
      for (i = this.m_bodies.length;
      i < bodyCapacity; i++)
      this.m_bodies[i] = null;
      for (i = this.m_contacts.length;
      i < contactCapacity; i++)
      this.m_contacts[i] = null;
      for (i = this.m_joints.length;
      i < jointCapacity; i++)
      this.m_joints[i] = null;
   }
   b2Island.prototype.Clear = function () {
      this.m_bodyCount = 0;
      this.m_contactCount = 0;
      this.m_jointCount = 0;
   }
   b2Island.prototype.Solve = function (step, gravity, allowSleep) {
      var i = 0;
      var j = 0;
      var b;
      var joint;
      for (i = 0;
      i < this.m_bodyCount; ++i) {
         b = this.m_bodies[i];
         if (b.GetType() != b2Body.b2_dynamicBody) continue;
         b.m_linearVelocity.x += step.dt * (gravity.x + b.m_invMass * b.m_force.x);
         b.m_linearVelocity.y += step.dt * (gravity.y + b.m_invMass * b.m_force.y);
         b.m_angularVelocity += step.dt * b.m_invI * b.m_torque;
         b.m_linearVelocity.Multiply(b2Math.Clamp(1.0 - step.dt * b.m_linearDamping, 0.0, 1.0));
         b.m_angularVelocity *= b2Math.Clamp(1.0 - step.dt * b.m_angularDamping, 0.0, 1.0);
      }
      this.m_contactSolver.Initialize(step, this.m_contacts, this.m_contactCount, this.m_allocator);
      var contactSolver = this.m_contactSolver;
      contactSolver.InitVelocityConstraints(step);
      for (i = 0;
      i < this.m_jointCount; ++i) {
         joint = this.m_joints[i];
         joint.InitVelocityConstraints(step);
      }
      for (i = 0;
      i < step.velocityIterations; ++i) {
         for (j = 0;
         j < this.m_jointCount; ++j) {
            joint = this.m_joints[j];
            joint.SolveVelocityConstraints(step);
         }
         contactSolver.SolveVelocityConstraints();
      }
      for (i = 0;
      i < this.m_jointCount; ++i) {
         joint = this.m_joints[i];
         joint.FinalizeVelocityConstraints();
      }
      contactSolver.FinalizeVelocityConstraints();
      for (i = 0;
      i < this.m_bodyCount; ++i) {
         b = this.m_bodies[i];
         if (b.GetType() == b2Body.b2_staticBody) continue;
         var translationX = step.dt * b.m_linearVelocity.x;
         var translationY = step.dt * b.m_linearVelocity.y;
         if ((translationX * translationX + translationY * translationY) > b2Settings.b2_maxTranslationSquared) {
            b.m_linearVelocity.Normalize();
            b.m_linearVelocity.x *= b2Settings.b2_maxTranslation * step.inv_dt;
            b.m_linearVelocity.y *= b2Settings.b2_maxTranslation * step.inv_dt;
         }
         var rotation = step.dt * b.m_angularVelocity;
         if (rotation * rotation > b2Settings.b2_maxRotationSquared) {
            if (b.m_angularVelocity < 0.0) {
               b.m_angularVelocity = (-b2Settings.b2_maxRotation * step.inv_dt);
            }
            else {
               b.m_angularVelocity = b2Settings.b2_maxRotation * step.inv_dt;
            }
         }
         b.m_sweep.c0.SetV(b.m_sweep.c);
         b.m_sweep.a0 = b.m_sweep.a;
         b.m_sweep.c.x += step.dt * b.m_linearVelocity.x;
         b.m_sweep.c.y += step.dt * b.m_linearVelocity.y;
         b.m_sweep.a += step.dt * b.m_angularVelocity;
         b.SynchronizeTransform();
      }
      for (i = 0;
      i < step.positionIterations; ++i) {
         var contactsOkay = contactSolver.SolvePositionConstraints(b2Settings.b2_contactBaumgarte);
         var jointsOkay = true;
         for (j = 0;
         j < this.m_jointCount; ++j) {
            joint = this.m_joints[j];
            var jointOkay = joint.SolvePositionConstraints(b2Settings.b2_contactBaumgarte);
            jointsOkay = jointsOkay && jointOkay;
         }
         if (contactsOkay && jointsOkay) {
            break;
         }
      }
      this.Report(contactSolver.m_constraints);
      if (allowSleep) {
         var minSleepTime = Number.MAX_VALUE;
         var linTolSqr = b2Settings.b2_linearSleepTolerance * b2Settings.b2_linearSleepTolerance;
         var angTolSqr = b2Settings.b2_angularSleepTolerance * b2Settings.b2_angularSleepTolerance;
         for (i = 0;
         i < this.m_bodyCount; ++i) {
            b = this.m_bodies[i];
            if (b.GetType() == b2Body.b2_staticBody) {
               continue;
            }
            if ((b.m_flags & b2Body.e_allowSleepFlag) == 0) {
               b.m_sleepTime = 0.0;
               minSleepTime = 0.0;
            }
            if ((b.m_flags & b2Body.e_allowSleepFlag) == 0 || b.m_angularVelocity * b.m_angularVelocity > angTolSqr || b2Math.Dot(b.m_linearVelocity, b.m_linearVelocity) > linTolSqr) {
               b.m_sleepTime = 0.0;
               minSleepTime = 0.0;
            }
            else {
               b.m_sleepTime += step.dt;
               minSleepTime = b2Math.Min(minSleepTime, b.m_sleepTime);
            }
         }
         if (minSleepTime >= b2Settings.b2_timeToSleep) {
            for (i = 0;
            i < this.m_bodyCount; ++i) {
               b = this.m_bodies[i];
               b.SetAwake(false);
            }
         }
      }
   }
   b2Island.prototype.SolveTOI = function (subStep) {
      var i = 0;
      var j = 0;
      this.m_contactSolver.Initialize(subStep, this.m_contacts, this.m_contactCount, this.m_allocator);
      var contactSolver = this.m_contactSolver;
      for (i = 0;
      i < this.m_jointCount; ++i) {
         this.m_joints[i].InitVelocityConstraints(subStep);
      }
      for (i = 0;
      i < subStep.velocityIterations; ++i) {
         contactSolver.SolveVelocityConstraints();
         for (j = 0;
         j < this.m_jointCount; ++j) {
            this.m_joints[j].SolveVelocityConstraints(subStep);
         }
      }
      for (i = 0;
      i < this.m_bodyCount; ++i) {
         var b = this.m_bodies[i];
         if (b.GetType() == b2Body.b2_staticBody) continue;
         var translationX = subStep.dt * b.m_linearVelocity.x;
         var translationY = subStep.dt * b.m_linearVelocity.y;
         if ((translationX * translationX + translationY * translationY) > b2Settings.b2_maxTranslationSquared) {
            b.m_linearVelocity.Normalize();
            b.m_linearVelocity.x *= b2Settings.b2_maxTranslation * subStep.inv_dt;
            b.m_linearVelocity.y *= b2Settings.b2_maxTranslation * subStep.inv_dt;
         }
         var rotation = subStep.dt * b.m_angularVelocity;
         if (rotation * rotation > b2Settings.b2_maxRotationSquared) {
            if (b.m_angularVelocity < 0.0) {
               b.m_angularVelocity = (-b2Settings.b2_maxRotation * subStep.inv_dt);
            }
            else {
               b.m_angularVelocity = b2Settings.b2_maxRotation * subStep.inv_dt;
            }
         }
         b.m_sweep.c0.SetV(b.m_sweep.c);
         b.m_sweep.a0 = b.m_sweep.a;
         b.m_sweep.c.x += subStep.dt * b.m_linearVelocity.x;
         b.m_sweep.c.y += subStep.dt * b.m_linearVelocity.y;
         b.m_sweep.a += subStep.dt * b.m_angularVelocity;
         b.SynchronizeTransform();
      }
      var k_toiBaumgarte = 0.75;
      for (i = 0;
      i < subStep.positionIterations; ++i) {
         var contactsOkay = contactSolver.SolvePositionConstraints(k_toiBaumgarte);
         var jointsOkay = true;
         for (j = 0;
         j < this.m_jointCount; ++j) {
            var jointOkay = this.m_joints[j].SolvePositionConstraints(b2Settings.b2_contactBaumgarte);
            jointsOkay = jointsOkay && jointOkay;
         }
         if (contactsOkay && jointsOkay) {
            break;
         }
      }
      this.Report(contactSolver.m_constraints);
   }
   b2Island.prototype.Report = function (constraints) {
      if (this.m_listener == null) {
         return;
      }
      for (var i = 0; i < this.m_contactCount; ++i) {
         var c = this.m_contacts[i];
         var cc = constraints[i];
         for (var j = 0; j < cc.pointCount; ++j) {
            b2Island.s_impulse.normalImpulses[j] = cc.points[j].normalImpulse;
            b2Island.s_impulse.tangentImpulses[j] = cc.points[j].tangentImpulse;
         }
         this.m_listener.PostSolve(c, b2Island.s_impulse);
      }
   }
   b2Island.prototype.AddBody = function (body) {
      body.m_islandIndex = this.m_bodyCount;
      this.m_bodies[this.m_bodyCount++] = body;
   }
   b2Island.prototype.AddContact = function (contact) {
      this.m_contacts[this.m_contactCount++] = contact;
   }
   b2Island.prototype.AddJoint = function (joint) {
      this.m_joints[this.m_jointCount++] = joint;
   }
   Box2D.postDefs.push(function () {
      Box2D.Dynamics.b2Island.s_impulse = new b2ContactImpulse();
   });
   b2TimeStep.b2TimeStep = function () {};
   b2TimeStep.prototype.Set = function (step) {
      this.dt = step.dt;
      this.inv_dt = step.inv_dt;
      this.positionIterations = step.positionIterations;
      this.velocityIterations = step.velocityIterations;
      this.warmStarting = step.warmStarting;
   }
   b2World.b2World = function () {
      this.s_stack = new Vector();
      this.m_contactManager = new b2ContactManager();
      this.m_contactSolver = new b2ContactSolver();
      this.m_island = new b2Island();
   };
   b2World.prototype.b2World = function (gravity, doSleep) {
      this.m_destructionListener = null;
      this.m_debugDraw = null;
      this.m_bodyList = null;
      this.m_contactList = null;
      this.m_jointList = null;
      this.m_controllerList = null;
      this.m_bodyCount = 0;
      this.m_contactCount = 0;
      this.m_jointCount = 0;
      this.m_controllerCount = 0;
      b2World.m_warmStarting = true;
      b2World.m_continuousPhysics = true;
      this.m_allowSleep = doSleep;
      this.m_gravity = gravity;
      this.m_inv_dt0 = 0.0;
      this.m_contactManager.m_world = this;
      var bd = new b2BodyDef();
      this.m_groundBody = this.CreateBody(bd);
   }
   b2World.prototype.SetDestructionListener = function (listener) {
      this.m_destructionListener = listener;
   }
   b2World.prototype.SetContactFilter = function (filter) {
      this.m_contactManager.m_contactFilter = filter;
   }
   b2World.prototype.SetContactListener = function (listener) {
      this.m_contactManager.m_contactListener = listener;
   }
   b2World.prototype.SetDebugDraw = function (debugDraw) {
      this.m_debugDraw = debugDraw;
   }
   b2World.prototype.SetBroadPhase = function (broadPhase) {
      var oldBroadPhase = this.m_contactManager.m_broadPhase;
      this.m_contactManager.m_broadPhase = broadPhase;
      for (var b = this.m_bodyList; b; b = b.m_next) {
         for (var f = b.m_fixtureList; f; f = f.m_next) {
            f.m_proxy = broadPhase.CreateProxy(oldBroadPhase.GetFatAABB(f.m_proxy), f);
         }
      }
   }
   b2World.prototype.Validate = function () {
      this.m_contactManager.m_broadPhase.Validate();
   }
   b2World.prototype.GetProxyCount = function () {
      return this.m_contactManager.m_broadPhase.GetProxyCount();
   }
   b2World.prototype.CreateBody = function (def) {
      if (this.IsLocked() == true) {
         return null;
      }
      var b = new b2Body(def, this);
      b.m_prev = null;
      b.m_next = this.m_bodyList;
      if (this.m_bodyList) {
         this.m_bodyList.m_prev = b;
      }
      this.m_bodyList = b;
      ++this.m_bodyCount;
      return b;
   }
   b2World.prototype.DestroyBody = function (b) {
      if (this.IsLocked() == true) {
         return;
      }
      var jn = b.m_jointList;
      while (jn) {
         var jn0 = jn;
         jn = jn.next;
         if (this.m_destructionListener) {
            this.m_destructionListener.SayGoodbyeJoint(jn0.joint);
         }
         this.DestroyJoint(jn0.joint);
      }
      var coe = b.m_controllerList;
      while (coe) {
         var coe0 = coe;
         coe = coe.nextController;
         coe0.controller.RemoveBody(b);
      }
      var ce = b.m_contactList;
      while (ce) {
         var ce0 = ce;
         ce = ce.next;
         this.m_contactManager.Destroy(ce0.contact);
      }
      b.m_contactList = null;
      var f = b.m_fixtureList;
      while (f) {
         var f0 = f;
         f = f.m_next;
         if (this.m_destructionListener) {
            this.m_destructionListener.SayGoodbyeFixture(f0);
         }
         f0.DestroyProxy(this.m_contactManager.m_broadPhase);
         f0.Destroy();
      }
      b.m_fixtureList = null;
      b.m_fixtureCount = 0;
      if (b.m_prev) {
         b.m_prev.m_next = b.m_next;
      }
      if (b.m_next) {
         b.m_next.m_prev = b.m_prev;
      }
      if (b == this.m_bodyList) {
         this.m_bodyList = b.m_next;
      }--this.m_bodyCount;
   }
   b2World.prototype.CreateJoint = function (def) {
      var j = b2Joint.Create(def, null);
      j.m_prev = null;
      j.m_next = this.m_jointList;
      if (this.m_jointList) {
         this.m_jointList.m_prev = j;
      }
      this.m_jointList = j;
      ++this.m_jointCount;
      j.m_edgeA.joint = j;
      j.m_edgeA.other = j.m_bodyB;
      j.m_edgeA.prev = null;
      j.m_edgeA.next = j.m_bodyA.m_jointList;
      if (j.m_bodyA.m_jointList) j.m_bodyA.m_jointList.prev = j.m_edgeA;
      j.m_bodyA.m_jointList = j.m_edgeA;
      j.m_edgeB.joint = j;
      j.m_edgeB.other = j.m_bodyA;
      j.m_edgeB.prev = null;
      j.m_edgeB.next = j.m_bodyB.m_jointList;
      if (j.m_bodyB.m_jointList) j.m_bodyB.m_jointList.prev = j.m_edgeB;
      j.m_bodyB.m_jointList = j.m_edgeB;
      var bodyA = def.bodyA;
      var bodyB = def.bodyB;
      if (def.collideConnected == false) {
         var edge = bodyB.GetContactList();
         while (edge) {
            if (edge.other == bodyA) {
               edge.contact.FlagForFiltering();
            }
            edge = edge.next;
         }
      }
      return j;
   }
   b2World.prototype.DestroyJoint = function (j) {
      var collideConnected = j.m_collideConnected;
      if (j.m_prev) {
         j.m_prev.m_next = j.m_next;
      }
      if (j.m_next) {
         j.m_next.m_prev = j.m_prev;
      }
      if (j == this.m_jointList) {
         this.m_jointList = j.m_next;
      }
      var bodyA = j.m_bodyA;
      var bodyB = j.m_bodyB;
      bodyA.SetAwake(true);
      bodyB.SetAwake(true);
      if (j.m_edgeA.prev) {
         j.m_edgeA.prev.next = j.m_edgeA.next;
      }
      if (j.m_edgeA.next) {
         j.m_edgeA.next.prev = j.m_edgeA.prev;
      }
      if (j.m_edgeA == bodyA.m_jointList) {
         bodyA.m_jointList = j.m_edgeA.next;
      }
      j.m_edgeA.prev = null;
      j.m_edgeA.next = null;
      if (j.m_edgeB.prev) {
         j.m_edgeB.prev.next = j.m_edgeB.next;
      }
      if (j.m_edgeB.next) {
         j.m_edgeB.next.prev = j.m_edgeB.prev;
      }
      if (j.m_edgeB == bodyB.m_jointList) {
         bodyB.m_jointList = j.m_edgeB.next;
      }
      j.m_edgeB.prev = null;
      j.m_edgeB.next = null;
      b2Joint.Destroy(j, null);
      --this.m_jointCount;
      if (collideConnected == false) {
         var edge = bodyB.GetContactList();
         while (edge) {
            if (edge.other == bodyA) {
               edge.contact.FlagForFiltering();
            }
            edge = edge.next;
         }
      }
   }
   b2World.prototype.AddController = function (c) {
      c.m_next = this.m_controllerList;
      c.m_prev = null;
      this.m_controllerList = c;
      c.m_world = this;
      this.m_controllerCount++;
      return c;
   }
   b2World.prototype.RemoveController = function (c) {
      if (c.m_prev) c.m_prev.m_next = c.m_next;
      if (c.m_next) c.m_next.m_prev = c.m_prev;
      if (this.m_controllerList == c) this.m_controllerList = c.m_next;
      this.m_controllerCount--;
   }
   b2World.prototype.CreateController = function (controller) {
      if (controller.m_world != this) throw new Error("Controller can only be a member of one world");
      controller.m_next = this.m_controllerList;
      controller.m_prev = null;
      if (this.m_controllerList) this.m_controllerList.m_prev = controller;
      this.m_controllerList = controller;
      ++this.m_controllerCount;
      controller.m_world = this;
      return controller;
   }
   b2World.prototype.DestroyController = function (controller) {
      controller.Clear();
      if (controller.m_next) controller.m_next.m_prev = controller.m_prev;
      if (controller.m_prev) controller.m_prev.m_next = controller.m_next;
      if (controller == this.m_controllerList) this.m_controllerList = controller.m_next;
      --this.m_controllerCount;
   }
   b2World.prototype.SetWarmStarting = function (flag) {
      b2World.m_warmStarting = flag;
   }
   b2World.prototype.SetContinuousPhysics = function (flag) {
      b2World.m_continuousPhysics = flag;
   }
   b2World.prototype.GetBodyCount = function () {
      return this.m_bodyCount;
   }
   b2World.prototype.GetJointCount = function () {
      return this.m_jointCount;
   }
   b2World.prototype.GetContactCount = function () {
      return this.m_contactCount;
   }
   b2World.prototype.SetGravity = function (gravity) {
      this.m_gravity = gravity;
   }
   b2World.prototype.GetGravity = function () {
      return this.m_gravity;
   }
   b2World.prototype.GetGroundBody = function () {
      return this.m_groundBody;
   }
   b2World.prototype.Step = function (dt, velocityIterations, positionIterations) {
      if (dt === undefined) dt = 0;
      if (velocityIterations === undefined) velocityIterations = 0;
      if (positionIterations === undefined) positionIterations = 0;
      if (this.m_flags & b2World.e_newFixture) {
         this.m_contactManager.FindNewContacts();
         this.m_flags &= ~b2World.e_newFixture;
      }
      this.m_flags |= b2World.e_locked;
      var step = b2World.s_timestep2;
      step.dt = dt;
      step.velocityIterations = velocityIterations;
      step.positionIterations = positionIterations;
      if (dt > 0.0) {
         step.inv_dt = 1.0 / dt;
      }
      else {
         step.inv_dt = 0.0;
      }
      step.dtRatio = this.m_inv_dt0 * dt;
      step.warmStarting = b2World.m_warmStarting;
      this.m_contactManager.Collide();
      if (step.dt > 0.0) {
         this.Solve(step);
      }
      if (b2World.m_continuousPhysics && step.dt > 0.0) {
         this.SolveTOI(step);
      }
      if (step.dt > 0.0) {
         this.m_inv_dt0 = step.inv_dt;
      }
      this.m_flags &= ~b2World.e_locked;
   }
   b2World.prototype.ClearForces = function () {
      for (var body = this.m_bodyList; body; body = body.m_next) {
         body.m_force.SetZero();
         body.m_torque = 0.0;
      }
   }
   b2World.prototype.DrawDebugData = function () {
      if (this.m_debugDraw == null) {
         return;
      }
      this.m_debugDraw.m_sprite.graphics.clear();
      var flags = this.m_debugDraw.GetFlags();
      var i = 0;
      var b;
      var f;
      var s;
      var j;
      var bp;
      var invQ = new b2Vec2;
      var x1 = new b2Vec2;
      var x2 = new b2Vec2;
      var xf;
      var b1 = new b2AABB();
      var b2 = new b2AABB();
      var vs = [new b2Vec2(), new b2Vec2(), new b2Vec2(), new b2Vec2()];
      var color = new b2Color(0, 0, 0);
      if (flags & b2DebugDraw.e_shapeBit) {
         for (b = this.m_bodyList;
         b; b = b.m_next) {
            xf = b.m_xf;
            for (f = b.GetFixtureList();
            f; f = f.m_next) {
               s = f.GetShape();
               if (b.IsActive() == false) {
                  color.Set(0.5, 0.5, 0.3);
                  this.DrawShape(s, xf, color);
               }
               else if (b.GetType() == b2Body.b2_staticBody) {
                  color.Set(0.5, 0.9, 0.5);
                  this.DrawShape(s, xf, color);
               }
               else if (b.GetType() == b2Body.b2_kinematicBody) {
                  color.Set(0.5, 0.5, 0.9);
                  this.DrawShape(s, xf, color);
               }
               else if (b.IsAwake() == false) {
                  color.Set(0.6, 0.6, 0.6);
                  this.DrawShape(s, xf, color);
               }
               else {
                  color.Set(0.9, 0.7, 0.7);
                  this.DrawShape(s, xf, color);
               }
            }
         }
      }
      if (flags & b2DebugDraw.e_jointBit) {
         for (j = this.m_jointList;
         j; j = j.m_next) {
            this.DrawJoint(j);
         }
      }
      if (flags & b2DebugDraw.e_controllerBit) {
         for (var c = this.m_controllerList; c; c = c.m_next) {
            c.Draw(this.m_debugDraw);
         }
      }
      if (flags & b2DebugDraw.e_pairBit) {
         color.Set(0.3, 0.9, 0.9);
         for (var contact = this.m_contactManager.m_contactList; contact; contact = contact.GetNext()) {
            var fixtureA = contact.GetFixtureA();
            var fixtureB = contact.GetFixtureB();
            var cA = fixtureA.GetAABB().GetCenter();
            var cB = fixtureB.GetAABB().GetCenter();
            this.m_debugDraw.DrawSegment(cA, cB, color);
         }
      }
      if (flags & b2DebugDraw.e_aabbBit) {
         bp = this.m_contactManager.m_broadPhase;
         vs = [new b2Vec2(), new b2Vec2(), new b2Vec2(), new b2Vec2()];
         for (b = this.m_bodyList;
         b; b = b.GetNext()) {
            if (b.IsActive() == false) {
               continue;
            }
            for (f = b.GetFixtureList();
            f; f = f.GetNext()) {
               var aabb = bp.GetFatAABB(f.m_proxy);
               vs[0].Set(aabb.lowerBound.x, aabb.lowerBound.y);
               vs[1].Set(aabb.upperBound.x, aabb.lowerBound.y);
               vs[2].Set(aabb.upperBound.x, aabb.upperBound.y);
               vs[3].Set(aabb.lowerBound.x, aabb.upperBound.y);
               this.m_debugDraw.DrawPolygon(vs, 4, color);
            }
         }
      }
      if (flags & b2DebugDraw.e_centerOfMassBit) {
         for (b = this.m_bodyList;
         b; b = b.m_next) {
            xf = b2World.s_xf;
            xf.R = b.m_xf.R;
            xf.position = b.GetWorldCenter();
            this.m_debugDraw.DrawTransform(xf);
         }
      }
   }
   b2World.prototype.QueryAABB = function (callback, aabb) {
      var __this = this;
      var broadPhase = __this.m_contactManager.m_broadPhase;

      function WorldQueryWrapper(proxy) {
         return callback(broadPhase.GetUserData(proxy));
      };
      broadPhase.Query(WorldQueryWrapper, aabb);
   }
   b2World.prototype.QueryShape = function (callback, shape, transform) {
      var __this = this;
      if (transform === undefined) transform = null;
      if (transform == null) {
         transform = new b2Transform();
         transform.SetIdentity();
      }
      var broadPhase = __this.m_contactManager.m_broadPhase;

      function WorldQueryWrapper(proxy) {
         var fixture = (broadPhase.GetUserData(proxy) instanceof b2Fixture ? broadPhase.GetUserData(proxy) : null);
         if (b2Shape.TestOverlap(shape, transform, fixture.GetShape(), fixture.GetBody().GetTransform())) return callback(fixture);
         return true;
      };
      var aabb = new b2AABB();
      shape.ComputeAABB(aabb, transform);
      broadPhase.Query(WorldQueryWrapper, aabb);
   }
   b2World.prototype.QueryPoint = function (callback, p) {
      var __this = this;
      var broadPhase = __this.m_contactManager.m_broadPhase;

      function WorldQueryWrapper(proxy) {
         var fixture = (broadPhase.GetUserData(proxy) instanceof b2Fixture ? broadPhase.GetUserData(proxy) : null);
         if (fixture.TestPoint(p)) return callback(fixture);
         return true;
      };
      var aabb = new b2AABB();
      aabb.lowerBound.Set(p.x - b2Settings.b2_linearSlop, p.y - b2Settings.b2_linearSlop);
      aabb.upperBound.Set(p.x + b2Settings.b2_linearSlop, p.y + b2Settings.b2_linearSlop);
      broadPhase.Query(WorldQueryWrapper, aabb);
   }
   b2World.prototype.RayCast = function (callback, point1, point2) {
      var __this = this;
      var broadPhase = __this.m_contactManager.m_broadPhase;
      var output = new b2RayCastOutput;

      function RayCastWrapper(input, proxy) {
         var userData = broadPhase.GetUserData(proxy);
         var fixture = (userData instanceof b2Fixture ? userData : null);
         var hit = fixture.RayCast(output, input);
         if (hit) {
            var fraction = output.fraction;
            var point = new b2Vec2((1.0 - fraction) * point1.x + fraction * point2.x, (1.0 - fraction) * point1.y + fraction * point2.y);
            return callback(fixture, point, output.normal, fraction);
         }
         return input.maxFraction;
      };
      var input = new b2RayCastInput(point1, point2);
      broadPhase.RayCast(RayCastWrapper, input);
   }
   b2World.prototype.RayCastOne = function (point1, point2) {
      var __this = this;
      var result;

      function RayCastOneWrapper(fixture, point, normal, fraction) {
         if (fraction === undefined) fraction = 0;
         result = fixture;
         return fraction;
      };
      __this.RayCast(RayCastOneWrapper, point1, point2);
      return result;
   }
   b2World.prototype.RayCastAll = function (point1, point2) {
      var __this = this;
      var result = new Vector();

      function RayCastAllWrapper(fixture, point, normal, fraction) {
         if (fraction === undefined) fraction = 0;
         result[result.length] = fixture;
         return 1;
      };
      __this.RayCast(RayCastAllWrapper, point1, point2);
      return result;
   }
   b2World.prototype.GetBodyList = function () {
      return this.m_bodyList;
   }
   b2World.prototype.GetJointList = function () {
      return this.m_jointList;
   }
   b2World.prototype.GetContactList = function () {
      return this.m_contactList;
   }
   b2World.prototype.IsLocked = function () {
      return (this.m_flags & b2World.e_locked) > 0;
   }
   b2World.prototype.Solve = function (step) {
      var b;
      for (var controller = this.m_controllerList; controller; controller = controller.m_next) {
         controller.Step(step);
      }
      var island = this.m_island;
      island.Initialize(this.m_bodyCount, this.m_contactCount, this.m_jointCount, null, this.m_contactManager.m_contactListener, this.m_contactSolver);
      for (b = this.m_bodyList;
      b; b = b.m_next) {
         b.m_flags &= ~b2Body.e_islandFlag;
      }
      for (var c = this.m_contactList; c; c = c.m_next) {
         c.m_flags &= ~b2Contact.e_islandFlag;
      }
      for (var j = this.m_jointList; j; j = j.m_next) {
         j.m_islandFlag = false;
      }
      var stackSize = parseInt(this.m_bodyCount);
      var stack = this.s_stack;
      for (var seed = this.m_bodyList; seed; seed = seed.m_next) {
         if (seed.m_flags & b2Body.e_islandFlag) {
            continue;
         }
         if (seed.IsAwake() == false || seed.IsActive() == false) {
            continue;
         }
         if (seed.GetType() == b2Body.b2_staticBody) {
            continue;
         }
         island.Clear();
         var stackCount = 0;
         stack[stackCount++] = seed;
         seed.m_flags |= b2Body.e_islandFlag;
         while (stackCount > 0) {
            b = stack[--stackCount];
            island.AddBody(b);
            if (b.IsAwake() == false) {
               b.SetAwake(true);
            }
            if (b.GetType() == b2Body.b2_staticBody) {
               continue;
            }
            var other;
            for (var ce = b.m_contactList; ce; ce = ce.next) {
               if (ce.contact.m_flags & b2Contact.e_islandFlag) {
                  continue;
               }
               if (ce.contact.IsSensor() == true || ce.contact.IsEnabled() == false || ce.contact.IsTouching() == false) {
                  continue;
               }
               island.AddContact(ce.contact);
               ce.contact.m_flags |= b2Contact.e_islandFlag;
               other = ce.other;
               if (other.m_flags & b2Body.e_islandFlag) {
                  continue;
               }
               stack[stackCount++] = other;
               other.m_flags |= b2Body.e_islandFlag;
            }
            for (var jn = b.m_jointList; jn; jn = jn.next) {
               if (jn.joint.m_islandFlag == true) {
                  continue;
               }
               other = jn.other;
               if (other.IsActive() == false) {
                  continue;
               }
               island.AddJoint(jn.joint);
               jn.joint.m_islandFlag = true;
               if (other.m_flags & b2Body.e_islandFlag) {
                  continue;
               }
               stack[stackCount++] = other;
               other.m_flags |= b2Body.e_islandFlag;
            }
         }
         island.Solve(step, this.m_gravity, this.m_allowSleep);
         for (var i = 0; i < island.m_bodyCount; ++i) {
            b = island.m_bodies[i];
            if (b.GetType() == b2Body.b2_staticBody) {
               b.m_flags &= ~b2Body.e_islandFlag;
            }
         }
      }
      for (i = 0;
      i < stack.length; ++i) {
         if (!stack[i]) break;
         stack[i] = null;
      }
      for (b = this.m_bodyList;
      b; b = b.m_next) {
         if (b.IsAwake() == false || b.IsActive() == false) {
            continue;
         }
         if (b.GetType() == b2Body.b2_staticBody) {
            continue;
         }
         b.SynchronizeFixtures();
      }
      this.m_contactManager.FindNewContacts();
   }
   b2World.prototype.SolveTOI = function (step) {
      var b;
      var fA;
      var fB;
      var bA;
      var bB;
      var cEdge;
      var j;
      var island = this.m_island;
      island.Initialize(this.m_bodyCount, b2Settings.b2_maxTOIContactsPerIsland, b2Settings.b2_maxTOIJointsPerIsland, null, this.m_contactManager.m_contactListener, this.m_contactSolver);
      var queue = b2World.s_queue;
      for (b = this.m_bodyList;
      b; b = b.m_next) {
         b.m_flags &= ~b2Body.e_islandFlag;
         b.m_sweep.t0 = 0.0;
      }
      var c;
      for (c = this.m_contactList;
      c; c = c.m_next) {
         c.m_flags &= ~ (b2Contact.e_toiFlag | b2Contact.e_islandFlag);
      }
      for (j = this.m_jointList;
      j; j = j.m_next) {
         j.m_islandFlag = false;
      }
      for (;;) {
         var minContact = null;
         var minTOI = 1.0;
         for (c = this.m_contactList;
         c; c = c.m_next) {
            if (c.IsSensor() == true || c.IsEnabled() == false || c.IsContinuous() == false) {
               continue;
            }
            var toi = 1.0;
            if (c.m_flags & b2Contact.e_toiFlag) {
               toi = c.m_toi;
            }
            else {
               fA = c.m_fixtureA;
               fB = c.m_fixtureB;
               bA = fA.m_body;
               bB = fB.m_body;
               if ((bA.GetType() != b2Body.b2_dynamicBody || bA.IsAwake() == false) && (bB.GetType() != b2Body.b2_dynamicBody || bB.IsAwake() == false)) {
                  continue;
               }
               var t0 = bA.m_sweep.t0;
               if (bA.m_sweep.t0 < bB.m_sweep.t0) {
                  t0 = bB.m_sweep.t0;
                  bA.m_sweep.Advance(t0);
               }
               else if (bB.m_sweep.t0 < bA.m_sweep.t0) {
                  t0 = bA.m_sweep.t0;
                  bB.m_sweep.Advance(t0);
               }
               toi = c.ComputeTOI(bA.m_sweep, bB.m_sweep);
               b2Settings.b2Assert(0.0 <= toi && toi <= 1.0);
               if (toi > 0.0 && toi < 1.0) {
                  toi = (1.0 - toi) * t0 + toi;
                  if (toi > 1) toi = 1;
               }
               c.m_toi = toi;
               c.m_flags |= b2Contact.e_toiFlag;
            }
            if (Number.MIN_VALUE < toi && toi < minTOI) {
               minContact = c;
               minTOI = toi;
            }
         }
         if (minContact == null || 1.0 - 100.0 * Number.MIN_VALUE < minTOI) {
            break;
         }
         fA = minContact.m_fixtureA;
         fB = minContact.m_fixtureB;
         bA = fA.m_body;
         bB = fB.m_body;
         b2World.s_backupA.Set(bA.m_sweep);
         b2World.s_backupB.Set(bB.m_sweep);
         bA.Advance(minTOI);
         bB.Advance(minTOI);
         minContact.Update(this.m_contactManager.m_contactListener);
         minContact.m_flags &= ~b2Contact.e_toiFlag;
         if (minContact.IsSensor() == true || minContact.IsEnabled() == false) {
            bA.m_sweep.Set(b2World.s_backupA);
            bB.m_sweep.Set(b2World.s_backupB);
            bA.SynchronizeTransform();
            bB.SynchronizeTransform();
            continue;
         }
         if (minContact.IsTouching() == false) {
            continue;
         }
         var seed = bA;
         if (seed.GetType() != b2Body.b2_dynamicBody) {
            seed = bB;
         }
         island.Clear();
         var queueStart = 0;
         var queueSize = 0;
         queue[queueStart + queueSize++] = seed;
         seed.m_flags |= b2Body.e_islandFlag;
         while (queueSize > 0) {
            b = queue[queueStart++];
            --queueSize;
            island.AddBody(b);
            if (b.IsAwake() == false) {
               b.SetAwake(true);
            }
            if (b.GetType() != b2Body.b2_dynamicBody) {
               continue;
            }
            for (cEdge = b.m_contactList;
            cEdge; cEdge = cEdge.next) {
               if (island.m_contactCount == island.m_contactCapacity) {
                  break;
               }
               if (cEdge.contact.m_flags & b2Contact.e_islandFlag) {
                  continue;
               }
               if (cEdge.contact.IsSensor() == true || cEdge.contact.IsEnabled() == false || cEdge.contact.IsTouching() == false) {
                  continue;
               }
               island.AddContact(cEdge.contact);
               cEdge.contact.m_flags |= b2Contact.e_islandFlag;
               var other = cEdge.other;
               if (other.m_flags & b2Body.e_islandFlag) {
                  continue;
               }
               if (other.GetType() != b2Body.b2_staticBody) {
                  other.Advance(minTOI);
                  other.SetAwake(true);
               }
               queue[queueStart + queueSize] = other;
               ++queueSize;
               other.m_flags |= b2Body.e_islandFlag;
            }
            for (var jEdge = b.m_jointList; jEdge; jEdge = jEdge.next) {
               if (island.m_jointCount == island.m_jointCapacity) continue;
               if (jEdge.joint.m_islandFlag == true) continue;
               other = jEdge.other;
               if (other.IsActive() == false) {
                  continue;
               }
               island.AddJoint(jEdge.joint);
               jEdge.joint.m_islandFlag = true;
               if (other.m_flags & b2Body.e_islandFlag) continue;
               if (other.GetType() != b2Body.b2_staticBody) {
                  other.Advance(minTOI);
                  other.SetAwake(true);
               }
               queue[queueStart + queueSize] = other;
               ++queueSize;
               other.m_flags |= b2Body.e_islandFlag;
            }
         }
         var subStep = b2World.s_timestep;
         subStep.warmStarting = false;
         subStep.dt = (1.0 - minTOI) * step.dt;
         subStep.inv_dt = 1.0 / subStep.dt;
         subStep.dtRatio = 0.0;
         subStep.velocityIterations = step.velocityIterations;
         subStep.positionIterations = step.positionIterations;
         island.SolveTOI(subStep);
         var i = 0;
         for (i = 0;
         i < island.m_bodyCount; ++i) {
            b = island.m_bodies[i];
            b.m_flags &= ~b2Body.e_islandFlag;
            if (b.IsAwake() == false) {
               continue;
            }
            if (b.GetType() != b2Body.b2_dynamicBody) {
               continue;
            }
            b.SynchronizeFixtures();
            for (cEdge = b.m_contactList;
            cEdge; cEdge = cEdge.next) {
               cEdge.contact.m_flags &= ~b2Contact.e_toiFlag;
            }
         }
         for (i = 0;
         i < island.m_contactCount; ++i) {
            c = island.m_contacts[i];
            c.m_flags &= ~ (b2Contact.e_toiFlag | b2Contact.e_islandFlag);
         }
         for (i = 0;
         i < island.m_jointCount; ++i) {
            j = island.m_joints[i];
            j.m_islandFlag = false;
         }
         this.m_contactManager.FindNewContacts();
      }
   }
   b2World.prototype.DrawJoint = function (joint) {
      var b1 = joint.GetBodyA();
      var b2 = joint.GetBodyB();
      var xf1 = b1.m_xf;
      var xf2 = b2.m_xf;
      var x1 = xf1.position;
      var x2 = xf2.position;
      var p1 = joint.GetAnchorA();
      var p2 = joint.GetAnchorB();
      var color = b2World.s_jointColor;
      switch (joint.m_type) {
      case b2Joint.e_distanceJoint:
         this.m_debugDraw.DrawSegment(p1, p2, color);
         break;
      case b2Joint.e_pulleyJoint:
         {
            var pulley = ((joint instanceof b2PulleyJoint ? joint : null));
            var s1 = pulley.GetGroundAnchorA();
            var s2 = pulley.GetGroundAnchorB();
            this.m_debugDraw.DrawSegment(s1, p1, color);
            this.m_debugDraw.DrawSegment(s2, p2, color);
            this.m_debugDraw.DrawSegment(s1, s2, color);
         }
         break;
      case b2Joint.e_mouseJoint:
         this.m_debugDraw.DrawSegment(p1, p2, color);
         break;
      default:
         if (b1 != this.m_groundBody) this.m_debugDraw.DrawSegment(x1, p1, color);
         this.m_debugDraw.DrawSegment(p1, p2, color);
         if (b2 != this.m_groundBody) this.m_debugDraw.DrawSegment(x2, p2, color);
      }
   }
   b2World.prototype.DrawShape = function (shape, xf, color) {
      switch (shape.m_type) {
      case b2Shape.e_circleShape:
         {
            var circle = ((shape instanceof b2CircleShape ? shape : null));
            var center = b2Math.MulX(xf, circle.m_p);
            var radius = circle.m_radius;
            var axis = xf.R.col1;
            this.m_debugDraw.DrawSolidCircle(center, radius, axis, color);
         }
         break;
      case b2Shape.e_polygonShape:
         {
            var i = 0;
            var poly = ((shape instanceof b2PolygonShape ? shape : null));
            var vertexCount = parseInt(poly.GetVertexCount());
            var localVertices = poly.GetVertices();
            var vertices = new Vector(vertexCount);
            for (i = 0;
            i < vertexCount; ++i) {
               vertices[i] = b2Math.MulX(xf, localVertices[i]);
            }
            this.m_debugDraw.DrawSolidPolygon(vertices, vertexCount, color);
         }
         break;
      case b2Shape.e_edgeShape:
         {
            var edge = (shape instanceof b2EdgeShape ? shape : null);
            this.m_debugDraw.DrawSegment(b2Math.MulX(xf, edge.GetVertex1()), b2Math.MulX(xf, edge.GetVertex2()), color);
         }
         break;
      }
   }
   Box2D.postDefs.push(function () {
      Box2D.Dynamics.b2World.s_timestep2 = new b2TimeStep();
      Box2D.Dynamics.b2World.s_xf = new b2Transform();
      Box2D.Dynamics.b2World.s_backupA = new b2Sweep();
      Box2D.Dynamics.b2World.s_backupB = new b2Sweep();
      Box2D.Dynamics.b2World.s_timestep = new b2TimeStep();
      Box2D.Dynamics.b2World.s_queue = new Vector();
      Box2D.Dynamics.b2World.s_jointColor = new b2Color(0.5, 0.8, 0.8);
      Box2D.Dynamics.b2World.e_newFixture = 0x0001;
      Box2D.Dynamics.b2World.e_locked = 0x0002;
   });
})();
(function () {
   var b2CircleShape = Box2D.Collision.Shapes.b2CircleShape,
      b2EdgeChainDef = Box2D.Collision.Shapes.b2EdgeChainDef,
      b2EdgeShape = Box2D.Collision.Shapes.b2EdgeShape,
      b2MassData = Box2D.Collision.Shapes.b2MassData,
      b2PolygonShape = Box2D.Collision.Shapes.b2PolygonShape,
      b2Shape = Box2D.Collision.Shapes.b2Shape,
      b2CircleContact = Box2D.Dynamics.Contacts.b2CircleContact,
      b2Contact = Box2D.Dynamics.Contacts.b2Contact,
      b2ContactConstraint = Box2D.Dynamics.Contacts.b2ContactConstraint,
      b2ContactConstraintPoint = Box2D.Dynamics.Contacts.b2ContactConstraintPoint,
      b2ContactEdge = Box2D.Dynamics.Contacts.b2ContactEdge,
      b2ContactFactory = Box2D.Dynamics.Contacts.b2ContactFactory,
      b2ContactRegister = Box2D.Dynamics.Contacts.b2ContactRegister,
      b2ContactResult = Box2D.Dynamics.Contacts.b2ContactResult,
      b2ContactSolver = Box2D.Dynamics.Contacts.b2ContactSolver,
      b2EdgeAndCircleContact = Box2D.Dynamics.Contacts.b2EdgeAndCircleContact,
      b2NullContact = Box2D.Dynamics.Contacts.b2NullContact,
      b2PolyAndCircleContact = Box2D.Dynamics.Contacts.b2PolyAndCircleContact,
      b2PolyAndEdgeContact = Box2D.Dynamics.Contacts.b2PolyAndEdgeContact,
      b2PolygonContact = Box2D.Dynamics.Contacts.b2PolygonContact,
      b2PositionSolverManifold = Box2D.Dynamics.Contacts.b2PositionSolverManifold,
      b2Body = Box2D.Dynamics.b2Body,
      b2BodyDef = Box2D.Dynamics.b2BodyDef,
      b2ContactFilter = Box2D.Dynamics.b2ContactFilter,
      b2ContactImpulse = Box2D.Dynamics.b2ContactImpulse,
      b2ContactListener = Box2D.Dynamics.b2ContactListener,
      b2ContactManager = Box2D.Dynamics.b2ContactManager,
      b2DebugDraw = Box2D.Dynamics.b2DebugDraw,
      b2DestructionListener = Box2D.Dynamics.b2DestructionListener,
      b2FilterData = Box2D.Dynamics.b2FilterData,
      b2Fixture = Box2D.Dynamics.b2Fixture,
      b2FixtureDef = Box2D.Dynamics.b2FixtureDef,
      b2Island = Box2D.Dynamics.b2Island,
      b2TimeStep = Box2D.Dynamics.b2TimeStep,
      b2World = Box2D.Dynamics.b2World,
      b2Color = Box2D.Common.b2Color,
      b2internal = Box2D.Common.b2internal,
      b2Settings = Box2D.Common.b2Settings,
      b2Mat22 = Box2D.Common.Math.b2Mat22,
      b2Mat33 = Box2D.Common.Math.b2Mat33,
      b2Math = Box2D.Common.Math.b2Math,
      b2Sweep = Box2D.Common.Math.b2Sweep,
      b2Transform = Box2D.Common.Math.b2Transform,
      b2Vec2 = Box2D.Common.Math.b2Vec2,
      b2Vec3 = Box2D.Common.Math.b2Vec3,
      b2AABB = Box2D.Collision.b2AABB,
      b2Bound = Box2D.Collision.b2Bound,
      b2BoundValues = Box2D.Collision.b2BoundValues,
      b2Collision = Box2D.Collision.b2Collision,
      b2ContactID = Box2D.Collision.b2ContactID,
      b2ContactPoint = Box2D.Collision.b2ContactPoint,
      b2Distance = Box2D.Collision.b2Distance,
      b2DistanceInput = Box2D.Collision.b2DistanceInput,
      b2DistanceOutput = Box2D.Collision.b2DistanceOutput,
      b2DistanceProxy = Box2D.Collision.b2DistanceProxy,
      b2DynamicTree = Box2D.Collision.b2DynamicTree,
      b2DynamicTreeBroadPhase = Box2D.Collision.b2DynamicTreeBroadPhase,
      b2DynamicTreeNode = Box2D.Collision.b2DynamicTreeNode,
      b2DynamicTreePair = Box2D.Collision.b2DynamicTreePair,
      b2Manifold = Box2D.Collision.b2Manifold,
      b2ManifoldPoint = Box2D.Collision.b2ManifoldPoint,
      b2Point = Box2D.Collision.b2Point,
      b2RayCastInput = Box2D.Collision.b2RayCastInput,
      b2RayCastOutput = Box2D.Collision.b2RayCastOutput,
      b2Segment = Box2D.Collision.b2Segment,
      b2SeparationFunction = Box2D.Collision.b2SeparationFunction,
      b2Simplex = Box2D.Collision.b2Simplex,
      b2SimplexCache = Box2D.Collision.b2SimplexCache,
      b2SimplexVertex = Box2D.Collision.b2SimplexVertex,
      b2TimeOfImpact = Box2D.Collision.b2TimeOfImpact,
      b2TOIInput = Box2D.Collision.b2TOIInput,
      b2WorldManifold = Box2D.Collision.b2WorldManifold,
      ClipVertex = Box2D.Collision.ClipVertex,
      Features = Box2D.Collision.Features,
      IBroadPhase = Box2D.Collision.IBroadPhase;

   Box2D.inherit(b2CircleContact, Box2D.Dynamics.Contacts.b2Contact);
   b2CircleContact.prototype.__super = Box2D.Dynamics.Contacts.b2Contact.prototype;
   b2CircleContact.b2CircleContact = function () {
      Box2D.Dynamics.Contacts.b2Contact.b2Contact.apply(this, arguments);
   };
   b2CircleContact.Create = function (allocator) {
      return new b2CircleContact();
   }
   b2CircleContact.Destroy = function (contact, allocator) {}
   b2CircleContact.prototype.Reset = function (fixtureA, fixtureB) {
      this.__super.Reset.call(this, fixtureA, fixtureB);
   }
   b2CircleContact.prototype.Evaluate = function () {
      var bA = this.m_fixtureA.GetBody();
      var bB = this.m_fixtureB.GetBody();
      b2Collision.CollideCircles(this.m_manifold, (this.m_fixtureA.GetShape() instanceof b2CircleShape ? this.m_fixtureA.GetShape() : null), bA.m_xf, (this.m_fixtureB.GetShape() instanceof b2CircleShape ? this.m_fixtureB.GetShape() : null), bB.m_xf);
   }
   b2Contact.b2Contact = function () {
      this.m_nodeA = new b2ContactEdge();
      this.m_nodeB = new b2ContactEdge();
      this.m_manifold = new b2Manifold();
      this.m_oldManifold = new b2Manifold();
   };
   b2Contact.prototype.GetManifold = function () {
      return this.m_manifold;
   }
   b2Contact.prototype.GetWorldManifold = function (worldManifold) {
      var bodyA = this.m_fixtureA.GetBody();
      var bodyB = this.m_fixtureB.GetBody();
      var shapeA = this.m_fixtureA.GetShape();
      var shapeB = this.m_fixtureB.GetShape();
      worldManifold.Initialize(this.m_manifold, bodyA.GetTransform(), shapeA.m_radius, bodyB.GetTransform(), shapeB.m_radius);
   }
   b2Contact.prototype.IsTouching = function () {
      return (this.m_flags & b2Contact.e_touchingFlag) == b2Contact.e_touchingFlag;
   }
   b2Contact.prototype.IsContinuous = function () {
      return (this.m_flags & b2Contact.e_continuousFlag) == b2Contact.e_continuousFlag;
   }
   b2Contact.prototype.SetSensor = function (sensor) {
      if (sensor) {
         this.m_flags |= b2Contact.e_sensorFlag;
      }
      else {
         this.m_flags &= ~b2Contact.e_sensorFlag;
      }
   }
   b2Contact.prototype.IsSensor = function () {
      return (this.m_flags & b2Contact.e_sensorFlag) == b2Contact.e_sensorFlag;
   }
   b2Contact.prototype.SetEnabled = function (flag) {
      if (flag) {
         this.m_flags |= b2Contact.e_enabledFlag;
      }
      else {
         this.m_flags &= ~b2Contact.e_enabledFlag;
      }
   }
   b2Contact.prototype.IsEnabled = function () {
      return (this.m_flags & b2Contact.e_enabledFlag) == b2Contact.e_enabledFlag;
   }
   b2Contact.prototype.GetNext = function () {
      return this.m_next;
   }
   b2Contact.prototype.GetFixtureA = function () {
      return this.m_fixtureA;
   }
   b2Contact.prototype.GetFixtureB = function () {
      return this.m_fixtureB;
   }
   b2Contact.prototype.FlagForFiltering = function () {
      this.m_flags |= b2Contact.e_filterFlag;
   }
   b2Contact.prototype.b2Contact = function () {}
   b2Contact.prototype.Reset = function (fixtureA, fixtureB) {
      if (fixtureA === undefined) fixtureA = null;
      if (fixtureB === undefined) fixtureB = null;
      this.m_flags = b2Contact.e_enabledFlag;
      if (!fixtureA || !fixtureB) {
         this.m_fixtureA = null;
         this.m_fixtureB = null;
         return;
      }
      if (fixtureA.IsSensor() || fixtureB.IsSensor()) {
         this.m_flags |= b2Contact.e_sensorFlag;
      }
      var bodyA = fixtureA.GetBody();
      var bodyB = fixtureB.GetBody();
      if (bodyA.GetType() != b2Body.b2_dynamicBody || bodyA.IsBullet() || bodyB.GetType() != b2Body.b2_dynamicBody || bodyB.IsBullet()) {
         this.m_flags |= b2Contact.e_continuousFlag;
      }
      this.m_fixtureA = fixtureA;
      this.m_fixtureB = fixtureB;
      this.m_manifold.m_pointCount = 0;
      this.m_prev = null;
      this.m_next = null;
      this.m_nodeA.contact = null;
      this.m_nodeA.prev = null;
      this.m_nodeA.next = null;
      this.m_nodeA.other = null;
      this.m_nodeB.contact = null;
      this.m_nodeB.prev = null;
      this.m_nodeB.next = null;
      this.m_nodeB.other = null;
   }
   b2Contact.prototype.Update = function (listener) {
      var tManifold = this.m_oldManifold;
      this.m_oldManifold = this.m_manifold;
      this.m_manifold = tManifold;
      this.m_flags |= b2Contact.e_enabledFlag;
      var touching = false;
      var wasTouching = (this.m_flags & b2Contact.e_touchingFlag) == b2Contact.e_touchingFlag;
      var bodyA = this.m_fixtureA.m_body;
      var bodyB = this.m_fixtureB.m_body;
      var aabbOverlap = this.m_fixtureA.m_aabb.TestOverlap(this.m_fixtureB.m_aabb);
      if (this.m_flags & b2Contact.e_sensorFlag) {
         if (aabbOverlap) {
            var shapeA = this.m_fixtureA.GetShape();
            var shapeB = this.m_fixtureB.GetShape();
            var xfA = bodyA.GetTransform();
            var xfB = bodyB.GetTransform();
            touching = b2Shape.TestOverlap(shapeA, xfA, shapeB, xfB);
         }
         this.m_manifold.m_pointCount = 0;
      }
      else {
         if (bodyA.GetType() != b2Body.b2_dynamicBody || bodyA.IsBullet() || bodyB.GetType() != b2Body.b2_dynamicBody || bodyB.IsBullet()) {
            this.m_flags |= b2Contact.e_continuousFlag;
         }
         else {
            this.m_flags &= ~b2Contact.e_continuousFlag;
         }
         if (aabbOverlap) {
            this.Evaluate();
            touching = this.m_manifold.m_pointCount > 0;
            for (var i = 0; i < this.m_manifold.m_pointCount; ++i) {
               var mp2 = this.m_manifold.m_points[i];
               mp2.m_normalImpulse = 0.0;
               mp2.m_tangentImpulse = 0.0;
               var id2 = mp2.m_id;
               for (var j = 0; j < this.m_oldManifold.m_pointCount; ++j) {
                  var mp1 = this.m_oldManifold.m_points[j];
                  if (mp1.m_id.key == id2.key) {
                     mp2.m_normalImpulse = mp1.m_normalImpulse;
                     mp2.m_tangentImpulse = mp1.m_tangentImpulse;
                     break;
                  }
               }
            }
         }
         else {
            this.m_manifold.m_pointCount = 0;
         }
         if (touching != wasTouching) {
            bodyA.SetAwake(true);
            bodyB.SetAwake(true);
         }
      }
      if (touching) {
         this.m_flags |= b2Contact.e_touchingFlag;
      }
      else {
         this.m_flags &= ~b2Contact.e_touchingFlag;
      }
      if (wasTouching == false && touching == true) {
         listener.BeginContact(this);
      }
      if (wasTouching == true && touching == false) {
         listener.EndContact(this);
      }
      if ((this.m_flags & b2Contact.e_sensorFlag) == 0) {
         listener.PreSolve(this, this.m_oldManifold);
      }
   }
   b2Contact.prototype.Evaluate = function () {}
   b2Contact.prototype.ComputeTOI = function (sweepA, sweepB) {
      b2Contact.s_input.proxyA.Set(this.m_fixtureA.GetShape());
      b2Contact.s_input.proxyB.Set(this.m_fixtureB.GetShape());
      b2Contact.s_input.sweepA = sweepA;
      b2Contact.s_input.sweepB = sweepB;
      b2Contact.s_input.tolerance = b2Settings.b2_linearSlop;
      return b2TimeOfImpact.TimeOfImpact(b2Contact.s_input);
   }
   Box2D.postDefs.push(function () {
      Box2D.Dynamics.Contacts.b2Contact.e_sensorFlag = 0x0001;
      Box2D.Dynamics.Contacts.b2Contact.e_continuousFlag = 0x0002;
      Box2D.Dynamics.Contacts.b2Contact.e_islandFlag = 0x0004;
      Box2D.Dynamics.Contacts.b2Contact.e_toiFlag = 0x0008;
      Box2D.Dynamics.Contacts.b2Contact.e_touchingFlag = 0x0010;
      Box2D.Dynamics.Contacts.b2Contact.e_enabledFlag = 0x0020;
      Box2D.Dynamics.Contacts.b2Contact.e_filterFlag = 0x0040;
      Box2D.Dynamics.Contacts.b2Contact.s_input = new b2TOIInput();
   });
   b2ContactConstraint.b2ContactConstraint = function () {
      this.localPlaneNormal = new b2Vec2();
      this.localPoint = new b2Vec2();
      this.normal = new b2Vec2();
      this.normalMass = new b2Mat22();
      this.K = new b2Mat22();
   };
   b2ContactConstraint.prototype.b2ContactConstraint = function () {
      this.points = new Vector(b2Settings.b2_maxManifoldPoints);
      for (var i = 0; i < b2Settings.b2_maxManifoldPoints; i++) {
         this.points[i] = new b2ContactConstraintPoint();
      }
   }
   b2ContactConstraintPoint.b2ContactConstraintPoint = function () {
      this.localPoint = new b2Vec2();
      this.rA = new b2Vec2();
      this.rB = new b2Vec2();
   };
   b2ContactEdge.b2ContactEdge = function () {};
   b2ContactFactory.b2ContactFactory = function () {};
   b2ContactFactory.prototype.b2ContactFactory = function (allocator) {
      this.m_allocator = allocator;
      this.InitializeRegisters();
   }
   b2ContactFactory.prototype.AddType = function (createFcn, destroyFcn, type1, type2) {
      if (type1 === undefined) type1 = 0;
      if (type2 === undefined) type2 = 0;
      this.m_registers[type1][type2].createFcn = createFcn;
      this.m_registers[type1][type2].destroyFcn = destroyFcn;
      this.m_registers[type1][type2].primary = true;
      if (type1 != type2) {
         this.m_registers[type2][type1].createFcn = createFcn;
         this.m_registers[type2][type1].destroyFcn = destroyFcn;
         this.m_registers[type2][type1].primary = false;
      }
   }
   b2ContactFactory.prototype.InitializeRegisters = function () {
      this.m_registers = new Vector(b2Shape.e_shapeTypeCount);
      for (var i = 0; i < b2Shape.e_shapeTypeCount; i++) {
         this.m_registers[i] = new Vector(b2Shape.e_shapeTypeCount);
         for (var j = 0; j < b2Shape.e_shapeTypeCount; j++) {
            this.m_registers[i][j] = new b2ContactRegister();
         }
      }
      this.AddType(b2CircleContact.Create, b2CircleContact.Destroy, b2Shape.e_circleShape, b2Shape.e_circleShape);
      this.AddType(b2PolyAndCircleContact.Create, b2PolyAndCircleContact.Destroy, b2Shape.e_polygonShape, b2Shape.e_circleShape);
      this.AddType(b2PolygonContact.Create, b2PolygonContact.Destroy, b2Shape.e_polygonShape, b2Shape.e_polygonShape);
      this.AddType(b2EdgeAndCircleContact.Create, b2EdgeAndCircleContact.Destroy, b2Shape.e_edgeShape, b2Shape.e_circleShape);
      this.AddType(b2PolyAndEdgeContact.Create, b2PolyAndEdgeContact.Destroy, b2Shape.e_polygonShape, b2Shape.e_edgeShape);
   }
   b2ContactFactory.prototype.Create = function (fixtureA, fixtureB) {
      var type1 = parseInt(fixtureA.GetType());
      var type2 = parseInt(fixtureB.GetType());
      var reg = this.m_registers[type1][type2];
      var c;
      if (reg.pool) {
         c = reg.pool;
         reg.pool = c.m_next;
         reg.poolCount--;
         c.Reset(fixtureA, fixtureB);
         return c;
      }
      var createFcn = reg.createFcn;
      if (createFcn != null) {
         if (reg.primary) {
            c = createFcn(this.m_allocator);
            c.Reset(fixtureA, fixtureB);
            return c;
         }
         else {
            c = createFcn(this.m_allocator);
            c.Reset(fixtureB, fixtureA);
            return c;
         }
      }
      else {
         return null;
      }
   }
   b2ContactFactory.prototype.Destroy = function (contact) {
      if (contact.m_manifold.m_pointCount > 0) {
         contact.m_fixtureA.m_body.SetAwake(true);
         contact.m_fixtureB.m_body.SetAwake(true);
      }
      var type1 = parseInt(contact.m_fixtureA.GetType());
      var type2 = parseInt(contact.m_fixtureB.GetType());
      var reg = this.m_registers[type1][type2];
      if (true) {
         reg.poolCount++;
         contact.m_next = reg.pool;
         reg.pool = contact;
      }
      var destroyFcn = reg.destroyFcn;
      destroyFcn(contact, this.m_allocator);
   }
   b2ContactRegister.b2ContactRegister = function () {};
   b2ContactResult.b2ContactResult = function () {
      this.position = new b2Vec2();
      this.normal = new b2Vec2();
      this.id = new b2ContactID();
   };
   b2ContactSolver.b2ContactSolver = function () {
      this.m_step = new b2TimeStep();
      this.m_constraints = new Vector();
   };
   b2ContactSolver.prototype.b2ContactSolver = function () {}
   b2ContactSolver.prototype.Initialize = function (step, contacts, contactCount, allocator) {
      if (contactCount === undefined) contactCount = 0;
      var contact;
      this.m_step.Set(step);
      this.m_allocator = allocator;
      var i = 0;
      var tVec;
      var tMat;
      this.m_constraintCount = contactCount;
      while (this.m_constraints.length < this.m_constraintCount) {
         this.m_constraints[this.m_constraints.length] = new b2ContactConstraint();
      }
      for (i = 0;
      i < contactCount; ++i) {
         contact = contacts[i];
         var fixtureA = contact.m_fixtureA;
         var fixtureB = contact.m_fixtureB;
         var shapeA = fixtureA.m_shape;
         var shapeB = fixtureB.m_shape;
         var radiusA = shapeA.m_radius;
         var radiusB = shapeB.m_radius;
         var bodyA = fixtureA.m_body;
         var bodyB = fixtureB.m_body;
         var manifold = contact.GetManifold();
         var friction = b2Settings.b2MixFriction(fixtureA.GetFriction(), fixtureB.GetFriction());
         var restitution = b2Settings.b2MixRestitution(fixtureA.GetRestitution(), fixtureB.GetRestitution());
         var vAX = bodyA.m_linearVelocity.x;
         var vAY = bodyA.m_linearVelocity.y;
         var vBX = bodyB.m_linearVelocity.x;
         var vBY = bodyB.m_linearVelocity.y;
         var wA = bodyA.m_angularVelocity;
         var wB = bodyB.m_angularVelocity;
         b2Settings.b2Assert(manifold.m_pointCount > 0);
         b2ContactSolver.s_worldManifold.Initialize(manifold, bodyA.m_xf, radiusA, bodyB.m_xf, radiusB);
         var normalX = b2ContactSolver.s_worldManifold.m_normal.x;
         var normalY = b2ContactSolver.s_worldManifold.m_normal.y;
         var cc = this.m_constraints[i];
         cc.bodyA = bodyA;
         cc.bodyB = bodyB;
         cc.manifold = manifold;
         cc.normal.x = normalX;
         cc.normal.y = normalY;
         cc.pointCount = manifold.m_pointCount;
         cc.friction = friction;
         cc.restitution = restitution;
         cc.localPlaneNormal.x = manifold.m_localPlaneNormal.x;
         cc.localPlaneNormal.y = manifold.m_localPlaneNormal.y;
         cc.localPoint.x = manifold.m_localPoint.x;
         cc.localPoint.y = manifold.m_localPoint.y;
         cc.radius = radiusA + radiusB;
         cc.type = manifold.m_type;
         for (var k = 0; k < cc.pointCount; ++k) {
            var cp = manifold.m_points[k];
            var ccp = cc.points[k];
            ccp.normalImpulse = cp.m_normalImpulse;
            ccp.tangentImpulse = cp.m_tangentImpulse;
            ccp.localPoint.SetV(cp.m_localPoint);
            var rAX = ccp.rA.x = b2ContactSolver.s_worldManifold.m_points[k].x - bodyA.m_sweep.c.x;
            var rAY = ccp.rA.y = b2ContactSolver.s_worldManifold.m_points[k].y - bodyA.m_sweep.c.y;
            var rBX = ccp.rB.x = b2ContactSolver.s_worldManifold.m_points[k].x - bodyB.m_sweep.c.x;
            var rBY = ccp.rB.y = b2ContactSolver.s_worldManifold.m_points[k].y - bodyB.m_sweep.c.y;
            var rnA = rAX * normalY - rAY * normalX;
            var rnB = rBX * normalY - rBY * normalX;
            rnA *= rnA;
            rnB *= rnB;
            var kNormal = bodyA.m_invMass + bodyB.m_invMass + bodyA.m_invI * rnA + bodyB.m_invI * rnB;
            ccp.normalMass = 1.0 / kNormal;
            var kEqualized = bodyA.m_mass * bodyA.m_invMass + bodyB.m_mass * bodyB.m_invMass;
            kEqualized += bodyA.m_mass * bodyA.m_invI * rnA + bodyB.m_mass * bodyB.m_invI * rnB;
            ccp.equalizedMass = 1.0 / kEqualized;
            var tangentX = normalY;
            var tangentY = (-normalX);
            var rtA = rAX * tangentY - rAY * tangentX;
            var rtB = rBX * tangentY - rBY * tangentX;
            rtA *= rtA;
            rtB *= rtB;
            var kTangent = bodyA.m_invMass + bodyB.m_invMass + bodyA.m_invI * rtA + bodyB.m_invI * rtB;
            ccp.tangentMass = 1.0 / kTangent;
            ccp.velocityBias = 0.0;
            var tX = vBX + ((-wB * rBY)) - vAX - ((-wA * rAY));
            var tY = vBY + (wB * rBX) - vAY - (wA * rAX);
            var vRel = cc.normal.x * tX + cc.normal.y * tY;
            if (vRel < (-b2Settings.b2_velocityThreshold)) {
               ccp.velocityBias += (-cc.restitution * vRel);
            }
         }
         if (cc.pointCount == 2) {
            var ccp1 = cc.points[0];
            var ccp2 = cc.points[1];
            var invMassA = bodyA.m_invMass;
            var invIA = bodyA.m_invI;
            var invMassB = bodyB.m_invMass;
            var invIB = bodyB.m_invI;
            var rn1A = ccp1.rA.x * normalY - ccp1.rA.y * normalX;
            var rn1B = ccp1.rB.x * normalY - ccp1.rB.y * normalX;
            var rn2A = ccp2.rA.x * normalY - ccp2.rA.y * normalX;
            var rn2B = ccp2.rB.x * normalY - ccp2.rB.y * normalX;
            var k11 = invMassA + invMassB + invIA * rn1A * rn1A + invIB * rn1B * rn1B;
            var k22 = invMassA + invMassB + invIA * rn2A * rn2A + invIB * rn2B * rn2B;
            var k12 = invMassA + invMassB + invIA * rn1A * rn2A + invIB * rn1B * rn2B;
            var k_maxConditionNumber = 100.0;
            if (k11 * k11 < k_maxConditionNumber * (k11 * k22 - k12 * k12)) {
               cc.K.col1.Set(k11, k12);
               cc.K.col2.Set(k12, k22);
               cc.K.GetInverse(cc.normalMass);
            }
            else {
               cc.pointCount = 1;
            }
         }
      }
   }
   b2ContactSolver.prototype.InitVelocityConstraints = function (step) {
      var tVec;
      var tVec2;
      var tMat;
      for (var i = 0; i < this.m_constraintCount; ++i) {
         var c = this.m_constraints[i];
         var bodyA = c.bodyA;
         var bodyB = c.bodyB;
         var invMassA = bodyA.m_invMass;
         var invIA = bodyA.m_invI;
         var invMassB = bodyB.m_invMass;
         var invIB = bodyB.m_invI;
         var normalX = c.normal.x;
         var normalY = c.normal.y;
         var tangentX = normalY;
         var tangentY = (-normalX);
         var tX = 0;
         var j = 0;
         var tCount = 0;
         if (step.warmStarting) {
            tCount = c.pointCount;
            for (j = 0;
            j < tCount; ++j) {
               var ccp = c.points[j];
               ccp.normalImpulse *= step.dtRatio;
               ccp.tangentImpulse *= step.dtRatio;
               var PX = ccp.normalImpulse * normalX + ccp.tangentImpulse * tangentX;
               var PY = ccp.normalImpulse * normalY + ccp.tangentImpulse * tangentY;
               bodyA.m_angularVelocity -= invIA * (ccp.rA.x * PY - ccp.rA.y * PX);
               bodyA.m_linearVelocity.x -= invMassA * PX;
               bodyA.m_linearVelocity.y -= invMassA * PY;
               bodyB.m_angularVelocity += invIB * (ccp.rB.x * PY - ccp.rB.y * PX);
               bodyB.m_linearVelocity.x += invMassB * PX;
               bodyB.m_linearVelocity.y += invMassB * PY;
            }
         }
         else {
            tCount = c.pointCount;
            for (j = 0;
            j < tCount; ++j) {
               var ccp2 = c.points[j];
               ccp2.normalImpulse = 0.0;
               ccp2.tangentImpulse = 0.0;
            }
         }
      }
   }
   b2ContactSolver.prototype.SolveVelocityConstraints = function () {
      var j = 0;
      var ccp;
      var rAX = 0;
      var rAY = 0;
      var rBX = 0;
      var rBY = 0;
      var dvX = 0;
      var dvY = 0;
      var vn = 0;
      var vt = 0;
      var lambda = 0;
      var maxFriction = 0;
      var newImpulse = 0;
      var PX = 0;
      var PY = 0;
      var dX = 0;
      var dY = 0;
      var P1X = 0;
      var P1Y = 0;
      var P2X = 0;
      var P2Y = 0;
      var tMat;
      var tVec;
      for (var i = 0; i < this.m_constraintCount; ++i) {
         var c = this.m_constraints[i];
         var bodyA = c.bodyA;
         var bodyB = c.bodyB;
         var wA = bodyA.m_angularVelocity;
         var wB = bodyB.m_angularVelocity;
         var vA = bodyA.m_linearVelocity;
         var vB = bodyB.m_linearVelocity;
         var invMassA = bodyA.m_invMass;
         var invIA = bodyA.m_invI;
         var invMassB = bodyB.m_invMass;
         var invIB = bodyB.m_invI;
         var normalX = c.normal.x;
         var normalY = c.normal.y;
         var tangentX = normalY;
         var tangentY = (-normalX);
         var friction = c.friction;
         var tX = 0;
         for (j = 0;
         j < c.pointCount; j++) {
            ccp = c.points[j];
            dvX = vB.x - wB * ccp.rB.y - vA.x + wA * ccp.rA.y;
            dvY = vB.y + wB * ccp.rB.x - vA.y - wA * ccp.rA.x;
            vt = dvX * tangentX + dvY * tangentY;
            lambda = ccp.tangentMass * (-vt);
            maxFriction = friction * ccp.normalImpulse;
            newImpulse = b2Math.Clamp(ccp.tangentImpulse + lambda, (-maxFriction), maxFriction);
            lambda = newImpulse - ccp.tangentImpulse;
            PX = lambda * tangentX;
            PY = lambda * tangentY;
            vA.x -= invMassA * PX;
            vA.y -= invMassA * PY;
            wA -= invIA * (ccp.rA.x * PY - ccp.rA.y * PX);
            vB.x += invMassB * PX;
            vB.y += invMassB * PY;
            wB += invIB * (ccp.rB.x * PY - ccp.rB.y * PX);
            ccp.tangentImpulse = newImpulse;
         }
         var tCount = parseInt(c.pointCount);
         if (c.pointCount == 1) {
            ccp = c.points[0];
            dvX = vB.x + ((-wB * ccp.rB.y)) - vA.x - ((-wA * ccp.rA.y));
            dvY = vB.y + (wB * ccp.rB.x) - vA.y - (wA * ccp.rA.x);
            vn = dvX * normalX + dvY * normalY;
            lambda = (-ccp.normalMass * (vn - ccp.velocityBias));
            newImpulse = ccp.normalImpulse + lambda;
            newImpulse = newImpulse > 0 ? newImpulse : 0.0;
            lambda = newImpulse - ccp.normalImpulse;
            PX = lambda * normalX;
            PY = lambda * normalY;
            vA.x -= invMassA * PX;
            vA.y -= invMassA * PY;
            wA -= invIA * (ccp.rA.x * PY - ccp.rA.y * PX);
            vB.x += invMassB * PX;
            vB.y += invMassB * PY;
            wB += invIB * (ccp.rB.x * PY - ccp.rB.y * PX);
            ccp.normalImpulse = newImpulse;
         }
         else {
            var cp1 = c.points[0];
            var cp2 = c.points[1];
            var aX = cp1.normalImpulse;
            var aY = cp2.normalImpulse;
            var dv1X = vB.x - wB * cp1.rB.y - vA.x + wA * cp1.rA.y;
            var dv1Y = vB.y + wB * cp1.rB.x - vA.y - wA * cp1.rA.x;
            var dv2X = vB.x - wB * cp2.rB.y - vA.x + wA * cp2.rA.y;
            var dv2Y = vB.y + wB * cp2.rB.x - vA.y - wA * cp2.rA.x;
            var vn1 = dv1X * normalX + dv1Y * normalY;
            var vn2 = dv2X * normalX + dv2Y * normalY;
            var bX = vn1 - cp1.velocityBias;
            var bY = vn2 - cp2.velocityBias;
            tMat = c.K;
            bX -= tMat.col1.x * aX + tMat.col2.x * aY;
            bY -= tMat.col1.y * aX + tMat.col2.y * aY;
            var k_errorTol = 0.001;
            for (;;) {
               tMat = c.normalMass;
               var xX = (-(tMat.col1.x * bX + tMat.col2.x * bY));
               var xY = (-(tMat.col1.y * bX + tMat.col2.y * bY));
               if (xX >= 0.0 && xY >= 0.0) {
                  dX = xX - aX;
                  dY = xY - aY;
                  P1X = dX * normalX;
                  P1Y = dX * normalY;
                  P2X = dY * normalX;
                  P2Y = dY * normalY;
                  vA.x -= invMassA * (P1X + P2X);
                  vA.y -= invMassA * (P1Y + P2Y);
                  wA -= invIA * (cp1.rA.x * P1Y - cp1.rA.y * P1X + cp2.rA.x * P2Y - cp2.rA.y * P2X);
                  vB.x += invMassB * (P1X + P2X);
                  vB.y += invMassB * (P1Y + P2Y);
                  wB += invIB * (cp1.rB.x * P1Y - cp1.rB.y * P1X + cp2.rB.x * P2Y - cp2.rB.y * P2X);
                  cp1.normalImpulse = xX;
                  cp2.normalImpulse = xY;
                  break;
               }
               xX = (-cp1.normalMass * bX);
               xY = 0.0;
               vn1 = 0.0;
               vn2 = c.K.col1.y * xX + bY;
               if (xX >= 0.0 && vn2 >= 0.0) {
                  dX = xX - aX;
                  dY = xY - aY;
                  P1X = dX * normalX;
                  P1Y = dX * normalY;
                  P2X = dY * normalX;
                  P2Y = dY * normalY;
                  vA.x -= invMassA * (P1X + P2X);
                  vA.y -= invMassA * (P1Y + P2Y);
                  wA -= invIA * (cp1.rA.x * P1Y - cp1.rA.y * P1X + cp2.rA.x * P2Y - cp2.rA.y * P2X);
                  vB.x += invMassB * (P1X + P2X);
                  vB.y += invMassB * (P1Y + P2Y);
                  wB += invIB * (cp1.rB.x * P1Y - cp1.rB.y * P1X + cp2.rB.x * P2Y - cp2.rB.y * P2X);
                  cp1.normalImpulse = xX;
                  cp2.normalImpulse = xY;
                  break;
               }
               xX = 0.0;
               xY = (-cp2.normalMass * bY);
               vn1 = c.K.col2.x * xY + bX;
               vn2 = 0.0;
               if (xY >= 0.0 && vn1 >= 0.0) {
                  dX = xX - aX;
                  dY = xY - aY;
                  P1X = dX * normalX;
                  P1Y = dX * normalY;
                  P2X = dY * normalX;
                  P2Y = dY * normalY;
                  vA.x -= invMassA * (P1X + P2X);
                  vA.y -= invMassA * (P1Y + P2Y);
                  wA -= invIA * (cp1.rA.x * P1Y - cp1.rA.y * P1X + cp2.rA.x * P2Y - cp2.rA.y * P2X);
                  vB.x += invMassB * (P1X + P2X);
                  vB.y += invMassB * (P1Y + P2Y);
                  wB += invIB * (cp1.rB.x * P1Y - cp1.rB.y * P1X + cp2.rB.x * P2Y - cp2.rB.y * P2X);
                  cp1.normalImpulse = xX;
                  cp2.normalImpulse = xY;
                  break;
               }
               xX = 0.0;
               xY = 0.0;
               vn1 = bX;
               vn2 = bY;
               if (vn1 >= 0.0 && vn2 >= 0.0) {
                  dX = xX - aX;
                  dY = xY - aY;
                  P1X = dX * normalX;
                  P1Y = dX * normalY;
                  P2X = dY * normalX;
                  P2Y = dY * normalY;
                  vA.x -= invMassA * (P1X + P2X);
                  vA.y -= invMassA * (P1Y + P2Y);
                  wA -= invIA * (cp1.rA.x * P1Y - cp1.rA.y * P1X + cp2.rA.x * P2Y - cp2.rA.y * P2X);
                  vB.x += invMassB * (P1X + P2X);
                  vB.y += invMassB * (P1Y + P2Y);
                  wB += invIB * (cp1.rB.x * P1Y - cp1.rB.y * P1X + cp2.rB.x * P2Y - cp2.rB.y * P2X);
                  cp1.normalImpulse = xX;
                  cp2.normalImpulse = xY;
                  break;
               }
               break;
            }
         }
         bodyA.m_angularVelocity = wA;
         bodyB.m_angularVelocity = wB;
      }
   }
   b2ContactSolver.prototype.FinalizeVelocityConstraints = function () {
      for (var i = 0; i < this.m_constraintCount; ++i) {
         var c = this.m_constraints[i];
         var m = c.manifold;
         for (var j = 0; j < c.pointCount; ++j) {
            var point1 = m.m_points[j];
            var point2 = c.points[j];
            point1.m_normalImpulse = point2.normalImpulse;
            point1.m_tangentImpulse = point2.tangentImpulse;
         }
      }
   }
   b2ContactSolver.prototype.SolvePositionConstraints = function (baumgarte) {
      if (baumgarte === undefined) baumgarte = 0;
      var minSeparation = 0.0;
      for (var i = 0; i < this.m_constraintCount; i++) {
         var c = this.m_constraints[i];
         var bodyA = c.bodyA;
         var bodyB = c.bodyB;
         var invMassA = bodyA.m_mass * bodyA.m_invMass;
         var invIA = bodyA.m_mass * bodyA.m_invI;
         var invMassB = bodyB.m_mass * bodyB.m_invMass;
         var invIB = bodyB.m_mass * bodyB.m_invI;
         b2ContactSolver.s_psm.Initialize(c);
         var normal = b2ContactSolver.s_psm.m_normal;
         for (var j = 0; j < c.pointCount; j++) {
            var ccp = c.points[j];
            var point = b2ContactSolver.s_psm.m_points[j];
            var separation = b2ContactSolver.s_psm.m_separations[j];
            var rAX = point.x - bodyA.m_sweep.c.x;
            var rAY = point.y - bodyA.m_sweep.c.y;
            var rBX = point.x - bodyB.m_sweep.c.x;
            var rBY = point.y - bodyB.m_sweep.c.y;
            minSeparation = minSeparation < separation ? minSeparation : separation;
            var C = b2Math.Clamp(baumgarte * (separation + b2Settings.b2_linearSlop), (-b2Settings.b2_maxLinearCorrection), 0.0);
            var impulse = (-ccp.equalizedMass * C);
            var PX = impulse * normal.x;
            var PY = impulse * normal.y;bodyA.m_sweep.c.x -= invMassA * PX;
            bodyA.m_sweep.c.y -= invMassA * PY;
            bodyA.m_sweep.a -= invIA * (rAX * PY - rAY * PX);
            bodyA.SynchronizeTransform();
            bodyB.m_sweep.c.x += invMassB * PX;
            bodyB.m_sweep.c.y += invMassB * PY;
            bodyB.m_sweep.a += invIB * (rBX * PY - rBY * PX);
            bodyB.SynchronizeTransform();
         }
      }
      return minSeparation > (-1.5 * b2Settings.b2_linearSlop);
   }
   Box2D.postDefs.push(function () {
      Box2D.Dynamics.Contacts.b2ContactSolver.s_worldManifold = new b2WorldManifold();
      Box2D.Dynamics.Contacts.b2ContactSolver.s_psm = new b2PositionSolverManifold();
   });
   Box2D.inherit(b2EdgeAndCircleContact, Box2D.Dynamics.Contacts.b2Contact);
   b2EdgeAndCircleContact.prototype.__super = Box2D.Dynamics.Contacts.b2Contact.prototype;
   b2EdgeAndCircleContact.b2EdgeAndCircleContact = function () {
      Box2D.Dynamics.Contacts.b2Contact.b2Contact.apply(this, arguments);
   };
   b2EdgeAndCircleContact.Create = function (allocator) {
      return new b2EdgeAndCircleContact();
   }
   b2EdgeAndCircleContact.Destroy = function (contact, allocator) {}
   b2EdgeAndCircleContact.prototype.Reset = function (fixtureA, fixtureB) {
      this.__super.Reset.call(this, fixtureA, fixtureB);
   }
   b2EdgeAndCircleContact.prototype.Evaluate = function () {
      var bA = this.m_fixtureA.GetBody();
      var bB = this.m_fixtureB.GetBody();
      this.b2CollideEdgeAndCircle(this.m_manifold, (this.m_fixtureA.GetShape() instanceof b2EdgeShape ? this.m_fixtureA.GetShape() : null), bA.m_xf, (this.m_fixtureB.GetShape() instanceof b2CircleShape ? this.m_fixtureB.GetShape() : null), bB.m_xf);
   }
   b2EdgeAndCircleContact.prototype.b2CollideEdgeAndCircle = function (manifold, edge, xf1, circle, xf2) {}
   Box2D.inherit(b2NullContact, Box2D.Dynamics.Contacts.b2Contact);
   b2NullContact.prototype.__super = Box2D.Dynamics.Contacts.b2Contact.prototype;
   b2NullContact.b2NullContact = function () {
      Box2D.Dynamics.Contacts.b2Contact.b2Contact.apply(this, arguments);
   };
   b2NullContact.prototype.b2NullContact = function () {
      this.__super.b2Contact.call(this);
   }
   b2NullContact.prototype.Evaluate = function () {}
   Box2D.inherit(b2PolyAndCircleContact, Box2D.Dynamics.Contacts.b2Contact);
   b2PolyAndCircleContact.prototype.__super = Box2D.Dynamics.Contacts.b2Contact.prototype;
   b2PolyAndCircleContact.b2PolyAndCircleContact = function () {
      Box2D.Dynamics.Contacts.b2Contact.b2Contact.apply(this, arguments);
   };
   b2PolyAndCircleContact.Create = function (allocator) {
      return new b2PolyAndCircleContact();
   }
   b2PolyAndCircleContact.Destroy = function (contact, allocator) {}
   b2PolyAndCircleContact.prototype.Reset = function (fixtureA, fixtureB) {
      this.__super.Reset.call(this, fixtureA, fixtureB);
      b2Settings.b2Assert(fixtureA.GetType() == b2Shape.e_polygonShape);
      b2Settings.b2Assert(fixtureB.GetType() == b2Shape.e_circleShape);
   }
   b2PolyAndCircleContact.prototype.Evaluate = function () {
      var bA = this.m_fixtureA.m_body;
      var bB = this.m_fixtureB.m_body;
      b2Collision.CollidePolygonAndCircle(this.m_manifold, (this.m_fixtureA.GetShape() instanceof b2PolygonShape ? this.m_fixtureA.GetShape() : null), bA.m_xf, (this.m_fixtureB.GetShape() instanceof b2CircleShape ? this.m_fixtureB.GetShape() : null), bB.m_xf);
   }
   Box2D.inherit(b2PolyAndEdgeContact, Box2D.Dynamics.Contacts.b2Contact);
   b2PolyAndEdgeContact.prototype.__super = Box2D.Dynamics.Contacts.b2Contact.prototype;
   b2PolyAndEdgeContact.b2PolyAndEdgeContact = function () {
      Box2D.Dynamics.Contacts.b2Contact.b2Contact.apply(this, arguments);
   };
   b2PolyAndEdgeContact.Create = function (allocator) {
      return new b2PolyAndEdgeContact();
   }
   b2PolyAndEdgeContact.Destroy = function (contact, allocator) {}
   b2PolyAndEdgeContact.prototype.Reset = function (fixtureA, fixtureB) {
      this.__super.Reset.call(this, fixtureA, fixtureB);
      b2Settings.b2Assert(fixtureA.GetType() == b2Shape.e_polygonShape);
      b2Settings.b2Assert(fixtureB.GetType() == b2Shape.e_edgeShape);
   }
   b2PolyAndEdgeContact.prototype.Evaluate = function () {
      var bA = this.m_fixtureA.GetBody();
      var bB = this.m_fixtureB.GetBody();
      this.b2CollidePolyAndEdge(this.m_manifold, (this.m_fixtureA.GetShape() instanceof b2PolygonShape ? this.m_fixtureA.GetShape() : null), bA.m_xf, (this.m_fixtureB.GetShape() instanceof b2EdgeShape ? this.m_fixtureB.GetShape() : null), bB.m_xf);
   }
   b2PolyAndEdgeContact.prototype.b2CollidePolyAndEdge = function (manifold, polygon, xf1, edge, xf2) {}
   Box2D.inherit(b2PolygonContact, Box2D.Dynamics.Contacts.b2Contact);
   b2PolygonContact.prototype.__super = Box2D.Dynamics.Contacts.b2Contact.prototype;
   b2PolygonContact.b2PolygonContact = function () {
      Box2D.Dynamics.Contacts.b2Contact.b2Contact.apply(this, arguments);
   };
   b2PolygonContact.Create = function (allocator) {
      return new b2PolygonContact();
   }
   b2PolygonContact.Destroy = function (contact, allocator) {}
   b2PolygonContact.prototype.Reset = function (fixtureA, fixtureB) {
      this.__super.Reset.call(this, fixtureA, fixtureB);
   }
   b2PolygonContact.prototype.Evaluate = function () {
      var bA = this.m_fixtureA.GetBody();
      var bB = this.m_fixtureB.GetBody();
      b2Collision.CollidePolygons(this.m_manifold, (this.m_fixtureA.GetShape() instanceof b2PolygonShape ? this.m_fixtureA.GetShape() : null), bA.m_xf, (this.m_fixtureB.GetShape() instanceof b2PolygonShape ? this.m_fixtureB.GetShape() : null), bB.m_xf);
   }
   b2PositionSolverManifold.b2PositionSolverManifold = function () {};
   b2PositionSolverManifold.prototype.b2PositionSolverManifold = function () {
      this.m_normal = new b2Vec2();
      this.m_separations = new Vector_a2j_Number(b2Settings.b2_maxManifoldPoints);
      this.m_points = new Vector(b2Settings.b2_maxManifoldPoints);
      for (var i = 0; i < b2Settings.b2_maxManifoldPoints; i++) {
         this.m_points[i] = new b2Vec2();
      }
   }
   b2PositionSolverManifold.prototype.Initialize = function (cc) {
      b2Settings.b2Assert(cc.pointCount > 0);
      var i = 0;
      var clipPointX = 0;
      var clipPointY = 0;
      var tMat;
      var tVec;
      var planePointX = 0;
      var planePointY = 0;
      switch (cc.type) {
      case b2Manifold.e_circles:
         {
            tMat = cc.bodyA.m_xf.R;
            tVec = cc.localPoint;
            var pointAX = cc.bodyA.m_xf.position.x + (tMat.col1.x * tVec.x + tMat.col2.x * tVec.y);
            var pointAY = cc.bodyA.m_xf.position.y + (tMat.col1.y * tVec.x + tMat.col2.y * tVec.y);
            tMat = cc.bodyB.m_xf.R;
            tVec = cc.points[0].localPoint;
            var pointBX = cc.bodyB.m_xf.position.x + (tMat.col1.x * tVec.x + tMat.col2.x * tVec.y);
            var pointBY = cc.bodyB.m_xf.position.y + (tMat.col1.y * tVec.x + tMat.col2.y * tVec.y);
            var dX = pointBX - pointAX;
            var dY = pointBY - pointAY;
            var d2 = dX * dX + dY * dY;
            if (d2 > Number.MIN_VALUE * Number.MIN_VALUE) {
               var d = Math.sqrt(d2);
               this.m_normal.x = dX / d;
               this.m_normal.y = dY / d;
            }
            else {
               this.m_normal.x = 1.0;
               this.m_normal.y = 0.0;
            }
            this.m_points[0].x = 0.5 * (pointAX + pointBX);
            this.m_points[0].y = 0.5 * (pointAY + pointBY);
            this.m_separations[0] = dX * this.m_normal.x + dY * this.m_normal.y - cc.radius;
         }
         break;
      case b2Manifold.e_faceA:
         {
            tMat = cc.bodyA.m_xf.R;
            tVec = cc.localPlaneNormal;
            this.m_normal.x = tMat.col1.x * tVec.x + tMat.col2.x * tVec.y;
            this.m_normal.y = tMat.col1.y * tVec.x + tMat.col2.y * tVec.y;
            tMat = cc.bodyA.m_xf.R;
            tVec = cc.localPoint;
            planePointX = cc.bodyA.m_xf.position.x + (tMat.col1.x * tVec.x + tMat.col2.x * tVec.y);
            planePointY = cc.bodyA.m_xf.position.y + (tMat.col1.y * tVec.x + tMat.col2.y * tVec.y);
            tMat = cc.bodyB.m_xf.R;
            for (i = 0;
            i < cc.pointCount; ++i) {
               tVec = cc.points[i].localPoint;
               clipPointX = cc.bodyB.m_xf.position.x + (tMat.col1.x * tVec.x + tMat.col2.x * tVec.y);
               clipPointY = cc.bodyB.m_xf.position.y + (tMat.col1.y * tVec.x + tMat.col2.y * tVec.y);
               this.m_separations[i] = (clipPointX - planePointX) * this.m_normal.x + (clipPointY - planePointY) * this.m_normal.y - cc.radius;
               this.m_points[i].x = clipPointX;
               this.m_points[i].y = clipPointY;
            }
         }
         break;
      case b2Manifold.e_faceB:
         {
            tMat = cc.bodyB.m_xf.R;
            tVec = cc.localPlaneNormal;
            this.m_normal.x = tMat.col1.x * tVec.x + tMat.col2.x * tVec.y;
            this.m_normal.y = tMat.col1.y * tVec.x + tMat.col2.y * tVec.y;
            tMat = cc.bodyB.m_xf.R;
            tVec = cc.localPoint;
            planePointX = cc.bodyB.m_xf.position.x + (tMat.col1.x * tVec.x + tMat.col2.x * tVec.y);
            planePointY = cc.bodyB.m_xf.position.y + (tMat.col1.y * tVec.x + tMat.col2.y * tVec.y);
            tMat = cc.bodyA.m_xf.R;
            for (i = 0;
            i < cc.pointCount; ++i) {
               tVec = cc.points[i].localPoint;
               clipPointX = cc.bodyA.m_xf.position.x + (tMat.col1.x * tVec.x + tMat.col2.x * tVec.y);
               clipPointY = cc.bodyA.m_xf.position.y + (tMat.col1.y * tVec.x + tMat.col2.y * tVec.y);
               this.m_separations[i] = (clipPointX - planePointX) * this.m_normal.x + (clipPointY - planePointY) * this.m_normal.y - cc.radius;
               this.m_points[i].Set(clipPointX, clipPointY);
            }
            this.m_normal.x *= (-1);
            this.m_normal.y *= (-1);
         }
         break;
      }
   }
   Box2D.postDefs.push(function () {
      Box2D.Dynamics.Contacts.b2PositionSolverManifold.circlePointA = new b2Vec2();
      Box2D.Dynamics.Contacts.b2PositionSolverManifold.circlePointB = new b2Vec2();
   });
})();
(function () {
   var b2Body = Box2D.Dynamics.b2Body,
      b2BodyDef = Box2D.Dynamics.b2BodyDef,
      b2ContactFilter = Box2D.Dynamics.b2ContactFilter,
      b2ContactImpulse = Box2D.Dynamics.b2ContactImpulse,
      b2ContactListener = Box2D.Dynamics.b2ContactListener,
      b2ContactManager = Box2D.Dynamics.b2ContactManager,
      b2DebugDraw = Box2D.Dynamics.b2DebugDraw,
      b2DestructionListener = Box2D.Dynamics.b2DestructionListener,
      b2FilterData = Box2D.Dynamics.b2FilterData,
      b2Fixture = Box2D.Dynamics.b2Fixture,
      b2FixtureDef = Box2D.Dynamics.b2FixtureDef,
      b2Island = Box2D.Dynamics.b2Island,
      b2TimeStep = Box2D.Dynamics.b2TimeStep,
      b2World = Box2D.Dynamics.b2World,
      b2Mat22 = Box2D.Common.Math.b2Mat22,
      b2Mat33 = Box2D.Common.Math.b2Mat33,
      b2Math = Box2D.Common.Math.b2Math,
      b2Sweep = Box2D.Common.Math.b2Sweep,
      b2Transform = Box2D.Common.Math.b2Transform,
      b2Vec2 = Box2D.Common.Math.b2Vec2,
      b2Vec3 = Box2D.Common.Math.b2Vec3,
      b2Color = Box2D.Common.b2Color,
      b2internal = Box2D.Common.b2internal,
      b2Settings = Box2D.Common.b2Settings,
      b2CircleShape = Box2D.Collision.Shapes.b2CircleShape,
      b2EdgeChainDef = Box2D.Collision.Shapes.b2EdgeChainDef,
      b2EdgeShape = Box2D.Collision.Shapes.b2EdgeShape,
      b2MassData = Box2D.Collision.Shapes.b2MassData,
      b2PolygonShape = Box2D.Collision.Shapes.b2PolygonShape,
      b2Shape = Box2D.Collision.Shapes.b2Shape,
      b2BuoyancyController = Box2D.Dynamics.Controllers.b2BuoyancyController,
      b2ConstantAccelController = Box2D.Dynamics.Controllers.b2ConstantAccelController,
      b2ConstantForceController = Box2D.Dynamics.Controllers.b2ConstantForceController,
      b2Controller = Box2D.Dynamics.Controllers.b2Controller,
      b2ControllerEdge = Box2D.Dynamics.Controllers.b2ControllerEdge,
      b2GravityController = Box2D.Dynamics.Controllers.b2GravityController,
      b2TensorDampingController = Box2D.Dynamics.Controllers.b2TensorDampingController;

   Box2D.inherit(b2BuoyancyController, Box2D.Dynamics.Controllers.b2Controller);
   b2BuoyancyController.prototype.__super = Box2D.Dynamics.Controllers.b2Controller.prototype;
   b2BuoyancyController.b2BuoyancyController = function () {
      Box2D.Dynamics.Controllers.b2Controller.b2Controller.apply(this, arguments);
      this.normal = new b2Vec2(0, (-1));
      this.offset = 0;
      this.density = 0;
      this.velocity = new b2Vec2(0, 0);
      this.linearDrag = 2;
      this.angularDrag = 1;
      this.useDensity = false;
      this.useWorldGravity = true;
      this.gravity = null;
   };
   b2BuoyancyController.prototype.Step = function (step) {
      if (!this.m_bodyList) return;
      if (this.useWorldGravity) {
         this.gravity = this.GetWorld().GetGravity().Copy();
      }
      for (var i = this.m_bodyList; i; i = i.nextBody) {
         var body = i.body;
         if (body.IsAwake() == false) {
            continue;
         }
         var areac = new b2Vec2();
         var massc = new b2Vec2();
         var area = 0.0;
         var mass = 0.0;
         for (var fixture = body.GetFixtureList(); fixture; fixture = fixture.GetNext()) {
            var sc = new b2Vec2();
            var sarea = fixture.GetShape().ComputeSubmergedArea(this.normal, this.offset, body.GetTransform(), sc);
            area += sarea;
            areac.x += sarea * sc.x;
            areac.y += sarea * sc.y;
            var shapeDensity = 0;
            if (this.useDensity) {
               shapeDensity = 1;
            }
            else {
               shapeDensity = 1;
            }
            mass += sarea * shapeDensity;
            massc.x += sarea * sc.x * shapeDensity;
            massc.y += sarea * sc.y * shapeDensity;
         }
         areac.x /= area;
         areac.y /= area;
         massc.x /= mass;
         massc.y /= mass;
         if (area < Number.MIN_VALUE) continue;
         var buoyancyForce = this.gravity.GetNegative();
         buoyancyForce.Multiply(this.density * area);
         body.ApplyForce(buoyancyForce, massc);
         var dragForce = body.GetLinearVelocityFromWorldPoint(areac);
         dragForce.Subtract(this.velocity);
         dragForce.Multiply((-this.linearDrag * area));
         body.ApplyForce(dragForce, areac);
         body.ApplyTorque((-body.GetInertia() / body.GetMass() * area * body.GetAngularVelocity() * this.angularDrag));
      }
   }
   b2BuoyancyController.prototype.Draw = function (debugDraw) {
      var r = 1000;
      var p1 = new b2Vec2();
      var p2 = new b2Vec2();
      p1.x = this.normal.x * this.offset + this.normal.y * r;
      p1.y = this.normal.y * this.offset - this.normal.x * r;
      p2.x = this.normal.x * this.offset - this.normal.y * r;
      p2.y = this.normal.y * this.offset + this.normal.x * r;
      var color = new b2Color(0, 0, 1);
      debugDraw.DrawSegment(p1, p2, color);
   }
   Box2D.inherit(b2ConstantAccelController, Box2D.Dynamics.Controllers.b2Controller);
   b2ConstantAccelController.prototype.__super = Box2D.Dynamics.Controllers.b2Controller.prototype;
   b2ConstantAccelController.b2ConstantAccelController = function () {
      Box2D.Dynamics.Controllers.b2Controller.b2Controller.apply(this, arguments);
      this.A = new b2Vec2(0, 0);
   };
   b2ConstantAccelController.prototype.Step = function (step) {
      var smallA = new b2Vec2(this.A.x * step.dt, this.A.y * step.dt);
      for (var i = this.m_bodyList; i; i = i.nextBody) {
         var body = i.body;
         if (!body.IsAwake()) continue;
         body.SetLinearVelocity(new b2Vec2(body.GetLinearVelocity().x + smallA.x, body.GetLinearVelocity().y + smallA.y));
      }
   }
   Box2D.inherit(b2ConstantForceController, Box2D.Dynamics.Controllers.b2Controller);
   b2ConstantForceController.prototype.__super = Box2D.Dynamics.Controllers.b2Controller.prototype;
   b2ConstantForceController.b2ConstantForceController = function () {
      Box2D.Dynamics.Controllers.b2Controller.b2Controller.apply(this, arguments);
      this.F = new b2Vec2(0, 0);
   };
   b2ConstantForceController.prototype.Step = function (step) {
      for (var i = this.m_bodyList; i; i = i.nextBody) {
         var body = i.body;
         if (!body.IsAwake()) continue;
         body.ApplyForce(this.F, body.GetWorldCenter());
      }
   }
   b2Controller.b2Controller = function () {};
   b2Controller.prototype.Step = function (step) {}
   b2Controller.prototype.Draw = function (debugDraw) {}
   b2Controller.prototype.AddBody = function (body) {
      var edge = new b2ControllerEdge();
      edge.controller = this;
      edge.body = body;
      edge.nextBody = this.m_bodyList;
      edge.prevBody = null;
      this.m_bodyList = edge;
      if (edge.nextBody) edge.nextBody.prevBody = edge;
      this.m_bodyCount++;
      edge.nextController = body.m_controllerList;
      edge.prevController = null;
      body.m_controllerList = edge;
      if (edge.nextController) edge.nextController.prevController = edge;
      body.m_controllerCount++;
   }
   b2Controller.prototype.RemoveBody = function (body) {
      var edge = body.m_controllerList;
      while (edge && edge.controller != this)
      edge = edge.nextController;
      if (edge.prevBody) edge.prevBody.nextBody = edge.nextBody;
      if (edge.nextBody) edge.nextBody.prevBody = edge.prevBody;
      if (edge.nextController) edge.nextController.prevController = edge.prevController;
      if (edge.prevController) edge.prevController.nextController = edge.nextController;
      if (this.m_bodyList == edge) this.m_bodyList = edge.nextBody;
      if (body.m_controllerList == edge) body.m_controllerList = edge.nextController;
      body.m_controllerCount--;
      this.m_bodyCount--;
   }
   b2Controller.prototype.Clear = function () {
      while (this.m_bodyList)
      this.RemoveBody(this.m_bodyList.body);
   }
   b2Controller.prototype.GetNext = function () {
      return this.m_next;
   }
   b2Controller.prototype.GetWorld = function () {
      return this.m_world;
   }
   b2Controller.prototype.GetBodyList = function () {
      return this.m_bodyList;
   }
   b2ControllerEdge.b2ControllerEdge = function () {};
   Box2D.inherit(b2GravityController, Box2D.Dynamics.Controllers.b2Controller);
   b2GravityController.prototype.__super = Box2D.Dynamics.Controllers.b2Controller.prototype;
   b2GravityController.b2GravityController = function () {
      Box2D.Dynamics.Controllers.b2Controller.b2Controller.apply(this, arguments);
      this.G = 1;
      this.invSqr = true;
   };
   b2GravityController.prototype.Step = function (step) {
      var i = null;
      var body1 = null;
      var p1 = null;
      var mass1 = 0;
      var j = null;
      var body2 = null;
      var p2 = null;
      var dx = 0;
      var dy = 0;
      var r2 = 0;
      var f = null;
      if (this.invSqr) {
         for (i = this.m_bodyList;
         i; i = i.nextBody) {
            body1 = i.body;
            p1 = body1.GetWorldCenter();
            mass1 = body1.GetMass();
            for (j = this.m_bodyList;
            j != i; j = j.nextBody) {
               body2 = j.body;
               p2 = body2.GetWorldCenter();
               dx = p2.x - p1.x;
               dy = p2.y - p1.y;
               r2 = dx * dx + dy * dy;
               if (r2 < Number.MIN_VALUE) continue;
               f = new b2Vec2(dx, dy);
               f.Multiply(this.G / r2 / Math.sqrt(r2) * mass1 * body2.GetMass());
               if (body1.IsAwake()) body1.ApplyForce(f, p1);
               f.Multiply((-1));
               if (body2.IsAwake()) body2.ApplyForce(f, p2);
            }
         }
      }
      else {
         for (i = this.m_bodyList;
         i; i = i.nextBody) {
            body1 = i.body;
            p1 = body1.GetWorldCenter();
            mass1 = body1.GetMass();
            for (j = this.m_bodyList;
            j != i; j = j.nextBody) {
               body2 = j.body;
               p2 = body2.GetWorldCenter();
               dx = p2.x - p1.x;
               dy = p2.y - p1.y;
               r2 = dx * dx + dy * dy;
               if (r2 < Number.MIN_VALUE) continue;
               f = new b2Vec2(dx, dy);
               f.Multiply(this.G / r2 * mass1 * body2.GetMass());
               if (body1.IsAwake()) body1.ApplyForce(f, p1);
               f.Multiply((-1));
               if (body2.IsAwake()) body2.ApplyForce(f, p2);
            }
         }
      }
   }
   Box2D.inherit(b2TensorDampingController, Box2D.Dynamics.Controllers.b2Controller);
   b2TensorDampingController.prototype.__super = Box2D.Dynamics.Controllers.b2Controller.prototype;
   b2TensorDampingController.b2TensorDampingController = function () {
      Box2D.Dynamics.Controllers.b2Controller.b2Controller.apply(this, arguments);
      this.T = new b2Mat22();
      this.maxTimestep = 0;
   };
   b2TensorDampingController.prototype.SetAxisAligned = function (xDamping, yDamping) {
      if (xDamping === undefined) xDamping = 0;
      if (yDamping === undefined) yDamping = 0;
      this.T.col1.x = (-xDamping);
      this.T.col1.y = 0;
      this.T.col2.x = 0;
      this.T.col2.y = (-yDamping);
      if (xDamping > 0 || yDamping > 0) {
         this.maxTimestep = 1 / Math.max(xDamping, yDamping);
      }
      else {
         this.maxTimestep = 0;
      }
   }
   b2TensorDampingController.prototype.Step = function (step) {
      var timestep = step.dt;
      if (timestep <= Number.MIN_VALUE) return;
      if (timestep > this.maxTimestep && this.maxTimestep > 0) timestep = this.maxTimestep;
      for (var i = this.m_bodyList; i; i = i.nextBody) {
         var body = i.body;
         if (!body.IsAwake()) {
            continue;
         }
         var damping = body.GetWorldVector(b2Math.MulMV(this.T, body.GetLocalVector(body.GetLinearVelocity())));
         body.SetLinearVelocity(new b2Vec2(body.GetLinearVelocity().x + damping.x * timestep, body.GetLinearVelocity().y + damping.y * timestep));
      }
   }
})();
(function () {
   var b2Color = Box2D.Common.b2Color,
      b2internal = Box2D.Common.b2internal,
      b2Settings = Box2D.Common.b2Settings,
      b2Mat22 = Box2D.Common.Math.b2Mat22,
      b2Mat33 = Box2D.Common.Math.b2Mat33,
      b2Math = Box2D.Common.Math.b2Math,
      b2Sweep = Box2D.Common.Math.b2Sweep,
      b2Transform = Box2D.Common.Math.b2Transform,
      b2Vec2 = Box2D.Common.Math.b2Vec2,
      b2Vec3 = Box2D.Common.Math.b2Vec3,
      b2DistanceJoint = Box2D.Dynamics.Joints.b2DistanceJoint,
      b2DistanceJointDef = Box2D.Dynamics.Joints.b2DistanceJointDef,
      b2FrictionJoint = Box2D.Dynamics.Joints.b2FrictionJoint,
      b2FrictionJointDef = Box2D.Dynamics.Joints.b2FrictionJointDef,
      b2GearJoint = Box2D.Dynamics.Joints.b2GearJoint,
      b2GearJointDef = Box2D.Dynamics.Joints.b2GearJointDef,
      b2Jacobian = Box2D.Dynamics.Joints.b2Jacobian,
      b2Joint = Box2D.Dynamics.Joints.b2Joint,
      b2JointDef = Box2D.Dynamics.Joints.b2JointDef,
      b2JointEdge = Box2D.Dynamics.Joints.b2JointEdge,
      b2LineJoint = Box2D.Dynamics.Joints.b2LineJoint,
      b2LineJointDef = Box2D.Dynamics.Joints.b2LineJointDef,
      b2MouseJoint = Box2D.Dynamics.Joints.b2MouseJoint,
      b2MouseJointDef = Box2D.Dynamics.Joints.b2MouseJointDef,
      b2PrismaticJoint = Box2D.Dynamics.Joints.b2PrismaticJoint,
      b2PrismaticJointDef = Box2D.Dynamics.Joints.b2PrismaticJointDef,
      b2PulleyJoint = Box2D.Dynamics.Joints.b2PulleyJoint,
      b2PulleyJointDef = Box2D.Dynamics.Joints.b2PulleyJointDef,
      b2RevoluteJoint = Box2D.Dynamics.Joints.b2RevoluteJoint,
      b2RevoluteJointDef = Box2D.Dynamics.Joints.b2RevoluteJointDef,
      b2WeldJoint = Box2D.Dynamics.Joints.b2WeldJoint,
      b2WeldJointDef = Box2D.Dynamics.Joints.b2WeldJointDef,
      b2Body = Box2D.Dynamics.b2Body,
      b2BodyDef = Box2D.Dynamics.b2BodyDef,
      b2ContactFilter = Box2D.Dynamics.b2ContactFilter,
      b2ContactImpulse = Box2D.Dynamics.b2ContactImpulse,
      b2ContactListener = Box2D.Dynamics.b2ContactListener,
      b2ContactManager = Box2D.Dynamics.b2ContactManager,
      b2DebugDraw = Box2D.Dynamics.b2DebugDraw,
      b2DestructionListener = Box2D.Dynamics.b2DestructionListener,
      b2FilterData = Box2D.Dynamics.b2FilterData,
      b2Fixture = Box2D.Dynamics.b2Fixture,
      b2FixtureDef = Box2D.Dynamics.b2FixtureDef,
      b2Island = Box2D.Dynamics.b2Island,
      b2TimeStep = Box2D.Dynamics.b2TimeStep,
      b2World = Box2D.Dynamics.b2World;

   Box2D.inherit(b2DistanceJoint, Box2D.Dynamics.Joints.b2Joint);
   b2DistanceJoint.prototype.__super = Box2D.Dynamics.Joints.b2Joint.prototype;
   b2DistanceJoint.b2DistanceJoint = function () {
      Box2D.Dynamics.Joints.b2Joint.b2Joint.apply(this, arguments);
      this.m_localAnchor1 = new b2Vec2();
      this.m_localAnchor2 = new b2Vec2();
      this.m_u = new b2Vec2();
   };
   b2DistanceJoint.prototype.GetAnchorA = function () {
      return this.m_bodyA.GetWorldPoint(this.m_localAnchor1);
   }
   b2DistanceJoint.prototype.GetAnchorB = function () {
      return this.m_bodyB.GetWorldPoint(this.m_localAnchor2);
   }
   b2DistanceJoint.prototype.GetReactionForce = function (inv_dt) {
      if (inv_dt === undefined) inv_dt = 0;
      return new b2Vec2(inv_dt * this.m_impulse * this.m_u.x, inv_dt * this.m_impulse * this.m_u.y);
   }
   b2DistanceJoint.prototype.GetReactionTorque = function (inv_dt) {
      if (inv_dt === undefined) inv_dt = 0;
      return 0.0;
   }
   b2DistanceJoint.prototype.GetLength = function () {
      return this.m_length;
   }
   b2DistanceJoint.prototype.SetLength = function (length) {
      if (length === undefined) length = 0;
      this.m_length = length;
   }
   b2DistanceJoint.prototype.GetFrequency = function () {
      return this.m_frequencyHz;
   }
   b2DistanceJoint.prototype.SetFrequency = function (hz) {
      if (hz === undefined) hz = 0;
      this.m_frequencyHz = hz;
   }
   b2DistanceJoint.prototype.GetDampingRatio = function () {
      return this.m_dampingRatio;
   }
   b2DistanceJoint.prototype.SetDampingRatio = function (ratio) {
      if (ratio === undefined) ratio = 0;
      this.m_dampingRatio = ratio;
   }
   b2DistanceJoint.prototype.b2DistanceJoint = function (def) {
      this.__super.b2Joint.call(this, def);
      var tMat;
      var tX = 0;
      var tY = 0;
      this.m_localAnchor1.SetV(def.localAnchorA);
      this.m_localAnchor2.SetV(def.localAnchorB);
      this.m_length = def.length;
      this.m_frequencyHz = def.frequencyHz;
      this.m_dampingRatio = def.dampingRatio;
      this.m_impulse = 0.0;
      this.m_gamma = 0.0;
      this.m_bias = 0.0;
   }
   b2DistanceJoint.prototype.InitVelocityConstraints = function (step) {
      var tMat;
      var tX = 0;
      var bA = this.m_bodyA;
      var bB = this.m_bodyB;
      tMat = bA.m_xf.R;
      var r1X = this.m_localAnchor1.x - bA.m_sweep.localCenter.x;
      var r1Y = this.m_localAnchor1.y - bA.m_sweep.localCenter.y;
      tX = (tMat.col1.x * r1X + tMat.col2.x * r1Y);
      r1Y = (tMat.col1.y * r1X + tMat.col2.y * r1Y);
      r1X = tX;
      tMat = bB.m_xf.R;
      var r2X = this.m_localAnchor2.x - bB.m_sweep.localCenter.x;
      var r2Y = this.m_localAnchor2.y - bB.m_sweep.localCenter.y;
      tX = (tMat.col1.x * r2X + tMat.col2.x * r2Y);
      r2Y = (tMat.col1.y * r2X + tMat.col2.y * r2Y);
      r2X = tX;
      this.m_u.x = bB.m_sweep.c.x + r2X - bA.m_sweep.c.x - r1X;
      this.m_u.y = bB.m_sweep.c.y + r2Y - bA.m_sweep.c.y - r1Y;
      var length = Math.sqrt(this.m_u.x * this.m_u.x + this.m_u.y * this.m_u.y);
      if (length > b2Settings.b2_linearSlop) {
         this.m_u.Multiply(1.0 / length);
      }
      else {
         this.m_u.SetZero();
      }
      var cr1u = (r1X * this.m_u.y - r1Y * this.m_u.x);
      var cr2u = (r2X * this.m_u.y - r2Y * this.m_u.x);
      var invMass = bA.m_invMass + bA.m_invI * cr1u * cr1u + bB.m_invMass + bB.m_invI * cr2u * cr2u;
      this.m_mass = invMass != 0.0 ? 1.0 / invMass : 0.0;
      if (this.m_frequencyHz > 0.0) {
         var C = length - this.m_length;
         var omega = 2.0 * Math.PI * this.m_frequencyHz;
         var d = 2.0 * this.m_mass * this.m_dampingRatio * omega;
         var k = this.m_mass * omega * omega;
         this.m_gamma = step.dt * (d + step.dt * k);
         this.m_gamma = this.m_gamma != 0.0 ? 1 / this.m_gamma : 0.0;
         this.m_bias = C * step.dt * k * this.m_gamma;
         this.m_mass = invMass + this.m_gamma;
         this.m_mass = this.m_mass != 0.0 ? 1.0 / this.m_mass : 0.0;
      }
      if (step.warmStarting) {
         this.m_impulse *= step.dtRatio;
         var PX = this.m_impulse * this.m_u.x;
         var PY = this.m_impulse * this.m_u.y;
         bA.m_linearVelocity.x -= bA.m_invMass * PX;
         bA.m_linearVelocity.y -= bA.m_invMass * PY;
         bA.m_angularVelocity -= bA.m_invI * (r1X * PY - r1Y * PX);
         bB.m_linearVelocity.x += bB.m_invMass * PX;
         bB.m_linearVelocity.y += bB.m_invMass * PY;
         bB.m_angularVelocity += bB.m_invI * (r2X * PY - r2Y * PX);
      }
      else {
         this.m_impulse = 0.0;
      }
   }
   b2DistanceJoint.prototype.SolveVelocityConstraints = function (step) {
      var tMat;
      var bA = this.m_bodyA;
      var bB = this.m_bodyB;
      tMat = bA.m_xf.R;
      var r1X = this.m_localAnchor1.x - bA.m_sweep.localCenter.x;
      var r1Y = this.m_localAnchor1.y - bA.m_sweep.localCenter.y;
      var tX = (tMat.col1.x * r1X + tMat.col2.x * r1Y);
      r1Y = (tMat.col1.y * r1X + tMat.col2.y * r1Y);
      r1X = tX;
      tMat = bB.m_xf.R;
      var r2X = this.m_localAnchor2.x - bB.m_sweep.localCenter.x;
      var r2Y = this.m_localAnchor2.y - bB.m_sweep.localCenter.y;
      tX = (tMat.col1.x * r2X + tMat.col2.x * r2Y);
      r2Y = (tMat.col1.y * r2X + tMat.col2.y * r2Y);
      r2X = tX;
      var v1X = bA.m_linearVelocity.x + ((-bA.m_angularVelocity * r1Y));
      var v1Y = bA.m_linearVelocity.y + (bA.m_angularVelocity * r1X);
      var v2X = bB.m_linearVelocity.x + ((-bB.m_angularVelocity * r2Y));
      var v2Y = bB.m_linearVelocity.y + (bB.m_angularVelocity * r2X);
      var Cdot = (this.m_u.x * (v2X - v1X) + this.m_u.y * (v2Y - v1Y));
      var impulse = (-this.m_mass * (Cdot + this.m_bias + this.m_gamma * this.m_impulse));
      this.m_impulse += impulse;
      var PX = impulse * this.m_u.x;
      var PY = impulse * this.m_u.y;
      bA.m_linearVelocity.x -= bA.m_invMass * PX;
      bA.m_linearVelocity.y -= bA.m_invMass * PY;
      bA.m_angularVelocity -= bA.m_invI * (r1X * PY - r1Y * PX);
      bB.m_linearVelocity.x += bB.m_invMass * PX;
      bB.m_linearVelocity.y += bB.m_invMass * PY;
      bB.m_angularVelocity += bB.m_invI * (r2X * PY - r2Y * PX);
   }
   b2DistanceJoint.prototype.SolvePositionConstraints = function (baumgarte) {
      if (baumgarte === undefined) baumgarte = 0;
      var tMat;
      if (this.m_frequencyHz > 0.0) {
         return true;
      }
      var bA = this.m_bodyA;
      var bB = this.m_bodyB;
      tMat = bA.m_xf.R;
      var r1X = this.m_localAnchor1.x - bA.m_sweep.localCenter.x;
      var r1Y = this.m_localAnchor1.y - bA.m_sweep.localCenter.y;
      var tX = (tMat.col1.x * r1X + tMat.col2.x * r1Y);
      r1Y = (tMat.col1.y * r1X + tMat.col2.y * r1Y);
      r1X = tX;
      tMat = bB.m_xf.R;
      var r2X = this.m_localAnchor2.x - bB.m_sweep.localCenter.x;
      var r2Y = this.m_localAnchor2.y - bB.m_sweep.localCenter.y;
      tX = (tMat.col1.x * r2X + tMat.col2.x * r2Y);
      r2Y = (tMat.col1.y * r2X + tMat.col2.y * r2Y);
      r2X = tX;
      var dX = bB.m_sweep.c.x + r2X - bA.m_sweep.c.x - r1X;
      var dY = bB.m_sweep.c.y + r2Y - bA.m_sweep.c.y - r1Y;
      var length = Math.sqrt(dX * dX + dY * dY);
      dX /= length;
      dY /= length;
      var C = length - this.m_length;
      C = b2Math.Clamp(C, (-b2Settings.b2_maxLinearCorrection), b2Settings.b2_maxLinearCorrection);
      var impulse = (-this.m_mass * C);
      this.m_u.Set(dX, dY);
      var PX = impulse * this.m_u.x;
      var PY = impulse * this.m_u.y;
      bA.m_sweep.c.x -= bA.m_invMass * PX;
      bA.m_sweep.c.y -= bA.m_invMass * PY;
      bA.m_sweep.a -= bA.m_invI * (r1X * PY - r1Y * PX);
      bB.m_sweep.c.x += bB.m_invMass * PX;
      bB.m_sweep.c.y += bB.m_invMass * PY;
      bB.m_sweep.a += bB.m_invI * (r2X * PY - r2Y * PX);
      bA.SynchronizeTransform();
      bB.SynchronizeTransform();
      return b2Math.Abs(C) < b2Settings.b2_linearSlop;
   }
   Box2D.inherit(b2DistanceJointDef, Box2D.Dynamics.Joints.b2JointDef);
   b2DistanceJointDef.prototype.__super = Box2D.Dynamics.Joints.b2JointDef.prototype;
   b2DistanceJointDef.b2DistanceJointDef = function () {
      Box2D.Dynamics.Joints.b2JointDef.b2JointDef.apply(this, arguments);
      this.localAnchorA = new b2Vec2();
      this.localAnchorB = new b2Vec2();
   };
   b2DistanceJointDef.prototype.b2DistanceJointDef = function () {
      this.__super.b2JointDef.call(this);
      this.type = b2Joint.e_distanceJoint;
      this.length = 1.0;
      this.frequencyHz = 0.0;
      this.dampingRatio = 0.0;
   }
   b2DistanceJointDef.prototype.Initialize = function (bA, bB, anchorA, anchorB) {
      this.bodyA = bA;
      this.bodyB = bB;
      this.localAnchorA.SetV(this.bodyA.GetLocalPoint(anchorA));
      this.localAnchorB.SetV(this.bodyB.GetLocalPoint(anchorB));
      var dX = anchorB.x - anchorA.x;
      var dY = anchorB.y - anchorA.y;
      this.length = Math.sqrt(dX * dX + dY * dY);
      this.frequencyHz = 0.0;
      this.dampingRatio = 0.0;
   }
   Box2D.inherit(b2FrictionJoint, Box2D.Dynamics.Joints.b2Joint);
   b2FrictionJoint.prototype.__super = Box2D.Dynamics.Joints.b2Joint.prototype;
   b2FrictionJoint.b2FrictionJoint = function () {
      Box2D.Dynamics.Joints.b2Joint.b2Joint.apply(this, arguments);
      this.m_localAnchorA = new b2Vec2();
      this.m_localAnchorB = new b2Vec2();
      this.m_linearMass = new b2Mat22();
      this.m_linearImpulse = new b2Vec2();
   };
   b2FrictionJoint.prototype.GetAnchorA = function () {
      return this.m_bodyA.GetWorldPoint(this.m_localAnchorA);
   }
   b2FrictionJoint.prototype.GetAnchorB = function () {
      return this.m_bodyB.GetWorldPoint(this.m_localAnchorB);
   }
   b2FrictionJoint.prototype.GetReactionForce = function (inv_dt) {
      if (inv_dt === undefined) inv_dt = 0;
      return new b2Vec2(inv_dt * this.m_linearImpulse.x, inv_dt * this.m_linearImpulse.y);
   }
   b2FrictionJoint.prototype.GetReactionTorque = function (inv_dt) {
      if (inv_dt === undefined) inv_dt = 0;
      return inv_dt * this.m_angularImpulse;
   }
   b2FrictionJoint.prototype.SetMaxForce = function (force) {
      if (force === undefined) force = 0;
      this.m_maxForce = force;
   }
   b2FrictionJoint.prototype.GetMaxForce = function () {
      return this.m_maxForce;
   }
   b2FrictionJoint.prototype.SetMaxTorque = function (torque) {
      if (torque === undefined) torque = 0;
      this.m_maxTorque = torque;
   }
   b2FrictionJoint.prototype.GetMaxTorque = function () {
      return this.m_maxTorque;
   }
   b2FrictionJoint.prototype.b2FrictionJoint = function (def) {
      this.__super.b2Joint.call(this, def);
      this.m_localAnchorA.SetV(def.localAnchorA);
      this.m_localAnchorB.SetV(def.localAnchorB);
      this.m_linearMass.SetZero();
      this.m_angularMass = 0.0;
      this.m_linearImpulse.SetZero();
      this.m_angularImpulse = 0.0;
      this.m_maxForce = def.maxForce;
      this.m_maxTorque = def.maxTorque;
   }
   b2FrictionJoint.prototype.InitVelocityConstraints = function (step) {
      var tMat;
      var tX = 0;
      var bA = this.m_bodyA;
      var bB = this.m_bodyB;
      tMat = bA.m_xf.R;
      var rAX = this.m_localAnchorA.x - bA.m_sweep.localCenter.x;
      var rAY = this.m_localAnchorA.y - bA.m_sweep.localCenter.y;
      tX = (tMat.col1.x * rAX + tMat.col2.x * rAY);
      rAY = (tMat.col1.y * rAX + tMat.col2.y * rAY);
      rAX = tX;
      tMat = bB.m_xf.R;
      var rBX = this.m_localAnchorB.x - bB.m_sweep.localCenter.x;
      var rBY = this.m_localAnchorB.y - bB.m_sweep.localCenter.y;
      tX = (tMat.col1.x * rBX + tMat.col2.x * rBY);
      rBY = (tMat.col1.y * rBX + tMat.col2.y * rBY);
      rBX = tX;
      var mA = bA.m_invMass;
      var mB = bB.m_invMass;
      var iA = bA.m_invI;
      var iB = bB.m_invI;
      var K = new b2Mat22();
      K.col1.x = mA + mB;
      K.col2.x = 0.0;
      K.col1.y = 0.0;
      K.col2.y = mA + mB;
      K.col1.x += iA * rAY * rAY;
      K.col2.x += (-iA * rAX * rAY);
      K.col1.y += (-iA * rAX * rAY);
      K.col2.y += iA * rAX * rAX;
      K.col1.x += iB * rBY * rBY;
      K.col2.x += (-iB * rBX * rBY);
      K.col1.y += (-iB * rBX * rBY);
      K.col2.y += iB * rBX * rBX;
      K.GetInverse(this.m_linearMass);
      this.m_angularMass = iA + iB;
      if (this.m_angularMass > 0.0) {
         this.m_angularMass = 1.0 / this.m_angularMass;
      }
      if (step.warmStarting) {
         this.m_linearImpulse.x *= step.dtRatio;
         this.m_linearImpulse.y *= step.dtRatio;
         this.m_angularImpulse *= step.dtRatio;
         var P = this.m_linearImpulse;
         bA.m_linearVelocity.x -= mA * P.x;
         bA.m_linearVelocity.y -= mA * P.y;
         bA.m_angularVelocity -= iA * (rAX * P.y - rAY * P.x + this.m_angularImpulse);
         bB.m_linearVelocity.x += mB * P.x;
         bB.m_linearVelocity.y += mB * P.y;
         bB.m_angularVelocity += iB * (rBX * P.y - rBY * P.x + this.m_angularImpulse);
      }
      else {
         this.m_linearImpulse.SetZero();
         this.m_angularImpulse = 0.0;
      }
   }
   b2FrictionJoint.prototype.SolveVelocityConstraints = function (step) {
      var tMat;
      var tX = 0;
      var bA = this.m_bodyA;
      var bB = this.m_bodyB;
      var vA = bA.m_linearVelocity;
      var wA = bA.m_angularVelocity;
      var vB = bB.m_linearVelocity;
      var wB = bB.m_angularVelocity;
      var mA = bA.m_invMass;
      var mB = bB.m_invMass;
      var iA = bA.m_invI;
      var iB = bB.m_invI;
      tMat = bA.m_xf.R;
      var rAX = this.m_localAnchorA.x - bA.m_sweep.localCenter.x;
      var rAY = this.m_localAnchorA.y - bA.m_sweep.localCenter.y;
      tX = (tMat.col1.x * rAX + tMat.col2.x * rAY);
      rAY = (tMat.col1.y * rAX + tMat.col2.y * rAY);
      rAX = tX;
      tMat = bB.m_xf.R;
      var rBX = this.m_localAnchorB.x - bB.m_sweep.localCenter.x;
      var rBY = this.m_localAnchorB.y - bB.m_sweep.localCenter.y;
      tX = (tMat.col1.x * rBX + tMat.col2.x * rBY);
      rBY = (tMat.col1.y * rBX + tMat.col2.y * rBY);
      rBX = tX;
      var maxImpulse = 0; {
         var Cdot = wB - wA;
         var impulse = (-this.m_angularMass * Cdot);
         var oldImpulse = this.m_angularImpulse;
         maxImpulse = step.dt * this.m_maxTorque;
         this.m_angularImpulse = b2Math.Clamp(this.m_angularImpulse + impulse, (-maxImpulse), maxImpulse);
         impulse = this.m_angularImpulse - oldImpulse;
         wA -= iA * impulse;
         wB += iB * impulse;
      } {
         var CdotX = vB.x - wB * rBY - vA.x + wA * rAY;
         var CdotY = vB.y + wB * rBX - vA.y - wA * rAX;
         var impulseV = b2Math.MulMV(this.m_linearMass, new b2Vec2((-CdotX), (-CdotY)));
         var oldImpulseV = this.m_linearImpulse.Copy();
         this.m_linearImpulse.Add(impulseV);
         maxImpulse = step.dt * this.m_maxForce;
         if (this.m_linearImpulse.LengthSquared() > maxImpulse * maxImpulse) {
            this.m_linearImpulse.Normalize();
            this.m_linearImpulse.Multiply(maxImpulse);
         }
         impulseV = b2Math.SubtractVV(this.m_linearImpulse, oldImpulseV);
         vA.x -= mA * impulseV.x;
         vA.y -= mA * impulseV.y;
         wA -= iA * (rAX * impulseV.y - rAY * impulseV.x);
         vB.x += mB * impulseV.x;
         vB.y += mB * impulseV.y;
         wB += iB * (rBX * impulseV.y - rBY * impulseV.x);
      }
      bA.m_angularVelocity = wA;
      bB.m_angularVelocity = wB;
   }
   b2FrictionJoint.prototype.SolvePositionConstraints = function (baumgarte) {
      if (baumgarte === undefined) baumgarte = 0;
      return true;
   }
   Box2D.inherit(b2FrictionJointDef, Box2D.Dynamics.Joints.b2JointDef);
   b2FrictionJointDef.prototype.__super = Box2D.Dynamics.Joints.b2JointDef.prototype;
   b2FrictionJointDef.b2FrictionJointDef = function () {
      Box2D.Dynamics.Joints.b2JointDef.b2JointDef.apply(this, arguments);
      this.localAnchorA = new b2Vec2();
      this.localAnchorB = new b2Vec2();
   };
   b2FrictionJointDef.prototype.b2FrictionJointDef = function () {
      this.__super.b2JointDef.call(this);
      this.type = b2Joint.e_frictionJoint;
      this.maxForce = 0.0;
      this.maxTorque = 0.0;
   }
   b2FrictionJointDef.prototype.Initialize = function (bA, bB, anchor) {
      this.bodyA = bA;
      this.bodyB = bB;
      this.localAnchorA.SetV(this.bodyA.GetLocalPoint(anchor));
      this.localAnchorB.SetV(this.bodyB.GetLocalPoint(anchor));
   }
   Box2D.inherit(b2GearJoint, Box2D.Dynamics.Joints.b2Joint);
   b2GearJoint.prototype.__super = Box2D.Dynamics.Joints.b2Joint.prototype;
   b2GearJoint.b2GearJoint = function () {
      Box2D.Dynamics.Joints.b2Joint.b2Joint.apply(this, arguments);
      this.m_groundAnchor1 = new b2Vec2();
      this.m_groundAnchor2 = new b2Vec2();
      this.m_localAnchor1 = new b2Vec2();
      this.m_localAnchor2 = new b2Vec2();
      this.m_J = new b2Jacobian();
   };
   b2GearJoint.prototype.GetAnchorA = function () {
      return this.m_bodyA.GetWorldPoint(this.m_localAnchor1);
   }
   b2GearJoint.prototype.GetAnchorB = function () {
      return this.m_bodyB.GetWorldPoint(this.m_localAnchor2);
   }
   b2GearJoint.prototype.GetReactionForce = function (inv_dt) {
      if (inv_dt === undefined) inv_dt = 0;
      return new b2Vec2(inv_dt * this.m_impulse * this.m_J.linearB.x, inv_dt * this.m_impulse * this.m_J.linearB.y);
   }
   b2GearJoint.prototype.GetReactionTorque = function (inv_dt) {
      if (inv_dt === undefined) inv_dt = 0;
      var tMat = this.m_bodyB.m_xf.R;
      var rX = this.m_localAnchor1.x - this.m_bodyB.m_sweep.localCenter.x;
      var rY = this.m_localAnchor1.y - this.m_bodyB.m_sweep.localCenter.y;
      var tX = tMat.col1.x * rX + tMat.col2.x * rY;
      rY = tMat.col1.y * rX + tMat.col2.y * rY;
      rX = tX;
      var PX = this.m_impulse * this.m_J.linearB.x;
      var PY = this.m_impulse * this.m_J.linearB.y;
      return inv_dt * (this.m_impulse * this.m_J.angularB - rX * PY + rY * PX);
   }
   b2GearJoint.prototype.GetRatio = function () {
      return this.m_ratio;
   }
   b2GearJoint.prototype.SetRatio = function (ratio) {
      if (ratio === undefined) ratio = 0;
      this.m_ratio = ratio;
   }
   b2GearJoint.prototype.b2GearJoint = function (def) {
      this.__super.b2Joint.call(this, def);
      var type1 = parseInt(def.joint1.m_type);
      var type2 = parseInt(def.joint2.m_type);
      this.m_revolute1 = null;
      this.m_prismatic1 = null;
      this.m_revolute2 = null;
      this.m_prismatic2 = null;
      var coordinate1 = 0;
      var coordinate2 = 0;
      this.m_ground1 = def.joint1.GetBodyA();
      this.m_bodyA = def.joint1.GetBodyB();
      if (type1 == b2Joint.e_revoluteJoint) {
         this.m_revolute1 = (def.joint1 instanceof b2RevoluteJoint ? def.joint1 : null);
         this.m_groundAnchor1.SetV(this.m_revolute1.m_localAnchor1);
         this.m_localAnchor1.SetV(this.m_revolute1.m_localAnchor2);
         coordinate1 = this.m_revolute1.GetJointAngle();
      }
      else {
         this.m_prismatic1 = (def.joint1 instanceof b2PrismaticJoint ? def.joint1 : null);
         this.m_groundAnchor1.SetV(this.m_prismatic1.m_localAnchor1);
         this.m_localAnchor1.SetV(this.m_prismatic1.m_localAnchor2);
         coordinate1 = this.m_prismatic1.GetJointTranslation();
      }
      this.m_ground2 = def.joint2.GetBodyA();
      this.m_bodyB = def.joint2.GetBodyB();
      if (type2 == b2Joint.e_revoluteJoint) {
         this.m_revolute2 = (def.joint2 instanceof b2RevoluteJoint ? def.joint2 : null);
         this.m_groundAnchor2.SetV(this.m_revolute2.m_localAnchor1);
         this.m_localAnchor2.SetV(this.m_revolute2.m_localAnchor2);
         coordinate2 = this.m_revolute2.GetJointAngle();
      }
      else {
         this.m_prismatic2 = (def.joint2 instanceof b2PrismaticJoint ? def.joint2 : null);
         this.m_groundAnchor2.SetV(this.m_prismatic2.m_localAnchor1);
         this.m_localAnchor2.SetV(this.m_prismatic2.m_localAnchor2);
         coordinate2 = this.m_prismatic2.GetJointTranslation();
      }
      this.m_ratio = def.ratio;
      this.m_constant = coordinate1 + this.m_ratio * coordinate2;
      this.m_impulse = 0.0;
   }
   b2GearJoint.prototype.InitVelocityConstraints = function (step) {
      var g1 = this.m_ground1;
      var g2 = this.m_ground2;
      var bA = this.m_bodyA;
      var bB = this.m_bodyB;
      var ugX = 0;
      var ugY = 0;
      var rX = 0;
      var rY = 0;
      var tMat;
      var tVec;
      var crug = 0;
      var tX = 0;
      var K = 0.0;
      this.m_J.SetZero();
      if (this.m_revolute1) {
         this.m_J.angularA = (-1.0);
         K += bA.m_invI;
      }
      else {
         tMat = g1.m_xf.R;
         tVec = this.m_prismatic1.m_localXAxis1;
         ugX = tMat.col1.x * tVec.x + tMat.col2.x * tVec.y;
         ugY = tMat.col1.y * tVec.x + tMat.col2.y * tVec.y;
         tMat = bA.m_xf.R;
         rX = this.m_localAnchor1.x - bA.m_sweep.localCenter.x;
         rY = this.m_localAnchor1.y - bA.m_sweep.localCenter.y;
         tX = tMat.col1.x * rX + tMat.col2.x * rY;
         rY = tMat.col1.y * rX + tMat.col2.y * rY;
         rX = tX;
         crug = rX * ugY - rY * ugX;
         this.m_J.linearA.Set((-ugX), (-ugY));
         this.m_J.angularA = (-crug);
         K += bA.m_invMass + bA.m_invI * crug * crug;
      }
      if (this.m_revolute2) {
         this.m_J.angularB = (-this.m_ratio);
         K += this.m_ratio * this.m_ratio * bB.m_invI;
      }
      else {
         tMat = g2.m_xf.R;
         tVec = this.m_prismatic2.m_localXAxis1;
         ugX = tMat.col1.x * tVec.x + tMat.col2.x * tVec.y;
         ugY = tMat.col1.y * tVec.x + tMat.col2.y * tVec.y;
         tMat = bB.m_xf.R;
         rX = this.m_localAnchor2.x - bB.m_sweep.localCenter.x;
         rY = this.m_localAnchor2.y - bB.m_sweep.localCenter.y;
         tX = tMat.col1.x * rX + tMat.col2.x * rY;
         rY = tMat.col1.y * rX + tMat.col2.y * rY;
         rX = tX;
         crug = rX * ugY - rY * ugX;
         this.m_J.linearB.Set((-this.m_ratio * ugX), (-this.m_ratio * ugY));
         this.m_J.angularB = (-this.m_ratio * crug);
         K += this.m_ratio * this.m_ratio * (bB.m_invMass + bB.m_invI * crug * crug);
      }
      this.m_mass = K > 0.0 ? 1.0 / K : 0.0;
      if (step.warmStarting) {
         bA.m_linearVelocity.x += bA.m_invMass * this.m_impulse * this.m_J.linearA.x;
         bA.m_linearVelocity.y += bA.m_invMass * this.m_impulse * this.m_J.linearA.y;
         bA.m_angularVelocity += bA.m_invI * this.m_impulse * this.m_J.angularA;
         bB.m_linearVelocity.x += bB.m_invMass * this.m_impulse * this.m_J.linearB.x;
         bB.m_linearVelocity.y += bB.m_invMass * this.m_impulse * this.m_J.linearB.y;
         bB.m_angularVelocity += bB.m_invI * this.m_impulse * this.m_J.angularB;
      }
      else {
         this.m_impulse = 0.0;
      }
   }
   b2GearJoint.prototype.SolveVelocityConstraints = function (step) {
      var bA = this.m_bodyA;
      var bB = this.m_bodyB;
      var Cdot = this.m_J.Compute(bA.m_linearVelocity, bA.m_angularVelocity, bB.m_linearVelocity, bB.m_angularVelocity);
      var impulse = (-this.m_mass * Cdot);
      this.m_impulse += impulse;
      bA.m_linearVelocity.x += bA.m_invMass * impulse * this.m_J.linearA.x;
      bA.m_linearVelocity.y += bA.m_invMass * impulse * this.m_J.linearA.y;
      bA.m_angularVelocity += bA.m_invI * impulse * this.m_J.angularA;
      bB.m_linearVelocity.x += bB.m_invMass * impulse * this.m_J.linearB.x;
      bB.m_linearVelocity.y += bB.m_invMass * impulse * this.m_J.linearB.y;
      bB.m_angularVelocity += bB.m_invI * impulse * this.m_J.angularB;
   }
   b2GearJoint.prototype.SolvePositionConstraints = function (baumgarte) {
      if (baumgarte === undefined) baumgarte = 0;
      var linearError = 0.0;
      var bA = this.m_bodyA;
      var bB = this.m_bodyB;
      var coordinate1 = 0;
      var coordinate2 = 0;
      if (this.m_revolute1) {
         coordinate1 = this.m_revolute1.GetJointAngle();
      }
      else {
         coordinate1 = this.m_prismatic1.GetJointTranslation();
      }
      if (this.m_revolute2) {
         coordinate2 = this.m_revolute2.GetJointAngle();
      }
      else {
         coordinate2 = this.m_prismatic2.GetJointTranslation();
      }
      var C = this.m_constant - (coordinate1 + this.m_ratio * coordinate2);
      var impulse = (-this.m_mass * C);
      bA.m_sweep.c.x += bA.m_invMass * impulse * this.m_J.linearA.x;
      bA.m_sweep.c.y += bA.m_invMass * impulse * this.m_J.linearA.y;
      bA.m_sweep.a += bA.m_invI * impulse * this.m_J.angularA;
      bB.m_sweep.c.x += bB.m_invMass * impulse * this.m_J.linearB.x;
      bB.m_sweep.c.y += bB.m_invMass * impulse * this.m_J.linearB.y;
      bB.m_sweep.a += bB.m_invI * impulse * this.m_J.angularB;
      bA.SynchronizeTransform();
      bB.SynchronizeTransform();
      return linearError < b2Settings.b2_linearSlop;
   }
   Box2D.inherit(b2GearJointDef, Box2D.Dynamics.Joints.b2JointDef);
   b2GearJointDef.prototype.__super = Box2D.Dynamics.Joints.b2JointDef.prototype;
   b2GearJointDef.b2GearJointDef = function () {
      Box2D.Dynamics.Joints.b2JointDef.b2JointDef.apply(this, arguments);
   };
   b2GearJointDef.prototype.b2GearJointDef = function () {
      this.__super.b2JointDef.call(this);
      this.type = b2Joint.e_gearJoint;
      this.joint1 = null;
      this.joint2 = null;
      this.ratio = 1.0;
   }
   b2Jacobian.b2Jacobian = function () {
      this.linearA = new b2Vec2();
      this.linearB = new b2Vec2();
   };
   b2Jacobian.prototype.SetZero = function () {
      this.linearA.SetZero();
      this.angularA = 0.0;
      this.linearB.SetZero();
      this.angularB = 0.0;
   }
   b2Jacobian.prototype.Set = function (x1, a1, x2, a2) {
      if (a1 === undefined) a1 = 0;
      if (a2 === undefined) a2 = 0;
      this.linearA.SetV(x1);
      this.angularA = a1;
      this.linearB.SetV(x2);
      this.angularB = a2;
   }
   b2Jacobian.prototype.Compute = function (x1, a1, x2, a2) {
      if (a1 === undefined) a1 = 0;
      if (a2 === undefined) a2 = 0;
      return (this.linearA.x * x1.x + this.linearA.y * x1.y) + this.angularA * a1 + (this.linearB.x * x2.x + this.linearB.y * x2.y) + this.angularB * a2;
   }
   b2Joint.b2Joint = function () {
      this.m_edgeA = new b2JointEdge();
      this.m_edgeB = new b2JointEdge();
      this.m_localCenterA = new b2Vec2();
      this.m_localCenterB = new b2Vec2();
   };
   b2Joint.prototype.GetType = function () {
      return this.m_type;
   }
   b2Joint.prototype.GetAnchorA = function () {
      return null;
   }
   b2Joint.prototype.GetAnchorB = function () {
      return null;
   }
   b2Joint.prototype.GetReactionForce = function (inv_dt) {
      if (inv_dt === undefined) inv_dt = 0;
      return null;
   }
   b2Joint.prototype.GetReactionTorque = function (inv_dt) {
      if (inv_dt === undefined) inv_dt = 0;
      return 0.0;
   }
   b2Joint.prototype.GetBodyA = function () {
      return this.m_bodyA;
   }
   b2Joint.prototype.GetBodyB = function () {
      return this.m_bodyB;
   }
   b2Joint.prototype.GetNext = function () {
      return this.m_next;
   }
   b2Joint.prototype.GetUserData = function () {
      return this.m_userData;
   }
   b2Joint.prototype.SetUserData = function (data) {
      this.m_userData = data;
   }
   b2Joint.prototype.IsActive = function () {
      return this.m_bodyA.IsActive() && this.m_bodyB.IsActive();
   }
   b2Joint.Create = function (def, allocator) {
      var joint = null;
      switch (def.type) {
      case b2Joint.e_distanceJoint:
         {
            joint = new b2DistanceJoint((def instanceof b2DistanceJointDef ? def : null));
         }
         break;
      case b2Joint.e_mouseJoint:
         {
            joint = new b2MouseJoint((def instanceof b2MouseJointDef ? def : null));
         }
         break;
      case b2Joint.e_prismaticJoint:
         {
            joint = new b2PrismaticJoint((def instanceof b2PrismaticJointDef ? def : null));
         }
         break;
      case b2Joint.e_revoluteJoint:
         {
            joint = new b2RevoluteJoint((def instanceof b2RevoluteJointDef ? def : null));
         }
         break;
      case b2Joint.e_pulleyJoint:
         {
            joint = new b2PulleyJoint((def instanceof b2PulleyJointDef ? def : null));
         }
         break;
      case b2Joint.e_gearJoint:
         {
            joint = new b2GearJoint((def instanceof b2GearJointDef ? def : null));
         }
         break;
      case b2Joint.e_lineJoint:
         {
            joint = new b2LineJoint((def instanceof b2LineJointDef ? def : null));
         }
         break;
      case b2Joint.e_weldJoint:
         {
            joint = new b2WeldJoint((def instanceof b2WeldJointDef ? def : null));
         }
         break;
      case b2Joint.e_frictionJoint:
         {
            joint = new b2FrictionJoint((def instanceof b2FrictionJointDef ? def : null));
         }
         break;
      default:
         break;
      }
      return joint;
   }
   b2Joint.Destroy = function (joint, allocator) {}
   b2Joint.prototype.b2Joint = function (def) {
      b2Settings.b2Assert(def.bodyA != def.bodyB);
      this.m_type = def.type;
      this.m_prev = null;
      this.m_next = null;
      this.m_bodyA = def.bodyA;
      this.m_bodyB = def.bodyB;
      this.m_collideConnected = def.collideConnected;
      this.m_islandFlag = false;
      this.m_userData = def.userData;
   }
   b2Joint.prototype.InitVelocityConstraints = function (step) {}
   b2Joint.prototype.SolveVelocityConstraints = function (step) {}
   b2Joint.prototype.FinalizeVelocityConstraints = function () {}
   b2Joint.prototype.SolvePositionConstraints = function (baumgarte) {
      if (baumgarte === undefined) baumgarte = 0;
      return false;
   }
   Box2D.postDefs.push(function () {
      Box2D.Dynamics.Joints.b2Joint.e_unknownJoint = 0;
      Box2D.Dynamics.Joints.b2Joint.e_revoluteJoint = 1;
      Box2D.Dynamics.Joints.b2Joint.e_prismaticJoint = 2;
      Box2D.Dynamics.Joints.b2Joint.e_distanceJoint = 3;
      Box2D.Dynamics.Joints.b2Joint.e_pulleyJoint = 4;
      Box2D.Dynamics.Joints.b2Joint.e_mouseJoint = 5;
      Box2D.Dynamics.Joints.b2Joint.e_gearJoint = 6;
      Box2D.Dynamics.Joints.b2Joint.e_lineJoint = 7;
      Box2D.Dynamics.Joints.b2Joint.e_weldJoint = 8;
      Box2D.Dynamics.Joints.b2Joint.e_frictionJoint = 9;
      Box2D.Dynamics.Joints.b2Joint.e_inactiveLimit = 0;
      Box2D.Dynamics.Joints.b2Joint.e_atLowerLimit = 1;
      Box2D.Dynamics.Joints.b2Joint.e_atUpperLimit = 2;
      Box2D.Dynamics.Joints.b2Joint.e_equalLimits = 3;
   });
   b2JointDef.b2JointDef = function () {};
   b2JointDef.prototype.b2JointDef = function () {
      this.type = b2Joint.e_unknownJoint;
      this.userData = null;
      this.bodyA = null;
      this.bodyB = null;
      this.collideConnected = false;
   }
   b2JointEdge.b2JointEdge = function () {};
   Box2D.inherit(b2LineJoint, Box2D.Dynamics.Joints.b2Joint);
   b2LineJoint.prototype.__super = Box2D.Dynamics.Joints.b2Joint.prototype;
   b2LineJoint.b2LineJoint = function () {
      Box2D.Dynamics.Joints.b2Joint.b2Joint.apply(this, arguments);
      this.m_localAnchor1 = new b2Vec2();
      this.m_localAnchor2 = new b2Vec2();
      this.m_localXAxis1 = new b2Vec2();
      this.m_localYAxis1 = new b2Vec2();
      this.m_axis = new b2Vec2();
      this.m_perp = new b2Vec2();
      this.m_K = new b2Mat22();
      this.m_impulse = new b2Vec2();
   };
   b2LineJoint.prototype.GetAnchorA = function () {
      return this.m_bodyA.GetWorldPoint(this.m_localAnchor1);
   }
   b2LineJoint.prototype.GetAnchorB = function () {
      return this.m_bodyB.GetWorldPoint(this.m_localAnchor2);
   }
   b2LineJoint.prototype.GetReactionForce = function (inv_dt) {
      if (inv_dt === undefined) inv_dt = 0;
      return new b2Vec2(inv_dt * (this.m_impulse.x * this.m_perp.x + (this.m_motorImpulse + this.m_impulse.y) * this.m_axis.x), inv_dt * (this.m_impulse.x * this.m_perp.y + (this.m_motorImpulse + this.m_impulse.y) * this.m_axis.y));
   }
   b2LineJoint.prototype.GetReactionTorque = function (inv_dt) {
      if (inv_dt === undefined) inv_dt = 0;
      return inv_dt * this.m_impulse.y;
   }
   b2LineJoint.prototype.GetJointTranslation = function () {
      var bA = this.m_bodyA;
      var bB = this.m_bodyB;
      var tMat;
      var p1 = bA.GetWorldPoint(this.m_localAnchor1);
      var p2 = bB.GetWorldPoint(this.m_localAnchor2);
      var dX = p2.x - p1.x;
      var dY = p2.y - p1.y;
      var axis = bA.GetWorldVector(this.m_localXAxis1);
      var translation = axis.x * dX + axis.y * dY;
      return translation;
   }
   b2LineJoint.prototype.GetJointSpeed = function () {
      var bA = this.m_bodyA;
      var bB = this.m_bodyB;
      var tMat;
      tMat = bA.m_xf.R;
      var r1X = this.m_localAnchor1.x - bA.m_sweep.localCenter.x;
      var r1Y = this.m_localAnchor1.y - bA.m_sweep.localCenter.y;
      var tX = (tMat.col1.x * r1X + tMat.col2.x * r1Y);
      r1Y = (tMat.col1.y * r1X + tMat.col2.y * r1Y);
      r1X = tX;
      tMat = bB.m_xf.R;
      var r2X = this.m_localAnchor2.x - bB.m_sweep.localCenter.x;
      var r2Y = this.m_localAnchor2.y - bB.m_sweep.localCenter.y;
      tX = (tMat.col1.x * r2X + tMat.col2.x * r2Y);
      r2Y = (tMat.col1.y * r2X + tMat.col2.y * r2Y);
      r2X = tX;
      var p1X = bA.m_sweep.c.x + r1X;
      var p1Y = bA.m_sweep.c.y + r1Y;
      var p2X = bB.m_sweep.c.x + r2X;
      var p2Y = bB.m_sweep.c.y + r2Y;
      var dX = p2X - p1X;
      var dY = p2Y - p1Y;
      var axis = bA.GetWorldVector(this.m_localXAxis1);
      var v1 = bA.m_linearVelocity;
      var v2 = bB.m_linearVelocity;
      var w1 = bA.m_angularVelocity;
      var w2 = bB.m_angularVelocity;
      var speed = (dX * ((-w1 * axis.y)) + dY * (w1 * axis.x)) + (axis.x * (((v2.x + ((-w2 * r2Y))) - v1.x) - ((-w1 * r1Y))) + axis.y * (((v2.y + (w2 * r2X)) - v1.y) - (w1 * r1X)));
      return speed;
   }
   b2LineJoint.prototype.IsLimitEnabled = function () {
      return this.m_enableLimit;
   }
   b2LineJoint.prototype.EnableLimit = function (flag) {
      this.m_bodyA.SetAwake(true);
      this.m_bodyB.SetAwake(true);
      this.m_enableLimit = flag;
   }
   b2LineJoint.prototype.GetLowerLimit = function () {
      return this.m_lowerTranslation;
   }
   b2LineJoint.prototype.GetUpperLimit = function () {
      return this.m_upperTranslation;
   }
   b2LineJoint.prototype.SetLimits = function (lower, upper) {
      if (lower === undefined) lower = 0;
      if (upper === undefined) upper = 0;
      this.m_bodyA.SetAwake(true);
      this.m_bodyB.SetAwake(true);
      this.m_lowerTranslation = lower;
      this.m_upperTranslation = upper;
   }
   b2LineJoint.prototype.IsMotorEnabled = function () {
      return this.m_enableMotor;
   }
   b2LineJoint.prototype.EnableMotor = function (flag) {
      this.m_bodyA.SetAwake(true);
      this.m_bodyB.SetAwake(true);
      this.m_enableMotor = flag;
   }
   b2LineJoint.prototype.SetMotorSpeed = function (speed) {
      if (speed === undefined) speed = 0;
      this.m_bodyA.SetAwake(true);
      this.m_bodyB.SetAwake(true);
      this.m_motorSpeed = speed;
   }
   b2LineJoint.prototype.GetMotorSpeed = function () {
      return this.m_motorSpeed;
   }
   b2LineJoint.prototype.SetMaxMotorForce = function (force) {
      if (force === undefined) force = 0;
      this.m_bodyA.SetAwake(true);
      this.m_bodyB.SetAwake(true);
      this.m_maxMotorForce = force;
   }
   b2LineJoint.prototype.GetMaxMotorForce = function () {
      return this.m_maxMotorForce;
   }
   b2LineJoint.prototype.GetMotorForce = function () {
      return this.m_motorImpulse;
   }
   b2LineJoint.prototype.b2LineJoint = function (def) {
      this.__super.b2Joint.call(this, def);
      var tMat;
      var tX = 0;
      var tY = 0;
      this.m_localAnchor1.SetV(def.localAnchorA);
      this.m_localAnchor2.SetV(def.localAnchorB);
      this.m_localXAxis1.SetV(def.localAxisA);
      this.m_localYAxis1.x = (-this.m_localXAxis1.y);
      this.m_localYAxis1.y = this.m_localXAxis1.x;
      this.m_impulse.SetZero();
      this.m_motorMass = 0.0;
      this.m_motorImpulse = 0.0;
      this.m_lowerTranslation = def.lowerTranslation;
      this.m_upperTranslation = def.upperTranslation;
      this.m_maxMotorForce = def.maxMotorForce;
      this.m_motorSpeed = def.motorSpeed;
      this.m_enableLimit = def.enableLimit;
      this.m_enableMotor = def.enableMotor;
      this.m_limitState = b2Joint.e_inactiveLimit;
      this.m_axis.SetZero();
      this.m_perp.SetZero();
   }
   b2LineJoint.prototype.InitVelocityConstraints = function (step) {
      var bA = this.m_bodyA;
      var bB = this.m_bodyB;
      var tMat;
      var tX = 0;
      this.m_localCenterA.SetV(bA.GetLocalCenter());
      this.m_localCenterB.SetV(bB.GetLocalCenter());
      var xf1 = bA.GetTransform();
      var xf2 = bB.GetTransform();
      tMat = bA.m_xf.R;
      var r1X = this.m_localAnchor1.x - this.m_localCenterA.x;
      var r1Y = this.m_localAnchor1.y - this.m_localCenterA.y;
      tX = (tMat.col1.x * r1X + tMat.col2.x * r1Y);
      r1Y = (tMat.col1.y * r1X + tMat.col2.y * r1Y);
      r1X = tX;
      tMat = bB.m_xf.R;
      var r2X = this.m_localAnchor2.x - this.m_localCenterB.x;
      var r2Y = this.m_localAnchor2.y - this.m_localCenterB.y;
      tX = (tMat.col1.x * r2X + tMat.col2.x * r2Y);
      r2Y = (tMat.col1.y * r2X + tMat.col2.y * r2Y);
      r2X = tX;
      var dX = bB.m_sweep.c.x + r2X - bA.m_sweep.c.x - r1X;
      var dY = bB.m_sweep.c.y + r2Y - bA.m_sweep.c.y - r1Y;
      this.m_invMassA = bA.m_invMass;
      this.m_invMassB = bB.m_invMass;
      this.m_invIA = bA.m_invI;
      this.m_invIB = bB.m_invI; {
         this.m_axis.SetV(b2Math.MulMV(xf1.R, this.m_localXAxis1));
         this.m_a1 = (dX + r1X) * this.m_axis.y - (dY + r1Y) * this.m_axis.x;
         this.m_a2 = r2X * this.m_axis.y - r2Y * this.m_axis.x;
         this.m_motorMass = this.m_invMassA + this.m_invMassB + this.m_invIA * this.m_a1 * this.m_a1 + this.m_invIB * this.m_a2 * this.m_a2;
         this.m_motorMass = this.m_motorMass > Number.MIN_VALUE ? 1.0 / this.m_motorMass : 0.0;
      } {
         this.m_perp.SetV(b2Math.MulMV(xf1.R, this.m_localYAxis1));
         this.m_s1 = (dX + r1X) * this.m_perp.y - (dY + r1Y) * this.m_perp.x;
         this.m_s2 = r2X * this.m_perp.y - r2Y * this.m_perp.x;
         var m1 = this.m_invMassA;
         var m2 = this.m_invMassB;
         var i1 = this.m_invIA;
         var i2 = this.m_invIB;
         this.m_K.col1.x = m1 + m2 + i1 * this.m_s1 * this.m_s1 + i2 * this.m_s2 * this.m_s2;
         this.m_K.col1.y = i1 * this.m_s1 * this.m_a1 + i2 * this.m_s2 * this.m_a2;
         this.m_K.col2.x = this.m_K.col1.y;
         this.m_K.col2.y = m1 + m2 + i1 * this.m_a1 * this.m_a1 + i2 * this.m_a2 * this.m_a2;
      }
      if (this.m_enableLimit) {
         var jointTransition = this.m_axis.x * dX + this.m_axis.y * dY;
         if (b2Math.Abs(this.m_upperTranslation - this.m_lowerTranslation) < 2.0 * b2Settings.b2_linearSlop) {
            this.m_limitState = b2Joint.e_equalLimits;
         }
         else if (jointTransition <= this.m_lowerTranslation) {
            if (this.m_limitState != b2Joint.e_atLowerLimit) {
               this.m_limitState = b2Joint.e_atLowerLimit;
               this.m_impulse.y = 0.0;
            }
         }
         else if (jointTransition >= this.m_upperTranslation) {
            if (this.m_limitState != b2Joint.e_atUpperLimit) {
               this.m_limitState = b2Joint.e_atUpperLimit;
               this.m_impulse.y = 0.0;
            }
         }
         else {
            this.m_limitState = b2Joint.e_inactiveLimit;
            this.m_impulse.y = 0.0;
         }
      }
      else {
         this.m_limitState = b2Joint.e_inactiveLimit;
      }
      if (this.m_enableMotor == false) {
         this.m_motorImpulse = 0.0;
      }
      if (step.warmStarting) {
         this.m_impulse.x *= step.dtRatio;
         this.m_impulse.y *= step.dtRatio;
         this.m_motorImpulse *= step.dtRatio;
         var PX = this.m_impulse.x * this.m_perp.x + (this.m_motorImpulse + this.m_impulse.y) * this.m_axis.x;
         var PY = this.m_impulse.x * this.m_perp.y + (this.m_motorImpulse + this.m_impulse.y) * this.m_axis.y;
         var L1 = this.m_impulse.x * this.m_s1 + (this.m_motorImpulse + this.m_impulse.y) * this.m_a1;
         var L2 = this.m_impulse.x * this.m_s2 + (this.m_motorImpulse + this.m_impulse.y) * this.m_a2;
         bA.m_linearVelocity.x -= this.m_invMassA * PX;
         bA.m_linearVelocity.y -= this.m_invMassA * PY;
         bA.m_angularVelocity -= this.m_invIA * L1;
         bB.m_linearVelocity.x += this.m_invMassB * PX;
         bB.m_linearVelocity.y += this.m_invMassB * PY;
         bB.m_angularVelocity += this.m_invIB * L2;
      }
      else {
         this.m_impulse.SetZero();
         this.m_motorImpulse = 0.0;
      }
   }
   b2LineJoint.prototype.SolveVelocityConstraints = function (step) {
      var bA = this.m_bodyA;
      var bB = this.m_bodyB;
      var v1 = bA.m_linearVelocity;
      var w1 = bA.m_angularVelocity;
      var v2 = bB.m_linearVelocity;
      var w2 = bB.m_angularVelocity;
      var PX = 0;
      var PY = 0;
      var L1 = 0;
      var L2 = 0;
      if (this.m_enableMotor && this.m_limitState != b2Joint.e_equalLimits) {
         var Cdot = this.m_axis.x * (v2.x - v1.x) + this.m_axis.y * (v2.y - v1.y) + this.m_a2 * w2 - this.m_a1 * w1;
         var impulse = this.m_motorMass * (this.m_motorSpeed - Cdot);
         var oldImpulse = this.m_motorImpulse;
         var maxImpulse = step.dt * this.m_maxMotorForce;
         this.m_motorImpulse = b2Math.Clamp(this.m_motorImpulse + impulse, (-maxImpulse), maxImpulse);
         impulse = this.m_motorImpulse - oldImpulse;
         PX = impulse * this.m_axis.x;
         PY = impulse * this.m_axis.y;
         L1 = impulse * this.m_a1;
         L2 = impulse * this.m_a2;
         v1.x -= this.m_invMassA * PX;
         v1.y -= this.m_invMassA * PY;
         w1 -= this.m_invIA * L1;
         v2.x += this.m_invMassB * PX;
         v2.y += this.m_invMassB * PY;
         w2 += this.m_invIB * L2;
      }
      var Cdot1 = this.m_perp.x * (v2.x - v1.x) + this.m_perp.y * (v2.y - v1.y) + this.m_s2 * w2 - this.m_s1 * w1;
      if (this.m_enableLimit && this.m_limitState != b2Joint.e_inactiveLimit) {
         var Cdot2 = this.m_axis.x * (v2.x - v1.x) + this.m_axis.y * (v2.y - v1.y) + this.m_a2 * w2 - this.m_a1 * w1;
         var f1 = this.m_impulse.Copy();
         var df = this.m_K.Solve(new b2Vec2(), (-Cdot1), (-Cdot2));
         this.m_impulse.Add(df);
         if (this.m_limitState == b2Joint.e_atLowerLimit) {
            this.m_impulse.y = b2Math.Max(this.m_impulse.y, 0.0);
         }
         else if (this.m_limitState == b2Joint.e_atUpperLimit) {
            this.m_impulse.y = b2Math.Min(this.m_impulse.y, 0.0);
         }
         var b = (-Cdot1) - (this.m_impulse.y - f1.y) * this.m_K.col2.x;
         var f2r = 0;
         if (this.m_K.col1.x != 0.0) {
            f2r = b / this.m_K.col1.x + f1.x;
         }
         else {
            f2r = f1.x;
         }
         this.m_impulse.x = f2r;
         df.x = this.m_impulse.x - f1.x;
         df.y = this.m_impulse.y - f1.y;
         PX = df.x * this.m_perp.x + df.y * this.m_axis.x;
         PY = df.x * this.m_perp.y + df.y * this.m_axis.y;
         L1 = df.x * this.m_s1 + df.y * this.m_a1;
         L2 = df.x * this.m_s2 + df.y * this.m_a2;
         v1.x -= this.m_invMassA * PX;
         v1.y -= this.m_invMassA * PY;
         w1 -= this.m_invIA * L1;
         v2.x += this.m_invMassB * PX;
         v2.y += this.m_invMassB * PY;
         w2 += this.m_invIB * L2;
      }
      else {
         var df2 = 0;
         if (this.m_K.col1.x != 0.0) {
            df2 = ((-Cdot1)) / this.m_K.col1.x;
         }
         else {
            df2 = 0.0;
         }
         this.m_impulse.x += df2;
         PX = df2 * this.m_perp.x;
         PY = df2 * this.m_perp.y;
         L1 = df2 * this.m_s1;
         L2 = df2 * this.m_s2;
         v1.x -= this.m_invMassA * PX;
         v1.y -= this.m_invMassA * PY;
         w1 -= this.m_invIA * L1;
         v2.x += this.m_invMassB * PX;
         v2.y += this.m_invMassB * PY;
         w2 += this.m_invIB * L2;
      }
      bA.m_linearVelocity.SetV(v1);
      bA.m_angularVelocity = w1;
      bB.m_linearVelocity.SetV(v2);
      bB.m_angularVelocity = w2;
   }
   b2LineJoint.prototype.SolvePositionConstraints = function (baumgarte) {
      if (baumgarte === undefined) baumgarte = 0;
      var limitC = 0;
      var oldLimitImpulse = 0;
      var bA = this.m_bodyA;
      var bB = this.m_bodyB;
      var c1 = bA.m_sweep.c;
      var a1 = bA.m_sweep.a;
      var c2 = bB.m_sweep.c;
      var a2 = bB.m_sweep.a;
      var tMat;
      var tX = 0;
      var m1 = 0;
      var m2 = 0;
      var i1 = 0;
      var i2 = 0;
      var linearError = 0.0;
      var angularError = 0.0;
      var active = false;
      var C2 = 0.0;
      var R1 = b2Mat22.FromAngle(a1);
      var R2 = b2Mat22.FromAngle(a2);
      tMat = R1;
      var r1X = this.m_localAnchor1.x - this.m_localCenterA.x;
      var r1Y = this.m_localAnchor1.y - this.m_localCenterA.y;
      tX = (tMat.col1.x * r1X + tMat.col2.x * r1Y);
      r1Y = (tMat.col1.y * r1X + tMat.col2.y * r1Y);
      r1X = tX;
      tMat = R2;
      var r2X = this.m_localAnchor2.x - this.m_localCenterB.x;
      var r2Y = this.m_localAnchor2.y - this.m_localCenterB.y;
      tX = (tMat.col1.x * r2X + tMat.col2.x * r2Y);
      r2Y = (tMat.col1.y * r2X + tMat.col2.y * r2Y);
      r2X = tX;
      var dX = c2.x + r2X - c1.x - r1X;
      var dY = c2.y + r2Y - c1.y - r1Y;
      if (this.m_enableLimit) {
         this.m_axis = b2Math.MulMV(R1, this.m_localXAxis1);
         this.m_a1 = (dX + r1X) * this.m_axis.y - (dY + r1Y) * this.m_axis.x;
         this.m_a2 = r2X * this.m_axis.y - r2Y * this.m_axis.x;
         var translation = this.m_axis.x * dX + this.m_axis.y * dY;
         if (b2Math.Abs(this.m_upperTranslation - this.m_lowerTranslation) < 2.0 * b2Settings.b2_linearSlop) {
            C2 = b2Math.Clamp(translation, (-b2Settings.b2_maxLinearCorrection), b2Settings.b2_maxLinearCorrection);
            linearError = b2Math.Abs(translation);
            active = true;
         }
         else if (translation <= this.m_lowerTranslation) {
            C2 = b2Math.Clamp(translation - this.m_lowerTranslation + b2Settings.b2_linearSlop, (-b2Settings.b2_maxLinearCorrection), 0.0);
            linearError = this.m_lowerTranslation - translation;
            active = true;
         }
         else if (translation >= this.m_upperTranslation) {
            C2 = b2Math.Clamp(translation - this.m_upperTranslation + b2Settings.b2_linearSlop, 0.0, b2Settings.b2_maxLinearCorrection);
            linearError = translation - this.m_upperTranslation;
            active = true;
         }
      }
      this.m_perp = b2Math.MulMV(R1, this.m_localYAxis1);
      this.m_s1 = (dX + r1X) * this.m_perp.y - (dY + r1Y) * this.m_perp.x;
      this.m_s2 = r2X * this.m_perp.y - r2Y * this.m_perp.x;
      var impulse = new b2Vec2();
      var C1 = this.m_perp.x * dX + this.m_perp.y * dY;
      linearError = b2Math.Max(linearError, b2Math.Abs(C1));
      angularError = 0.0;
      if (active) {
         m1 = this.m_invMassA;
         m2 = this.m_invMassB;
         i1 = this.m_invIA;
         i2 = this.m_invIB;
         this.m_K.col1.x = m1 + m2 + i1 * this.m_s1 * this.m_s1 + i2 * this.m_s2 * this.m_s2;
         this.m_K.col1.y = i1 * this.m_s1 * this.m_a1 + i2 * this.m_s2 * this.m_a2;
         this.m_K.col2.x = this.m_K.col1.y;
         this.m_K.col2.y = m1 + m2 + i1 * this.m_a1 * this.m_a1 + i2 * this.m_a2 * this.m_a2;
         this.m_K.Solve(impulse, (-C1), (-C2));
      }
      else {
         m1 = this.m_invMassA;
         m2 = this.m_invMassB;
         i1 = this.m_invIA;
         i2 = this.m_invIB;
         var k11 = m1 + m2 + i1 * this.m_s1 * this.m_s1 + i2 * this.m_s2 * this.m_s2;
         var impulse1 = 0;
         if (k11 != 0.0) {
            impulse1 = ((-C1)) / k11;
         }
         else {
            impulse1 = 0.0;
         }
         impulse.x = impulse1;
         impulse.y = 0.0;
      }
      var PX = impulse.x * this.m_perp.x + impulse.y * this.m_axis.x;
      var PY = impulse.x * this.m_perp.y + impulse.y * this.m_axis.y;
      var L1 = impulse.x * this.m_s1 + impulse.y * this.m_a1;
      var L2 = impulse.x * this.m_s2 + impulse.y * this.m_a2;
      c1.x -= this.m_invMassA * PX;
      c1.y -= this.m_invMassA * PY;
      a1 -= this.m_invIA * L1;
      c2.x += this.m_invMassB * PX;
      c2.y += this.m_invMassB * PY;
      a2 += this.m_invIB * L2;
      bA.m_sweep.a = a1;
      bB.m_sweep.a = a2;
      bA.SynchronizeTransform();
      bB.SynchronizeTransform();
      return linearError <= b2Settings.b2_linearSlop && angularError <= b2Settings.b2_angularSlop;
   }
   Box2D.inherit(b2LineJointDef, Box2D.Dynamics.Joints.b2JointDef);
   b2LineJointDef.prototype.__super = Box2D.Dynamics.Joints.b2JointDef.prototype;
   b2LineJointDef.b2LineJointDef = function () {
      Box2D.Dynamics.Joints.b2JointDef.b2JointDef.apply(this, arguments);
      this.localAnchorA = new b2Vec2();
      this.localAnchorB = new b2Vec2();
      this.localAxisA = new b2Vec2();
   };
   b2LineJointDef.prototype.b2LineJointDef = function () {
      this.__super.b2JointDef.call(this);
      this.type = b2Joint.e_lineJoint;
      this.localAxisA.Set(1.0, 0.0);
      this.enableLimit = false;
      this.lowerTranslation = 0.0;
      this.upperTranslation = 0.0;
      this.enableMotor = false;
      this.maxMotorForce = 0.0;
      this.motorSpeed = 0.0;
   }
   b2LineJointDef.prototype.Initialize = function (bA, bB, anchor, axis) {
      this.bodyA = bA;
      this.bodyB = bB;
      this.localAnchorA = this.bodyA.GetLocalPoint(anchor);
      this.localAnchorB = this.bodyB.GetLocalPoint(anchor);
      this.localAxisA = this.bodyA.GetLocalVector(axis);
   }
   Box2D.inherit(b2MouseJoint, Box2D.Dynamics.Joints.b2Joint);
   b2MouseJoint.prototype.__super = Box2D.Dynamics.Joints.b2Joint.prototype;
   b2MouseJoint.b2MouseJoint = function () {
      Box2D.Dynamics.Joints.b2Joint.b2Joint.apply(this, arguments);
      this.K = new b2Mat22();
      this.K1 = new b2Mat22();
      this.K2 = new b2Mat22();
      this.m_localAnchor = new b2Vec2();
      this.m_target = new b2Vec2();
      this.m_impulse = new b2Vec2();
      this.m_mass = new b2Mat22();
      this.m_C = new b2Vec2();
   };
   b2MouseJoint.prototype.GetAnchorA = function () {
      return this.m_target;
   }
   b2MouseJoint.prototype.GetAnchorB = function () {
      return this.m_bodyB.GetWorldPoint(this.m_localAnchor);
   }
   b2MouseJoint.prototype.GetReactionForce = function (inv_dt) {
      if (inv_dt === undefined) inv_dt = 0;
      return new b2Vec2(inv_dt * this.m_impulse.x, inv_dt * this.m_impulse.y);
   }
   b2MouseJoint.prototype.GetReactionTorque = function (inv_dt) {
      if (inv_dt === undefined) inv_dt = 0;
      return 0.0;
   }
   b2MouseJoint.prototype.GetTarget = function () {
      return this.m_target;
   }
   b2MouseJoint.prototype.SetTarget = function (target) {
      if (this.m_bodyB.IsAwake() == false) {
         this.m_bodyB.SetAwake(true);
      }
      this.m_target = target;
   }
   b2MouseJoint.prototype.GetMaxForce = function () {
      return this.m_maxForce;
   }
   b2MouseJoint.prototype.SetMaxForce = function (maxForce) {
      if (maxForce === undefined) maxForce = 0;
      this.m_maxForce = maxForce;
   }
   b2MouseJoint.prototype.GetFrequency = function () {
      return this.m_frequencyHz;
   }
   b2MouseJoint.prototype.SetFrequency = function (hz) {
      if (hz === undefined) hz = 0;
      this.m_frequencyHz = hz;
   }
   b2MouseJoint.prototype.GetDampingRatio = function () {
      return this.m_dampingRatio;
   }
   b2MouseJoint.prototype.SetDampingRatio = function (ratio) {
      if (ratio === undefined) ratio = 0;
      this.m_dampingRatio = ratio;
   }
   b2MouseJoint.prototype.b2MouseJoint = function (def) {
      this.__super.b2Joint.call(this, def);
      this.m_target.SetV(def.target);
      var tX = this.m_target.x - this.m_bodyB.m_xf.position.x;
      var tY = this.m_target.y - this.m_bodyB.m_xf.position.y;
      var tMat = this.m_bodyB.m_xf.R;
      this.m_localAnchor.x = (tX * tMat.col1.x + tY * tMat.col1.y);
      this.m_localAnchor.y = (tX * tMat.col2.x + tY * tMat.col2.y);
      this.m_maxForce = def.maxForce;
      this.m_impulse.SetZero();
      this.m_frequencyHz = def.frequencyHz;
      this.m_dampingRatio = def.dampingRatio;
      this.m_beta = 0.0;
      this.m_gamma = 0.0;
   }
   b2MouseJoint.prototype.InitVelocityConstraints = function (step) {
      var b = this.m_bodyB;
      var mass = b.GetMass();
      var omega = 2.0 * Math.PI * this.m_frequencyHz;
      var d = 2.0 * mass * this.m_dampingRatio * omega;
      var k = mass * omega * omega;
      this.m_gamma = step.dt * (d + step.dt * k);
      this.m_gamma = this.m_gamma != 0 ? 1 / this.m_gamma : 0.0;
      this.m_beta = step.dt * k * this.m_gamma;
      var tMat;tMat = b.m_xf.R;
      var rX = this.m_localAnchor.x - b.m_sweep.localCenter.x;
      var rY = this.m_localAnchor.y - b.m_sweep.localCenter.y;
      var tX = (tMat.col1.x * rX + tMat.col2.x * rY);rY = (tMat.col1.y * rX + tMat.col2.y * rY);
      rX = tX;
      var invMass = b.m_invMass;
      var invI = b.m_invI;this.K1.col1.x = invMass;
      this.K1.col2.x = 0.0;
      this.K1.col1.y = 0.0;
      this.K1.col2.y = invMass;
      this.K2.col1.x = invI * rY * rY;
      this.K2.col2.x = (-invI * rX * rY);
      this.K2.col1.y = (-invI * rX * rY);
      this.K2.col2.y = invI * rX * rX;
      this.K.SetM(this.K1);
      this.K.AddM(this.K2);
      this.K.col1.x += this.m_gamma;
      this.K.col2.y += this.m_gamma;
      this.K.GetInverse(this.m_mass);
      this.m_C.x = b.m_sweep.c.x + rX - this.m_target.x;
      this.m_C.y = b.m_sweep.c.y + rY - this.m_target.y;
      b.m_angularVelocity *= 0.98;
      this.m_impulse.x *= step.dtRatio;
      this.m_impulse.y *= step.dtRatio;
      b.m_linearVelocity.x += invMass * this.m_impulse.x;
      b.m_linearVelocity.y += invMass * this.m_impulse.y;
      b.m_angularVelocity += invI * (rX * this.m_impulse.y - rY * this.m_impulse.x);
   }
   b2MouseJoint.prototype.SolveVelocityConstraints = function (step) {
      var b = this.m_bodyB;
      var tMat;
      var tX = 0;
      var tY = 0;
      tMat = b.m_xf.R;
      var rX = this.m_localAnchor.x - b.m_sweep.localCenter.x;
      var rY = this.m_localAnchor.y - b.m_sweep.localCenter.y;
      tX = (tMat.col1.x * rX + tMat.col2.x * rY);
      rY = (tMat.col1.y * rX + tMat.col2.y * rY);
      rX = tX;
      var CdotX = b.m_linearVelocity.x + ((-b.m_angularVelocity * rY));
      var CdotY = b.m_linearVelocity.y + (b.m_angularVelocity * rX);
      tMat = this.m_mass;
      tX = CdotX + this.m_beta * this.m_C.x + this.m_gamma * this.m_impulse.x;
      tY = CdotY + this.m_beta * this.m_C.y + this.m_gamma * this.m_impulse.y;
      var impulseX = (-(tMat.col1.x * tX + tMat.col2.x * tY));
      var impulseY = (-(tMat.col1.y * tX + tMat.col2.y * tY));
      var oldImpulseX = this.m_impulse.x;
      var oldImpulseY = this.m_impulse.y;
      this.m_impulse.x += impulseX;
      this.m_impulse.y += impulseY;
      var maxImpulse = step.dt * this.m_maxForce;
      if (this.m_impulse.LengthSquared() > maxImpulse * maxImpulse) {
         this.m_impulse.Multiply(maxImpulse / this.m_impulse.Length());
      }
      impulseX = this.m_impulse.x - oldImpulseX;
      impulseY = this.m_impulse.y - oldImpulseY;
      b.m_linearVelocity.x += b.m_invMass * impulseX;
      b.m_linearVelocity.y += b.m_invMass * impulseY;
      b.m_angularVelocity += b.m_invI * (rX * impulseY - rY * impulseX);
   }
   b2MouseJoint.prototype.SolvePositionConstraints = function (baumgarte) {
      if (baumgarte === undefined) baumgarte = 0;
      return true;
   }
   Box2D.inherit(b2MouseJointDef, Box2D.Dynamics.Joints.b2JointDef);
   b2MouseJointDef.prototype.__super = Box2D.Dynamics.Joints.b2JointDef.prototype;
   b2MouseJointDef.b2MouseJointDef = function () {
      Box2D.Dynamics.Joints.b2JointDef.b2JointDef.apply(this, arguments);
      this.target = new b2Vec2();
   };
   b2MouseJointDef.prototype.b2MouseJointDef = function () {
      this.__super.b2JointDef.call(this);
      this.type = b2Joint.e_mouseJoint;
      this.maxForce = 0.0;
      this.frequencyHz = 5.0;
      this.dampingRatio = 0.7;
   }
   Box2D.inherit(b2PrismaticJoint, Box2D.Dynamics.Joints.b2Joint);
   b2PrismaticJoint.prototype.__super = Box2D.Dynamics.Joints.b2Joint.prototype;
   b2PrismaticJoint.b2PrismaticJoint = function () {
      Box2D.Dynamics.Joints.b2Joint.b2Joint.apply(this, arguments);
      this.m_localAnchor1 = new b2Vec2();
      this.m_localAnchor2 = new b2Vec2();
      this.m_localXAxis1 = new b2Vec2();
      this.m_localYAxis1 = new b2Vec2();
      this.m_axis = new b2Vec2();
      this.m_perp = new b2Vec2();
      this.m_K = new b2Mat33();
      this.m_impulse = new b2Vec3();
   };
   b2PrismaticJoint.prototype.GetAnchorA = function () {
      return this.m_bodyA.GetWorldPoint(this.m_localAnchor1);
   }
   b2PrismaticJoint.prototype.GetAnchorB = function () {
      return this.m_bodyB.GetWorldPoint(this.m_localAnchor2);
   }
   b2PrismaticJoint.prototype.GetReactionForce = function (inv_dt) {
      if (inv_dt === undefined) inv_dt = 0;
      return new b2Vec2(inv_dt * (this.m_impulse.x * this.m_perp.x + (this.m_motorImpulse + this.m_impulse.z) * this.m_axis.x), inv_dt * (this.m_impulse.x * this.m_perp.y + (this.m_motorImpulse + this.m_impulse.z) * this.m_axis.y));
   }
   b2PrismaticJoint.prototype.GetReactionTorque = function (inv_dt) {
      if (inv_dt === undefined) inv_dt = 0;
      return inv_dt * this.m_impulse.y;
   }
   b2PrismaticJoint.prototype.GetJointTranslation = function () {
      var bA = this.m_bodyA;
      var bB = this.m_bodyB;
      var tMat;
      var p1 = bA.GetWorldPoint(this.m_localAnchor1);
      var p2 = bB.GetWorldPoint(this.m_localAnchor2);
      var dX = p2.x - p1.x;
      var dY = p2.y - p1.y;
      var axis = bA.GetWorldVector(this.m_localXAxis1);
      var translation = axis.x * dX + axis.y * dY;
      return translation;
   }
   b2PrismaticJoint.prototype.GetJointSpeed = function () {
      var bA = this.m_bodyA;
      var bB = this.m_bodyB;
      var tMat;
      tMat = bA.m_xf.R;
      var r1X = this.m_localAnchor1.x - bA.m_sweep.localCenter.x;
      var r1Y = this.m_localAnchor1.y - bA.m_sweep.localCenter.y;
      var tX = (tMat.col1.x * r1X + tMat.col2.x * r1Y);
      r1Y = (tMat.col1.y * r1X + tMat.col2.y * r1Y);
      r1X = tX;
      tMat = bB.m_xf.R;
      var r2X = this.m_localAnchor2.x - bB.m_sweep.localCenter.x;
      var r2Y = this.m_localAnchor2.y - bB.m_sweep.localCenter.y;
      tX = (tMat.col1.x * r2X + tMat.col2.x * r2Y);
      r2Y = (tMat.col1.y * r2X + tMat.col2.y * r2Y);
      r2X = tX;
      var p1X = bA.m_sweep.c.x + r1X;
      var p1Y = bA.m_sweep.c.y + r1Y;
      var p2X = bB.m_sweep.c.x + r2X;
      var p2Y = bB.m_sweep.c.y + r2Y;
      var dX = p2X - p1X;
      var dY = p2Y - p1Y;
      var axis = bA.GetWorldVector(this.m_localXAxis1);
      var v1 = bA.m_linearVelocity;
      var v2 = bB.m_linearVelocity;
      var w1 = bA.m_angularVelocity;
      var w2 = bB.m_angularVelocity;
      var speed = (dX * ((-w1 * axis.y)) + dY * (w1 * axis.x)) + (axis.x * (((v2.x + ((-w2 * r2Y))) - v1.x) - ((-w1 * r1Y))) + axis.y * (((v2.y + (w2 * r2X)) - v1.y) - (w1 * r1X)));
      return speed;
   }
   b2PrismaticJoint.prototype.IsLimitEnabled = function () {
      return this.m_enableLimit;
   }
   b2PrismaticJoint.prototype.EnableLimit = function (flag) {
      this.m_bodyA.SetAwake(true);
      this.m_bodyB.SetAwake(true);
      this.m_enableLimit = flag;
   }
   b2PrismaticJoint.prototype.GetLowerLimit = function () {
      return this.m_lowerTranslation;
   }
   b2PrismaticJoint.prototype.GetUpperLimit = function () {
      return this.m_upperTranslation;
   }
   b2PrismaticJoint.prototype.SetLimits = function (lower, upper) {
      if (lower === undefined) lower = 0;
      if (upper === undefined) upper = 0;
      this.m_bodyA.SetAwake(true);
      this.m_bodyB.SetAwake(true);
      this.m_lowerTranslation = lower;
      this.m_upperTranslation = upper;
   }
   b2PrismaticJoint.prototype.IsMotorEnabled = function () {
      return this.m_enableMotor;
   }
   b2PrismaticJoint.prototype.EnableMotor = function (flag) {
      this.m_bodyA.SetAwake(true);
      this.m_bodyB.SetAwake(true);
      this.m_enableMotor = flag;
   }
   b2PrismaticJoint.prototype.SetMotorSpeed = function (speed) {
      if (speed === undefined) speed = 0;
      this.m_bodyA.SetAwake(true);
      this.m_bodyB.SetAwake(true);
      this.m_motorSpeed = speed;
   }
   b2PrismaticJoint.prototype.GetMotorSpeed = function () {
      return this.m_motorSpeed;
   }
   b2PrismaticJoint.prototype.SetMaxMotorForce = function (force) {
      if (force === undefined) force = 0;
      this.m_bodyA.SetAwake(true);
      this.m_bodyB.SetAwake(true);
      this.m_maxMotorForce = force;
   }
   b2PrismaticJoint.prototype.GetMotorForce = function () {
      return this.m_motorImpulse;
   }
   b2PrismaticJoint.prototype.b2PrismaticJoint = function (def) {
      this.__super.b2Joint.call(this, def);
      var tMat;
      var tX = 0;
      var tY = 0;
      this.m_localAnchor1.SetV(def.localAnchorA);
      this.m_localAnchor2.SetV(def.localAnchorB);
      this.m_localXAxis1.SetV(def.localAxisA);
      this.m_localYAxis1.x = (-this.m_localXAxis1.y);
      this.m_localYAxis1.y = this.m_localXAxis1.x;
      this.m_refAngle = def.referenceAngle;
      this.m_impulse.SetZero();
      this.m_motorMass = 0.0;
      this.m_motorImpulse = 0.0;
      this.m_lowerTranslation = def.lowerTranslation;
      this.m_upperTranslation = def.upperTranslation;
      this.m_maxMotorForce = def.maxMotorForce;
      this.m_motorSpeed = def.motorSpeed;
      this.m_enableLimit = def.enableLimit;
      this.m_enableMotor = def.enableMotor;
      this.m_limitState = b2Joint.e_inactiveLimit;
      this.m_axis.SetZero();
      this.m_perp.SetZero();
   }
   b2PrismaticJoint.prototype.InitVelocityConstraints = function (step) {
      var bA = this.m_bodyA;
      var bB = this.m_bodyB;
      var tMat;
      var tX = 0;
      this.m_localCenterA.SetV(bA.GetLocalCenter());
      this.m_localCenterB.SetV(bB.GetLocalCenter());
      var xf1 = bA.GetTransform();
      var xf2 = bB.GetTransform();
      tMat = bA.m_xf.R;
      var r1X = this.m_localAnchor1.x - this.m_localCenterA.x;
      var r1Y = this.m_localAnchor1.y - this.m_localCenterA.y;
      tX = (tMat.col1.x * r1X + tMat.col2.x * r1Y);
      r1Y = (tMat.col1.y * r1X + tMat.col2.y * r1Y);
      r1X = tX;
      tMat = bB.m_xf.R;
      var r2X = this.m_localAnchor2.x - this.m_localCenterB.x;
      var r2Y = this.m_localAnchor2.y - this.m_localCenterB.y;
      tX = (tMat.col1.x * r2X + tMat.col2.x * r2Y);
      r2Y = (tMat.col1.y * r2X + tMat.col2.y * r2Y);
      r2X = tX;
      var dX = bB.m_sweep.c.x + r2X - bA.m_sweep.c.x - r1X;
      var dY = bB.m_sweep.c.y + r2Y - bA.m_sweep.c.y - r1Y;
      this.m_invMassA = bA.m_invMass;
      this.m_invMassB = bB.m_invMass;
      this.m_invIA = bA.m_invI;
      this.m_invIB = bB.m_invI; {
         this.m_axis.SetV(b2Math.MulMV(xf1.R, this.m_localXAxis1));
         this.m_a1 = (dX + r1X) * this.m_axis.y - (dY + r1Y) * this.m_axis.x;
         this.m_a2 = r2X * this.m_axis.y - r2Y * this.m_axis.x;
         this.m_motorMass = this.m_invMassA + this.m_invMassB + this.m_invIA * this.m_a1 * this.m_a1 + this.m_invIB * this.m_a2 * this.m_a2;
         if (this.m_motorMass > Number.MIN_VALUE) this.m_motorMass = 1.0 / this.m_motorMass;
      } {
         this.m_perp.SetV(b2Math.MulMV(xf1.R, this.m_localYAxis1));
         this.m_s1 = (dX + r1X) * this.m_perp.y - (dY + r1Y) * this.m_perp.x;
         this.m_s2 = r2X * this.m_perp.y - r2Y * this.m_perp.x;
         var m1 = this.m_invMassA;
         var m2 = this.m_invMassB;
         var i1 = this.m_invIA;
         var i2 = this.m_invIB;
         this.m_K.col1.x = m1 + m2 + i1 * this.m_s1 * this.m_s1 + i2 * this.m_s2 * this.m_s2;
         this.m_K.col1.y = i1 * this.m_s1 + i2 * this.m_s2;
         this.m_K.col1.z = i1 * this.m_s1 * this.m_a1 + i2 * this.m_s2 * this.m_a2;
         this.m_K.col2.x = this.m_K.col1.y;
         this.m_K.col2.y = i1 + i2;
         this.m_K.col2.z = i1 * this.m_a1 + i2 * this.m_a2;
         this.m_K.col3.x = this.m_K.col1.z;
         this.m_K.col3.y = this.m_K.col2.z;
         this.m_K.col3.z = m1 + m2 + i1 * this.m_a1 * this.m_a1 + i2 * this.m_a2 * this.m_a2;
      }
      if (this.m_enableLimit) {
         var jointTransition = this.m_axis.x * dX + this.m_axis.y * dY;
         if (b2Math.Abs(this.m_upperTranslation - this.m_lowerTranslation) < 2.0 * b2Settings.b2_linearSlop) {
            this.m_limitState = b2Joint.e_equalLimits;
         }
         else if (jointTransition <= this.m_lowerTranslation) {
            if (this.m_limitState != b2Joint.e_atLowerLimit) {
               this.m_limitState = b2Joint.e_atLowerLimit;
               this.m_impulse.z = 0.0;
            }
         }
         else if (jointTransition >= this.m_upperTranslation) {
            if (this.m_limitState != b2Joint.e_atUpperLimit) {
               this.m_limitState = b2Joint.e_atUpperLimit;
               this.m_impulse.z = 0.0;
            }
         }
         else {
            this.m_limitState = b2Joint.e_inactiveLimit;
            this.m_impulse.z = 0.0;
         }
      }
      else {
         this.m_limitState = b2Joint.e_inactiveLimit;
      }
      if (this.m_enableMotor == false) {
         this.m_motorImpulse = 0.0;
      }
      if (step.warmStarting) {
         this.m_impulse.x *= step.dtRatio;
         this.m_impulse.y *= step.dtRatio;
         this.m_motorImpulse *= step.dtRatio;
         var PX = this.m_impulse.x * this.m_perp.x + (this.m_motorImpulse + this.m_impulse.z) * this.m_axis.x;
         var PY = this.m_impulse.x * this.m_perp.y + (this.m_motorImpulse + this.m_impulse.z) * this.m_axis.y;
         var L1 = this.m_impulse.x * this.m_s1 + this.m_impulse.y + (this.m_motorImpulse + this.m_impulse.z) * this.m_a1;
         var L2 = this.m_impulse.x * this.m_s2 + this.m_impulse.y + (this.m_motorImpulse + this.m_impulse.z) * this.m_a2;
         bA.m_linearVelocity.x -= this.m_invMassA * PX;
         bA.m_linearVelocity.y -= this.m_invMassA * PY;
         bA.m_angularVelocity -= this.m_invIA * L1;
         bB.m_linearVelocity.x += this.m_invMassB * PX;
         bB.m_linearVelocity.y += this.m_invMassB * PY;
         bB.m_angularVelocity += this.m_invIB * L2;
      }
      else {
         this.m_impulse.SetZero();
         this.m_motorImpulse = 0.0;
      }
   }
   b2PrismaticJoint.prototype.SolveVelocityConstraints = function (step) {
      var bA = this.m_bodyA;
      var bB = this.m_bodyB;
      var v1 = bA.m_linearVelocity;
      var w1 = bA.m_angularVelocity;
      var v2 = bB.m_linearVelocity;
      var w2 = bB.m_angularVelocity;
      var PX = 0;
      var PY = 0;
      var L1 = 0;
      var L2 = 0;
      if (this.m_enableMotor && this.m_limitState != b2Joint.e_equalLimits) {
         var Cdot = this.m_axis.x * (v2.x - v1.x) + this.m_axis.y * (v2.y - v1.y) + this.m_a2 * w2 - this.m_a1 * w1;
         var impulse = this.m_motorMass * (this.m_motorSpeed - Cdot);
         var oldImpulse = this.m_motorImpulse;
         var maxImpulse = step.dt * this.m_maxMotorForce;
         this.m_motorImpulse = b2Math.Clamp(this.m_motorImpulse + impulse, (-maxImpulse), maxImpulse);
         impulse = this.m_motorImpulse - oldImpulse;
         PX = impulse * this.m_axis.x;
         PY = impulse * this.m_axis.y;
         L1 = impulse * this.m_a1;
         L2 = impulse * this.m_a2;
         v1.x -= this.m_invMassA * PX;
         v1.y -= this.m_invMassA * PY;
         w1 -= this.m_invIA * L1;
         v2.x += this.m_invMassB * PX;
         v2.y += this.m_invMassB * PY;
         w2 += this.m_invIB * L2;
      }
      var Cdot1X = this.m_perp.x * (v2.x - v1.x) + this.m_perp.y * (v2.y - v1.y) + this.m_s2 * w2 - this.m_s1 * w1;
      var Cdot1Y = w2 - w1;
      if (this.m_enableLimit && this.m_limitState != b2Joint.e_inactiveLimit) {
         var Cdot2 = this.m_axis.x * (v2.x - v1.x) + this.m_axis.y * (v2.y - v1.y) + this.m_a2 * w2 - this.m_a1 * w1;
         var f1 = this.m_impulse.Copy();
         var df = this.m_K.Solve33(new b2Vec3(), (-Cdot1X), (-Cdot1Y), (-Cdot2));
         this.m_impulse.Add(df);
         if (this.m_limitState == b2Joint.e_atLowerLimit) {
            this.m_impulse.z = b2Math.Max(this.m_impulse.z, 0.0);
         }
         else if (this.m_limitState == b2Joint.e_atUpperLimit) {
            this.m_impulse.z = b2Math.Min(this.m_impulse.z, 0.0);
         }
         var bX = (-Cdot1X) - (this.m_impulse.z - f1.z) * this.m_K.col3.x;
         var bY = (-Cdot1Y) - (this.m_impulse.z - f1.z) * this.m_K.col3.y;
         var f2r = this.m_K.Solve22(new b2Vec2(), bX, bY);
         f2r.x += f1.x;
         f2r.y += f1.y;
         this.m_impulse.x = f2r.x;
         this.m_impulse.y = f2r.y;
         df.x = this.m_impulse.x - f1.x;
         df.y = this.m_impulse.y - f1.y;
         df.z = this.m_impulse.z - f1.z;
         PX = df.x * this.m_perp.x + df.z * this.m_axis.x;
         PY = df.x * this.m_perp.y + df.z * this.m_axis.y;
         L1 = df.x * this.m_s1 + df.y + df.z * this.m_a1;
         L2 = df.x * this.m_s2 + df.y + df.z * this.m_a2;
         v1.x -= this.m_invMassA * PX;
         v1.y -= this.m_invMassA * PY;
         w1 -= this.m_invIA * L1;
         v2.x += this.m_invMassB * PX;
         v2.y += this.m_invMassB * PY;
         w2 += this.m_invIB * L2;
      }
      else {
         var df2 = this.m_K.Solve22(new b2Vec2(), (-Cdot1X), (-Cdot1Y));
         this.m_impulse.x += df2.x;
         this.m_impulse.y += df2.y;
         PX = df2.x * this.m_perp.x;
         PY = df2.x * this.m_perp.y;
         L1 = df2.x * this.m_s1 + df2.y;
         L2 = df2.x * this.m_s2 + df2.y;
         v1.x -= this.m_invMassA * PX;
         v1.y -= this.m_invMassA * PY;
         w1 -= this.m_invIA * L1;
         v2.x += this.m_invMassB * PX;
         v2.y += this.m_invMassB * PY;
         w2 += this.m_invIB * L2;
      }
      bA.m_linearVelocity.SetV(v1);
      bA.m_angularVelocity = w1;
      bB.m_linearVelocity.SetV(v2);
      bB.m_angularVelocity = w2;
   }
   b2PrismaticJoint.prototype.SolvePositionConstraints = function (baumgarte) {
      if (baumgarte === undefined) baumgarte = 0;
      var limitC = 0;
      var oldLimitImpulse = 0;
      var bA = this.m_bodyA;
      var bB = this.m_bodyB;
      var c1 = bA.m_sweep.c;
      var a1 = bA.m_sweep.a;
      var c2 = bB.m_sweep.c;
      var a2 = bB.m_sweep.a;
      var tMat;
      var tX = 0;
      var m1 = 0;
      var m2 = 0;
      var i1 = 0;
      var i2 = 0;
      var linearError = 0.0;
      var angularError = 0.0;
      var active = false;
      var C2 = 0.0;
      var R1 = b2Mat22.FromAngle(a1);
      var R2 = b2Mat22.FromAngle(a2);
      tMat = R1;
      var r1X = this.m_localAnchor1.x - this.m_localCenterA.x;
      var r1Y = this.m_localAnchor1.y - this.m_localCenterA.y;
      tX = (tMat.col1.x * r1X + tMat.col2.x * r1Y);
      r1Y = (tMat.col1.y * r1X + tMat.col2.y * r1Y);
      r1X = tX;
      tMat = R2;
      var r2X = this.m_localAnchor2.x - this.m_localCenterB.x;
      var r2Y = this.m_localAnchor2.y - this.m_localCenterB.y;
      tX = (tMat.col1.x * r2X + tMat.col2.x * r2Y);
      r2Y = (tMat.col1.y * r2X + tMat.col2.y * r2Y);
      r2X = tX;
      var dX = c2.x + r2X - c1.x - r1X;
      var dY = c2.y + r2Y - c1.y - r1Y;
      if (this.m_enableLimit) {
         this.m_axis = b2Math.MulMV(R1, this.m_localXAxis1);
         this.m_a1 = (dX + r1X) * this.m_axis.y - (dY + r1Y) * this.m_axis.x;
         this.m_a2 = r2X * this.m_axis.y - r2Y * this.m_axis.x;
         var translation = this.m_axis.x * dX + this.m_axis.y * dY;
         if (b2Math.Abs(this.m_upperTranslation - this.m_lowerTranslation) < 2.0 * b2Settings.b2_linearSlop) {
            C2 = b2Math.Clamp(translation, (-b2Settings.b2_maxLinearCorrection), b2Settings.b2_maxLinearCorrection);
            linearError = b2Math.Abs(translation);
            active = true;
         }
         else if (translation <= this.m_lowerTranslation) {
            C2 = b2Math.Clamp(translation - this.m_lowerTranslation + b2Settings.b2_linearSlop, (-b2Settings.b2_maxLinearCorrection), 0.0);
            linearError = this.m_lowerTranslation - translation;
            active = true;
         }
         else if (translation >= this.m_upperTranslation) {
            C2 = b2Math.Clamp(translation - this.m_upperTranslation + b2Settings.b2_linearSlop, 0.0, b2Settings.b2_maxLinearCorrection);
            linearError = translation - this.m_upperTranslation;
            active = true;
         }
      }
      this.m_perp = b2Math.MulMV(R1, this.m_localYAxis1);
      this.m_s1 = (dX + r1X) * this.m_perp.y - (dY + r1Y) * this.m_perp.x;
      this.m_s2 = r2X * this.m_perp.y - r2Y * this.m_perp.x;
      var impulse = new b2Vec3();
      var C1X = this.m_perp.x * dX + this.m_perp.y * dY;
      var C1Y = a2 - a1 - this.m_refAngle;
      linearError = b2Math.Max(linearError, b2Math.Abs(C1X));
      angularError = b2Math.Abs(C1Y);
      if (active) {
         m1 = this.m_invMassA;
         m2 = this.m_invMassB;
         i1 = this.m_invIA;
         i2 = this.m_invIB;
         this.m_K.col1.x = m1 + m2 + i1 * this.m_s1 * this.m_s1 + i2 * this.m_s2 * this.m_s2;
         this.m_K.col1.y = i1 * this.m_s1 + i2 * this.m_s2;
         this.m_K.col1.z = i1 * this.m_s1 * this.m_a1 + i2 * this.m_s2 * this.m_a2;
         this.m_K.col2.x = this.m_K.col1.y;
         this.m_K.col2.y = i1 + i2;
         this.m_K.col2.z = i1 * this.m_a1 + i2 * this.m_a2;
         this.m_K.col3.x = this.m_K.col1.z;
         this.m_K.col3.y = this.m_K.col2.z;
         this.m_K.col3.z = m1 + m2 + i1 * this.m_a1 * this.m_a1 + i2 * this.m_a2 * this.m_a2;
         this.m_K.Solve33(impulse, (-C1X), (-C1Y), (-C2));
      }
      else {
         m1 = this.m_invMassA;
         m2 = this.m_invMassB;
         i1 = this.m_invIA;
         i2 = this.m_invIB;
         var k11 = m1 + m2 + i1 * this.m_s1 * this.m_s1 + i2 * this.m_s2 * this.m_s2;
         var k12 = i1 * this.m_s1 + i2 * this.m_s2;
         var k22 = i1 + i2;
         this.m_K.col1.Set(k11, k12, 0.0);
         this.m_K.col2.Set(k12, k22, 0.0);
         var impulse1 = this.m_K.Solve22(new b2Vec2(), (-C1X), (-C1Y));
         impulse.x = impulse1.x;
         impulse.y = impulse1.y;
         impulse.z = 0.0;
      }
      var PX = impulse.x * this.m_perp.x + impulse.z * this.m_axis.x;
      var PY = impulse.x * this.m_perp.y + impulse.z * this.m_axis.y;
      var L1 = impulse.x * this.m_s1 + impulse.y + impulse.z * this.m_a1;
      var L2 = impulse.x * this.m_s2 + impulse.y + impulse.z * this.m_a2;
      c1.x -= this.m_invMassA * PX;
      c1.y -= this.m_invMassA * PY;
      a1 -= this.m_invIA * L1;
      c2.x += this.m_invMassB * PX;
      c2.y += this.m_invMassB * PY;
      a2 += this.m_invIB * L2;
      bA.m_sweep.a = a1;
      bB.m_sweep.a = a2;
      bA.SynchronizeTransform();
      bB.SynchronizeTransform();
      return linearError <= b2Settings.b2_linearSlop && angularError <= b2Settings.b2_angularSlop;
   }
   Box2D.inherit(b2PrismaticJointDef, Box2D.Dynamics.Joints.b2JointDef);
   b2PrismaticJointDef.prototype.__super = Box2D.Dynamics.Joints.b2JointDef.prototype;
   b2PrismaticJointDef.b2PrismaticJointDef = function () {
      Box2D.Dynamics.Joints.b2JointDef.b2JointDef.apply(this, arguments);
      this.localAnchorA = new b2Vec2();
      this.localAnchorB = new b2Vec2();
      this.localAxisA = new b2Vec2();
   };
   b2PrismaticJointDef.prototype.b2PrismaticJointDef = function () {
      this.__super.b2JointDef.call(this);
      this.type = b2Joint.e_prismaticJoint;
      this.localAxisA.Set(1.0, 0.0);
      this.referenceAngle = 0.0;
      this.enableLimit = false;
      this.lowerTranslation = 0.0;
      this.upperTranslation = 0.0;
      this.enableMotor = false;
      this.maxMotorForce = 0.0;
      this.motorSpeed = 0.0;
   }
   b2PrismaticJointDef.prototype.Initialize = function (bA, bB, anchor, axis) {
      this.bodyA = bA;
      this.bodyB = bB;
      this.localAnchorA = this.bodyA.GetLocalPoint(anchor);
      this.localAnchorB = this.bodyB.GetLocalPoint(anchor);
      this.localAxisA = this.bodyA.GetLocalVector(axis);
      this.referenceAngle = this.bodyB.GetAngle() - this.bodyA.GetAngle();
   }
   Box2D.inherit(b2PulleyJoint, Box2D.Dynamics.Joints.b2Joint);
   b2PulleyJoint.prototype.__super = Box2D.Dynamics.Joints.b2Joint.prototype;
   b2PulleyJoint.b2PulleyJoint = function () {
      Box2D.Dynamics.Joints.b2Joint.b2Joint.apply(this, arguments);
      this.m_groundAnchor1 = new b2Vec2();
      this.m_groundAnchor2 = new b2Vec2();
      this.m_localAnchor1 = new b2Vec2();
      this.m_localAnchor2 = new b2Vec2();
      this.m_u1 = new b2Vec2();
      this.m_u2 = new b2Vec2();
   };
   b2PulleyJoint.prototype.GetAnchorA = function () {
      return this.m_bodyA.GetWorldPoint(this.m_localAnchor1);
   }
   b2PulleyJoint.prototype.GetAnchorB = function () {
      return this.m_bodyB.GetWorldPoint(this.m_localAnchor2);
   }
   b2PulleyJoint.prototype.GetReactionForce = function (inv_dt) {
      if (inv_dt === undefined) inv_dt = 0;
      return new b2Vec2(inv_dt * this.m_impulse * this.m_u2.x, inv_dt * this.m_impulse * this.m_u2.y);
   }
   b2PulleyJoint.prototype.GetReactionTorque = function (inv_dt) {
      if (inv_dt === undefined) inv_dt = 0;
      return 0.0;
   }
   b2PulleyJoint.prototype.GetGroundAnchorA = function () {
      var a = this.m_ground.m_xf.position.Copy();
      a.Add(this.m_groundAnchor1);
      return a;
   }
   b2PulleyJoint.prototype.GetGroundAnchorB = function () {
      var a = this.m_ground.m_xf.position.Copy();
      a.Add(this.m_groundAnchor2);
      return a;
   }
   b2PulleyJoint.prototype.GetLength1 = function () {
      var p = this.m_bodyA.GetWorldPoint(this.m_localAnchor1);
      var sX = this.m_ground.m_xf.position.x + this.m_groundAnchor1.x;
      var sY = this.m_ground.m_xf.position.y + this.m_groundAnchor1.y;
      var dX = p.x - sX;
      var dY = p.y - sY;
      return Math.sqrt(dX * dX + dY * dY);
   }
   b2PulleyJoint.prototype.GetLength2 = function () {
      var p = this.m_bodyB.GetWorldPoint(this.m_localAnchor2);
      var sX = this.m_ground.m_xf.position.x + this.m_groundAnchor2.x;
      var sY = this.m_ground.m_xf.position.y + this.m_groundAnchor2.y;
      var dX = p.x - sX;
      var dY = p.y - sY;
      return Math.sqrt(dX * dX + dY * dY);
   }
   b2PulleyJoint.prototype.GetRatio = function () {
      return this.m_ratio;
   }
   b2PulleyJoint.prototype.b2PulleyJoint = function (def) {
      this.__super.b2Joint.call(this, def);
      var tMat;
      var tX = 0;
      var tY = 0;
      this.m_ground = this.m_bodyA.m_world.m_groundBody;
      this.m_groundAnchor1.x = def.groundAnchorA.x - this.m_ground.m_xf.position.x;
      this.m_groundAnchor1.y = def.groundAnchorA.y - this.m_ground.m_xf.position.y;
      this.m_groundAnchor2.x = def.groundAnchorB.x - this.m_ground.m_xf.position.x;
      this.m_groundAnchor2.y = def.groundAnchorB.y - this.m_ground.m_xf.position.y;
      this.m_localAnchor1.SetV(def.localAnchorA);
      this.m_localAnchor2.SetV(def.localAnchorB);
      this.m_ratio = def.ratio;
      this.m_constant = def.lengthA + this.m_ratio * def.lengthB;
      this.m_maxLength1 = b2Math.Min(def.maxLengthA, this.m_constant - this.m_ratio * b2PulleyJoint.b2_minPulleyLength);
      this.m_maxLength2 = b2Math.Min(def.maxLengthB, (this.m_constant - b2PulleyJoint.b2_minPulleyLength) / this.m_ratio);
      this.m_impulse = 0.0;
      this.m_limitImpulse1 = 0.0;
      this.m_limitImpulse2 = 0.0;
   }
   b2PulleyJoint.prototype.InitVelocityConstraints = function (step) {
      var bA = this.m_bodyA;
      var bB = this.m_bodyB;
      var tMat;
      tMat = bA.m_xf.R;
      var r1X = this.m_localAnchor1.x - bA.m_sweep.localCenter.x;
      var r1Y = this.m_localAnchor1.y - bA.m_sweep.localCenter.y;
      var tX = (tMat.col1.x * r1X + tMat.col2.x * r1Y);
      r1Y = (tMat.col1.y * r1X + tMat.col2.y * r1Y);
      r1X = tX;
      tMat = bB.m_xf.R;
      var r2X = this.m_localAnchor2.x - bB.m_sweep.localCenter.x;
      var r2Y = this.m_localAnchor2.y - bB.m_sweep.localCenter.y;
      tX = (tMat.col1.x * r2X + tMat.col2.x * r2Y);
      r2Y = (tMat.col1.y * r2X + tMat.col2.y * r2Y);
      r2X = tX;
      var p1X = bA.m_sweep.c.x + r1X;
      var p1Y = bA.m_sweep.c.y + r1Y;
      var p2X = bB.m_sweep.c.x + r2X;
      var p2Y = bB.m_sweep.c.y + r2Y;
      var s1X = this.m_ground.m_xf.position.x + this.m_groundAnchor1.x;
      var s1Y = this.m_ground.m_xf.position.y + this.m_groundAnchor1.y;
      var s2X = this.m_ground.m_xf.position.x + this.m_groundAnchor2.x;
      var s2Y = this.m_ground.m_xf.position.y + this.m_groundAnchor2.y;
      this.m_u1.Set(p1X - s1X, p1Y - s1Y);
      this.m_u2.Set(p2X - s2X, p2Y - s2Y);
      var length1 = this.m_u1.Length();
      var length2 = this.m_u2.Length();
      if (length1 > b2Settings.b2_linearSlop) {
         this.m_u1.Multiply(1.0 / length1);
      }
      else {
         this.m_u1.SetZero();
      }
      if (length2 > b2Settings.b2_linearSlop) {
         this.m_u2.Multiply(1.0 / length2);
      }
      else {
         this.m_u2.SetZero();
      }
      var C = this.m_constant - length1 - this.m_ratio * length2;
      if (C > 0.0) {
         this.m_state = b2Joint.e_inactiveLimit;
         this.m_impulse = 0.0;
      }
      else {
         this.m_state = b2Joint.e_atUpperLimit;
      }
      if (length1 < this.m_maxLength1) {
         this.m_limitState1 = b2Joint.e_inactiveLimit;
         this.m_limitImpulse1 = 0.0;
      }
      else {
         this.m_limitState1 = b2Joint.e_atUpperLimit;
      }
      if (length2 < this.m_maxLength2) {
         this.m_limitState2 = b2Joint.e_inactiveLimit;
         this.m_limitImpulse2 = 0.0;
      }
      else {
         this.m_limitState2 = b2Joint.e_atUpperLimit;
      }
      var cr1u1 = r1X * this.m_u1.y - r1Y * this.m_u1.x;
      var cr2u2 = r2X * this.m_u2.y - r2Y * this.m_u2.x;
      this.m_limitMass1 = bA.m_invMass + bA.m_invI * cr1u1 * cr1u1;
      this.m_limitMass2 = bB.m_invMass + bB.m_invI * cr2u2 * cr2u2;
      this.m_pulleyMass = this.m_limitMass1 + this.m_ratio * this.m_ratio * this.m_limitMass2;
      this.m_limitMass1 = 1.0 / this.m_limitMass1;
      this.m_limitMass2 = 1.0 / this.m_limitMass2;
      this.m_pulleyMass = 1.0 / this.m_pulleyMass;
      if (step.warmStarting) {
         this.m_impulse *= step.dtRatio;
         this.m_limitImpulse1 *= step.dtRatio;
         this.m_limitImpulse2 *= step.dtRatio;
         var P1X = ((-this.m_impulse) - this.m_limitImpulse1) * this.m_u1.x;
         var P1Y = ((-this.m_impulse) - this.m_limitImpulse1) * this.m_u1.y;
         var P2X = ((-this.m_ratio * this.m_impulse) - this.m_limitImpulse2) * this.m_u2.x;
         var P2Y = ((-this.m_ratio * this.m_impulse) - this.m_limitImpulse2) * this.m_u2.y;
         bA.m_linearVelocity.x += bA.m_invMass * P1X;
         bA.m_linearVelocity.y += bA.m_invMass * P1Y;
         bA.m_angularVelocity += bA.m_invI * (r1X * P1Y - r1Y * P1X);
         bB.m_linearVelocity.x += bB.m_invMass * P2X;
         bB.m_linearVelocity.y += bB.m_invMass * P2Y;
         bB.m_angularVelocity += bB.m_invI * (r2X * P2Y - r2Y * P2X);
      }
      else {
         this.m_impulse = 0.0;
         this.m_limitImpulse1 = 0.0;
         this.m_limitImpulse2 = 0.0;
      }
   }
   b2PulleyJoint.prototype.SolveVelocityConstraints = function (step) {
      var bA = this.m_bodyA;
      var bB = this.m_bodyB;
      var tMat;
      tMat = bA.m_xf.R;
      var r1X = this.m_localAnchor1.x - bA.m_sweep.localCenter.x;
      var r1Y = this.m_localAnchor1.y - bA.m_sweep.localCenter.y;
      var tX = (tMat.col1.x * r1X + tMat.col2.x * r1Y);
      r1Y = (tMat.col1.y * r1X + tMat.col2.y * r1Y);
      r1X = tX;
      tMat = bB.m_xf.R;
      var r2X = this.m_localAnchor2.x - bB.m_sweep.localCenter.x;
      var r2Y = this.m_localAnchor2.y - bB.m_sweep.localCenter.y;
      tX = (tMat.col1.x * r2X + tMat.col2.x * r2Y);
      r2Y = (tMat.col1.y * r2X + tMat.col2.y * r2Y);
      r2X = tX;
      var v1X = 0;
      var v1Y = 0;
      var v2X = 0;
      var v2Y = 0;
      var P1X = 0;
      var P1Y = 0;
      var P2X = 0;
      var P2Y = 0;
      var Cdot = 0;
      var impulse = 0;
      var oldImpulse = 0;
      if (this.m_state == b2Joint.e_atUpperLimit) {
         v1X = bA.m_linearVelocity.x + ((-bA.m_angularVelocity * r1Y));
         v1Y = bA.m_linearVelocity.y + (bA.m_angularVelocity * r1X);
         v2X = bB.m_linearVelocity.x + ((-bB.m_angularVelocity * r2Y));
         v2Y = bB.m_linearVelocity.y + (bB.m_angularVelocity * r2X);
         Cdot = (-(this.m_u1.x * v1X + this.m_u1.y * v1Y)) - this.m_ratio * (this.m_u2.x * v2X + this.m_u2.y * v2Y);
         impulse = this.m_pulleyMass * ((-Cdot));
         oldImpulse = this.m_impulse;
         this.m_impulse = b2Math.Max(0.0, this.m_impulse + impulse);
         impulse = this.m_impulse - oldImpulse;
         P1X = (-impulse * this.m_u1.x);
         P1Y = (-impulse * this.m_u1.y);
         P2X = (-this.m_ratio * impulse * this.m_u2.x);
         P2Y = (-this.m_ratio * impulse * this.m_u2.y);
         bA.m_linearVelocity.x += bA.m_invMass * P1X;
         bA.m_linearVelocity.y += bA.m_invMass * P1Y;
         bA.m_angularVelocity += bA.m_invI * (r1X * P1Y - r1Y * P1X);
         bB.m_linearVelocity.x += bB.m_invMass * P2X;
         bB.m_linearVelocity.y += bB.m_invMass * P2Y;
         bB.m_angularVelocity += bB.m_invI * (r2X * P2Y - r2Y * P2X);
      }
      if (this.m_limitState1 == b2Joint.e_atUpperLimit) {
         v1X = bA.m_linearVelocity.x + ((-bA.m_angularVelocity * r1Y));
         v1Y = bA.m_linearVelocity.y + (bA.m_angularVelocity * r1X);
         Cdot = (-(this.m_u1.x * v1X + this.m_u1.y * v1Y));
         impulse = (-this.m_limitMass1 * Cdot);
         oldImpulse = this.m_limitImpulse1;
         this.m_limitImpulse1 = b2Math.Max(0.0, this.m_limitImpulse1 + impulse);
         impulse = this.m_limitImpulse1 - oldImpulse;
         P1X = (-impulse * this.m_u1.x);
         P1Y = (-impulse * this.m_u1.y);
         bA.m_linearVelocity.x += bA.m_invMass * P1X;
         bA.m_linearVelocity.y += bA.m_invMass * P1Y;
         bA.m_angularVelocity += bA.m_invI * (r1X * P1Y - r1Y * P1X);
      }
      if (this.m_limitState2 == b2Joint.e_atUpperLimit) {
         v2X = bB.m_linearVelocity.x + ((-bB.m_angularVelocity * r2Y));
         v2Y = bB.m_linearVelocity.y + (bB.m_angularVelocity * r2X);
         Cdot = (-(this.m_u2.x * v2X + this.m_u2.y * v2Y));
         impulse = (-this.m_limitMass2 * Cdot);
         oldImpulse = this.m_limitImpulse2;
         this.m_limitImpulse2 = b2Math.Max(0.0, this.m_limitImpulse2 + impulse);
         impulse = this.m_limitImpulse2 - oldImpulse;
         P2X = (-impulse * this.m_u2.x);
         P2Y = (-impulse * this.m_u2.y);
         bB.m_linearVelocity.x += bB.m_invMass * P2X;
         bB.m_linearVelocity.y += bB.m_invMass * P2Y;
         bB.m_angularVelocity += bB.m_invI * (r2X * P2Y - r2Y * P2X);
      }
   }
   b2PulleyJoint.prototype.SolvePositionConstraints = function (baumgarte) {
      if (baumgarte === undefined) baumgarte = 0;
      var bA = this.m_bodyA;
      var bB = this.m_bodyB;
      var tMat;
      var s1X = this.m_ground.m_xf.position.x + this.m_groundAnchor1.x;
      var s1Y = this.m_ground.m_xf.position.y + this.m_groundAnchor1.y;
      var s2X = this.m_ground.m_xf.position.x + this.m_groundAnchor2.x;
      var s2Y = this.m_ground.m_xf.position.y + this.m_groundAnchor2.y;
      var r1X = 0;
      var r1Y = 0;
      var r2X = 0;
      var r2Y = 0;
      var p1X = 0;
      var p1Y = 0;
      var p2X = 0;
      var p2Y = 0;
      var length1 = 0;
      var length2 = 0;
      var C = 0;
      var impulse = 0;
      var oldImpulse = 0;
      var oldLimitPositionImpulse = 0;
      var tX = 0;
      var linearError = 0.0;
      if (this.m_state == b2Joint.e_atUpperLimit) {
         tMat = bA.m_xf.R;
         r1X = this.m_localAnchor1.x - bA.m_sweep.localCenter.x;
         r1Y = this.m_localAnchor1.y - bA.m_sweep.localCenter.y;
         tX = (tMat.col1.x * r1X + tMat.col2.x * r1Y);
         r1Y = (tMat.col1.y * r1X + tMat.col2.y * r1Y);
         r1X = tX;
         tMat = bB.m_xf.R;
         r2X = this.m_localAnchor2.x - bB.m_sweep.localCenter.x;
         r2Y = this.m_localAnchor2.y - bB.m_sweep.localCenter.y;
         tX = (tMat.col1.x * r2X + tMat.col2.x * r2Y);
         r2Y = (tMat.col1.y * r2X + tMat.col2.y * r2Y);
         r2X = tX;
         p1X = bA.m_sweep.c.x + r1X;
         p1Y = bA.m_sweep.c.y + r1Y;
         p2X = bB.m_sweep.c.x + r2X;
         p2Y = bB.m_sweep.c.y + r2Y;
         this.m_u1.Set(p1X - s1X, p1Y - s1Y);
         this.m_u2.Set(p2X - s2X, p2Y - s2Y);
         length1 = this.m_u1.Length();
         length2 = this.m_u2.Length();
         if (length1 > b2Settings.b2_linearSlop) {
            this.m_u1.Multiply(1.0 / length1);
         }
         else {
            this.m_u1.SetZero();
         }
         if (length2 > b2Settings.b2_linearSlop) {
            this.m_u2.Multiply(1.0 / length2);
         }
         else {
            this.m_u2.SetZero();
         }
         C = this.m_constant - length1 - this.m_ratio * length2;
         linearError = b2Math.Max(linearError, (-C));
         C = b2Math.Clamp(C + b2Settings.b2_linearSlop, (-b2Settings.b2_maxLinearCorrection), 0.0);
         impulse = (-this.m_pulleyMass * C);
         p1X = (-impulse * this.m_u1.x);
         p1Y = (-impulse * this.m_u1.y);
         p2X = (-this.m_ratio * impulse * this.m_u2.x);
         p2Y = (-this.m_ratio * impulse * this.m_u2.y);
         bA.m_sweep.c.x += bA.m_invMass * p1X;
         bA.m_sweep.c.y += bA.m_invMass * p1Y;
         bA.m_sweep.a += bA.m_invI * (r1X * p1Y - r1Y * p1X);
         bB.m_sweep.c.x += bB.m_invMass * p2X;
         bB.m_sweep.c.y += bB.m_invMass * p2Y;
         bB.m_sweep.a += bB.m_invI * (r2X * p2Y - r2Y * p2X);
         bA.SynchronizeTransform();
         bB.SynchronizeTransform();
      }
      if (this.m_limitState1 == b2Joint.e_atUpperLimit) {
         tMat = bA.m_xf.R;
         r1X = this.m_localAnchor1.x - bA.m_sweep.localCenter.x;
         r1Y = this.m_localAnchor1.y - bA.m_sweep.localCenter.y;
         tX = (tMat.col1.x * r1X + tMat.col2.x * r1Y);
         r1Y = (tMat.col1.y * r1X + tMat.col2.y * r1Y);
         r1X = tX;
         p1X = bA.m_sweep.c.x + r1X;
         p1Y = bA.m_sweep.c.y + r1Y;
         this.m_u1.Set(p1X - s1X, p1Y - s1Y);
         length1 = this.m_u1.Length();
         if (length1 > b2Settings.b2_linearSlop) {
            this.m_u1.x *= 1.0 / length1;
            this.m_u1.y *= 1.0 / length1;
         }
         else {
            this.m_u1.SetZero();
         }
         C = this.m_maxLength1 - length1;
         linearError = b2Math.Max(linearError, (-C));
         C = b2Math.Clamp(C + b2Settings.b2_linearSlop, (-b2Settings.b2_maxLinearCorrection), 0.0);
         impulse = (-this.m_limitMass1 * C);
         p1X = (-impulse * this.m_u1.x);
         p1Y = (-impulse * this.m_u1.y);
         bA.m_sweep.c.x += bA.m_invMass * p1X;
         bA.m_sweep.c.y += bA.m_invMass * p1Y;
         bA.m_sweep.a += bA.m_invI * (r1X * p1Y - r1Y * p1X);
         bA.SynchronizeTransform();
      }
      if (this.m_limitState2 == b2Joint.e_atUpperLimit) {
         tMat = bB.m_xf.R;
         r2X = this.m_localAnchor2.x - bB.m_sweep.localCenter.x;
         r2Y = this.m_localAnchor2.y - bB.m_sweep.localCenter.y;
         tX = (tMat.col1.x * r2X + tMat.col2.x * r2Y);
         r2Y = (tMat.col1.y * r2X + tMat.col2.y * r2Y);
         r2X = tX;
         p2X = bB.m_sweep.c.x + r2X;
         p2Y = bB.m_sweep.c.y + r2Y;
         this.m_u2.Set(p2X - s2X, p2Y - s2Y);
         length2 = this.m_u2.Length();
         if (length2 > b2Settings.b2_linearSlop) {
            this.m_u2.x *= 1.0 / length2;
            this.m_u2.y *= 1.0 / length2;
         }
         else {
            this.m_u2.SetZero();
         }
         C = this.m_maxLength2 - length2;
         linearError = b2Math.Max(linearError, (-C));
         C = b2Math.Clamp(C + b2Settings.b2_linearSlop, (-b2Settings.b2_maxLinearCorrection), 0.0);
         impulse = (-this.m_limitMass2 * C);
         p2X = (-impulse * this.m_u2.x);
         p2Y = (-impulse * this.m_u2.y);
         bB.m_sweep.c.x += bB.m_invMass * p2X;
         bB.m_sweep.c.y += bB.m_invMass * p2Y;
         bB.m_sweep.a += bB.m_invI * (r2X * p2Y - r2Y * p2X);
         bB.SynchronizeTransform();
      }
      return linearError < b2Settings.b2_linearSlop;
   }
   Box2D.postDefs.push(function () {
      Box2D.Dynamics.Joints.b2PulleyJoint.b2_minPulleyLength = 2.0;
   });
   Box2D.inherit(b2PulleyJointDef, Box2D.Dynamics.Joints.b2JointDef);
   b2PulleyJointDef.prototype.__super = Box2D.Dynamics.Joints.b2JointDef.prototype;
   b2PulleyJointDef.b2PulleyJointDef = function () {
      Box2D.Dynamics.Joints.b2JointDef.b2JointDef.apply(this, arguments);
      this.groundAnchorA = new b2Vec2();
      this.groundAnchorB = new b2Vec2();
      this.localAnchorA = new b2Vec2();
      this.localAnchorB = new b2Vec2();
   };
   b2PulleyJointDef.prototype.b2PulleyJointDef = function () {
      this.__super.b2JointDef.call(this);
      this.type = b2Joint.e_pulleyJoint;
      this.groundAnchorA.Set((-1.0), 1.0);
      this.groundAnchorB.Set(1.0, 1.0);
      this.localAnchorA.Set((-1.0), 0.0);
      this.localAnchorB.Set(1.0, 0.0);
      this.lengthA = 0.0;
      this.maxLengthA = 0.0;
      this.lengthB = 0.0;
      this.maxLengthB = 0.0;
      this.ratio = 1.0;
      this.collideConnected = true;
   }
   b2PulleyJointDef.prototype.Initialize = function (bA, bB, gaA, gaB, anchorA, anchorB, r) {
      if (r === undefined) r = 0;
      this.bodyA = bA;
      this.bodyB = bB;
      this.groundAnchorA.SetV(gaA);
      this.groundAnchorB.SetV(gaB);
      this.localAnchorA = this.bodyA.GetLocalPoint(anchorA);
      this.localAnchorB = this.bodyB.GetLocalPoint(anchorB);
      var d1X = anchorA.x - gaA.x;
      var d1Y = anchorA.y - gaA.y;
      this.lengthA = Math.sqrt(d1X * d1X + d1Y * d1Y);
      var d2X = anchorB.x - gaB.x;
      var d2Y = anchorB.y - gaB.y;
      this.lengthB = Math.sqrt(d2X * d2X + d2Y * d2Y);
      this.ratio = r;
      var C = this.lengthA + this.ratio * this.lengthB;
      this.maxLengthA = C - this.ratio * b2PulleyJoint.b2_minPulleyLength;
      this.maxLengthB = (C - b2PulleyJoint.b2_minPulleyLength) / this.ratio;
   }
   Box2D.inherit(b2RevoluteJoint, Box2D.Dynamics.Joints.b2Joint);
   b2RevoluteJoint.prototype.__super = Box2D.Dynamics.Joints.b2Joint.prototype;
   b2RevoluteJoint.b2RevoluteJoint = function () {
      Box2D.Dynamics.Joints.b2Joint.b2Joint.apply(this, arguments);
      this.K = new b2Mat22();
      this.K1 = new b2Mat22();
      this.K2 = new b2Mat22();
      this.K3 = new b2Mat22();
      this.impulse3 = new b2Vec3();
      this.impulse2 = new b2Vec2();
      this.reduced = new b2Vec2();
      this.m_localAnchor1 = new b2Vec2();
      this.m_localAnchor2 = new b2Vec2();
      this.m_impulse = new b2Vec3();
      this.m_mass = new b2Mat33();
   };
   b2RevoluteJoint.prototype.GetAnchorA = function () {
      return this.m_bodyA.GetWorldPoint(this.m_localAnchor1);
   }
   b2RevoluteJoint.prototype.GetAnchorB = function () {
      return this.m_bodyB.GetWorldPoint(this.m_localAnchor2);
   }
   b2RevoluteJoint.prototype.GetReactionForce = function (inv_dt) {
      if (inv_dt === undefined) inv_dt = 0;
      return new b2Vec2(inv_dt * this.m_impulse.x, inv_dt * this.m_impulse.y);
   }
   b2RevoluteJoint.prototype.GetReactionTorque = function (inv_dt) {
      if (inv_dt === undefined) inv_dt = 0;
      return inv_dt * this.m_impulse.z;
   }
   b2RevoluteJoint.prototype.GetJointAngle = function () {
      return this.m_bodyB.m_sweep.a - this.m_bodyA.m_sweep.a - this.m_referenceAngle;
   }
   b2RevoluteJoint.prototype.GetJointSpeed = function () {
      return this.m_bodyB.m_angularVelocity - this.m_bodyA.m_angularVelocity;
   }
   b2RevoluteJoint.prototype.IsLimitEnabled = function () {
      return this.m_enableLimit;
   }
   b2RevoluteJoint.prototype.EnableLimit = function (flag) {
      this.m_enableLimit = flag;
   }
   b2RevoluteJoint.prototype.GetLowerLimit = function () {
      return this.m_lowerAngle;
   }
   b2RevoluteJoint.prototype.GetUpperLimit = function () {
      return this.m_upperAngle;
   }
   b2RevoluteJoint.prototype.SetLimits = function (lower, upper) {
      if (lower === undefined) lower = 0;
      if (upper === undefined) upper = 0;
      this.m_lowerAngle = lower;
      this.m_upperAngle = upper;
   }
   b2RevoluteJoint.prototype.IsMotorEnabled = function () {
      this.m_bodyA.SetAwake(true);
      this.m_bodyB.SetAwake(true);
      return this.m_enableMotor;
   }
   b2RevoluteJoint.prototype.EnableMotor = function (flag) {
      this.m_enableMotor = flag;
   }
   b2RevoluteJoint.prototype.SetMotorSpeed = function (speed) {
      if (speed === undefined) speed = 0;
      this.m_bodyA.SetAwake(true);
      this.m_bodyB.SetAwake(true);
      this.m_motorSpeed = speed;
   }
   b2RevoluteJoint.prototype.GetMotorSpeed = function () {
      return this.m_motorSpeed;
   }
   b2RevoluteJoint.prototype.SetMaxMotorTorque = function (torque) {
      if (torque === undefined) torque = 0;
      this.m_maxMotorTorque = torque;
   }
   b2RevoluteJoint.prototype.GetMotorTorque = function () {
      return this.m_maxMotorTorque;
   }
   b2RevoluteJoint.prototype.b2RevoluteJoint = function (def) {
      this.__super.b2Joint.call(this, def);
      this.m_localAnchor1.SetV(def.localAnchorA);
      this.m_localAnchor2.SetV(def.localAnchorB);
      this.m_referenceAngle = def.referenceAngle;
      this.m_impulse.SetZero();
      this.m_motorImpulse = 0.0;
      this.m_lowerAngle = def.lowerAngle;
      this.m_upperAngle = def.upperAngle;
      this.m_maxMotorTorque = def.maxMotorTorque;
      this.m_motorSpeed = def.motorSpeed;
      this.m_enableLimit = def.enableLimit;
      this.m_enableMotor = def.enableMotor;
      this.m_limitState = b2Joint.e_inactiveLimit;
   }
   b2RevoluteJoint.prototype.InitVelocityConstraints = function (step) {
      var bA = this.m_bodyA;
      var bB = this.m_bodyB;
      var tMat;
      var tX = 0;
      if (this.m_enableMotor || this.m_enableLimit) {}
      tMat = bA.m_xf.R;
      var r1X = this.m_localAnchor1.x - bA.m_sweep.localCenter.x;
      var r1Y = this.m_localAnchor1.y - bA.m_sweep.localCenter.y;
      tX = (tMat.col1.x * r1X + tMat.col2.x * r1Y);
      r1Y = (tMat.col1.y * r1X + tMat.col2.y * r1Y);
      r1X = tX;
      tMat = bB.m_xf.R;
      var r2X = this.m_localAnchor2.x - bB.m_sweep.localCenter.x;
      var r2Y = this.m_localAnchor2.y - bB.m_sweep.localCenter.y;
      tX = (tMat.col1.x * r2X + tMat.col2.x * r2Y);
      r2Y = (tMat.col1.y * r2X + tMat.col2.y * r2Y);
      r2X = tX;
      var m1 = bA.m_invMass;
      var m2 = bB.m_invMass;
      var i1 = bA.m_invI;
      var i2 = bB.m_invI;
      this.m_mass.col1.x = m1 + m2 + r1Y * r1Y * i1 + r2Y * r2Y * i2;
      this.m_mass.col2.x = (-r1Y * r1X * i1) - r2Y * r2X * i2;
      this.m_mass.col3.x = (-r1Y * i1) - r2Y * i2;
      this.m_mass.col1.y = this.m_mass.col2.x;
      this.m_mass.col2.y = m1 + m2 + r1X * r1X * i1 + r2X * r2X * i2;
      this.m_mass.col3.y = r1X * i1 + r2X * i2;
      this.m_mass.col1.z = this.m_mass.col3.x;
      this.m_mass.col2.z = this.m_mass.col3.y;
      this.m_mass.col3.z = i1 + i2;
      this.m_motorMass = 1.0 / (i1 + i2);
      if (this.m_enableMotor == false) {
         this.m_motorImpulse = 0.0;
      }
      if (this.m_enableLimit) {
         var jointAngle = bB.m_sweep.a - bA.m_sweep.a - this.m_referenceAngle;
         if (b2Math.Abs(this.m_upperAngle - this.m_lowerAngle) < 2.0 * b2Settings.b2_angularSlop) {
            this.m_limitState = b2Joint.e_equalLimits;
         }
         else if (jointAngle <= this.m_lowerAngle) {
            if (this.m_limitState != b2Joint.e_atLowerLimit) {
               this.m_impulse.z = 0.0;
            }
            this.m_limitState = b2Joint.e_atLowerLimit;
         }
         else if (jointAngle >= this.m_upperAngle) {
            if (this.m_limitState != b2Joint.e_atUpperLimit) {
               this.m_impulse.z = 0.0;
            }
            this.m_limitState = b2Joint.e_atUpperLimit;
         }
         else {
            this.m_limitState = b2Joint.e_inactiveLimit;
            this.m_impulse.z = 0.0;
         }
      }
      else {
         this.m_limitState = b2Joint.e_inactiveLimit;
      }
      if (step.warmStarting) {
         this.m_impulse.x *= step.dtRatio;
         this.m_impulse.y *= step.dtRatio;
         this.m_motorImpulse *= step.dtRatio;
         var PX = this.m_impulse.x;
         var PY = this.m_impulse.y;
         bA.m_linearVelocity.x -= m1 * PX;
         bA.m_linearVelocity.y -= m1 * PY;
         bA.m_angularVelocity -= i1 * ((r1X * PY - r1Y * PX) + this.m_motorImpulse + this.m_impulse.z);
         bB.m_linearVelocity.x += m2 * PX;
         bB.m_linearVelocity.y += m2 * PY;
         bB.m_angularVelocity += i2 * ((r2X * PY - r2Y * PX) + this.m_motorImpulse + this.m_impulse.z);
      }
      else {
         this.m_impulse.SetZero();
         this.m_motorImpulse = 0.0;
      }
   }
   b2RevoluteJoint.prototype.SolveVelocityConstraints = function (step) {
      var bA = this.m_bodyA;
      var bB = this.m_bodyB;
      var tMat;
      var tX = 0;
      var newImpulse = 0;
      var r1X = 0;
      var r1Y = 0;
      var r2X = 0;
      var r2Y = 0;
      var v1 = bA.m_linearVelocity;
      var w1 = bA.m_angularVelocity;
      var v2 = bB.m_linearVelocity;
      var w2 = bB.m_angularVelocity;
      var m1 = bA.m_invMass;
      var m2 = bB.m_invMass;
      var i1 = bA.m_invI;
      var i2 = bB.m_invI;
      if (this.m_enableMotor && this.m_limitState != b2Joint.e_equalLimits) {
         var Cdot = w2 - w1 - this.m_motorSpeed;
         var impulse = this.m_motorMass * ((-Cdot));
         var oldImpulse = this.m_motorImpulse;
         var maxImpulse = step.dt * this.m_maxMotorTorque;
         this.m_motorImpulse = b2Math.Clamp(this.m_motorImpulse + impulse, (-maxImpulse), maxImpulse);
         impulse = this.m_motorImpulse - oldImpulse;
         w1 -= i1 * impulse;
         w2 += i2 * impulse;
      }
      if (this.m_enableLimit && this.m_limitState != b2Joint.e_inactiveLimit) {
         tMat = bA.m_xf.R;
         r1X = this.m_localAnchor1.x - bA.m_sweep.localCenter.x;
         r1Y = this.m_localAnchor1.y - bA.m_sweep.localCenter.y;
         tX = (tMat.col1.x * r1X + tMat.col2.x * r1Y);
         r1Y = (tMat.col1.y * r1X + tMat.col2.y * r1Y);
         r1X = tX;
         tMat = bB.m_xf.R;
         r2X = this.m_localAnchor2.x - bB.m_sweep.localCenter.x;
         r2Y = this.m_localAnchor2.y - bB.m_sweep.localCenter.y;
         tX = (tMat.col1.x * r2X + tMat.col2.x * r2Y);
         r2Y = (tMat.col1.y * r2X + tMat.col2.y * r2Y);
         r2X = tX;
         var Cdot1X = v2.x + ((-w2 * r2Y)) - v1.x - ((-w1 * r1Y));
         var Cdot1Y = v2.y + (w2 * r2X) - v1.y - (w1 * r1X);
         var Cdot2 = w2 - w1;
         this.m_mass.Solve33(this.impulse3, (-Cdot1X), (-Cdot1Y), (-Cdot2));
         if (this.m_limitState == b2Joint.e_equalLimits) {
            this.m_impulse.Add(this.impulse3);
         }
         else if (this.m_limitState == b2Joint.e_atLowerLimit) {
            newImpulse = this.m_impulse.z + this.impulse3.z;
            if (newImpulse < 0.0) {
               this.m_mass.Solve22(this.reduced, (-Cdot1X), (-Cdot1Y));
               this.impulse3.x = this.reduced.x;
               this.impulse3.y = this.reduced.y;
               this.impulse3.z = (-this.m_impulse.z);
               this.m_impulse.x += this.reduced.x;
               this.m_impulse.y += this.reduced.y;
               this.m_impulse.z = 0.0;
            }
         }
         else if (this.m_limitState == b2Joint.e_atUpperLimit) {
            newImpulse = this.m_impulse.z + this.impulse3.z;
            if (newImpulse > 0.0) {
               this.m_mass.Solve22(this.reduced, (-Cdot1X), (-Cdot1Y));
               this.impulse3.x = this.reduced.x;
               this.impulse3.y = this.reduced.y;
               this.impulse3.z = (-this.m_impulse.z);
               this.m_impulse.x += this.reduced.x;
               this.m_impulse.y += this.reduced.y;
               this.m_impulse.z = 0.0;
            }
         }
         v1.x -= m1 * this.impulse3.x;
         v1.y -= m1 * this.impulse3.y;
         w1 -= i1 * (r1X * this.impulse3.y - r1Y * this.impulse3.x + this.impulse3.z);
         v2.x += m2 * this.impulse3.x;
         v2.y += m2 * this.impulse3.y;
         w2 += i2 * (r2X * this.impulse3.y - r2Y * this.impulse3.x + this.impulse3.z);
      }
      else {
         tMat = bA.m_xf.R;
         r1X = this.m_localAnchor1.x - bA.m_sweep.localCenter.x;
         r1Y = this.m_localAnchor1.y - bA.m_sweep.localCenter.y;
         tX = (tMat.col1.x * r1X + tMat.col2.x * r1Y);
         r1Y = (tMat.col1.y * r1X + tMat.col2.y * r1Y);
         r1X = tX;
         tMat = bB.m_xf.R;
         r2X = this.m_localAnchor2.x - bB.m_sweep.localCenter.x;
         r2Y = this.m_localAnchor2.y - bB.m_sweep.localCenter.y;
         tX = (tMat.col1.x * r2X + tMat.col2.x * r2Y);
         r2Y = (tMat.col1.y * r2X + tMat.col2.y * r2Y);
         r2X = tX;
         var CdotX = v2.x + ((-w2 * r2Y)) - v1.x - ((-w1 * r1Y));
         var CdotY = v2.y + (w2 * r2X) - v1.y - (w1 * r1X);
         this.m_mass.Solve22(this.impulse2, (-CdotX), (-CdotY));
         this.m_impulse.x += this.impulse2.x;
         this.m_impulse.y += this.impulse2.y;
         v1.x -= m1 * this.impulse2.x;
         v1.y -= m1 * this.impulse2.y;
         w1 -= i1 * (r1X * this.impulse2.y - r1Y * this.impulse2.x);
         v2.x += m2 * this.impulse2.x;
         v2.y += m2 * this.impulse2.y;
         w2 += i2 * (r2X * this.impulse2.y - r2Y * this.impulse2.x);
      }
      bA.m_linearVelocity.SetV(v1);
      bA.m_angularVelocity = w1;
      bB.m_linearVelocity.SetV(v2);
      bB.m_angularVelocity = w2;
   }
   b2RevoluteJoint.prototype.SolvePositionConstraints = function (baumgarte) {
      if (baumgarte === undefined) baumgarte = 0;
      var oldLimitImpulse = 0;
      var C = 0;
      var tMat;
      var bA = this.m_bodyA;
      var bB = this.m_bodyB;
      var angularError = 0.0;
      var positionError = 0.0;
      var tX = 0;
      var impulseX = 0;
      var impulseY = 0;
      if (this.m_enableLimit && this.m_limitState != b2Joint.e_inactiveLimit) {
         var angle = bB.m_sweep.a - bA.m_sweep.a - this.m_referenceAngle;
         var limitImpulse = 0.0;
         if (this.m_limitState == b2Joint.e_equalLimits) {
            C = b2Math.Clamp(angle - this.m_lowerAngle, (-b2Settings.b2_maxAngularCorrection), b2Settings.b2_maxAngularCorrection);
            limitImpulse = (-this.m_motorMass * C);
            angularError = b2Math.Abs(C);
         }
         else if (this.m_limitState == b2Joint.e_atLowerLimit) {
            C = angle - this.m_lowerAngle;
            angularError = (-C);
            C = b2Math.Clamp(C + b2Settings.b2_angularSlop, (-b2Settings.b2_maxAngularCorrection), 0.0);
            limitImpulse = (-this.m_motorMass * C);
         }
         else if (this.m_limitState == b2Joint.e_atUpperLimit) {
            C = angle - this.m_upperAngle;
            angularError = C;
            C = b2Math.Clamp(C - b2Settings.b2_angularSlop, 0.0, b2Settings.b2_maxAngularCorrection);
            limitImpulse = (-this.m_motorMass * C);
         }
         bA.m_sweep.a -= bA.m_invI * limitImpulse;
         bB.m_sweep.a += bB.m_invI * limitImpulse;
         bA.SynchronizeTransform();
         bB.SynchronizeTransform();
      } {
         tMat = bA.m_xf.R;
         var r1X = this.m_localAnchor1.x - bA.m_sweep.localCenter.x;
         var r1Y = this.m_localAnchor1.y - bA.m_sweep.localCenter.y;
         tX = (tMat.col1.x * r1X + tMat.col2.x * r1Y);
         r1Y = (tMat.col1.y * r1X + tMat.col2.y * r1Y);
         r1X = tX;
         tMat = bB.m_xf.R;
         var r2X = this.m_localAnchor2.x - bB.m_sweep.localCenter.x;
         var r2Y = this.m_localAnchor2.y - bB.m_sweep.localCenter.y;
         tX = (tMat.col1.x * r2X + tMat.col2.x * r2Y);
         r2Y = (tMat.col1.y * r2X + tMat.col2.y * r2Y);
         r2X = tX;
         var CX = bB.m_sweep.c.x + r2X - bA.m_sweep.c.x - r1X;
         var CY = bB.m_sweep.c.y + r2Y - bA.m_sweep.c.y - r1Y;
         var CLengthSquared = CX * CX + CY * CY;
         var CLength = Math.sqrt(CLengthSquared);
         positionError = CLength;
         var invMass1 = bA.m_invMass;
         var invMass2 = bB.m_invMass;
         var invI1 = bA.m_invI;
         var invI2 = bB.m_invI;
         var k_allowedStretch = 10.0 * b2Settings.b2_linearSlop;
         if (CLengthSquared > k_allowedStretch * k_allowedStretch) {
            var uX = CX / CLength;
            var uY = CY / CLength;
            var k = invMass1 + invMass2;
            var m = 1.0 / k;
            impulseX = m * ((-CX));
            impulseY = m * ((-CY));
            var k_beta = 0.5;
            bA.m_sweep.c.x -= k_beta * invMass1 * impulseX;
            bA.m_sweep.c.y -= k_beta * invMass1 * impulseY;
            bB.m_sweep.c.x += k_beta * invMass2 * impulseX;
            bB.m_sweep.c.y += k_beta * invMass2 * impulseY;
            CX = bB.m_sweep.c.x + r2X - bA.m_sweep.c.x - r1X;
            CY = bB.m_sweep.c.y + r2Y - bA.m_sweep.c.y - r1Y;
         }
         this.K1.col1.x = invMass1 + invMass2;
         this.K1.col2.x = 0.0;
         this.K1.col1.y = 0.0;
         this.K1.col2.y = invMass1 + invMass2;
         this.K2.col1.x = invI1 * r1Y * r1Y;
         this.K2.col2.x = (-invI1 * r1X * r1Y);
         this.K2.col1.y = (-invI1 * r1X * r1Y);
         this.K2.col2.y = invI1 * r1X * r1X;
         this.K3.col1.x = invI2 * r2Y * r2Y;
         this.K3.col2.x = (-invI2 * r2X * r2Y);
         this.K3.col1.y = (-invI2 * r2X * r2Y);
         this.K3.col2.y = invI2 * r2X * r2X;
         this.K.SetM(this.K1);
         this.K.AddM(this.K2);
         this.K.AddM(this.K3);
         this.K.Solve(b2RevoluteJoint.tImpulse, (-CX), (-CY));
         impulseX = b2RevoluteJoint.tImpulse.x;
         impulseY = b2RevoluteJoint.tImpulse.y;
         bA.m_sweep.c.x -= bA.m_invMass * impulseX;
         bA.m_sweep.c.y -= bA.m_invMass * impulseY;
         bA.m_sweep.a -= bA.m_invI * (r1X * impulseY - r1Y * impulseX);
         bB.m_sweep.c.x += bB.m_invMass * impulseX;
         bB.m_sweep.c.y += bB.m_invMass * impulseY;
         bB.m_sweep.a += bB.m_invI * (r2X * impulseY - r2Y * impulseX);
         bA.SynchronizeTransform();
         bB.SynchronizeTransform();
      }
      return positionError <= b2Settings.b2_linearSlop && angularError <= b2Settings.b2_angularSlop;
   }
   Box2D.postDefs.push(function () {
      Box2D.Dynamics.Joints.b2RevoluteJoint.tImpulse = new b2Vec2();
   });
   Box2D.inherit(b2RevoluteJointDef, Box2D.Dynamics.Joints.b2JointDef);
   b2RevoluteJointDef.prototype.__super = Box2D.Dynamics.Joints.b2JointDef.prototype;
   b2RevoluteJointDef.b2RevoluteJointDef = function () {
      Box2D.Dynamics.Joints.b2JointDef.b2JointDef.apply(this, arguments);
      this.localAnchorA = new b2Vec2();
      this.localAnchorB = new b2Vec2();
   };
   b2RevoluteJointDef.prototype.b2RevoluteJointDef = function () {
      this.__super.b2JointDef.call(this);
      this.type = b2Joint.e_revoluteJoint;
      this.localAnchorA.Set(0.0, 0.0);
      this.localAnchorB.Set(0.0, 0.0);
      this.referenceAngle = 0.0;
      this.lowerAngle = 0.0;
      this.upperAngle = 0.0;
      this.maxMotorTorque = 0.0;
      this.motorSpeed = 0.0;
      this.enableLimit = false;
      this.enableMotor = false;
   }
   b2RevoluteJointDef.prototype.Initialize = function (bA, bB, anchor) {
      this.bodyA = bA;
      this.bodyB = bB;
      this.localAnchorA = this.bodyA.GetLocalPoint(anchor);
      this.localAnchorB = this.bodyB.GetLocalPoint(anchor);
      this.referenceAngle = this.bodyB.GetAngle() - this.bodyA.GetAngle();
   }
   Box2D.inherit(b2WeldJoint, Box2D.Dynamics.Joints.b2Joint);
   b2WeldJoint.prototype.__super = Box2D.Dynamics.Joints.b2Joint.prototype;
   b2WeldJoint.b2WeldJoint = function () {
      Box2D.Dynamics.Joints.b2Joint.b2Joint.apply(this, arguments);
      this.m_localAnchorA = new b2Vec2();
      this.m_localAnchorB = new b2Vec2();
      this.m_impulse = new b2Vec3();
      this.m_mass = new b2Mat33();
   };
   b2WeldJoint.prototype.GetAnchorA = function () {
      return this.m_bodyA.GetWorldPoint(this.m_localAnchorA);
   }
   b2WeldJoint.prototype.GetAnchorB = function () {
      return this.m_bodyB.GetWorldPoint(this.m_localAnchorB);
   }
   b2WeldJoint.prototype.GetReactionForce = function (inv_dt) {
      if (inv_dt === undefined) inv_dt = 0;
      return new b2Vec2(inv_dt * this.m_impulse.x, inv_dt * this.m_impulse.y);
   }
   b2WeldJoint.prototype.GetReactionTorque = function (inv_dt) {
      if (inv_dt === undefined) inv_dt = 0;
      return inv_dt * this.m_impulse.z;
   }
   b2WeldJoint.prototype.b2WeldJoint = function (def) {
      this.__super.b2Joint.call(this, def);
      this.m_localAnchorA.SetV(def.localAnchorA);
      this.m_localAnchorB.SetV(def.localAnchorB);
      this.m_referenceAngle = def.referenceAngle;
      this.m_impulse.SetZero();
      this.m_mass = new b2Mat33();
   }
   b2WeldJoint.prototype.InitVelocityConstraints = function (step) {
      var tMat;
      var tX = 0;
      var bA = this.m_bodyA;
      var bB = this.m_bodyB;
      tMat = bA.m_xf.R;
      var rAX = this.m_localAnchorA.x - bA.m_sweep.localCenter.x;
      var rAY = this.m_localAnchorA.y - bA.m_sweep.localCenter.y;
      tX = (tMat.col1.x * rAX + tMat.col2.x * rAY);
      rAY = (tMat.col1.y * rAX + tMat.col2.y * rAY);
      rAX = tX;
      tMat = bB.m_xf.R;
      var rBX = this.m_localAnchorB.x - bB.m_sweep.localCenter.x;
      var rBY = this.m_localAnchorB.y - bB.m_sweep.localCenter.y;
      tX = (tMat.col1.x * rBX + tMat.col2.x * rBY);
      rBY = (tMat.col1.y * rBX + tMat.col2.y * rBY);
      rBX = tX;
      var mA = bA.m_invMass;
      var mB = bB.m_invMass;
      var iA = bA.m_invI;
      var iB = bB.m_invI;
      this.m_mass.col1.x = mA + mB + rAY * rAY * iA + rBY * rBY * iB;
      this.m_mass.col2.x = (-rAY * rAX * iA) - rBY * rBX * iB;
      this.m_mass.col3.x = (-rAY * iA) - rBY * iB;
      this.m_mass.col1.y = this.m_mass.col2.x;
      this.m_mass.col2.y = mA + mB + rAX * rAX * iA + rBX * rBX * iB;
      this.m_mass.col3.y = rAX * iA + rBX * iB;
      this.m_mass.col1.z = this.m_mass.col3.x;
      this.m_mass.col2.z = this.m_mass.col3.y;
      this.m_mass.col3.z = iA + iB;
      if (step.warmStarting) {
         this.m_impulse.x *= step.dtRatio;
         this.m_impulse.y *= step.dtRatio;
         this.m_impulse.z *= step.dtRatio;
         bA.m_linearVelocity.x -= mA * this.m_impulse.x;
         bA.m_linearVelocity.y -= mA * this.m_impulse.y;
         bA.m_angularVelocity -= iA * (rAX * this.m_impulse.y - rAY * this.m_impulse.x + this.m_impulse.z);
         bB.m_linearVelocity.x += mB * this.m_impulse.x;
         bB.m_linearVelocity.y += mB * this.m_impulse.y;
         bB.m_angularVelocity += iB * (rBX * this.m_impulse.y - rBY * this.m_impulse.x + this.m_impulse.z);
      }
      else {
         this.m_impulse.SetZero();
      }
   }
   b2WeldJoint.prototype.SolveVelocityConstraints = function (step) {
      var tMat;
      var tX = 0;
      var bA = this.m_bodyA;
      var bB = this.m_bodyB;
      var vA = bA.m_linearVelocity;
      var wA = bA.m_angularVelocity;
      var vB = bB.m_linearVelocity;
      var wB = bB.m_angularVelocity;
      var mA = bA.m_invMass;
      var mB = bB.m_invMass;
      var iA = bA.m_invI;
      var iB = bB.m_invI;
      tMat = bA.m_xf.R;
      var rAX = this.m_localAnchorA.x - bA.m_sweep.localCenter.x;
      var rAY = this.m_localAnchorA.y - bA.m_sweep.localCenter.y;
      tX = (tMat.col1.x * rAX + tMat.col2.x * rAY);
      rAY = (tMat.col1.y * rAX + tMat.col2.y * rAY);
      rAX = tX;
      tMat = bB.m_xf.R;
      var rBX = this.m_localAnchorB.x - bB.m_sweep.localCenter.x;
      var rBY = this.m_localAnchorB.y - bB.m_sweep.localCenter.y;
      tX = (tMat.col1.x * rBX + tMat.col2.x * rBY);
      rBY = (tMat.col1.y * rBX + tMat.col2.y * rBY);
      rBX = tX;
      var Cdot1X = vB.x - wB * rBY - vA.x + wA * rAY;
      var Cdot1Y = vB.y + wB * rBX - vA.y - wA * rAX;
      var Cdot2 = wB - wA;
      var impulse = new b2Vec3();
      this.m_mass.Solve33(impulse, (-Cdot1X), (-Cdot1Y), (-Cdot2));
      this.m_impulse.Add(impulse);
      vA.x -= mA * impulse.x;
      vA.y -= mA * impulse.y;
      wA -= iA * (rAX * impulse.y - rAY * impulse.x + impulse.z);
      vB.x += mB * impulse.x;
      vB.y += mB * impulse.y;
      wB += iB * (rBX * impulse.y - rBY * impulse.x + impulse.z);
      bA.m_angularVelocity = wA;
      bB.m_angularVelocity = wB;
   }
   b2WeldJoint.prototype.SolvePositionConstraints = function (baumgarte) {
      if (baumgarte === undefined) baumgarte = 0;
      var tMat;
      var tX = 0;
      var bA = this.m_bodyA;
      var bB = this.m_bodyB;
      tMat = bA.m_xf.R;
      var rAX = this.m_localAnchorA.x - bA.m_sweep.localCenter.x;
      var rAY = this.m_localAnchorA.y - bA.m_sweep.localCenter.y;
      tX = (tMat.col1.x * rAX + tMat.col2.x * rAY);
      rAY = (tMat.col1.y * rAX + tMat.col2.y * rAY);
      rAX = tX;
      tMat = bB.m_xf.R;
      var rBX = this.m_localAnchorB.x - bB.m_sweep.localCenter.x;
      var rBY = this.m_localAnchorB.y - bB.m_sweep.localCenter.y;
      tX = (tMat.col1.x * rBX + tMat.col2.x * rBY);
      rBY = (tMat.col1.y * rBX + tMat.col2.y * rBY);
      rBX = tX;
      var mA = bA.m_invMass;
      var mB = bB.m_invMass;
      var iA = bA.m_invI;
      var iB = bB.m_invI;
      var C1X = bB.m_sweep.c.x + rBX - bA.m_sweep.c.x - rAX;
      var C1Y = bB.m_sweep.c.y + rBY - bA.m_sweep.c.y - rAY;
      var C2 = bB.m_sweep.a - bA.m_sweep.a - this.m_referenceAngle;
      var k_allowedStretch = 10.0 * b2Settings.b2_linearSlop;
      var positionError = Math.sqrt(C1X * C1X + C1Y * C1Y);
      var angularError = b2Math.Abs(C2);
      if (positionError > k_allowedStretch) {
         iA *= 1.0;
         iB *= 1.0;
      }
      this.m_mass.col1.x = mA + mB + rAY * rAY * iA + rBY * rBY * iB;
      this.m_mass.col2.x = (-rAY * rAX * iA) - rBY * rBX * iB;
      this.m_mass.col3.x = (-rAY * iA) - rBY * iB;
      this.m_mass.col1.y = this.m_mass.col2.x;
      this.m_mass.col2.y = mA + mB + rAX * rAX * iA + rBX * rBX * iB;
      this.m_mass.col3.y = rAX * iA + rBX * iB;
      this.m_mass.col1.z = this.m_mass.col3.x;
      this.m_mass.col2.z = this.m_mass.col3.y;
      this.m_mass.col3.z = iA + iB;
      var impulse = new b2Vec3();
      this.m_mass.Solve33(impulse, (-C1X), (-C1Y), (-C2));
      bA.m_sweep.c.x -= mA * impulse.x;
      bA.m_sweep.c.y -= mA * impulse.y;
      bA.m_sweep.a -= iA * (rAX * impulse.y - rAY * impulse.x + impulse.z);
      bB.m_sweep.c.x += mB * impulse.x;
      bB.m_sweep.c.y += mB * impulse.y;
      bB.m_sweep.a += iB * (rBX * impulse.y - rBY * impulse.x + impulse.z);
      bA.SynchronizeTransform();
      bB.SynchronizeTransform();
      return positionError <= b2Settings.b2_linearSlop && angularError <= b2Settings.b2_angularSlop;
   }
   Box2D.inherit(b2WeldJointDef, Box2D.Dynamics.Joints.b2JointDef);
   b2WeldJointDef.prototype.__super = Box2D.Dynamics.Joints.b2JointDef.prototype;
   b2WeldJointDef.b2WeldJointDef = function () {
      Box2D.Dynamics.Joints.b2JointDef.b2JointDef.apply(this, arguments);
      this.localAnchorA = new b2Vec2();
      this.localAnchorB = new b2Vec2();
   };
   b2WeldJointDef.prototype.b2WeldJointDef = function () {
      this.__super.b2JointDef.call(this);
      this.type = b2Joint.e_weldJoint;
      this.referenceAngle = 0.0;
   }
   b2WeldJointDef.prototype.Initialize = function (bA, bB, anchor) {
      this.bodyA = bA;
      this.bodyB = bB;
      this.localAnchorA.SetV(this.bodyA.GetLocalPoint(anchor));
      this.localAnchorB.SetV(this.bodyB.GetLocalPoint(anchor));
      this.referenceAngle = this.bodyB.GetAngle() - this.bodyA.GetAngle();
   }
})();
(function () {
   var b2DebugDraw = Box2D.Dynamics.b2DebugDraw;
   b2DebugDraw.b2DebugDraw = function () {
      this.m_drawScale = 1.0;
      this.m_lineThickness = 1.0;
      this.m_alpha = 1.0;
      this.m_fillAlpha = 1.0;
      this.m_xformScale = 1.0;
      var __this = this;
      //#WORKAROUND
      this.m_sprite = {
         graphics: {
            clear: function () {
               __this.m_ctx.clearRect(0, 0, __this.m_ctx.canvas.width, __this.m_ctx.canvas.height)
            }
         }
      };
   };
   b2DebugDraw.prototype._color = function (color, alpha) {
      return "rgba(" + ((color & 0xFF0000) >> 16) + "," + ((color & 0xFF00) >> 8) + "," + (color & 0xFF) + "," + alpha + ")";
   };
   b2DebugDraw.prototype.b2DebugDraw = function () {
      this.m_drawFlags = 0;
   };
   b2DebugDraw.prototype.SetFlags = function (flags) {
      if (flags === undefined) flags = 0;
      this.m_drawFlags = flags;
   };
   b2DebugDraw.prototype.GetFlags = function () {
      return this.m_drawFlags;
   };
   b2DebugDraw.prototype.AppendFlags = function (flags) {
      if (flags === undefined) flags = 0;
      this.m_drawFlags |= flags;
   };
   b2DebugDraw.prototype.ClearFlags = function (flags) {
      if (flags === undefined) flags = 0;
      this.m_drawFlags &= ~flags;
   };
   b2DebugDraw.prototype.SetSprite = function (sprite) {
      this.m_ctx = sprite;
   };
   b2DebugDraw.prototype.GetSprite = function () {
      return this.m_ctx;
   };
   b2DebugDraw.prototype.SetDrawScale = function (drawScale) {
      if (drawScale === undefined) drawScale = 0;
      this.m_drawScale = drawScale;
   };
   b2DebugDraw.prototype.GetDrawScale = function () {
      return this.m_drawScale;
   };
   b2DebugDraw.prototype.SetLineThickness = function (lineThickness) {
      if (lineThickness === undefined) lineThickness = 0;
      this.m_lineThickness = lineThickness;
      this.m_ctx.strokeWidth = lineThickness;
   };
   b2DebugDraw.prototype.GetLineThickness = function () {
      return this.m_lineThickness;
   };
   b2DebugDraw.prototype.SetAlpha = function (alpha) {
      if (alpha === undefined) alpha = 0;
      this.m_alpha = alpha;
   };
   b2DebugDraw.prototype.GetAlpha = function () {
      return this.m_alpha;
   };
   b2DebugDraw.prototype.SetFillAlpha = function (alpha) {
      if (alpha === undefined) alpha = 0;
      this.m_fillAlpha = alpha;
   };
   b2DebugDraw.prototype.GetFillAlpha = function () {
      return this.m_fillAlpha;
   };
   b2DebugDraw.prototype.SetXFormScale = function (xformScale) {
      if (xformScale === undefined) xformScale = 0;
      this.m_xformScale = xformScale;
   };
   b2DebugDraw.prototype.GetXFormScale = function () {
      return this.m_xformScale;
   };
   b2DebugDraw.prototype.DrawPolygon = function (vertices, vertexCount, color) {
      if (!vertexCount) return;
      var s = this.m_ctx;
      var drawScale = this.m_drawScale;
      s.beginPath();
      s.strokeStyle = this._color(color.color, this.m_alpha);
      s.moveTo(vertices[0].x * drawScale, vertices[0].y * drawScale);
      for (var i = 1; i < vertexCount; i++) {
         s.lineTo(vertices[i].x * drawScale, vertices[i].y * drawScale);
      }
      s.lineTo(vertices[0].x * drawScale, vertices[0].y * drawScale);
      s.closePath();
      s.stroke();
   };
   b2DebugDraw.prototype.DrawSolidPolygon = function (vertices, vertexCount, color) {
      if (!vertexCount) return;
      var s = this.m_ctx;
      var drawScale = this.m_drawScale;
      s.beginPath();
      s.strokeStyle = this._color(color.color, this.m_alpha);
      s.fillStyle = this._color(color.color, this.m_fillAlpha);
      s.moveTo(vertices[0].x * drawScale, vertices[0].y * drawScale);
      for (var i = 1; i < vertexCount; i++) {
         s.lineTo(vertices[i].x * drawScale, vertices[i].y * drawScale);
      }
      s.lineTo(vertices[0].x * drawScale, vertices[0].y * drawScale);
      s.closePath();
      s.fill();
      s.stroke();
   };
   b2DebugDraw.prototype.DrawCircle = function (center, radius, color) {
      if (!radius) return;
      var s = this.m_ctx;
      var drawScale = this.m_drawScale;
      s.beginPath();
      s.strokeStyle = this._color(color.color, this.m_alpha);
      s.arc(center.x * drawScale, center.y * drawScale, radius * drawScale, 0, Math.PI * 2, true);
      s.closePath();
      s.stroke();
   };
   b2DebugDraw.prototype.DrawSolidCircle = function (center, radius, axis, color) {
      if (!radius) return;
      var s = this.m_ctx,
         drawScale = this.m_drawScale,
         cx = center.x * drawScale,
         cy = center.y * drawScale;
      s.moveTo(0, 0);
      s.beginPath();
      s.strokeStyle = this._color(color.color, this.m_alpha);
      s.fillStyle = this._color(color.color, this.m_fillAlpha);
      s.arc(cx, cy, radius * drawScale, 0, Math.PI * 2, true);
      s.moveTo(cx, cy);
      s.lineTo((center.x + axis.x * radius) * drawScale, (center.y + axis.y * radius) * drawScale);
      s.closePath();
      s.fill();
      s.stroke();
   };
   b2DebugDraw.prototype.DrawSegment = function (p1, p2, color) {
      var s = this.m_ctx,
         drawScale = this.m_drawScale;
      s.strokeStyle = this._color(color.color, this.m_alpha);
      s.beginPath();
      s.moveTo(p1.x * drawScale, p1.y * drawScale);
      s.lineTo(p2.x * drawScale, p2.y * drawScale);
      s.closePath();
      s.stroke();
   };
   b2DebugDraw.prototype.DrawTransform = function (xf) {
      var s = this.m_ctx,
         drawScale = this.m_drawScale;
      s.beginPath();
      s.strokeStyle = this._color(0xff0000, this.m_alpha);
      s.moveTo(xf.position.x * drawScale, xf.position.y * drawScale);
      s.lineTo((xf.position.x + this.m_xformScale * xf.R.col1.x) * drawScale, (xf.position.y + this.m_xformScale * xf.R.col1.y) * drawScale);

      s.strokeStyle = this._color(0xff00, this.m_alpha);
      s.moveTo(xf.position.x * drawScale, xf.position.y * drawScale);
      s.lineTo((xf.position.x + this.m_xformScale * xf.R.col2.x) * drawScale, (xf.position.y + this.m_xformScale * xf.R.col2.y) * drawScale);
      s.closePath();
      s.stroke();
   };
})();
var i;
for (i = 0; i < Box2D.postDefs.length; ++i) Box2D.postDefs[i]();

module.exports = Box2D
})(g.module.exports, g.module.require, g.module, g.filename, g.dirname);

		};
	



</script>

<script>

	window.addEventListener("load", function() {

	start();

	function start() {
		// TODO WebGL有効化
		// // webgl=1でRendererを問答無用でWebGLのみにする
		// if (getParameterByName("webgl")) {
		// 	conf.renderers = ["webgl"];
		// }

		var sandboxPlayer = { id: "9999", name: "sandbox-player" };
		var sandboxPlayId = "sandboxDummyPlayId";

		var pdiBrowser = engineFiles.pdiBrowser;
		var gdr = engineFiles.gameDriver;

		var amflowClient = new gdr.MemoryAmflowClient({
			playId: sandboxPlayId
		});

		var sandboxConfig;
		if (window.__akashic__.autoSendEventName === true || typeof window.__akashic__.autoSendEventName === "string") {
			sandboxConfig = window.__akashic__.sandboxConfigFunc();
			var autoSendEventName = window.__akashic__.autoSendEventName;
			if (autoSendEventName === true) {
			  autoSendEventName = sandboxConfig.autoSendEventName || sandboxConfig.autoSendEvents;
			}
			if (!!sandboxConfig && autoSendEventName && sandboxConfig.events && sandboxConfig.events[autoSendEventName]) {
				sandboxConfig.events[autoSendEventName].forEach(function (ev){amflowClient.sendEvent(ev)});
			}
		}

		var gameArguments;
		if (window.__akashic__.autoGivenArgsName) { 
			if (!sandboxConfig) 
				sandboxConfig = window.__akashic__.sandboxConfigFunc();
			gameArguments = sandboxConfig.arguments[window.__akashic__.autoGivenArgsName];
		}

		var audioPlugins;
		if (location.protocol !== "file:") {
			// 特にSafariの制約(user activationなしでは音が鳴らない)回避のため、可能ならWebAudioを使う
			audioPlugins = [pdiBrowser.WebAudioPlugin, pdiBrowser.HTMLAudioPlugin];
		} else {
			// file:の場合ブラウザによってCORSの制約にひっかかるWebAudioは避ける
			audioPlugins = [pdiBrowser.HTMLAudioPlugin];
		}
		var elem = document.getElementById("container");
		var pf = new pdiBrowser.Platform({
			amflow: amflowClient,
			containerView: elem,
			audioPlugins: audioPlugins,
			// iframe 下の場合 preventDefault すると iframe 領域外での mousemove が通知されなくなってしまうので無効化
			disablePreventDefault: true
		});
		elem.addEventListener("touchstart", function (ev) {
			// disablePreventDefault の場合 touchstart のデフォルト処理を止めないと mousestart が二重になる場合がある
			ev.preventDefault();
		});

		pf.loadGameConfiguration = function(url, callback) {
			try {
				var gameJsonText = window.gLocalAssetContainer["game.json"];
				gameJsonText = decodeURIComponent(gameJsonText);
				callback(null, JSON.parse(gameJsonText));
			} catch(error) {
				callback(error, null);
			}
		};

		pf._resourceFactory.createScriptAsset = function(id, assetPath) {
			return new LocalScriptAssetV3(id, assetPath);
		};

		var createTextAsset = function(id, assetPath) {
			return new LocalTextAssetV3(id, assetPath);
		};
		if (typeof LocalTextAssetV3 !== "undefined") {
			pf._resourceFactory.createTextAsset = createTextAsset;
		}

		driver = new gdr.GameDriver({
			platform: pf,
			player: sandboxPlayer,
			errorHandler: function (e) { console.log("ERRORHANDLER:", e); }
		});

		driver.gameCreatedTrigger.add(function (game) {
			if (window.optionProps.magnify) {
				resize(game);
				window.addEventListener("resize", function() {
					resize(game);
				});
			}
			injectGameExternalStorage(game);
		});

		function resize(game) {
			if (!pf.containerController) return;
			var viewportSize = {
				width: window.innerWidth || document.documentElement.clientWidth,
				height: window.innerHeight || document.documentElement.clientHeight
			};
			var gameScale = Math.min(
				viewportSize.width / game.width,
				viewportSize.height / game.height
			);
			var gameSize = {
				width: Math.floor(game.width * gameScale),
				height: Math.floor(game.height * gameScale)
			};
			pf.containerController.changeScale(gameScale, gameScale);
			var gameOffset = {
				x: Math.floor((viewportSize.width - gameSize.width) / 2),
				y: Math.floor((viewportSize.height - gameSize.height) / 2)
			};
			pf.containerController.inputHandlerLayer.setOffset(gameOffset);
		}

		driver.initialize({
			configurationUrl: "game.json",
			assetBase: "./",
			gameArgs: gameArguments,
			driverConfiguration: {
				playId: sandboxPlayId,
				playToken: "dummyToken",
				executionMode: gdr.ExecutionMode.Active
			},
			loopConfiguration: {
				loopMode: gdr.LoopMode.Realtime
			}
		}, function (e) {
			if (e) {
				throw e;
			}
			setAtsumaruHook();
			driver.startGame();
		});

		function setAtsumaruHook() {
			try {
				if (typeof window !== "undefined" && window.RPGAtsumaru) {
					var volume = window.RPGAtsumaru.volume.getCurrentValue();
					pf.setMasterVolume(volume);
					window.RPGAtsumaru.volume.changed.subscribe(function(newVolume) {
						pf.setMasterVolume(newVolume);
					});
	
					window.RPGAtsumaru.screenshot.setScreenshotHandler(function() {
						var canvas = pf.getPrimarySurface().canvas;
						var pngData = canvas.toDataURL("image/png");
						return Promise.resolve(pngData);
					});
				}
			} catch (error) {
				console.error(error);
			}
		}

		function injectGameExternalStorage(game) {
			// TODO: game.external.contentStorage に GameExternalStorage を inject する。
		}
	}
});


	window.g = require("@akashic/akashic-engine");

if (! ("gLocalAssetContainer" in window)) {
	window.gLocalAssetContainer = {};
}

if (! ("__akashic__" in window)) {
	window.__akashic__ = {};
}


	// 本来であればv3系のg.ScriptAssetをimplementsすべきだが、ビルド時に使用しているakashic-engineはv2系なので一からクラス定義している
// eslint-disable-next-line @typescript-eslint/no-unused-vars
class LocalScriptAssetV3 {
    constructor(id, path, exports = []) {
        this.type = "script";
        this.id = id;
        this.originalPath = path;
        this.exports = exports;
        this.path = this._assetPathFilter(path);
        this.onDestroyed = new g.Trigger();
        this.func = window.gLocalAssetContainer[id]; // gLocalScriptContainer は index.ect 上のscriptタグ内で宣言されている
    }
    destroy() {
        this.onDestroyed.fire(this);
        this.id = undefined;
        this.originalPath = undefined;
        this.path = undefined;
        this.exports = undefined;
        this.onDestroyed.destroy();
        this.onDestroyed = undefined;
    }
    destroyed() {
        return this.id === undefined;
    }
    inUse() {
        return false;
    }
    // 引数の型はg.ScriptAssetRuntimeValueだが、v2系には無いものなのでanyを指定している
    execute(execEnv) {
        this.func(execEnv);
        return execEnv.module.exports;
    }
    _load(loader) {
        if (this.func !== undefined) {
            setTimeout(() => {
                loader._onAssetLoad(this);
            }, 0);
        }
        else {
            setTimeout(() => {
                loader._onAssetError(this, g.ExceptionFactory.createAssetLoadError("can not load script asset"));
            }, 0);
        }
    }
    /**
     * @private
     */
    _assetPathFilter(path) {
        // 拡張子の補完・読み替えが必要なassetはこれをオーバーライドすればよい。(対応形式が限定されるaudioなどの場合)
        return path;
    }
}


	// 本来であればv3系のg.TextAssetをimplementsすべきだが、ビルド時に使用しているakashic-engineはv2系なので一からクラス定義している
// eslint-disable-next-line @typescript-eslint/no-unused-vars
class LocalTextAssetV3 {
    constructor(id, path) {
        this.type = "text";
        this.id = id;
        this.originalPath = path;
        this.path = this._assetPathFilter(path);
        this.onDestroyed = new g.Trigger();
        this.data = decodeURIComponent(window.gLocalAssetContainer[id]);
    }
    destroy() {
        this.onDestroyed.fire(this);
        this.id = undefined;
        this.originalPath = undefined;
        this.path = undefined;
        this.onDestroyed.destroy();
        this.onDestroyed = undefined;
    }
    destroyed() {
        return this.id === undefined;
    }
    inUse() {
        return false;
    }
    _load(loader) {
        if (this.data !== undefined) {
            setTimeout(() => {
                loader._onAssetLoad(this);
            }, 0);
        }
        else {
            setTimeout(() => {
                loader._onAssetError(this, g.ExceptionFactory.createAssetLoadError("can not load text asset"));
            }, 0);
        }
    }
    /**
     * @private
     */
    _assetPathFilter(path) {
        // 拡張子の補完・読み替えが必要なassetはこれをオーバーライドすればよい。(対応形式が限定されるaudioなどの場合)
        return path;
    }
}


</script>

<style type="text/css">
* {
	margin: 0;
	border: 0;
	padding: 0;
}

html {
	width: 100%;
	height: 100%;
}

body {
	overflow: hidden;
	width: 100%;
	height: 100%;
}

#container {
	margin: 0px;
	padding: 0px;
	overflow: hidden;
	touch-action: none;
	width: 100%;
	height: 100%;

	/* iOS表示崩れ対策: bodyのサイズ計算からこの要素を除外 */
	position: absolute;
}

#container canvas {
	background-size: contain;
}

</style>



</head>
<body>
<div id="container">
</div>
</body>
</html>
